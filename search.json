[{"title":"åå°„æ³¨è§£ä¸åŠ¨æ€ä»£ç†","url":"/2024/05/20/åå°„æ³¨è§£ä¸åŠ¨æ€ä»£ç†/","content":"\n> æœ¬æ–‡å°†é€ä¸€è®²è§£åå°„ã€æ³¨è§£ã€åŠ¨æ€ä»£ç†ã€‚ä¹‹æ‰€ä»¥å°†è¿™å‡ ä¸ªçŸ¥è¯†ç‚¹æ”¾åœ¨ä¸€èµ·ï¼Œæ˜¯å› ä¸ºä¸‰è€…å­˜åœ¨ç€ä¸€å®šçš„è”ç³»ï¼Œå³**åå°„æœºåˆ¶**è´¯ç©¿ç€æ³¨è§£å’ŒåŠ¨æ€ä»£ç†ã€‚å¹¶ä¸”ç”±äºåœ¨æ—¥å¸¸å®é™…å¼€å‘ä¸­ï¼Œè™½ç„¶å¾ˆå°‘æ¥è§¦å®ƒä»¬çš„åº•å±‚ï¼Œä½†æ˜¯å¯¹äºäº†è§£å„ç±»æ¡†æ¶çš„åº•å±‚åŸç†ååˆ†æœ‰å¸®åŠ©ã€‚\n\n<a name=\"KPmFk\"></a>\n\n# åå°„\n\n<a name=\"F3q6t\"></a>\n\n## ä»€ä¹ˆæ˜¯åå°„\n\nåœ¨è¿è¡ŒçŠ¶æ€ä¸­ï¼Œå¯¹äºä»»æ„ä¸€ä¸ªç±»ï¼Œéƒ½èƒ½å¤ŸçŸ¥é“è¿™ä¸ªç±»çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•ï¼›å¯¹äºä»»æ„ä¸€ä¸ªå¯¹è±¡ï¼Œéƒ½èƒ½å¤Ÿè°ƒç”¨å®ƒçš„ä»»æ„ä¸€ä¸ªæ–¹æ³•å’Œå±æ€§ï¼›è¿™ç§åŠ¨æ€è·å–ä¿¡æ¯ä»¥åŠåŠ¨æ€è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•çš„åŠŸèƒ½ç§°ä¸º**Javaè¯­è¨€çš„åå°„æœºåˆ¶**ã€‚<br />åå°„ä¹‹æ‰€ä»¥è¢«ç§°ä¸ºæ¡†æ¶çš„çµé­‚ï¼Œä¸»è¦æ˜¯å› ä¸ºå®ƒèµ‹äºˆäº†æˆ‘ä»¬åœ¨è¿è¡Œæ—¶åˆ†æç±»ä»¥åŠæ‰§è¡Œç±»ä¸­æ–¹æ³•çš„èƒ½åŠ›ã€‚<br />é€šè¿‡åå°„ä½ å¯ä»¥**è·å–ä»»æ„ä¸€ä¸ªç±»**çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•ï¼Œä½ è¿˜å¯ä»¥è°ƒç”¨è¿™äº›æ–¹æ³•å’Œå±æ€§ã€‚\n<a name=\"W7tkA\"></a>\n\n## è·å– Class å¯¹è±¡çš„å››ç§æ–¹å¼\n\nå¦‚æœæˆ‘ä»¬åŠ¨æ€è·å–åˆ°è¿™äº›ä¿¡æ¯ï¼Œæˆ‘ä»¬éœ€è¦ä¾é  Class å¯¹è±¡ã€‚Class ç±»å¯¹è±¡å°†ä¸€ä¸ªç±»çš„æ–¹æ³•ã€å˜é‡ç­‰ä¿¡æ¯å‘Šè¯‰è¿è¡Œçš„ç¨‹åºã€‚è€ŒJava æä¾›äº†å››ç§æ–¹å¼è·å– Class å¯¹è±¡ï¼š\n\n- **çŸ¥é“å…·ä½“ç±»çš„æƒ…å†µä¸‹ï¼š**\n\n```java\nClass alunbarClass = TargetObject.class;\n```\n\n- **é€šè¿‡`Class.forName()`ä¼ å…¥ç±»çš„å…¨è·¯å¾„ï¼š**\n\n> æˆ‘ä»¬ä¸€èˆ¬æ˜¯ä¸çŸ¥é“å…·ä½“ç±»çš„ï¼ŒåŸºæœ¬éƒ½æ˜¯é€šè¿‡éå†åŒ…ä¸‹é¢çš„ç±»æ¥è·å– Class å¯¹è±¡ï¼Œé€šè¿‡æ­¤æ–¹å¼è·å– Class å¯¹è±¡ä¸ä¼šè¿›è¡Œåˆå§‹åŒ–\n\n```java\nClass alunbarClass1 = Class.forName(\"cn.smallboat.TargetObject\");\n```\n\n- **é€šè¿‡å¯¹è±¡å®ä¾‹`instance.getClass()`è·å–ï¼š**\n\n```java\nTargetObject o = new TargetObject();\nClass alunbarClass2 = o.getClass();\n```\n\n- **é€šè¿‡ç±»åŠ è½½å™¨`xxxClassLoader.loadClass()`ä¼ å…¥ç±»è·¯å¾„è·å–ï¼š**\n\n```java\nClassLoader.getSystemClassLoader().loadClass(\"cn.smallboat.TargetObject\");\n```\n\n> é€šè¿‡ç±»åŠ è½½å™¨è·å– Class å¯¹è±¡ä¸ä¼šè¿›è¡Œåˆå§‹åŒ–ï¼Œæ„å‘³ç€ä¸è¿›è¡ŒåŒ…æ‹¬åˆå§‹åŒ–ç­‰ä¸€ç³»åˆ—æ­¥éª¤ï¼Œé™æ€ä»£ç å—å’Œé™æ€å¯¹è±¡ä¸ä¼šå¾—åˆ°æ‰§è¡Œã€‚\n\n<a name=\"q7nLF\"></a>\n\n## åå°„çš„åŸºæœ¬æ“ä½œ\n\n- åˆ›å»ºä¸€ä¸ªç”¨æ¥åå°„çš„ç±»\n\n```java\npackage cn.smallboat;\n\npublic class TargetObject {\n    private String value;\n\n    public TargetObject() {\n        value = \"smallboat\";\n    }\n\n    public void publicMethod(String s) {\n        System.out.println(\"I love \" + s);\n    }\n\n    private void privateMethod() {\n        System.out.println(\"value is \" + value);\n    }\n}\n```\n\n- ä½¿ç”¨åå°„æ“ä½œè¿™ä¸ªç±»çš„æ–¹æ³•åŠå‚æ•°\n\n```java\npackage cn.smallboat;\n\nimport java.lang.reflect.Field;\nimport java.lang.reflect.InvocationTargetException;\nimport java.lang.reflect.Method;\n\npublic class Main {\n    public static void main(String[] args) throws ClassNotFoundException, NoSuchMethodException, IllegalAccessException, InstantiationException, InvocationTargetException, NoSuchFieldException {\n        /**\n         * è·å– TargetObject ç±»çš„ Class å¯¹è±¡å¹¶ä¸”åˆ›å»º TargetObject ç±»å®ä¾‹\n         */\n        Class<?> targetClass = Class.forName(\"cn.smallboat.TargetObject\");\n        TargetObject targetObject = (TargetObject) targetClass.newInstance();\n        /**\n         * è·å– TargetObject ç±»ä¸­å®šä¹‰çš„æ‰€æœ‰æ–¹æ³•\n         */\n        Method[] methods = targetClass.getDeclaredMethods();\n        /**\n         * è¾“å‡ºï¼špublicMethod\n                 privateMethod\n         */\n        for (Method method : methods) {\n            System.out.println(method.getName());\n        }\n\n        /**\n         * è·å–æŒ‡å®šæ–¹æ³•å¹¶è°ƒç”¨\n         */\n        Method publicMethod = targetClass.getDeclaredMethod(\"publicMethod\",\n                String.class);\n\n        // è¾“å‡ºï¼šI love smallboat\n        publicMethod.invoke(targetObject, \"smallboat\");\n\n        /**\n         * è·å–æŒ‡å®šå‚æ•°å¹¶å¯¹å‚æ•°è¿›è¡Œä¿®æ”¹\n         */\n        Field field = targetClass.getDeclaredField(\"value\");\n        //ä¸ºäº†å¯¹ç±»ä¸­çš„å‚æ•°è¿›è¡Œä¿®æ”¹æˆ‘ä»¬å–æ¶ˆå®‰å…¨æ£€æŸ¥\n        field.setAccessible(true);\n        field.set(targetObject, \"smallboat\");\n\n        /**\n         * è°ƒç”¨ private æ–¹æ³•\n         */\n        // è¾“å‡ºï¼š value is smallboat\n        Method privateMethod = targetClass.getDeclaredMethod(\"privateMethod\");\n        //ä¸ºäº†è°ƒç”¨privateæ–¹æ³•æˆ‘ä»¬å–æ¶ˆå®‰å…¨æ£€æŸ¥\n        privateMethod.setAccessible(true);\n        privateMethod.invoke(targetObject);\n    }\n}\n```\n\n<a name=\"DAAG3\"></a>\n\n# æ³¨è§£\n\n<a name=\"HkjvP\"></a>\n\n## ä»€ä¹ˆæ˜¯æ³¨è§£\n\nJavaæ³¨è§£ï¼ˆAnnotationï¼‰ï¼Œä¹Ÿå«`å…ƒæ•°æ®`ã€‚ä¸€ç§ä»£ç çº§åˆ«çš„è¯´æ˜ã€‚å®ƒæ˜¯`JDK1.5`åŠä»¥åç‰ˆæœ¬å¼•å…¥çš„ä¸€ä¸ªç‰¹æ€§ï¼Œä¸ç±»ã€æ¥å£ã€æšä¸¾æ˜¯åœ¨åŒä¸€ä¸ªå±‚æ¬¡ã€‚å®ƒå¯ä»¥å£°æ˜åœ¨`åŒ…ã€ç±»ã€å­—æ®µã€æ–¹æ³•ã€å±€éƒ¨å˜é‡ã€æ–¹æ³•å‚æ•°`ç­‰çš„å‰é¢ï¼Œç”¨æ¥å¯¹è¿™äº›å…ƒç´ è¿›è¡Œè¯´æ˜ï¼Œæ³¨é‡Šã€‚\n\n> **å…ƒæ•°æ®ï¼š** å…ƒæ•°æ®æ˜¯ä¸€ä¸ªéå¸¸å¹¿æ³›çš„æ¦‚å¿µï¼Œå…ƒæ•°æ®çš„å®šä¹‰ä¹Ÿéå¸¸ç®€å•ï¼Œåªè¦æ˜¯æè¿°æ•°æ®çš„æ•°æ®éƒ½æ˜¯å…ƒæ•°æ®ã€‚ä¸¾ä¸ªä¾‹å­ğŸŒ°ï¼šå¦‚æœæœ‰ä¸€ä¸ªæ•°å­—`20`ï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½çŸ¥é“`20`æ˜¯ä»€ä¹ˆï¼Œä½†æ˜¯æˆ‘ä»¬å¯¹å…¶åŠ ä»¥æè¿°ï¼Œä¾‹å¦‚`20å¤©`ã€`20kgé‡é‡`ï¼Œé‚£ä¹ˆ`å¤©æ•°`ã€`é‡é‡`è¿™ç±»ä¿¡æ¯å°±æ˜¯æè¿°20è¿™ä¸ªæ•°æ®çš„å…ƒæ•°æ®ã€‚\n\næ³¨è§£æ˜¯ä»¥`@æ³¨è§£å`åœ¨ä»£ç ä¸­å­˜åœ¨çš„ï¼Œæ ¹æ®æ³¨è§£å‚æ•°çš„ä¸ªæ•°ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ³¨è§£åˆ†ä¸ºï¼š`æ ‡è®°æ³¨è§£ã€å•å€¼æ³¨è§£ã€å®Œæ•´æ³¨è§£`ä¸‰ç±»ã€‚å®ƒä»¬éƒ½ä¸ä¼šç›´æ¥å½±å“åˆ°ç¨‹åºçš„è¯­ä¹‰ï¼Œåªæ˜¯ä½œä¸ºæ³¨è§£ï¼ˆæ ‡è¯†ï¼‰å­˜åœ¨ï¼Œ**æˆ‘ä»¬å¯ä»¥é€šè¿‡åå°„æœºåˆ¶ç¼–ç¨‹å®ç°å¯¹è¿™äº›å…ƒæ•°æ®ï¼ˆç”¨æ¥æè¿°æ•°æ®çš„æ•°æ®ï¼‰çš„è®¿é—®**ã€‚\n\n> **æ³¨æ„ï¼š** æ³¨è§£æœ¬èº«æ˜¯æ²¡æœ‰ä»»ä½•ä½œç”¨çš„ï¼Œæ¯”å¦‚`@RequestMapping`ï¼Œåœ¨`controller`å±‚`@RequestMapping`åŸºæœ¬ä¸Šå¯ä»¥è¯´æ˜¯å¿…è§çš„ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ä»–çš„ä½œç”¨æ˜¯è¯·æ±‚æ˜ å°„ï¼Œé€šè¿‡ä»–æ¥è®¾ç½®è¯·æ±‚çš„urlåœ°å€ï¼Œä¸¾ä¾‹ï¼šå°†`@RequestMapping(\"config\")`å†™åœ¨æ–¹æ³•ä¸Šï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡`url`åœ°å€è®¿é—®åˆ°è¿™ä¸ªæ–¹æ³•äº†ï¼Œä½†æ˜¯è®°ä½è¿™å¹¶ä¸æ˜¯`@RequestMapping`æ³¨è§£çš„åŠŸèƒ½ï¼Œ`SpringMVC`ä¼šé€šè¿‡åå°„å°†æ³¨è§£å½“ä¸­è®¾ç½®çš„å±æ€§å€¼`config`æ‹¿åˆ°ï¼Œç„¶åå°†`url`å’Œä½ å£°æ˜æ³¨è§£çš„æ–¹æ³•è¿›è¡Œç»‘å®šã€‚\n> **æ‰€ä»¥ï¼š** æ³¨è§£åªæ˜¯èµ·æ ‡è®°ä½œç”¨ï¼Œæ³¨è§£çœŸæ­£çš„åŠŸèƒ½éƒ½æ˜¯ç”±æ¡†æ¶é€šè¿‡åå°„æ¥å®ç°çš„ã€‚æ¢å¥è¯è¯´ï¼Œ**æ³¨è§£ç¦»å¼€äº†åå°„å•¥ä¹Ÿä¸æ˜¯ï¼**\n\n<a name=\"aMtr0\"></a>\n\n## æ³¨è§£çš„åˆ†ç±»\n\næ³¨è§£å¤§è‡´å¯ä»¥æ ¹æ®æ³¨è§£å‚æ•°ï¼ˆæˆå‘˜å˜é‡ï¼‰ä¸ªæ•°ã€æ³¨è§£ä½œç”¨è¿›è¡Œåˆ†ç±»ã€‚\n\n- æŒ‰ç…§æ³¨è§£å‚æ•°ä¸ªæ•°å¯åˆ†ä¸ºï¼š**æ ‡è®°æ³¨è§£ã€å•å…ƒç´ æ³¨è§£ã€å¤šå…ƒç´ æ³¨è§£**\n- æŒ‰ç…§æ³¨è§£ä½œç”¨å¯åˆ†ä¸ºï¼š**é¢„å®šä¹‰æ³¨è§£ã€å…ƒæ³¨è§£ã€è‡ªå®šä¹‰æ³¨è§£**\n  <a name=\"pYXOp\"></a>\n\n### æ ‡è®°æ³¨è§£\n\næ ‡è®°æ³¨è§£ä¸åŒ…å«æˆå‘˜/å…ƒç´ ã€‚å®ƒä»…ç”¨äºæ ‡è®°å£°æ˜ã€‚<br />å…¶è¯­æ³•ä¸ºï¼š`@AnnotationName()`\n\n> ç”±äºè¿™äº›æ³¨è§£ä¸åŒ…å«å…ƒç´ ï¼Œå› æ­¤ä¸éœ€è¦æ‹¬å·ã€‚ä¾‹å¦‚ï¼š`@Override`\n\n<a name=\"rDaws\"></a>\n\n### å•å…ƒç´ æ³¨è§£\n\nå•ä¸ªå…ƒç´ æ³¨è§£ä»…åŒ…å«ä¸€ä¸ªå…ƒç´ ã€‚<br />å…¶è¯­æ³•ä¸ºï¼š`@AnnotationName(elementName = \"elementValue\")`\n\n> å¦‚æœåªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œä¹ æƒ¯ä¸Šå°†è¯¥å…ƒç´ å‘½åä¸º`value`ï¼š`@AnnotationName(value = \"elementValue\")`\n> åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¹Ÿå¯ä»¥ç§»é™¤å…ƒç´ åç§°ã€‚å…ƒç´ åç§°é»˜è®¤ä¸º`value`ï¼š`@AnnotationName(\"elementValue\")`\n\n<a name=\"yv0CQ\"></a>\n\n### å¤šå…ƒç´ æ³¨è§£\n\nè¿™äº›æ³¨è§£åŒ…å«å¤šä¸ªç”¨é€—å·åˆ†éš”çš„å…ƒç´ ã€‚<br />å…¶è¯­æ³•ä¸ºï¼š`@AnnotationName(element1 = \"value1\", element2 = \"value2\")`\n<a name=\"qYXMJ\"></a>\n\n### é¢„å®šä¹‰æ³¨è§£\n\né¢„å®šä¹‰æ³¨è§£éƒ½æ˜¯`java.lang`åŒ…ä¸‹çš„ï¼Œä¹Ÿå°±æ˜¯Javaæä¾›çš„åŸºç¡€æ³¨è§£ï¼Œç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€å¯¼åŒ…ã€‚<br />é¢„å®šä¹‰æ³¨è§£æœ‰ï¼š\n\n- **`@Deprecated`** ï¼šè¯¥æ³¨è§£å¯ä½œç”¨äºæ–¹æ³•ã€å±æ€§ã€ç±»ï¼Œè¡¨ç¤ºå·²è¿‡æ—¶ï¼Œä¸å»ºè®®ä½¿ç”¨ï¼Œä½†ä»å¯ä»¥ä½¿ç”¨ã€‚\n- **`@Override`**ï¼šè¯¥æ³¨è§£çš„ä½œç”¨æ˜¯å¯¹è¦†ç›–è¶…ç±»ä¸­çš„æ–¹æ³•è¿›è¡Œæ ‡è®°ï¼Œå¦‚æœè¢«æ ‡è®°çš„æ–¹æ³•æœªè¢«å®é™…è¦†ç›–ï¼Œåˆ™ç¼–è¯‘å™¨ä¼šè­¦å‘Šã€‚\n- **`@SuppressWarnings`**ï¼šä½œç”¨æ˜¯æ¶ˆé™¤ç¼–è¯‘å™¨çš„è­¦å‘Šï¼Œæ»¡è¶³ç¨‹åºå‘˜çš„æ´ç™–ã€‚\n- **`@SafeVarargs`**ï¼šåœ¨å£°æ˜å…·æœ‰æ¨¡ç³Šç±»å‹ï¼ˆæ¯”å¦‚ï¼šæ³›å‹ï¼‰çš„å¯å˜å‚æ•°çš„æ„é€ å‡½æ•°æˆ–æ–¹æ³•æ—¶ï¼ŒJavaç¼–è¯‘å™¨ä¼šæŠ¥`unchecked`è­¦å‘Šã€‚é‰´äºè¿™äº›æƒ…å†µï¼Œå¦‚æœç¨‹åºå‘˜æ–­å®šå£°æ˜çš„æ„é€ å‡½æ•°å’Œæ–¹æ³•çš„ä¸»ä½“ä¸ä¼šå¯¹å…¶`varargs`å‚æ•°æ‰§è¡Œæ½œåœ¨çš„ä¸å®‰å…¨çš„æ“ä½œï¼Œå¯ä½¿ç”¨`@SafeVarargs`è¿›è¡Œæ ‡è®°ã€‚ä½†æ˜¯åªèƒ½ä½œç”¨äºæ„é€ å‡½æ•°å’Œ`static`æˆ–`final`ä¿®é¥°çš„å¯å˜é•¿å‚æ•°æ–¹æ³•ä¸Šã€‚\n- **`@FunctionalInterface`**ï¼šè¯¥æ³¨è§£åªèƒ½ä½œç”¨åŸŸå‡½æ•°æ¥å£ï¼Œæ ‡è®°è¯¥æ¥å£æ˜¯ä¸€ä¸ªå‡½æ•°æ¥å£ï¼Œä¸€æ—¦ä¸æ»¡è¶³å°±ä¼šæŠ¥é”™ã€‚\n  <a name=\"O6DzX\"></a>\n\n### å…ƒæ³¨è§£\n\nå…ƒæ³¨è§£éƒ½æ˜¯æ¥è‡ª`java.lang.annotation`åŒ…ä¸‹ï¼Œç”¨äºæè¿°æ³¨è§£çš„å±æ€§ï¼ˆå…ƒæ•°æ®æè¿°æ•°æ®ï¼Œå…ƒæ³¨è§£æè¿°æ³¨è§£ï¼‰ï¼Œæ‰€ä»¥è¿™äº›æ³¨è§£åªèƒ½ä¿®é¥°æ³¨è§£ï¼Œä½†æ˜¯`@Native`é™¤å¤–ï¼Œå®ƒæ˜¯ä½œç”¨äº`Field`ï¼ˆå­—æ®µï¼‰ã€‚<br />![1.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_40cef19b27-1.png)\n<a name=\"bWarX\"></a>\n\n### è‡ªå®šä¹‰æ³¨è§£\n\nè‡ªå®šä¹‰æ³¨è§£ä¸»è¦åŒ…å«ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š\n\n- å…ƒæ³¨è§£\n- `public @interface {æ³¨è§£å} {å±æ€§}`\n\n**è‡ªå®šä¹‰æ³¨è§£å®æˆ˜ï¼š**\n\n- è‡ªå®šä¹‰`@Init`æ³¨è§£\n\n```java\n@Documented\n@Inherited\n// å¯ä»¥åœ¨å­—æ®µã€æšä¸¾çš„å¸¸é‡ã€æ–¹æ³•\n@Target({ElementType.FIELD, ElementType.METHOD, ElementType.TYPE})\n@Retention(RetentionPolicy.RUNTIME)\npublic @interface Init {\n    String value() default \"\";\n}\n```\n\n- åˆ›å»º`User`ç±»\n\n```java\npublic class User {\n    private String name;\n    private String age;\n\n    public String getName() {\n        return name;\n    }\n\n    @Init(\"smallboat\")\n    public User setName(String name) {\n        this.name = name;\n        return this;\n    }\n\n    public String getAge() {\n        return age;\n    }\n\n    @Init(\"24\")\n    public User setAge(String age) {\n        this.age = age;\n        return this;\n    }\n}\n```\n\n- åˆ›å»º`UserFactory`å·¥å‚ï¼ˆæ³¨è§£å®é™…å‘æŒ¥ä½œç”¨çš„åœ°æ–¹ï¼‰\n\n```java\nimport java.lang.reflect.Method;\n\npublic class UserFactory {\n    public static User create() {\n        User user = new User();\n        // é€šè¿‡åå°„è·å– User ç±»ä¸­æ‰€æœ‰çš„æ–¹æ³•ï¼ˆgetDeclaredMethodsä¹Ÿè¡Œï¼‰\n        Method[] methods = User.class.getMethods();\n        try {\n            for (Method method : methods) {\n                // åˆ¤æ–­æ–¹æ³•ä¸Šæ˜¯å¦å­˜åœ¨Initæ³¨è§£ï¼Œå­˜åœ¨å°±è¿”å›trueï¼Œå¦åˆ™è¿”å›false\n                if (method.isAnnotationPresent(Init.class)) {\n                    // æ­¤æ–¹æ³•è¿”å›è¯¥å…ƒç´ çš„æ³¨è§£åœ¨æ­¤å…ƒç´ çš„æŒ‡å®šæ³¨é‡Šç±»å‹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œå¦åˆ™è¿”å›null\n                    Init init = method.getAnnotation(Init.class);\n                    // å¦‚æœMethodä»£è¡¨äº†ä¸€ä¸ªæ–¹æ³• é‚£ä¹ˆè°ƒç”¨å®ƒçš„invokeå°±ç›¸å½“äºæ‰§è¡Œäº†å®ƒä»£è¡¨çš„è¿™ä¸ªæ–¹æ³•,åœ¨è¿™é‡Œå°±æ˜¯ç»™setæ–¹æ³•èµ‹å€¼\n                    method.invoke(user, init.value());\n                }\n            }\n        } catch (Exception e) {\n            e.printStackTrace();\n            return null;\n        }\n        return user;\n    }\n}\n```\n\n- æµ‹è¯•\n\n```java\npublic static void main(String[] args) {\n    User user = UserFactory.create();\n    user.setAge(\"25\");\n    System.out.println(user.getName());\n    System.out.println(user.getAge());\n}\n```\n\n- è¾“å‡ºç»“æœ\n\n```java\nsmallboat\n25\n```\n\n<a name=\"Um7qU\"></a>\n\n# åŠ¨æ€ä»£ç†\n\n<a name=\"qYJcC\"></a>\n\n## ä»€ä¹ˆæ˜¯åŠ¨æ€ä»£ç†\n\n**åŠ¨æ€ä»£ç†ï¼ˆDynamic Proxyï¼‰** æ˜¯ä¸€ç§åœ¨è¿è¡Œæ—¶åŠ¨æ€åˆ›å»ºä»£ç†å¯¹è±¡çš„æœºåˆ¶ï¼Œå®ƒå…è®¸ä½ åœ¨è°ƒç”¨å®é™…å¯¹è±¡çš„æ–¹æ³•ä¹‹å‰æˆ–ä¹‹åæ‰§è¡Œé¢å¤–çš„é€»è¾‘ã€‚åŠ¨æ€ä»£ç†é€šå¸¸ç”¨äºå®ç°æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆcross-cutting concernsï¼‰å¦‚æ—¥å¿—è®°å½•ã€æ€§èƒ½ç›‘æµ‹ã€äº‹åŠ¡ç®¡ç†ç­‰ã€‚<br />**åŠ¨æ€ä»£ç†çš„å·¥ä½œåŸç†**æ˜¯åœ¨è¿è¡Œæ—¶åˆ›å»ºä¸€ä¸ªä»£ç†ç±»æˆ–è€…ä»£ç†å¯¹è±¡ï¼Œè¿™ä¸ªä»£ç†å¯¹è±¡å®ç°äº†ä¸è¢«ä»£ç†å¯¹è±¡ç›¸åŒçš„æ¥å£ï¼ŒåŒæ—¶è¿˜åŒ…å«äº†é¢å¤–çš„é€»è¾‘ã€‚å½“è°ƒç”¨ä»£ç†å¯¹è±¡çš„æ–¹æ³•æ—¶ï¼Œå®é™…ä¸Šæ˜¯è°ƒç”¨äº†ä»£ç†å¯¹è±¡çš„å¤„ç†å™¨ï¼ˆInvocationHandlerï¼‰ä¸­çš„é€»è¾‘ï¼Œå¤„ç†å™¨å†å†³å®šæ˜¯å¦è°ƒç”¨è¢«ä»£ç†å¯¹è±¡çš„æ–¹æ³•ä»¥åŠåœ¨ä½•æ—¶è°ƒç”¨ã€‚<br />**åŠ¨æ€ä»£ç†çš„ä½œç”¨**åœ¨äºåˆ›å»ºä»£ç†å¯¹è±¡å¯¹åŸæœ‰å¯¹è±¡è¿›è¡ŒåŠŸèƒ½å¢å¼ºçš„åŒæ—¶ï¼Œé™ä½ç¨‹åºçš„è€¦åˆåº¦ã€‚<br />å½“å‰å®ç°åŠ¨æ€ä»£ç†çš„æ–¹å¼æœ‰ä¸¤ç§ï¼š\n\n- JDKæä¾›çš„åŠ¨æ€ä»£ç†\n- ç¬¬ä¸‰æ–¹æä¾›çš„CGLIBåŠ¨æ€ä»£ç†\n\nä¸¤è€…çš„**åŒºåˆ«**ï¼š\n\n- JDK åŠ¨æ€ä»£ç†åªèƒ½ä»£ç†å®ç°äº†æ¥å£çš„ç±»ï¼Œè€Œ CGLIB åŠ¨æ€ä»£ç†å¯ä»¥ä»£ç†æ²¡æœ‰å®ç°æ¥å£çš„ç±»ã€‚\n- JDK åŠ¨æ€ä»£ç†ç”Ÿæˆçš„ä»£ç†ç±»æ˜¯ç›®æ ‡ç±»çš„æ¥å£çš„å®ç°ç±»ï¼Œè€Œ CGLIB åŠ¨æ€ä»£ç†ç”Ÿæˆçš„ä»£ç†ç±»æ˜¯ç›®æ ‡ç±»çš„å­ç±»ã€‚\n- JDK åŠ¨æ€ä»£ç†ä¸éœ€è¦é¢å¤–çš„ä¾èµ–ï¼Œè€Œ CGLIB åŠ¨æ€ä»£ç†éœ€è¦å•ç‹¬çš„ä¾èµ–ã€‚\n- JDK åŠ¨æ€ä»£ç†æ€§èƒ½ç›¸å¯¹è¾ƒä½ï¼Œå› ä¸ºä½¿ç”¨äº†åå°„ï¼Œè€Œ CGLIB åŠ¨æ€ä»£ç†æ€§èƒ½ç›¸å¯¹è¾ƒé«˜ï¼Œå› ä¸ºä½¿ç”¨äº†å­—èŠ‚ç æŠ€æœ¯ã€‚\n> å›¾ç‰‡æ¥è‡ª[JavaGuide](https://javaguide.cn/system-design/framework/spring/spring-knowledge-and-questions-summary.html#spring-aop)\n- ![aop.jpeg](https://cdn.acwing.com/media/article/image/2024/06/19/126318_a8bb03b62e-aop.jpeg)\n\n## JDKåŠ¨æ€ä»£ç†\n\nJDK åŠ¨æ€ä»£ç†æ˜¯ Java æ ‡å‡†åº“æä¾›çš„ä¸€ç§åŠ¨æ€ä»£ç†æœºåˆ¶ï¼Œå®ƒå…è®¸åœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆä»£ç†ç±»å’Œä»£ç†å¯¹è±¡ï¼Œç”¨äºå®ç°æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆcross-cutting concernsï¼‰å¦‚æ—¥å¿—è®°å½•ã€æ€§èƒ½ç›‘æµ‹ã€äº‹åŠ¡ç®¡ç†ç­‰ã€‚JDK åŠ¨æ€ä»£ç†ä¸»è¦åŸºäºä¸¤ä¸ªæ ¸å¿ƒç±»ï¼š`java.lang.reflect.Proxy` å’Œ `java.lang.reflect.InvocationHandler`ã€‚<br />**ç‰¹ç‚¹ï¼š**\n\n- JDK åŠ¨æ€ä»£ç†æ˜¯ Java æ ‡å‡†åº“çš„ä¸€éƒ¨åˆ†ï¼Œä¸éœ€è¦é¢å¤–çš„ä¾èµ–ã€‚\n- å®ƒåªèƒ½ä»£ç†å®ç°äº†æ¥å£çš„ç±»ï¼Œå³ç›®æ ‡ç±»å¿…é¡»å®ç°è‡³å°‘ä¸€ä¸ªæ¥å£ã€‚\n- ä½¿ç”¨åå°„ç”Ÿæˆä»£ç†ç±»å’Œä»£ç†å¯¹è±¡ï¼Œä»£ç†ç±»å’Œä»£ç†å¯¹è±¡éƒ½æ˜¯åœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆçš„ã€‚\n- ä»£ç†ç±»å’Œä»£ç†å¯¹è±¡éƒ½æ˜¯ç›´æ¥å®ç°äº†è¢«ä»£ç†æ¥å£çš„ï¼Œå› æ­¤ä¸éœ€è¦ç»§æ‰¿è¢«ä»£ç†ç±»ã€‚\n\n**ä¼˜ç‚¹ï¼š**\n\n- DK åŠ¨æ€ä»£ç†æ˜¯ Java æ ‡å‡†åº“çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤ä¸éœ€è¦é¢å¤–çš„ä¾èµ–ã€‚\n- ç›¸å¯¹ç®€å•æ˜“ç”¨ï¼Œé€‚ç”¨äºä»£ç†æ¥å£çš„åœºæ™¯ã€‚\n\n**ç¼ºç‚¹ï¼š**\n\n- åªèƒ½ä»£ç†æ¥å£ï¼Œæ— æ³•ä»£ç†ç±»ã€‚\n- è¦æ±‚ç›®æ ‡ç±»å¿…é¡»å®ç°æ¥å£ï¼Œæœ‰æ—¶ä¼šå¯¼è‡´ä»£ç ç»“æ„çš„è°ƒæ•´ã€‚\n- æ€§èƒ½ç›¸å¯¹è¾ƒä½ï¼Œå› ä¸ºä»£ç†ç±»å’Œä»£ç†å¯¹è±¡éƒ½æ˜¯é€šè¿‡åå°„åŠ¨æ€ç”Ÿæˆçš„ã€‚\n\n**ä»£ç ç¤ºä¾‹ï¼ˆå®ç°addåŠŸèƒ½çš„åŒæ—¶å¢åŠ æ—¥å¿—ï¼‰ï¼š**\n\n- å®šä¹‰æ¥å£\n\n```java\ninterface Calculator {\n    int add(int a, int b);\n}\n```\n\n- å®šä¹‰æ¥å£å®ç°ç±»\n\n```java\nclass CalculatorImpl implements Calculator {\n    public int add(int a, int b) {\n        return a + b;\n    }\n}\n```\n\n- å®ç°`InvocationHandler`æ¥å£ï¼ˆæ—¥å¿—è®°å½•æ‹¦æˆªå™¨ï¼‰\n\n```java\nclass LoggingHandler implements InvocationHandler {\n    private Object target;\n\n    public LoggingHandler(Object target) {\n        this.target = target;\n    }\n\n    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n        // åœ¨æ–¹æ³•è°ƒç”¨å‰è®°å½•æ—¥å¿—\n        System.out.println(\"Before calling method: \" + method.getName());\n        \n        // è°ƒç”¨å®é™…å¯¹è±¡çš„æ–¹æ³•\n        Object result = method.invoke(target, args);\n        \n        // åœ¨æ–¹æ³•è°ƒç”¨åè®°å½•æ—¥å¿—\n        System.out.println(\"After calling method: \" + method.getName());\n        \n        return result;\n    }\n}\n```\n\n- ä½¿ç”¨ä»£ç†å¤„ç†ä¸šåŠ¡\n\n```java\npublic class DynamicProxyExample {\n    public static void main(String[] args) {\n        // åˆ›å»ºå®é™…å¯¹è±¡\n        CalculatorImpl calculator = new CalculatorImpl();\n        \n        // åˆ›å»ºæ—¥å¿—è®°å½•å¤„ç†å™¨\n        LoggingHandler handler = new LoggingHandler(calculator);\n        \n        // åˆ›å»ºåŠ¨æ€ä»£ç†å¯¹è±¡\n        Calculator proxy = (Calculator) Proxy.newProxyInstance(\n                Calculator.class.getClassLoader(),\n                new Class[] { Calculator.class },\n                handler);\n\n        // ä½¿ç”¨ä»£ç†å¯¹è±¡è°ƒç”¨æ–¹æ³•ï¼Œå®é™…ä¸Šä¼šè§¦å‘æ—¥å¿—è®°å½•\n        int result = proxy.add(5, 3);\n        System.out.println(\"Result: \" + result);\n    }\n}\n```\n\n<a name=\"qbtzx\"></a>\n\n## CGLIBåŠ¨æ€ä»£ç†\n\nCGLIB æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ã€é«˜æ€§èƒ½çš„ä»£ç ç”Ÿæˆåº“ï¼Œå®ƒç”¨äºåœ¨è¿è¡Œæ—¶ç”Ÿæˆå­—èŠ‚ç ï¼Œé€šè¿‡æ‰©å±•è¢«ä»£ç†ç±»æ¥åˆ›å»ºä»£ç†å¯¹è±¡ã€‚ä¸ Java æ ‡å‡†åº“ä¸­çš„åŠ¨æ€ä»£ç†ä¸åŒï¼ŒCGLIB å¯ä»¥ä»£ç†é‚£äº›æ²¡æœ‰å®ç°æ¥å£çš„ç±»ï¼Œå¹¶ä¸”ä¸éœ€è¦ç›®æ ‡å¯¹è±¡å®ç°ä»»ä½•æ¥å£ã€‚<br />**ç‰¹ç‚¹ï¼š**\n\n- CGLIB æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ç¬¬ä¸‰æ–¹åº“ï¼Œéœ€è¦å•ç‹¬çš„ä¾èµ–ã€‚\n- å®ƒèƒ½å¤Ÿä»£ç†æ²¡æœ‰å®ç°æ¥å£çš„ç±»ï¼Œå³ç›®æ ‡ç±»å¯ä»¥æ˜¯æ™®é€šçš„ç±»ï¼Œè€Œä¸éœ€è¦å®ç°æ¥å£ã€‚\n- ä½¿ç”¨å­—èŠ‚ç æŠ€æœ¯ç”Ÿæˆä»£ç†ç±»ï¼Œä»£ç†ç±»æ˜¯ç›®æ ‡ç±»çš„å­ç±»ï¼Œå› æ­¤å¯ä»¥ä»£ç† final ç±»å’Œæ–¹æ³•ã€‚\n- ç”Ÿæˆçš„ä»£ç†å¯¹è±¡æ˜¯ç›®æ ‡ç±»çš„å­ç±»ï¼Œå› æ­¤éœ€è¦ç»§æ‰¿ç›®æ ‡ç±»ã€‚\n\n**ä¼˜ç‚¹ï¼š**\n\n- èƒ½å¤Ÿä»£ç†æ²¡æœ‰å®ç°æ¥å£çš„ç±»ï¼Œæ›´åŠ çµæ´»ã€‚\n- æ€§èƒ½ç›¸å¯¹è¾ƒé«˜ï¼Œå› ä¸ºä»£ç†ç±»æ˜¯ç›®æ ‡ç±»çš„å­ç±»ï¼Œä¸éœ€è¦ä½¿ç”¨åå°„ã€‚\n\n**ç¼ºç‚¹ï¼š**\n\n- éœ€è¦é¢å¤–çš„ä¾èµ–ï¼Œä¸æ˜¯ Java æ ‡å‡†åº“çš„ä¸€éƒ¨åˆ†ã€‚\n- ç”Ÿæˆçš„ä»£ç†ç±»æ˜¯ç›®æ ‡ç±»çš„å­ç±»ï¼Œå¯èƒ½ä¼šæœ‰ç±»åŠ è½½å™¨å’Œå­—èŠ‚ç å…¼å®¹æ€§ç­‰é—®é¢˜ã€‚\n- æ— æ³•ä»£ç† final ç±»å’Œæ–¹æ³•ä»¥åŠ static æ–¹æ³•ã€‚\n\n**ä»£ç ç¤ºä¾‹ï¼ˆå®ç°addåŠŸèƒ½çš„åŒæ—¶å¢åŠ æ—¥å¿—ï¼‰ï¼š**\n\n- å®é™…å®ç°ç±»ï¼ˆæ³¨æ„è¿™æ¬¡ä¸éœ€è¦å®ç°æ¥å£ï¼‰\n\n```java\nclass Calculator {\n    public int add(int a, int b) {\n        return a + b;\n    }\n}\n```\n\n- å®ç°`InvocationHandler`æ¥å£ï¼ˆæ—¥å¿—è®°å½•æ‹¦æˆªå™¨ï¼‰\n\n```java\nclass LoggingInterceptor implements MethodInterceptor {\n    public Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) throws Throwable {\n        // åœ¨æ–¹æ³•è°ƒç”¨å‰è®°å½•æ—¥å¿—\n        System.out.println(\"Before calling method: \" + method.getName());\n        \n        // è°ƒç”¨å®é™…å¯¹è±¡çš„æ–¹æ³•\n        Object result = proxy.invokeSuper(obj, args);\n        \n        // åœ¨æ–¹æ³•è°ƒç”¨åè®°å½•æ—¥å¿—\n        System.out.println(\"After calling method: \" + method.getName());\n        \n        return result;\n    }\n}\n```\n\n- ä½¿ç”¨ä»£ç†å¤„ç†ä¸šåŠ¡\n\n```java\npublic class CglibProxyExample {\n    public static void main(String[] args) {\n        // åˆ›å»º Enhancer å¯¹è±¡ï¼Œç”¨äºç”Ÿæˆä»£ç†ç±»\n        Enhancer enhancer = new Enhancer();\n        // è®¾ç½®è¢«ä»£ç†ç±»\n        enhancer.setSuperclass(Calculator.class);\n        // è®¾ç½®æ‹¦æˆªå™¨\n        enhancer.setCallback(new LoggingInterceptor());\n        \n        // åˆ›å»ºä»£ç†å¯¹è±¡\n        Calculator proxy = (Calculator) enhancer.create();\n\n        // ä½¿ç”¨ä»£ç†å¯¹è±¡è°ƒç”¨æ–¹æ³•ï¼Œå®é™…ä¸Šä¼šè§¦å‘æ—¥å¿—è®°å½•\n        int result = proxy.add(5, 3);\n        System.out.println(\"Result: \" + result);\n    }\n}\n```","categories":["JavaåŸºç¡€"]},{"title":"Redis å®æˆ˜ç¯‡","url":"/2024/03/18/Rediså®æˆ˜ç¯‡/","content":"\n> authorï¼šSmallBoat\n\n<a name=\"LQFnK\"></a>\n\n## å†…å®¹æ¦‚è¿°\n\n**å½“ä¸‹ä¸»æµæ¨¡å‹ä»‹ç»ï¼š**<br />æ‰‹æœºæˆ–è€…appç«¯å‘èµ·è¯·æ±‚ï¼Œè¯·æ±‚æˆ‘ä»¬çš„nginxæœåŠ¡å™¨ï¼ŒnginxåŸºäºä¸ƒå±‚æ¨¡å‹èµ°çš„æ˜¯HTTPåè®®ï¼Œå¯ä»¥å®ç°åŸºäºLuaç›´æ¥ç»•å¼€tomcatè®¿é—®redisï¼Œä¹Ÿå¯ä»¥ä½œä¸ºé™æ€èµ„æºæœåŠ¡å™¨ï¼Œè½»æ¾æ‰›ä¸‹ä¸Šä¸‡å¹¶å‘ï¼Œ è´Ÿè½½å‡è¡¡åˆ°ä¸‹æ¸¸tomcatæœåŠ¡å™¨ï¼Œæ‰“æ•£æµé‡ã€‚æˆ‘ä»¬éƒ½çŸ¥é“ä¸€å°4æ ¸8Gçš„tomcatï¼Œåœ¨ä¼˜åŒ–å’Œå¤„ç†ç®€å•ä¸šåŠ¡çš„åŠ æŒä¸‹ï¼Œæœ€å¤šèƒ½å¤„ç†1000å·¦å³çš„å¹¶å‘ï¼Œ ç»è¿‡nginxçš„è´Ÿè½½å‡è¡¡åˆ†æµåï¼Œåˆ©ç”¨é›†ç¾¤æ”¯æ’‘èµ·æ•´ä¸ªé¡¹ç›®ï¼ŒåŒæ—¶nginxåœ¨éƒ¨ç½²äº†å‰ç«¯é¡¹ç›®åï¼Œæ›´æ˜¯å¯ä»¥åšåˆ°åŠ¨é™åˆ†ç¦»ï¼Œè¿›ä¸€æ­¥é™ä½tomcatæœåŠ¡çš„å‹åŠ›ï¼Œè¿™äº›åŠŸèƒ½éƒ½å¾—é nginxèµ·ä½œç”¨ï¼Œæ‰€ä»¥nginxæ˜¯æ•´ä¸ªé¡¹ç›®ä¸­é‡è¦çš„ä¸€ç¯ã€‚<br />åœ¨tomcatæ”¯æ’‘èµ·å¹¶å‘æµé‡åï¼Œæˆ‘ä»¬å¦‚æœè®©tomcatç›´æ¥å»è®¿é—®Mysqlï¼Œæ ¹æ®ç»éªŒMysqlä¼ä¸šçº§æœåŠ¡å™¨ä¸€èˆ¬æ˜¯16æˆ–32æ ¸å¿ƒcpuï¼Œ32æˆ–64Gå†…å­˜ï¼Œå°±ç®—æ˜¯ä¼ä¸šçº§mysqlåŠ ä¸Šå›ºæ€ç¡¬ç›˜èƒ½å¤Ÿæ”¯æ’‘çš„å¹¶å‘ï¼Œå¤§æ¦‚å°±æ˜¯4000~7000å·¦å³ï¼Œä¸Šä¸‡å¹¶å‘ï¼Œ ç¬é—´å°±ä¼šè®©MysqlæœåŠ¡å™¨çš„cpuï¼Œç¡¬ç›˜å…¨éƒ¨æ‰“æ»¡ã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œä¼šé€‰æ‹©ä½¿ç”¨mysqlé›†ç¾¤ï¼ŒåŒæ—¶ä¸ºäº†è¿›ä¸€æ­¥é™ä½Mysqlçš„å‹åŠ›ï¼ŒåŒæ—¶å¢åŠ è®¿é—®çš„æ€§èƒ½ï¼Œæˆ‘ä»¬ä¹Ÿä¼šåŠ å…¥Redisï¼ŒåŒæ—¶ä½¿ç”¨Redisé›†ç¾¤ä½¿å¾—Rediså¯¹å¤–æä¾›æ›´å¥½çš„æœåŠ¡ã€‚<br />**çŸ­ä¿¡ç™»å½•ï¼š**\n\n- ä»£ç å®ç°ç™»å½•ç›¸å…³å†…å®¹ï¼šå¦‚å®ç°çŸ­ä¿¡éªŒè¯ç ç™»å½•ã€ç™»å½•æ ¡éªŒæ‹¦æˆªã€è§£å†³Sessionå…±äº«é—®é¢˜ç­‰\n- é€šè¿‡Rediså…±äº«Sessionå®ç°çŸ­ä¿¡ç™»å½•çš„éªŒè¯\n\n**å•†æˆ·æŸ¥è¯¢ç¼“å­˜ï¼š**\n\n- å¸¸è§çš„ç¼“å­˜æ›´æ–°ç­–ç•¥\n- åˆ†æå¹¶è§£å†³ç¼“å­˜ç©¿é€ã€ç¼“å­˜é›ªå´©ã€ç¼“å­˜å‡»ç©¿ç­‰é—®é¢˜\n- å°è£…Rediså·¥å…·ç±»\n\n**ä¼˜æƒ åˆ¸ç§’æ€ï¼ˆ4-8ç« ï¼‰ï¼š**\n\n- é€šè¿‡ä¹è§‚é”ã€æ‚²è§‚é”è§£å†³ä¼˜æƒ åˆ¸ä¸‹å•ä¸šåŠ¡çš„çº¿ç¨‹å®‰å…¨é—®é¢˜\n- Luaè„šæœ¬å®ç°åŸå­æ“ä½œ\n- Rediså®ç°åˆ†å¸ƒå¼é”åŠåˆ†å¸ƒå¼è§£å†³æ¡†æ¶Redisson\n- Rediså®ç°æ¶ˆæ¯é˜Ÿåˆ—\n\n**è¾¾äººæ¢åº—ï¼š**\n\n- åˆ©ç”¨Setå¯¹ç‚¹èµç”¨æˆ·åˆ¤é‡\n- åˆ©ç”¨SortedSetå¯¹ç‚¹èµç”¨æˆ·è¿›è¡Œæ’å\n\n**å¥½å‹å…³æ³¨ï¼š**\n\n- åˆ©ç”¨Seté›†åˆå¿«é€Ÿæ±‚å‡ºå…±åŒå…³æ³¨ï¼ˆäº¤é›†ï¼‰\n- åˆ©ç”¨Feedæµå®ç°æ¶ˆæ¯æ¨é€\n\n**é™„è¿‘å•†æˆ·ï¼š**\n\n- åˆ©ç”¨GEOæ•°æ®ç»“æ„å®ç°é™„è¿‘å•†æˆ·çš„æŸ¥è¯¢\n\n**ç”¨æˆ·ç­¾åˆ°ï¼š**\n\n- åˆ©ç”¨BitMapå®ç°ç”¨æˆ·ç­¾åˆ°åŠŸèƒ½åŠè¿ç»­ç­¾åˆ°å¤©æ•°ç»Ÿè®¡\n- ç®€å•åˆ†æå¸ƒéš†è¿‡æ»¤å™¨è§£å†³ç¼“å­˜ç©¿é€é—®é¢˜æ€è·¯\n\n**UVç»Ÿè®¡ï¼š**\n\n- åˆ©ç”¨HyperLogLogæ•°æ®ç»“æ„å®ç°ç™¾ä¸‡UVç»Ÿè®¡\n  <a name=\"d2Ghb\"></a>\n\n## çŸ­ä¿¡ç™»å½•\n\n<a name=\"rbqgw\"></a>\n\n### åŸºäºSessionå®ç°ç™»å½•æµç¨‹\n\n!![1.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_5fe0ce7427-1.png) <br />**å®ç°å‘é€éªŒè¯ç ï¼š**\n\n```java\n@Override\npublic Result sendCode(String phone, HttpSession session) {\n    // 1.æ ¡éªŒæ‰‹æœºå·\n    if (RegexUtils.isPhoneInvalid(phone)) {\n        // 2.å¦‚æœä¸ç¬¦åˆï¼Œè¿”å›é”™è¯¯ä¿¡æ¯\n        return Result.fail(\"æ‰‹æœºå·æ ¼å¼é”™è¯¯ï¼\");\n    }\n    // 3.ç¬¦åˆï¼Œç”ŸæˆéªŒè¯ç \n    String code = RandomUtil.randomNumbers(6);\n\n    // 4.ä¿å­˜éªŒè¯ç åˆ° session\n    session.setAttribute(\"code\", code);\n\n    // 5.å‘é€éªŒè¯ç ï¼ˆå¹¶æ²¡æœ‰çœŸæ­£å‘é€ï¼Œåªæ˜¯å­˜åˆ°æ—¥å¿—é‡Œï¼‰\n    log.debug(\"å‘é€çŸ­ä¿¡éªŒè¯ç æˆåŠŸï¼ŒéªŒè¯ç ï¼š{}\", code);\n    // è¿”å›ok\n    return Result.ok();\n}\n```\n\n**å®ç°éªŒè¯ç ç™»å½•ä¸æ³¨å†Œï¼š**\n\n```java\n@Override\npublic Result login(LoginFormDTO loginForm, HttpSession session) {\n    // 1.æ ¡éªŒæ‰‹æœºå·\n    String phone = loginForm.getPhone();\n    if (RegexUtils.isPhoneInvalid(phone)) {\n        // 2.å¦‚æœä¸ç¬¦åˆï¼Œè¿”å›é”™è¯¯ä¿¡æ¯\n        return Result.fail(\"æ‰‹æœºå·æ ¼å¼é”™è¯¯ï¼\");\n    }\n    // 3.ä»sessionè·å–éªŒè¯ç å¹¶æ ¡éªŒ\n    Object cacheCode = session.getAttribute(\"code\");\n    String code = loginForm.getCode();\n    if (cacheCode == null || !cacheCode.toString().equals(code)) {\n        // ä¸ä¸€è‡´ï¼ŒæŠ¥é”™\n        return Result.fail(\"éªŒè¯ç é”™è¯¯\");\n    }\n\n    // 4.ä¸€è‡´ï¼Œæ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ· select * from tb_user where phone = ?\n    User user = query().eq(\"phone\", phone).one();\n\n    // 5.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨\n    if (user == null) {\n        // 6.ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ç”¨æˆ·å¹¶ä¿å­˜\n        user = createUserWithPhone(phone);\n    }\n\n    // 7.ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ° sessionä¸­\n    session.setAttribute(\"user\", BeanUtil.copyProperties(user, UserDTO.class));\n    return Result.ok();\n}\n\nprivate User createUserWithPhone(String phone) {\n    // 1.åˆ›å»ºç”¨æˆ·\n    User user = new User();\n    user.setPhone(phone);\n    user.setNickName(USER_NICK_NAME_PREFIX + RandomUtil.randomString(10));\n    // 2.ä¿å­˜ç”¨æˆ·\n    save(user);\n    return user;\n}\n```\n\n<a name=\"Yr548\"></a>\n\n### å®ç°ç™»å½•æ‹¦æˆªåŠŸèƒ½\n\n**å‰ç½®çŸ¥è¯†ï¼š**\n\n- **tomcatè¿è¡ŒåŸç†ï¼š** æ¯æ¬¡ç”¨æˆ·è¯·æ±‚è¿‡æ¥æ—¶ï¼Œä¼šè®¿é—®æˆ‘ä»¬åœ¨tomcatæ³¨å†Œçš„ç«¯å£ï¼Œä»»ä½•ç¨‹åºæƒ³è¦è¿è¡Œï¼Œéƒ½éœ€è¦æœ‰ä¸€ä¸ªçº¿ç¨‹å¯¹å½“å‰ç«¯å£å·è¿›è¡Œç›‘å¬ï¼Œtomcatä¹Ÿä¸ä¾‹å¤–ï¼Œå½“ç›‘å¬çº¿ç¨‹çŸ¥é“ç”¨æˆ·æƒ³è¦å’Œtomcatè¿æ¥æ—¶ï¼Œå°±ä¼šç”±ç›‘å¬çº¿ç¨‹åˆ›å»ºsocketè¿æ¥ï¼Œsocketéƒ½æ˜¯æˆå¯¹å‡ºç°çš„ï¼Œç”¨æˆ·é€šè¿‡socketä¼ é€’æ•°æ®ï¼Œå½“tomcatç«¯çš„socketæ¥å—åˆ°æ•°æ®åï¼Œæ­¤æ—¶ç›‘å¬çº¿ç¨‹ä¼šä»tomcatçš„çº¿ç¨‹æ± ä¸­å–å‡ºä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œç”¨æˆ·è¯·æ±‚ï¼Œåœ¨æˆ‘ä»¬çš„æœåŠ¡éƒ¨ç½²åˆ°tomcatåï¼Œçº¿ç¨‹ä¼šæ‰¾åˆ°ç”¨æˆ·æƒ³è¦è®¿é—®çš„å·¥ç¨‹ï¼Œç„¶åç”¨è¿™ä¸ªçº¿ç¨‹è½¬å‘åˆ°å·¥ç¨‹ä¸­çš„controllerï¼Œserviceï¼Œdaoä¸­ï¼Œå¹¶ä¸”è®¿é—®å¯¹åº”çš„DBï¼Œåœ¨ç”¨æˆ·æ‰§è¡Œå®Œè¯·æ±‚åï¼Œå†ç»Ÿä¸€è¿”å›ï¼Œå†æ‰¾åˆ°tomcatç«¯çš„socketï¼Œå†å°†æ•°æ®å†™å›åˆ°ç”¨æˆ·ç«¯çš„socketï¼Œå®Œæˆè¯·æ±‚å’Œå“åº”ã€‚\n\n![2.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_646c078627-2.png)\n\n- **çº¿ç¨‹éš”ç¦»ï¼š** æ¯ä¸ªç”¨æˆ·éƒ½æ˜¯å»æ‰¾tomcatçº¿ç¨‹æ± ä¸­çš„ä¸€ä¸ªçº¿ç¨‹æ¥å®Œæˆå·¥ä½œï¼Œä½¿ç”¨å®Œæˆåå†è¿›è¡Œå›æ”¶ï¼Œå¹¶ä¸”æ¯ä¸ªè¯·æ±‚éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œæ‰€ä»¥åœ¨æ¯ä¸ªç”¨æˆ·å»è®¿é—®æˆ‘ä»¬çš„å·¥ç¨‹æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨threadlocalæ¥åšåˆ°çº¿ç¨‹éš”ç¦»ï¼Œä½¿å¾—æ¯ä¸ªçº¿ç¨‹æ“ä½œè‡ªå·±çš„ä¸€ä»½æ•°æ®ã€‚\n\nåŸºäºä»¥ä¸Šæƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥åœ¨çº¿ç¨‹è½¬å‘åˆ°å¯¹åº”çš„controllerä¹‹å‰å¯¹ç”¨æˆ·èº«ä»½è¿›è¡Œæ ¡éªŒï¼Œæ£€æŸ¥Sessionä¸­çš„useræ˜¯å¦ä¸ºnullã€‚<br />![3.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_6849d26327-3.png) <br />**å®ç°æ‹¦æˆªå™¨ï¼š**\n\n```java\npublic class LoginInterceptor implements HandlerInterceptor {\n\n    @Override\n    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {\n        // 1.è·å–session\n        HttpSession session = request.getSession();\n        // 2.è·å–sessionä¸­çš„ç”¨æˆ·\n        Object user = session.getAttribute(\"user\");\n        // 3.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨\n        if(user == null) {\n              // 4.ä¸å­˜åœ¨ï¼Œæ‹¦æˆªï¼Œè¿”å›401çŠ¶æ€ç \n              response.setStatus(401);\n              return false;\n        }\n        // 5.å­˜åœ¨ï¼Œä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°Threadlocal\n        UserHolder.saveUser((User)user);\n        // 6.æ”¾è¡Œ\n        return true;\n    }\n}\n```\n\n**å°†æ‹¦æˆªå™¨é…ç½®åˆ°MvcConfigä½¿å…¶ç”Ÿæ•ˆï¼š**\n\n```java\n@Configuration\npublic class MvcConfig implements WebMvcConfigurer {\n\n    @Resource\n    private StringRedisTemplate stringRedisTemplate;\n\n    @Override\n    public void addInterceptors(InterceptorRegistry registry) {\n        // ç™»å½•æ‹¦æˆªå™¨\n        registry.addInterceptor(new LoginInterceptor())\n                .excludePathPatterns(\n                        \"/shop/**\",\n                        \"/voucher/**\",\n                        \"/shop-type/**\",\n                        \"/upload/**\",\n                        \"/blog/hot\",\n                        \"/user/code\",\n                        \"/user/login\"\n                ).order(1);\n        // tokenåˆ·æ–°çš„æ‹¦æˆªå™¨\n        registry.addInterceptor(new RefreshTokenInterceptor(stringRedisTemplate)).addPathPatterns(\"/**\").order(0);\n    }\n}\n```\n\n<a name=\"io1HZ\"></a>\n\n### é›†ç¾¤ä¸‹çš„Sessionå…±äº«é—®é¢˜\n\n<a name=\"gd7dp\"></a>\n\n#### Sessionå…±äº«é—®é¢˜\n\nåœ¨é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œnginxå¯èƒ½ä¼šå°†åŒä¸€ä¸ªç”¨æˆ·çš„å¤šæ¬¡è¯·æ±‚åˆ†é…åˆ°ä¸åŒçš„tomcatè¿›è¡Œå¤„ç†ï¼Œæ¯ä¸ªtomcatä¸­éƒ½æœ‰ä¸€ä»½å±äºè‡ªå·±çš„sessionï¼Œå‡è®¾ç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®ç¬¬ä¸€å°tomcatï¼Œå¹¶ä¸”æŠŠè‡ªå·±çš„ä¿¡æ¯å­˜æ”¾åˆ°ç¬¬ä¸€å°æœåŠ¡å™¨çš„sessionä¸­ï¼Œä½†æ˜¯ç¬¬äºŒæ¬¡è¿™ä¸ªç”¨æˆ·è®¿é—®åˆ°äº†ç¬¬äºŒå°tomcatï¼Œé‚£ä¹ˆåœ¨ç¬¬äºŒå°æœåŠ¡å™¨ä¸Šï¼Œè‚¯å®šæ²¡æœ‰ç¬¬ä¸€å°æœåŠ¡å™¨å­˜æ”¾çš„sessionï¼Œæ‰€ä»¥æ­¤æ—¶æ•´ä¸ªç™»å½•æ‹¦æˆªåŠŸèƒ½å°±ä¼šå‡ºç°é—®é¢˜ã€‚è¿™å°±æ˜¯é›†ç¾¤ä¸‹çš„Sessionå…±äº«é—®é¢˜ã€‚\n<a name=\"BXVG1\"></a>\n\n#### sessionæ‹·è´\n\næ—©æœŸçš„æ–¹æ¡ˆæ˜¯sessionæ‹·è´ï¼šæ¯å½“ä»»æ„ä¸€å°æœåŠ¡å™¨çš„sessionä¿®æ”¹æ—¶ï¼Œéƒ½ä¼šåŒæ­¥ç»™å…¶ä»–çš„TomcatæœåŠ¡å™¨çš„sessionï¼Œè¿™æ ·å°±èƒ½å®ç°sessionçš„å…±äº«äº†ã€‚<br />ä½†æ˜¯è¿™ç§æ–¹æ¡ˆä¼šå­˜åœ¨**ä¸¤å¤§é—®é¢˜**ï¼š\n\n- æ¯å°æœåŠ¡å™¨ä¸­éƒ½æœ‰å®Œæ•´çš„ä¸€ä»½sessionæ•°æ®ï¼ŒæœåŠ¡å™¨å‹åŠ›è¿‡å¤§ï¼›\n- sessionæ‹·è´æ•°æ®æ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°å»¶è¿Ÿã€‚\n\n**_äºæ˜¯ï¼Œå¼ºå¤§çš„Redisç™»åœºäº†ã€‚â†“_**\n<a name=\"EzKug\"></a>\n\n### Rediså®ç°Sessionå…±äº«\n\n<a name=\"FsCAJ\"></a>\n\n#### è®¾è®¡keyç»“æ„\n\né¦–å…ˆæˆ‘ä»¬è¦æ€è€ƒä¸€ä¸‹åˆ©ç”¨redisæ¥å­˜å‚¨æ•°æ®ï¼Œé‚£ä¹ˆåˆ°åº•ä½¿ç”¨å“ªç§ç»“æ„å‘¢ï¼Ÿç”±äºå­˜å…¥çš„æ•°æ®æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘ä½¿ç”¨Stringï¼Œä½†æ˜¯ä¼šå¤šå ç”¨ä¸€ç‚¹ç©ºé—´ã€‚<br />![4.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_6a972e3927-4.png) <br />å¦‚æœä½¿ç”¨å“ˆå¸Œï¼Œåˆ™ä»–çš„valueä¸­åªä¼šå­˜å‚¨ä»–æ•°æ®æœ¬èº«ã€‚å¦‚æœä¸æ˜¯ç‰¹åˆ«åœ¨æ„å†…å­˜ï¼Œå…¶å®ä½¿ç”¨Stringå°±å¯ä»¥äº†ã€‚<br />![5.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_6e2470a327-5.png) <br />æ‰€ä»¥æˆ‘ä»¬é€‰æ‹©ç®€å•çš„Stringç»“æ„ã€‚å…³äºkeyçš„å¤„ç†ï¼Œæ¯ä¸ªç”¨æˆ·æœ‰è‡ªå·±çš„Sessionï¼Œä½†æ˜¯redisçš„keyæ˜¯å…±äº«çš„ï¼Œæ‰€ä»¥éœ€è¦ä¸ºæ¯ä¸ªç”¨æˆ·ç”Ÿæˆä¸€ä¸ªtokenï¼ŒæŒ‰ç…§â€œå‰ç¼€ + tokenâ€çš„æ–¹å¼ä½œä¸ºkeyå­˜å‚¨ç”¨æˆ·çš„ä¿¡æ¯ã€‚\n<a name=\"QmdzF\"></a>\n\n#### å¼•å…¥Redisåçš„ç™»å½•ä¸šåŠ¡æµç¨‹\n\n![6.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_70eb198427-6.png) <br />**å®ç°å‘é€éªŒè¯ç ï¼š**\n\n```java\n@Override\npublic Result sendCode(String phone, HttpSession session) {\n    // 1.æ ¡éªŒæ‰‹æœºå·\n    if (RegexUtils.isPhoneInvalid(phone)) {\n        // 2.å¦‚æœä¸ç¬¦åˆï¼Œè¿”å›é”™è¯¯ä¿¡æ¯\n        return Result.fail(\"æ‰‹æœºå·æ ¼å¼é”™è¯¯ï¼\");\n    }\n    // 3.ç¬¦åˆï¼Œç”ŸæˆéªŒè¯ç \n    String code = RandomUtil.randomNumbers(6);\n\n    // 4.ä¿å­˜éªŒè¯ç åˆ° redis\n    stringRedisTemplate.opsForValue().set(LOGIN_CODE_KEY + phone, code, LOGIN_CODE_TTL, TimeUnit.MINUTES);\n\n    // 5.å‘é€éªŒè¯ç \n    log.debug(\"å‘é€çŸ­ä¿¡éªŒè¯ç æˆåŠŸï¼ŒéªŒè¯ç ï¼š{}\", code);\n    // è¿”å›ok\n    return Result.ok();\n}\n```\n\n**å®ç°éªŒè¯ç ç™»å½•ä¸æ³¨å†Œï¼š**\n\n```java\n@Override\npublic Result login(LoginFormDTO loginForm, HttpSession session) {\n    // 1.æ ¡éªŒæ‰‹æœºå·\n    String phone = loginForm.getPhone();\n    if (RegexUtils.isPhoneInvalid(phone)) {\n        // 2.å¦‚æœä¸ç¬¦åˆï¼Œè¿”å›é”™è¯¯ä¿¡æ¯\n        return Result.fail(\"æ‰‹æœºå·æ ¼å¼é”™è¯¯ï¼\");\n    }\n    // 3.ä»redisè·å–éªŒè¯ç å¹¶æ ¡éªŒ\n    String cacheCode = stringRedisTemplate.opsForValue().get(LOGIN_CODE_KEY + phone);\n    String code = loginForm.getCode();\n    if (cacheCode == null || !cacheCode.equals(code)) {\n        // ä¸ä¸€è‡´ï¼ŒæŠ¥é”™\n        return Result.fail(\"éªŒè¯ç é”™è¯¯\");\n    }\n\n    // 4.ä¸€è‡´ï¼Œæ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ· select * from tb_user where phone = ?\n    User user = query().eq(\"phone\", phone).one();\n\n    // 5.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨\n    if (user == null) {\n        // 6.ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ç”¨æˆ·å¹¶ä¿å­˜\n        user = createUserWithPhone(phone);\n    }\n\n    // 7.ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ° redisä¸­\n    // 7.1.éšæœºç”Ÿæˆtokenï¼Œä½œä¸ºç™»å½•ä»¤ç‰Œ\n    String token = UUID.randomUUID().toString(true);\n    // 7.2.å°†Userå¯¹è±¡è½¬ä¸ºHashMapå­˜å‚¨\n    UserDTO userDTO = BeanUtil.copyProperties(user, UserDTO.class);\n    Map<String, Object> userMap = BeanUtil.beanToMap(userDTO, new HashMap<>(),\n            CopyOptions.create()\n                    .setIgnoreNullValue(true)\n                    .setFieldValueEditor((fieldName, fieldValue) -> fieldValue.toString()));\n    // 7.3.å­˜å‚¨\n    String tokenKey = LOGIN_USER_KEY + token;\n    stringRedisTemplate.opsForHash().putAll(tokenKey, userMap);\n    // 7.4.è®¾ç½®tokenæœ‰æ•ˆæœŸ\n    stringRedisTemplate.expire(tokenKey, LOGIN_USER_TTL, TimeUnit.MINUTES);\n\n    // 8.è¿”å›token\n    return Result.ok(token);\n}\n```\n\n<a name=\"zlEde\"></a>\n\n### Rediså®ç°Sessionçš„åˆ·æ–°\n\n**ç°åœ¨æœ‰è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼š** ç”¨æˆ·å·²ç»ç™»å½•ï¼Œç„¶åè¿‡äº†ä¸€é˜µè®¿é—®äº†ä¸€ä¸ªä¸éœ€è¦æ‹¦æˆªçš„è·¯å¾„ã€‚ç»“æœå†è®¿é—®éœ€è¦æ‹¦æˆªçš„è·¯å¾„æ—¶å‘ç°ç™»å½•è¿‡æœŸäº†ã€‚<br />**é—®é¢˜åˆ†æï¼š** ç”±äºç”¨æˆ·è®¿é—®çš„æ˜¯ä¸éœ€è¦æ‹¦æˆªçš„è·¯å¾„ï¼Œå› æ­¤åœ¨è®¿é—®æ—¶ï¼Œtokenä¸ä¼šè¢«åˆ·æ–°ï¼Œäºæ˜¯ä¸‹ä¸€æ¬¡è®¿é—®æ—¶ï¼Œå‘ç°tokenå·²ç»è¿‡æœŸã€‚<br />![7.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_742ff9a827-7.png) <br />**è§£å†³æ–¹æ¡ˆï¼š** æ—¢ç„¶å·²ç™»å½•ç”¨æˆ·åœ¨è®¿é—®æ— éœ€æ‹¦æˆªçš„è·¯å¾„ä¸ä¼šåˆ·æ–°tokenï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±åœ¨æ‹¦æˆªå™¨å‰é¢å†åŠ ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œè¿™ä¸ªæ‹¦æˆªå™¨ä¸“é—¨ç”¨æ¥åˆ·æ–°tokenæˆ–è€…æ”¾è¡Œæœªç™»å½•ç”¨æˆ·ã€‚å†åˆ°ç¬¬äºŒä¸ªæ‹¦æˆªå™¨æ—¶å†åˆ¤æ–­æ˜¯å¦éœ€è¦ç™»å½•æ‰èƒ½è®¿é—®ã€‚<br />![8.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_7679eb5b27-8.png) <br />**å®ç°æ‹¦æˆªå™¨1ï¼š**\n\n```java\npublic class RefreshTokenInterceptor implements HandlerInterceptor {\n\n    private StringRedisTemplate stringRedisTemplate;\n\n    public RefreshTokenInterceptor(StringRedisTemplate stringRedisTemplate) {\n        this.stringRedisTemplate = stringRedisTemplate;\n    }\n\n    @Override\n    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {\n        // 1.è·å–è¯·æ±‚å¤´ä¸­çš„token\n        String token = request.getHeader(\"authorization\");\n        if (StrUtil.isBlank(token)) {\n            return true;\n        }\n        // 2.åŸºäºTOKENè·å–redisä¸­çš„ç”¨æˆ·\n        String key  = LOGIN_USER_KEY + token;\n        Map<Object, Object> userMap = stringRedisTemplate.opsForHash().entries(key);\n        // 3.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨\n        if (userMap.isEmpty()) {\n            return true;\n        }\n        // 5.å°†æŸ¥è¯¢åˆ°çš„hashæ•°æ®è½¬ä¸ºUserDTO\n        UserDTO userDTO = BeanUtil.fillBeanWithMap(userMap, new UserDTO(), false);\n        // 6.å­˜åœ¨ï¼Œä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ° ThreadLocal\n        UserHolder.saveUser(userDTO);\n        // 7.åˆ·æ–°tokenæœ‰æ•ˆæœŸ\n        stringRedisTemplate.expire(key, LOGIN_USER_TTL, TimeUnit.MINUTES);\n        // 8.æ”¾è¡Œ\n        return true;\n    }\n\n    @Override\n    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {\n        // ç§»é™¤ç”¨æˆ·\n        UserHolder.removeUser();\n    }\n}\n```\n\n**ç®€åŒ–æ‹¦æˆªå™¨2ï¼š**\n\n```java\npublic class LoginInterceptor implements HandlerInterceptor {\n\n    @Override\n    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {\n        // 1.åˆ¤æ–­æ˜¯å¦éœ€è¦æ‹¦æˆªï¼ˆThreadLocalä¸­æ˜¯å¦æœ‰ç”¨æˆ·ï¼‰\n        if (UserHolder.getUser() == null) {\n            // æ²¡æœ‰ï¼Œéœ€è¦æ‹¦æˆªï¼Œè®¾ç½®çŠ¶æ€ç \n            response.setStatus(401);\n            // æ‹¦æˆª\n            return false;\n        }\n        // æœ‰ç”¨æˆ·ï¼Œåˆ™æ”¾è¡Œ\n        return true;\n    }\n}\n```\n\n<a name=\"Wc2O4\"></a>\n\n## å•†æˆ·æŸ¥è¯¢ç¼“å­˜\n\n<a name=\"JupxW\"></a>\n\n### ä»€ä¹ˆæ˜¯ç¼“å­˜\n\nç”Ÿæ´»ä¸­ï¼Œä¸ç¼“å­˜ç›¸ä¼¼çš„å°±å¥½æ¯”è¶Šé‡è½¦çš„â€œå‡éœ‡å™¨â€ï¼Œå®ƒå¯ä»¥é˜²æ­¢è¶Šé‡è½¦å› ç¡¬ç€é™†å¯¼è‡´è½¦ä½“æŸä¼¤ã€‚<br />åœ¨æˆ‘ä»¬çš„é¡¹ç›®å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦ç±»ä¼¼çš„åŠŸèƒ½æ¥è§£å†³å¤§é‡çš„æ•°æ®çŒ›å†²è¿›ç³»ç»Ÿï¼Œå¯¼è‡´å…¶æ“ä½œçº¿ç¨‹æ— æ³•å¤„ç†è¿‡é‡ä¿¡æ¯è€Œå¯¼è‡´ç˜«ç—ªçš„é—®é¢˜ã€‚<br />å¹¶ä¸”åœ¨ä¼ä¸šä¸­ï¼Œå¦‚æœè¿™ç§æƒ…å†µå¤„ç†ä¸å¥½ï¼Œä¼šæå¤§çš„é™ä½ç”¨æˆ·çš„å£ç¢‘ï¼Œæ‰€ä»¥ä¼ä¸šååˆ†é‡è§†ç¼“å­˜æŠ€æœ¯ã€‚<br />**ç¼“å­˜ï¼š** å³æ•°æ®çš„äº¤æ¢ç¼“å†²åŒºï¼Œå¹³æ—¶æˆ‘ä»¬æ‰€è¯´çš„ç¼“å­˜å…¶å®å°±æ˜¯ç¼“å†²åŒºä¸­çš„æ•°æ®ï¼Œä¸€èˆ¬æ¥è®²æ˜¯ä»æ•°æ®åº“ä¸­è·å–ï¼Œå¹¶å­˜å‚¨åœ¨æœ¬åœ°ã€‚<br />**ä¾‹å¦‚ï¼š**\n\n```java\n// æœ¬åœ°ç”¨äºé«˜å¹¶å‘\nstatic final ConcurrentHashMap<K,V> map = new ConcurrentHashMap<>();\n\n// ç”¨äºredisç­‰ç¼“å­˜\nstatic final Cache<K,V> USER_CACHE = CacheBuilder.newBuilder().build();\n\n// æœ¬åœ°ç¼“å­˜\nstatic final Map<K,V> map = new HashMap();\n```\n\n> ç”±äºå…¶è¢«**static**ä¿®é¥°ï¼Œæ‰€ä»¥éšç€ç±»çš„åŠ è½½è€Œè¢«åŠ è½½åˆ°**å†…å­˜ä¹‹ä¸­**,ä½œä¸ºæœ¬åœ°ç¼“å­˜ï¼›ç”±äºå…¶åˆè¢«**final**ä¿®é¥°ï¼Œæ‰€ä»¥å…¶å¼•ç”¨(map)å’Œå¯¹è±¡(new HashMap())ä¹‹é—´çš„å…³ç³»æ˜¯å›ºå®šçš„ï¼Œä¸èƒ½æ”¹å˜ï¼Œå› æ­¤ä¸ç”¨æ‹…å¿ƒèµ‹å€¼(=)å¯¼è‡´ç¼“å­˜å¤±æ•ˆã€‚\n\nå½“ç„¶ï¼Œä½¿ç”¨ç¼“å­˜ä¹Ÿæ˜¯æœ‰ä¸€å®šçš„æˆæœ¬çš„ï¼š<br />![9.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_78d84f5e27-9.png)\n<a name=\"Rq1m6\"></a>\n\n### ç¼“å­˜çš„ä½¿ç”¨åœºæ™¯\n\nå®é™…å¼€å‘ä¸­ï¼Œä¼šæ„ç­‘å¤šçº§ç¼“å­˜æ¥ä½¿ç³»ç»Ÿè¿è¡Œé€Ÿåº¦è¿›ä¸€æ­¥æå‡ï¼Œä¾‹å¦‚ï¼šæœ¬åœ°ç¼“å­˜ä¸redisä¸­çš„ç¼“å­˜å¹¶å‘ä½¿ç”¨ã€‚<br />å¸¸è§çš„ç¼“å­˜ä¸»è¦æœ‰ä¸€ä¸‹å‡ ç§ï¼š\n\n- **æµè§ˆå™¨ç¼“å­˜ï¼š** ä¸»è¦æ˜¯å­˜åœ¨äºæµè§ˆå™¨ç«¯çš„ç¼“å­˜ï¼›\n- **åº”ç”¨å±‚ç¼“å­˜ï¼š** å¯ä»¥åˆ†ä¸ºtomcatæœ¬åœ°ç¼“å­˜ï¼Œæ¯”å¦‚ä¹‹å‰æåˆ°çš„mapï¼Œæˆ–è€…æ˜¯ä½¿ç”¨redisä½œä¸ºç¼“å­˜ï¼›\n- **æ•°æ®åº“ç¼“å­˜ï¼š** åœ¨æ•°æ®åº“ä¸­æœ‰ä¸€ç‰‡ç©ºé—´æ˜¯ buffer poolï¼Œå¢æ”¹æŸ¥æ•°æ®éƒ½ä¼šå…ˆåŠ è½½åˆ°mysqlçš„ç¼“å­˜ä¸­ï¼›\n- **CPUç¼“å­˜ï¼š** å½“ä»£è®¡ç®—æœºæœ€å¤§çš„é—®é¢˜æ˜¯cpuæ€§èƒ½æå‡äº†ï¼Œä½†å†…å­˜è¯»å†™é€Ÿåº¦æ²¡æœ‰è·Ÿä¸Šï¼Œæ‰€ä»¥ä¸ºäº†é€‚åº”å½“ä¸‹çš„æƒ…å†µï¼Œå¢åŠ äº†cpuçš„L1ï¼ŒL2ï¼ŒL3çº§çš„ç¼“å­˜ã€‚\n\n![10.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_7b5ed7d527-10.png)\n<a name=\"JCbbI\"></a>\n\n### æ·»åŠ å•†æˆ·ç¼“å­˜\n\næˆ‘ä»¬åœ¨æŸ¥è¯¢å•†æˆ·ä¿¡æ¯çš„æ—¶å€™ï¼Œå¦‚æœç›´æ¥å»æ•°æ®åº“é‡ŒæŸ¥ä¿®ï¼Œé€Ÿåº¦å°±ä¼šæ¯”è¾ƒæ…¢ï¼Œæ‰€ä»¥éœ€è¦åœ¨è¿™é‡Œæ·»åŠ å•†æˆ·çš„ç¼“å­˜ã€‚<br />æ ‡å‡†çš„æ“ä½œæ–¹å¼å°±æ˜¯æŸ¥è¯¢æ•°æ®åº“ä¹‹å‰å…ˆæŸ¥è¯¢ç¼“å­˜ï¼Œå¦‚æœç¼“å­˜æ•°æ®å­˜åœ¨ï¼Œåˆ™ç›´æ¥ä»ç¼“å­˜ä¸­è¿”å›ï¼Œå¦‚æœç¼“å­˜æ•°æ®ä¸å­˜åœ¨ï¼Œå†æŸ¥è¯¢æ•°æ®åº“ï¼Œç„¶åå°†æ•°æ®å­˜å…¥redisã€‚<br />![11.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_7f7b24e027-11.png) <br />**ä»£ç å®ç°ï¼š**\n\n```java\n@Override\npublic Result queryById(Long id) {\n    // å…ˆä»Redisä¸­æŸ¥ï¼Œè¿™é‡Œçš„å¸¸é‡å€¼æ˜¯å›ºå®šçš„å‰ç¼€ + åº—é“ºid\n    String shopJson = stringRedisTemplate.opsForValue().get(CACHE_SHOP_KEY + id);\n    // å¦‚æœä¸ä¸ºç©ºï¼ˆæŸ¥è¯¢åˆ°äº†ï¼‰ï¼Œåˆ™è½¬ä¸ºShopç±»å‹ç›´æ¥è¿”å›\n    if (StrUtil.isNotBlank(shopJson)) {\n        Shop shop = JSONUtil.toBean(shopJson, Shop.class);\n        return Result.ok(shop);\n    }\n    // å¦åˆ™å»æ•°æ®åº“ä¸­æŸ¥\n    Shop shop = getById(id);\n    // æŸ¥ä¸åˆ°è¿”å›ä¸€ä¸ªé”™è¯¯ä¿¡æ¯æˆ–è€…è¿”å›ç©ºéƒ½å¯ä»¥ï¼Œæ ¹æ®è‡ªå·±çš„éœ€æ±‚æ¥\n    if (shop == null) {\n        return Result.fail(\"åº—é“ºä¸å­˜åœ¨ï¼ï¼\");\n    }\n    // æŸ¥åˆ°äº†åˆ™è½¬ä¸ºjsonå­—ç¬¦ä¸²\n    String jsonStr = JSONUtil.toJsonStr(shop);\n    // å¹¶å­˜å…¥redis\n    stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, jsonStr);\n    // æœ€ç»ˆæŠŠæŸ¥è¯¢åˆ°çš„å•†æˆ·ä¿¡æ¯è¿”å›ç»™å‰ç«¯\n    return Result.ok(shop);\n}\n```\n\n<a name=\"RcKoX\"></a>\n\n### ç¼“å­˜æ›´æ–°ç­–ç•¥\n\nç¼“å­˜æ›´æ–°æ˜¯redisä¸ºäº†èŠ‚çº¦å†…å­˜è€Œè®¾è®¡å‡ºæ¥çš„ï¼Œä¸»è¦æ˜¯å› ä¸ºå†…å­˜æ•°æ®å®è´µï¼Œå½“æˆ‘ä»¬å‘redisæ’å…¥å¤ªå¤šæ•°æ®ï¼Œæ­¤æ—¶å°±å¯èƒ½ä¼šå¯¼è‡´ç¼“å­˜ä¸­çš„æ•°æ®è¿‡å¤šï¼Œæ‰€ä»¥redisä¼šå¯¹éƒ¨åˆ†æ•°æ®è¿›è¡Œæ›´æ–°ï¼Œæˆ–è€…æŠŠä»–ç§°ä½œæ·˜æ±°æ›´åˆé€‚ã€‚<br />**ç¼“å­˜æ›´æ–°ä¸»è¦ç­–ç•¥ï¼š**\n\n- **å†…å­˜æ·˜æ±°ï¼š** redisè‡ªåŠ¨è¿›è¡Œï¼Œå½“rediså†…å­˜è¾¾åˆ°å’±ä»¬è®¾å®šçš„max-memeryçš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨è§¦å‘æ·˜æ±°æœºåˆ¶ï¼Œæ·˜æ±°æ‰ä¸€äº›ä¸é‡è¦çš„æ•°æ®(å¯ä»¥è‡ªå·±è®¾ç½®ç­–ç•¥æ–¹å¼)ï¼›\n- **è¶…æ—¶å‰”é™¤ï¼š** å½“æˆ‘ä»¬ç»™redisè®¾ç½®äº†è¿‡æœŸæ—¶é—´ttlä¹‹åï¼Œredisä¼šå°†è¶…æ—¶çš„æ•°æ®è¿›è¡Œåˆ é™¤ï¼Œæ–¹ä¾¿å’±ä»¬ç»§ç»­ä½¿ç”¨ç¼“å­˜ï¼›\n- **ä¸»åŠ¨æ›´æ–°ï¼š** æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨è°ƒç”¨æ–¹æ³•æŠŠç¼“å­˜åˆ æ‰ï¼Œé€šå¸¸ç”¨äºè§£å†³ç¼“å­˜å’Œæ•°æ®åº“ä¸ä¸€è‡´é—®é¢˜ã€‚\n\n![12.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_8285320c27-12.png)\n<a name=\"jdUjM\"></a>\n\n#### æ•°æ®åº“ä¸ç¼“å­˜æ•°æ®ä¸ä¸€è‡´é—®é¢˜\n\nç”±äºæˆ‘ä»¬çš„ç¼“å­˜çš„æ•°æ®æºæ¥è‡ªäºæ•°æ®åº“ï¼Œè€Œæ•°æ®åº“çš„æ•°æ®æ˜¯ä¼šå‘ç”Ÿå˜åŒ–çš„ã€‚å› æ­¤ï¼Œå¦‚æœå½“æ•°æ®åº“ä¸­æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œè€Œç¼“å­˜å´æ²¡æœ‰åŒæ­¥ï¼Œæ­¤æ—¶å°±ä¼šæœ‰**ä¸€è‡´æ€§é—®é¢˜**å­˜åœ¨ï¼Œå…¶åæœæ˜¯ï¼šç”¨æˆ·ä½¿ç”¨ç¼“å­˜ä¸­çš„è¿‡æ—¶æ•°æ®,å°±ä¼šäº§ç”Ÿç±»ä¼¼å¤šçº¿ç¨‹æ•°æ®å®‰å…¨é—®é¢˜ï¼Œä»è€Œå½±å“ä¸šåŠ¡ï¼Œäº§å“å£ç¢‘ç­‰ã€‚<br />**å½“å‰å‡ ç§è¾ƒä¸ºå¸¸è§çš„è§£å†³æ–¹æ¡ˆï¼ˆä¸»åŠ¨æ›´æ–°çš„å‡ ç§æ–¹å¼ï¼‰ï¼š**\n\n- Cache Aside Patternï¼ˆæ—è·¯ç¼“å­˜æ¨¡å¼ï¼‰ï¼šå…ˆæ›´æ–°æ•°æ®åº“ï¼Œç„¶åå†æ›´æ–°ç¼“å­˜ï¼ˆåŒå†™æ–¹æ¡ˆï¼‰ï¼›\n- Read/Write Through Patternï¼ˆè¯»å†™ç©¿é€ï¼‰ï¼šå°†ç¼“å­˜å’Œæ•°æ®åº“æ•´åˆä¸ºä¸€ä¸ªæœåŠ¡ï¼Œç”±æœåŠ¡æ¥ç»´æŠ¤æ•°æ®ä¸€è‡´æ€§ï¼›\n- Write Behind Caching Patternï¼ˆå¼‚æ­¥ç¼“å­˜å†™å…¥ï¼‰ï¼šè°ƒç”¨è€…åªæ“ä½œç¼“å­˜ï¼Œç”±å…¶ä»–çº¿ç¨‹å¼‚æ­¥å°†ç¼“å­˜æŒä¹…åŒ–åˆ°æ•°æ®åº“ã€‚\n  <a name=\"tAEei\"></a>\n\n#### ç¼“å­˜ä¸ä¸€è‡´é‡‡ç”¨çš„æœ€ç»ˆæ–¹æ¡ˆ\n\nå„ä¸ªæ–¹æ¡ˆçš„ç‰¹ç‚¹ï¼š\n\n- Cache Aside Patternï¼šéœ€è¦å†™ä»£ç ï¼Œè¾ƒä¸ºå¤æ‚ï¼Œä½†å¯ä»¥äººä¸ºæ§åˆ¶ï¼›\n- Read/Write Through Patternï¼šè°ƒç”¨è€…æ— éœ€å…³å¿ƒä¸€è‡´æ€§é—®é¢˜ï¼Œç»´æŠ¤è¿™æ ·ä¸€ä¸ªæœåŠ¡æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œå¼€å‘æˆæœ¬é«˜ï¼›\n- Write Behind Caching Patternï¼šå¯ä»¥å°†å¤šæ¬¡å¯¹æ•°æ®åº“çš„å†™æ“ä½œåˆå¹¶ä¸ºä¸€æ¬¡ï¼Œä½†æ˜¯å¯èƒ½ä¼šä¸¢å¤±æ•°æ®ï¼Œç»´æŠ¤ä»»åŠ¡è¾ƒä¸ºå¤æ‚ï¼Œå¹¶ä¸”ä¸€è‡´æ€§ä¸èƒ½åŠæ—¶ä¿è¯ã€‚\n\nç»¼ä¸Šï¼Œæœ€ç»ˆæ–¹æ¡ˆä½¿ç”¨æ–¹æ¡ˆä¸€ï¼š**Cache Aside Patternï¼**<br />![13.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_85f2044e27-13.png) <br />**é‡‡ç”¨æ–¹æ¡ˆä¸€è¡ç”Ÿçš„é—®é¢˜ï¼š**\n\n- æ›´æ–°ç¼“å­˜æ—¶æ˜¯æ›´æ–°ç¼“å­˜è¿˜æ˜¯åˆ é™¤ç¼“å­˜ï¼Ÿ\n    - æ›´æ–°ç¼“å­˜ï¼šæ¯æ¬¡æ›´æ–°æ•°æ®åº“éƒ½æ›´æ–°ç¼“å­˜ï¼Œæ— æ•ˆå†™æ“ä½œè¾ƒå¤š\n    - **åˆ é™¤ç¼“å­˜ï¼š** æ›´æ–°æ•°æ®åº“æ—¶è®©ç¼“å­˜å¤±æ•ˆï¼ŒæŸ¥è¯¢æ—¶å†æ›´æ–°ç¼“å­˜ **âˆš**\n- å¦‚ä½•ä¿è¯ç¼“å­˜ä¸æ•°æ®åº“çš„æ“ä½œçš„åŒæ—¶æˆåŠŸæˆ–å¤±è´¥ï¼Ÿ\n    - å¯¹äºå•ä½“ç³»ç»Ÿï¼Œå°†ç¼“å­˜ä¸æ•°æ®åº“æ“ä½œæ”¾åœ¨ä¸€ä¸ªäº‹åŠ¡\n    - å¯¹äºåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œåˆ©ç”¨TCCç­‰åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆ\n- å…ˆæ“ä½œç¼“å­˜è¿˜æ˜¯å…ˆæ“ä½œæ•°æ®åº“ï¼Ÿ\n    - å…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ“ä½œæ•°æ®åº“\n    - **å…ˆæ“ä½œæ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜ âˆš**\n\n> æˆ‘ä»¬åº”å½“æ˜¯å…ˆæ“ä½œæ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜ï¼ŒåŸå› åœ¨äºï¼Œå¦‚æœä¸¤ä¸ªçº¿ç¨‹å¹¶å‘æ¥è®¿é—®æ—¶ï¼Œå‡è®¾çº¿ç¨‹1å…ˆæ¥ï¼Œä»–å…ˆæŠŠç¼“å­˜åˆ äº†ï¼Œæ­¤æ—¶çº¿ç¨‹2è¿‡æ¥ï¼Œä»–æŸ¥è¯¢ç¼“å­˜æ•°æ®å¹¶ä¸å­˜åœ¨ï¼Œæ­¤æ—¶ä»–å†™å…¥ç¼“å­˜ï¼Œå½“ä»–å†™å…¥ç¼“å­˜åï¼Œçº¿ç¨‹1å†æ‰§è¡Œæ›´æ–°åŠ¨ä½œæ—¶ï¼Œå®é™…ä¸Šå†™å…¥çš„å°±æ˜¯æ—§çš„æ•°æ®ï¼Œæ–°çš„æ•°æ®è¢«æ—§æ•°æ®è¦†ç›–äº†ã€‚\n\né‡åˆ°çº¿ç¨‹å®‰å…¨é—®é¢˜æ—¶çš„â€œå…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ“ä½œæ•°æ®åº“â€ï¼ˆå¯¼è‡´å°†æ—§æ•°æ®åˆå†™å›ç¼“å­˜ä¸­ï¼‰ï¼š<br />![14.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_88fd0c6a27-14.png) <br />é‡åˆ°çº¿ç¨‹å®‰å…¨é—®é¢˜æ—¶çš„â€œå…ˆæ“ä½œæ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜â€ï¼š<br />![16.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_8db3c3a327-16.png) <br />æ‰€ä»¥æœ€ç»ˆçš„æ–¹æ¡ˆæ˜¯ï¼š**å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜**ã€‚\n<a name=\"smvH7\"></a>\n\n### å®ç°å•†æˆ·ç¼“å­˜ä¸æ•°æ®åº“åŒå†™ä¸€è‡´\n\næ ¹æ®ä¸Šè¿°åˆ†æï¼Œæœ€ç»ˆæˆ‘ä»¬é€‰æ‹©**åœ¨æŸ¥è¯¢ç¼“å­˜æ—¶**ï¼Œå¦‚æœç¼“å­˜ä¸­æ²¡æœ‰æ•°æ®ï¼Œåˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ä½œä¸ºè¶…æ—¶å‰”é™¤æ–¹æ¡ˆå…œåº•ã€‚**æ›´æ–°ç¼“å­˜æ—¶**ï¼Œå…ˆåˆ é™¤æ•°æ®åº“å†åˆ é™¤ç¼“å­˜ã€‚\n<a name=\"hgcFv\"></a>\n\n#### æ·»åŠ ç¼“å­˜æ—¶è®¾ç½®è¿‡æœŸæ—¶é—´\n\n```java\n@Override\npublic Result queryById(Long id) {\n    // å…ˆä»Redisä¸­æŸ¥ï¼Œè¿™é‡Œçš„å¸¸é‡å€¼æ˜¯å›ºå®šçš„å‰ç¼€ + åº—é“ºid\n    String shopJson = stringRedisTemplate.opsForValue().get(CACHE_SHOP_KEY + id);\n    // å¦‚æœä¸ä¸ºç©ºï¼ˆæŸ¥è¯¢åˆ°äº†ï¼‰ï¼Œåˆ™è½¬ä¸ºShopç±»å‹ç›´æ¥è¿”å›\n    if (StrUtil.isNotBlank(shopJson)) {\n        Shop shop = JSONUtil.toBean(shopJson, Shop.class);\n        return Result.ok(shop);\n    }\n    // å¦åˆ™å»æ•°æ®åº“ä¸­æŸ¥\n    Shop shop = getById(id);\n    if (shop == null) {\n        return Result.fail(\"åº—é“ºä¸å­˜åœ¨ï¼\");\n    }\n    // æŸ¥åˆ°äº†åˆ™è½¬ä¸ºjsonå­—ç¬¦ä¸²\n    String jsonStr = JSONUtil.toJsonStr(shop);\n    // å¹¶å­˜å…¥redisï¼Œè®¾ç½®TTL\n    stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, jsonStr,CACHE_SHOP_TTL, TimeUnit.MINUTES);\n    // æœ€ç»ˆæŠŠæŸ¥è¯¢åˆ°çš„å•†æˆ·ä¿¡æ¯è¿”å›ç»™å‰ç«¯\n    return Result.ok(shop);\n}\n```\n\n<a name=\"evZrU\"></a>\n\n#### æ›´æ–°ç¼“å­˜æ—¶å…ˆä¿®æ”¹æ•°æ®åº“å†åˆ é™¤ç¼“å­˜\n\n```java\n@Override\n@Transactional\npublic Result update(Shop shop) {\n    // åˆ¤ç©º\n    if (shop.getId() == null) {\n        return Result.fail(\"åº—é“ºidä¸èƒ½ä¸ºç©ºï¼ï¼\");\n    }\n    // å…ˆä¿®æ”¹æ•°æ®åº“\n    updateById(shop);\n    // å†åˆ é™¤ç¼“å­˜\n    stringRedisTemplate.delete(CACHE_SHOP_KEY + shop.getId());\n    return Result.ok();\n}\n```\n\n<a name=\"EBbDL\"></a>\n\n### ç¼“å­˜ç©¿é€é—®é¢˜è§£å†³æ–¹æ¡ˆåŠå®ç°\n\n<a name=\"RS8FD\"></a>\n\n#### ç¼“å­˜ç©¿é€åŠè§£å†³æ–¹æ¡ˆ\n\n**ç¼“å­˜ç©¿é€ ï¼š**ç¼“å­˜ç©¿é€æ˜¯æŒ‡å®¢æˆ·ç«¯è¯·æ±‚çš„æ•°æ®åœ¨**ç¼“å­˜ä¸­å’Œæ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨**ï¼Œè¿™æ ·ç¼“å­˜æ°¸è¿œä¸ä¼šç”Ÿæ•ˆï¼Œè¿™äº›è¯·æ±‚éƒ½ä¼šæ‰“åˆ°æ•°æ®åº“ã€‚<br />**å¸¸è§è§£å†³æ–¹æ¡ˆï¼š**\n\n- ç¼“å­˜ç©ºå¯¹è±¡ï¼šå®ç°ç®€å•ï¼Œç»´æŠ¤æ–¹ä¾¿ã€‚ä½†æ˜¯ä¼šæœ‰é¢å¤–çš„å†…å­˜æ¶ˆè€—ï¼Œå¯èƒ½ä¼šé€ æˆçŸ­æœŸçš„æ•°æ®ä¸ä¸€è‡´ã€‚\n- å¸ƒéš†è¿‡æ»¤ï¼šå†…å­˜å ç”¨å°‘ï¼Œæ²¡æœ‰å¤šä½™çš„keyã€‚ä½†æ˜¯å®ç°è¾ƒä¸ºå¤æ‚ï¼Œå­˜åœ¨è¯¯åˆ¤å¯èƒ½ã€‚\n- å¢å¼ºidçš„å¤æ‚åº¦ï¼Œé¿å…è¢«çŒœæµ‹idè§„å¾‹\n- åšå¥½æ•°æ®çš„åŸºç¡€æ ¼å¼æ ¡éªŒ\n- åŠ å¼ºç”¨æˆ·æƒé™æ ¡éªŒ\n- åšå¥½çƒ­ç‚¹å‚æ•°çš„é™æµ\n\n**ç¼“å­˜ç©ºå¯¹è±¡çš„æ€è·¯åˆ†æï¼š** å½“æˆ‘ä»¬å®¢æˆ·ç«¯è®¿é—®ä¸å­˜åœ¨çš„æ•°æ®æ—¶ï¼Œå…ˆè¯·æ±‚redisï¼Œä½†æ˜¯æ­¤æ—¶redisä¸­æ²¡æœ‰æ•°æ®ï¼Œæ­¤æ—¶ä¼šè®¿é—®åˆ°æ•°æ®åº“ï¼Œä½†æ˜¯æ•°æ®åº“ä¸­ä¹Ÿæ²¡æœ‰æ•°æ®ï¼Œè¿™ä¸ªæ•°æ®ç©¿é€äº†ç¼“å­˜ï¼Œç›´å‡»æ•°æ®åº“ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“æ•°æ®åº“èƒ½å¤Ÿæ‰¿è½½çš„å¹¶å‘ä¸å¦‚redisè¿™ä¹ˆé«˜ï¼Œå¦‚æœå¤§é‡çš„è¯·æ±‚åŒæ—¶è¿‡æ¥è®¿é—®è¿™ç§ä¸å­˜åœ¨çš„æ•°æ®ï¼Œè¿™äº›è¯·æ±‚å°±éƒ½ä¼šè®¿é—®åˆ°æ•°æ®åº“ï¼Œç®€å•çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯å“ªæ€•è¿™ä¸ªæ•°æ®åœ¨æ•°æ®åº“ä¸­ä¹Ÿä¸å­˜åœ¨ï¼Œæˆ‘ä»¬ä¹ŸæŠŠè¿™ä¸ªæ•°æ®å­˜å…¥åˆ°redisä¸­å»ï¼Œè¿™æ ·ï¼Œä¸‹æ¬¡ç”¨æˆ·è¿‡æ¥è®¿é—®è¿™ä¸ªä¸å­˜åœ¨çš„æ•°æ®ï¼Œé‚£ä¹ˆåœ¨redisä¸­ä¹Ÿèƒ½æ‰¾åˆ°è¿™ä¸ªæ•°æ®å°±ä¸ä¼šè¿›å…¥åˆ°ç¼“å­˜äº†ã€‚<br />**å¸ƒéš†è¿‡æ»¤ï¼š** å¸ƒéš†è¿‡æ»¤å™¨å…¶å®é‡‡ç”¨çš„æ˜¯å“ˆå¸Œæ€æƒ³æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œé€šè¿‡ä¸€ä¸ªåºå¤§çš„äºŒè¿›åˆ¶æ•°ç»„ï¼Œèµ°å“ˆå¸Œæ€æƒ³å»åˆ¤æ–­å½“å‰è¿™ä¸ªè¦æŸ¥è¯¢çš„è¿™ä¸ªæ•°æ®æ˜¯å¦å­˜åœ¨ï¼ˆå¤šä¸ªç‹¬ç«‹çš„å“ˆå¸Œå‡½æ•°åŒæ—¶æ ¡éªŒï¼‰ï¼Œå¦‚æœå¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­å­˜åœ¨ï¼Œåˆ™æ”¾è¡Œï¼Œè¿™ä¸ªè¯·æ±‚ä¼šå»è®¿é—®redisï¼Œå“ªæ€•æ­¤æ—¶redisä¸­çš„æ•°æ®è¿‡æœŸäº†ï¼Œä½†æ˜¯æ•°æ®åº“ä¸­ä¸€å®šå­˜åœ¨è¿™ä¸ªæ•°æ®ï¼Œåœ¨æ•°æ®åº“ä¸­æŸ¥è¯¢å‡ºæ¥è¿™ä¸ªæ•°æ®åï¼Œå†å°†å…¶æ”¾å…¥åˆ°redisä¸­ã€‚å‡è®¾å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­è¿™ä¸ªæ•°æ®ä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚è¿™ç§æ–¹å¼ä¼˜ç‚¹åœ¨äºèŠ‚çº¦å†…å­˜ç©ºé—´ï¼Œå­˜åœ¨è¯¯åˆ¤ï¼Œè¯¯åˆ¤åŸå› åœ¨äºï¼šå¸ƒéš†è¿‡æ»¤å™¨èµ°çš„æ˜¯å“ˆå¸Œæ€æƒ³ï¼Œåªè¦å“ˆå¸Œæ€æƒ³ï¼Œå°±å¯èƒ½å­˜åœ¨å“ˆå¸Œå†²çªã€‚<br />![17.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_900f701527-17.png)\n<a name=\"Vfeb4\"></a>\n\n#### ç¼–ç è§£å†³ç¼“å­˜ç©¿é€\n\nåœ¨åŸæ¥çš„é€»è¾‘ä¸­ï¼Œæˆ‘ä»¬å¦‚æœå‘ç°è¿™ä¸ªæ•°æ®åœ¨mysqlä¸­ä¸å­˜åœ¨ï¼Œç›´æ¥å°±è¿”å›404ï¼Œè¿™æ ·ä¼šå­˜åœ¨ç¼“å­˜ç©¿é€é—®é¢˜ã€‚\n\n```java\n@Override\npublic Result queryById(Long id) {\n    // å…ˆä»Redisä¸­æŸ¥ï¼Œè¿™é‡Œçš„å¸¸é‡å€¼æ˜¯å›ºå®šçš„å‰ç¼€ + åº—é“ºid\n    String shopJson = stringRedisTemplate.opsForValue().get(CACHE_SHOP_KEY + id);\n    // å¦‚æœä¸ä¸ºç©ºï¼ˆæŸ¥è¯¢åˆ°äº†ï¼‰ï¼Œåˆ™è½¬ä¸ºShopç±»å‹ç›´æ¥è¿”å›\n    if (StrUtil.isNotBlank(shopJson)) {\n        Shop shop = JSONUtil.toBean(shopJson, Shop.class);\n        return Result.ok(shop);\n    }\n    // å¦åˆ™å»æ•°æ®åº“ä¸­æŸ¥\n    Shop shop = getById(id);\n    // æŸ¥ä¸åˆ°è¿”å›ä¸€ä¸ªé”™è¯¯ä¿¡æ¯æˆ–è€…è¿”å›ç©ºéƒ½å¯ä»¥ï¼Œæ ¹æ®è‡ªå·±çš„éœ€æ±‚æ¥\n    if (shop == null) {\n        return Result.fail(\"åº—é“ºä¸å­˜åœ¨ï¼ï¼\");\n    }\n    // æŸ¥åˆ°äº†åˆ™è½¬ä¸ºjsonå­—ç¬¦ä¸²\n    String jsonStr = JSONUtil.toJsonStr(shop);\n    // å¹¶å­˜å…¥redisï¼Œè®¾ç½®TTL\n    stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, jsonStr,CACHE_SHOP_TTL, TimeUnit.MINUTES);\n    // æœ€ç»ˆæŠŠæŸ¥è¯¢åˆ°çš„å•†æˆ·ä¿¡æ¯è¿”å›ç»™å‰ç«¯\n    return Result.ok(shop);\n}\n```\n\n**ä¼˜åŒ–é€»è¾‘ï¼š** å¦‚æœè¿™ä¸ªæ•°æ®ä¸å­˜åœ¨ï¼Œæˆ‘ä»¬ä¸ä¼šè¿”å›404 ï¼Œè¿˜æ˜¯ä¼šæŠŠè¿™ä¸ªæ•°æ®å†™å…¥åˆ°Redisä¸­ï¼Œå¹¶ä¸”å°†valueè®¾ç½®ä¸ºç©ºï¼Œå½“å†æ¬¡å‘èµ·æŸ¥è¯¢æ—¶ï¼Œæˆ‘ä»¬å¦‚æœå‘ç°å‘½ä¸­ä¹‹åï¼Œåˆ¤æ–­è¿™ä¸ªvalueæ˜¯å¦æ˜¯nullï¼Œå¦‚æœæ˜¯nullï¼Œåˆ™æ˜¯ä¹‹å‰å†™å…¥çš„æ•°æ®ï¼Œè¯æ˜æ˜¯ç¼“å­˜ç©¿é€æ•°æ®ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™ç›´æ¥è¿”å›æ•°æ®ã€‚<br />![18.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_928f870c27-18.png)\n\n```java\n@Override\npublic Result queryById(Long id) {\n    // å…ˆä»Redisä¸­æŸ¥ï¼Œè¿™é‡Œçš„å¸¸é‡å€¼æ˜¯å›ºå®šçš„å‰ç¼€ + åº—é“ºid\n    String shopJson = stringRedisTemplate.opsForValue().get(CACHE_SHOP_KEY + id);\n    // å¦‚æœä¸ä¸ºç©ºï¼ˆæŸ¥è¯¢åˆ°äº†ï¼‰ï¼Œåˆ™è½¬ä¸ºShopç±»å‹ç›´æ¥è¿”å›\n    if (StrUtil.isNotBlank(shopJson)) {\n        Shop shop = JSONUtil.toBean(shopJson, Shop.class);\n        return Result.ok(shop);\n    }\n    // å¦‚æœæŸ¥è¯¢åˆ°çš„æ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œåˆ™è¯´æ˜æ˜¯æˆ‘ä»¬ç¼“å­˜çš„ç©ºæ•°æ®\n    if (shopjson != null) {\n        return Result.fail(\"åº—é“ºä¸å­˜åœ¨ï¼ï¼\");\n    }\n    // å¦åˆ™å»æ•°æ®åº“ä¸­æŸ¥\n    Shop shop = getById(id);\n    // æŸ¥ä¸åˆ°ï¼Œåˆ™å°†ç©ºå­—ç¬¦ä¸²å†™å…¥Redis\n    if (shop == null) {\n        // è¿™é‡Œçš„å¸¸é‡å€¼æ˜¯2åˆ†é’Ÿ\n        stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, \"\", CACHE_NULL_TTL, TimeUnit.MINUTES);\n        return Result.fail(\"åº—é“ºä¸å­˜åœ¨ï¼\");\n    }\n    // æŸ¥åˆ°äº†åˆ™è½¬ä¸ºjsonå­—ç¬¦ä¸²\n    String jsonStr = JSONUtil.toJsonStr(shop);\n    // å¹¶å­˜å…¥redisï¼Œè®¾ç½®TTL\n    stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, jsonStr, CACHE_SHOP_TTL, TimeUnit.MINUTES);\n    // æœ€ç»ˆæŠŠæŸ¥è¯¢åˆ°çš„å•†æˆ·ä¿¡æ¯è¿”å›ç»™å‰ç«¯\n    return Result.ok(shop);\n}\n```\n\n<a name=\"ZP9Ku\"></a>\n\n### ç¼“å­˜é›ªå´©é—®é¢˜è§£å†³æ–¹æ¡ˆ\n\n**ç¼“å­˜é›ªå´©ï¼š**ç¼“å­˜é›ªå´©æ˜¯æŒ‡åœ¨**åŒä¸€æ—¶æ®µ**å¤§é‡çš„ç¼“å­˜key**åŒæ—¶å¤±æ•ˆ**æˆ–è€…**RedisæœåŠ¡å®•æœº**ï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚åˆ°è¾¾æ•°æ®åº“ï¼Œå¸¦æ¥å·¨å¤§å‹åŠ›ã€‚<br />![19.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_9509c7b727-19.png) <br />**å¸¸è§è§£å†³æ–¹æ¡ˆï¼š**\n\n- ç»™ä¸åŒçš„Keyçš„TTLæ·»åŠ éšæœºå€¼ï¼ˆé’ˆå¯¹æ•°æ®åŒæ—¶å¤±æ•ˆï¼‰ï¼›\n- åˆ©ç”¨Redisé›†ç¾¤æé«˜æœåŠ¡çš„å¯ç”¨æ€§ï¼ˆé’ˆå¯¹Rediså®•æœºï¼Œä½¿ç”¨ä¸€ä¸ªæˆ–è€…å¤šä¸ªå“¨å…µ(Sentinel)å®ä¾‹ç»„æˆçš„ç³»ç»Ÿï¼Œå¯¹redisèŠ‚ç‚¹è¿›è¡Œç›‘æ§ï¼Œåœ¨ä¸»èŠ‚ç‚¹å‡ºç°æ•…éšœçš„æƒ…å†µä¸‹ï¼Œèƒ½å°†ä»èŠ‚ç‚¹ä¸­çš„ä¸€ä¸ªå‡çº§ä¸ºä¸»èŠ‚ç‚¹ï¼Œè¿›è¡Œæ•…éšœè½¬ä¹‰ï¼Œä¿è¯ç³»ç»Ÿçš„å¯ç”¨æ€§ã€‚ï¼‰ï¼›\n- ç»™ç¼“å­˜ä¸šåŠ¡æ·»åŠ é™çº§é™æµç­–ç•¥ï¼ˆä¸»åŠ¨é™æµä¿å…¨æ•°æ®åº“ï¼‰ï¼›\n- ç»™ä¸šåŠ¡æ·»åŠ å¤šçº§ç¼“å­˜ï¼ˆå¢åŠ ç¼“å­˜é«˜å¯ç”¨ï¼Œæµè§ˆå™¨è®¿é—®é™æ€èµ„æºæ—¶ï¼Œä¼˜å…ˆè¯»å–æµè§ˆå™¨æœ¬åœ°ç¼“å­˜ï¼›è®¿é—®éé™æ€èµ„æºï¼ˆajaxæŸ¥è¯¢æ•°æ®ï¼‰æ—¶ï¼Œè®¿é—®æœåŠ¡ç«¯ï¼›è¯·æ±‚åˆ°è¾¾Nginxåï¼Œä¼˜å…ˆè¯»å–Nginxæœ¬åœ°ç¼“å­˜ï¼›å¦‚æœNginxæœ¬åœ°ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™å»ç›´æ¥æŸ¥è¯¢Redisï¼ˆä¸ç»è¿‡Tomcatï¼‰ï¼›å¦‚æœRedisæŸ¥è¯¢æœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢Tomcatï¼›è¯·æ±‚è¿›å…¥Tomcatåï¼Œä¼˜å…ˆæŸ¥è¯¢JVMè¿›ç¨‹ç¼“å­˜ï¼›å¦‚æœJVMè¿›ç¨‹ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢æ•°æ®åº“ï¼‰ã€‚\n  <a name=\"CeHTm\"></a>\n\n### ç¼“å­˜å‡»ç©¿é—®é¢˜è§£å†³æ–¹æ¡ˆåŠå®ç°\n\n<a name=\"pWInW\"></a>\n\n#### ç¼“å­˜å‡»ç©¿é—®é¢˜åˆ†æ\n\n**ç¼“å­˜å‡»ç©¿ï¼š**ç¼“å­˜å‡»ç©¿ä¹Ÿå«**çƒ­ç‚¹Keyé—®é¢˜**ï¼Œå°±æ˜¯ä¸€ä¸ªè¢«é«˜å¹¶å‘è®¿é—®å¹¶ä¸”ç¼“å­˜é‡å»ºä¸šåŠ¡è¾ƒå¤æ‚çš„keyçªç„¶å¤±æ•ˆäº†ï¼Œé‚£ä¹ˆæ— æ•°è¯·æ±‚è®¿é—®å°±ä¼šåœ¨ç¬é—´ç»™æ•°æ®åº“å¸¦æ¥å·¨å¤§çš„å†²å‡»ã€‚<br />**å¸¸è§è§£å†³æ–¹æ¡ˆï¼š**\n\n- äº’æ–¥é”\n- é€»è¾‘è¿‡æœŸ\n\n**é€»è¾‘åˆ†æï¼š** å‡è®¾çº¿ç¨‹1åœ¨æŸ¥è¯¢ç¼“å­˜ä¹‹åï¼Œæœ¬æ¥åº”è¯¥å»æŸ¥è¯¢æ•°æ®åº“ï¼Œç„¶åæŠŠè¿™ä¸ªæ•°æ®é‡æ–°åŠ è½½åˆ°ç¼“å­˜çš„ï¼Œæ­¤æ—¶åªè¦çº¿ç¨‹1èµ°å®Œè¿™ä¸ªé€»è¾‘ï¼Œå…¶ä»–çº¿ç¨‹å°±éƒ½èƒ½ä»ç¼“å­˜ä¸­åŠ è½½è¿™äº›æ•°æ®äº†ã€‚ä½†æ˜¯ï¼Œå‡è®¾åœ¨çº¿ç¨‹1æ²¡æœ‰èµ°å®Œçš„æ—¶å€™ï¼Œåç»­çš„çº¿ç¨‹2ï¼Œçº¿ç¨‹3ï¼Œçº¿ç¨‹4åŒæ—¶è¿‡æ¥è®¿é—®å½“å‰è¿™ä¸ªæ–¹æ³•ï¼Œ é‚£ä¹ˆè¿™äº›çº¿ç¨‹éƒ½ä¸èƒ½ä»ç¼“å­˜ä¸­æŸ¥è¯¢åˆ°æ•°æ®ï¼Œé‚£ä¹ˆä»–ä»¬å°±ä¼šåŒä¸€æ—¶åˆ»æ¥è®¿é—®æŸ¥è¯¢ç¼“å­˜ï¼Œéƒ½æ²¡æŸ¥åˆ°ï¼Œæ¥ç€åŒä¸€æ—¶é—´å»è®¿é—®æ•°æ®åº“ï¼ŒåŒæ—¶çš„å»æ‰§è¡Œæ•°æ®åº“ä»£ç ï¼Œå¯¹æ•°æ®åº“è®¿é—®å‹åŠ›è¿‡å¤§ã€‚<br />!![20.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_986f821f27-20.png) <br />**æ–¹æ¡ˆä¸€ï¼šäº’æ–¥é”åˆ†æï¼š**\n\n- åˆ©ç”¨é”çš„äº’æ–¥æ€§ï¼Œå‡è®¾çº¿ç¨‹è¿‡æ¥ï¼Œåªèƒ½ä¸€ä¸ªäººä¸€ä¸ªäººçš„è®¿é—®æ•°æ®åº“ï¼Œä»è€Œé¿å…å¯¹æ•°æ®åº“é¢‘ç¹è®¿é—®äº§ç”Ÿè¿‡å¤§å‹åŠ›ï¼Œä½†è¿™ä¹Ÿä¼šå½±å“æŸ¥è¯¢çš„æ€§èƒ½ï¼Œå°†æŸ¥è¯¢çš„æ€§èƒ½ä»å¹¶è¡Œå˜æˆäº†ä¸²è¡Œï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨tryLockæ–¹æ³•+double checkæ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚\n- å‡è®¾ç°åœ¨çº¿ç¨‹1è¿‡æ¥è®¿é—®ï¼Œä»–æŸ¥è¯¢ç¼“å­˜æ²¡æœ‰å‘½ä¸­ï¼Œä½†æ˜¯æ­¤æ—¶ä»–è·å¾—åˆ°äº†é”çš„èµ„æºï¼Œé‚£ä¹ˆçº¿ç¨‹1å°±ä¼šä¸€ä¸ªäººå»æ‰§è¡Œé€»è¾‘ï¼Œå‡è®¾ç°åœ¨çº¿ç¨‹2è¿‡æ¥ï¼Œçº¿ç¨‹2åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¹¶æ²¡æœ‰è·å¾—åˆ°é”ï¼Œé‚£ä¹ˆçº¿ç¨‹2å°±å¯ä»¥è¿›è¡Œåˆ°ä¼‘çœ ï¼Œç›´åˆ°çº¿ç¨‹1æŠŠé”é‡Šæ”¾åï¼Œçº¿ç¨‹2è·å¾—åˆ°é”ï¼Œç„¶åå†æ¥æ‰§è¡Œé€»è¾‘ï¼Œæ­¤æ—¶å°±èƒ½å¤Ÿä»ç¼“å­˜ä¸­æ‹¿åˆ°æ•°æ®äº†ã€‚\n\n![21.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_9c0717f827-21.png) <br />**æ–¹æ¡ˆäºŒï¼šé€»è¾‘è¿‡æœŸåˆ†æï¼š**\n\n- æˆ‘ä»¬ä¹‹æ‰€ä»¥ä¼šå‡ºç°è¿™ä¸ªç¼“å­˜å‡»ç©¿é—®é¢˜ï¼Œä¸»è¦åŸå› æ˜¯åœ¨äºæˆ‘ä»¬å¯¹keyè®¾ç½®äº†è¿‡æœŸæ—¶é—´ï¼Œå‡è®¾æˆ‘ä»¬ä¸è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå…¶å®å°±ä¸ä¼šæœ‰ç¼“å­˜å‡»ç©¿çš„é—®é¢˜ï¼Œä½†æ˜¯ä¸è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œæ•°æ®åˆä¼šä¸€ç›´å ç”¨æˆ‘ä»¬çš„å†…å­˜ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é‡‡ç”¨é€»è¾‘è¿‡æœŸæ–¹æ¡ˆã€‚\n- æˆ‘ä»¬æŠŠè¿‡æœŸæ—¶é—´è®¾ç½®åœ¨redisçš„valueä¸­ï¼Œæ³¨æ„ï¼šè¿™ä¸ªè¿‡æœŸæ—¶é—´å¹¶ä¸ä¼šç›´æ¥ä½œç”¨äºredisï¼Œè€Œæ˜¯æˆ‘ä»¬åç»­é€šè¿‡é€»è¾‘å»å¤„ç†ã€‚å‡è®¾çº¿ç¨‹1å»æŸ¥è¯¢ç¼“å­˜ï¼Œç„¶åä»valueä¸­åˆ¤æ–­å‡ºæ¥å½“å‰çš„æ•°æ®å·²ç»è¿‡æœŸäº†ï¼Œæ­¤æ—¶çº¿ç¨‹1å»è·å¾—äº’æ–¥é”ï¼Œé‚£ä¹ˆå…¶ä»–çº¿ç¨‹ä¼šè¿›è¡Œé˜»å¡ï¼Œè·å¾—äº†é”çš„çº¿ç¨‹ä»–ä¼šå¼€å¯ä¸€ä¸ª çº¿ç¨‹å»è¿›è¡Œ ä»¥å‰çš„é‡æ„æ•°æ®çš„é€»è¾‘ï¼Œç›´åˆ°æ–°å¼€çš„çº¿ç¨‹å®Œæˆè¿™ä¸ªé€»è¾‘åï¼Œæ‰é‡Šæ”¾é”ï¼Œ è€Œçº¿ç¨‹1ç›´æ¥è¿›è¡Œè¿”å›ï¼Œå‡è®¾ç°åœ¨çº¿ç¨‹3è¿‡æ¥è®¿é—®ï¼Œç”±äºçº¿ç¨‹çº¿ç¨‹2æŒæœ‰ç€é”ï¼Œæ‰€ä»¥çº¿ç¨‹3æ— æ³•è·å¾—é”ï¼Œçº¿ç¨‹3ä¹Ÿç›´æ¥è¿”å›æ•°æ®ï¼Œåªæœ‰ç­‰åˆ°æ–°å¼€çš„çº¿ç¨‹2æŠŠé‡å»ºæ•°æ®æ„å»ºå®Œåï¼Œå…¶ä»–çº¿ç¨‹æ‰èƒ½èµ°è¿”å›æ­£ç¡®çš„æ•°æ®ã€‚\n- è¿™ç§æ–¹æ¡ˆå·§å¦™åœ¨äºï¼Œå¼‚æ­¥çš„æ„å»ºç¼“å­˜ï¼Œç¼ºç‚¹åœ¨äºåœ¨æ„å»ºå®Œç¼“å­˜ä¹‹å‰ï¼Œè¿”å›çš„éƒ½æ˜¯**è„æ•°æ®**ã€‚\n\n![22.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_9e62a3c227-22.png) <br />**å¯¹æ¯”äº’æ–¥é”ä¸é€»è¾‘åˆ é™¤ï¼š**\n\n- **äº’æ–¥é”æ–¹æ¡ˆï¼š** ç”±äºä¿è¯äº†äº’æ–¥æ€§ï¼Œæ‰€ä»¥æ•°æ®ä¸€è‡´ï¼Œä¸”å®ç°ç®€å•ï¼Œåªæ˜¯åŠ äº†ä¸€æŠŠé”è€Œå·²ï¼Œä¹Ÿæ²¡æœ‰å…¶ä»–çš„äº‹æƒ…éœ€è¦æ“å¿ƒï¼Œæ‰€ä»¥æ²¡æœ‰é¢å¤–çš„å†…å­˜æ¶ˆè€—ï¼Œç¼ºç‚¹åœ¨äºæœ‰é”çš„æƒ…å†µï¼Œå°±å¯èƒ½æ­»é”ï¼Œæ‰€ä»¥åªèƒ½ä¸²è¡Œæ‰§è¡Œï¼Œæ€§èƒ½ä¼šå—åˆ°å½±å“ã€‚\n- **é€»è¾‘è¿‡æœŸæ–¹æ¡ˆï¼š** çº¿ç¨‹è¯»å–è¿‡ç¨‹ä¸­ä¸éœ€è¦ç­‰å¾…ï¼Œæ€§èƒ½å¥½ï¼Œæœ‰ä¸€ä¸ªé¢å¤–çš„çº¿ç¨‹æŒæœ‰é”å»è¿›è¡Œé‡æ„ç¼“å­˜æ•°æ®ï¼Œä½†æ˜¯åœ¨é‡æ„æ•°æ®å®Œæˆä¹‹å‰ï¼Œå…¶ä»–çº¿ç¨‹åªèƒ½è¿”å›è„æ•°æ®ï¼Œä¸”å®ç°èµ·æ¥æ¯”è¾ƒéº»çƒ¦ã€‚\n\n![23.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_a201856827-23.png)\n<a name=\"uAmX7\"></a>\n\n#### åˆ©ç”¨äº’æ–¥é”è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜\n\n**æ ¸å¿ƒæ€è·¯ï¼š** ç›¸è¾ƒäºåŸæ¥ä»ç¼“å­˜ä¸­æŸ¥è¯¢ä¸åˆ°æ•°æ®åç›´æ¥æŸ¥è¯¢æ•°æ®åº“è€Œè¨€ï¼Œç°åœ¨çš„æ–¹æ¡ˆæ˜¯è¿›è¡ŒæŸ¥è¯¢ä¹‹åï¼Œå¦‚æœä»ç¼“å­˜æ²¡æœ‰æŸ¥è¯¢åˆ°æ•°æ®ï¼Œåˆ™è¿›è¡Œäº’æ–¥é”çš„è·å–ï¼Œè·å–äº’æ–¥é”åï¼Œåˆ¤æ–­æ˜¯å¦è·å¾—åˆ°äº†é”ï¼Œå¦‚æœæ²¡æœ‰è·å¾—åˆ°ï¼Œåˆ™ä¼‘çœ ï¼Œè¿‡ä¸€ä¼šå†è¿›è¡Œå°è¯•ï¼Œç›´åˆ°è·å–åˆ°é”ä¸ºæ­¢ï¼Œæ‰èƒ½è¿›è¡ŒæŸ¥è¯¢ã€‚<br />![24.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_a4978e1427-24.png) <br />**æ“ä½œé”çš„ä»£ç ï¼š**<br />åˆ©ç”¨redisçš„setnxæ–¹æ³•æ¥è¡¨ç¤ºè·å–é”ï¼Œè¯¥æ–¹æ³•å«ä¹‰æ˜¯redisä¸­å¦‚æœæ²¡æœ‰è¿™ä¸ªkeyï¼Œåˆ™æ’å…¥æˆåŠŸï¼Œè¿”å›1ï¼Œåœ¨stringRedisTemplateä¸­è¿”å›trueï¼Œ å¦‚æœæœ‰è¿™ä¸ªkeyåˆ™æ’å…¥å¤±è´¥ï¼Œåˆ™è¿”å›0ï¼Œåœ¨stringRedisTemplateè¿”å›falseï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡trueï¼Œæˆ–è€…æ˜¯falseï¼Œæ¥è¡¨ç¤ºæ˜¯å¦æœ‰çº¿ç¨‹æˆåŠŸæ’å…¥keyï¼ŒæˆåŠŸæ’å…¥çš„keyçš„çº¿ç¨‹æˆ‘ä»¬è®¤ä¸ºä»–å°±æ˜¯è·å¾—åˆ°é”çš„çº¿ç¨‹ã€‚\n\n```java\n// è·å–é”\nprivate boolean tryLock(String key) {\n    Boolean flag = stringRedisTemplate.opsForValue().setIfAbsent(key, \"1\", 10, TimeUnit.SECONDS);\n    return BooleanUtil.isTrue(flag);\n}\n\n// é‡Šæ”¾é”\nprivate void unlock(String key) {\n    stringRedisTemplate.delete(key);\n}\n```\n\n**å®é™…æŸ¥è¯¢ä»£ç ï¼š**\n\n```java\n public Shop queryWithMutex(Long id)  {\n    String key = CACHE_SHOP_KEY + id;\n    // 1ã€ä»redisä¸­æŸ¥è¯¢å•†é“ºç¼“å­˜\n    String shopJson = stringRedisTemplate.opsForValue().get(\"key\");\n    // 2ã€åˆ¤æ–­æ˜¯å¦å­˜åœ¨\n    if (StrUtil.isNotBlank(shopJson)) {\n        // å­˜åœ¨,ç›´æ¥è¿”å›\n        return JSONUtil.toBean(shopJson, Shop.class);\n    }\n    // åˆ¤æ–­å‘½ä¸­çš„å€¼æ˜¯å¦æ˜¯ç©ºå€¼\n    if (shopJson != null) {\n        // è¿”å›ä¸€ä¸ªé”™è¯¯ä¿¡æ¯\n        return null;\n    }\n    // 4.å®ç°ç¼“å­˜é‡æ„\n    // 4.1 è·å–äº’æ–¥é”\n    String lockKey = \"lock:shop:\" + id;\n    Shop shop = null;\n    try {\n        boolean isLock = tryLock(lockKey);\n        // 4.2 åˆ¤æ–­å¦è·å–æˆåŠŸ\n        if(!isLock) {\n            // 4.3 å¤±è´¥ï¼Œåˆ™ä¼‘çœ é‡è¯•\n            Thread.sleep(50);\n            return queryWithMutex(id);\n        }\n        // 4.4 æˆåŠŸï¼Œæ ¹æ®idæŸ¥è¯¢æ•°æ®åº“\n         shop = getById(id);\n        // 5.ä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯\n        if(shop == null) {\n             // å°†ç©ºå€¼å†™å…¥redis\n            stringRedisTemplate.opsForValue().set(key,\"\",CACHE_NULL_TTL,TimeUnit.MINUTES);\n            // è¿”å›é”™è¯¯ä¿¡æ¯\n            return null;\n        }\n        // 6.å†™å…¥redis\n        stringRedisTemplate.opsForValue().set(key,JSONUtil.toJsonStr(shop),CACHE_NULL_TTL,TimeUnit.MINUTES);\n\n    } catch (Exception e) {\n        throw new RuntimeException(e);\n    }\n    finally {\n        // 7.é‡Šæ”¾äº’æ–¥é”\n        unlock(lockKey);\n    }\n    return shop;\n}\n```\n\n<a name=\"YrlYl\"></a>\n\n#### åˆ©ç”¨é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿\n\n**æ ¸å¿ƒæ€è·¯ï¼š** å½“ç”¨æˆ·å¼€å§‹æŸ¥è¯¢redisæ—¶ï¼Œåˆ¤æ–­æ˜¯å¦å‘½ä¸­ï¼Œå¦‚æœæ²¡æœ‰å‘½ä¸­åˆ™ç›´æ¥è¿”å›ç©ºæ•°æ®ï¼Œä¸æŸ¥è¯¢æ•°æ®åº“ï¼Œè€Œä¸€æ—¦å‘½ä¸­åï¼Œå°†valueå–å‡ºï¼Œåˆ¤æ–­valueä¸­çš„è¿‡æœŸæ—¶é—´æ˜¯å¦æ»¡è¶³ï¼Œå¦‚æœæ²¡æœ‰è¿‡æœŸï¼Œåˆ™ç›´æ¥è¿”å›redisä¸­çš„æ•°æ®ï¼Œå¦‚æœè¿‡æœŸï¼Œåˆ™åœ¨å¼€å¯ç‹¬ç«‹çº¿ç¨‹åç›´æ¥è¿”å›ä¹‹å‰çš„æ•°æ®ï¼Œç‹¬ç«‹çº¿ç¨‹å»é‡æ„æ•°æ®ï¼Œé‡æ„å®Œæˆåé‡Šæ”¾äº’æ–¥é”ã€‚<br />![25.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_a6eb26d327-25.png) <br />**å®ç°æ­¥éª¤ï¼š**\n\n- å°è£…æ•°æ®ï¼šå› ä¸ºç°åœ¨redisä¸­å­˜å‚¨çš„æ•°æ®çš„valueéœ€è¦å¸¦ä¸Šè¿‡æœŸæ—¶é—´ï¼Œæ­¤æ—¶è¦ä¹ˆä½ å»ä¿®æ”¹ï¼ˆæˆ–è€…ç»§æ‰¿ï¼‰åŸæ¥çš„å®ä½“ç±»ï¼Œè¦ä¹ˆæ–°å»ºä¸€ä¸ªç±»åŒ…å«åŸæœ‰çš„æ•°æ®å’Œè¿‡æœŸæ—¶é—´ã€‚\n\n```java\n// è¿™é‡Œæˆ‘ä»¬é€‰æ‹©æ–°å»ºä¸€ä¸ªå®ä½“ç±»ï¼ŒåŒ…å«åŸæœ‰æ•°æ®(Object)å’Œè¿‡æœŸæ—¶é—´ï¼Œè¿™æ ·å¯¹åŸæœ‰çš„ä»£ç æ²¡æœ‰ä¾µå…¥æ€§\n@Data\npublic class RedisData {\n    private LocalDateTime expireTime;\n    private Object data;\n}\n```\n\n- åˆ©ç”¨é€»è¾‘è¿‡æœŸå®ç°è§£å†³ç¼“å­˜å‡»ç©¿\n\n```java\n// è¿™é‡Œéœ€è¦å£°æ˜ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œå› ä¸ºä¸‹é¢æˆ‘ä»¬éœ€è¦æ–°å»ºä¸€ä¸ªçº¿ç¨‹æ¥å®Œæˆé‡æ„ç¼“å­˜\nprivate static final ExecutorService CACHE_REBUILD_EXECUTOR = Executors.newFixedThreadPool(10);\n\n@Override\npublic Shop queryWithLogicalExpire(Long id) {\n    // 1. ä»redisä¸­æŸ¥è¯¢å•†é“ºç¼“å­˜\n    String json = stringRedisTemplate.opsForValue().get(CACHE_SHOP_KEY + id);\n    // 2. å¦‚æœæœªå‘½ä¸­ï¼Œåˆ™è¿”å›ç©º\n    if (StrUtil.isBlank(json)) {\n        return null;\n    }\n    // 3. å‘½ä¸­ï¼Œå°†jsonååºåˆ—åŒ–ä¸ºå¯¹è±¡\n    RedisData redisData = JSONUtil.toBean(json, RedisData.class);\n    // 3.1 å°†dataè½¬ä¸ºShopå¯¹è±¡\n    JSONObject shopJson = (JSONObject) redisData.getData();\n    Shop shop = JSONUtil.toBean(shopJson, Shop.class);\n    // 3.2 è·å–è¿‡æœŸæ—¶é—´\n    LocalDateTime expireTime = redisData.getExpireTime();\n    // 4. åˆ¤æ–­æ˜¯å¦è¿‡æœŸ\n    if (LocalDateTime.now().isBefore(time)) {\n        // 5. æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›å•†é“ºä¿¡æ¯\n        return shop;\n    }\n    // 6. è¿‡æœŸï¼Œå°è¯•è·å–äº’æ–¥é”\n    boolean flag = tryLock(LOCK_SHOP_KEY + id);\n    // 7. è·å–åˆ°äº†é”\n    if (flag) {\n        // 8. å¼€å¯ç‹¬ç«‹çº¿ç¨‹\n        CACHE_REBUILD_EXECUTOR.submit(() -> {\n            try {\n                this.saveShop2Redis(id, LOCK_SHOP_TTL);\n            } catch (Exception e) {\n                throw new RuntimeException(e);\n            } finally {\n                unlock(LOCK_SHOP_KEY + id);\n            }\n        });\n        // 9. ç›´æ¥è¿”å›å•†é“ºä¿¡æ¯\n        return shop;\n    }\n    // 10. æœªè·å–åˆ°é”ï¼Œç›´æ¥è¿”å›å•†é“ºä¿¡æ¯\n    return shop;\n}\n```\n\n<a name=\"hhwVD\"></a>\n\n### å°è£…Rediså·¥å…·ç±»\n\n<a name=\"rPmUo\"></a>\n\n#### å·¥å…·ç±»çš„å„æ–¹æ³•è¯´æ˜\n\næœ¬èŠ‚å°†åŸºäºStringRedisTemplateå°è£…ä¸€ä¸ªç¼“å­˜å·¥å…·ç±»ï¼Œè¯¥å·¥å…·ç±»çš„æ–¹æ³•å¦‚ä¸‹ï¼š\n\n- **æ–¹æ³•1ï¼š** å°†ä»»æ„Javaå¯¹è±¡åºåˆ—åŒ–ä¸ºJSONï¼Œå¹¶å­˜å‚¨åˆ°Stringç±»å‹çš„Keyä¸­ï¼Œå¹¶å¯ä»¥è®¾ç½®TTLè¿‡æœŸæ—¶é—´\n\n```java\npublic void set(String key, Object value, Long time, TimeUnit timeUnit) {\n    stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(value), time, timeUnit);\n}\n```\n\n- **æ–¹æ³•2ï¼š** å°†ä»»æ„Javaå¯¹è±¡åºåˆ—åŒ–ä¸ºJSONï¼Œå¹¶å­˜å‚¨åœ¨Stringç±»å‹çš„Keyä¸­ï¼Œå¹¶å¯ä»¥è®¾ç½®é€»è¾‘è¿‡æœŸæ—¶é—´ï¼ˆç”¨äºå¤„ç†ç¼“å­˜å‡»ç©¿é—®é¢˜ï¼‰\n\n```java\npublic void setWithLogicalExpire(String key, Object value, Long time, TimeUnit unit) {\n    // è®¾ç½®é€»è¾‘è¿‡æœŸ\n    RedisData redisData = new RedisData();\n    redisData.setData(value);\n    redisData.setExpireTime(LocalDateTime.now().plusSeconds(unit.toSeconds(time)));\n    // å†™å…¥Redis\n    stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(redisData));\n}\n```\n\n- **æ–¹æ³•3ï¼š** æ ¹æ®æŒ‡å®šçš„KeyæŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶ååºåˆ—åŒ–ä¸ºæŒ‡å®šç±»å‹ï¼Œåˆ©ç”¨ç¼“å­˜ç©ºå€¼çš„æ–¹å¼è§£å†³ç¼“å­˜ç©¿é€é—®é¢˜\n\n> **æ³¨æ„ï¼š**\n> ï¼ˆ1ï¼‰é€šç”¨æ–¹æ³•æŸ¥è¯¢çš„å°±ä¸ä¸€å®šæ˜¯shopäº†ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨æ³›å‹ä»£æ›¿ï¼ŒåŒæ—¶idä¹Ÿéœ€è¦ä½¿ç”¨æ³›å‹ã€‚\n> ï¼ˆ2ï¼‰keyçš„å‰ç¼€ä¼šéšç€ä¸šåŠ¡ä¸åŒè€Œå˜æ›´ï¼Œæ‰€ä»¥éœ€è¦ä½œä¸ºå‚æ•°ä¼ å…¥\n> ï¼ˆ3ï¼‰å¦‚æœé€šè¿‡ä¼ å…¥çš„idåœ¨redisä¸­æŸ¥è¯¢ä¸åˆ°æ˜¯éœ€è¦å»æ•°æ®åº“æŸ¥è¯¢çš„ï¼Œæ‰€ä»¥éœ€è¦ä¼ å…¥æŸ¥è¯¢æ•°æ®åº“çš„é€»è¾‘å‡½æ•°\n> ï¼ˆ4ï¼‰å¯¹äºTTLçš„è®¾ç½®éœ€è¦ä¼ å…¥æ—¶é—´é•¿åº¦å’Œæ—¶é—´å•ä½\n\n```java\npublic <R, ID> R queryWithPassThrough(String keyPrefix, ID id, Class<R> type, \n                                     Function<ID, R> dbFallback, Long time, TimeUnit unit) {\n    String key = keyPrefix + id;\n    // 1.ä»redisæŸ¥è¯¢å•†é“ºç¼“å­˜\n    String json = stringRedisTemplate.opsForValue().get(key);\n    // 2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨\n    if (StrUtil.isNotBlank(json)) {\n        // 3.å­˜åœ¨ï¼Œç›´æ¥è¿”å›\n        return JSONUtil.toBean(json, type);\n    }\n    // åˆ¤æ–­å‘½ä¸­çš„æ˜¯å¦æ˜¯ç©ºå€¼\n    if (json != null) {\n        // è¿”å›ä¸€ä¸ªé”™è¯¯ä¿¡æ¯\n        return null;\n    }\n\n    // 4.ä¸å­˜åœ¨ï¼Œæ ¹æ®idæŸ¥è¯¢æ•°æ®åº“\n    R r = dbFallback.apply(id);\n    // 5.ä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯\n    if (r == null) {\n        // å°†ç©ºå€¼å†™å…¥redis\n        stringRedisTemplate.opsForValue().set(key, \"\", CACHE_NULL_TTL, TimeUnit.MINUTES);\n        // è¿”å›é”™è¯¯ä¿¡æ¯\n        return null;\n    }\n    // 6.å­˜åœ¨ï¼Œå†™å…¥redis\n    this.set(key, r, time, unit);\n    return r;\n}\n```\n\n- **æ–¹æ³•4ï¼š** æ ¹æ®æŒ‡å®šçš„KeyæŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶ååºåˆ—åŒ–ä¸ºæŒ‡å®šç±»å‹ï¼Œéœ€è¦åˆ©ç”¨é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜\n\n```java\npublic <R, ID> R queryWithLogicalExpire(String keyPrefix, ID id, Class<R> type, \n                                        Function<ID, R> dbFallback, Long time, TimeUnit unit) {\n    String key = keyPrefix + id;\n    // 1.ä»redisæŸ¥è¯¢å•†é“ºç¼“å­˜\n    String json = stringRedisTemplate.opsForValue().get(key);\n    // 2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨\n    if (StrUtil.isBlank(json)) {\n        // 3.å­˜åœ¨ï¼Œç›´æ¥è¿”å›\n        return null;\n    }\n    // 4.å‘½ä¸­ï¼Œéœ€è¦å…ˆæŠŠjsonååºåˆ—åŒ–ä¸ºå¯¹è±¡\n    RedisData redisData = JSONUtil.toBean(json, RedisData.class);\n    R r = JSONUtil.toBean((JSONObject) redisData.getData(), type);\n    LocalDateTime expireTime = redisData.getExpireTime();\n    // 5.åˆ¤æ–­æ˜¯å¦è¿‡æœŸ\n    if(expireTime.isAfter(LocalDateTime.now())) {\n        // 5.1.æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›åº—é“ºä¿¡æ¯\n        return r;\n    }\n    // 5.2.å·²è¿‡æœŸï¼Œéœ€è¦ç¼“å­˜é‡å»º\n    // 6.ç¼“å­˜é‡å»º\n    // 6.1.è·å–äº’æ–¥é”\n    String lockKey = LOCK_SHOP_KEY + id;\n    boolean isLock = tryLock(lockKey);\n    // 6.2.åˆ¤æ–­æ˜¯å¦è·å–é”æˆåŠŸ\n    if (isLock) {\n        // 6.3.æˆåŠŸï¼Œå¼€å¯ç‹¬ç«‹çº¿ç¨‹ï¼Œå®ç°ç¼“å­˜é‡å»º\n        CACHE_REBUILD_EXECUTOR.submit(() -> {\n            try {\n                // æŸ¥è¯¢æ•°æ®åº“\n                R newR = dbFallback.apply(id);\n                // é‡å»ºç¼“å­˜\n                this.setWithLogicalExpire(key, newR, time, unit);\n            } catch (Exception e) {\n                throw new RuntimeException(e);\n            }finally {\n                // é‡Šæ”¾é”\n                unlock(lockKey);\n            }\n        });\n    }\n    // 6.4.è¿”å›è¿‡æœŸçš„å•†é“ºä¿¡æ¯\n    return r;\n}\n```\n\n- **æ–¹æ³•5ï¼š** æ ¹æ®æŒ‡å®šçš„KeyæŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶ååºåˆ—åŒ–ä¸ºæŒ‡å®šç±»å‹ï¼Œéœ€è¦åˆ©ç”¨äº’æ–¥é”è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜\n\n```java\npublic <R, ID> R queryWithMutex(String keyPrefix, ID id, Class<R> type, \n                                Function<ID, R> dbFallback, Long time, TimeUnit unit) {\n    String key = keyPrefix + id;\n    // 1.ä»redisæŸ¥è¯¢å•†é“ºç¼“å­˜\n    String shopJson = stringRedisTemplate.opsForValue().get(key);\n    // 2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨\n    if (StrUtil.isNotBlank(shopJson)) {\n        // 3.å­˜åœ¨ï¼Œç›´æ¥è¿”å›\n        return JSONUtil.toBean(shopJson, type);\n    }\n    // åˆ¤æ–­å‘½ä¸­çš„æ˜¯å¦æ˜¯ç©ºå€¼\n    if (shopJson != null) {\n        // è¿”å›ä¸€ä¸ªé”™è¯¯ä¿¡æ¯\n        return null;\n    }\n\n    // 4.å®ç°ç¼“å­˜é‡å»º\n    // 4.1.è·å–äº’æ–¥é”\n    String lockKey = LOCK_SHOP_KEY + id;\n    R r = null;\n    try {\n        boolean isLock = tryLock(lockKey);\n        // 4.2.åˆ¤æ–­æ˜¯å¦è·å–æˆåŠŸ\n        if (!isLock) {\n            // 4.3.è·å–é”å¤±è´¥ï¼Œä¼‘çœ å¹¶é‡è¯•\n            Thread.sleep(50);\n            return queryWithMutex(keyPrefix, id, type, dbFallback, time, unit);\n        }\n        // 4.4.è·å–é”æˆåŠŸï¼Œæ ¹æ®idæŸ¥è¯¢æ•°æ®åº“\n        r = dbFallback.apply(id);\n        // 5.ä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯\n        if (r == null) {\n            // å°†ç©ºå€¼å†™å…¥redis\n            stringRedisTemplate.opsForValue().set(key, \"\", CACHE_NULL_TTL, TimeUnit.MINUTES);\n            // è¿”å›é”™è¯¯ä¿¡æ¯\n            return null;\n        }\n        // 6.å­˜åœ¨ï¼Œå†™å…¥redis\n        this.set(key, r, time, unit);\n    } catch (InterruptedException e) {\n        throw new RuntimeException(e);\n    }finally {\n        // 7.é‡Šæ”¾é”\n        unlock(lockKey);\n    }\n    // 8.è¿”å›\n    return r;\n}\n```\n\n<a name=\"IvrPv\"></a>\n\n#### å·¥å…·ç±»å®Œæ•´ä»£ç \n\n```java\n@Slf4j\n@Component\npublic class CacheClient {\n\n    private final StringRedisTemplate stringRedisTemplate;\n\n    private static final ExecutorService CACHE_REBUILD_EXECUTOR = Executors.newFixedThreadPool(10);\n\n    public CacheClient(StringRedisTemplate stringRedisTemplate) {\n        this.stringRedisTemplate = stringRedisTemplate;\n    }\n\n    private boolean tryLock(String key) {\n        Boolean flag = stringRedisTemplate.opsForValue().setIfAbsent(key, \"1\", 10, TimeUnit.SECONDS);\n        return BooleanUtil.isTrue(flag);\n    }\n\n    private void unlock(String key) {\n        stringRedisTemplate.delete(key);\n    }\n\n    public void set(String key, Object value, Long time, TimeUnit timeUnit) {\n        stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(value), time, timeUnit);\n    }\n\n    public void setWithLogicalExpire(String key, Object value, Long time, TimeUnit unit) {\n    // è®¾ç½®é€»è¾‘è¿‡æœŸ\n        RedisData redisData = new RedisData();\n        redisData.setData(value);\n        redisData.setExpireTime(LocalDateTime.now().plusSeconds(unit.toSeconds(time)));\n        // å†™å…¥Redis\n        stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(redisData));\n    }\n\n    public <R, ID> R queryWithPassThrough(String keyPrefix, ID id, Class<R> type, \n                                     Function<ID, R> dbFallback, Long time, TimeUnit unit) {\n        String key = keyPrefix + id;\n        // 1.ä»redisæŸ¥è¯¢å•†é“ºç¼“å­˜\n        String json = stringRedisTemplate.opsForValue().get(key);\n        // 2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨\n        if (StrUtil.isNotBlank(json)) {\n            // 3.å­˜åœ¨ï¼Œç›´æ¥è¿”å›\n            return JSONUtil.toBean(json, type);\n        }\n        // åˆ¤æ–­å‘½ä¸­çš„æ˜¯å¦æ˜¯ç©ºå€¼\n        if (json != null) {\n            // è¿”å›ä¸€ä¸ªé”™è¯¯ä¿¡æ¯\n            return null;\n        }\n    \n        // 4.ä¸å­˜åœ¨ï¼Œæ ¹æ®idæŸ¥è¯¢æ•°æ®åº“\n        R r = dbFallback.apply(id);\n        // 5.ä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯\n        if (r == null) {\n            // å°†ç©ºå€¼å†™å…¥redis\n            stringRedisTemplate.opsForValue().set(key, \"\", CACHE_NULL_TTL, TimeUnit.MINUTES);\n            // è¿”å›é”™è¯¯ä¿¡æ¯\n            return null;\n        }\n        // 6.å­˜åœ¨ï¼Œå†™å…¥redis\n        this.set(key, r, time, unit);\n        return r;\n    }\n\n    public <R, ID> R queryWithLogicalExpire(String keyPrefix, ID id, Class<R> type, \n                                            Function<ID, R> dbFallback, Long time, TimeUnit unit) {\n        String key = keyPrefix + id;\n        // 1.ä»redisæŸ¥è¯¢å•†é“ºç¼“å­˜\n        String json = stringRedisTemplate.opsForValue().get(key);\n        // 2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨\n        if (StrUtil.isBlank(json)) {\n            // 3.å­˜åœ¨ï¼Œç›´æ¥è¿”å›\n            return null;\n        }\n        // 4.å‘½ä¸­ï¼Œéœ€è¦å…ˆæŠŠjsonååºåˆ—åŒ–ä¸ºå¯¹è±¡\n        RedisData redisData = JSONUtil.toBean(json, RedisData.class);\n        R r = JSONUtil.toBean((JSONObject) redisData.getData(), type);\n        LocalDateTime expireTime = redisData.getExpireTime();\n        // 5.åˆ¤æ–­æ˜¯å¦è¿‡æœŸ\n        if(expireTime.isAfter(LocalDateTime.now())) {\n            // 5.1.æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›åº—é“ºä¿¡æ¯\n            return r;\n        }\n        // 5.2.å·²è¿‡æœŸï¼Œéœ€è¦ç¼“å­˜é‡å»º\n        // 6.ç¼“å­˜é‡å»º\n        // 6.1.è·å–äº’æ–¥é”\n        String lockKey = LOCK_SHOP_KEY + id;\n        boolean isLock = tryLock(lockKey);\n        // 6.2.åˆ¤æ–­æ˜¯å¦è·å–é”æˆåŠŸ\n        if (isLock) {\n            // 6.3.æˆåŠŸï¼Œå¼€å¯ç‹¬ç«‹çº¿ç¨‹ï¼Œå®ç°ç¼“å­˜é‡å»º\n            CACHE_REBUILD_EXECUTOR.submit(() -> {\n                try {\n                    // æŸ¥è¯¢æ•°æ®åº“\n                    R newR = dbFallback.apply(id);\n                    // é‡å»ºç¼“å­˜\n                    this.setWithLogicalExpire(key, newR, time, unit);\n                } catch (Exception e) {\n                    throw new RuntimeException(e);\n                }finally {\n                    // é‡Šæ”¾é”\n                    unlock(lockKey);\n                }\n            });\n        }\n        // 6.4.è¿”å›è¿‡æœŸçš„å•†é“ºä¿¡æ¯\n        return r;\n    }\n\n    public <R, ID> R queryWithMutex(String keyPrefix, ID id, Class<R> type, \n                                Function<ID, R> dbFallback, Long time, TimeUnit unit) {\n        String key = keyPrefix + id;\n        // 1.ä»redisæŸ¥è¯¢å•†é“ºç¼“å­˜\n        String shopJson = stringRedisTemplate.opsForValue().get(key);\n        // 2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨\n        if (StrUtil.isNotBlank(shopJson)) {\n            // 3.å­˜åœ¨ï¼Œç›´æ¥è¿”å›\n            return JSONUtil.toBean(shopJson, type);\n        }\n        // åˆ¤æ–­å‘½ä¸­çš„æ˜¯å¦æ˜¯ç©ºå€¼\n        if (shopJson != null) {\n            // è¿”å›ä¸€ä¸ªé”™è¯¯ä¿¡æ¯\n            return null;\n        }\n    \n        // 4.å®ç°ç¼“å­˜é‡å»º\n        // 4.1.è·å–äº’æ–¥é”\n        String lockKey = LOCK_SHOP_KEY + id;\n        R r = null;\n        try {\n            boolean isLock = tryLock(lockKey);\n            // 4.2.åˆ¤æ–­æ˜¯å¦è·å–æˆåŠŸ\n            if (!isLock) {\n                // 4.3.è·å–é”å¤±è´¥ï¼Œä¼‘çœ å¹¶é‡è¯•\n                Thread.sleep(50);\n                return queryWithMutex(keyPrefix, id, type, dbFallback, time, unit);\n            }\n            // 4.4.è·å–é”æˆåŠŸï¼Œæ ¹æ®idæŸ¥è¯¢æ•°æ®åº“\n            r = dbFallback.apply(id);\n            // 5.ä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯\n            if (r == null) {\n                // å°†ç©ºå€¼å†™å…¥redis\n                stringRedisTemplate.opsForValue().set(key, \"\", CACHE_NULL_TTL, TimeUnit.MINUTES);\n                // è¿”å›é”™è¯¯ä¿¡æ¯\n                return null;\n            }\n            // 6.å­˜åœ¨ï¼Œå†™å…¥redis\n            this.set(key, r, time, unit);\n        } catch (InterruptedException e) {\n            throw new RuntimeException(e);\n        }finally {\n            // 7.é‡Šæ”¾é”\n            unlock(lockKey);\n        }\n        // 8.è¿”å›\n        return r;\n    }\n}\n```\n\n<a name=\"xXz83\"></a>\n\n## ä¼˜æƒ åˆ¸ç§’æ€\n\n<a name=\"p06OE\"></a>\n\n### Rediså®ç°å…¨å±€å”¯ä¸€ID\n\n<a name=\"s9qYz\"></a>\n\n#### å…¨å±€å”¯ä¸€IDçš„æ„ä¹‰\n\n- éœ€è¦å¯¹è®¢å•åšå”¯ä¸€æ ‡è¯†ï¼ˆidï¼‰\n- id çš„è§„å¾‹æ€§ä¸èƒ½å¤ªæ˜æ˜¾\n- ä¸èƒ½å—åˆ°è¡¨å•æ•°é‡çš„é™åˆ¶ï¼ˆå¯èƒ½ä¼šè¿›è¡Œåˆ†åº“åˆ†è¡¨ï¼‰\n  <a name=\"bGmzZ\"></a>\n\n#### å…¨å±€å”¯ä¸€ç”Ÿæˆå™¨éœ€æ»¡è¶³çš„ç‰¹å¾\n\n- å”¯ä¸€æ€§\n- å®‰å…¨æ€§\n- é€’å¢æ€§\n- é«˜å¯ç”¨\n- é«˜æ€§èƒ½\n  <a name=\"klFjG\"></a>\n\n#### å…¨å±€å”¯ä¸€IDçš„å®ç°\n\nä¸ºäº†å¢åŠ IDçš„å®‰å…¨æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ç›´æ¥ä½¿ç”¨Redisè‡ªå¢çš„æ•°å€¼ï¼Œè€Œæ˜¯æ‹¼æ¥ä¸€äº›å…¶ä»–ä¿¡æ¯ã€‚<br />![26.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_aa4cd5a927-26.png)\n\n```java\n@Component\npublic class RedisIdWorker {\n    @Autowired\n    private StringRedisTemplate stringRedisTemplate;\n    // è®¾ç½®èµ·å§‹æ—¶é—´ï¼Œæˆ‘è¿™é‡Œè®¾å®šçš„æ˜¯2022.01.01 00:00:00\n    public static final Long BEGIN_TIMESTAMP = 1640995200L;\n    // åºåˆ—å·é•¿åº¦\n    public static final Long COUNT_BIT = 32L;\n\n    public long nextId(String keyPrefix) {\n        // 1. ç”Ÿæˆæ—¶é—´æˆ³\n        LocalDateTime now = LocalDateTime.now();\n        long currentSecond = now.toEpochSecond(ZoneOffset.UTC);\n        long timeStamp = currentSecond - BEGIN_TIMESTAMP;\n        // 2. ç”Ÿæˆåºåˆ—å·\n        String date = now.format(DateTimeFormatter.ofPattern(\"yyyy:MM:dd\"));\n        long count = stringRedisTemplate.opsForValue().increment(\"inc:\"+keyPrefix+\":\"+date);\n        // 3. æ‹¼æ¥å¹¶è¿”å›ï¼Œç®€å•ä½è¿ç®—\n        return timeStamp << COUNT_BIT | count;\n    }\n}\n```\n\n<a name=\"hnA5h\"></a>\n\n### å®ç°ç§’æ€ä¸‹å•åŸºæœ¬æµç¨‹\n\né¦–å…ˆï¼Œæ ¹æ®åˆ†æï¼Œç§’æ€çš„ä¸‹å•æµç¨‹å¦‚ä¸‹ï¼š<br />![27.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_ac59d1a427-27.png) <br />**Controllerï¼š**\n\n```java\n@RestController\n@RequestMapping(\"/voucher-order\")\npublic class VoucherOrderController {\n    @Autowired\n    private IVoucherOrderService voucherOrderService;\n    @PostMapping(\"/seckill/{id}\")\n    public Result seckillVoucher(@PathVariable(\"id\") Long voucherId) {\n        return voucherOrderService.seckillVoucher(voucherId);\n    }\n}\n```\n\n**Serviceï¼š**\n\n```java\npublic interface IVoucherOrderService extends IService<VoucherOrder> {\n    Result seckillVoucher(Long voucherId);\n}\n```\n\n**ServiceImplï¼š**\n\n```java\n@Autowired\nprivate ISeckillVoucherService seckillVoucherService;\n\n@Autowired\nprivate RedisIdWorker redisIdWorker;\n@Override\npublic Result seckillVoucher(Long voucherId) {\n    LambdaQueryWrapper<SeckillVoucher> queryWrapper = new LambdaQueryWrapper<>();\n    // 1. æŸ¥è¯¢ä¼˜æƒ åˆ¸\n    queryWrapper.eq(SeckillVoucher::getVoucherId, voucherId);\n    SeckillVoucher seckillVoucher = seckillVoucherService.getOne(queryWrapper);\n    // 2. åˆ¤æ–­ç§’æ€æ—¶é—´æ˜¯å¦å¼€å§‹\n    if (LocalDateTime.now().isBefore(seckillVoucher.getBeginTime())) {\n        return Result.fail(\"ç§’æ€è¿˜æœªå¼€å§‹ï¼Œè¯·è€å¿ƒç­‰å¾…\");\n    }\n    // 3. åˆ¤æ–­ç§’æ€æ—¶é—´æ˜¯å¦ç»“æŸ\n    if (LocalDateTime.now().isAfter(seckillVoucher.getEndTime())) {\n        return Result.fail(\"ç§’æ€å·²ç»ç»“æŸï¼\");\n    }\n    // 4. åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³\n    if (seckillVoucher.getStock() < 1) {\n        return Result.fail(\"ä¼˜æƒ åˆ¸å·²è¢«æŠ¢å…‰äº†å“¦ï¼Œä¸‹æ¬¡è®°å¾—æ‰‹é€Ÿå¿«ç‚¹\");\n    }\n    // 5. æ‰£å‡åº“å­˜\n    boolean success = seckillVoucherService.update()\n        .setSql(\"stock = stock - 1\")\n        .eq(\"voucher_id\",voucherId)\n        .update();\n    if (!success) {\n        return Result.fail(\"åº“å­˜ä¸è¶³\");\n    }\n    // 6. åˆ›å»ºè®¢å•\n    VoucherOrder voucherOrder = new VoucherOrder();\n    // 6.1 è®¾ç½®è®¢å•id\n    long orderId = redisIdWorker.nextId(\"order\");\n    // 6.2 è®¾ç½®ç”¨æˆ·id\n    Long id = UserHolder.getUser().getId();\n    // 6.3 è®¾ç½®ä»£é‡‘åˆ¸id\n    voucherOrder.setVoucherId(voucherId);\n    voucherOrder.setId(orderId);\n    voucherOrder.setUserId(id);\n    // 7. å°†è®¢å•æ•°æ®ä¿å­˜åˆ°è¡¨ä¸­\n    save(voucherOrder);\n    // 8. è¿”å›è®¢å•id\n    return Result.ok(orderId);\n}\n```\n\n<a name=\"N2Lom\"></a>\n\n### è§£å†³è¶…å–é—®é¢˜\n\n<a name=\"C12nl\"></a>\n\n#### è¶…å–é—®é¢˜åˆ†æ\n\nåœ¨å®Œæˆç§’æ€åŸºæœ¬ä¸‹å•æµç¨‹åï¼Œæˆ‘ä»¬å‘ç°ï¼Œåœ¨æµ‹è¯•çš„æ—¶å€™ä¼šäº§ç”Ÿçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼š\n\n- çº¿ç¨‹1æŸ¥è¯¢ï¼Œå‘ç°å•†å“æ•°é‡å¤§äº0ï¼ˆå•†å“æ•°é‡ä¸º1ï¼‰\n- çº¿ç¨‹2æŸ¥è¯¢ï¼Œå‘ç°å•†å“æ•°é‡å¤§äº0ï¼ˆå•†å“æ•°é‡ä¸º1ï¼‰\n- çº¿ç¨‹1åˆ›å»ºè®¢å•ï¼Œå¹¶æ‰£å‡åº“å­˜\n- çº¿ç¨‹1åˆ›å»ºè®¢å•ï¼Œå¹¶æ‰£å‡åº“å­˜ï¼ˆæ­¤æ—¶åº“å­˜å·²ç»ä¸º0ï¼Œä½†ä»ç„¶åˆ›å»ºäº†è®¢å•ï¼Œå¹¶æ‰£å‡åº“å­˜ï¼Œå¯¼è‡´è¶…å–é—®é¢˜ï¼‰\n\n![28.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_afb7ccee27-28.png)\n<a name=\"eaXCP\"></a>\n\n#### è¶…å–é—®é¢˜è§£å†³æ€è·¯\n\nè¶…å–é—®é¢˜æ˜¯å…¸å‹çš„å¤šçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œé’ˆå¯¹è¿™ä¸€é—®é¢˜çš„å¸¸è§è§£å†³æ–¹æ¡ˆå°±æ˜¯åŠ é”ï¼šè€Œå¯¹äºåŠ é”ï¼Œæˆ‘ä»¬é€šå¸¸æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š\n\n1. **æ‚²è§‚é”**\n\n- æ‚²è§‚é”è®¤ä¸ºçº¿ç¨‹å®‰å…¨é—®é¢˜ä¸€å®šä¼šå‘ç”Ÿï¼Œå› æ­¤åœ¨æ“ä½œæ•°æ®ä¹‹å‰å…ˆè·å–é”ï¼Œç¡®ä¿çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œ\n- ä¾‹å¦‚Synchronizedã€Lockç­‰ï¼Œéƒ½æ˜¯æ‚²è§‚é”\n\n2. **ä¹è§‚é”**\n\n- ä¹è§‚é”è®¤ä¸ºçº¿ç¨‹å®‰å…¨é—®é¢˜ä¸ä¸€å®šä¼šå‘ç”Ÿï¼Œå› æ­¤ä¸åŠ é”ï¼Œåªæ˜¯åœ¨æ›´æ–°æ•°æ®çš„æ—¶å€™å†å»åˆ¤æ–­æœ‰æ²¡æœ‰å…¶ä»–çº¿ç¨‹å¯¹æ•°æ®è¿›è¡Œäº†ä¿®æ”¹\n    - å¦‚æœæ²¡æœ‰ä¿®æ”¹ï¼Œåˆ™è®¤ä¸ºè‡ªå·±æ˜¯å®‰å…¨çš„ï¼Œè‡ªå·±æ‰å¯ä»¥æ›´æ–°æ•°æ®\n    - å¦‚æœå·²ç»è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ï¼Œåˆ™è¯´æ˜å‘ç”Ÿäº†å®‰å…¨é—®é¢˜ï¼Œæ­¤æ—¶å¯ä»¥é‡è¯•æˆ–è€…å¼‚å¸¸\n\n**æ‚²è§‚é”ï¼š** æ‚²è§‚é”å¯ä»¥å®ç°å¯¹äºæ•°æ®çš„ä¸²è¡ŒåŒ–æ‰§è¡Œï¼Œæ¯”å¦‚synï¼Œå’Œlockéƒ½æ˜¯æ‚²è§‚é”çš„ä»£è¡¨ï¼ŒåŒæ—¶ï¼Œæ‚²è§‚é”ä¸­åˆå¯ä»¥å†ç»†åˆ†ä¸ºå…¬å¹³é”ï¼Œéå…¬å¹³é”ï¼Œå¯é‡å…¥é”ç­‰ç­‰ã€‚<br />**ä¹è§‚é”ï¼š** ä¹è§‚é”åˆ™æ˜¯å¢åŠ ç‰ˆæœ¬å·å­—æ®µï¼Œæ¯æ¬¡æ“ä½œæ•°æ®ä¼šå¯¹ç‰ˆæœ¬å·+1ï¼Œæäº¤æ“ä½œæ—¶ä¼šæ ¡éªŒå½“å‰ç‰ˆæœ¬å·æ˜¯å¦ä¸åˆšæ‰æŸ¥è¯¢çš„ç‰ˆæœ¬å·ä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´åˆ™è¯´æ˜å·²ç»è¢«ä¿®æ”¹è¿‡ã€‚\n\n> æ­¤å¤„é‡‡ç”¨é’ˆå¯¹å½“å‰ä¸šåŠ¡ä¼˜åŒ–çš„ä¹è§‚é”è§£å†³è¶…å–é—®é¢˜ã€‚æˆ‘ä»¬åœ¨å®ç°çš„æ—¶å€™å¹¶ä¸éœ€è¦å¢åŠ ä¸€ä¸ªç‰ˆæœ¬å·å­—æ®µï¼Œè€Œæ˜¯åˆ©ç”¨åº“å­˜æ˜¯å¦å‘ç”Ÿå˜åŒ–è¿›è¡Œç‰ˆæœ¬çš„åˆ¤æ–­ï¼ˆæ›´è¿›ä¸€æ­¥å¯ä»¥åªæ˜¯æ ¡éªŒåº“å­˜æ˜¯å¦å¤§äº0ï¼‰\n\n**ä»£ç å®ç°ï¼š**\n\n```java\n@Override\npublic Result seckillVoucher(Long voucherId) {\n    LambdaQueryWrapper<SeckillVoucher> queryWrapper = new LambdaQueryWrapper<>();\n    // 1. æŸ¥è¯¢ä¼˜æƒ åˆ¸\n    queryWrapper.eq(SeckillVoucher::getVoucherId, voucherId);\n    SeckillVoucher seckillVoucher = seckillVoucherService.getOne(queryWrapper);\n    // 2. åˆ¤æ–­ç§’æ€æ—¶é—´æ˜¯å¦å¼€å§‹\n    if (LocalDateTime.now().isBefore(seckillVoucher.getBeginTime())) {\n        return Result.fail(\"ç§’æ€è¿˜æœªå¼€å§‹ï¼Œè¯·è€å¿ƒç­‰å¾…\");\n    }\n    // 3. åˆ¤æ–­ç§’æ€æ—¶é—´æ˜¯å¦ç»“æŸ\n    if (LocalDateTime.now().isAfter(seckillVoucher.getEndTime())) {\n        return Result.fail(\"ç§’æ€å·²ç»ç»“æŸï¼\");\n    }\n    // 4. åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³\n    if (seckillVoucher.getStock() < 1) {\n        return Result.fail(\"ä¼˜æƒ åˆ¸å·²è¢«æŠ¢å…‰äº†å“¦ï¼Œä¸‹æ¬¡è®°å¾—æ‰‹é€Ÿå¿«ç‚¹\");\n    }\n    // 5. æ‰£å‡åº“å­˜\n    boolean success = seckillVoucherService.update()\n            .setSql(\"stock = stock - 1\")\n            .eq(\"voucher_id\", voucherId)\n            .gt(\"stock\", 0)\n            .update();\n    if (!success) {\n        return Result.fail(\"åº“å­˜ä¸è¶³\");\n    }\n    // 6. åˆ›å»ºè®¢å•\n    VoucherOrder voucherOrder = new VoucherOrder();\n    // 6.1 è®¾ç½®è®¢å•id\n    long orderId = redisIdWorker.nextId(\"order\");\n    // 6.2 è®¾ç½®ç”¨æˆ·id\n    Long id = UserHolder.getUser().getId();\n    // 6.3 è®¾ç½®ä»£é‡‘åˆ¸id\n    voucherOrder.setVoucherId(voucherId);\n    voucherOrder.setId(orderId);\n    voucherOrder.setUserId(id);\n    // 7. å°†è®¢å•æ•°æ®ä¿å­˜åˆ°è¡¨ä¸­\n    save(voucherOrder);\n    // 8. è¿”å›è®¢å•id\n    return Result.ok(orderId);\n}\n```\n\n<a name=\"Xc5L9\"></a>\n\n### ä¸€äººä¸€å•é™åˆ¶\n\n<a name=\"apNlJ\"></a>\n\n#### ä¸€äººä¸€å•é—®é¢˜åˆ†æ\n\nåœ¨ä¼˜æƒ åˆ¸åœºæ™¯å½“ä¸­ï¼Œå¾€å¾€ä¼šæœ‰åŒä¸€ä¸ªç”¨æˆ·å¯¹äºåŒä¸€ç§ä¼˜æƒ åˆ¸åªèƒ½è´­ä¹°ä¸€å•çš„éœ€æ±‚ã€‚<br />**é€»è¾‘åˆ†æï¼š**<br />![29.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_b2423a1527-29.png)\n<a name=\"f058H\"></a>\n\n#### åˆæ­¥ä»£ç å®ç°\n\n```java\n@Override\npublic Result seckillVoucher(Long voucherId) {\n    LambdaQueryWrapper<SeckillVoucher> queryWrapper = new LambdaQueryWrapper<>();\n    // 1. æŸ¥è¯¢ä¼˜æƒ åˆ¸\n    queryWrapper.eq(SeckillVoucher::getVoucherId, voucherId);\n    SeckillVoucher seckillVoucher = seckillVoucherService.getOne(queryWrapper);\n    // 2. åˆ¤æ–­ç§’æ€æ—¶é—´æ˜¯å¦å¼€å§‹\n    if (LocalDateTime.now().isBefore(seckillVoucher.getBeginTime())) {\n        return Result.fail(\"ç§’æ€è¿˜æœªå¼€å§‹ï¼Œè¯·è€å¿ƒç­‰å¾…\");\n    }\n    // 3. åˆ¤æ–­ç§’æ€æ—¶é—´æ˜¯å¦ç»“æŸ\n    if (LocalDateTime.now().isAfter(seckillVoucher.getEndTime())) {\n        return Result.fail(\"ç§’æ€å·²ç»ç»“æŸï¼\");\n    }\n    // 4. åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³\n    if (seckillVoucher.getStock() < 1) {\n        return Result.fail(\"ä¼˜æƒ åˆ¸å·²è¢«æŠ¢å…‰äº†å“¦ï¼Œä¸‹æ¬¡è®°å¾—æ‰‹é€Ÿå¿«ç‚¹\");\n    }\n\n    // æ–°å¢ä¸€äººä¸€å•é€»è¾‘\n    Long userId = UserHolder.getUser().getId();\n    int count = query().eq(\"voucher_id\", voucherId).eq(\"user_id\", userId).count();\n    if (count > 0) {\n        return Result.fail(\"ä½ å·²ç»æŠ¢è¿‡ä¼˜æƒ åˆ¸äº†å“¦\");\n    }\n\n    // 5. æ‰£å‡åº“å­˜\n    boolean success = seckillVoucherService.update()\n            .setSql(\"stock = stock - 1\")\n            .eq(\"voucher_id\", voucherId)\n            .gt(\"stock\", 0)\n            .update();\n    if (!success) {\n        return Result.fail(\"åº“å­˜ä¸è¶³\");\n    }\n    // 6. åˆ›å»ºè®¢å•\n    VoucherOrder voucherOrder = new VoucherOrder();\n    // 6.1 è®¾ç½®è®¢å•id\n    long orderId = redisIdWorker.nextId(\"order\");\n    // 6.2 è®¾ç½®ç”¨æˆ·id\n    Long id = UserHolder.getUser().getId();\n    // 6.3 è®¾ç½®ä»£é‡‘åˆ¸id\n    voucherOrder.setVoucherId(voucherId);\n    voucherOrder.setId(orderId);\n    voucherOrder.setUserId(id);\n    // 7. å°†è®¢å•æ•°æ®ä¿å­˜åˆ°è¡¨ä¸­\n    save(voucherOrder);\n    // 8. è¿”å›è®¢å•id\n    return Result.ok(orderId);\n}\n```\n\n<a name=\"yiWt2\"></a>\n\n#### åˆæ­¥ä»£ç é—®é¢˜åˆ†æä¸äºŒæ¬¡ä»£ç å®ç°\n\nä¸è¶…å–é—®é¢˜ç±»ä¼¼ï¼Œä¸€äººä¸€å•ä¹Ÿå­˜åœ¨ç€åŒæ ·çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼ˆå½“ä¸€ä¸ªç”¨æˆ·åŒæ—¶ä½¿ç”¨å¤šä¸ªè®¾å¤‡ç§’æ€ä¼˜æƒ åˆ¸æ—¶ï¼‰ï¼š\n\n- çº¿ç¨‹1æŸ¥è¯¢ï¼Œå‘ç°å½“å‰ç”¨æˆ·æœªè´­ä¹°è¿‡è¯¥ä¼˜æƒ åˆ¸\n- çº¿ç¨‹2æŸ¥è¯¢ï¼Œå‘ç°å½“å‰ç”¨æˆ·æœªè´­ä¹°è¿‡è¯¥ä¼˜æƒ åˆ¸\n- çº¿ç¨‹1åˆ›å»ºè®¢å•ï¼Œå¹¶æ‰£å‡åº“å­˜\n- çº¿ç¨‹2åˆ›å»ºè®¢å•ï¼Œå¹¶æ‰£å‡åº“å­˜ï¼ˆå¯¼è‡´çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼‰\n\näºæ˜¯ä¹ï¼Œæˆ‘ä»¬åªèƒ½è¢«è¿«è¿›è¡ŒåŠ é”ï¼Œä½†æ˜¯ä¹è§‚é”æ¯”è¾ƒé€‚åˆæ›´æ–°æ•°æ®ï¼Œè€Œç°åœ¨æ˜¯æ’å…¥æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨æ‚²è§‚é”æ“ä½œã€‚<br />é¦–å…ˆæˆ‘ä»¬å°†åˆ›å»ºè®¢å•éƒ¨åˆ†æŠ½å–å‡ºæ¥ï¼Œå¹¶åŠ ä¸Š**synchronized é”**ï¼ŒåŒæ—¶åŠ ä¸Šäº‹åŠ¡@Transactionalã€‚\n\n```java\n@Transactional\npublic synchronized Result createVoucherOrder(Long voucherId) {\n\n\tLong userId = UserHolder.getUser().getId();\n         // 5.1.æŸ¥è¯¢è®¢å•\n        int count = query().eq(\"user_id\", userId).eq(\"voucher_id\", voucherId).count();\n        // 5.2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨\n        if (count > 0) {\n            // ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†\n            return Result.fail(\"ç”¨æˆ·å·²ç»è´­ä¹°è¿‡ä¸€æ¬¡ï¼\");\n        }\n\n        // 6.æ‰£å‡åº“å­˜\n        boolean success = seckillVoucherService.update()\n                .setSql(\"stock = stock - 1\") // set stock = stock - 1\n                .eq(\"voucher_id\", voucherId).gt(\"stock\", 0) // where id = ? and stock > 0\n                .update();\n        if (!success) {\n            // æ‰£å‡å¤±è´¥\n            return Result.fail(\"åº“å­˜ä¸è¶³ï¼\");\n        }\n\n        // 7.åˆ›å»ºè®¢å•\n        VoucherOrder voucherOrder = new VoucherOrder();\n        // 7.1.è®¢å•id\n        long orderId = redisIdWorker.nextId(\"order\");\n        voucherOrder.setId(orderId);\n        // 7.2.ç”¨æˆ·id\n        voucherOrder.setUserId(userId);\n        // 7.3.ä»£é‡‘åˆ¸id\n        voucherOrder.setVoucherId(voucherId);\n        save(voucherOrder);\n\n        // 7.è¿”å›è®¢å•id\n        return Result.ok(orderId);\n}\n```\n\n<a name=\"ElomY\"></a>\n\n#### äºŒæ¬¡ä»£ç é—®é¢˜åˆ†æä¸ä¸‰æ¬¡ä»£ç å®ç°\n\næˆ‘ä»¬å‘ç°ï¼ŒäºŒæ¬¡ä»£ç ä¸­åŠ é”çš„ç²’åº¦å¤ªå¤§äº†ï¼ˆåœ¨ä½¿ç”¨é”è¿‡ç¨‹ä¸­ï¼Œæ§åˆ¶é”ç²’åº¦ æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„äº‹æƒ…ï¼Œå› ä¸ºå¦‚æœé”çš„ç²’åº¦å¤ªå¤§ï¼Œä¼šå¯¼è‡´æ¯ä¸ªçº¿ç¨‹è¿›æ¥éƒ½ä¼šé”ä½ï¼‰ã€‚<br />åœ¨å½“å‰ä¸šåŠ¡ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦å¯¹åŒä¸€ä¸ªç”¨æˆ·åŠ é”å³å¯ï¼Œäºæ˜¯æœ‰äº†ç‰ˆæœ¬3ã€‚\n\n```java\n@Transactional\npublic  Result createVoucherOrder(Long voucherId) {\n\tLong userId = UserHolder.getUser().getId();\n    // intern() è¿™ä¸ªæ–¹æ³•æ˜¯ä»å¸¸é‡æ± ä¸­æ‹¿åˆ°æ•°æ®ï¼Œå¦‚æœæˆ‘ä»¬ç›´æ¥ä½¿ç”¨userId.toString() ä»–æ‹¿åˆ°çš„å¯¹è±¡å®é™…ä¸Šæ˜¯ä¸åŒçš„å¯¹è±¡ï¼Œnew å‡ºæ¥çš„å¯¹è±¡ï¼Œæˆ‘ä»¬ä½¿ç”¨é”å¿…é¡»ä¿è¯é”å¿…é¡»æ˜¯åŒä¸€æŠŠï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨intern()æ–¹æ³•\n\tsynchronized(userId.toString().intern()) {\n         // 5.1.æŸ¥è¯¢è®¢å•\n        int count = query().eq(\"user_id\", userId).eq(\"voucher_id\", voucherId).count();\n        // 5.2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨\n        if (count > 0) {\n            // ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†\n            return Result.fail(\"ç”¨æˆ·å·²ç»è´­ä¹°è¿‡ä¸€æ¬¡ï¼\");\n        }\n\n        // 6.æ‰£å‡åº“å­˜\n        boolean success = seckillVoucherService.update()\n                .setSql(\"stock = stock - 1\") // set stock = stock - 1\n                .eq(\"voucher_id\", voucherId).gt(\"stock\", 0) // where id = ? and stock > 0\n                .update();\n        if (!success) {\n            // æ‰£å‡å¤±è´¥\n            return Result.fail(\"åº“å­˜ä¸è¶³ï¼\");\n        }\n\n        // 7.åˆ›å»ºè®¢å•\n        VoucherOrder voucherOrder = new VoucherOrder();\n        // 7.1.è®¢å•id\n        long orderId = redisIdWorker.nextId(\"order\");\n        voucherOrder.setId(orderId);\n        // 7.2.ç”¨æˆ·id\n        voucherOrder.setUserId(userId);\n        // 7.3.ä»£é‡‘åˆ¸id\n        voucherOrder.setVoucherId(voucherId);\n        save(voucherOrder);\n\n        // 7.è¿”å›è®¢å•id\n        return Result.ok(orderId);\n    }\n}\n```\n\n<a name=\"vE7h3\"></a>\n\n#### ä¸‰æ¬¡ä»£ç é—®é¢˜åˆ†æä¸æœ€ç»ˆç‰ˆæœ¬ä»£ç å®ç°\n\nåœ¨ç¬¬ä¸‰ä¸ªç‰ˆæœ¬ä¸­ä¾ç„¶å­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼š\n\n- é—®é¢˜1ï¼šå½“å‰æ–¹æ³•è¢«springçš„äº‹åŠ¡æ§åˆ¶ï¼Œå¦‚æœä½ åœ¨æ–¹æ³•å†…éƒ¨åŠ é”ï¼Œå¯èƒ½ä¼šå¯¼è‡´å½“å‰æ–¹æ³•äº‹åŠ¡è¿˜æ²¡æœ‰æäº¤ï¼Œä½†æ˜¯é”å·²ç»é‡Šæ”¾ï¼Œå¯¼è‡´å¹¶å‘é—®é¢˜å†æ¬¡å‡ºç°\n- é—®é¢˜2ï¼šä½†æ˜¯å¦‚æœå°†é”åŠ åœ¨è°ƒç”¨createVoucherOrderçš„åœ°æ–¹ï¼ˆé—®é¢˜1çš„è§£å†³åŠæ³•ï¼‰ï¼Œæˆ‘ä»¬çš„äº‹åŠ¡æ˜¯æ— æ³•æ­£å¸¸ç”Ÿæ•ˆçš„ï¼Œå› ä¸ºæˆ‘ä»¬è°ƒç”¨è¿™ä¸ªå‡½æ•°å…¶å®æ˜¯`this.`çš„æ–¹å¼è°ƒç”¨çš„ï¼Œæƒ³è¦äº‹åŠ¡ç”Ÿæ•ˆï¼Œå¿…é¡»é€šè¿‡ä»£ç†æ¥è¿›è¡Œè°ƒç”¨ã€‚\n\näºæ˜¯ï¼Œæˆ‘ä»¬è¿™é‡Œå¯ä»¥å°†é”åŠ åœ¨è°ƒç”¨createVoucherOrderçš„åœ°æ–¹ï¼ŒåŒæ—¶åˆ©ç”¨`AopContext.currentProxy()`æ¥è·å–å½“å‰å¯¹è±¡çš„ä»£ç†å¯¹è±¡ï¼Œç„¶åå†ç”¨ä»£ç†å¯¹è±¡è°ƒç”¨æ–¹æ³•\n\n> éœ€è¦åœ¨æ¥å£ä¸­åˆ›å»ºcreateVoucherOrderæ–¹æ³•ã€‚\n> éœ€è¦å¼•å…¥aspectjweaverä¾èµ–\n> åœ¨å¯åŠ¨ç±»ä¸ŠåŠ ä¸Š@EnableAspectJAutoProxy(exposeProxy = true)æ³¨è§£\n\n**æœ€ç»ˆä»£ç å®ç°ï¼š**\n\n```java\n@Override\npublic Result seckillVoucher(Long voucherId) {\n    LambdaQueryWrapper<SeckillVoucher> queryWrapper = new LambdaQueryWrapper<>();\n    // 1. æŸ¥è¯¢ä¼˜æƒ åˆ¸\n    queryWrapper.eq(SeckillVoucher::getVoucherId, voucherId);\n    SeckillVoucher seckillVoucher = seckillVoucherService.getOne(queryWrapper);\n    // 2. åˆ¤æ–­ç§’æ€æ—¶é—´æ˜¯å¦å¼€å§‹\n    if (LocalDateTime.now().isBefore(seckillVoucher.getBeginTime())) {\n        return Result.fail(\"ç§’æ€è¿˜æœªå¼€å§‹ï¼Œè¯·è€å¿ƒç­‰å¾…\");\n    }\n    // 3. åˆ¤æ–­ç§’æ€æ—¶é—´æ˜¯å¦ç»“æŸ\n    if (LocalDateTime.now().isAfter(seckillVoucher.getEndTime())) {\n        return Result.fail(\"ç§’æ€å·²ç»ç»“æŸï¼\");\n    }\n    // 4. åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³\n    if (seckillVoucher.getStock() < 1) {\n        return Result.fail(\"ä¼˜æƒ åˆ¸å·²è¢«æŠ¢å…‰äº†å“¦ï¼Œä¸‹æ¬¡è®°å¾—æ‰‹é€Ÿå¿«ç‚¹\");\n    }\n\n    Long userId = UserHolder.getUser().getId();\n\n    // åœ¨è°ƒç”¨å¤„åŠ é”ï¼ŒåŒæ—¶åˆ©ç”¨ä»£ç†ä½¿äº‹åŠ¡ç”Ÿæ•ˆ\n    synchronized (userId.toString().intern()) {\n        IVoucherOrderService proxy = (IVoucherOrderService) AopContext.currentProxy();\n        return proxy.createVoucherOrder(voucherId);\n    }\n}\n\n@Transactional\npublic  Result createVoucherOrder(Long voucherId) {\n    // 5.1.æŸ¥è¯¢è®¢å•\n    int count = query().eq(\"user_id\", userId).eq(\"voucher_id\", voucherId).count();\n    // 5.2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨\n    if (count > 0) {\n        // ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†\n        return Result.fail(\"ç”¨æˆ·å·²ç»è´­ä¹°è¿‡ä¸€æ¬¡ï¼\");\n    }\n\n    // 6.æ‰£å‡åº“å­˜\n    boolean success = seckillVoucherService.update()\n            .setSql(\"stock = stock - 1\") // set stock = stock - 1\n            .eq(\"voucher_id\", voucherId).gt(\"stock\", 0) // where id = ? and stock > 0\n            .update();\n    if (!success) {\n        // æ‰£å‡å¤±è´¥\n        return Result.fail(\"åº“å­˜ä¸è¶³ï¼\");\n    }\n\n    // 7.åˆ›å»ºè®¢å•\n    VoucherOrder voucherOrder = new VoucherOrder();\n    // 7.1.è®¢å•id\n    long orderId = redisIdWorker.nextId(\"order\");\n    voucherOrder.setId(orderId);\n    // 7.2.ç”¨æˆ·id\n    voucherOrder.setUserId(userId);\n    // 7.3.ä»£é‡‘åˆ¸id\n    voucherOrder.setVoucherId(voucherId);\n    save(voucherOrder);\n\n    // 7.è¿”å›è®¢å•id\n    return Result.ok(orderId);\n}\n```\n**å½“å‰æœ‰æ›´ä¼˜çš„æ–¹æ¡ˆï¼š** å³å°†ç”¨æˆ·çš„è´­ä¹°ä¿¡æ¯åŠ åˆ°Redisä¸­ï¼Œç”¨æˆ·ä¸‹å•æ—¶ç›´æ¥ä»Redisä¸­æŸ¥è¯¢ï¼Œæ ¡éªŒå…¶ä¸‹å•æ•°é‡ã€‚\n<a name=\"Vost4\"></a>\n\n### é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜\n\né€šè¿‡ä¸Šé¢çš„ä¸€äººä¸€å•é™åˆ¶ï¼Œè§£å†³äº†åœ¨å•å°tomcatæœåŠ¡å™¨ä¸Šçš„å¹¶å‘é—®é¢˜ï¼Œä½†æ˜¯å½“æˆ‘ä»¬å¯¹tomcatè¿›è¡Œé›†ç¾¤éƒ¨ç½²æ—¶ï¼Œåˆä¼šå‡ºç°å¹¶å‘å®‰å…¨é—®é¢˜ï¼š\n\n- jvm1ä¸­çš„çº¿ç¨‹1è·å–é”æˆåŠŸ\n- jvm1ä¸­çš„çº¿ç¨‹2è·å–é”å¤±è´¥ï¼ˆå•å°tomcatå¹¶å‘é—®é¢˜æˆåŠŸæŠ—ä½ï¼‰\n- jvm2ä¸­çš„çº¿ç¨‹1è·å–é”æˆåŠŸï¼ˆ**æ­¤æ—¶å‡ºç°äº†é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘å®‰å…¨é—®é¢˜**ï¼‰\n- jvm2ä¸­çš„çº¿ç¨‹2è·å–é”å¤±è´¥\n\n![30.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_b6883d1c27-30.png) <br />é‚£ä¹ˆï¼Œä¸Šé¢è¿™ä¸ªæ£˜æ‰‹çš„å¹¶å‘å®‰å…¨é—®é¢˜è¯¥å¦‚ä½•è§£å†³å‘¢ï¼Ÿ<br />**_è¿™æ—¶å€™ï¼Œå°±è¯¥åˆ†å¸ƒå¼é”ç™»åœºäº†ï¼_**\n<a name=\"CUL1F\"></a>\n\n## åˆ†å¸ƒå¼é”\n\n<a name=\"kitAt\"></a>\n\n### åˆ†å¸ƒå¼é”çš„åŸºæœ¬åŸç†\n\n**åˆ†å¸ƒå¼é”ï¼š**æ»¡è¶³åˆ†å¸ƒå¼ç³»ç»Ÿæˆ–é›†ç¾¤æ¨¡å¼ä¸‹å¤šçº¿ç¨‹å¯è§å¹¶ä¸”å¯ä»¥äº’æ–¥çš„é”ã€‚<br />åˆ†å¸ƒå¼é”çš„**æ ¸å¿ƒæ€æƒ³**å°±æ˜¯è®©å¤§å®¶å…±ç”¨åŒä¸€æŠŠé”ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±èƒ½é”ä½çº¿ç¨‹ï¼Œä¸è®©çº¿ç¨‹è¿›è¡Œï¼Œè®©ç¨‹åºä¸²è¡Œæ‰§è¡Œï¼Œè¿™å°±æ˜¯åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒæ€è·¯ã€‚<br />![31.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_bc35e46a27-31.png) <br />**åˆ†å¸ƒå¼é”åº”å½“æ»¡è¶³å¦‚ä¸‹æ¡ä»¶ï¼š**\n\n- å¯è§æ€§ï¼šå¤šä¸ªçº¿ç¨‹éƒ½èƒ½çœ‹åˆ°ç›¸åŒçš„ç»“æœ\n\n> æ³¨æ„ï¼šè¿™é‡Œè¯´çš„å¯è§æ€§å¹¶ä¸æ˜¯å¹¶å‘ç¼–ç¨‹ä¸­æŒ‡çš„å†…å­˜å¯è§æ€§ï¼Œåªæ˜¯è¯´å¤šä¸ªè¿›ç¨‹ä¹‹é—´éƒ½èƒ½æ„ŸçŸ¥åˆ°å˜åŒ–çš„æ„æ€\n\n- äº’æ–¥ï¼šäº’æ–¥æ˜¯åˆ†å¸ƒå¼é”çš„æœ€åŸºæœ¬æ¡ä»¶ï¼Œä½¿å¾—ç¨‹åºä¸²è¡Œæ‰§è¡Œ\n- é«˜å¯ç”¨ï¼šç¨‹åºä¸æ˜“å´©æºƒï¼Œæ—¶æ—¶åˆ»åˆ»éƒ½ä¿è¯è¾ƒé«˜çš„å¯ç”¨æ€§\n- é«˜æ€§èƒ½ï¼šç”±äºåŠ é”æœ¬èº«å°±è®©æ€§èƒ½é™ä½ï¼Œæ‰€ä»¥å¯¹äºåˆ†å¸ƒå¼é”éœ€è¦ä»–è¾ƒé«˜çš„åŠ é”æ€§èƒ½å’Œé‡Šæ”¾é”æ€§èƒ½\n- å®‰å…¨æ€§ï¼šå®‰å…¨ä¹Ÿæ˜¯ç¨‹åºä¸­å¿…ä¸å¯å°‘çš„ä¸€ç¯\n\n**å¸¸è§çš„åˆ†å¸ƒå¼é”çš„å®ç°ï¼š**\n\n- MySQLï¼šMySQLæœ¬èº«å°±å¸¦æœ‰é”æœºåˆ¶ï¼Œä½†æ˜¯ç”±äºMySQLçš„æ€§èƒ½ä¸€èˆ¬ï¼Œæ‰€ä»¥é‡‡ç”¨åˆ†å¸ƒå¼é”çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨MySQLä½œä¸ºåˆ†å¸ƒå¼é”æ¯”è¾ƒå°‘è§\n- Redisï¼šRedisä½œä¸ºåˆ†å¸ƒå¼é”æ˜¯éå¸¸å¸¸è§çš„ä¸€ç§ä½¿ç”¨æ–¹å¼ï¼Œç°åœ¨ä¼ä¸šçº§å¼€å‘ä¸­åŸºæœ¬éƒ½æ˜¯ç”¨Redisæˆ–è€…Zookeeperä½œä¸ºåˆ†å¸ƒå¼é”ï¼Œåˆ©ç”¨`SETNX`è¿™ä¸ªæ–¹æ³•ï¼Œå¦‚æœæ’å…¥KeyæˆåŠŸï¼Œåˆ™è¡¨ç¤ºè·å¾—åˆ°äº†é”ï¼Œå¦‚æœæœ‰äººæ’å…¥æˆåŠŸï¼Œé‚£ä¹ˆå…¶ä»–äººå°±ä¼šæ’å…¥å¤±è´¥ï¼Œæ— æ³•è·å–åˆ°é”ï¼Œåˆ©ç”¨è¿™å¥—é€»è¾‘å®Œæˆ`äº’æ–¥`ï¼Œä»è€Œå®ç°åˆ†å¸ƒå¼é”\n- Zookeeperï¼šå…¶å®Zookeeperä¹Ÿæ˜¯ä¼ä¸šçº§å¼€å‘ä¸­è¾ƒå¥½çš„ä¸€ç§å®ç°åˆ†å¸ƒå¼é”çš„æ–¹æ¡ˆï¼Œæœ¬æ–‡ä¸»è¦è®²è§£Redisçš„å®ç°\n\n![32.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_bfd27eef27-32.png)\n<a name=\"DmVJH\"></a>\n\n### Redisåˆ†å¸ƒå¼é”å®ç°çš„æ ¸å¿ƒæ€è·¯\n\nå®ç°åˆ†å¸ƒå¼é”æ—¶éœ€è¦å®ç°ä¸¤ä¸ªåŸºæœ¬æ–¹æ³•\n\n- è·å–é”\n    - äº’æ–¥ï¼šç¡®ä¿åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è·å–é”\n    - éé˜»å¡ï¼šå°è¯•ä¸€æ¬¡ï¼ŒæˆåŠŸè¿”å›trueï¼Œå¤±è´¥è¿”å›false\n- é‡Šæ”¾é”\n    - æ‰‹åŠ¨é‡Šæ”¾\n    - è¶…æ—¶é‡Šæ”¾ï¼šè·å–é”çš„æ—¶å€™æ·»åŠ ä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼ˆä½œä¸ºå…œåº•ï¼‰\n\n**æ ¸å¿ƒæ€è·¯**ï¼šæˆ‘ä»¬åˆ©ç”¨redisçš„`SETNX`æ–¹æ³•ï¼Œå½“æœ‰å¤šä¸ªçº¿ç¨‹è¿›å…¥æ—¶ï¼Œæˆ‘ä»¬å°±åˆ©ç”¨è¯¥æ–¹æ³•æ¥è·å–é”ã€‚ç¬¬ä¸€ä¸ªçº¿ç¨‹è¿›å…¥æ—¶ï¼Œredis ä¸­å°±æœ‰è¿™ä¸ªkeyäº†ï¼Œè¿”å›äº†1ï¼Œå¦‚æœç»“æœæ˜¯1ï¼Œåˆ™è¡¨ç¤ºä»–æŠ¢åˆ°äº†é”ï¼Œé‚£ä¹ˆä»–å»æ‰§è¡Œä¸šåŠ¡ï¼Œç„¶åå†åˆ é™¤é”ï¼Œé€€å‡ºé”é€»è¾‘ã€‚æ²¡æœ‰æŠ¢åˆ°é”ï¼ˆè¿”å›äº†0ï¼‰çš„çº¿ç¨‹ï¼Œç­‰å¾…ä¸€å®šæ—¶é—´åé‡è¯•å³å¯ï¼ˆå¯¹äºå½“å‰ä¸šåŠ¡ï¼Œè¯´æ˜ç”¨æˆ·çš„å½“å‰æ“ä½œä¸åˆæ³•ï¼Œç›´æ¥è¿”å›å¤±è´¥å³å¯ï¼‰ã€‚<br />![33.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_c69db1e427-33.png)\n<a name=\"DaZYf\"></a>\n\n### å®ç°åˆ†å¸ƒå¼é”\n\n<a name=\"F4Mxk\"></a>\n\n#### åˆ›å»ºé”çš„åŸºæœ¬æ¥å£\n\n```java\npublic interface ILock {\n    /**\n     * å°è¯•è·å–é”\n     *\n     * @param timeoutSec é”æŒæœ‰çš„è¶…æ—¶æ—¶é—´ï¼Œè¿‡æœŸè‡ªåŠ¨é‡Šæ”¾\n     * @return trueè¡¨ç¤ºè·å–é”æˆåŠŸï¼Œfalseè¡¨ç¤ºè·å–é”å¤±è´¥\n     */\n    boolean tryLock(long timeoutSec);\n\n    /**\n     * é‡Šæ”¾é”\n     */\n    void unlock();\n}\n```\n\n<a name=\"Ly616\"></a>\n\n#### å®ç°é”çš„åŸºæœ¬æ¥å£\n\n```java\npublic class SimpleRedisLock implements ILock {\n    // é”çš„å‰ç¼€\n    private static final String KEY_PREFIX = \"lock:\";\n    // å…·ä½“ä¸šåŠ¡åç§°ï¼Œå°†å‰ç¼€å’Œä¸šåŠ¡åæ‹¼æ¥ä¹‹åå½“åšKey\n    private String name;\n    // è¿™é‡Œä¸æ˜¯@Autowiredæ³¨å…¥ï¼Œé‡‡ç”¨çš„æ˜¯æ„é€ å™¨æ³¨å…¥ï¼Œåœ¨åˆ›å»ºSimpleRedisLockæ—¶ï¼Œå°†RedisTemplateä½œä¸ºå‚æ•°ä¼ å…¥\n    private StringRedisTemplate stringRedisTemplate;\n\n    public SimpleRedisLock(String name, StringRedisTemplate stringRedisTemplate) {\n        this.name = name;\n        this.stringRedisTemplate = stringRedisTemplate;\n    }\n\n    @Override\n    public boolean tryLock(long timeoutSec) {\n        // è·å–çº¿ç¨‹æ ‡è¯†\n        long threadId = Thread.currentThread().getId();\n        // è·å–é”ï¼Œä½¿ç”¨SETNXæ–¹æ³•è¿›è¡ŒåŠ é”ï¼ŒåŒæ—¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢æ­»é”\n        Boolean success = stringRedisTemplate.opsForValue().setIfAbsent(KEY_PREFIX + name, threadId + \"\", timeoutSec, TimeUnit.SECONDS);\n        // è‡ªåŠ¨æ‹†ç®±å¯èƒ½ä¼šå¯¼è‡´NPEé—®é¢˜ï¼Œè¿™æ ·å†™æ›´ç¨³å¦¥\n        return Boolean.TRUE.equals(success);\n    }\n\n    @Override\n    public void unlock() {\n        // é€šè¿‡DELæ¥åˆ é™¤é”\n        stringRedisTemplate.delete(KEY_PREFIX + name);\n    }\n}\n```\n\n<a name=\"kEcW7\"></a>\n\n#### åŸºäºåˆ†å¸ƒå¼é”ä¿®æ”¹ç§’æ€ä¸šåŠ¡\n\n```java\n@Override\npublic Result seckillVoucher(Long voucherId) {\n    LambdaQueryWrapper<SeckillVoucher> queryWrapper = new LambdaQueryWrapper<>();\n    // 1. æŸ¥è¯¢ä¼˜æƒ åˆ¸\n    queryWrapper.eq(SeckillVoucher::getVoucherId, voucherId);\n    SeckillVoucher seckillVoucher = seckillVoucherService.getOne(queryWrapper);\n    // 2. åˆ¤æ–­ç§’æ€æ—¶é—´æ˜¯å¦å¼€å§‹\n    if (LocalDateTime.now().isBefore(seckillVoucher.getBeginTime())) {\n        return Result.fail(\"ç§’æ€è¿˜æœªå¼€å§‹ï¼Œè¯·è€å¿ƒç­‰å¾…\");\n    }\n    // 3. åˆ¤æ–­ç§’æ€æ—¶é—´æ˜¯å¦ç»“æŸ\n    if (LocalDateTime.now().isAfter(seckillVoucher.getEndTime())) {\n        return Result.fail(\"ç§’æ€å·²ç»ç»“æŸï¼\");\n    }\n    // 4. åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³\n    if (seckillVoucher.getStock() < 1) {\n        return Result.fail(\"ä¼˜æƒ åˆ¸å·²è¢«æŠ¢å…‰äº†å“¦ï¼Œä¸‹æ¬¡è®°å¾—æ‰‹é€Ÿå¿«ç‚¹\");\n    }\n    Long userId = UserHolder.getUser().getId();\n    // åˆ›å»ºé”å¯¹è±¡\n    SimpleRedisLock redisLock = new SimpleRedisLock(\"order:\" + userId, stringRedisTemplate);\n    // è·å–é”å¯¹è±¡\n    boolean isLock = redisLock.tryLock(30);\n    // åŠ é”å¤±è´¥ï¼Œè¯´æ˜å½“å‰ç”¨æˆ·å¼€äº†å¤šä¸ªçº¿ç¨‹æŠ¢ä¼˜æƒ åˆ¸ï¼Œä½†æ˜¯ç”±äºkeyæ˜¯SETNXçš„ï¼Œæ‰€ä»¥ä¸èƒ½åˆ›å»ºkeyï¼Œå¾—ç­‰keyçš„TTLåˆ°æœŸæˆ–é‡Šæ”¾é”ï¼ˆåˆ é™¤keyï¼‰\n    if (!isLock) {\n        return Result.fail(\"ä½ å·²ç»æŠ¢è¿‡ä¸€å¼ å•¦ï¼Œç•™ç»™åˆ«äººå§ï¼\");\n    }\n    try {\n        IVoucherOrderService proxy = (IVoucherOrderService) AopContext.currentProxy();\n        return proxy.createVoucherOrder(voucherId);\n    } finally {\n        // é‡Šæ”¾é”\n        redisLock.unlock();\n    }\n}\n```\n\n<a name=\"CHbb8\"></a>\n\n### Redisåˆ†å¸ƒå¼é”é”™è¯¯é‡Šæ”¾é—®é¢˜\n\n<a name=\"zmUUX\"></a>\n\n#### Redisåˆ†å¸ƒå¼é”çš„é”™è¯¯é‡Šæ”¾é—®é¢˜\n\næŒæœ‰é”çš„çº¿ç¨‹åœ¨é”çš„å†…éƒ¨å‡ºç°äº†é˜»å¡ï¼Œå¯¼è‡´ä»–çš„é”è‡ªåŠ¨é‡Šæ”¾ï¼Œè¿™æ—¶å…¶ä»–çº¿ç¨‹ï¼Œçº¿ç¨‹2æ¥å°è¯•è·å¾—é”ï¼Œå°±æ‹¿åˆ°äº†è¿™æŠŠé”ï¼Œç„¶åçº¿ç¨‹2åœ¨æŒæœ‰é”æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œçº¿ç¨‹1ååº”è¿‡æ¥ï¼Œç»§ç»­æ‰§è¡Œï¼Œè€Œçº¿ç¨‹1æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œèµ°åˆ°äº†åˆ é™¤é”é€»è¾‘ï¼Œæ­¤æ—¶å°±ä¼šæŠŠæœ¬åº”è¯¥å±äºçº¿ç¨‹2çš„é”è¿›è¡Œåˆ é™¤ã€‚<br />![34.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_cbd1000527-34.png)\n<a name=\"Ak2Q5\"></a>\n\n#### Redisåˆ†å¸ƒå¼é”çš„é”™è¯¯é‡Šæ”¾é—®é¢˜è§£å†³æ–¹æ¡ˆ\n\nè§£å†³æ–¹æ¡ˆå°±æ˜¯åœ¨æ¯ä¸ªçº¿ç¨‹é‡Šæ”¾é”çš„æ—¶å€™ï¼Œéƒ½åˆ¤æ–­ä¸€ä¸‹è¿™ä¸ªé”æ˜¯ä¸æ˜¯è‡ªå·±çš„ï¼Œå¦‚æœä¸å±äºè‡ªå·±ï¼Œåˆ™ä¸è¿›è¡Œåˆ é™¤æ“ä½œã€‚<br />![35.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_d01613d827-35.png)\n<a name=\"Cajwm\"></a>\n\n#### è§£å†³åé‡æ–°æ¨¡æ‹Ÿé”™è¯¯é‡Šæ”¾é—®é¢˜\n\nå‡è®¾è¿˜æ˜¯ä¸Šé¢çš„æƒ…å†µï¼Œçº¿ç¨‹1é˜»å¡ï¼Œé”è‡ªåŠ¨é‡Šæ”¾ï¼Œçº¿ç¨‹2è¿›å…¥åˆ°é”çš„å†…éƒ¨æ‰§è¡Œé€»è¾‘ï¼Œæ­¤æ—¶çº¿ç¨‹1é˜»å¡å®Œäº†ï¼Œç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œå¼€å§‹åˆ é™¤é”ï¼Œä½†æ˜¯çº¿ç¨‹1å‘ç°è¿™æŠŠé”ä¸æ˜¯è‡ªå·±çš„ï¼Œæ‰€ä»¥ä¸è¿›è¡Œåˆ é™¤é”çš„é€»è¾‘ï¼Œå½“çº¿ç¨‹2æ‰§è¡Œåˆ°åˆ é™¤é”çš„é€»è¾‘æ—¶ï¼Œå¦‚æœTTLè¿˜æœªåˆ°æœŸï¼Œåˆ™åˆ¤æ–­å½“å‰è¿™æŠŠé”æ˜¯è‡ªå·±çš„ï¼Œäºæ˜¯åˆ é™¤è¿™æŠŠé”ã€‚<br />![36.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_d414f28827-36.png)\n<a name=\"qimR5\"></a>\n\n#### è§£å†³Redisåˆ†å¸ƒå¼é”è¯¯åˆ é—®é¢˜ä»£ç å®ç°\n\n```java\n// åŠ é”\nprivate static final String ID_PREFIX = UUID.randomUUID().toString(true) + \"-\";\n@Override\npublic boolean tryLock(long timeoutSec) {\n   // è·å–çº¿ç¨‹æ ‡ç¤º\n   String threadId = ID_PREFIX + Thread.currentThread().getId();\n   // è·å–é”\n   Boolean success = stringRedisTemplate.opsForValue()\n                .setIfAbsent(KEY_PREFIX + name, threadId, timeoutSec, TimeUnit.SECONDS);\n   return Boolean.TRUE.equals(success);\n}\n\n// é‡Šæ”¾é”\npublic void unlock() {\n    // è·å–çº¿ç¨‹æ ‡ç¤º\n    String threadId = ID_PREFIX + Thread.currentThread().getId();\n    // è·å–é”ä¸­çš„æ ‡ç¤º\n    String id = stringRedisTemplate.opsForValue().get(KEY_PREFIX + name);\n    // åˆ¤æ–­æ ‡ç¤ºæ˜¯å¦ä¸€è‡´\n    if(threadId.equals(id)) {\n        // é‡Šæ”¾é”\n        stringRedisTemplate.delete(KEY_PREFIX + name);\n    }\n}\n```\n\n<a name=\"vagru\"></a>\n\n### åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜\n\n<a name=\"g6zRK\"></a>\n\n#### ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜\n\næ‰€è°“åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜ï¼Œå°±æ˜¯åœ¨ä¸Šé¢çš„è¯¯åˆ é—®é¢˜çš„åŸºç¡€ä¸Šï¼Œå³ä½¿åˆ¤æ–­äº†æ˜¯è‡ªå·±çš„çº¿ç¨‹æ ‡è¯†ï¼Œä½†æ˜¯ç”±äºåˆ¤æ–­å’Œé‡Šæ”¾é”çš„è¿™ä¸¤ä¸ªæ­¥éª¤å¹¶ä¸å…·æœ‰åŸå­æ€§ï¼Œåœ¨ä¸€äº›æç«¯æƒ…å†µï¼Œå¯èƒ½ä¼šåœ¨åˆ¤æ–­æˆåŠŸåï¼Œé˜»å¡ä½äº†ï¼Œç„¶åè¢«è¶…æ—¶é‡Šæ”¾ï¼Œç»“æœè¿™ä¸ªé”è¢«å…¶ä»–çš„çº¿ç¨‹è·å–ï¼Œè¿™æ—¶é˜»å¡ä½çš„çº¿ç¨‹æ¢å¤åç›´æ¥è¿›è¡Œäº†é”çš„é‡Šæ”¾ï¼Œåˆå¯¼è‡´äº†è¯¯åˆ é—®é¢˜ã€‚\n<a name=\"vmx7z\"></a>\n\n#### åˆ©ç”¨Luaè„šæœ¬è§£å†³åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜\n\n**Luaè„šæœ¬ï¼š**\n\n- Redisæä¾›äº†Luaè„šæœ¬åŠŸèƒ½ï¼Œåœ¨ä¸€ä¸ªè„šæœ¬ä¸­ç¼–å†™å¤šæ¡Rediså‘½ä»¤ï¼Œç¡®ä¿å¤šæ¡å‘½ä»¤æ‰§è¡Œæ—¶çš„åŸå­æ€§\n- Luaæ˜¯ä¸€ç§ç¼–ç¨‹è¯­è¨€ï¼Œå…¶åŸºæœ¬è¯­æ³•å¯åœ¨[èœé¸Ÿæ•™ç¨‹](https://www.runoob.com/lua/lua-tutorial.html)æŸ¥çœ‹\n- è¿™é‡Œé‡ç‚¹ä»‹ç»Redisæä¾›çš„è°ƒç”¨å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Luaå»æ“ä½œRedisï¼Œè€Œä¸”è¿˜èƒ½ä¿è¯å®ƒçš„åŸå­æ€§ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°æ‹¿é”ï¼Œåˆ¤æ–­æ ‡è¯†ï¼Œåˆ é”æ˜¯ä¸€ä¸ªåŸå­æ€§åŠ¨ä½œäº†\n\n**Redisè°ƒç”¨Luaè„šæœ¬ï¼š**\n\n- Luaè„šæœ¬æ ¼å¼\n\n```lua\nredis.call('å‘½ä»¤åç§°', 'key', 'å…¶å®ƒå‚æ•°', ...)\n```\n\n- ç¤ºä¾‹\n\n```lua\n-- å…ˆæ‰§è¡Œ set name jack\nredis.call('set', 'name', 'Rose')\n-- å†æ‰§è¡Œ get name\nlocal name = redis.call('get', 'name')\n-- è¿”å›\nreturn name\n```\n\n- Redisè°ƒç”¨Luaè„šæœ¬\n\n![37.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_d982af8327-37.png) <br />**Luaè„šæœ¬å®ç°åˆ¤æ–­æ ‡è¯†ä¸é‡Šæ”¾é”ï¼š**\n\n```lua\n-- è¿™é‡Œçš„KEYS[1]å°±æ˜¯ä¼ å…¥é”çš„key\n-- è¿™é‡Œçš„ARGV[1]å°±æ˜¯çº¿ç¨‹æ ‡è¯†\n-- æ¯”è¾ƒé”ä¸­çš„çº¿ç¨‹æ ‡è¯†ä¸çº¿ç¨‹æ ‡è¯†æ˜¯å¦ä¸€è‡´\nif (redis.call('get', KEYS[1]) == ARGV[1]) then\n    -- ä¸€è‡´åˆ™é‡Šæ”¾é”\n    return redis.call('del', KEYS[1])\nend\nreturn 0\n```\n\n<a name=\"o30fA\"></a>\n\n#### åˆ©ç”¨Javaè°ƒç”¨Luaè„šæœ¬è§£å†³åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜\n\nåœ¨RedisTemplateä¸­ï¼Œå¯ä»¥åˆ©ç”¨`excute`æ–¹æ³•æ‰§è¡Œ`Lua`è„šæœ¬\n\n```java\npublic <T> T execute(RedisScript<T> script, List<K> keys, Object... args) {\n    return this.scriptExecutor.execute(script, keys, args);\n}\n```\n\n**ä»£ç å®ç°ï¼š**\n\n```java\nprivate static final DefaultRedisScript<Long> UNLOCK_SCRIPT;\n\nstatic {\n    UNLOCK_SCRIPT = new DefaultRedisScript();\n    UNLOCK_SCRIPT.setLocation(new ClassPathResource(\"unlock.lua\"));\n    UNLOCK_SCRIPT.setResultType(Long.class);\n}\n\n@Override\npublic void unlock() {\n    stringRedisTemplate.execute(UNLOCK_SCRIPT,\n            Collections.singletonList(KEY_PREFIX + name),\n            ID_PREFIX + Thread.currentThread().getId());\n}\n```\n\n<a name=\"wHOSL\"></a>\n\n### åŸºäºRediså®ç°åˆ†å¸ƒå¼é”çš„ä¸è¶³\n\nåŸºäºRedisä¸­çš„`setnx`å‘½ä»¤å®ç°åˆ†å¸ƒå¼é”å…·æœ‰ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š<br />![38.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_de66d9e027-38.png) <br />å¦‚æœæ²¡æœ‰ä»¥ä¸Šå‡ ç§éœ€æ±‚ï¼ŒåŸºäºRediså®ç°çš„åˆ†å¸ƒå¼é”æ˜¯å®Œå…¨æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯ï¼Œå¦‚æœä¸šåŠ¡ä¸­çš„ç¡®æœ‰ä»¥ä¸Šéœ€æ±‚ï¼Œé‚£ä¹ˆè¯¥æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ<br />**_äºæ˜¯ï¼Œå¼ºå¤§çš„Redissonè¯ç”Ÿäº†ï¼_**<br />åœ¨ä»¥åéœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼é”çš„æ—¶å€™ï¼Œç›´æ¥ä½¿ç”¨Redissonçš„åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆå³å¯ã€‚\n<a name=\"LKg9j\"></a>\n\n## åˆ†å¸ƒå¼é”-Redisson\n\n<a name=\"zszOv\"></a>\n\n### RedissonåŸºç¡€\n\nRedissonæ˜¯ä¸€ä¸ªåœ¨Redisçš„åŸºç¡€ä¸Šå®ç°çš„Javaé©»å†…å­˜æ•°æ®ç½‘æ ¼(In-Memory Data Grid)ã€‚å®ƒä¸ä»…æä¾›äº†ä¸€ç³»åˆ—çš„åˆ†å¸ƒå¼Javaå¸¸ç”¨å¯¹è±¡ï¼Œè¿˜æä¾›äº†è®¸å¤šåˆ†å¸ƒå¼æœåŠ¡ï¼Œå…¶ä¸­å°±åŒ…å«äº†å„ç§åˆ†å¸ƒå¼é”çš„å®ç°ã€‚<br />**Redissonå®ç°äº†åˆ†å¸ƒå¼é”çš„å„ç§åŠŸèƒ½ï¼š**\n\n- å¯é‡å…¥é”(Reentrant Lock)\n- å…¬å¹³é”(Fair Lock)\n- è”é”(MultiLock)\n- çº¢é”(RedLock)\n- è¯»å†™é”(ReadWriteLock)\n- ä¿¡å·é‡(Semaphore)\n- å¯è¿‡æœŸæ€§ä¿¡å·é‡(PermitExpirableSemaphore)\n- é—­é”(CountDownLatch)\n  <a name=\"HwSXo\"></a>\n\n### é¡¹ç›®å¼•å…¥Redisson\n\n- å¼•å…¥ä¾èµ–\n\n```xml\n<dependency>\n    <groupId>org.redisson</groupId>\n    <artifactId>redisson</artifactId>\n    <version>3.13.6</version>\n</dependency>\n```\n\n- é…ç½®`RedissonConfig`ç±»\n\n```java\nimport org.redisson.Redisson;\nimport org.redisson.api.RedissonClient;\nimport org.redisson.config.Config;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\n\n@Configuration\npublic class RedissonConfig {\n    @Bean\n    public RedissonClient redissonClient() {\n        Config config = new Config();\n        config.useSingleServer()\n            .setAddress(\"redis:// 127.0.0.1:6379\")\n            .setPassword(\"123456\");\n        return Redisson.create(config);\n    }\n}\n```\n\n- ä½¿ç”¨Redissonçš„åˆ†å¸ƒå¼é”ä¿®æ”¹ç§’æ€ä¸šåŠ¡\n\n```java\n@Resource\nprivate RedissonClient redissonClient;\n@Override\npublic Result seckillVoucher(Long voucherId) {\n    LambdaQueryWrapper<SeckillVoucher> queryWrapper = new LambdaQueryWrapper<>();\n    // 1. æŸ¥è¯¢ä¼˜æƒ åˆ¸\n    queryWrapper.eq(SeckillVoucher::getVoucherId, voucherId);\n    SeckillVoucher seckillVoucher = seckillVoucherService.getOne(queryWrapper);\n    // 2. åˆ¤æ–­ç§’æ€æ—¶é—´æ˜¯å¦å¼€å§‹\n    if (LocalDateTime.now().isBefore(seckillVoucher.getBeginTime())) {\n        return Result.fail(\"ç§’æ€è¿˜æœªå¼€å§‹ï¼Œè¯·è€å¿ƒç­‰å¾…\");\n    }\n    // 3. åˆ¤æ–­ç§’æ€æ—¶é—´æ˜¯å¦ç»“æŸ\n    if (LocalDateTime.now().isAfter(seckillVoucher.getEndTime())) {\n        return Result.fail(\"ç§’æ€å·²ç»ç»“æŸï¼\");\n    }\n    // 4. åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³\n    if (seckillVoucher.getStock() < 1) {\n        return Result.fail(\"ä¼˜æƒ åˆ¸å·²è¢«æŠ¢å…‰äº†å“¦ï¼Œä¸‹æ¬¡è®°å¾—æ‰‹é€Ÿå¿«ç‚¹\");\n    }\n    Long userId = UserHolder.getUser().getId();\n    RLock redisLock = redissonClient.getLock(\"order:\" + userId);\n    boolean isLock = redisLock.tryLock();\n    if (!isLock) {\n        return Result.fail(\"ä¸å…è®¸æŠ¢å¤šå¼ ä¼˜æƒ åˆ¸\");\n    }\n    try {\n        IVoucherOrderService proxy = (IVoucherOrderService) AopContext.currentProxy();\n        return proxy.createVoucherOrder(voucherId);\n    } finally {\n        redisLock.unlock();\n    }\n}\n```\n\n<a name=\"BOYTV\"></a>\n\n### Redissonå®ç°å¯é‡å…¥é”åŸç†\n\nå‚è€ƒJDKå®ç°é”çš„åŸç†ï¼ŒRedissonå®ç°å¯é‡å…¥ä¹Ÿæ˜¯åŸºäºè®¡æ•°æœºåˆ¶ï¼Œå³æœ‰äººè·å–å½“å‰é”æ—¶ï¼Œ`count = 1`ï¼Œå†æ¬¡è·å–è¯¥é”æ—¶ï¼Œ`count ++`ï¼Œå½“é‡Šæ”¾è¯¥é”æ—¶ï¼Œ`count --`ï¼Œç›´åˆ°`count == 0`æ—¶è¡¨ç¤ºå½“å‰é”æœªè¢«æŒæœ‰ã€‚\n\n> èƒ½å†æ¬¡è·å–é”çš„å¿…è¦æ¡ä»¶æ˜¯å¤„äºåŒä¸€çº¿ç¨‹ã€‚\n\nRedissonå®ç°è®¡æ•°æœºåˆ¶ä½¿ç”¨çš„æ˜¯Redisçš„Hashç»“æ„ï¼Œç”¨å¤–å±‚çš„â€œå¤§â€keyè¡¨ç¤ºå½“å‰é”æ˜¯å¦è¢«æŒæœ‰ï¼Œç”¨Hashç»“æ„çš„â€œå°â€Keyæ¥è®°å½•è¢«å“ªä¸ªçº¿ç¨‹æŒæœ‰ã€‚<br />![39.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_e089985f27-39.png) <br />**å°è¯•è‡ªå·±å®ç°è·å–é”å’Œé‡Šæ”¾é”ï¼š**\n\n> ç”±äºéœ€è¦ä¿è¯åŸå­æ€§ï¼Œæ‰€ä»¥ä¹Ÿéœ€è¦ä½¿ç”¨Luaå®ç°ã€‚\n\n- è·å–é”\n\n```lua\nlocal key = KEYS[1]; -- é”çš„key\nlocal threadId = ARGV[1]; -- çº¿ç¨‹å”¯ä¸€æ ‡è¯†\nlocal releaseTime = ARGV[2]; -- é”çš„è‡ªåŠ¨é‡Šæ”¾æ—¶é—´\n-- é”ä¸å­˜åœ¨\nif (redis.call('exists', key) == 0) then\n    -- è·å–é”å¹¶æ·»åŠ çº¿ç¨‹æ ‡è¯†ï¼Œstateè®¾ä¸º1\n    redis.call('hset', key, threadId, '1');\n    -- è®¾ç½®é”æœ‰æ•ˆæœŸ\n    redis.call('expire', key, releaseTime);\n    return 1; -- è¿”å›ç»“æœ\nend;\n-- é”å­˜åœ¨ï¼Œåˆ¤æ–­threadIdæ˜¯å¦ä¸ºè‡ªå·±\nif (redis.call('hexists', key, threadId) == 1) then\n    -- é”å­˜åœ¨ï¼Œé‡å…¥æ¬¡æ•° +1ï¼Œè¿™é‡Œç”¨çš„æ˜¯hashç»“æ„çš„incrbyå¢é•¿\n    redis.call('hincrby', key, thread, 1);\n    -- è®¾ç½®é”çš„æœ‰æ•ˆæœŸ\n    redis.call('expire', key, releaseTime);\n    return 1; -- è¿”å›ç»“æœ\nend;\nreturn 0; -- ä»£ç èµ°åˆ°è¿™é‡Œï¼Œè¯´æ˜è·å–é”çš„ä¸æ˜¯è‡ªå·±ï¼Œè·å–é”å¤±è´¥\n```\n\n- é‡Šæ”¾é”\n\n```lua\nlocal key = KEYS[1];\nlocal threadId = ARGV[1];\nlocal releaseTime = ARGV[2];\n-- å¦‚æœé”ä¸æ˜¯è‡ªå·±çš„\nif (redis.call('HEXISTS', key, threadId) == 0) then\n    return nil; -- ç›´æ¥è¿”å›\nend;\n-- é”æ˜¯è‡ªå·±çš„ï¼Œé”è®¡æ•°-1ï¼Œè¿˜æ˜¯ç”¨hincrbyï¼Œä¸è¿‡è‡ªå¢é•¿çš„å€¼ä¸º-1\nlocal count = redis.call('hincrby', key, threadId, -1);\n-- åˆ¤æ–­é‡å…¥æ¬¡æ•°ä¸ºå¤šå°‘\nif (count > 0) then\n    -- å¤§äº0ï¼Œé‡ç½®æœ‰æ•ˆæœŸ\n    redis.call('expire', key, releaseTime);\n    return nil;\nelse\n    -- å¦åˆ™ç›´æ¥é‡Šæ”¾é”\n    redis.call('del', key);\n    return nil;\nend;\n```\n\n**æŸ¥çœ‹Redissonå®ç°è·å–é”ä¸é‡Šæ”¾é”çš„æºç ï¼š**\n\n- è·å–é”\n\n```java\n<T> RFuture<T> tryLockInnerAsync(long waitTime, long leaseTime, TimeUnit unit, long threadId, RedisStrictCommand<T> command) {\n    this.internalLockLeaseTime = unit.toMillis(leaseTime);\n    return this.evalWriteAsync(this.getName(), LongCodec.INSTANCE, command, \n                                \"if (redis.call('exists', KEYS[1]) == 0) then \" +\n                                    \"redis.call('hincrby', KEYS[1], ARGV[2], 1); \" +\n                                    \"redis.call('pexpire', KEYS[1], ARGV[1]); \" +\n                                    \"return nil; \" +\n                                \"end; \" +\n                                \"if (redis.call('hexists', KEYS[1], ARGV[2]) == 1) then \" +\n                                    \"redis.call('hincrby', KEYS[1], ARGV[2], 1); \" +\n                                    \"redis.call('pexpire', KEYS[1], ARGV[1]); \" +\n                                    \"return nil; \" +\n                                 \"end; \" +\n                                \"return redis.call('pttl', KEYS[1]);\", \n                                Collections.singletonList(this.getName()), \n                                this.internalLockLeaseTime, \n                                this.getLockName(threadId));\n}\n```\n\n- é‡Šæ”¾é”\n\n```java\nprotected RFuture<Boolean> unlockInnerAsync(long threadId) {\n    return this.evalWriteAsync(this.getName(), LongCodec.INSTANCE, RedisCommands.EVAL_BOOLEAN, \n                                \"if (redis.call('hexists', KEYS[1], ARGV[3]) == 0) then \" +\n                                    \"return nil;\" +\n                                \"end; \" +\n                                \"local counter = redis.call('hincrby', KEYS[1], ARGV[3], -1); \" +\n                                \"if (counter > 0) then \" +\n                                    \"redis.call('pexpire', KEYS[1], ARGV[2]); \" +\n                                    \"return 0; \" +\n                                \"else \" +\n                                    \"redis.call('del', KEYS[1]); \" +\n                                    \"redis.call('publish', KEYS[2], ARGV[1]); return 1; \" +\n                                \"end; \" +\n                                \"return nil;\", \n                                Arrays.asList(this.getName(), \n                                this.getChannelName()), \n                                LockPubSub.UNLOCK_MESSAGE, \n                                this.internalLockLeaseTime, \n                                this.getLockName(threadId));\n}\n```\n\n> æˆ‘ä»¬å‘ç°ï¼Œæºç å®ç°å’Œæˆ‘ä»¬çš„é¢„æœŸå‡ ä¹ä¸€æ ·ã€‚\n\n<a name=\"BxTHZ\"></a>\n\n### Redissoné”é‡è¯•ä¸WatchDogæœºåˆ¶\n\né€šè¿‡å¯¹æºç çš„è§£è¯»ï¼Œæˆ‘ä»¬å‘ç°Redissoné”é‡è¯•çš„å®ç°å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br />![40.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_e4d195d827-40.png)\n<a name=\"PDMsd\"></a>\n\n### Redissonçš„MultiLocké”å®ç°åŸç†\n\n<a name=\"GdtjL\"></a>\n\n#### åŸç†åˆ†æ\n\nä¸ºäº†æé«˜redisçš„å¯ç”¨æ€§ï¼Œæˆ‘ä»¬ä¼šæ­å»ºé›†ç¾¤æˆ–è€…ä¸»ä»ï¼Œç°åœ¨ä»¥ä¸»ä»ä¸ºä¾‹ã€‚<br />æ­¤æ—¶æˆ‘ä»¬å»å†™å‘½ä»¤ï¼Œå†™åœ¨ä¸»æœºä¸Šï¼Œ ä¸»æœºä¼šå°†æ•°æ®åŒæ­¥ç»™ä»æœºï¼Œä½†æ˜¯å‡è®¾åœ¨ä¸»æœºè¿˜æ²¡æœ‰æ¥å¾—åŠæŠŠæ•°æ®å†™å…¥åˆ°ä»æœºå»çš„æ—¶å€™ï¼Œæ­¤æ—¶ä¸»æœºå®•æœºï¼Œå“¨å…µä¼šå‘ç°ä¸»æœºå®•æœºï¼Œå¹¶ä¸”é€‰ä¸¾ä¸€ä¸ªslaveå˜æˆmasterï¼Œè€Œæ­¤æ—¶æ–°çš„masterä¸­å®é™…ä¸Šå¹¶æ²¡æœ‰é”ä¿¡æ¯ï¼Œæ­¤æ—¶é”ä¿¡æ¯å°±å·²ç»ä¸¢æ‰äº†ã€‚<br />![41.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_eaf3f43a27-41.png)   <br />ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒRedissonæå‡ºæ¥äº†MutiLocké”ï¼Œä½¿ç”¨è¿™æŠŠé”å’±ä»¬å°±ä¸ä½¿ç”¨ä¸»ä»äº†ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„åœ°ä½éƒ½æ˜¯ä¸€æ ·çš„ï¼Œ è¿™æŠŠé”åŠ é”çš„é€»è¾‘éœ€è¦å†™å…¥åˆ°æ¯ä¸€ä¸ªä¸»ä»èŠ‚ç‚¹ä¸Šï¼Œåªæœ‰æ‰€æœ‰çš„æœåŠ¡å™¨éƒ½å†™å…¥æˆåŠŸï¼Œæ­¤æ—¶æ‰æ˜¯åŠ é”æˆåŠŸã€‚<br />å‡è®¾ç°åœ¨æŸä¸ªèŠ‚ç‚¹æŒ‚äº†ï¼Œé‚£ä¹ˆä»–å»è·å¾—é”çš„æ—¶å€™ï¼Œåªè¦æœ‰ä¸€ä¸ªèŠ‚ç‚¹æ‹¿ä¸åˆ°ï¼Œéƒ½ä¸èƒ½ç®—æ˜¯åŠ é”æˆåŠŸï¼Œå°±ä¿è¯äº†åŠ é”çš„å¯é æ€§ã€‚<br />![42.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_ef8ba45027-42.png) <br />**Redissonçš„MultiLocké”æºç åˆ†æå›¾ï¼š**<br />![43.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_f2916f4127-43.png)\n<a name=\"VCGh5\"></a>\n\n#### å®è·µ\n\n- ä½¿ç”¨è™šæ‹Ÿæœºé¢å¤–æ­å»ºä¸¤ä¸ªRedisèŠ‚ç‚¹ï¼Œç„¶åé‡æ–°é…ç½®`RedissonConfig`ç±»\n\n```java\n@Configuration\npublic class RedissonConfig {\n    @Bean\n    public RedissonClient redissonClient() {\n        Config config = new Config();\n        config.useSingleServer().setAddress(\"redis:// 192.168.137.130:6379\")\n                .setPassword(\"root\");\n        return Redisson.create(config);\n    }\n\n    @Bean\n    public RedissonClient redissonClient2() {\n        Config config = new Config();\n        config.useSingleServer().setAddress(\"redis:// 92.168.137.131:6379\")\n                .setPassword(\"root\");\n        return Redisson.create(config);\n    }\n\n    @Bean\n    public RedissonClient redissonClient3() {\n        Config config = new Config();\n        config.useSingleServer().setAddress(\"redis:// 92.168.137.132:6379\")\n                .setPassword(\"root\");\n        return Redisson.create(config);\n    }\n}\n```\n\n- è¦ä½¿ç”¨è”é”ï¼Œæˆ‘ä»¬éœ€è¦æ³¨å…¥ä¸‰ä¸ª`RedissonClient`å¯¹è±¡\n\n```java\n@Resource\nprivate RedissonClient redissonClient;\n@Resource\nprivate RedissonClient redissonClient2;\n@Resource\nprivate RedissonClient redissonClient3;\n\nprivate RLock lock;\n\n@BeforeEach\nvoid setUp() {\n    RLock lock1 = redissonClient.getLock(\"lock\");\n    RLock lock2 = redissonClient2.getLock(\"lock\");\n    RLock lock3 = redissonClient3.getLock(\"lock\");\n    lock = redissonClient.getMultiLock(lock1, lock2, lock3);\n}\n\n@Test\nvoid method1() {\n    boolean success = lock.tryLock();\n    redissonClient.getMultiLock();\n    if (!success) {\n        log.error(\"è·å–é”å¤±è´¥ï¼Œ1\");\n        return;\n    }\n    try {\n        log.info(\"è·å–é”æˆåŠŸ\");\n        method2();\n    } finally {\n        log.info(\"é‡Šæ”¾é”ï¼Œ1\");\n        lock.unlock();\n    }\n}\n\nvoid method2() {\n    RLock lock = redissonClient.getLock(\"lock\");\n    boolean success = lock.tryLock();\n    if (!success) {\n        log.error(\"è·å–é”å¤±è´¥ï¼Œ2\");\n        return;\n    }\n    try {\n        log.info(\"è·å–é”æˆåŠŸï¼Œ2\");\n    } finally {\n        log.info(\"é‡Šæ”¾é”ï¼Œ2\");\n        lock.unlock();\n    }\n}\n```\n\n<a name=\"F6pIl\"></a>\n\n### Redissonåˆ†å¸ƒå¼é”å°ç»“\n\n- ä¸å¯é‡å…¥Redisåˆ†å¸ƒå¼é”\n    - åŸç†ï¼šåˆ©ç”¨`SETNX`çš„äº’æ–¥æ€§ï¼›åˆ©ç”¨`EX`é¿å…æ­»é”ï¼›é‡Šæ”¾é”æ—¶åˆ¤æ–­çº¿ç¨‹æ ‡è¯†\n    - ç¼ºé™·ï¼šä¸å¯é‡å…¥ã€æ— æ³•é‡è¯•ã€é”è¶…æ—¶å¤±æ•ˆ\n- å¯é‡å…¥Redisåˆ†å¸ƒå¼é”\n    - åŸç†ï¼šåˆ©ç”¨Hashç»“æ„ï¼Œè®°å½•çº¿ç¨‹æ ‡è¯†ä¸é‡å…¥æ¬¡æ•°ï¼›åˆ©ç”¨WatchDogå»¶ç»­é”æ—¶é—´ï¼›åˆ©ç”¨ä¿¡å·é‡æ§åˆ¶é”é‡è¯•ç­‰å¾…\n    - ç¼ºé™·ï¼šRediså®•æœºå¼•èµ·é”å¤±æ•ˆé—®é¢˜\n- Redissonçš„multiLock\n    - åŸç†ï¼šå¤šä¸ªç‹¬ç«‹çš„RedisèŠ‚ç‚¹ï¼Œå¿…é¡»åœ¨æ‰€æœ‰èŠ‚ç‚¹éƒ½è·å–é‡å…¥é”ï¼Œæ‰ç®—è·å–é”æˆåŠŸ\n    - ç¼ºé™·ï¼šè¿ç»´æˆæœ¬é«˜ã€å®ç°è¾ƒä¸ºå¤æ‚\n      <a name=\"CAuyj\"></a>\n\n## ç§’æ€ä¼˜åŒ–\n\n<a name=\"BmOsK\"></a>\n\n### å¼‚æ­¥ç§’æ€æ€è·¯\n\næˆ‘ä»¬å…ˆæ¥å›é¡¾ä¸€ä¸‹ç§’æ€ä¸‹å•æµç¨‹ï¼š<br />å½“ç”¨æˆ·å‘èµ·è¯·æ±‚ï¼Œæ­¤æ—¶ä¼šå…ˆè¯·æ±‚Nginxï¼ŒNginxåå‘ä»£ç†åˆ°Tomcatï¼Œè€ŒTomcatä¸­çš„ç¨‹åºï¼Œä¼šè¿›è¡Œä¸²è¡Œæ“ä½œï¼Œåˆ†ä¸ºå¦‚ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š\n\n- æŸ¥è¯¢ä¼˜æƒ åˆ¸\n- åˆ¤æ–­ç§’æ€åº“å­˜æ˜¯å¦è¶³å¤Ÿ\n- æŸ¥è¯¢è®¢å•\n- æ ¡éªŒæ˜¯å¦ä¸€äººä¸€å•\n- æ‰£å‡åº“å­˜\n- åˆ›å»ºè®¢å•\n\n![44.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_f85e818027-44.png) <br />åœ¨è¿™å…­ä¸ªæ­¥éª¤ä¸­ï¼Œæœ‰å¾ˆå¤šæ“ä½œéƒ½æ˜¯è¦å»æ“ä½œæ•°æ®åº“çš„ï¼Œè€Œä¸”è¿˜æ˜¯ä¸€ä¸ªçº¿ç¨‹ä¸²è¡Œæ‰§è¡Œï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´æˆ‘ä»¬çš„ç¨‹åºæ‰§è¡Œå¾ˆæ…¢ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¼‚æ­¥ç¨‹åºæ‰§è¡Œï¼Œé‚£ä¹ˆå¦‚ä½•åŠ é€Ÿå‘¢ï¼Ÿ<br />**ä¼˜åŒ–æ–¹æ¡ˆï¼š** æˆ‘ä»¬å°†è€—æ—¶è¾ƒçŸ­çš„é€»è¾‘åˆ¤æ–­æ”¾åˆ°Redisä¸­ï¼Œä¾‹å¦‚ï¼šåº“å­˜æ˜¯å¦å……è¶³ï¼Œæ˜¯å¦ä¸€äººä¸€å•è¿™æ ·çš„æ“ä½œï¼Œåªè¦æ»¡è¶³è¿™ä¸¤æ¡æ“ä½œï¼Œé‚£æˆ‘ä»¬æ˜¯ä¸€å®šå¯ä»¥ä¸‹å•æˆåŠŸçš„ï¼Œä¸ç”¨ç­‰æ•°æ®çœŸçš„å†™è¿›æ•°æ®åº“ï¼Œæˆ‘ä»¬ç›´æ¥å‘Šè¯‰ç”¨æˆ·ä¸‹å•æˆåŠŸå°±å¥½äº†ã€‚ç„¶ååå°å†å¼€ä¸€ä¸ªçº¿ç¨‹ï¼Œåå°çº¿ç¨‹å†å»æ…¢æ…¢æ‰§è¡Œé˜Ÿåˆ—é‡Œçš„æ¶ˆæ¯ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½å¾ˆå¿«çš„å®Œæˆä¸‹å•ä¸šåŠ¡ã€‚<br />**ä½†æ˜¯è¿™é‡Œå­˜åœ¨ä¸¤ä¸ªéš¾ç‚¹ï¼š**\n\n- æˆ‘ä»¬æ€ä¹ˆåœ¨Redisä¸­å¿«é€Ÿæ ¡éªŒæ˜¯å¦ä¸€äººä¸€å•ï¼Œè¿˜æœ‰åº“å­˜åˆ¤æ–­\n- æˆ‘ä»¬æ ¡éªŒä¸€äººä¸€å•å’Œå°†ä¸‹å•æ•°æ®å†™å…¥æ•°æ®åº“ï¼Œè¿™æ˜¯ä¸¤ä¸ªçº¿ç¨‹ï¼Œæˆ‘ä»¬æ€ä¹ˆçŸ¥é“ä¸‹å•æ˜¯å¦å®Œæˆ\n\n**è§£å†³éš¾ç‚¹ï¼š** ä¸ºäº†å®Œæˆè¿™ä»¶äº‹æˆ‘ä»¬åœ¨redisæ“ä½œå®Œï¼ˆæ‰§è¡ŒLuaè„šæœ¬ä»¥ä¿è¯åŸå­æ€§ï¼‰ä¹‹åï¼Œæˆ‘ä»¬ä¼šå°†ä¸€äº›ä¿¡æ¯è¿”å›ç»™å‰ç«¯ï¼ŒåŒæ—¶ä¹Ÿä¼šæŠŠè¿™äº›ä¿¡æ¯ä¸¢åˆ°å¼‚æ­¥queueä¸­å»ï¼Œåç»­æ“ä½œä¸­ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªidæ¥æŸ¥è¯¢æˆ‘ä»¬tomcatä¸­çš„ä¸‹å•é€»è¾‘æ˜¯å¦å®Œæˆäº†ã€‚<br />![45.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_fb5a6fec27-45.png) <br />**æˆ‘ä»¬ç°åœ¨æ¥çœ‹æ•´ä½“æ€è·¯ï¼š** å½“ç”¨æˆ·ä¸‹å•ä¹‹åï¼Œåˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ï¼Œåªéœ€è¦å–Redisä¸­æ ¹æ®keyæ‰¾å¯¹åº”çš„valueæ˜¯å¦å¤§äº0å³å¯ï¼Œå¦‚æœä¸å……è¶³ï¼Œåˆ™ç›´æ¥ç»“æŸã€‚å¦‚æœå……è¶³ï¼Œåˆ™åœ¨Redisä¸­åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å¯ä»¥ä¸‹å•ï¼Œå¦‚æœseté›†åˆä¸­æ²¡æœ‰è¯¥ç”¨æˆ·çš„ä¸‹å•æ•°æ®ï¼Œåˆ™å¯ä»¥ä¸‹å•ï¼Œå¹¶å°†userIdå’Œä¼˜æƒ åˆ¸å­˜å…¥åˆ°Redisä¸­ï¼Œå¹¶ä¸”è¿”å›0ï¼Œæ•´ä¸ªè¿‡ç¨‹éœ€è¦ä¿è¯æ˜¯åŸå­æ€§çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ç”¨Luaæ¥æ“ä½œã€‚åŒæ—¶ï¼Œç”±äºæˆ‘ä»¬éœ€è¦åœ¨Redisä¸­æŸ¥è¯¢ä¼˜æƒ åˆ¸ä¿¡æ¯ï¼Œæ‰€ä»¥åœ¨æˆ‘ä»¬æ–°å¢ç§’æ€ä¼˜æƒ åˆ¸çš„åŒæ—¶ï¼Œéœ€è¦å°†ä¼˜æƒ åˆ¸ä¿¡æ¯ä¿å­˜åˆ°Redisä¸­ã€‚<br />å®Œæˆä»¥ä¸Šé€»è¾‘åˆ¤æ–­æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦åˆ¤æ–­å½“å‰Redisä¸­çš„è¿”å›å€¼æ˜¯å¦ä¸º0ï¼Œå¦‚æœæ˜¯0ï¼Œåˆ™è¡¨ç¤ºå¯ä»¥ä¸‹å•ï¼Œå°†ä¿¡æ¯ä¿å­˜åˆ°queueä¸­å»ï¼Œç„¶åè¿”å›ï¼Œå¼€ä¸€ä¸ªçº¿ç¨‹æ¥å¼‚æ­¥ä¸‹å•ï¼Œå‰ç«¯å¯ä»¥é€šè¿‡è¿”å›è®¢å•çš„idæ¥æŸ¥è¯¢æ˜¯å¦ä¸‹å•æˆåŠŸ<br />![46.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_ff90994727-46.png)\n<a name=\"Z8kJX\"></a>\n\n### Rediså®Œæˆç”¨æˆ·ç§’æ€èµ„æ ¼æ ¡éªŒ\n\næœ¬èŠ‚éœ€æ±‚ï¼š\n\n- æ–°å¢ç§’æ€ä¼˜æƒ åˆ¸çš„åŒæ—¶ï¼Œå°†ä¼˜æƒ åˆ¸ä¿¡æ¯ä¿å­˜åˆ°Redisä¸­\n- åŸºäºLuaè„šæœ¬ï¼Œåˆ¤æ–­ç§’æ€åº“å­˜ã€ä¸€äººä¸€å•ï¼Œå†³å®šç”¨æˆ·æ˜¯å¦æŠ¢è´­æˆåŠŸ\n\n**ä¿å­˜ä¼˜æƒ åˆ¸ä»£ç ï¼š**\n\n```java\n@Override\n@Transactional\npublic void addSeckillVoucher(Voucher voucher) {\n    // ä¿å­˜ä¼˜æƒ åˆ¸\n    save(voucher);\n    // ä¿å­˜ç§’æ€ä¿¡æ¯\n    SeckillVoucher seckillVoucher = new SeckillVoucher();\n    seckillVoucher.setVoucherId(voucher.getId());\n    seckillVoucher.setStock(voucher.getStock());\n    seckillVoucher.setBeginTime(voucher.getBeginTime());\n    seckillVoucher.setEndTime(voucher.getEndTime());\n    seckillVoucherService.save(seckillVoucher);\n    // ä¿å­˜ç§’æ€ä¼˜æƒ åˆ¸ä¿¡æ¯åˆ°Reidsï¼ŒKeyåä¸­åŒ…å«ä¼˜æƒ åˆ¸IDï¼ŒValueä¸ºä¼˜æƒ åˆ¸çš„å‰©ä½™æ•°é‡\n    stringRedisTemplate.opsForValue().set(SECKILL_STOCK_KEY + voucher.getId(), voucher.getStock().toString()); \n}\n```\n\n**ç¼–å†™Luaè„šæœ¬ï¼š**\n\n> Luaçš„å­—ç¬¦ä¸²æ‹¼æ¥ä½¿ç”¨ ..ï¼Œå­—ç¬¦ä¸²è½¬æ•°å­—æ˜¯ tonumber()\n\n```lua\n-- è®¢å•id\nlocal voucherId = ARGV[1]\n-- ç”¨æˆ·id\nlocal userId = ARGV[2]\n-- ä¼˜æƒ åˆ¸key\nlocal stockKey = 'seckill:stock:' .. voucherId\n-- è®¢å•key\nlocal orderKey = 'seckill:order:' .. voucherId\n-- åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³\nif (tonumber(redis.call('get', stockKey)) <= 0) then\n    return 1\nend\n-- åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¸‹å•\nif (redis.call('sismember', orderKey, userId) == 1) then\n    return 2\nend\n-- æ‰£å‡åº“å­˜\nredis.call('incrby', stockKey, -1)\n-- å°†userIdå­˜å…¥å½“å‰ä¼˜æƒ åˆ¸çš„seté›†åˆ\nredis.call('sadd', orderKey, userId)\nreturn 0\n```\n\n**ä¿®æ”¹ç§’æ€ä¸‹å•é€»è¾‘ï¼š**\n\n```java\n@Override\npublic Result seckillVoucher(Long voucherId) {\n    // 1. æ‰§è¡Œluaè„šæœ¬\n    Long result = stringRedisTemplate.execute(SECKILL_SCRIPT,\n            Collections.emptyList(), voucherId.toString(),\n            UserHolder.getUser().getId().toString());\n    // 2. åˆ¤æ–­è¿”å›å€¼ï¼Œå¹¶è¿”å›é”™è¯¯ä¿¡æ¯\n    if (result.intValue() != 0) {\n        return Result.fail(result.intValue() == 1 ? \"åº“å­˜ä¸è¶³\" : \"ä¸èƒ½é‡å¤ä¸‹å•\");\n    }\n    long orderId = redisIdWorker.nextId(\"order\");\n    // TODO ä¿å­˜é˜»å¡é˜Ÿåˆ—\n\n    // 3. è¿”å›è®¢å•id\n    return Result.ok(orderId);\n}\n```\n\n<a name=\"akU5S\"></a>\n\n### åŸºäºé˜»å¡é˜Ÿåˆ—å®ç°ç§’æ€ä¼˜åŒ–\n\nåœ¨ä¸Šä¸€å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬åœ¨åˆ¤æ–­ç”¨æˆ·å…·æœ‰ç§’æ€èµ„æ ¼åè¿˜æœªåˆ›å»ºè®¢å•å¹¶æ”¾è¿›å¼‚æ­¥é˜Ÿåˆ—å®ç°å¼‚æ­¥ä¸‹å•ã€‚<br />æœ¬èŠ‚ä»»åŠ¡ï¼š\n\n- åˆ›å»ºè®¢å•å¹¶æ”¾è¿›å¼‚æ­¥é˜Ÿåˆ—\n- å¼€å¯çº¿ç¨‹ä»»åŠ¡å¯¹å¼‚æ­¥é˜Ÿåˆ—ä¸­çš„è®¢å•è¿›è¡Œæ¶ˆè´¹\n  <a name=\"TbwQu\"></a>\n\n#### åˆ›å»ºå¼‚æ­¥é˜Ÿåˆ—\n\n**åˆ›å»ºé˜»å¡é˜Ÿåˆ—ï¼š**\n\n```java\nprivate final BlockingQueue<VoucherOrder> orderTasks = new ArrayBlockingQueue<>(1024 * 1024);\n```\n\n**å°è£…ä¼˜æƒ åˆ¸è®¢å•å¹¶æ”¾è¿›å¼‚æ­¥é˜Ÿåˆ—ï¼š**\n\n```java\n@Override\npublic Result seckillVoucher(Long voucherId) {\n    Long result = stringRedisTemplate.execute(SECKILL_SCRIPT,\n            Collections.emptyList(), voucherId.toString(),\n            UserHolder.getUser().getId().toString());\n    if (result.intValue() != 0) {\n        return Result.fail(result.intValue() == 1 ? \"åº“å­˜ä¸è¶³\" : \"ä¸èƒ½é‡å¤ä¸‹å•\");\n    }\n    long orderId = redisIdWorker.nextId(\"order\");\n    // å°è£…åˆ°voucherOrderä¸­\n    VoucherOrder voucherOrder = new VoucherOrder();\n    voucherOrder.setVoucherId(voucherId);\n    voucherOrder.setUserId(UserHolder.getUser().getId());\n    voucherOrder.setId(orderId);\n    // åŠ å…¥åˆ°é˜»å¡é˜Ÿåˆ—\n    orderTasks.add(voucherOrder);\n    return Result.ok(orderId);\n}\n```\n\n<a name=\"WjhdT\"></a>\n\n#### å®ç°å¼‚æ­¥ä¸‹å•\n\n**åˆ›å»ºçº¿ç¨‹æ± ï¼š**\n\n```java\nprivate static final ExecutorService SECKILL_ORDER_EXECUTOR = Executors.newSingleThreadExecutor();\n```\n\n**åˆ›å»ºçº¿ç¨‹ä»»åŠ¡ï¼š**\n\n```java\n// ç§’æ€ä¸šåŠ¡éœ€è¦åœ¨ç±»åˆå§‹åŒ–ä¹‹åï¼Œå°±ç«‹å³æ‰§è¡Œï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦ç”¨åˆ°@PostConstructæ³¨è§£\n@PostConstruct\nprivate void init() {\n    SECKILL_ORDER_EXECUTOR.submit(new VoucherOrderHandler());\n}\n\nprivate class VoucherOrderHandler implements Runnable {\n    @Override\n    public void run() {\n        while (true) {\n            try {\n                // 1. è·å–é˜Ÿåˆ—ä¸­çš„è®¢å•ä¿¡æ¯\n                VoucherOrder voucherOrder = orderTasks.take();\n                // 2. åˆ›å»ºè®¢å•\n                handleVoucherOrder(voucherOrder);\n            } catch (Exception e) {\n                log.error(\"è®¢å•å¤„ç†å¼‚å¸¸\", e);\n            }\n        }\n    }\n}\n```\n\n**åˆ›å»ºè®¢å•ä¸šåŠ¡ï¼š**\n\n```java\nprivate IVoucherOrderService proxy;\nprivate void handleVoucherOrder(VoucherOrder voucherOrder) {\n    // 1. è·å–ç”¨æˆ·\n    Long userId = voucherOrder.getUserId();\n    // 2. åˆ›å»ºé”å¯¹è±¡ï¼Œä½œä¸ºå…œåº•æ–¹æ¡ˆ\n    RLock redisLock = redissonClient.getLock(\"order:\" + userId);\n    // 3. è·å–é”\n    boolean isLock = redisLock.tryLock();\n    // 4. åˆ¤æ–­æ˜¯å¦è·å–é”æˆåŠŸ         \n    if (!isLock) {\n        log.error(\"ä¸å…è®¸é‡å¤ä¸‹å•!\");\n        return;\n    }\n    try {\n        // 5. ä½¿ç”¨ä»£ç†å¯¹è±¡ï¼Œç”±äºè¿™é‡Œæ˜¯å¦å¤–ä¸€ä¸ªçº¿ç¨‹ï¼Œ\n        proxy.createVoucherOrder(voucherOrder);\n    } finally {\n        redisLock.unlock();\n    }\n}\n```\n\n> è¿™é‡Œæœ‰ä¸€ä¸ªç»†èŠ‚çš„åœ°æ–¹ï¼Œæˆ‘ä»¬é€šè¿‡æŸ¥çœ‹AopContextçš„æºç å‘ç°ï¼Œå…¶è·å–ä»£ç†å¯¹è±¡çš„æ–¹å¼æ˜¯é€šè¿‡ThreadLocalï¼Œç”±äºæˆ‘ä»¬ç°åœ¨æ˜¯å¼‚æ­¥ä¸‹å•ï¼Œå·²ç»ä¸åœ¨ä¸»çº¿ç¨‹ä¸­äº†ï¼Œæ‰€ä»¥ç›´æ¥è·å–æ˜¯ä¸è¡Œçš„ã€‚\n\n```java\nprivate static final ThreadLocal<Object> currentProxy = new NamedThreadLocal(\"Current AOP proxy\");\n```\n\n**ä¿®æ”¹ç§’æ€ä¸šåŠ¡ï¼ˆåœ¨ä¸»çº¿ç¨‹ä¸­è·å–ä»£ç†å¯¹è±¡å¹¶å­˜æ”¾åœ¨æˆå‘˜å˜é‡ä¸­ï¼‰ï¼š**\n\n```java\n@Override\npublic Result seckillVoucher(Long voucherId) {\n    Long result = stringRedisTemplate.execute(SECKILL_SCRIPT,\n            Collections.emptyList(), voucherId.toString(),\n            UserHolder.getUser().getId().toString());\n    if (result.intValue() != 0) {\n        return Result.fail(result.intValue() == 1 ? \"åº“å­˜ä¸è¶³\" : \"ä¸èƒ½é‡å¤ä¸‹å•\");\n    }\n    long orderId = redisIdWorker.nextId(\"order\");\n    // å°è£…åˆ°voucherOrderä¸­\n    VoucherOrder voucherOrder = new VoucherOrder();\n    voucherOrder.setVoucherId(voucherId);\n    voucherOrder.setUserId(UserHolder.getUser().getId());\n    voucherOrder.setId(orderId);\n    // åŠ å…¥åˆ°é˜»å¡é˜Ÿåˆ—\n    orderTasks.add(voucherOrder);\n    // ä¸»çº¿ç¨‹è·å–ä»£ç†å¯¹è±¡\n    proxy = (IVoucherOrderService) AopContext.currentProxy();\n    return Result.ok(orderId);\n}\n```\n\n<a name=\"bHssv\"></a>\n\n#### åŸºäºé˜»å¡é˜Ÿåˆ—å®ç°ç§’æ€ä¼˜åŒ–å®Œæ•´ä»£ç \n\n```java\npackage com.hmdp.service.impl;\n\nimport com.hmdp.dto.Result;\nimport com.hmdp.entity.VoucherOrder;\nimport com.hmdp.mapper.VoucherOrderMapper;\nimport com.hmdp.service.ISeckillVoucherService;\nimport com.hmdp.service.IVoucherOrderService;\nimport com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;\nimport com.hmdp.utils.RedisIdWorker;\nimport com.hmdp.utils.UserHolder;\nimport lombok.extern.slf4j.Slf4j;\nimport org.redisson.api.RLock;\nimport org.redisson.api.RedissonClient;\nimport org.springframework.aop.framework.AopContext;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.core.io.ClassPathResource;\nimport org.springframework.data.redis.core.StringRedisTemplate;\nimport org.springframework.data.redis.core.script.DefaultRedisScript;\nimport org.springframework.stereotype.Service;\nimport org.springframework.transaction.annotation.Transactional;\n\nimport javax.annotation.PostConstruct;\nimport javax.annotation.Resource;\nimport java.util.Collections;\nimport java.util.concurrent.ArrayBlockingQueue;\nimport java.util.concurrent.BlockingQueue;\nimport java.util.concurrent.ExecutorService;\nimport java.util.concurrent.Executors;\n\n@Service\n@Slf4j\npublic class VoucherOrderServiceImpl extends ServiceImpl<VoucherOrderMapper, VoucherOrder> implements IVoucherOrderService {\n\n    @Autowired\n    private ISeckillVoucherService seckillVoucherService;\n\n    @Autowired\n    private RedisIdWorker redisIdWorker;\n\n    @Resource\n    private StringRedisTemplate stringRedisTemplate;\n\n    @Resource\n    private RedissonClient redissonClient;\n\n    private IVoucherOrderService proxy;\n\n\n    private static final DefaultRedisScript<Long> SECKILL_SCRIPT;\n\n    static {\n        SECKILL_SCRIPT = new DefaultRedisScript();\n        SECKILL_SCRIPT.setLocation(new ClassPathResource(\"seckill.lua\"));\n        SECKILL_SCRIPT.setResultType(Long.class);\n    }\n\n    private static final ExecutorService SECKILL_ORDER_EXECUTOR = Executors.newSingleThreadExecutor();\n\n    @PostConstruct\n    private void init() {\n        SECKILL_ORDER_EXECUTOR.submit(new VoucherOrderHandler());\n    }\n\n    private final BlockingQueue<VoucherOrder> orderTasks = new ArrayBlockingQueue<>(1024 * 1024);\n\n    private void handleVoucherOrder(VoucherOrder voucherOrder) {\n        // 1. è·å–ç”¨æˆ·\n        Long userId = voucherOrder.getUserId();\n        // 2. åˆ›å»ºé”å¯¹è±¡ï¼Œä½œä¸ºå…œåº•æ–¹æ¡ˆ\n        RLock redisLock = redissonClient.getLock(\"order:\" + userId);\n        // 3. è·å–é”\n        boolean isLock = redisLock.tryLock();\n        // 4. åˆ¤æ–­æ˜¯å¦è·å–é”æˆåŠŸ \n        if (!isLock) {\n            log.error(\"ä¸å…è®¸é‡å¤ä¸‹å•!\");\n            return;\n        }\n        try {\n            // 5. ä½¿ç”¨ä»£ç†å¯¹è±¡ï¼Œç”±äºè¿™é‡Œæ˜¯å¦å¤–ä¸€ä¸ªçº¿ç¨‹ï¼Œ\n            proxy.createVoucherOrder(voucherOrder);\n        } finally {\n            redisLock.unlock();\n        }\n    }\n\n    private class VoucherOrderHandler implements Runnable {\n        @Override\n        public void run() {\n            while (true) {\n                try {\n                    // 1. è·å–é˜Ÿåˆ—ä¸­çš„è®¢å•ä¿¡æ¯\n                    VoucherOrder voucherOrder = orderTasks.take();\n                    // 2. åˆ›å»ºè®¢å•\n                    handleVoucherOrder(voucherOrder);\n                } catch (Exception e) {\n                    log.error(\"è®¢å•å¤„ç†å¼‚å¸¸\", e);\n                }\n            }\n        }\n    }\n\n    @Override\n    public Result seckillVoucher(Long voucherId) {\n        Long result = stringRedisTemplate.execute(SECKILL_SCRIPT,\n                Collections.emptyList(), voucherId.toString(),\n                UserHolder.getUser().getId().toString());\n        if (result.intValue() != 0) {\n            return Result.fail(result.intValue() == 1 ? \"åº“å­˜ä¸è¶³\" : \"ä¸èƒ½é‡å¤ä¸‹å•\");\n        }\n        long orderId = redisIdWorker.nextId(\"order\");\n        // å°è£…åˆ°voucherOrderä¸­\n        VoucherOrder voucherOrder = new VoucherOrder();\n        voucherOrder.setVoucherId(voucherId);\n        voucherOrder.setUserId(UserHolder.getUser().getId());\n        voucherOrder.setId(orderId);\n        // åŠ å…¥åˆ°é˜»å¡é˜Ÿåˆ—\n        orderTasks.add(voucherOrder);\n        // ä¸»çº¿ç¨‹è·å–ä»£ç†å¯¹è±¡\n        proxy = (IVoucherOrderService) AopContext.currentProxy();\n        return Result.ok(orderId);\n    }\n\n\n    @Transactional\n    public void createVoucherOrder(VoucherOrder voucherOrder) {\n        // ä¸€äººä¸€å•é€»è¾‘\n        Long userId = voucherOrder.getUserId();\n        Long voucherId = voucherOrder.getVoucherId();\n        synchronized (userId.toString().intern()) {\n            int count = query().eq(\"voucher_id\", voucherId).eq(\"user_id\", userId).count();\n            if (count > 0) {\n                log.error(\"ä½ å·²ç»æŠ¢è¿‡ä¼˜æƒ åˆ¸äº†å“¦\");\n                return;\n            }\n            // 5. æ‰£å‡åº“å­˜\n            boolean success = seckillVoucherService.update()\n                    .setSql(\"stock = stock - 1\")\n                    .eq(\"voucher_id\", voucherId)\n                    .gt(\"stock\", 0)\n                    .update();\n            if (!success) {\n                log.error(\"åº“å­˜ä¸è¶³\");\n            }\n            // 7. å°†è®¢å•æ•°æ®ä¿å­˜åˆ°è¡¨ä¸­\n            save(voucherOrder);\n        }\n    }\n}\n```\n\n<a name=\"T066c\"></a>\n\n### ç§’æ€ä¼˜åŒ–å°ç»“\n\n<a name=\"EQSHi\"></a>\n\n#### ç§’æ€ä¸šåŠ¡çš„ä¼˜åŒ–æ€è·¯\n\n- å…ˆåˆ©ç”¨Rediså®Œæˆåº“å­˜å®¹é‡ã€ä¸€äººä¸€å•çš„åˆ¤æ–­ï¼Œå®ŒæˆæŠ¢å•ä¸šåŠ¡\n- å†å°†ä¸‹å•ä¸šåŠ¡æ”¾å…¥é˜»å¡é˜Ÿåˆ—ï¼Œåˆ©ç”¨ç‹¬ç«‹çº¿ç¨‹å¼‚æ­¥ä¸‹å•\n  <a name=\"vaUv2\"></a>\n\n#### åŸºäºé˜»å¡é˜Ÿåˆ—çš„å¼‚æ­¥ç§’æ€å­˜åœ¨å“ªäº›é—®é¢˜\n\n**å†…å­˜é™åˆ¶é—®é¢˜ï¼š** æˆ‘ä»¬ç°åœ¨ä½¿ç”¨çš„æ˜¯JDKè‡ªå¸¦çš„é˜»å¡é˜Ÿåˆ—ï¼Œå®ƒä½¿ç”¨çš„æ˜¯JVMçš„å†…å­˜ï¼Œå¦‚æœåœ¨é«˜å¹¶å‘çš„æ¡ä»¶ä¸‹ï¼Œå¤§é‡çš„è®¢å•éƒ½ä¼šæ”¾è¿›é˜»å¡é˜Ÿåˆ—é‡Œï¼Œå¯èƒ½å°±ä¼šé€ æˆå†…å­˜æº¢å‡ºï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨åˆ›å»ºé˜»å¡é˜Ÿåˆ—æ—¶ï¼Œè®¾ç½®äº†ä¸€ä¸ªé•¿åº¦ï¼Œä½†æ˜¯å¦‚æœçœŸçš„å­˜æ»¡äº†ï¼Œå†æœ‰æ–°çš„è®¢å•æ¥å¾€é‡Œå¡ï¼Œé‚£å°±å¡ä¸è¿›å»äº†ï¼Œå­˜åœ¨å†…å­˜é™åˆ¶é—®é¢˜<br />**æ•°æ®å®‰å…¨é—®é¢˜ï¼š**\n\n- å¦‚æœæœåŠ¡å™¨å®•æœºï¼Œå†…å­˜ä¸­çš„ä¿¡æ¯å…¨éƒ¨ä¸¢å¤±ï¼Œå¯¼è‡´å·²ä»˜æ¬¾å´æ— è®¢å•\n- ä»å¼‚æ­¥é˜Ÿåˆ—ä¸­æ‹¿å‡ºäº†è®¢å•å´å› ä¸ºå¼‚å¸¸æ²¡æœ‰æ¶ˆè´¹ï¼Œé‚£å°±æ°¸è¿œä¹Ÿä¸ä¼šè¢«æ¶ˆè´¹äº†\n  <a name=\"BvMXW\"></a>\n\n## Redisæ¶ˆæ¯é˜Ÿåˆ—\n\n<a name=\"iWvzp\"></a>\n\n### è®¤è¯†æ¶ˆæ¯é˜Ÿåˆ—\n\nä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿå­—é¢æ„æ€å°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—ï¼Œæœ€ç®€å•çš„æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å‹åŒ…æ‹¬3ä¸ªè§’è‰²\n\n- æ¶ˆæ¯é˜Ÿåˆ—ï¼šå­˜å‚¨å’Œç®¡ç†æ¶ˆæ¯ï¼Œä¹Ÿè¢«ç§°ä¸ºæ¶ˆæ¯ä»£ç†ï¼ˆMessage Brokerï¼‰\n- ç”Ÿäº§è€…ï¼šå‘é€æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—\n- æ¶ˆè´¹è€…ï¼šä»æ¶ˆæ¯é˜Ÿåˆ—è·å–æ¶ˆæ¯å¹¶å¤„ç†æ¶ˆæ¯\n\nä½¿ç”¨é˜Ÿåˆ—çš„å¥½å¤„åœ¨äº**è§£è€¦**ï¼šä¸¾ä¸ªä¾‹å­ï¼Œå¿«é€’å‘˜(ç”Ÿäº§è€…)æŠŠå¿«é€’æ”¾åˆ°é©¿ç«™/å¿«é€’æŸœé‡Œå»(Message Queue)å»ï¼Œæˆ‘ä»¬(æ¶ˆè´¹è€…)ä»å¿«é€’æŸœ/é©¿ç«™å»æ‹¿å¿«é€’ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªå¼‚æ­¥ï¼Œå¦‚æœè€¦åˆï¼Œé‚£ä¹ˆå¿«é€’å‘˜å¿…é¡»äº²è‡ªä¸Šæ¥¼æŠŠå¿«é€’é€’åˆ°ä½ æ‰‹é‡Œï¼ŒæœåŠ¡å½“ç„¶å¥½ï¼Œä½†æ˜¯ä¸‡ä¸€æˆ‘ä¸åœ¨å®¶ï¼Œå¿«é€’å‘˜å°±å¾—ä¸€ç›´ç­‰æˆ‘ï¼Œæµªè´¹äº†å¿«é€’å‘˜çš„æ—¶é—´ã€‚æ‰€ä»¥è§£è€¦è¿˜æ˜¯éå¸¸æœ‰å¿…è¦çš„<br />é‚£ä¹ˆåœ¨è¿™ç§åœºæ™¯ä¸‹æˆ‘ä»¬çš„ç§’æ€å°±å˜æˆäº†ï¼šåœ¨æˆ‘ä»¬ä¸‹å•ä¹‹åï¼Œåˆ©ç”¨Rediså»è¿›è¡Œæ ¡éªŒä¸‹å•çš„ç»“æœï¼Œç„¶ååœ¨é€šè¿‡é˜Ÿåˆ—æŠŠæ¶ˆæ¯å‘é€å‡ºå»ï¼Œç„¶ååœ¨å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å»æ‹¿åˆ°è¿™ä¸ªæ¶ˆæ¯ï¼Œå®Œæˆè§£è€¦ï¼ŒåŒæ—¶ä¹ŸåŠ å¿«æˆ‘ä»¬çš„å“åº”é€Ÿåº¦<br />å¯¹äºå°ä¸­å‹é¡¹ç›®å®Œå…¨å¯ä»¥ä½¿ç”¨Redisä¸­çš„Streamä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¯¹äºä¸€äº›å¯¹æ¶ˆæ¯é˜Ÿåˆ—æœ‰è¾ƒé«˜è¦æ±‚çš„é¡¹ç›®ï¼Œå¯ä»¥å»ºè®®ä½¿ç”¨ç°æœ‰çš„æ¶ˆæ¯é˜Ÿåˆ—æ¡†æ¶ï¼Œå¦‚RabitMqï¼ŒRocketMqï¼ŒKafkaã€‚\n<a name=\"vD8in\"></a>\n\n### åŸºäºRedis-Listå®ç°æ¶ˆæ¯é˜Ÿåˆ—\n\nåŸºäºListç»“æ„æ¨¡æ‹Ÿæ¶ˆæ¯é˜Ÿåˆ—<br />æ¶ˆæ¯é˜Ÿåˆ—(Message Queue)ï¼Œå­—é¢æ„æ€å°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—ï¼Œè€ŒRedisçš„listæ•°æ®ç»“æ„æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå¾ˆå®¹æ˜“æ¨¡æ‹Ÿå‡ºé˜Ÿåˆ—çš„æ•ˆæœ<br />é˜Ÿåˆ—çš„å…¥å£å’Œå‡ºå£ä¸åœ¨åŒä¸€è¾¹ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ï¼š`LPUSH`ç»“åˆ`RPOP`æˆ–è€…`RPUSH`ç»“åˆ`LPOP`æ¥å®ç°æ¶ˆæ¯é˜Ÿåˆ—ã€‚<br />ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“é˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯æ—¶ï¼Œ`RPOP`å’Œ`LPOP`æ“ä½œä¼šè¿”å›`NULL`ï¼Œè€Œä¸åƒJVMé˜»å¡é˜Ÿåˆ—é‚£æ ·ä¼šé˜»å¡ï¼Œå¹¶ç­‰å¾…æ¶ˆæ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œåº”è¯¥ä½¿ç”¨`BRPOP`æˆ–è€…`BLPOP`æ¥å®ç°é˜»å¡æ•ˆæœ<br />![47.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_02a4c26127-47.png) <br />åŸºäºListçš„æ¶ˆæ¯é˜Ÿåˆ—æœ‰å“ªäº›ä¼˜ç¼ºç‚¹ï¼Ÿ<br />**ä¼˜ç‚¹ï¼š**\n\n- åˆ©ç”¨Rediså­˜å‚¨ï¼Œä¸å—é™äºJVMå†…å­˜ä¸Šé™\n- åŸºäºRedisçš„æŒä¹…åŒ–æœºåˆ¶ï¼Œæ•°æ®å®‰å…¨æ€§æœ‰ä¿éšœ\n- å¯ä»¥æ»¡è¶³æ¶ˆæ¯æœ‰åºæ€§\n\n**ç¼ºç‚¹ï¼š**\n\n- åªæ”¯æŒå•æ¶ˆè´¹è€…(ä¸€ä¸ªæ¶ˆæ¯åªèƒ½è¢«è¯»ä¸€æ¬¡)\n- æ— æ³•é¿å…æ¶ˆæ¯ä¸¢å¤±(å¦‚æœè¯»äº†æ¶ˆæ¯ä¹‹åæœåŠ¡å™¨å®•æœºï¼Œåˆç”±äºåªèƒ½è¢«è¯»ä¸€æ¬¡ï¼Œæ‰€ä»¥ç›´æ¥å¯„)\n  <a name=\"UUqOz\"></a>\n\n### åŸºäºPubSubçš„æ¶ˆæ¯é˜Ÿåˆ—\n\n**PubSub**ï¼ˆå‘å¸ƒè®¢é˜…ï¼‰æ˜¯Redis2.0ç‰ˆæœ¬å¼•å…¥çš„æ¶ˆæ¯ä¼ é€’æ¨¡å‹ã€‚é¡¾åæ€ä¹‰ï¼Œæ¶ˆè´¹å’Œå¯ä»¥è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªchannelï¼Œç”Ÿäº§è€…å‘å¯¹åº”channelå‘é€æ¶ˆæ¯åï¼Œæ‰€æœ‰è®¢é˜…è€…éƒ½èƒ½æ”¶åˆ°ç›¸å…³æ¶ˆæ¯\n\n- `SUBSCRIBE channel [channel]`ï¼šè®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªé¢‘é“\n- `PUBLISH channel msg`ï¼šå‘ä¸€ä¸ªé¢‘é“å‘é€æ¶ˆæ¯\n- `PSUBSCRIBE pattern [pattern]`ï¼šè®¢é˜…ä¸patternæ ¼å¼åŒ¹é…çš„æ‰€æœ‰é¢‘é“\n\n> å®˜ç½‘å¯¹äº`partern`çš„è§£é‡Šï¼š\n> Subscribes the client to the given patterns.<br />Supported glob-style patterns:\n>\n> - h?flo subscribes to hello, hallo and hxllo\n> - h*llo subscribes to hllo and heeeello\n> - h[ae]llo subscribes to hello and hallo, but not hillo\n>\n> Use \\ to escape special characters if you want to match them verbatim.\n\nåŸºäºPubSubçš„æ¶ˆæ¯é˜Ÿåˆ—æœ‰å“ªäº›ä¼˜ç¼ºç‚¹<br />**ä¼˜ç‚¹ï¼š**\n\n- é‡‡ç”¨å‘å¸ƒè®¢é˜…æ¨¡å‹ï¼Œæ”¯æŒå¤šç”Ÿäº§ï¼Œå¤šæ¶ˆè´¹\n\n**ç¼ºç‚¹ï¼š**\n\n- ä¸æ”¯æŒæ•°æ®æŒä¹…åŒ–\n- æ— æ³•é¿å…æ¶ˆæ¯ä¸¢å¤±ï¼ˆå¦‚æœå‘é¢‘é“å‘é€äº†æ¶ˆæ¯ï¼Œå´æ²¡æœ‰äººè®¢é˜…è¯¥é¢‘é“ï¼Œé‚£å‘é€çš„è¿™æ¡æ¶ˆæ¯å°±ä¸¢å¤±äº†ï¼‰\n- æ¶ˆæ¯å †ç§¯æœ‰ä¸Šé™ï¼Œè¶…å‡ºæ—¶æ•°æ®ä¸¢å¤±ï¼ˆæ¶ˆè´¹è€…æ‹¿åˆ°æ•°æ®çš„æ—¶å€™å¤„ç†çš„å¤ªæ…¢ï¼Œè€Œå‘é€æ¶ˆæ¯å‘çš„å¤ªå¿«ï¼‰\n  <a name=\"WKILK\"></a>\n\n### åŸºäºStreamçš„å•æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—\n\n**Stream**æ˜¯Redis 5.0å¼•å…¥çš„ä¸€ç§æ–°æ•°æ®ç±»å‹ï¼Œå¯ä»¥å®ç°ä¸€ä¸ªåŠŸèƒ½éå¸¸å®Œå–„çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚<br />**å‘é€æ¶ˆæ¯çš„å‘½ä»¤ï¼šXADD**<br />![48.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_06504d6127-48.png)\n\n> ä¾‹å¦‚ï¼š\n\n![49.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_0deef46827-49.png) <br />**è¯»å–æ¶ˆæ¯çš„æ–¹å¼ä¹‹ä¸€ï¼šXREAD**<br />![50.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_10cfb76a27-50.png)\n\n> ä¾‹å¦‚ä½¿ç”¨XREADè¯»å–ç¬¬ä¸€ä¸ªæ¶ˆæ¯ï¼š\n\n![51.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_13c9a04927-51.png)\n\n> ä¾‹å¦‚è®©XREADé˜»å¡æ–¹å¼è¯»å–æœ€æ–°æ¶ˆæ¯ï¼š\n\n![52.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_f80362ca27-52.png) <br />åœ¨ä¸šåŠ¡å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¾ªç¯è°ƒç”¨çš„XREADé˜»å¡æ–¹å¼æ¥æŸ¥è¯¢æœ€æ–°æ¶ˆæ¯ï¼Œä»è€Œå®ç°æŒç»­ç›‘å¬é˜Ÿåˆ—çš„æ•ˆæœï¼Œä¼ªä»£ç å¦‚ä¸‹ï¼š\n\n```java\nwhile (true) {\n    // å°è¯•è¯»å–é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼Œæœ€å¤šé˜»å¡2ç§’\n    Object msg = redis.execute(\"XREAD COUNT 1 BLOCK 2000 STREAMS users $\");\n    if (msg == null) {\n        continue;\n    }\n    // å¤„ç†æ¶ˆæ¯\n    handleMessage(msg);\n}\n```\n\n> æ³¨æ„ï¼šå½“æˆ‘ä»¬æŒ‡å®šå…¶å®IDä¸º$æ—¶ï¼Œä»£è¡¨åªèƒ½è¯»å–åˆ°æœ€æ–°æ¶ˆæ¯ï¼Œå¦‚æœå½“æˆ‘ä»¬åœ¨å¤„ç†ä¸€æ¡æ¶ˆæ¯çš„è¿‡ç¨‹ä¸­ï¼Œåˆæœ‰è¶…è¿‡1æ¡ä»¥ä¸Šçš„æ¶ˆæ¯åˆ°è¾¾é˜Ÿåˆ—ï¼Œé‚£ä¹ˆä¸‹æ¬¡è·å–çš„æ—¶å€™ï¼Œä¹Ÿåªèƒ½è·å–åˆ°æœ€æ–°çš„ä¸€æ¡ï¼Œä¼šå‡ºç°æ¼è¯»æ¶ˆæ¯çš„é—®é¢˜\n\n**STREAMç±»å‹æ¶ˆæ¯é˜Ÿåˆ—çš„XREADå‘½ä»¤ç‰¹ç‚¹ï¼š**\n\n- æ¶ˆæ¯å¯å›æº¯\n- ä¸€ä¸ªæ¶ˆæ¯å¯ä»¥è¢«å¤šä¸ªæ¶ˆè´¹è€…è¯»å–\n- å¯ä»¥é˜»å¡è¯»å–\n- æœ‰æ¼è¯»æ¶ˆæ¯çš„é£é™©\n  <a name=\"Mrc44\"></a>\n\n### åŸºäºStreamçš„æ¶ˆè´¹è€…ç»„æ¶ˆæ¯é˜Ÿåˆ—\n\n**æ¶ˆè´¹è€…ç»„**(Consumer Group)ï¼šå°†å¤šä¸ªæ¶ˆè´¹è€…åˆ’åˆ†åˆ°ä¸€ä¸ªç»„ä¸­ï¼Œç›‘å¬åŒä¸€ä¸ªé˜Ÿåˆ—ï¼Œå…·å¤‡ä»¥ä¸‹ç‰¹ç‚¹ï¼š<br />![53.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_fb5fb12827-53.png) <br />**åˆ›å»ºæ¶ˆè´¹è€…ç»„çš„å‘½ä»¤ï¼š**\n\n```bash\nXGROUP CREATE key groupName ID [MKSTREAM]\n```\n\n> `key`ï¼šé˜Ÿåˆ—åç§°\n> `groupName`ï¼šæ¶ˆè´¹è€…ç»„åç§°\n> `ID`ï¼šèµ·å§‹`ID`æ ‡ç¤ºï¼Œ`$`ä»£è¡¨é˜Ÿåˆ—ä¸­æœ€åä¸€ä¸ªæ¶ˆæ¯ï¼Œ`0`åˆ™ä»£è¡¨é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªæ¶ˆæ¯\n> `MKSTREAM`ï¼šé˜Ÿåˆ—ä¸å­˜åœ¨æ—¶è‡ªåŠ¨åˆ›å»ºé˜Ÿåˆ—\n\nå…¶ä»–å¸¸è§å‘½ä»¤ï¼š\n\n```bash\n# åˆ é™¤æŒ‡å®šæ¶ˆè´¹ç»„\nXGROUP DESTORY key groupName\n\n# ç»™æŒ‡å®šçš„æ¶ˆè´¹è€…ç»„æ·»åŠ æ¶ˆè´¹è€…\nXGROUP CREATECONSUMER key groupName consumerName\n\n# åˆ é™¤æ¶ˆè´¹è€…ç»„ä¸­æŒ‡å®šçš„æ¶ˆè´¹è€…\nXGROUP DELCONSUMER key groupName consumerName\n```\n\n**ä»æ¶ˆè´¹è€…ç»„ä¸­è¯»å–æ¶ˆæ¯ï¼š**\n\n```bash\nXREADGROUP GROUP group consumer [COUNT count] [BLOCK milliseconds] [NOACK] STREAMS key [key ...] ID [ID ...]\n```\n\n> `group`ï¼šæ¶ˆè´¹ç»„åç§°\n> `consumer`ï¼šæ¶ˆè´¹è€…åç§°ï¼Œå¦‚æœæ¶ˆè´¹è€…ä¸å­˜åœ¨ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ¶ˆè´¹è€…\n> `count`ï¼šæœ¬æ¬¡æŸ¥è¯¢çš„æœ€å¤§æ•°é‡\n> `BLOCK milliseconds`ï¼šå½“æ²¡æœ‰æ¶ˆæ¯æ—¶æœ€é•¿ç­‰å¾…æ—¶é—´\n> `NOACK`ï¼šæ— éœ€æ‰‹åŠ¨`ACK`ï¼Œè·å–åˆ°æ¶ˆæ¯åè‡ªåŠ¨ç¡®è®¤ï¼ˆä¸å»ºè®®ï¼‰\n> `STREAMS key`ï¼šæŒ‡å®šé˜Ÿåˆ—åç§°\n> `ID`ï¼šè·å–æ¶ˆæ¯çš„èµ·å§‹`ID`ï¼Œ`ID`åªæœ‰ä¸¤ç§ï¼š\n>\n> - `>`ï¼šä»ä¸‹ä¸€ä¸ªæœªæ¶ˆè´¹çš„æ¶ˆæ¯å¼€å§‹ï¼ˆé`pending-list`ä¸­çš„ï¼‰\n> - å…¶ä»–ï¼šæ ¹æ®æŒ‡å®š`id`ä»`pending-list`ä¸­è·å–å·²æ¶ˆè´¹ä½†æœªç¡®è®¤çš„æ¶ˆæ¯ï¼Œä¾‹å¦‚`0`ï¼Œæ˜¯ä»`pending-list`ä¸­çš„`ç¬¬ä¸€ä¸ª`æ¶ˆæ¯å¼€å§‹\n\n**æ¶ˆè´¹è€…ç»„ç›‘å¬æ¶ˆæ¯çš„åŸºæœ¬æ€è·¯ï¼ˆä¼ªä»£ç ï¼‰ï¼š**\n\n```java\nwhile(true) {\n    // å°è¯•ç›‘å¬é˜Ÿåˆ—ï¼Œä½¿ç”¨é˜»å¡æ¨¡å¼ï¼Œæœ€å¤§ç­‰å¾…æ—¶é•¿ä¸º2000ms\n    Object msg = redis.call(\"XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 >\")\n    if(msg == null) {\n        // æ²¡ç›‘å¬åˆ°æ¶ˆæ¯ï¼Œé‡è¯•\n        continue;\n    }\n    try{\n        // å¤„ç†æ¶ˆæ¯ï¼Œå®Œæˆåè¦æ‰‹åŠ¨ç¡®è®¤ACKï¼ŒACKä»£ç åœ¨handleMessageä¸­ç¼–å†™\n        handleMessage(msg);\n    } catch(Exception e) {\n        while(true) {\n            // 0è¡¨ç¤ºä»pending-listä¸­çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯å¼€å§‹ï¼Œå¦‚æœå‰é¢éƒ½ACKäº†ï¼Œé‚£ä¹ˆè¿™é‡Œå°±ä¸ä¼šç›‘å¬åˆ°æ¶ˆæ¯\n            Object msg = redis.call(\"XREADGROUP GROUP g1 c1 COUNT 1 STREAMS s1 0\");\n            if(msg == null) {\n                // nullè¡¨ç¤ºæ²¡æœ‰å¼‚å¸¸æ¶ˆæ¯ï¼Œæ‰€æœ‰æ¶ˆæ¯å‡å·²ç¡®è®¤ï¼Œç»“æŸå¾ªç¯\n                break;\n            }\n            try{\n                // è¯´æ˜æœ‰å¼‚å¸¸æ¶ˆæ¯ï¼Œå†æ¬¡å¤„ç†\n                handleMessage(msg);\n            } catch(Exception e) {\n                // å†æ¬¡å‡ºç°å¼‚å¸¸ï¼Œè®°å½•æ—¥å¿—ï¼Œç»§ç»­å¾ªç¯\n                log.error(\"..\");\n                continue;\n            }\n        }\n    }\n}\n```\n\n**STREAMç±»å‹æ¶ˆæ¯é˜Ÿåˆ—çš„XREADGROUPå‘½ä»¤çš„ç‰¹ç‚¹ï¼š**\n\n- æ¶ˆæ¯å¯å›æº¯\n- å¯ä»¥å¤šæ¶ˆè´¹è€…äº‰æŠ¢æ¶ˆæ¯ï¼ŒåŠ å¿«æ¶ˆè´¹é€Ÿåº¦\n- å¯ä»¥é˜»å¡è¯»å–\n- æ²¡æœ‰æ¶ˆæ¯æ¼è¯»é£é™©\n- æœ‰æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼Œä¿è¯æ¶ˆæ¯è‡³å°‘è¢«æ¶ˆè´¹ä¸€æ¬¡\n\n**Rediså®ç°æ¶ˆæ¯é˜Ÿåˆ—çš„ä¸‰ç§æ–¹å¼å¯¹æ¯”ï¼š**<br />![54.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_fe6681d927-54.png)\n<a name=\"IPCfB\"></a>\n\n### åŸºäºStreamçš„æ¶ˆè´¹è€…ç»„ä¼˜åŒ–ç§’æ€\n\næœ¬å°èŠ‚éœ€æ±‚ï¼š\n\n- åˆ›å»ºä¸€ä¸ªStreamç±»å‹çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåä¸ºstream.orders\n- ä¿®æ”¹ä¹‹å‰çš„ç§’æ€ä¸‹å•Luaè„šæœ¬ï¼Œåœ¨è®¤å®šæœ‰æŠ¢è´­èµ„æ ¼åï¼Œç›´æ¥å‘stream.ordersä¸­æ·»åŠ æ¶ˆæ¯ï¼Œå†…å®¹åŒ…å«voucherIdã€userIdã€orderId\n- é¡¹ç›®å¯åŠ¨æ—¶ï¼Œå¼€å¯ä¸€ä¸ªçº¿ç¨‹ä»»åŠ¡ï¼Œå°è¯•è·å–stream.ordersä¸­çš„æ¶ˆæ¯ï¼Œå®Œæˆä¸‹å•\n\n**åœ¨redisä¸­åˆ›å»ºåä¸ºstream.ordersçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼š**\n\n```bash\nXGROUP CREATE stream.orders g1 0 MKSTREAM\n```\n\n**ä¿®æ”¹Luaè„šæœ¬ï¼Œæ–°å¢orderIdå‚æ•°ï¼Œå¹¶å°†è®¢å•ä¿¡æ¯åŠ å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼š**\n\n```lua\n-- è®¢å•id\nlocal voucherId = ARGV[1]\n-- ç”¨æˆ·id\nlocal userId = ARGV[2]\n-- æ–°å¢orderIdï¼Œä½†æ˜¯å˜é‡åç”¨idå°±å¥½ï¼Œå› ä¸ºVoucherOrderå®ä½“ç±»ä¸­çš„orderIdå°±æ˜¯ç”¨idè¡¨ç¤ºçš„\nlocal id = ARGV[3]\n-- ä¼˜æƒ åˆ¸key\nlocal stockKey = 'seckill:stock:' .. voucherId\n-- è®¢å•key\nlocal orderKey = 'seckill:order:' .. voucherId\n-- åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³\nif (tonumber(redis.call('get', stockKey)) <= 0) then\n    return 1\nend\n-- åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¸‹å•\nif (redis.call('sismember', orderKey, userId) == 1) then\n    return 2\nend\n-- æ‰£å‡åº“å­˜\nredis.call('incrby', stockKey, -1)\n-- å°†userIdå­˜å…¥å½“å‰ä¼˜æƒ åˆ¸çš„seté›†åˆ\nredis.call('sadd', orderKey, userId)\n-- å°†ä¸‹å•æ•°æ®ä¿å­˜åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­\nredis.call(\"sadd\", 'stream.orders', '*', 'userId', userId, 'voucherId', voucherId, 'id', id)\nreturn 0\n```\n\n**ä¿®æ”¹ç§’æ€é€»è¾‘ï¼š**\n\n```java\n@Override\npublic Result seckillVoucher(Long voucherId) {\n    long orderId = redisIdWorker.nextId(\"order\");\n    Long result = stringRedisTemplate.execute(SECKILL_SCRIPT,\n            Collections.emptyList(), voucherId.toString(),\n            UserHolder.getUser().getId().toString(), String.valueOf(orderId));\n    if (result.intValue() != 0) {\n        return Result.fail(result.intValue() == 1 ? \"åº“å­˜ä¸è¶³\" : \"ä¸èƒ½é‡å¤ä¸‹å•\");\n    }\n    // ä¸»çº¿ç¨‹è·å–ä»£ç†å¯¹è±¡\n    proxy = (IVoucherOrderService) AopContext.currentProxy();\n    return Result.ok(orderId);\n}\n```\n\n**ä¿®æ”¹`VoucherOrderHandler`ï¼š**\n\n```java\nString queueName = \"stream.orders\";\n\nprivate class VoucherOrderHandler implements Runnable {\n\n    @Override\n    public void run() {\n        while (true) {\n            try {\n                // 1. è·å–é˜Ÿåˆ—ä¸­çš„è®¢å•ä¿¡æ¯ XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS stream.orders >\n                List<MapRecord<String, Object, Object>> records = stringRedisTemplate.opsForStream().read(Consumer.from(\"g1\", \"c1\"),\n                        StreamReadOptions.empty().count(1).block(Duration.ofSeconds(2)),\n                        // ReadOffset.lastConsumed()åº•å±‚å°±æ˜¯ '>'\n                        StreamOffset.create(queueName, ReadOffset.lastConsumed()));\n                // 2. åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦è·å–æˆåŠŸ\n                if (records == null || records.isEmpty()) {\n                    continue;\n                }\n                // 3. æ¶ˆæ¯è·å–æˆåŠŸä¹‹åï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶è½¬ä¸ºå¯¹è±¡\n                MapRecord<String, Object, Object> record = records.get(0);\n                Map<Object, Object> values = record.getValue();\n                VoucherOrder voucherOrder = BeanUtil.fillBeanWithMap(values, new VoucherOrder(), true);\n                // 4. è·å–æˆåŠŸï¼Œæ‰§è¡Œä¸‹å•é€»è¾‘ï¼Œå°†æ•°æ®ä¿å­˜åˆ°æ•°æ®åº“ä¸­\n                handleVoucherOrder(voucherOrder);\n                // 5. æ‰‹åŠ¨ACKï¼ŒSACK stream.orders g1 id\n                stringRedisTemplate.opsForStream().acknowledge(queueName, \"g1\", record.getId());\n            } catch (Exception e) {\n                log.error(\"è®¢å•å¤„ç†å¼‚å¸¸\", e);\n                // è®¢å•å¼‚å¸¸çš„å¤„ç†æ–¹å¼æˆ‘ä»¬å°è£…æˆä¸€ä¸ªå‡½æ•°ï¼Œé¿å…ä»£ç å¤ªè‡ƒè‚¿\n                handlePendingList();\n            }\n        }\n    }\n}\n\nprivate void handlePendingList() {\n    while (true) {\n        try {\n            // 1. è·å–pending-listä¸­çš„è®¢å•ä¿¡æ¯ XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS stream.orders 0\n            List<MapRecord<String, Object, Object>> records = stringRedisTemplate.opsForStream().read(\n                    Consumer.from(\"g1\", \"c1\"),\n                    StreamReadOptions.empty().count(1),\n                    StreamOffset.create(queueName, ReadOffset.from(\"0\")));\n            // 2. åˆ¤æ–­pending-listä¸­æ˜¯å¦æœ‰æœªå¤„ç†æ¶ˆæ¯\n            if (records == null || records.isEmpty()) {\n                // å¦‚æœæ²¡æœ‰å°±è¯´æ˜æ²¡æœ‰å¼‚å¸¸æ¶ˆæ¯ï¼Œç›´æ¥ç»“æŸå¾ªç¯\n                break;\n            }\n            // 3. æ¶ˆæ¯è·å–æˆåŠŸä¹‹åï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶è½¬ä¸ºå¯¹è±¡\n            MapRecord<String, Object, Object> record = records.get(0);\n            Map<Object, Object> values = record.getValue();\n            VoucherOrder voucherOrder = BeanUtil.fillBeanWithMap(values, new VoucherOrder(), true);\n            // 4. è·å–æˆåŠŸï¼Œæ‰§è¡Œä¸‹å•é€»è¾‘ï¼Œå°†æ•°æ®ä¿å­˜åˆ°æ•°æ®åº“ä¸­\n            handleVoucherOrder(voucherOrder);\n            // 5. æ‰‹åŠ¨ACKï¼ŒSACK stream.orders g1 id\n            stringRedisTemplate.opsForStream().acknowledge(queueName, \"g1\", record.getId());\n        } catch (Exception e) {\n            log.info(\"å¤„ç†pending-listå¼‚å¸¸\");\n            // å¦‚æœæ€•å¼‚å¸¸å¤šæ¬¡å‡ºç°ï¼Œå¯ä»¥åœ¨è¿™é‡Œä¼‘çœ ä¸€ä¼šå„¿\n            try {\n                Thread.sleep(50);\n            } catch (InterruptedException ex) {\n                throw new RuntimeException(ex);\n            }\n        }\n    }\n}\n```\n\n<a name=\"R2uIz\"></a>\n\n## è¾¾äººæ¢åº—\n\nåœ¨æœ¬å°èŠ‚ï¼Œæˆ‘ä»¬ä¸»è¦éœ€è¦å®ç°æ¢åº—ç¬”è®°çš„**ç‚¹èµåŠŸèƒ½**å’Œ**ç‚¹èµæ’è¡Œæ¦œ**åŠŸèƒ½ã€‚\n\n> å‡è®¾åœ¨æ­¤ä¹‹å‰å·²ç»å®ç°äº†å‘å¸ƒæ¢åº—ç¬”è®°å’ŒæŸ¥çœ‹æ¢åº—ç¬”è®°æ’è¡Œæ¦œåŠŸèƒ½ã€‚\n\n<a name=\"gIyih\"></a>\n\n### ç‚¹èµåŠŸèƒ½\n\n**éœ€æ±‚èƒŒæ™¯ï¼š** æˆ‘ä»¬å¯¹äºä¸€ç¯‡ç¬”è®°ï¼Œå¦‚æœä¸æ ¡éªŒç”¨æˆ·æ˜¯å¦ç‚¹èµï¼Œç”¨æˆ·å°±å¯ä»¥ä¸€ç›´ç‚¹èµï¼Œæ˜¾ç„¶ä¸ç¬¦åˆé¢„æœŸã€‚<br />**éœ€æ±‚ï¼š**\n\n- å½“ç”¨æˆ·æœªç‚¹èµæ—¶ï¼Œç‚¹èµæˆåŠŸï¼Œç‚¹èµæ•° `+ 1`\n- å½“ç”¨æˆ·å·²ç‚¹èµæ—¶ï¼Œå–æ¶ˆç‚¹èµï¼Œç‚¹èµæ•° `- 1`\n\n**è§£å†³æ–¹æ¡ˆï¼š** æˆ‘ä»¬å¯ä»¥åˆ©ç”¨Redisä¸­çš„Setæ•°æ®ç±»å‹å®ç°å¿«é€Ÿæ ¡éªŒç”¨æˆ·æ˜¯å¦å·²ç»ç‚¹èµã€‚<br />**Controllerï¼š**\n\n```java\n@PutMapping(\"/like/{id}\")\npublic Result likeBlog(@PathVariable(\"id\") Long id) {\n    return blogService.likeBlog(id);\n}\n```\n\n**ServiceImplï¼š**\n\n```java\n@Override\npublic Result likeBlog(Long id) {\n    // 1. è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯\n    Long userId = UserHolder.getUser().getId();\n    // 2. å¦‚æœå½“å‰ç”¨æˆ·æœªç‚¹èµï¼Œåˆ™ç‚¹èµæ•° +1ï¼ŒåŒæ—¶å°†ç”¨æˆ·åŠ å…¥seté›†åˆ\n    String key = BLOG_LIKED_KEY + id;\n    Boolean isLiked = stringRedisTemplate.opsForSet().isMember(key, userId.toString());\n    if (BooleanUtil.isFalse(isLiked)) {\n        // ç‚¹èµæ•° +1\n        boolean success = update().setSql(\"liked = liked + 1\").eq(\"id\", id).update();\n        // å°†ç”¨æˆ·åŠ å…¥seté›†åˆ\n        if (success) {\n            stringRedisTemplate.opsForSet().add(key, userId.toString());\n        }\n    // 3. å¦‚æœå½“å‰ç”¨æˆ·å·²ç‚¹èµï¼Œåˆ™å–æ¶ˆç‚¹èµï¼Œå°†ç”¨æˆ·ä»seté›†åˆä¸­ç§»é™¤\n    } else {\n        // ç‚¹èµæ•° -1\n        boolean success = update().setSql(\"liked = liked - 1\").eq(\"id\", id).update();\n        if (success) {\n            // ä»seté›†åˆç§»é™¤\n            stringRedisTemplate.opsForSet().remove(key, userId.toString());\n        }\n    }\n    return Result.ok();\n}\n```\n\n<a name=\"o9y7Z\"></a>\n\n### ç‚¹èµæ’è¡Œæ¦œ\n\n**éœ€æ±‚èƒŒæ™¯ï¼š** åœ¨æ¢åº—ç¬”è®°çš„è¯¦æƒ…é¡µé¢ï¼Œåº”è¯¥æŠŠç»™è¯¥æ¡ç¬”è®°ç‚¹èµçš„äººæ˜¾ç¤ºå‡ºæ¥ï¼Œä¾‹å¦‚æ˜¾ç¤ºæœ€æ—©ç‚¹èµçš„5ä¸ªäººï¼Œå½¢æˆç‚¹èµæ’è¡Œæ¦œã€‚<br />![55.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_02175bd027-55.png) <br />**è§£å†³æ–¹æ¡ˆï¼š** æˆ‘ä»¬ä¹‹å‰æ˜¯å°†ç‚¹èµçš„äººæ”¾åˆ°`Set`é›†åˆä¸­çš„ï¼Œä½†æ˜¯`Set`å¹¶ä¸æ”¯æŒæ’åºï¼Œæ‰€ä»¥ç°åœ¨éœ€è¦ä¿®æ”¹æˆ`SortedSet(Zset)`ï¼Œåœ¨æ­¤ï¼Œæˆ‘ä»¬é¡ºä¾¿å¯¹æ¯”ä¸€ä¸‹å‡ ç§é›†åˆçš„åŒºåˆ«ï¼š<br />![56.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_059249f627-56.png)\n\n> è¿™é‡Œæœ‰ä¸€ä¸ªå°ç»†èŠ‚ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨Zsetï¼Œé‚£ä¹ˆç‚¹èµåŠŸèƒ½å°±è¦åšç›¸åº”çš„ä¿®æ”¹ï¼Œç”±äºZsetä¸­æ²¡æœ‰SISMEMBERæ–¹æ³•ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡æŸ¥è¯¢åˆ†æ•°æ¥åˆ¤æ–­å…ƒç´ æ˜¯å¦åœ¨é›†åˆä¸­ï¼Œå¦‚æœæŸ¥è¯¢åˆ°åˆ†æ•°ï¼Œåˆ™è¯´æ˜æœ‰è¯¥å…ƒç´ ï¼Œå¦åˆ™è¯¥å…ƒç´ ä¸å­˜åœ¨ã€‚\n\n**Controllerï¼š**\n\n```java\n@GetMapping(\"/likes/{id}\")\npublic Result queryBlogLikes(@PathVariable Integer id) {\n    return blogService.queryBlogLikes(id);\n}\n```\n\n**ServiceImplï¼š**\n\n```java\n@Override\npublic Result queryBlogLikes(Integer id) {\n    String key = BLOG_LIKED_KEY + id;\n    // zrange key 0 4  æŸ¥è¯¢zsetä¸­å‰5ä¸ªå…ƒç´ \n    Set<String> top5 = stringRedisTemplate.opsForZSet().range(key, 0, 4);\n    // å¦‚æœæ˜¯ç©ºçš„(å¯èƒ½æ²¡äººç‚¹èµ)ï¼Œç›´æ¥è¿”å›ä¸€ä¸ªç©ºé›†åˆ\n    if (top5 == null || top5.isEmpty()) {\n        return Result.ok(Collections.emptyList());\n    }\n    List<Long> ids = top5.stream().map(Long::valueOf).collect(Collectors.toList());\n    // å°†idsä½¿ç”¨`,`æ‹¼æ¥ï¼ŒSQLè¯­å¥æŸ¥è¯¢å‡ºæ¥çš„ç»“æœå¹¶ä¸æ˜¯æŒ‰ç…§æˆ‘ä»¬æœŸæœ›çš„æ–¹å¼è¿›è¡Œæ’\n    // æ‰€ä»¥æˆ‘ä»¬éœ€è¦ç”¨order by fieldæ¥æŒ‡å®šæ’åºæ–¹å¼ï¼ŒæœŸæœ›çš„æ’åºæ–¹å¼å°±æ˜¯æŒ‰ç…§æŸ¥è¯¢å‡ºæ¥çš„idè¿›è¡Œæ’åº\n    String idsStr = StrUtil.join(\",\", ids);\n    // SELECT * FROM tb_user WHERE id IN (ids[0], ids[1] ...) ORDER BY FIELD(id, ids[0], ids[1] ...)\n    List<UserDTO> userDTOS = userService.query().in(\"id\", ids)\n            .last(\"order by field(id,\" + idsStr + \")\")\n            .list().stream()\n            .map(user -> BeanUtil.copyProperties(user, UserDTO.class))\n            .collect(Collectors.toList());\n    return Result.ok(userDTOS);\n}\n```\n\n<a name=\"idoe2\"></a>\n\n## å¥½å‹å…³æ³¨\n\n<a name=\"Qo9SR\"></a>\n\n### æŸ¥çœ‹ç”¨æˆ·ç¬”è®°\n\nå½“æˆ‘ä»¬å¯¹æŸä¸ªåšä¸»æ„Ÿå…´è¶£æ—¶ï¼Œä¼šç‚¹è¿›å…¶ä¸»é¡µçœ‹çœ‹å¥¹/ä»–å‘å¸ƒè¿‡å“ªäº›ç¬”è®°ï¼Œä»¥ä¾¿æ·±å…¥äº†è§£ã€‚\n\n```java\n// é€»è¾‘è¾ƒä¸ºç®€å•ï¼Œå°±æ²¡å†™Serviceï¼Œä¸å¤ªå»ºè®®è¿™æ ·å®ç°\n@GetMapping(\"/of/user\")\npublic Result queryBlogByUserId(\n\t\t@RequestParam(value = \"current\", defaultValue = \"1\") Integer current,\n\t\t@RequestParam(\"id\") Long id) {\n\t// æ ¹æ®ç”¨æˆ·æŸ¥è¯¢\n\tPage<Blog> page = blogService.query()\n\t\t\t.eq(\"user_id\", id).page(new Page<>(current, SystemConstants.MAX_PAGE_SIZE));\n\t// è·å–å½“å‰é¡µæ•°æ®\n\tList<Blog> records = page.getRecords();\n\treturn Result.ok(records);\n}\n```\n\n<a name=\"ZjY2P\"></a>\n\n### å…³æ³¨ä¸å–æ¶ˆå…³æ³¨\n\nåœ¨ç”Ÿæ´»ä¸­æœ‰è®¸å¤šåœºæ™¯æ¶‰åŠåˆ°å…³æ³¨ä¸å–æ¶ˆå…³æ³¨ï¼Œæ‰€ä»¥è¯¥åŠŸèƒ½ç”¨å¤„å¹¿æ³›ï¼Œæœ¬å°èŠ‚å°†å®ç°ç”¨æˆ·çš„å…³æ³¨ä¸å–æ¶ˆå…³æ³¨åŠŸèƒ½ã€‚<br />é¦–å…ˆæˆ‘ä»¬æŠ½è±¡å‡ºæ¯ä¸€æ¬¡å…³æ³¨è¡Œä¸ºï¼Œå¹¶è®°å½•åˆ°`follow`è¡¨ä¸­ã€‚`follow`è¡¨ç»“æ„å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š\n\n| Field          | Type            | Collation | Null | Key  | Default           | Extra             | Comment      |\n| -------------- | --------------- | --------- | ---- | ---- | ----------------- | ----------------- | ------------ |\n| id             | bigint          | (NULL)    | NO   | PRI  | (NULL)            | auto_increment    | ä¸»é”®         |\n| user_id        | bigint unsigned | (NULL)    | NO   |      | (NULL)            |                   | ç”¨æˆ·id       |\n| follow_user_id | bigint unsigned | (NULL)    | NO   |      | (NULL)            |                   | å…³è”çš„ç”¨æˆ·id |\n| create_time    | timestamp       | (NULL)    | NO   |      | CURRENT_TIMESTAMP | DEFAULT_GENERATED | åˆ›å»ºæ—¶é—´     |\n\n**`follow`è¡¨å¯¹åº”çš„å®ä½“ç±»ï¼š**\n\n```java\n@Data\n@EqualsAndHashCode(callSuper = false)\n@Accessors(chain = true)\n@TableName(\"tb_follow\")\npublic class Follow implements Serializable {\n\n    private static final long serialVersionUID = 1L;\n\n    /**\n     * ä¸»é”®\n     */\n    @TableId(value = \"id\", type = IdType.AUTO)\n    private Long id;\n\n    /**\n     * ç”¨æˆ·id\n     */\n    private Long userId;\n\n    /**\n     * å…³è”çš„ç”¨æˆ·id\n     */\n    private Long followUserId;\n\n    /**\n     * åˆ›å»ºæ—¶é—´\n     */\n    private LocalDateTime createTime;\n}\n```\n\n**Controllerï¼š**\n\n```java\n// å…³æ³¨\n@PutMapping(\"/{id}/{isFollow}\")\npublic Result follow(@PathVariable(\"id\") Long followUserId, @PathVariable(\"isFollow\") Boolean isFollow) {\n    return followService.follow(followUserId, isFollow);\n}\n// å–æ¶ˆå…³æ³¨\n@GetMapping(\"/or/not/{id}\")\npublic Result isFollow(@PathVariable(\"id\") Long followUserId) {\n      return followService.isFollow(followUserId);\n}\n```\n\n**ServiceImplï¼š**\n\n```java\n// æŸ¥è¯¢æ˜¯å¦å…³æ³¨\n@Override\npublic Result isFollow(Long followUserId) {\n    // 1.è·å–ç™»å½•ç”¨æˆ·\n    Long userId = UserHolder.getUser().getId();\n    // 2.æŸ¥è¯¢æ˜¯å¦å…³æ³¨ select count(*) from tb_follow where user_id = ? and follow_user_id = ?\n    Integer count = query().eq(\"user_id\", userId).eq(\"follow_user_id\", followUserId).count();\n    // 3.åˆ¤æ–­\n    return Result.ok(count > 0);\n}\n\n// å…³æ³¨ä¸å–æ¶ˆå…³æ³¨\n@Override\npublic Result follow(Long followUserId, Boolean isFollow) {\n    // 1.è·å–ç™»å½•ç”¨æˆ·\n    Long userId = UserHolder.getUser().getId();\n    String key = \"follows:\" + userId;\n    // 1.åˆ¤æ–­åˆ°åº•æ˜¯å…³æ³¨è¿˜æ˜¯å–å…³\n    if (isFollow) {\n        // 2.å…³æ³¨ï¼Œæ–°å¢æ•°æ®\n        Follow follow = new Follow();\n        follow.setUserId(userId);\n        follow.setFollowUserId(followUserId);\n        save(follow);\n    } else {\n        // 3.å–å…³ï¼Œåˆ é™¤ delete from tb_follow where user_id = ? and follow_user_id = ?\n        remove(new QueryWrapper<Follow>()\n                .eq(\"user_id\", userId).eq(\"follow_user_id\", followUserId));\n    }\n    return Result.ok();\n}\n```\n\n<a name=\"IdfWM\"></a>\n\n### å…±åŒå…³æ³¨\n\nå½“æˆ‘ä»¬æœ‰äº†å…³æ³¨åŠŸèƒ½åï¼Œæˆ‘ä»¬å»è®¿é—®åˆ«äººä¸»é¡µæ—¶ï¼Œæˆ‘ä»¬è¿˜å¸Œæœ›çœ‹åˆ°å…±åŒå…³æ³¨çš„äººæœ‰å“ªäº›ï¼Œè¿™ä¸ªåŠŸèƒ½åœ¨å¾ˆå¤šå¹³å°ä¹Ÿéƒ½æœ‰å¹¿æ³›åº”ç”¨ã€‚é‚£ä¹ˆæˆ‘ä»¬è¯¥æ€ä¹ˆå»å®ç°è¿™ä¸ªåŠŸèƒ½å‘¢ï¼Ÿ<br />**å…±åŒå…³æ³¨å®ç°æ–¹æ¡ˆï¼š**<br />åœ¨Redisä¸­æœ‰Setè¿™æ ·çš„æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡`INTERSECT`å‘½ä»¤å¿«é€Ÿæ±‚å‡ºä¸¤ä¸ªé›†åˆçš„äº¤é›†ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å°†é‡‡ç”¨è¿™ä¸ªæ•°æ®ç»“æ„å®ç°å…±åŒå…³æ³¨åŠŸèƒ½ã€‚\n\n> ä¸Šä¸€å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å®ç°å…³æ³¨ä¸å–æ¶ˆå…³æ³¨æ—¶å¹¶æ²¡æœ‰ä½¿ç”¨Redisï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿®æ”¹ä¸€ä¸‹ä»£ç ï¼Œç»´æŠ¤å¥½Seté›†ã€‚\n\n**ä¿®æ”¹å…³æ³¨ä¸å–æ¶ˆå…³æ³¨ï¼š**\n\n```java\n@Resource\nprivate StringRedisTemplate stringRedisTemplate;\n\n@Override\npublic Result follow(Long followUserId, Boolean isFellow) {\n    // è·å–å½“å‰ç”¨æˆ·id\n    Long userId = UserHolder.getUser().getId();\n    String key = \"follows:\" + userId;\n    // åˆ¤æ–­æ˜¯å¦å…³æ³¨\n    if (isFellow) {\n        // å…³æ³¨ï¼Œåˆ™å°†ä¿¡æ¯ä¿å­˜åˆ°æ•°æ®åº“\n        Follow follow = new Follow();\n        follow.setUserId(userId);\n        follow.setFollowUserId(followUserId);\n        // å¦‚æœä¿å­˜æˆåŠŸ\n        boolean success = save(follow);\n        // åˆ™å°†æ•°æ®ä¹Ÿå†™å…¥Redis\n        if (success) {\n            stringRedisTemplate.opsForSet().add(key, followUserId.toString());\n        }\n    } else {\n        // å–å…³ï¼Œåˆ™å°†æ•°æ®ä»æ•°æ®åº“ä¸­ç§»é™¤\n        LambdaQueryWrapper<Follow> queryWrapper = new LambdaQueryWrapper<>();\n        queryWrapper.eq(Follow::getUserId, userId).eq(Follow::getFollowUserId, followUserId);\n        // å¦‚æœå–å…³æˆåŠŸ\n        boolean success = remove(queryWrapper);\n        // åˆ™å°†æ•°æ®ä¹Ÿä»Redisä¸­ç§»é™¤\n        if (success) {\n            stringRedisTemplate.opsForSet().remove(key,followUserId.toString());\n        }\n    }\n    return Result.ok();\n}\n```\n\n**å…±åŒå…³æ³¨Controllerï¼š**\n\n```java\n@GetMapping(\"/common/{id}\")\npublic Result followCommons(@PathVariable Long id) {\n    return followService.followCommons(id);\n}\n```\n\n**å…±åŒå…³æ³¨ServiceImplï¼š**\n\n```java\n@Override\npublic Result followCommons(Long id) {\n    // è·å–å½“å‰ç”¨æˆ·id\n    Long userId = UserHolder.getUser().getId();\n    String key1 = \"follows:\" + id;\n    String key2 = \"follows:\" + userId;\n    // å¯¹å½“å‰ç”¨æˆ·å’Œåšä¸»ç”¨æˆ·çš„å…³æ³¨åˆ—è¡¨å–äº¤é›†\n    Set<String> intersect = stringRedisTemplate.opsForSet().intersect(key1, key2);\n    if (intersect == null || intersect.isEmpty()) {\n        // æ— äº¤é›†å°±è¿”å›ä¸ªç©ºé›†åˆ\n        return Result.ok(Collections.emptyList());\n    }\n    // å°†ç»“æœè½¬ä¸ºlist\n    List<Long> ids = intersect.stream().map(Long::valueOf).collect(Collectors.toList());\n    // ä¹‹åæ ¹æ®idså»æŸ¥è¯¢å…±åŒå…³æ³¨çš„ç”¨æˆ·ï¼Œå°è£…æˆUserDtoå†è¿”å›\n    List<UserDTO> userDTOS = userService.listByIds(ids).stream().map(user ->\n            BeanUtil.copyProperties(user, UserDTO.class)).collect(Collectors.toList());\n    return Result.ok(userDTOS);\n}\n```\n\n<a name=\"CxknG\"></a>\n\n### Feedæµ\n\n<a name=\"KksSu\"></a>\n\n#### Feedæµç®€ä»‹\n\n**å¯¹äºä¼ ç»Ÿçš„æ¨¡å¼å†…å®¹æ£€ç´¢**ï¼šç”¨æˆ·éœ€è¦ä¸»åŠ¨é€šè¿‡æœç´¢å¼•æ“æˆ–è€…æ˜¯å…¶ä»–æ–¹å¼å»æŸ¥æ‰¾æƒ³çœ‹çš„å†…å®¹<br />å½“æˆ‘ä»¬å…³æ³¨äº†ç”¨æˆ·ä¹‹åï¼Œè¿™ä¸ªç”¨æˆ·å‘å¸ƒäº†åŠ¨æ€ï¼Œé‚£æˆ‘ä»¬åº”è¯¥æŠŠè¿™äº›æ•°æ®æ¨é€ç»™ç”¨æˆ·ï¼Œè¿™ä¸ªéœ€æ±‚ï¼Œæˆ‘ä»¬åˆç§°å…¶ä¸ºFeedæµï¼Œå…³æ³¨æ¨é€ä¹Ÿå«ä½œ**Feedæµ**ï¼Œç›´è¯‘ä¸ºæŠ•å–‚ï¼Œä¸ºç”¨æˆ·æä¾›æ²‰æµ¸å¼ä½“éªŒï¼Œé€šè¿‡æ— é™ä¸‹æ‹‰åˆ·æ–°è·å–æ–°çš„ä¿¡æ¯ã€‚<br />**å¯¹äºæ–°å‹Feedæµçš„æ•ˆæœ**ï¼šç³»ç»Ÿåˆ†æç”¨æˆ·åˆ°åº•æƒ³çœ‹ä»€ä¹ˆï¼Œç„¶åç›´æ¥æŠŠå†…å®¹æ¨é€ç»™ç”¨æˆ·ï¼Œä»è€Œä½¿ç”¨æˆ·èƒ½æ›´åŠ èŠ‚çº¦æ—¶é—´ï¼Œä¸ç”¨å»ä¸»åŠ¨æœç´ ã€‚\n<a name=\"UyCii\"></a>\n\n#### Feedæµå®ç°æ–¹æ¡ˆ\n\nFeedæµçš„å®ç°æœ‰ä¸¤ç§æ¨¡å¼ï¼š<br />**Timelineï¼š** ä¸åšå†…å®¹ç­›é€‰ï¼Œç®€å•çš„æŒ‰ç…§å†…å®¹å‘å¸ƒæ—¶é—´æ’åºï¼Œå¸¸ç”¨äºå¥½å‹æˆ–å…³æ³¨(æœ‹å‹åœˆå°±æ˜¯åŸºäºæ­¤ç§æ–¹å¼å®ç°)\n\n- ä¼˜ç‚¹ï¼šä¿¡æ¯å…¨é¢ï¼Œä¸ä¼šæœ‰ç¼ºå¤±ï¼Œå¹¶ä¸”å®ç°ä¹Ÿç›¸å¯¹ç®€å•\n- ç¼ºç‚¹ï¼šä¿¡æ¯å™ªéŸ³è¾ƒå¤šï¼Œç”¨æˆ·ä¸ä¸€å®šæ„Ÿå…´è¶£ï¼Œå†…å®¹è·å–æ•ˆç‡ä½\n\n**æ™ºèƒ½æ’åºï¼š** åˆ©ç”¨æ™ºèƒ½ç®—æ³•å±è”½æ‰è¿è§„çš„ã€ç”¨æˆ·ä¸æ„Ÿå…´è¶£çš„å†…å®¹ï¼Œæ¨é€ç”¨æˆ·æ„Ÿå…´è¶£çš„ä¿¡æ¯æ¥å¸å¼•ç”¨æˆ·\n\n- ä¼˜ç‚¹ï¼šæŠ•å–‚ç”¨æˆ·æ„Ÿå…´è¶£çš„ä¿¡æ¯ï¼Œç”¨æˆ·ç²˜åº¦å¾ˆé«˜ï¼Œå®¹æ˜“æ²‰è¿·\n- ç¼ºç‚¹ï¼šå¦‚æœç®—æ³•ä¸ç²¾å‡†ï¼Œå¯èƒ½ä¼šèµ·åˆ°åä½œç”¨\n\n**ç”±äºæˆ‘ä»¬é’ˆå¯¹çš„æ˜¯å¥½å‹å…³æ³¨å…³ç³»çš„æ¨é€ï¼Œå› æ­¤é‡‡ç”¨Timelineæ–¹å¼ï¼šæ‹¿åˆ°å…³æ³¨çš„ç”¨æˆ·çš„åšå®¢ï¼Œç„¶åæŒ‰ç…§æ—¶é—´æ’åºã€‚**<br />**Timelineæ¨¡å¼çš„ä¸‰ç§å®ç°æ–¹æ¡ˆï¼š**\n\n- æ‹‰æ¨¡å¼ï¼ˆè¯»æ‰©æ•£ï¼‰\n- æ¨æ¨¡å¼ï¼ˆå†™æ‰©æ•£ï¼‰\n- æ¨æ‹‰ç»“åˆ\n\n**æ‹‰æ¨¡å¼ï¼š**\n\n- è¯¥æ¨¡å¼çš„æ ¸å¿ƒå«ä¹‰æ˜¯ï¼šå½“å¼ ä¸‰å’Œæå››ã€ç‹äº”å‘äº†æ¶ˆæ¯ä¹‹åï¼Œéƒ½ä¼šä¿å­˜åˆ°è‡ªå·±çš„å‘ä»¶ç®±ä¸­ï¼Œå¦‚æœèµµå…­è¦è¯»å–æ¶ˆæ¯ï¼Œé‚£ä¹ˆä»–ä¼šè¯»å–ä»–è‡ªå·±çš„æ”¶ä»¶ç®±ï¼Œæ­¤æ—¶ç³»ç»Ÿä¼šä»ä»–å…³æ³¨çš„äººç¾¤ä¸­ï¼Œå°†ä»–å…³æ³¨äººçš„ä¿¡æ¯å…¨éƒ½è¿›è¡Œæ‹‰å–ï¼Œç„¶åè¿›è¡Œæ’åº\n- ä¼˜ç‚¹ï¼šæ¯”è¾ƒèŠ‚çº¦ç©ºé—´ï¼Œå› ä¸ºèµµå…­åœ¨è¯»å–ä¿¡æ¯æ—¶ï¼Œå¹¶æ²¡æœ‰é‡å¤è¯»å–ï¼Œå¹¶ä¸”è¯»å–å®Œä¹‹åï¼Œå¯ä»¥å°†ä»–çš„æ”¶ä»¶ç®±æ¸…é™¤\n- ç¼ºç‚¹ï¼šæœ‰å»¶è¿Ÿï¼Œå½“ç”¨æˆ·è¯»å–æ•°æ®æ—¶ï¼Œæ‰ä¼šå»å…³æ³¨çš„äººçš„æ—¶å‘ä»¶ç®±ä¸­æ‹‰å–ä¿¡æ¯ï¼Œå‡è®¾è¯¥ç”¨æˆ·å…³æ³¨äº†æµ·é‡ç”¨æˆ·ï¼Œé‚£ä¹ˆæ­¤æ—¶å°±ä¼šæ‹‰å–å¾ˆå¤šä¿¡æ¯ï¼Œå¯¹æœåŠ¡å™¨å‹åŠ›å·¨å¤§\n\n![57.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_07e1300627-57.png)<br />**æ¨æ¨¡å¼ï¼š**\n\n- æ¨æ¨¡å¼æ˜¯æ²¡æœ‰å†™é‚®ç®±çš„ï¼Œå½“å¼ ä¸‰å†™äº†ä¸€ä¸ªå†…å®¹ï¼Œæ­¤æ—¶ä¼šä¸»åŠ¨æŠŠå¼ ä¸‰å†™çš„å†…å®¹å‘é€åˆ°å®ƒç²‰ä¸çš„æ”¶ä»¶ç®±ä¸­ï¼Œå‡è®¾æ­¤æ—¶æå››å†æ¥è¯»å–ï¼Œå°±ä¸ç”¨å†å»ä¸´æ—¶æ‹‰å–äº†\n- ä¼˜ç‚¹ï¼šæ—¶æ•ˆå¿«ï¼Œä¸ç”¨ä¸´æ—¶æ‹‰å–\n- ç¼ºç‚¹ï¼šå†…å­˜å‹åŠ›å¤§ï¼Œå‡è®¾ä¸€ä¸ªå¤§Vå‘äº†ä¸€ä¸ªåŠ¨æ€ï¼Œå¾ˆå¤šäººå…³æ³¨ä»–ï¼Œé‚£ä¹ˆå°±ä¼šå†™å¾ˆå¤šä»½æ•°æ®åˆ°ç²‰ä¸é‚£è¾¹å»\n\n![58.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_0ad816de27-58.png) <br />**æ¨æ‹‰ç»“åˆï¼š**<br />æ¨æ‹‰æ¨¡å¼æ˜¯ä¸€ä¸ªæŠ˜ä¸­çš„æ–¹æ¡ˆï¼Œç«™åœ¨å‘ä»¶äººè¿™ä¸€è¾¹ï¼Œå¦‚æœæ˜¯æ™®é€šäººï¼Œé‚£ä¹ˆæˆ‘ä»¬é‡‡ç”¨å†™æ‰©æ•£çš„æ–¹å¼ï¼Œç›´æ¥æŠŠæ•°æ®å†™å…¥åˆ°ä»–çš„ç²‰ä¸æ”¶ä»¶ç®±ä¸­ï¼Œå› ä¸ºæ™®é€šäººçš„ç²‰ä¸æ•°é‡è¾ƒå°‘ï¼Œæ‰€ä»¥è¿™æ ·ä¸ä¼šäº§ç”Ÿå¤ªå¤§å‹åŠ›ã€‚ä½†å¦‚æœæ˜¯å¤§Vï¼Œé‚£ä¹ˆä»–æ˜¯ç›´æ¥å°†æ•°æ®å†™å…¥ä¸€ä»½åˆ°å‘ä»¶ç®±ä¸­å»ï¼Œåœ¨ç›´æ¥å†™ä¸€ä»½åˆ°æ´»è·ƒç²‰ä¸çš„æ”¶ä»¶ç®±ä¸­ï¼Œç«™åœ¨æ”¶ä»¶äººè¿™è¾¹æ¥çœ‹ï¼Œå¦‚æœæ˜¯æ´»è·ƒç²‰ä¸ï¼Œé‚£ä¹ˆå¤§Vå’Œæ™®é€šäººå‘çš„éƒ½ä¼šå†™åˆ°è‡ªå·±çš„æ”¶ä»¶ç®±é‡Œï¼Œä½†å¦‚æœæ˜¯æ™®é€šç²‰ä¸ï¼Œç”±äºä¸Šçº¿ä¸æ˜¯å¾ˆé¢‘ç¹ï¼Œæ‰€ä»¥ç­‰ä»–ä»¬ä¸Šçº¿çš„æ—¶å€™ï¼Œå†ä»å‘ä»¶ç®±ä¸­å»æ‹‰å–ä¿¡æ¯ã€‚<br />![59.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_0e6cb81b27-59.png) <br />**Timelineçš„ä¸‰ç§å®ç°æ–¹å¼å¯¹æ¯”ï¼š**<br />![60.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_10d2d93827-60.png)<br />ç»¼ä¸Šï¼Œæˆ‘ä»¬å°†é‡‡ç”¨**Timeline**æ–¹å¼çš„**æ¨æ¨¡å¼**å®ç°å·²å…³æ³¨æ¨é€åŠŸèƒ½ã€‚\n<a name=\"FGbCt\"></a>\n\n### åŸºäºæ¨æ¨¡å¼å®ç°æ¨é€åŠŸèƒ½\n\n<a name=\"UnYLy\"></a>\n\n#### éœ€æ±‚åŠæ€è·¯åˆ†æ\n\næœ¬å°èŠ‚éœ€æ±‚ï¼š\n\n- ä¿®æ”¹æ–°å¢æ¢åº—ç¬”è®°çš„ä¸šåŠ¡ï¼Œåœ¨ä¿å­˜blogåˆ°æ•°æ®åº“çš„åŒæ—¶ï¼Œæ¨é€åˆ°ç²‰ä¸çš„æ”¶ä»¶ç®±ï¼ˆå·²å…³æ³¨ç”¨æˆ·çš„åšå®¢ï¼‰\n- æ”¶ä»¶ç®±æ»¡è¶³å¯ä»¥æ ¹æ®æ—¶é—´æˆ³æ’åºï¼ˆä½¿ç”¨Rediså®ç°ï¼‰\n- ç”¨æˆ·æŸ¥çœ‹å·²å…³æ³¨æ”¶ä»¶ç®±æ—¶ï¼Œåšåˆ°åˆ†é¡µæŸ¥è¯¢\n\n**æœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹**ï¼Œæˆ‘ä»¬ä¸èƒ½é‡‡ç”¨ä¼ ç»Ÿçš„åˆ†é¡µæŸ¥è¯¢æ¨¡å¼ã€‚ä¾‹å¦‚ï¼Œåœ¨ç¬¬ä¸€æ¬¡æŸ¥è¯¢ç”¨æˆ·æ”¶ä»¶ç®±ä¹‹åï¼Œå¯èƒ½æŸä¸€ä¸ªå…³æ³¨çš„ç”¨æˆ·çªç„¶æ›´æ–°ä¸€æ¡åšå®¢ï¼Œæˆ‘ä»¬å¦‚æœç»§ç»­æŒ‰ç…§ä¸‹æ ‡æŸ¥è¯¢ç¬¬äºŒé¡µï¼Œå°±ä¼šé‡å¤æŸ¥è¯¢åˆ°ç¬¬ä¸€é¡µçš„æœ€åä¸€æ¡è®°å½•ã€‚<br />![61.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_13de573927-61.png) <br />é‚£ä¹ˆæ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿæˆ‘ä»¬ä½¿ç”¨**æ»šåŠ¨åˆ†é¡µæŸ¥è¯¢**å³å¯ã€‚\n\n- æˆ‘ä»¬éœ€è¦è®°å½•æ¯æ¬¡æ“ä½œçš„æœ€åä¸€æ¡ï¼Œç„¶åä»è¿™ä¸ªä½ç½®å»å¼€å§‹è¯»æ•°æ®\n- ä¸¾ä¸ªä¾‹å­ï¼šæˆ‘ä»¬ä»t1æ—¶åˆ»å¼€å§‹ï¼Œæ‹¿åˆ°ç¬¬ä¸€é¡µæ•°æ®ï¼Œæ‹¿åˆ°äº†10~6ï¼Œç„¶åè®°å½•ä¸‹å½“å‰æœ€åä¸€æ¬¡è¯»å–çš„è®°å½•ï¼Œå°±æ˜¯6ï¼Œt2æ—¶åˆ»å‘å¸ƒäº†æ–°çºªå½•ï¼Œæ­¤æ—¶è¿™ä¸ª11åœ¨æœ€ä¸Šé¢ï¼Œä½†ä¸ä¼šå½±å“æˆ‘ä»¬ä¹‹å‰æ‹¿åˆ°çš„6ï¼Œæ­¤æ—¶t3æ—¶åˆ»æ¥è¯»å–ç¬¬äºŒé¡µï¼Œç¬¬äºŒé¡µè¯»æ•°æ®çš„æ—¶å€™ï¼Œä»6-1=5å¼€å§‹è¯»ï¼Œè¿™æ ·å°±æ‹¿åˆ°äº†5~1çš„è®°å½•ã€‚æˆ‘ä»¬åœ¨è¿™ä¸ªåœ°æ–¹å¯ä»¥ä½¿ç”¨SortedSetæ¥åšï¼Œä½¿ç”¨æ—¶é—´æˆ³æ¥å……å½“è¡¨ä¸­çš„1~10\n\n![62.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_162a288a27-62.png)\n<a name=\"nZiQc\"></a>\n\n#### è¡¥å……å‘å¸ƒåšå®¢ä»£ç \n\nç”±äºä¹‹å‰æœªä»‹ç»åˆ°å‘é€åšå®¢åŠŸèƒ½ï¼Œæœ¬å°èŠ‚ç»“åˆæ¨é€åŠŸèƒ½ï¼Œå¯¹å‘é€åšå®¢ä»£ç è¿›è¡Œä¹¦å†™å’Œå®Œå–„ã€‚\n\n```java\n@Override\npublic Result saveBlog(Blog blog) {\n    // è·å–ç™»å½•ç”¨æˆ·\n    UserDTO user = UserHolder.getUser();\n    blog.setUserId(user.getId());\n    // ä¿å­˜æ¢åº—åšæ–‡\n    save(blog);\n    // æ¡ä»¶æ„é€ å™¨\n    LambdaQueryWrapper<Follow> queryWrapper = new LambdaQueryWrapper<>();\n    // ä»followè¡¨æœ€ä¸­ï¼ŒæŸ¥æ‰¾å½“å‰ç”¨æˆ·çš„ç²‰ä¸  select * from follow where follow_user_id = user_id\n    queryWrapper.eq(Follow::getFollowUserId, user.getId());\n    // è·å–å½“å‰ç”¨æˆ·çš„ç²‰ä¸\n    List<Follow> follows = followService.list(queryWrapper);\n    for (Follow follow : follows) {\n        Long userId = follow.getUserId();\n        String key = FEED_KEY + userId;\n        // æ¨é€æ•°æ®\n        stringRedisTemplate.opsForZSet().add(key, blog.getId().toString(), System.currentTimeMillis());\n    }\n    // è¿”å›id\n    return Result.ok(blog.getId());\n}\n```\n\n<a name=\"lHCuM\"></a>\n\n#### å®ç°åˆ†é¡µæŸ¥è¯¢æ”¶ä»¶ç®±\n\næœ¬å°èŠ‚å°†å®ç°åœ¨ä¸ªäººä¸»é¡µçš„å…³æ³¨æ ä¸­æŸ¥è¯¢å¹¶å±•ç¤ºæ¨é€çš„åšå®¢ä¿¡æ¯ã€‚<br />**å®ç°æ­¥éª¤ï¼š**\n\n- ç¼–å†™ä¸€ä¸ªé€šç”¨çš„åˆ†é¡µç±»\n- æ ¹æ®å‚æ•°è¿›è¡ŒæŸ¥è¯¢\n- æ¯æ¬¡æŸ¥è¯¢å®Œæˆä¹‹åï¼Œæˆ‘ä»¬è¦åˆ†æå‡ºæŸ¥è¯¢å‡ºçš„æœ€å°æ—¶é—´æˆ³ï¼Œè¿™ä¸ªå€¼ä¼šä½œä¸ºä¸‹ä¸€æ¬¡çš„æŸ¥è¯¢æ¡ä»¶ï¼ˆè®¡ç®—`lastId`ï¼‰\n- æˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸ä¸Šä¸€æ¬¡æŸ¥è¯¢ç›¸åŒçš„æŸ¥è¯¢ä¸ªæ•°ï¼Œå¹¶ä½œä¸ºåç§»é‡ï¼Œä¸‹æ¬¡æŸ¥è¯¢çš„æ—¶å€™ï¼Œè·³è¿‡è¿™äº›æŸ¥è¯¢è¿‡çš„æ•°æ®ï¼Œæ‹¿åˆ°æˆ‘ä»¬éœ€è¦çš„æ•°æ®ï¼ˆè®¡ç®—`offset`ï¼‰\n\n> æˆ‘ä»¬çš„è¯·æ±‚å‚æ•°ä¸­éœ€è¦æºå¸¦`lastId`å’Œ`offset`ï¼Œå³ä¸Šä¸€æ¬¡æŸ¥è¯¢æ—¶çš„æœ€å°æ—¶é—´æˆ³å’Œåç§»é‡ï¼Œé™¤äº†ç¬¬ä¸€æ¬¡ï¼Œåé¢çš„æ¯ä¸€æ¬¡æŸ¥è¯¢çš„å‚æ•°ä¼šç”±å‰ä¸€æ¬¡æŸ¥è¯¢è®¡ç®—å‡º\n\n**ç¼–å†™é€šç”¨çš„åˆ†é¡µæŸ¥è¯¢ç»“æœç±»ï¼š**\n\n```java\n@Data\npublic class ScrollResult {\n    // ä¸ºäº†è¾¾åˆ°é€šç”¨çš„æ•ˆæœï¼Œæˆ‘ä»¬ä½¿ç”¨æ³›å‹ï¼Œè¿™æ ·ä¹Ÿèƒ½ç”¨äºæŸ¥è¯¢åšå®¢æ„å¤–çš„æ•°æ®\n    private List<?> list;\n    private Long minTime;\n    private Integer offset;\n}\n```\n\n**Controllerï¼š**\n\n```java\n@GetMapping(\"/of/follow\")\npublic Result queryBlogOfFollow(@RequestParam(\"lastId\") Long max, @RequestParam(value = \"offset\",defaultValue = \"0\") Integer offset) {\n    return blogService.queryBlogOfFollow(max, offset);\n}\n```\n\n**ServiceImplï¼š**\n\n```java\n@Override\npublic Result queryBlogOfFollow(Long max, Integer offset) {\n    // 1. è·å–å½“å‰ç”¨æˆ·\n    Long userId = UserHolder.getUser().getId();\n    // 2. æŸ¥è¯¢è¯¥ç”¨æˆ·æ”¶ä»¶ç®±ï¼ˆä¹‹å‰æˆ‘ä»¬å­˜çš„keyæ˜¯å›ºå®šå‰ç¼€ + ç²‰ä¸idï¼‰ï¼Œæ‰€ä»¥æ ¹æ®å½“å‰ç”¨æˆ·idå°±å¯ä»¥æŸ¥è¯¢æ˜¯å¦æœ‰å…³æ³¨çš„äººå‘äº†ç¬”è®°\n    String key = FEED_KEY + userId;\n    Set<ZSetOperations.TypedTuple<String>> typeTuples = stringRedisTemplate.opsForZSet()\n            .reverseRangeByScoreWithScores(key, 0, max, offset, 2);\n    // 3. éç©ºåˆ¤æ–­\n    if (typeTuples == null || typeTuples.isEmpty()) {\n        return Result.ok(Collections.emptyList());\n    }\n    // 4. è§£ææ•°æ®ï¼ŒblogIdã€minTimeï¼ˆæ—¶é—´æˆ³ï¼‰ã€offsetï¼Œè¿™é‡ŒæŒ‡å®šåˆ›å»ºçš„listå¤§å°ï¼Œå¯ä»¥ç•¥å¾®æé«˜æ•ˆç‡ï¼Œå› ä¸ºæˆ‘ä»¬çŸ¥é“è¿™ä¸ªlistå°±å¾—æ˜¯è¿™ä¹ˆå¤§\n    ArrayList<Long> ids = new ArrayList<>(typeTuples.size());\n    long minTime = 0;\n    int os = 1;\n    for (ZSetOperations.TypedTuple<String> typeTuple : typeTuples) {\n        // 4.1 è·å–id\n        String id = typeTuple.getValue();\n        ids.add(Long.valueOf(id));\n        // 4.2 è·å–scoreï¼ˆæ—¶é—´æˆ³ï¼‰\n        long time = typeTuple.getScore().longValue();\n        if (time == minTime) {\n            os ++;\n        }else {\n            minTime = time;\n            os = 1;\n        }\n    }\n    // è§£å†³SQLçš„inä¸èƒ½æ’åºé—®é¢˜ï¼Œæ‰‹åŠ¨æŒ‡å®šæ’åºä¸ºä¼ å…¥çš„ids\n    String idsStr = StrUtil.join(\",\");\n    // 5. æ ¹æ®idæŸ¥è¯¢blog\n    List<Blog> blogs = query().in(\"id\", ids).last(\"ORDER BY FIELD(id, \" + idsStr + \")\").list()\n    for (Blog blog : blogs) {\n        // 5.1 æŸ¥è¯¢å‘å¸ƒè¯¥blogçš„ç”¨æˆ·ä¿¡æ¯\n        queryBlogUser(blog);\n        // 5.2 æŸ¥è¯¢å½“å‰ç”¨æˆ·æ˜¯å¦ç»™è¯¥blogç‚¹è¿‡èµ\n        isBlogLiked(blog);\n    }\n    // 6. å°è£…ç»“æœå¹¶è¿”å›\n    ScrollResult scrollResult = new ScrollResult();\n    scrollResult.setList(blogs);\n    scrollResult.setOffset(os);\n    scrollResult.setMinTime(minTime);\n    return Result.ok(scrollResult);\n}\n```\n\n<a name=\"rAd4M\"></a>\n\n## é™„è¿‘å•†æˆ·\n\n<a name=\"NOgGD\"></a>\n\n### GEOæ•°æ®ç»“æ„\n\nGEOå°±æ˜¯Geolocationçš„ç®€å†™å½¢å¼ï¼Œä»£è¡¨åœ°ç†åæ ‡ã€‚Redisåœ¨3.2ç‰ˆæœ¬ä¸­åŠ å…¥äº†å¯¹GEOçš„æ”¯æŒï¼Œå…è®¸å­˜å‚¨åœ°ç†åæ ‡ä¿¡æ¯ï¼Œå¸®åŠ©æˆ‘ä»¬æ ¹æ®ç»çº¬åº¦æ¥æ£€ç´¢æ•°æ®ï¼Œå¸¸è§çš„å‘½ä»¤æœ‰ï¼š\n\n- `GEOADD`ï¼šæ·»åŠ ä¸€ä¸ªåœ°ç†ç©ºé—´ä¿¡æ¯ï¼ŒåŒ…å«ï¼šç»åº¦ï¼ˆlongitudeï¼‰ã€çº¬åº¦ï¼ˆlatitudeï¼‰ã€å€¼ï¼ˆmemberï¼‰\n- `GEODIST`ï¼šè®¡ç®—æŒ‡å®šçš„ä¸¤ä¸ªç‚¹ä¹‹é—´çš„è·ç¦»å¹¶è¿”å›\n- `GEOHASH`ï¼šå°†æŒ‡å®šmemberçš„åæ ‡è½¬ä¸ºhashå­—ç¬¦ä¸²å½¢å¼å¹¶è¿”å›\n- `GEOPOS`ï¼šè¿”å›æŒ‡å®šmemberçš„åæ ‡\n- `GEORADIUS`ï¼ˆ6.2ä»¥åå·²åºŸå¼ƒï¼‰ï¼šæŒ‡å®šåœ†å¿ƒã€åŠå¾„ï¼Œæ‰¾åˆ°è¯¥åœ†å†…åŒ…å«çš„æ‰€æœ‰memberï¼Œå¹¶æŒ‰ç…§ä¸åœ†å¿ƒä¹‹é—´çš„è·ç¦»æ’åºåè¿”å›ã€‚\n- `GEOSEARCH`ï¼ˆ6.2.æ–°åŠŸèƒ½ï¼‰ï¼šåœ¨æŒ‡å®šèŒƒå›´å†…æœç´¢memberï¼Œå¹¶æŒ‰ç…§ä¸æŒ‡å®šç‚¹ä¹‹é—´çš„è·ç¦»æ’åºåè¿”å›ã€‚èŒƒå›´å¯ä»¥æ˜¯åœ†å½¢æˆ–çŸ©å½¢ã€‚\n- `GEOSEARCHSTORE`ï¼ˆ6.2.æ–°åŠŸèƒ½ï¼‰ï¼šä¸`GEOSEARCH`åŠŸèƒ½ä¸€è‡´ï¼Œä¸è¿‡å¯ä»¥æŠŠç»“æœå­˜å‚¨åˆ°ä¸€ä¸ªæŒ‡å®šçš„`key`ã€‚\n  <a name=\"VkBV5\"></a>\n\n### å¯¼å…¥åº—é“ºæ•°æ®åˆ°Redis-GEO\n\nå…·ä½“åœºæ™¯è¯´æ˜ï¼Œä¾‹å¦‚ç¾å›¢/é¥¿äº†ä¹ˆè¿™ç§å¤–å–Appï¼Œä½ æ˜¯å¯ä»¥çœ‹åˆ°å•†å®¶ç¦»ä½ æœ‰å¤šè¿œçš„ï¼Œé‚£æˆ‘ä»¬ç°åœ¨ä¹Ÿè¦å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚<br />æˆ‘ä»¬å¯ä»¥ä½¿ç”¨GEOæ¥å®ç°è¯¥åŠŸèƒ½ï¼Œä»¥å½“å‰åæ ‡ä¸ºåœ†å¿ƒï¼ŒåŒæ—¶ç»‘å®šç›¸åŒçš„åº—å®¶ç±»å‹typeï¼Œä»¥åŠåˆ†é¡µä¿¡æ¯ï¼ŒæŠŠè¿™å‡ ä¸ªæ¡ä»¶æ’å…¥åå°ï¼Œåå°æŸ¥è¯¢å‡ºå¯¹åº”çš„æ•°æ®å†è¿”å›ã€‚<br />**é‚£ç°åœ¨æˆ‘ä»¬è¦åšçš„å°±æ˜¯**ï¼šå°†æ•°æ®åº“ä¸­çš„æ•°æ®å¯¼å…¥åˆ°Redisä¸­å»ï¼ŒGEOåœ¨Redisä¸­å°±æ˜¯ä¸€ä¸ªmemberå’Œä¸€ä¸ªç»çº¬åº¦ï¼Œç»çº¬åº¦å¯¹åº”çš„å°±æ˜¯tb_shopä¸­çš„`x`å’Œ`y`ï¼Œè€Œmemberï¼Œæˆ‘ä»¬ç”¨shop_idæ¥å­˜ï¼Œå› ä¸ºRedisåªæ˜¯ä¸€ä¸ªå†…å­˜çº§æ•°æ®åº“ï¼Œå¦‚æœå­˜æµ·é‡çš„æ•°æ®ï¼Œè¿˜æ˜¯åŠ›ä¸ä»å¿ƒï¼Œæ‰€ä»¥æˆ‘ä»¬åªå­˜ä¸€ä¸ªidï¼Œç”¨çš„æ—¶å€™å†æ‹¿idå»SQLæ•°æ®åº“ä¸­æŸ¥è¯¢shopä¿¡æ¯ã€‚<br />ä½†æ˜¯æ­¤æ—¶è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬åœ¨redisä¸­æ²¡æœ‰å­˜å‚¨shop_typeï¼Œæ— æ³•æ ¹æ®åº—é“ºç±»å‹æ¥å¯¹æ•°æ®è¿›è¡Œç­›é€‰ï¼Œè§£å†³åŠæ³•å°±æ˜¯**å°†type_idä½œä¸ºkeyï¼Œå­˜å…¥åŒä¸€ä¸ªGEOé›†åˆå³å¯**<br />![63.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_1874fdb627-63.png)<br />**ä»£ç å®ç°ï¼š**\n\n```java\n@Test\npublic void loadShopData() {\n    List<Shop> shopList = shopService.list();\n    Map<Long, List<Shop>> map = shopList.stream().collect(Collectors.groupingBy(Shop::getTypeId));\n    // å¤„ç†æ¯ä¸€ä¸ªç±»åˆ«\n    for (Map.Entry<Long, List<Shop>> entry : map.entrySet()) {\n        Long typeId = entry.getKey();\n        List<Shop> shops = entry.getValue();\n        String key = SHOP_GEO_KEY + typeId;\n        List<RedisGeoCommands.GeoLocation<String>> locations = new ArrayList<>(shops.size());\n        // å¤„ç†æ¯ä¸€ä¸ªç±»åˆ«ä¸­çš„æ‰€æœ‰åº—é“º\n        for (Shop shop : shops) {\n            // å°†å½“å‰typeçš„å•†é“ºéƒ½æ·»åŠ åˆ°locationsé›†åˆä¸­\n            locations.add(new RedisGeoCommands.GeoLocation<>(shop.getId().toString(), new Point(shop.getX(), shop.getY())));\n        }\n        // æ‰¹é‡å†™å…¥\n        stringRedisTemplate.opsForGeo().add(key, locations);\n    }\n}\n```\n\n<a name=\"c5k2d\"></a>\n\n### å®ç°æŸ¥è¯¢é™„è¿‘å•†æˆ·åŠŸèƒ½\n\nåœ¨å®ç°ä¹‹å‰è¿˜æœ‰ä¸€ä¸ªæ³¨æ„çš„åœ°æ–¹ï¼Œç”±äº`GEOSEARCH`æ˜¯Redis 6.2æ‰æä¾›çš„ï¼Œå› æ­¤å¦‚æœSpringDataRedisç‰ˆæœ¬è¾ƒä½ï¼Œåˆ™éœ€è¦ä¿®æ”¹`pom.xml`æ–‡ä»¶ï¼š\n\n```xml\n<dependency>\n    <groupId>org.springframework.boot</groupId>\n    <artifactId>spring-boot-starter-data-redis</artifactId>\n    <exclusions>\n        <exclusion>\n            <artifactId>spring-data-redis</artifactId>\n            <groupId>org.springframework.data</groupId>\n        </exclusion>\n        <exclusion>\n            <artifactId>lettuce-core</artifactId>\n            <groupId>io.lettuce</groupId>\n        </exclusion>\n    </exclusions>\n</dependency>\n<dependency>\n    <groupId>org.springframework.data</groupId>\n    <artifactId>spring-data-redis</artifactId>\n    <version>2.6.2</version>\n</dependency>\n<dependency>\n    <groupId>io.lettuce</groupId>\n    <artifactId>lettuce-core</artifactId>\n    <version>6.1.6.RELEASE</version>\n</dependency>\n```\n\n**Controllerï¼š**\n\n```java\n@GetMapping(\"/of/type\")\npublic Result queryShopByType(\n        @RequestParam(\"typeId\") Integer typeId,\n        @RequestParam(value = \"current\", defaultValue = \"1\") Integer current,\n        @RequestParam(value = \"x\", required = false) Double x,\n        @RequestParam(value = \"y\", required = false) Double y\n) {\n   return shopService.queryShopByType(typeId,current,x,y);\n}\n```\n\n**ServiceImplï¼ˆç»†èŠ‚è¶…å¤šï¼‰ï¼š**\n\n```java\n@Override\npublic Result queryShopByType(Integer typeId, Integer current, Double x, Double y) {\n    // 1. åˆ¤æ–­æ˜¯å¦éœ€è¦æ ¹æ®è·ç¦»æŸ¥è¯¢\n    if (x == null || y == null) {\n        // æ ¹æ®ç±»å‹åˆ†é¡µæŸ¥è¯¢\n        Page<Shop> page = query()\n                .eq(\"type_id\", typeId)\n                .page(new Page<>(current, SystemConstants.DEFAULT_PAGE_SIZE));\n        // è¿”å›æ•°æ®\n        return Result.ok(page.getRecords());\n    }\n    // 2. è®¡ç®—åˆ†é¡µæŸ¥è¯¢å‚æ•°\n    int from = (current - 1) * SystemConstants.MAX_PAGE_SIZE;\n    int end = current * SystemConstants.MAX_PAGE_SIZE;\n    String key = SHOP_GEO_KEY + typeId;\n    // 3. æŸ¥è¯¢redisã€æŒ‰ç…§è·ç¦»æ’åºã€åˆ†é¡µ; ç»“æœï¼šshopIdã€distance\n    // GEOSEARCH key FROMLONLAT x y BYRADIUS 5000 m WITHDIST\n    GeoResults<RedisGeoCommands.GeoLocation<String>> results = stringRedisTemplate.opsForGeo().search(key,\n            GeoReference.fromCoordinate(x, y),\n            new Distance(5000),\n            RedisGeoCommands.GeoSearchCommandArgs.newGeoSearchArgs().includeDistance().limit(end));\n    if (results == null) {\n        return Result.ok(Collections.emptyList());\n    }\n    // 4. è§£æå‡ºid\n    List<GeoResult<RedisGeoCommands.GeoLocation<String>>> list = results.getContent();\n    if (list.size() < from) {\n        // èµ·å§‹æŸ¥è¯¢ä½ç½®å¤§äºæ•°æ®æ€»é‡ï¼Œåˆ™è¯´æ˜æ²¡æ•°æ®äº†ï¼Œè¿”å›ç©ºé›†åˆ\n        return Result.ok(Collections.emptyList());\n    }\n    ArrayList<Long> ids = new ArrayList<>(list.size());\n    HashMap<String, Distance> distanceMap = new HashMap<>(list.size());\n    list.stream().skip(from).forEach(result -> {\n        String shopIdStr = result.getContent().getName();\n        ids.add(Long.valueOf(shopIdStr));\n        Distance distance = result.getDistance();\n        distanceMap.put(shopIdStr, distance);\n    });\n    // 5. æ ¹æ®idæŸ¥è¯¢shop\n    String idsStr = StrUtil.join(\",\", ids);\n    List<Shop> shops = query().in(\"id\", ids).last(\"ORDER BY FIELD( id,\" + idsStr + \")\").list();\n    for (Shop shop : shops) {\n        // è®¾ç½®shopçš„ä¸¾ä¾‹å±æ€§ï¼Œä»distanceMapä¸­æ ¹æ®shopIdæŸ¥è¯¢\n        shop.setDistance(distanceMap.get(shop.getId().toString()).getValue());\n    }\n    // 6. è¿”å›\n    return Result.ok(shops);\n}\n```\n\n<a name=\"kELTb\"></a>\n\n## ç”¨æˆ·ç­¾åˆ°\n\n<a name=\"CNXyX\"></a>\n\n### å®ç°æ€è·¯åŠBitMapä»‹ç»\n\nå¯¹äºç”¨æˆ·ç­¾åˆ°çš„åŠŸèƒ½ï¼Œåº”ç”¨åœºæ™¯ä¹Ÿå¯è°“æ˜¯å¹¿æ³›ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨æ•°æ®åº“æ¥å®Œæˆä¼šæ˜¯ä»€ä¹ˆæ ·å­å‘¢ï¼Ÿ<br />å¦‚æœæŠŠç”¨æˆ·çš„æ¯æ¬¡ç­¾åˆ°å½“æˆä¸€æ¡è®°å½•ï¼Œå‡è®¾1000ä¸‡ç”¨æˆ·ï¼Œå¹³å‡æ¯äººä¸€å¹´ç­¾åˆ°10æ¬¡ï¼ˆä¸è¿‡åˆ†å§ï¼‰ï¼Œé‚£ä¸€å¹´ä¸‹æ¥è¿™å¼ è¡¨å°±æœ‰1äº¿æ¡æ•°æ®ï¼Œè¿™æ˜¯å¤šä¹ˆææ€–çš„æ•°æ®é‡ï¼Œå¹¶ä¸”æ¯æ¡è®°å½•å°±ç®—10å¤šå­—èŠ‚ï¼Œè¿™å­˜å‚¨ç©ºé—´å‹åŠ›ä¹Ÿå±±å¤§å‘€ï¼<br />**æ‰€ä»¥ï¼Œæˆ‘ä»¬è¯¥æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ**<br />è¿™é‡Œæˆ‘ä»¬å€Ÿé‰´`çŠ¶æ€å‹ç¼©`çš„æ€æƒ³ï¼Œå°†æ¯ä¸ªç”¨æˆ·ä¸€ä¸ªæœˆçš„ç­¾åˆ°çŠ¶æ€å‹ç¼©ä¸ºä¸€ä¸ª31ä½çš„äºŒè¿›åˆ¶ä¸²ï¼Œ`0`ä»£è¡¨æœªç­¾åˆ°ï¼Œ`1`ä»£è¡¨å·²ç­¾åˆ°ï¼Œè€Œè¿™æ°å¥½èƒ½ä½¿ç”¨Redisä¸­çš„`BitMap`æ•°æ®ç»“æ„å®Œæˆã€‚<br />**BitMapçš„å¸¸è§å‘½ä»¤ï¼š**\n\n- `SETBIT`ï¼šå‘æŒ‡å®šä½ç½®ï¼ˆoffsetï¼‰å­˜å…¥ä¸€ä¸ª`0`æˆ–`1`\n- `GETBIT`ï¼šè·å–æŒ‡å®šä½ç½®ï¼ˆoffsetï¼‰çš„bitå€¼\n- `BITCOUNT`ï¼šç»Ÿè®¡BitMapä¸­å€¼ä¸º`1`çš„bitä½çš„æ•°é‡\n- `BITFIELD`ï¼šæ“ä½œï¼ˆæŸ¥è¯¢ã€ä¿®æ”¹ã€è‡ªå¢ï¼‰BitMapä¸­bitæ•°ç»„ä¸­çš„æŒ‡å®šä½ç½®ï¼ˆoffsetï¼‰çš„å€¼\n- `BITFIELD_RO`ï¼šè·å–BitMapä¸­bitæ•°ç»„ï¼Œå¹¶ä»¥åè¿›åˆ¶å½¢å¼è¿”å›\n- `BITOP`ï¼šå°†å¤šä¸ªBitMapçš„ç»“æœåšä½è¿ç®—ï¼ˆä¸ã€æˆ–ã€å¼‚æˆ–ï¼‰\n- `BITPOS`ï¼šæŸ¥æ‰¾bitæ•°ç»„ä¸­æŒ‡å®šèŒƒå›´å†…ç¬¬ä¸€ä¸ª`0`æˆ–`1`å‡ºç°çš„ä½ç½®\n  <a name=\"rRDK1\"></a>\n\n### å®ç°ç­¾åˆ°åŠŸèƒ½\n\néœ€æ±‚ï¼šå®ç°ç”¨æˆ·å½“å¤©ç­¾åˆ°åŠŸèƒ½\n\n> ç”±äºBitMapåº•å±‚æ˜¯åŸºäºStringæ•°æ®ç»“æ„ï¼Œå› æ­¤å¯¹å…¶çš„æ“ä½œåœ¨Javaä¸­ä¹Ÿéƒ½å°è£…åœ¨å­—ç¬¦ä¸²ç›¸å…³æ“ä½œä¸­äº†\n\n**Controllerï¼š**\n\n```java\n@PostMapping(\"/sign\")\npublic Result sign() {\n    return userService.sign();\n}\n```\n\n**ServiceImplï¼š**\n\n```java\n@Override\npublic Result sign() {\n    // 1. è·å–å½“å‰ç”¨æˆ·\n    Long userId = UserHolder.getUser().getId();\n    // 2. è·å–æ—¥æœŸ\n    LocalDateTime now = LocalDateTime.now();\n    // 3. æ‹¼æ¥key\n    String keySuffix = now.format(DateTimeFormatter.ofPattern(\":yyyyMM\"));\n    String key = USER_SIGN_KEY + userId + keySuffix;\n    // 4. è·å–ä»Šå¤©æ˜¯å½“æœˆç¬¬å‡ å¤©(1~31)\n    int dayOfMonth = now.getDayOfMonth();\n    // 5. å†™å…¥Redis  BITSET key offset 1\n    stringRedisTemplate.opsForValue().setBit(key, dayOfMonth - 1, true);\n    return Result.ok();\n}\n```\n\n<a name=\"beOYW\"></a>\n\n### è¿ç»­ç­¾åˆ°ç»Ÿè®¡\n\néœ€æ±‚ï¼šç»Ÿè®¡å‡ºä»ä»Šå¤©å¼€å§‹å¾€å‰çš„è¿ç»­ç­¾åˆ°å¤©æ•°\n\n> å…¶å®å°±æ˜¯ä¸€ä¸ªä½è¿ç®—çš„åŸºæœ¬æ“ä½œ\n\n**Controllerï¼š**\n\n```java\n@GetMapping(\"/sign/count\")\npublic Result signCount() {\n    return userService.signCount();\n}\n```\n\n**ServiceImplï¼š**\n\n```java\n@Override\npublic Result signCount() {\n    // 1. è·å–å½“å‰ç”¨æˆ·\n    Long userId = UserHolder.getUser().getId();\n    // 2. è·å–æ—¥æœŸ\n    LocalDateTime now = LocalDateTime.now();\n    // 3. æ‹¼æ¥key\n    String keySuffix = now.format(DateTimeFormatter.ofPattern(\":yyyyMM\"));\n    String key = USER_SIGN_KEY + userId + keySuffix;\n    // 4. è·å–ä»Šå¤©æ˜¯å½“æœˆç¬¬å‡ å¤©(1~31)\n    int dayOfMonth = now.getDayOfMonth();\n    // 5. è·å–æˆªæ­¢è‡³ä»Šæ—¥çš„ç­¾åˆ°è®°å½•  BITFIELD key GET uDay 0\n    List<Long> result = stringRedisTemplate.opsForValue().bitField(key, BitFieldSubCommands.create()\n            .get(BitFieldSubCommands.BitFieldType.unsigned(dayOfMonth)).valueAt(0));\n    if (result == null || result.isEmpty()) {\n        return Result.ok(0);\n    }\n    // 6. å¾ªç¯éå†\n    int count = 0;\n    Long num = result.get(0);\n    while (true) {\n        if ((num & 1) == 0) {\n            break;\n        } else\n            count++;\n        // æ•°å­—æ— ç¬¦å·å³ç§»ï¼ŒæŠ›å¼ƒæœ€åä¸€ä½\n        num >>>= 1;\n    }\n    return Result.ok(count);\n}\n```\n\n<a name=\"jpMI1\"></a>\n\n### åˆ©ç”¨BitMapå®ç°ç®€å•å¸ƒéš†è¿‡æ»¤å™¨\n\nä¹‹å‰çš„ç« èŠ‚ä¸­æˆ‘ä»¬ä»‹ç»è¿‡ç¼“å­˜ç©¿é€çš„é—®é¢˜ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªæ–¹æ¡ˆå°±æ˜¯åˆ©ç”¨å¸ƒéš†è¿‡æ»¤å™¨å¿«é€Ÿåˆ¤æ–­æŸ¥è¯¢çš„idåœ¨æ•°æ®åº“ä¸­æ˜¯å¦å­˜åœ¨ï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å…¶å®ç°æ€æƒ³æ˜¯ä»€ä¹ˆã€‚<br />æˆ‘ä»¬å¯¹æ¯ä¸€ä¸ªidè¿›è¡Œç›¸åŒçš„å“ˆå¸Œè¿ç®—ï¼Œå¾—åˆ°ä¸€ä¸ªå€¼ï¼Œç„¶åå°†è¿™ä¸ªå€¼åœ¨BitMapä¸Šå¯¹åº”çš„ä½ä¿®æ”¹ä¸º`1`æ¥è¡¨ç¤ºè¿™ä¸ªidå­˜åœ¨ï¼Œ`0`åˆ™è¡¨ç¤ºä¸å­˜åœ¨ã€‚<br />æ—¢ç„¶æ˜¯å“ˆå¸Œï¼Œé‚£å†²çªæ˜¯è‚¯å®šé¿å…ä¸äº†çš„ï¼Œè¿™ä¹Ÿå°±æ˜¯å¸ƒéš†è¿‡æ»¤å™¨ä¼šæœ‰è¯¯åˆ¤çš„å­˜åœ¨ï¼ˆå½“ç„¶ï¼Œåˆ«äººé‚£æ˜¯ä¼˜åŒ–è¿‡çš„ï¼Œåˆ©ç”¨å¤šæ¬¡å“ˆå¸Œè¾ƒå°‘å†²çªï¼‰<br />![64.png](https://cdn.acwing.com/media/article/image/2024/06/11/126318_1b03ccb627-64.png)\n<a name=\"Toj5N\"></a>\n\n## UVç»Ÿè®¡\n\n<a name=\"tD1e0\"></a>\n\n### æ¦‚å¿µä»‹ç»ä¸HyperLogLogç®€ä»‹\n\n**UVï¼š** å…¨ç§°Unique Visitorï¼Œä¹Ÿå«ç‹¬ç«‹è®¿å®¢é‡ï¼Œæ˜¯æŒ‡é€šè¿‡äº’è”ç½‘è®¿é—®ã€æµè§ˆè¿™ä¸ªç½‘é¡µçš„è‡ªç„¶äººã€‚1å¤©å†…åŒä¸€ä¸ªç”¨æˆ·å¤šæ¬¡è®¿é—®è¯¥ç½‘ç«™ï¼Œåªè®°å½•1æ¬¡ã€‚<br />**PVï¼š** å…¨ç§°Page Viewï¼Œä¹Ÿå«é¡µé¢è®¿é—®é‡æˆ–ç‚¹å‡»é‡ï¼Œç”¨æˆ·æ¯è®¿é—®ç½‘ç«™çš„ä¸€ä¸ªé¡µé¢ï¼Œè®°å½•1æ¬¡PVï¼Œç”¨æˆ·å¤šæ¬¡æ‰“å¼€é¡µé¢ï¼Œåˆ™è®°å½•å¤šæ¬¡PVã€‚å¾€å¾€ç”¨æ¥è¡¡é‡ç½‘ç«™çš„æµé‡ã€‚\n\n> æœ¬åšå®¢é¦–é¡µåº•éƒ¨å°±æœ‰æœ¬ç½‘ç«™çš„è®¿é—®äººæ•°åŠæµè§ˆæ€»é‡ï¼Œå¯¹åº”çš„å°±æ˜¯`UV`ä¸`PV`ã€‚\n\nUVç»Ÿè®¡åœ¨æœåŠ¡ç«¯åšä¼šå¾ˆéº»çƒ¦ï¼Œå› ä¸ºè¦åˆ¤æ–­è¯¥ç”¨æˆ·æ˜¯å¦å·²ç»ç»Ÿè®¡è¿‡äº†ï¼Œéœ€è¦å°†ç»Ÿè®¡è¿‡çš„ä¿¡æ¯ä¿å­˜ï¼Œä½†æ˜¯å¦‚æœæ¯ä¸ªè®¿é—®çš„ç”¨æˆ·éƒ½ä¿å­˜åˆ°Redisä¸­ï¼Œé‚£ä¹ˆæ•°æ®åº“ä¼šéå¸¸ææ€–ï¼Œé‚£ä¹ˆè¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ<br />**HyperLogLog(HLL)**æ˜¯ä»Loglogç®—æ³•æ´¾ç”Ÿçš„æ¦‚ç‡ç®—æ³•ï¼Œç”¨æˆ·ç¡®å®šéå¸¸å¤§çš„é›†åˆåŸºæ•°ï¼Œè€Œä¸éœ€è¦å­˜å‚¨å…¶æ‰€æœ‰å€¼ï¼Œç®—æ³•ç›¸å…³åŸç†å¯ä»¥å‚è€ƒä¸‹é¢è¿™ç¯‡æ–‡ç« ï¼š[HyperLogLog ç®—æ³•çš„åŸç†è®²è§£](https://juejin.cn/post/6844903785744056333#heading-0)<br />Redisä¸­çš„HLLæ˜¯åŸºäºstringç»“æ„å®ç°çš„ï¼Œå•ä¸ªHLLçš„å†…å­˜**æ°¸è¿œå°äº16kb**ï¼Œ**å†…å­˜å ç”¨ä½çš„ä»¤äººå‘æŒ‡**ï¼ä½œä¸ºä»£ä»·ï¼Œå…¶æµ‹é‡ç»“æœæ˜¯æ¦‚ç‡æ€§çš„ï¼Œ**æœ‰å°äº0.81ï¼…çš„è¯¯å·®**ã€‚ä¸è¿‡å¯¹äºUVç»Ÿè®¡æ¥è¯´ï¼Œè¿™å®Œå…¨å¯ä»¥å¿½ç•¥ã€‚<br />**HyperLogLogçš„ä¸‰ä¸ªå‘½ä»¤ï¼š**\n\n```bash\nPFADD key element [element...]\nsummary: Adds the specified elements to the specified HyperLogLog\n\nPFCOUNT key [key ...]\nReturn the approximated cardinality of the set(s) observed by the HyperLogLog at key(s).\n\nPFMERGE destkey sourcekey [sourcekey ...]\nlnternal commands for debugging HyperLogLog values\n```\n\n<a name=\"UYvT2\"></a>\n\n### æµ‹è¯•ç™¾ä¸‡æ•°æ®çš„ç»Ÿè®¡\n\nä½¿ç”¨å•å…ƒæµ‹è¯•ï¼Œå‘HyperLogLogä¸­æ·»åŠ 100ä¸‡æ¡æ•°æ®ï¼Œçœ‹çœ‹å†…å­˜å ç”¨æ˜¯å¦çœŸçš„é‚£ä¹ˆä½ï¼Œä»¥åŠç»Ÿè®¡è¯¯å·®å¦‚ä½•\n\n```java\n@Test\npublic void testHyperLogLog() {\n    String[] users = new String[1000];\n    int j = 0;\n    for (int i = 0; i < 1000000; i++) {\n        j = i % 1000;\n        users[j] = \"user_\" + i;\n        // æ¯1000æ¡æ•°æ®å‘HyperLogLogä¸­æ’å…¥ä¸€æ¬¡\n        if (j == 999) {\n            stringRedisTemplate.opsForHyperLogLog().add(\"HLL\", users);\n        }\n    }\n    Long count = stringRedisTemplate.opsForHyperLogLog().size(\"HLL\");\n    System.out.println(\"count = \" + count);\n}\n```\n\n> æ’å…¥100Wæ¡æ•°æ®ï¼Œå¾—åˆ°çš„countä¸º997593ï¼Œè¯¯å·®ç‡ä¸º0.002407%\n> å»Rediså›¾å½¢åŒ–ç•Œé¢ä¸­æŸ¥çœ‹å ç”¨æƒ…å†µä¸ºï¼š14Kå­—èŠ‚ï¼ˆç¡®å®å®ç°äº†å¹çš„ç‰›ï¼‰\n\n","categories":["Redis"]},{"title":"RedisåŸºç¡€ç¯‡","url":"/2024/03/04/RedisåŸºç¡€ç¯‡/","content":"\n<a name=\"AAv2g\"></a>\n## 1. Redisç®€ä»‹\n> Redisè¯ç”Ÿäº2009å¹´ï¼Œå…¨ç§°æ˜¯Remote Dictionary Serverï¼Œè¿œç¨‹è¯å…¸æœåŠ¡å™¨ï¼Œæ˜¯ä¸€ä¸ªåŸºäºå†…å­˜çš„é”®å€¼å‹NoSQLæ•°æ®åº“ã€‚\n\n- Redisçš„ç‰¹å¾ï¼š\n   - é”®å€¼ï¼ˆ`key-value`ï¼‰å‹ï¼Œvalueæ”¯æŒå¤šç§ä¸åŒæ•°æ®ç»“æ„ï¼ŒåŠŸèƒ½ä¸°å¯Œï¼›\n   - å•çº¿ç¨‹ï¼Œæ¯ä¸ªå‘½ä»¤å…·å¤‡åŸå­æ€§ï¼›\n   - ä½å»¶è¿Ÿï¼Œé€Ÿåº¦å¿«ï¼ˆåŸºäºå†…å­˜ã€IOå¤šè·¯å¤ç”¨ã€è‰¯å¥½çš„ç¼–ç ï¼‰ï¼›\n   - æ”¯æŒæ•°æ®æŒä¹…åŒ–ï¼›\n   - æ”¯æŒä¸»ä»é›†ç¾¤ã€åˆ†ç‰‡é›†ç¾¤ï¼›\n   - æ”¯æŒå¤šè¯­è¨€å®¢æˆ·ç«¯ã€‚\n- ä»€ä¹ˆæ˜¯NoSQLï¼š\n   - NoSQLæœ€å¸¸è§çš„è§£é‡Šæ˜¯\"non-relational\"ï¼Œ å¾ˆå¤šäººä¹Ÿè¯´å®ƒæ˜¯\"_**Not Only SQL**_\"ï¼›\n   - NoSQLä»…ä»…æ˜¯ä¸€ä¸ªæ¦‚å¿µï¼Œæ³›æŒ‡**éå…³ç³»å‹çš„æ•°æ®åº“ï¼›**\n   - åŒºåˆ«äºå…³ç³»æ•°æ®åº“ï¼Œå®ƒä»¬ä¸ä¿è¯å…³ç³»æ•°æ®çš„ACIDç‰¹æ€§ï¼ˆåŸå­æ€§ (Atomicity)ã€ ä¸€è‡´æ€§ï¼›(Consistency)ã€éš”ç¦»æ€§(Isolation) å’Œ æŒä¹…æ€§(Durability)ï¼‰ï¼›\n   - NoSQLæ˜¯ä¸€é¡¹å…¨æ–°çš„æ•°æ®åº“é©å‘½æ€§è¿åŠ¨ï¼Œæå€¡è¿ç”¨éå…³ç³»å‹çš„æ•°æ®å­˜å‚¨ï¼Œç›¸å¯¹äºé“ºå¤©ç›–åœ°çš„å…³ç³»å‹æ•°æ®åº“è¿ç”¨ï¼Œè¿™ä¸€æ¦‚å¿µæ— ç–‘æ˜¯ä¸€ç§å…¨æ–°çš„æ€ç»´çš„æ³¨å…¥ï¼›\n   - å¸¸è§çš„NoSQLæ•°æ®åº“æœ‰ï¼š`Redis`ã€`MemCache`ã€`MongoDB`ç­‰ã€‚\n- NoSQLä¸SQLçš„å·®å¼‚ï¼š\n\n| å±æ€§ | SQL | NoSQL |\n| :-: | :-: | :-: |\n| æ•°æ®ç»“æ„ | ç»“æ„åŒ– | éç»“æ„åŒ– |\n| æ•°æ®å…³è” | å…³è”çš„ | æ— å…³è”çš„ |\n| æŸ¥è¯¢æ–¹å¼ | SQLæŸ¥è¯¢ | éSQL |\n| äº‹åŠ¡ç‰¹æ€§ | ACID | BASE |\n| å­˜å‚¨æ–¹å¼ | ç£ç›˜ | å†…å­˜ |\n| æ‰©å±•æ€§ | å‚ç›´ | æ°´å¹³ |\n| ä½¿ç”¨åœºæ™¯ | ï¼ˆ1ï¼‰æ•°æ®ç»“æ„å›ºå®š<br />ï¼ˆ2ï¼‰ç›¸å…³ä¸šåŠ¡å¯¹æ•°æ®å®‰å…¨æ€§ã€ä¸€è‡´æ€§è¦æ±‚è¾ƒé«˜ | ï¼ˆ1ï¼‰æ•°æ®ç»“æ„ä¸å›ºå®š<br />ï¼ˆ2ï¼‰å¯¹ä¸€è‡´æ€§ã€å®‰å…¨æ€§è¦æ±‚ä¸é«˜<br />ï¼ˆ3ï¼‰å¯¹æ€§èƒ½è¦æ±‚ |\n\n<a name=\"fRycZ\"></a>\n## 2. Rediså®‰è£…\n<a name=\"ZO5Z0\"></a>\n### 2.1 ubuntuå®‰è£… \n\n- ubunutuæŒ‡ä»¤å®‰è£…ï¼š\n```shell\napt install redis-server\n```\n\n- æ£€æŸ¥å®‰è£…ï¼š\n```shell\nservice redis-server start\n\n# æ£€æŸ¥å¯åŠ¨æƒ…å†µ\nps -ef | grep redis # è¿›ç¨‹æ£€æŸ¥\nnetstat -anp | grep redis # ç«¯å£æ£€æŸ¥\n```\n\n- å¯åŠ¨redisæœåŠ¡ï¼š\n```shell\nservice redis-server start\n```\n\n- è¿æ¥rediså®¢æˆ·ç«¯ï¼š\n```shell\n# éœ€è¦åœ¨å®¢æˆ·ç«¯ä¸Šå¯¹redisè¿›è¡Œæ“ä½œ\nredis-cli\n```\n<a name=\"jVgJz\"></a>\n### 2.2 linuxæºç å®‰è£…\n> ç”±äºredisä½¿ç”¨Cè¯­è¨€ç¼–å†™ï¼Œæ‰€ä»¥æƒ³è¦ä½¿ç”¨æºç ç¼–è¯‘å®‰è£…ï¼Œå¿…é¡»å…ˆå®‰è£…ç¼–è¯‘å™¨å†æ‰§è¡Œåç»­æ­¥éª¤ã€‚\n> `apt install gcc`ï¼šä¸ºäº†ç¼–è¯‘æºä»£ç \n> `apt install make`ï¼šä¸ºäº†è‡ªåŠ¨åŒ–æ„å»ºé¡¹ç›®\n\n- è§£å‹å‹ç¼©åŒ…\n```shell\ntar -zxvf redis-6.0.6.tar.gz\n```\n\n- è¿›å…¥æºç ç›®å½•\n```shell\ncd redis-6.0.6\n```\n\n- æ‰§è¡Œç¼–è¯‘\n```shell\n# éœ€è¦ä¸»æœºä¸Šæœ‰Cè¯­è¨€çš„ç¼–è¯‘ç¯å¢ƒï¼Œå³gcc ç­‰ç¼–è¯‘å·¥å…·é“¾\nmake\n```\n\n- é»˜è®¤å®‰è£…\n```shell\n# é»˜è®¤åœ°ï¼Œç›¸å…³ç¨‹åºä¼šè¢«å®‰è£…åˆ° /usr/local/bin ç›®å½•ä¸‹,ä¾‹å¦‚ /usr/local/bin/redis-server\nmake install\n```\n  - æˆ–è€…å®‰è£…åˆ°æŒ‡å®šç›®å½•\n```shell\nexport PREFIX=/opt/redis\nmake install\n```\n\n- è¿è¡Œ\n```shell\ncd /usr/local/bin/\nredis-server\n# è¿è¡Œæ—¶ä¹Ÿå¯ä»¥æŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„\nredis-server  /path/of/redis/redis.conf\n```\n<a name=\"BEQuA\"></a>\n### 2.3 è®¾ç½®å¼€æœºè‡ªå¯\n> Redisæ¨èå¼€æœºè‡ªå¯\n\n- é¦–å…ˆï¼Œæ–°å»ºä¸€ä¸ªç³»ç»ŸæœåŠ¡æ–‡ä»¶ ï¼š\n```shell\nvi /etc/systemd/system/redis.service\n```\n\n- ç²˜è´´ä¸€ä¸‹å†…å®¹ï¼š\n```nginx\n[Unit]\nDescription=redis-server\nAfter=network.target\n\n[Service]\nType=forking\nExecStart=/usr/local/bin/redis-server /usr/local/src/redis-6.2.6/redis.conf\nPrivateTmp=true\n\n[Install]\nWantedBy=multi-user.target\n```\n\n- ç„¶åé‡è½½ç³»ç»ŸæœåŠ¡ ï¼š\n```shell\nsystemctl daemon-reload\n```\n\n- ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸‹é¢è¿™ç»„å‘½ä»¤æ¥æ“ä½œredisï¼š\n```shell\n# å¯åŠ¨\nsystemctl start redis\n# åœæ­¢\nsystemctl stop redis\n# é‡å¯\nsystemctl restart redis\n# æŸ¥çœ‹çŠ¶æ€\nsystemctl status redis\n```\n\n- æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œå¯ä»¥è®©rediså¼€æœºè‡ªå¯ \n```shell\nsystemctl enable redis\n```\n<a name=\"x4NCY\"></a>\n## 3. ä¿®æ”¹é…ç½®æ–‡ä»¶\næ‰¾åˆ°`/etc/redis/`ä¸‹çš„`redis.conf`æ–‡ä»¶ä½¿ç”¨`vim`ç¼–è¾‘ï¼š\n\n1. ç»‘å®šipé…ç½®ï¼šå½“æœåŠ¡å™¨å­˜åœ¨å¤šä¸ªç½‘å¡(IP) æ—¶ï¼Œè®©æœåŠ¡å™¨ç›‘å¬å“ªä¸ªIP\n```shell\nbind 127.0.0.1 # åªèƒ½ä»æœ¬æœºè®¿é—®\nbind 192.168.43.128 # åªèƒ½ä»å†…ç½‘è®¿é—®\nbind 202.10.8.130  # å¯ä»¥ä»å¤–ç½‘è®¿é—®\nbind 0.0.0.0  # å¯ä»¥ä»ä»»æ„ä½ç½®è®¿é—®æ­¤æœåŠ¡å™¨ (æ¯”è¾ƒå¸¸ç”¨)\n```\n\n2. è®¾ç½®å¯†ç ï¼š\n```shell\n# æ‰¾åˆ°requirepassè¿™ä¸€è¡Œ ä½¿ç”¨/requirepass + n æˆ–è€… ?requirepass + n å¿«é€ŸæŸ¥æ‰¾ï¼ˆvimçŸ¥è¯†ç‚¹ï¼‰\nrequirepass 1a2b3c # å¯†ç å°½é‡å¤æ‚äº›ï¼Œé¿å…è¢«ç ´è§£\n```\n\n3. é‡å¯`redis`æœåŠ¡ï¼š\n```shell\n# ä¸é‡å¯æœåŠ¡è¾“å…¥å¯†ç ä¸é€šè¿‡\nservice redis-server restart\n```\n\n4. è¿æ¥å®¢æˆ·ç«¯ï¼š\n```shell\nredis-cli\n# éªŒè¯å¯†ç \nauth 1a2b3c\n# ä¹Ÿå¯ä»¥å°†ä»¥ä¸Šä¸¤æ­¥åˆä¸ºä¸€æ­¥ redis-cli -a a1b2c3\nping # æœåŠ¡ç«¯æ­£å¸¸ä¼šè¿”å›pong\n```\n<a name=\"CEe0H\"></a>\n## 4. Rediså‘½ä»¤\n<a name=\"I5L8G\"></a>\n### 4.1 é€šç”¨å‘½ä»¤\n| æŒ‡ä»¤ | æè¿° |\n| :-: | :-: |\n| KEYS | æŸ¥çœ‹ç¬¦åˆæ¨¡æ¿çš„æ‰€æœ‰keyï¼Œä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒè®¾å¤‡ä¸Šä½¿ç”¨ |\n| DEL | åˆ é™¤ä¸€ä¸ªæŒ‡å®šçš„key |\n| EXISTS | åˆ¤æ–­keyæ˜¯å¦å­˜åœ¨ |\n| EXPIRE | ç»™ä¸€ä¸ªkeyè®¾ç½®æœ‰æ•ˆæœŸï¼Œæœ‰æ•ˆæœŸåˆ°æœŸæ—¶è¯¥keyä¼šè¢«è‡ªåŠ¨åˆ é™¤ |\n| TTL | æŸ¥çœ‹ä¸€ä¸ªKEYçš„å‰©ä½™æœ‰æ•ˆæœŸ |\n\n> å¯ä»¥é€šè¿‡`help [command]`æŸ¥çœ‹ä¸€ä¸ªå‘½ä»¤çš„å…·ä½“ç”¨æ³•ï¼\n\n<a name=\"OzXhr\"></a>\n### 4.2 å„ä¸ªæ•°æ®ç±»å‹å‘½ä»¤\n<a name=\"IweAd\"></a>\n\n#### 4.2.1 String\n**Stringçš„å¸¸è§å‘½ä»¤ï¼š**\n- `SET`ï¼šæ·»åŠ æˆ–è€…ä¿®æ”¹å·²ç»å­˜åœ¨çš„ä¸€ä¸ªStringç±»å‹çš„é”®å€¼å¯¹\n- `GET`ï¼šæ ¹æ®keyè·å–Stringç±»å‹çš„value\n- `MSET`ï¼šæ‰¹é‡æ·»åŠ å¤šä¸ªStringç±»å‹çš„é”®å€¼å¯¹\n- `MGET`ï¼šæ ¹æ®å¤šä¸ªkeyè·å–å¤šä¸ªStringç±»å‹çš„value\n- `INCR`ï¼šè®©ä¸€ä¸ªæ•´å‹çš„keyè‡ªå¢1\n- `INCRBY`:è®©ä¸€ä¸ªæ•´å‹çš„keyè‡ªå¢å¹¶æŒ‡å®šæ­¥é•¿ï¼Œä¾‹å¦‚ï¼šincrby num 2 è®©numå€¼è‡ªå¢2\n- `INCRBYFLOAT`ï¼šè®©ä¸€ä¸ªæµ®ç‚¹ç±»å‹çš„æ•°å­—è‡ªå¢å¹¶æŒ‡å®šæ­¥é•¿\n- `SETNX`ï¼šæ·»åŠ ä¸€ä¸ªStringç±»å‹çš„é”®å€¼å¯¹ï¼Œå‰ææ˜¯è¿™ä¸ªkeyä¸å­˜åœ¨ï¼Œå¦åˆ™ä¸æ‰§è¡Œ\n- `SETEX`ï¼šæ·»åŠ ä¸€ä¸ªStringç±»å‹çš„é”®å€¼å¯¹ï¼Œå¹¶ä¸”æŒ‡å®šæœ‰æ•ˆæœŸ\n\n**æ³¨æ„ï¼š**\n- ä»¥ä¸Šå‘½ä»¤é™¤äº†`INCRBYFLOAT`éƒ½æ˜¯å¸¸ç”¨å‘½ä»¤\n- `SET`å’Œ`GET`ï¼šå¦‚æœkeyä¸å­˜åœ¨åˆ™æ˜¯æ–°å¢ï¼Œå¦‚æœå­˜åœ¨åˆ™æ˜¯ä¿®æ”¹\n```shell\n127.0.0.1:6379> set name Rose  //åŸæ¥ä¸å­˜åœ¨\nOK\n\n127.0.0.1:6379> get name \n\"Rose\"\n\n127.0.0.1:6379> set name Jack //åŸæ¥å­˜åœ¨ï¼Œå°±æ˜¯ä¿®æ”¹\nOK\n\n127.0.0.1:6379> get name\n\"Jack\"\n```\n<a name=\"TwBwp\"></a>\n#### 4.2.2 Hash\n**Hashç±»å‹çš„å¸¸è§å‘½ä»¤:**\n- `HSET key field value`ï¼šæ·»åŠ æˆ–è€…ä¿®æ”¹hashç±»å‹keyçš„fieldçš„å€¼\n- `HGET key field`ï¼šè·å–ä¸€ä¸ªhashç±»å‹keyçš„fieldçš„å€¼\n- `HMSET`ï¼šæ‰¹é‡æ·»åŠ å¤šä¸ªhashç±»å‹keyçš„fieldçš„å€¼\n- `HMGET`ï¼šæ‰¹é‡è·å–å¤šä¸ªhashç±»å‹keyçš„fieldçš„å€¼\n- `HGETALL`ï¼šè·å–ä¸€ä¸ªhashç±»å‹çš„keyä¸­çš„æ‰€æœ‰çš„fieldå’Œvalue\n- `HKEYS`ï¼šè·å–ä¸€ä¸ªhashç±»å‹çš„keyä¸­çš„æ‰€æœ‰çš„field\n- `HINCRBY`:è®©ä¸€ä¸ªhashç±»å‹keyçš„å­—æ®µå€¼è‡ªå¢å¹¶æŒ‡å®šæ­¥é•¿\n- `HSETNX`ï¼šæ·»åŠ ä¸€ä¸ªhashç±»å‹çš„keyçš„fieldå€¼ï¼Œå‰ææ˜¯è¿™ä¸ªfieldä¸å­˜åœ¨ï¼Œå¦åˆ™ä¸æ‰§è¡Œ\n  <a name=\"nXnw9\"></a>\n#### 4.2.3 List\n**Listçš„å¸¸è§å‘½ä»¤ï¼š**\n- `LPUSH key element ... `ï¼šå‘åˆ—è¡¨å·¦ä¾§æ’å…¥ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ \n- `LPOP key`ï¼šç§»é™¤å¹¶è¿”å›åˆ—è¡¨å·¦ä¾§çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œæ²¡æœ‰åˆ™è¿”å›nil\n- `RPUSH key element ...`ï¼šå‘åˆ—è¡¨å³ä¾§æ’å…¥ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ \n- `RPOP key`ï¼šç§»é™¤å¹¶è¿”å›åˆ—è¡¨å³ä¾§çš„ç¬¬ä¸€ä¸ªå…ƒç´ \n- `LRANGE key star end`ï¼šè¿”å›ä¸€æ®µè§’æ ‡èŒƒå›´å†…çš„æ‰€æœ‰å…ƒç´ \n- `BLPOP`å’Œ`BRPOP`ï¼šä¸`LPOP`å’Œ`RPOP`ç±»ä¼¼ï¼Œåªä¸è¿‡åœ¨æ²¡æœ‰å…ƒç´ æ—¶ç­‰å¾…æŒ‡å®šæ—¶é—´ï¼Œè€Œä¸æ˜¯ç›´æ¥è¿”å›nil\n\n![image.png](https://cdn.acwing.com/media/article/image/2024/03/07/126318_7e02f584dc-4.2.3list.png)\n<a name=\"WMrHG\"></a>\n#### 4.2.4 Set\n**Setç±»å‹çš„å¸¸è§å‘½ä»¤ï¼š**\n- `SADD key member ...`ï¼šå‘setä¸­æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ \n- `SREM key member ...`: ç§»é™¤setä¸­çš„æŒ‡å®šå…ƒç´ \n- `SCARD key`ï¼š è¿”å›setä¸­å…ƒç´ çš„ä¸ªæ•°\n- `SISMEMBER key member`ï¼šåˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨äºsetä¸­\n- `SMEMBERS`ï¼šè·å–setä¸­çš„æ‰€æœ‰å…ƒç´ \n- `SINTER key1 key2 ...`ï¼šæ±‚key1ä¸key2çš„äº¤é›†\n- `SDIFF key1 key2 ...`ï¼šæ±‚key1ä¸key2çš„å·®é›†\n- `SUNION key1 key2 ...`ï¼šæ±‚key1å’Œkey2çš„å¹¶é›†\n\n![image.png](https://cdn.acwing.com/media/article/image/2024/03/07/126318_81ff1000dc-4.2.4set.png)\n<a name=\"m4FJA\"></a>\n#### 4.2.5 SortedSet\n**SortedSetçš„å¸¸è§å‘½ä»¤ï¼š**\n- `ZADD key score member`ï¼šæ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ åˆ°SortedSet ï¼Œå¦‚æœå·²ç»å­˜åœ¨åˆ™æ›´æ–°å…¶scoreå€¼\n- `ZREM key member`ï¼šåˆ é™¤SortedSetä¸­çš„ä¸€ä¸ªæŒ‡å®šå…ƒç´ \n- `ZSCORE key member` : è·å–SortedSetä¸­çš„æŒ‡å®šå…ƒç´ çš„scoreå€¼\n- `ZRANK key member`ï¼šè·å–SortedSet ä¸­çš„æŒ‡å®šå…ƒç´ çš„æ’å\n- `ZCARD key`ï¼šè·å–SortedSetä¸­çš„å…ƒç´ ä¸ªæ•°\n- `ZCOUNT key min max`ï¼šç»Ÿè®¡scoreå€¼åœ¨ç»™å®šèŒƒå›´å†…çš„æ‰€æœ‰å…ƒç´ çš„ä¸ªæ•°\n- `ZINCRBY key increment member`ï¼šè®©SortedSetä¸­çš„æŒ‡å®šå…ƒç´ è‡ªå¢ï¼Œæ­¥é•¿ä¸ºæŒ‡å®šçš„incrementå€¼\n- `ZRANGE key min max`ï¼šæŒ‰ç…§scoreæ’åºåï¼Œè·å–æŒ‡å®šæ’åèŒƒå›´å†…çš„å…ƒç´ \n- `ZRANGEBYSCORE key min max`ï¼šæŒ‰ç…§scoreæ’åºåï¼Œè·å–æŒ‡å®šscoreèŒƒå›´å†…çš„å…ƒç´ \n- `ZDIFF.ZINTER.ZUNION`ï¼šæ±‚å·®é›†ã€äº¤é›†ã€å¹¶é›†\n\n**æ³¨æ„ï¼š**<br />æ‰€æœ‰çš„æ’åé»˜è®¤éƒ½æ˜¯å‡åºï¼Œå¦‚æœè¦é™åºåˆ™åœ¨å‘½ä»¤çš„`Z`åé¢æ·»åŠ `REV`å³å¯ï¼Œä¾‹å¦‚ï¼š\n- **å‡åº**è·å–SortedSetä¸­çš„æŒ‡å®šå…ƒç´ çš„æ’åï¼š`ZRANK key member`\n- **é™åº**è·å–SortedSetä¸­çš„æŒ‡å®šå…ƒç´ çš„æ’åï¼š`ZREVRANK key memeber`\n  <a name=\"FadCZ\"></a>\n## 5. Redisçš„Javaå®¢æˆ·ç«¯\n<a name=\"BpC55\"></a>\n### 5.1 ç›®å‰ä¸»æµçš„Redisçš„Javaå®¢æˆ·ç«¯ï¼š\n\n- **Jediså’ŒLettuceï¼š** è¿™ä¸¤ä¸ªä¸»è¦æ˜¯æä¾›äº†Rediså‘½ä»¤å¯¹åº”çš„APIï¼Œæ–¹ä¾¿æˆ‘ä»¬æ“ä½œRedisï¼Œè€ŒSpringDataRedisåˆå¯¹è¿™ä¸¤ç§åšäº†æŠ½è±¡å’Œå°è£…ï¼Œå› æ­¤æˆ‘ä»¬åæœŸä¼šç›´æ¥ä»¥SpringDataRedisæ¥å­¦ä¹ ã€‚\n- **Redissonï¼š** æ˜¯åœ¨RedisåŸºç¡€ä¸Šå®ç°äº†åˆ†å¸ƒå¼çš„å¯ä¼¸ç¼©çš„javaæ•°æ®ç»“æ„ï¼Œä¾‹å¦‚Mapã€Queueç­‰ï¼Œè€Œä¸”æ”¯æŒè·¨è¿›ç¨‹çš„åŒæ­¥æœºåˆ¶ï¼šLockã€Semaphoreç­‰å¾…ï¼Œæ¯”è¾ƒé€‚åˆç”¨æ¥å®ç°ç‰¹æ®Šçš„åŠŸèƒ½éœ€æ±‚ã€‚\n<a name=\"eMiZZ\"></a>\n### 5.2 Jediså¿«é€Ÿå…¥é—¨\n**ä¸ä½¿ç”¨è¿æ¥æ± ï¼š**\n\n- å¼•å…¥ç›¸å…³ä¾èµ–\n```xml\n<!--jedis-->\n<dependency>\n    <groupId>redis.clients</groupId>\n    <artifactId>jedis</artifactId>\n    <version>3.7.0</version>\n</dependency>\n\n<!--å•å…ƒæµ‹è¯•-->\n<dependency>\n    <groupId>org.junit.jupiter</groupId>\n    <artifactId>junit-jupiter</artifactId>\n    <version>5.7.0</version>\n    <scope>test</scope>\n</dependency>\n```\n\n- å»ºç«‹æµ‹è¯•ç±»\n```java\nprivate Jedis jedis;\n\n// å»ºç«‹è¿æ¥\n@BeforeEach\nvoid setUp() {\n    // å»ºç«‹è¿æ¥ï¼ˆip + portï¼‰\n    jedis = new Jedis(\"127.0.0.1\", 6379);\n    // è®¾ç½®å¯†ç \n    jedis.auth(\"1a2b3c\");\n    // é€‰æ‹©åº“ï¼ˆæ€»å…±16ä¸ªåº“ï¼‰\n    jedis.select(0);\n}\n\n// é‡Šæ”¾èµ„æº\n@AfterEach\nvoid tearDown(){\n    if (jedis != null){\n        jedis.close();\n    }\n}\n```\n\n- åœ¨æµ‹è¯•ç±»ä¸­è¿›è¡Œæµ‹è¯•\n```java\n// æµ‹è¯•String\n@Test\nvoid testString(){\n    jedis.set(\"name\",\"SmallBoat\");\n    String name = jedis.get(\"name\");\n    System.out.println(\"name: \" + name);\n}\n\n// æµ‹è¯•Hash\n@Test\nvoid testHash(){\n    jedis.hset(\"user:1\",\"name\",\"Jack\");\n    jedis.hset(\"user:2\",\"name\",\"Rose\");\n    jedis.hset(\"user:1\",\"age\",\"21\");\n    jedis.hset(\"user:2\",\"age\",\"18\");\n    Map<String, String> map = jedis.hgetAll(\"user:1\");\n    System.out.println(map);\n}\n```\n**ä½¿ç”¨è¿æ¥æ± ï¼š**\n> Jedisæœ¬èº«æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œå¹¶ä¸”é¢‘ç¹çš„åˆ›å»ºå’Œé”€æ¯è¿æ¥ä¼šæœ‰æ€§èƒ½æŸè€—ï¼Œå› æ­¤æ¨èä½¿ç”¨Jedisè¿æ¥æ± ä»£æ›¿Jedisçš„ç›´è¿æ–¹å¼ã€‚\n\n- åˆ›å»ºJedisConnectionFactoryå·¥å…·ç±»\n```java\npublic class JedisConnectionFactory {\n\n    private static JedisPool jedisPool;\n\n    static {\n        // é…ç½®è¿æ¥æ± \n        JedisPoolConfig poolConfig = new JedisPoolConfig();\n        poolConfig.setMaxTotal(8);\n        poolConfig.setMaxIdle(8);\n        poolConfig.setMinIdle(0);\n        poolConfig.setMaxWaitMillis(1000);\n        // åˆ›å»ºè¿æ¥æ± å¯¹è±¡ï¼Œå‚æ•°ï¼šè¿æ¥æ± é…ç½®ã€æœåŠ¡ç«¯ipã€æœåŠ¡ç«¯ç«¯å£ã€è¶…æ—¶æ—¶é—´ã€å¯†ç \n        jedisPool = new JedisPool(poolConfig, \"127.0.0.1\", 6379, 1000, \"1a2b3c\");\n    }\n\n    public static Jedis getJedis(){\n        return jedisPool.getResource();\n    }\n}\n```\n\n- åˆ›å»ºæµ‹è¯•ç±»\n```java\n@SpringBootTest\nclass RedisTestApplicationTests {\n\n    private Jedis jedis = JedisConnectionFactory.getJedis();\n\n    // æµ‹è¯•String\n    @Test\n    void testString(){\n        jedis.set(\"name\",\"SmallBoat\");\n        String name = jedis.get(\"name\");\n        System.out.println(\"name: \" + name);\n    }\n\n    // æµ‹è¯•Hash\n    @Test\n    void testHash(){\n        jedis.hset(\"user:1\",\"name\",\"Jack\");\n        jedis.hset(\"user:2\",\"name\",\"Rose\");\n        jedis.hset(\"user:3\",\"name\",\"SmallBoat\");\n        jedis.hset(\"user:1\",\"age\",\"21\");\n        jedis.hset(\"user:2\",\"age\",\"18\");\n        jedis.hset(\"user:3\",\"age\",\"18\");\n        Map<String, String> map = jedis.hgetAll(\"user:3\");\n        System.out.println(map);\n    }\n\n    // é‡Šæ”¾èµ„æº\n    @AfterEach\n    void tearDown(){\n        if (jedis != null){\n            jedis.close();\n        }\n    }\n}\n```\n<a name=\"Tj3JO\"></a>\n### 5.3 SpringDataRediså¿«é€Ÿå…¥é—¨\n<a name=\"z49za\"></a>\n#### 5.3.1 SpringDataRedisç®€ä»‹\nSpringDataæ˜¯Springä¸­æ•°æ®æ“ä½œçš„æ¨¡å—ï¼ŒåŒ…å«å¯¹å„ç§æ•°æ®åº“çš„é›†æˆï¼Œå…¶ä¸­å¯¹Redisçš„é›†æˆæ¨¡å—å°±å«åšSpringDataRedisã€‚<br />**ç‰¹æ€§ï¼š**\n\n- æä¾›äº†å¯¹ä¸åŒRedisçš„Javaå®¢æˆ·ç«¯çš„æ•´åˆï¼ˆåŒ…æ‹¬Jediså’ŒLettuceï¼‰ï¼›\n- æä¾›äº†RedisTemplateç»Ÿä¸€APIæ¥æ“ä½œRedisï¼›\n- æ”¯æŒRedisçš„å‘å¸ƒè®¢é˜…æ¨¡å‹ï¼›\n- æ”¯æŒRediså“¨å…µå’ŒRedisé›†ç¾¤ï¼›\n- æ”¯æŒåŸºäºLettuceçš„å“åº”å¼ç¼–ç¨‹ï¼›\n- æ”¯æŒåŸºäºJDKã€JSONã€å­—ç¬¦ä¸²ã€Springå¯¹è±¡çš„æ•°æ®åºåˆ—åŒ–åŠååºåˆ—åŒ–ï¼›\n- æ”¯æŒåŸºäºRedisçš„JDKCollectionå®ç°ã€‚\n\n**redisTemplateçš„å„ç§APIï¼š**\n\n| API | è¿”å›å€¼ç±»å‹ | è¯´æ˜ |\n| :-: | :-: | :-: |\n| redisTemplate.opsForValue() | ValueOperations | æ“ä½œStringç±»å‹æ•°æ® |\n| redisTemplate.opsForHash() | HashOperations | æ“ä½œHashç±»å‹æ•°æ® |\n| redisTemplate.opsForList() | ListOperations | æ“ä½œListç±»å‹æ•°æ® |\n| redisTemplate.opsForSet() | SetOperations | æ“ä½œSetç±»å‹æ•°æ® |\n| redisTemplate.opsForzSet() | ZSetOperations | æ“ä½œSortedSetç±»å‹æ•°æ® |\n\n<a name=\"KgQPI\"></a>\n#### 5.3.2 ç¤ºä¾‹\n\n- å¼•å…¥ç›¸å…³ä¾èµ–\n```xml\n<!--redisä¾èµ–-->\n<dependency>\n    <groupId>org.springframework.boot</groupId>\n    <artifactId>spring-boot-starter-data-redis</artifactId>\n</dependency>\n<!--common-pool-->\n<dependency>\n    <groupId>org.apache.commons</groupId>\n    <artifactId>commons-pool2</artifactId>\n</dependency>\n<!--Jacksonä¾èµ–-->\n<dependency>\n    <groupId>com.fasterxml.jackson.core</groupId>\n    <artifactId>jackson-databind</artifactId>\n</dependency>\n<!--lombok-->\n<dependency>\n    <groupId>org.projectlombok</groupId>\n    <artifactId>lombok</artifactId>\n    <optional>true</optional>\n</dependency>\n<dependency>\n    <groupId>org.springframework.boot</groupId>\n    <artifactId>spring-boot-starter-test</artifactId>\n    <scope>test</scope>\n</dependency>\n```\n\n- åœ¨yamlæ–‡ä»¶ä¸­é…ç½®redis\n```yaml\nspring:\n  redis:\n    host: 127.0.0.1\n    port: 6379\n    password: 1a2b3c\n    lettuce:\n      pool:\n        max-active: 8\n        max-idle: 8\n        min-idle: 0\n        max-wait: 100ms\n```\n\n- æµ‹è¯•\n```java\n// å› ä¸ºæœ‰äº†SpringBootè‡ªåŠ¨è£…é…çš„åŠ æŒï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™ç›´æ¥æ³¨å…¥å³å¯\n@Autowired\nprivate RedisTemplate redisTemplate;\n\n@Test\nvoid stringTest(){\n    redisTemplate.opsForValue().set(\"username\", \"SmallBoat\");\n    String username = (String) redisTemplate.opsForValue().get(\"username\");\n    System.out.println(username);\n}\n```\n<a name=\"qh8Dg\"></a>\n#### 5.3.3 åºåˆ—åŒ–\nRedisTemplateå¯ä»¥æ¥æ”¶ä»»æ„Objectä½œä¸ºå€¼å†™å…¥Redisï¼Œåªä¸è¿‡å†™å…¥å‰ä¼šæŠŠObjectåºåˆ—åŒ–ä¸ºå­—èŠ‚å½¢å¼ï¼Œé»˜è®¤æ˜¯é‡‡ç”¨JDKåºåˆ—åŒ–ï¼Œå¾—åˆ°çš„ç»“æœç±»ä¼¼äºï¼š`\\xAC\\xED\\x00\\x05t\\x00\\x06\\xE5\\xBC\\xA0\\xE4\\xB8\\x89`<br />æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœä½¿ç”¨é»˜è®¤çš„åºåˆ—åŒ–å·¥å…·ï¼Œä¸ä»…å¯è¯»æ€§å·®ï¼Œè€Œä¸”è¿˜æµªè´¹å†…å­˜ã€‚äºæ˜¯æˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰RedisTemplateçš„åºåˆ—åŒ–æ–¹å¼ã€‚<br />**è‡ªå®šä¹‰åºåˆ—åŒ–ï¼š**\n\n- ç¼–å†™Redisé…ç½®ç±»\n```java\n@Configuration\npublic class RedisConfig {\n\n    @Bean\n    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory connectionFactory) {\n        // åˆ›å»ºRedisTemplateå¯¹è±¡\n        RedisTemplate<String, Object> template = new RedisTemplate<>();\n        // è®¾ç½®è¿æ¥å·¥å‚\n        template.setConnectionFactory(connectionFactory);\n        // åˆ›å»ºJSONåºåˆ—åŒ–å·¥å…·\n        GenericJackson2JsonRedisSerializer jsonRedisSerializer =\n                new GenericJackson2JsonRedisSerializer();\n        // è®¾ç½®Keyçš„åºåˆ—åŒ–\n        template.setKeySerializer(RedisSerializer.string());\n        template.setHashKeySerializer(RedisSerializer.string());\n        // è®¾ç½®Valueçš„åºåˆ—åŒ–\n        template.setValueSerializer(jsonRedisSerializer);\n        template.setHashValueSerializer(jsonRedisSerializer);\n        // è¿”å›\n        return template;\n    }\n}\n```\n\n- å¾—åˆ°çš„å­˜å‚¨ç»“æœ\n```json\n{\n  \"@class\": \"com.cxc.pojo.User\",\n  \"name\": \"SmallBoat\",\n  \"age\": 18\n}\n```\n> ç”±äºæˆ‘ä»¬ä½¿ç”¨äº†Jsonåºåˆ—åŒ–ä»£æ›¿jdkåºåˆ—åŒ–ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨è‡ªå®šä¹‰åºåˆ—åŒ–åï¼Œæ•´ä½“å¯è¯»æ€§å¾—åˆ°æå‡ï¼Œä¸”èƒ½å°†Javaå¯¹è±¡è‡ªåŠ¨çš„åºåˆ—åŒ–ä¸ºJSONå­—ç¬¦ä¸²ï¼Œå¹¶ä¸”æŸ¥è¯¢æ—¶è¿˜èƒ½è‡ªåŠ¨æŠŠJSONååºåˆ—åŒ–ä¸ºJavaå¯¹è±¡ã€‚ä½†æ˜¯ï¼Œåœ¨å­˜æ•°æ®æ—¶ä¼šè®°å½•åºåˆ—åŒ–æ—¶å¯¹åº”çš„Classåç§°ï¼ˆä¸ºäº†æŸ¥è¯¢æ—¶å®ç°è‡ªåŠ¨ååºåˆ—åŒ–ï¼‰ï¼Œè¿™ä¼šå¸¦æ¥é¢å¤–çš„å†…å­˜å¼€é”€ã€‚å› æ­¤ï¼Œå†ä»‹ç»ä¸€ç§æ–¹æ¡ˆï¼šStringRedisTemplate\n\n<a name=\"kGAlK\"></a>\n#### 5.3.4 StringRedisTemplate\nä¸ºäº†èŠ‚çœå†…å­˜ç©ºé—´ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ä½¿ç”¨JSONåºåˆ—åŒ–å™¨æ¥å¤„ç†valueï¼Œè€Œæ˜¯ç»Ÿä¸€ä½¿ç”¨Stringåºåˆ—åŒ–å™¨ï¼Œè¿™æ ·å°±åªèƒ½å­˜å‚¨Stringç±»å‹çš„keyå’Œvalueã€‚æ‰€ä»¥ï¼Œå½“éœ€è¦å­˜å‚¨Javaå¯¹è±¡æ—¶ï¼Œéœ€è¦æ‰‹åŠ¨å®Œæˆå¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚å› ä¸ºå­˜å…¥å’Œè¯»å–æ—¶çš„åºåˆ—åŒ–åŠååºåˆ—åŒ–éƒ½æ˜¯æˆ‘ä»¬è‡ªå·±å®ç°çš„ï¼ŒSpringDataRediså°±ä¸ä¼šå°†classä¿¡æ¯å†™å…¥Redisã€‚<br />ç”±äºè¿™ç§ç”¨æ³•æ¯”è¾ƒæ™®éï¼Œäºæ˜¯ä¹SpringDataRediså°±æä¾›äº†RedisTemplateçš„å­ç±»ï¼šStringRedisTemplateï¼Œå®ƒçš„keyå’Œvalueçš„åºåˆ—åŒ–æ–¹å¼é»˜è®¤å°±æ˜¯Stringæ–¹å¼ã€‚<br />**StringRedisTemplateæºç ï¼š**\n```java\npublic class StringRedisTemplate extends RedisTemplate<String, String> {\n    public StringRedisTemplate() {\n        this.setKeySerializer(RedisSerializer.string());\n        this.setValueSerializer(RedisSerializer.string());\n        this.setHashKeySerializer(RedisSerializer.string());\n        this.setHashValueSerializer(RedisSerializer.string());\n    }\n\n    public StringRedisTemplate(RedisConnectionFactory connectionFactory) {\n        this();\n        this.setConnectionFactory(connectionFactory);\n        this.afterPropertiesSet();\n    }\n\n    protected RedisConnection preProcessConnection(RedisConnection connection, boolean existingConnection) {\n        return new DefaultStringRedisConnection(connection);\n    }\n}\n```\næœ‰äº†StringRedisTemplateï¼Œæˆ‘ä»¬å°±ä¸éœ€è¦å†è¿›è¡Œè‡ªå®šä¹‰åºåˆ—åŒ–äº†ï¼Œè€Œæ˜¯ç›´æ¥è¿›è¡Œä½¿ç”¨ã€‚\n\n- æµ‹è¯•\n```java\n// ä½¿ç”¨StringRedisTemplateæµ‹è¯•String\n@Test\nvoid stringTest() throws JsonProcessingException {\n    // åˆ›å»ºå¯¹è±¡\n    User user = new User(\"SmallBoat\", 18);\n    // æ‰‹åŠ¨åºåˆ—åŒ–\n    String userjson = mapper.writeValueAsString(user);\n    // å†™å…¥æ•°æ®\n    stringRedisTemplate.opsForValue().set(\"userjson\", userjson);\n    // è·å–æ•°æ®\n    String getUserjson = stringRedisTemplate.opsForValue().get(\"userjson\");\n    // æ‰‹åŠ¨ååºåˆ—åŒ–\n    User getUser = mapper.readValue(getUserjson, User.class);\n    System.out.println(getUser);\n}\n```\n\n- å­˜å‚¨ç»“æœ\n```json\n{\n  \"name\": \"SmallBoat\",\n  \"age\": 18\n}\n```\n\n","categories":["Redis"]},{"title":"King of Botsé¡¹ç›®ç¬”è®°","url":"/2024/02/27/King of Botsé¡¹ç›®ç¬”è®°/","content":"\n<a name=\"xvTck\"></a>\n## 1. é¡¹ç›®è§„åˆ’\n- ä½¿ç”¨å‰åç«¯åˆ†ç¦»æ–¹å¼å®Œæˆæœ¬é¡¹ç›®ã€‚å…¶ä¸­ï¼Œå‰ç«¯ä½¿ç”¨`Vue3`å®Œæˆï¼Œåç«¯ä½¿ç”¨`SpringBoot2`å®Œæˆã€‚\n\n![](https://cdn.acwing.com/media/article/image/2024/03/03/126318_235f9eadd9-1.é¡¹ç›®è§„åˆ’.png)\n\n- æŠ€æœ¯æ ˆï¼š\n\n| **æŠ€æœ¯** | **è¯´æ˜** |\n| :-: | :-: |\n| SpringBoot | å®¹å™¨+MVCæ¡†æ¶ |\n| mysql | å…³ç³»å‹æ•°æ®åº“ |\n| JWT | ç™»å½•æ”¯æŒ |\n| SpringSecurity | éªŒè¯å’Œæˆæƒæ¡†æ¶ |\n| Redis | ç¼“å­˜æ•°æ®åº“ |\n| Lombok | ç®€åŒ–å¯¹è±¡å°è£…å·¥å…· |\n| MyBatisPlus | ORMæ¡†æ¶ |\n| MicroServiceï¼ˆSpringCloudï¼‰ | å¾®æœåŠ¡ |\n\n- é¡¹ç›®ï¼ˆæ¸¸æˆï¼‰è®¾è®¡é€»è¾‘ï¼š\n\n![](https://cdn.acwing.com/media/article/image/2024/03/03/126318_1d7f8b70d9-1.2.é¡¹ç›®é€»è¾‘è®¾è®¡.png)\n<a name=\"P2aiK\"></a>\n## 2. ç¯å¢ƒé…ç½®ä¸é¡¹ç›®åˆ›å»º\n<a name=\"ue2bM\"></a>\n### 2.1 é¡¹ç›®è®¾è®¡\n\n- åç§°ï¼š`King Of Bots`\n- é¡¹ç›®åŒ…å«çš„æ¨¡å—\n- PKæ¨¡å—ï¼šåŒ¹é…ç•Œé¢ï¼ˆå¾®æœåŠ¡ï¼‰ã€å®å†µç›´æ’­ç•Œé¢ï¼ˆ`WebSocket`åè®®ï¼‰\n   - å¯¹å±€åˆ—è¡¨æ¨¡å—ï¼šå¯¹å±€åˆ—è¡¨ç•Œé¢ã€å¯¹å±€å½•åƒç•Œé¢\n   - æ’è¡Œæ¦œæ¨¡å—ï¼š`Bot`æ’è¡Œæ¦œç•Œé¢\n   - ç”¨æˆ·ä¸­å¿ƒæ¨¡å—ï¼šæ³¨å†Œç•Œé¢ã€ç™»å½•ç•Œé¢ã€æˆ‘çš„`Bot`ç•Œé¢ã€æ¯ä¸ª`Bot`çš„è¯¦æƒ…ç•Œé¢\n- å‰åç«¯åˆ†ç¦»æ¨¡å¼\n   - `SpringBoot`å®ç°åç«¯\n   - `Vue3`å®ç°`Web`ç«¯å’Œ`AcApp`ç«¯\n   <a name=\"VPYFM\"></a>\n### 2.2 é…ç½®gitç¯å¢ƒ\n\n1. å®‰è£…`Git Bash`ï¼š[https://gitforwindows.org/](https://gitforwindows.org/)\n2. è¿›å…¥å®¶ç›®å½•ç”Ÿæˆç§˜é’¥ï¼šæ‰§è¡Œå‘½ä»¤`ssh-keygen`\n3. å°†`id_rsa.pub`çš„å†…å®¹å¤åˆ¶åˆ°`github`ä¸Š\n<a name=\"UX9s1\"></a>\n### 2.3 åˆ›å»ºé¡¹ç›®å‰åç«¯\n\n- åç«¯ï¼šä½¿ç”¨`Spring Initilizr`åˆ›å»ºåç«¯ï¼Œä½¿ç”¨`2.3.7REALESE`ç‰ˆæœ¬ï¼Œæ·»åŠ `SpringBoot Web Starter`æ’ä»¶ã€‚\n- å‰ç«¯ï¼šä½¿ç”¨`Vue cli`è„šæ‰‹æ¶åˆ›å»ºé¡¹ç›®ï¼Œæ·»åŠ `Vue Router`å’Œ`VueX`æ’ä»¶ï¼Œæ·»åŠ `BootStrap`ä¸`jquery`ä¾èµ–ã€‚ï¼ˆ`Vue ui`åˆ›å»ºå‰ç«¯æœ‰ç‚¹å¥‡æ€ªçš„`bug`ï¼Œé€‰æ‹©ä½ç½®æ—¶ä¸é€‰æ‹©é»˜è®¤ç›˜ç¬¦ä¸‹çš„ä½ç½®å°±æŠ¥é”™ï¼Œå…ˆåœ¨è¯¥ç›˜ç¬¦åˆ›å»ºå†ç§»åŠ¨åˆ°ç›®æ ‡ç›˜ç¬¦å»ï¼‰\n<a name=\"VBmjE\"></a>\n## 3. åˆ›å»ºå‰ç«¯åŸºç¡€é¡µé¢\n<a name=\"chK2N\"></a>\n### 3.1 åˆ›å»ºå¯¼èˆªæ åŠé¡µé¢\n![image.png](https://cdn.acwing.com/media/article/image/2024/03/03/126318_2aa880d4d9-3.1åˆ›å»ºå¯¼èˆªæ .png)<br />é€šè¿‡åˆ›å»ºå„ä¸ªé¡µé¢çš„`view`ï¼Œä¸»è¦åŒ…æ‹¬`error, pk, ranklist, record, user-bot`é¡µé¢ã€‚ç„¶ååœ¨å¯¼èˆªæ ä¸­é€šè¿‡`router`è¿›è¡Œè·³è½¬ã€‚<br />é€šè¿‡å¦‚ä¸‹æ–¹å¼å®æ—¶è®¡ç®—å½“å‰é¡µé¢ä½äºå“ªä¸ªéƒ¨åˆ†ï¼Œä»¥ä¾¿äºé«˜äº®å¯¼èˆªæ ä¸­çš„å¯¹åº”éƒ¨åˆ†ï¼š\n```javascript\nconst route = useRoute();\nlet route_name = computed(() => route.name)\nreturn {\n  route_name\n}\n```\n<a name=\"cfwHz\"></a>\n### 3.2 åˆ›å»ºæ¸¸æˆåœ°å›¾\n![image.png](https://cdn.acwing.com/media/article/image/2024/03/03/126318_301badf5d9-3.2åˆ›å»ºæ¸¸æˆåœ°å›¾.png)<br />é¦–å…ˆåˆ›å»ºæ¸¸æˆåœ°å›¾åŸºç±»`AcGameObject`ï¼Œç„¶åé€šè¿‡ç»§æ‰¿è¯¥ç±»å®ç°`GameMap`æ¸¸æˆåœ°å›¾æ¸²æŸ“ç±»ã€‚\n\n- åœ¨`AcGameObject`ä¸­ï¼Œé€šè¿‡`requestAnimationFrame(step)`é€’å½’å®ç°æ¯`60`å¸§ï¼ˆå› æ˜¾ç¤ºå™¨è€Œå¼‚ï¼‰çš„å®æ—¶æ¸²æŸ“æ¸¸æˆç”»é¢ã€‚\n- åœ¨`GameMap`ä¸­ï¼Œå…ˆå°†æ¸¸æˆèƒŒæ™¯ï¼ˆç»¿å¸ƒï¼‰æ¸²æŸ“å‡ºæ¥ï¼Œç„¶ååˆ›å»ºå››å‘¨å¢™å£ï¼Œå†éšæœºç”Ÿæˆå†…éƒ¨å¢™ä½“éšœç¢ç‰©ï¼Œæ¯ç”Ÿæˆä¸€ç§æ–¹æ¡ˆï¼Œé€šè¿‡`Flood Fill`ç®—æ³•æ£€éªŒå·¦ä¸‹è§’ä¸å³ä¸Šè§’çš„è¿é€šæ€§ï¼Œå¦‚æœä¸è¿é€šåˆ™é‡æ–°ç”Ÿæˆã€‚\n\n**æ³¨æ„ï¼š** åœ¨åæœŸä¼šå°†ç”Ÿæˆåœ°å›¾çš„é€»è¾‘æ”¾åˆ°åç«¯ï¼ˆå‰ç«¯åªè´Ÿè´£æ¸²æŸ“ï¼Œæš‚æ—¶æ”¾åœ¨å‰ç«¯ä¾¿äºå½“å‰è°ƒè¯•ï¼‰ï¼Œé¿å…ä¸¤åç”¨æˆ·ä¸­æœ‰äººä¿®æ”¹å‰ç«¯ä»£ç é€ æˆä¸å…¬å¹³çš„æƒ…å†µã€‚ä¸æ­¤åŒæ—¶ï¼Œç”Ÿæˆçš„åœ°å›¾ä¸º$13 \\times 14$çš„å¸ƒå±€ï¼Œå¹¶ç¡®ä¿å…¶æ˜¯ä¸­å¿ƒå¯¹ç§°çš„ã€‚\n> è®¾è®¡æˆ$13 \\times 14$ä¸»è¦æ˜¯ä¸ºäº†é¿å…ä¸¤æ¡è›‡å¤´èƒ½åŒæ—¶åˆ°è¾¾ä¸€ä¸ªç‚¹çš„æƒ…å†µï¼ˆå¹³å±€ï¼‰ï¼Œé¿å…é€ æˆå¯¹ä¼˜åŠ¿æ–¹ä¸åˆ©çš„æƒ…å†µã€‚\n> è§£é‡Šï¼šè‹¥è®¾è®¡ä¸º$13 \\times 13$ï¼Œåˆ™åˆšå¼€å§‹ä¸¤æ¡è›‡çš„è›‡å¤´åæ ‡ä¸º`(1, 13), (13, 1)`ï¼ŒåŒæ–¹æ¯èµ°ä¸€æ­¥ï¼Œæ¨ªçºµåæ ‡ä¹‹å’Œçš„å˜åŒ–éƒ½æ˜¯ç›¸åŒçš„ï¼ˆå¶ã€å¥‡ã€å¶ã€å¥‡â€¦â€¦ï¼‰ï¼Œè®¾è®¡æˆ$13 \\times 14$åˆ™åˆšå¼€å§‹ä¸¤è›‡å¤´çš„åæ ‡ä¸º`(1, 14), (13, 1)`ï¼Œåˆ™åŒæ–¹æ¯èµ°ä¸€æ­¥æ¨ªçºµåæ ‡ä¹‹å’Œä¸å¯èƒ½ç›¸ç­‰ï¼Œæ„å‘³ç€åŒæ–¹çš„è›‡å¤´ä¸å¯èƒ½åœ¨åŒä¸€æ—¶é—´è¿›å…¥åŒä¸€ä¸ªæ ¼å­ã€‚\n\n<a name=\"BUfE6\"></a>\n### 3.3 åˆ›å»ºè›‡ç±»\n![image.png](https://cdn.acwing.com/media/article/image/2024/03/03/126318_35da8150d9-3.3åˆ›å»ºè›‡ç±».png)åœ¨åˆ›å»ºè›‡ç±»å‰ï¼Œå…ˆè¦åˆ›å»ºè›‡çš„èº«ä½“ç±»ï¼ˆå³`Cell`ç±»ï¼‰ï¼š\n```javascript\nexport class Cell {\n  constructor(r, c) {\n    // æ ¼å­åæ ‡\n    this.r = r; \n    this.c = c;\n    \n    this.x = c + 0.5; // åœ†å¿ƒæ¨ªåæ ‡\n    this.y = r + 0.5; // åœ†å¿ƒçºµåæ ‡\n  }\n}\n```\nåœ¨å®šä¹‰è›‡ç±»æ—¶ï¼Œéœ€è¦å®šä¹‰å…¶çŠ¶æ€ã€å½“å‰ç§»åŠ¨æ–¹å‘ã€çœ¼ç›çš„åç§»æ–¹å‘ã€‚è›‡çš„ç§»åŠ¨æ–¹å¼ä¸ºæ¯ç§»åŠ¨ä¸€æ­¥ï¼Œè›‡å¤´å‘å‰ä¸€æ­¥ï¼Œè›‡å°¾ç æ‰ï¼Œèº«ä½“ä¿æŒä¸åŒï¼ˆå‰10æ­¥ï¼Œè›‡å°¾ä¸ç”¨ç§»åŠ¨ï¼Œæ¯æ¬¡ç§»åŠ¨åªè›‡å¤´å‘å‰ç§»åŠ¨å³å¯ï¼Œé•¿åº¦åŠ 1ï¼Œä¹‹åæ¯3æ­¥å¢é•¿ä¸€æ ¼ï¼‰ã€‚\n> è›‡çš„èº«ä½“ä¸ºä¸€ä¸ªä¸ªåœ†å½¢`Cell`ç»„æˆï¼Œå› æ­¤ï¼Œæ¯ä¸¤ä¸ª`Cell`é—´ç”¨é•¿æ–¹å½¢è¿›è¡Œå¡«å……ï¼Œè¿™æ ·å°±åªæœ‰å¤´å’Œå°¾çš„`Cell`æœ‰åœ†å¼§ï¼Œçœ‹èµ·æ¥ä¼šæ¯”è¾ƒæ­£å¸¸ã€‚\n\nåœ¨ç§»åŠ¨æ—¶ï¼Œé€šè¿‡è›‡ç±»ä¸­çš„å‡½æ•°è®¾ç½®å½“å‰æ­¥çš„å‰è¿›æ–¹å‘ï¼Œç„¶ååœ¨åœ°å›¾ç±»ä¸­è¿›è¡Œç›‘å¬ç”¨æˆ·æ“ä½œï¼ˆåç»­æ¥å…¥ä»£ç æ“ä½œåï¼Œä¹Ÿå°†è°ƒç”¨æ­¤å‡½æ•°è®¾ç½®è›‡è›‡çš„ç§»åŠ¨æ–¹å‘ï¼‰ï¼š\n```javascript\nset_direction(d) {\n  this.direction = d;\n}\n```\nç„¶ååˆ¤æ–­è›‡çš„å­˜æ´»çŠ¶æ€ï¼ˆåœ¨åœ°å›¾ç±»ä¸­è¿›è¡Œåˆ¤æ–­ï¼Œè€Œä¸æ˜¯åœ¨è›‡ç±»ä¸­åˆ¤æ–­ï¼‰ï¼š\n```javascript\ncheck_valid(cell) {  // æ£€æµ‹ç›®æ ‡ä½ç½®æ˜¯å¦åˆæ³•ï¼šæ²¡æœ‰æ’åˆ°ä¸¤æ¡è›‡çš„èº«ä½“å’Œéšœç¢ç‰©\n  for (const wall of this.walls) {\n      if (wall.r === cell.r && wall.c === cell.c)\n          return false;\n  }\n  for (const snake of this.snakes) {\n      let k = snake.cells.length;\n      if (!snake.check_tail_increasing()) {  // å½“è›‡å°¾ä¼šå‰è¿›çš„æ—¶å€™ï¼Œè›‡å°¾ä¸ç”¨åˆ¤æ–­\n          k -- ;\n      }\n      for (let i = 0; i < k; i ++ ) {\n          if (snake.cells[i].r === cell.r && snake.cells[i].c === cell.c)\n              return false;\n      }\n  }\n  return true;\n}\n```\n<a name=\"KM6d4\"></a>\n## 4. é…ç½®MySqlä¸å®ç°æ³¨å†Œç™»å½•æ¨¡å—\nåœ¨`pom.xml`æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹ä¾èµ–ï¼š\n```xml\n<dependency>\n    <groupId>org.springframework.boot</groupId>\n    <artifactId>spring-boot-starter-jdbc</artifactId>\n</dependency>\n<dependency>\n    <groupId>org.projectlombok</groupId>\n    <artifactId>lombok</artifactId>\n    <version>1.18.24</version>\n    <scope>provided</scope>\n</dependency>\n<dependency>\n    <groupId>com.mysql</groupId>\n    <artifactId>mysql-connector-j</artifactId>\n    <version>8.0.33</version>\n</dependency>\n<dependency>\n    <groupId>com.baomidou</groupId>\n    <artifactId>mybatis-plus-boot-starter</artifactId>\n    <version>3.5.2</version>\n</dependency>\n<dependency>\n    <groupId>com.baomidou</groupId>\n    <artifactId>mybatis-plus-generator</artifactId>\n    <version>3.5.3</version>\n</dependency>\n<dependency>\n    <groupId>org.springframework.boot</groupId>\n    <artifactId>spring-boot-starter-security</artifactId>\n    <version>3.1.5</version>\n</dependency>\n```\n<a name=\"IdcIv\"></a>\n### 4.1 æ•°æ®åº“é…ç½®\næ•°æ®åº“ä½¿ç”¨`MySql8.0`ç‰ˆæœ¬ï¼Œå¹¶åˆ›å»º`user`è¡¨ã€‚`YAML`ç›¸å…³é…ç½®å¦‚ä¸‹ï¼š\n```yaml\n# é…ç½®æ•°æ®åº“è¿æ¥\nspring:\n  datasource:\n    username: root\n    password: xxxxxxx\n    url: jdbc:mysql://localhost:3306/kob?serverTimezone=Asia/Shanghai&useUnicode=true&characterEncoding=utf-8\n    driver-class-name: com.mysql.cj.jdbc.Driver\n```\n<a name=\"qaDya\"></a>\n### 4.2 ç™»å½•æ ¡éªŒæ¨¡å—\n<a name=\"KX9uz\"></a>\n#### 4.2.1 åŸºæœ¬ç™»å½•åŠŸèƒ½\nç™»å½•æ¨¡å—åˆ©ç”¨`SpringSecurity`è‡ªå¸¦çš„åŠŸèƒ½å³å¯å®Œæˆã€‚é€šè¿‡é…ç½®`SecurityConfig`é…ç½®ç±»ã€å†å®ç°`UserDetailsService, UserDetails`ä¸¤ä¸ªæ¥å£å³å¯ã€‚åœ¨`UserDetailsServiceImpl`ä¸­å…ˆæ ¡éªŒç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼Œå†è¿”å›ä¸€ä¸ª**åŒ…å«ç”¨æˆ·ä¿¡æ¯**çš„`UserDetailsImpl`å¯¹è±¡ç”¨äºæ ¡éªŒç”¨æˆ·åˆæ³•æ€§ï¼ˆåŒ…æ‹¬å¯†ç æ ¡éªŒã€ç”¨æˆ·æ˜¯å¦å¤±æ•ˆã€ç”¨æˆ·æ˜¯å¦è¢«é”ç­‰ç­‰ï¼‰ã€‚\n<a name=\"StVor\"></a>\n#### 4.2.2 å¼•å…¥[JWT](https://www.yuque.com/cxc_lhl/iupfzc/krkag1qcw9gl91u4#xFIlJ)è®¤è¯\nä¸ºäº†ä½¿ç”¨`jwt`è®¤è¯ï¼Œå…ˆåœ¨`pom.xml`æ–‡ä»¶ä¸­å¼•å…¥ä¸€ä¸‹ä¾èµ–ï¼š\n```xml\n<dependency>\n    <groupId>io.jsonwebtoken</groupId>\n    <artifactId>jjwt-api</artifactId>\n    <version>0.11.2</version>\n</dependency>\n<dependency>\n    <groupId>io.jsonwebtoken</groupId>\n    <artifactId>jjwt-impl</artifactId>\n    <version>0.11.2</version>\n    <scope>runtime</scope>\n</dependency>\n<dependency>\n    <groupId>io.jsonwebtoken</groupId>\n    <artifactId>jjwt-jackson</artifactId>\n    <version>0.11.2</version>\n    <scope>runtime</scope>\n</dependency>\n```\n\n1. å®ç°`JwtUtil`ç±»ï¼Œç”¨äºç”Ÿæˆå’Œè§£æ`jwt`ã€‚\n2. å®ç°`JwtAuthenticationTokenFilter`ç±»ï¼Œç”¨äºéªŒè¯ç”¨æˆ·ä¼ é€’è¿‡æ¥çš„`jwt`ï¼ŒéªŒè¯æˆåŠŸåï¼Œå½“å‰ç”¨æˆ·çš„ä¿¡æ¯å°†ä¼šè¢«æ³¨å…¥ä¸Šä¸‹æ–‡ä¸­ã€‚\n3. ä¿®æ”¹`SecurityConfig`æ”¾è¡Œ`token`åŠ`register`è¯·æ±‚ã€‚\n```java\n@Override\nprotected void configure(HttpSecurity http) throws Exception {\n    http.csrf()\n        .disable()\n        .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)\n        .and()\n        .authorizeRequests()\n        .antMatchers(\"/user/account/token/\", \"/user/account/register/\").permitAll()\n        .antMatchers(HttpMethod.OPTIONS).permitAll()\n        .anyRequest().authenticated();\n    http.addFilterBefore(jwtAuthenticationTokenFilter, UsernamePasswordAuthenticationFilter.class);\n}\n```\n\n- å†åˆ†åˆ«åˆ›å»ºä¸‰ä¸ªæ¥å£`/user/account/token/, /user/account/info/, /user/account/register/`ç”¨äºè·å–`token`ã€è·å–ç”¨æˆ·ä¿¡æ¯ã€ç”¨æˆ·æ³¨å†Œã€‚\n> åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œå‘ç°ä¸€ä¸ªéœ€è¦æ³¨æ„çš„ç»†èŠ‚ï¼Œåœ¨æµè§ˆå™¨ä¸­å¤åˆ¶ç”Ÿæˆçš„`token`æ—¶ï¼Œéœ€è¦å°†å…¶ç‚¹å¼€å†å¤åˆ¶ï¼Œå› ä¸ºå½“ä½ç½®ä¸å¤Ÿæ—¶ï¼Œä¸­é—´å¾ˆé•¿ä¸€éƒ¨åˆ†ä¼šä»¥çœç•¥å·å½¢å¼å±•ç¤ºï¼Œå¤åˆ¶åæ ¹æœ¬æ— æ³•å‘å‡ºè¯·æ±‚ã€‚\n\n<a name=\"JrIwT\"></a>\n### 4.3 å‰ç«¯æ³¨å†Œé¡µé¢å®ç°\næ³¨å†Œé¡µé¢ä¸ç™»å½•é¡µé¢æå…¶ç±»ä¼¼ï¼Œç›´æ¥å¤åˆ¶è¿‡æ¥ä¿®æ”¹ä¸€ä¸‹å³å¯ã€‚<br />![image.png](https://cdn.acwing.com/media/article/image/2024/03/03/126318_3991b228d9-4.3å‰ç«¯æ³¨å†Œé¡µé¢å®ç°.png)\n<a name=\"DuFMp\"></a>\n### 4.4 å°†jwtä¿¡æ¯å­˜è¿›localStorage\næ¯å½“ç”¨æˆ·ç™»å½•æˆåŠŸæ—¶ï¼Œæˆ‘ä»¬å°±å°†å…¶è·å–åˆ°çš„`jwt`å­˜è¿›`localStorage`ä¸­ã€‚\n```javascript\nlocalStorage.setItem(\"jwt\", resp.token)\n```\nç„¶ååœ¨æ¯æ¬¡è·¯ç”±è·³è½¬åˆ°ç™»å½•é¡µæ—¶ï¼Œå…ˆå–å‡º`localStorage`ä¸­çš„`jwt`ä¿¡æ¯ï¼Œç„¶åå‘é€è·å–ç”¨æˆ·ä¿¡æ¯çš„è¯·æ±‚ä»¥æ ¡éªŒå½“å‰çš„`jwt`æ˜¯å¦è¿‡æœŸã€‚\n```javascript\nconst jwt = localStorage.getItem(\"jwt\")\nif (jwt) {\n  store.commit(\"updateToken\", jwt)\n  store.dispatch(\"getInfo\", {\n    success() {\n      router.push({name: \"home\"})\n      store.commit(\"updatePullingInfo\", false)\n    },\n    error() {\n      store.commit(\"updatePullingInfo\", false)\n    }\n  })\n} else {\n  store.commit(\"updatePullingInfo\", false)\n}\n```\nå¦‚æœæˆåŠŸï¼Œåˆ™è·¯ç”±ç›´æ¥è·³è½¬åˆ°é¦–é¡µï¼Œå¦åˆ™æ˜¾ç¤ºç™»å½•é¡µè®©ç”¨æˆ·é‡æ–°ç™»å½•ã€‚\n> å…¶ä¸­ï¼Œ`updatePullingInfo`æ˜¯`user.js`ä¸­çš„ç”¨äºä¿®æ”¹å…¨å±€å˜é‡`pulling_info`çš„å‡½æ•°ï¼Œ`pulling_info`ç”¨äºæ§åˆ¶å½“å‰æ˜¯å¦å¤„äºè·å–ç”¨æˆ·ä¿¡æ¯çŠ¶æ€ï¼ˆé¿å…æ­¤æ—¶ç™»å½•é¡µä¼šé—ªä¸€ä¸‹çš„é—®é¢˜ï¼‰ï¼Œå½“ç”¨æˆ·ä¿¡æ¯æ‹‰å–å®Œæ¯•æ—¶ï¼ŒæˆåŠŸå°±è·³è½¬é¦–é¡µï¼Œå¤±è´¥å°±æ­£å¸¸æ˜¾ç¤ºç™»å½•é¡µã€‚\n\n```javascript\nupdatePullingInfo(state, pulling_info) {\n    state.pulling_info = pulling_info\n}\n```\n<a name=\"lVLd6\"></a>\n## 5. ä¸ªäººä¸­å¿ƒï¼ˆæˆ‘çš„Botï¼‰\n<a name=\"p2qBF\"></a>\n### 5.1 Botçš„CRUDï¼ˆåç«¯ï¼‰\n`Bot`çš„`CRUD`æ˜¯ä¸€äº›æ¯”è¾ƒé‡å¤æ€§çš„å·¥ä½œï¼Œæ­¤å¤„ä»¥`add`ä¸¾ä¾‹ã€‚\n```java\n@Override\npublic Map<String, String> add(Map<String, String> botData) {\n    UsernamePasswordAuthenticationToken authenticationToken =\n            (UsernamePasswordAuthenticationToken) SecurityContextHolder.getContext().getAuthentication();\n    UserDetailsImpl loginUser = (UserDetailsImpl) authenticationToken.getPrincipal();\n    User user = loginUser.getUser();\n\n    String title = botData.get(\"title\");\n    String description = botData.get(\"description\");\n    String content = botData.get(\"content\");\n\n    Map<String, String> map = new HashMap<>();\n\n    if (null == title || title.length() == 0) {\n        map.put(\"error_massage\", \"Botæ ‡é¢˜ä¸èƒ½ä¸ºç©ºï¼\");\n        return map;\n    }\n    if (title.length() > 50) {\n        map.put(\"error_message\", \"Botæ ‡é¢˜é•¿åº¦ä¸èƒ½è¶…è¿‡50ï¼\");\n        return map;\n    }\n\n    // æè¿°å¯ä»¥ä¸ºç©º\n    if (null == description || description.length() == 0) {\n        description = \"è¿™ä¸ªç”¨æˆ·å¾ˆæ‡’ï¼Œä»€ä¹ˆä¹Ÿæ²¡å†™~\";\n    }\n    if (description.length() > 200) {\n        map.put(\"error_message\", \"Botæè¿°é•¿åº¦ä¸èƒ½è¶…è¿‡200ï¼\");\n        return map;\n    }\n\n    if (null == content || content.length() == 0) {\n        map.put(\"error_message\", \"Botä»£ç ä¸èƒ½ä¸ºç©ºï¼\");\n        return map;\n    }\n    if (content.length() > 10000) {\n        map.put(\"error_message\", \"Botä»£ç é•¿åº¦ä¸èƒ½è¶…è¿‡10000ï¼\");\n        return map;\n    }\n\n    // æ ¡éªŒä¸€ä¸‹è¯¥ botçš„æ ‡é¢˜å’Œä»£ç ï¼Œæ˜¯å¦å·²åˆ›å»ºè¿‡\n    QueryWrapper<Bot> botQueryWrapper = new QueryWrapper<>();\n    botQueryWrapper.eq(\"user_id\", user.getId());\n    botQueryWrapper.and(wrapper -> wrapper.eq(\"content\", content).or().eq(\"title\", title));\n    Long count = botMapper.selectCount(botQueryWrapper);\n    if (count > 0) {\n        map.put(\"error_message\", \"è¯¥Botå·²ç»è¢«ä½ åˆ›å»ºè¿‡å•¦ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„å§ï¼\");\n        return map;\n    }\n\n    Date now = new Date();\n    System.out.println(now);\n    Bot bot = new Bot(null, user.getId(), title, description, content, DEFAULT_RATING, now, now, null);\n    System.out.println(bot);\n\n    int state = botMapper.insert(bot);\n    if (state > 0) {\n        map.put(\"error_message\", \"success\");\n        return map;\n    }\n\n    map.put(\"error_message\", \"åˆ›å»ºå¤±è´¥ï¼\");\n    return map;\n}\n```\n`CRUD`éƒ¨åˆ†åŸºæœ¬éƒ½ç±»ä¼¼ï¼Œä¸»è¦æ˜¯ä¸€äº›é™åˆ¶æ¡ä»¶è¦é™åˆ¶å¥½ï¼Œä¸ç„¶å‰ç«¯ä»£ç å¦‚æœè¢«ä¿®æ”¹ï¼Œæ•°æ®å®‰å…¨æ€§å¾—ä¸åˆ°ä¿è¯ã€‚\n> æ­£å¦‚ yxc æ‰€è¯´ï¼Œå‰ç«¯é˜²å›å­ï¼Œåç«¯é˜²å°äººï¼\n> è¿™é‡Œåˆ›å»ºBotç±»æ—¶æœ‰ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼Œæ—¶åŒºä¸€å®šè¦é€šè¿‡`@JsonFormat(pattern = \"yyyy-MM-dd HH:mm:ss\", timezone = \"Asia/Shanghai\")`è§„å®šå¥½ï¼Œä¸ç„¶ä¼šå‡ºç°å‰åç«¯æ—¶é—´ç›¸å·®8å°æ—¶çš„æƒ…å†µï¼ˆå…·ä½“å¯å‚è€ƒ[ä½¿ç”¨@JsonFormatæ³¨è§£å‰åç«¯æ—¶é—´ç›¸å·®8å°æ—¶](https://blog.csdn.net/m0_65894434/article/details/134997740)ï¼‰ã€‚\n\n<a name=\"bpIYU\"></a>\n### 5.2 Botçš„CRUDï¼ˆå‰ç«¯ï¼‰\nå‰ç«¯å®ç°`CRUD`æ¯”è¾ƒå®¹æ˜“ï¼Œä½¿ç”¨`BootStrap`ä¸­çš„æ ·å¼å³å¯ã€‚å”¯ä¸€éº»çƒ¦ç‚¹çš„æ˜¯å¼•å…¥`ace`ä»£ç ç¼–è¾‘å™¨ã€‚\n\n- **æˆ‘çš„Boté¡µé¢ï¼š**\n\n![image.png](https://cdn.acwing.com/media/article/image/2024/03/03/126318_3e2a0c6bd9-5.2.1æˆ‘çš„boté¡µé¢.png)\n\n- **åˆ›å»ºBotçš„**`Modal`**æ¡†ï¼š**\n\n![image.png](https://cdn.acwing.com/media/article/image/2024/03/03/126318_43f08b5cd9-5.2.2åˆ›å»ºbotçš„modalæ¡†.png)\n\n- **ä¿®æ”¹Botçš„**`Modal`**æ¡†ï¼š**\n\n![image.png](https://cdn.acwing.com/media/article/image/2024/03/03/126318_4684fd31d9-5.2.3ä¿®æ”¹botçš„modalæ¡†.png)\n> æ³¨æ„ï¼šåœ¨å¼•å…¥`ace`ä»£ç ç¼–è¾‘å™¨æ—¶ï¼Œåœ¨è°ƒè¯•æ—¶å¯èƒ½ä¼šå› ä¸ºæµè§ˆå™¨çš„é—®é¢˜è€Œå¯¼è‡´ä»£ç é«˜äº®ã€è‡ªåŠ¨æç¤ºç­‰å‡ºç°ä¸ç¬¦åˆé¢„æœŸçš„é—®é¢˜ï¼Œåˆ‡æ¢æµè§ˆå™¨å°è¯•ä¸€ä¸‹ã€‚\n\n<a name=\"D2Q1e\"></a>\n## 6. å¾®æœåŠ¡ï¼šå®ç°åŒ¹é…ç³»ç»Ÿ\n<a name=\"p1O0M\"></a>\n### 6.1 åç«¯ï¼ˆbackendï¼‰é›†æˆWebSocket\n\n1. åœ¨`pom.xml`æ–‡ä»¶ä¸­æ·»åŠ ä¾èµ–ï¼š\n```xml\n<dependency>\n    <groupId>org.springframework.boot</groupId>\n    <artifactId>spring-boot-starter-websocket</artifactId>\n    <version>2.7.2</version>\n</dependency>\n\n<dependency>\n    <groupId>com.alibaba</groupId>\n    <artifactId>fastjson</artifactId>\n    <version>2.0.11</version>\n</dependency>\n```\n\n2. æ·»åŠ `WebSocketConfig`é…ç½®ç±»ï¼š\n```java\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.web.socket.server.standard.ServerEndpointExporter;\n\n@Configuration\npublic class WebSocketConfig {\n    @Bean\n    public ServerEndpointExporter serverEndpointExporter() {\n\n        return new ServerEndpointExporter();\n    }\n}\n```\n\n3. æ·»åŠ `WebSocketServer`ç±»ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰ï¼š\n```java\npackage com.kob.backend.comsumer;\n\nimport com.alibaba.fastjson.JSON;\nimport com.alibaba.fastjson.JSONObject;\nimport com.kob.backend.comsumer.utils.Game;\nimport com.kob.backend.comsumer.utils.JwtAuthentication;\nimport com.kob.backend.mapper.UserMapper;\nimport com.kob.backend.pojo.User;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.stereotype.Component;\n\nimport javax.websocket.*;\nimport javax.websocket.server.PathParam;\nimport javax.websocket.server.ServerEndpoint;\nimport java.io.IOException;\nimport java.util.Iterator;\nimport java.util.concurrent.ConcurrentHashMap;\nimport java.util.concurrent.CopyOnWriteArraySet;\n\n@Component\n@ServerEndpoint(\"/websocket/{token}\")  // ä¸è¦ä»¥'/'ç»“å°¾\npublic class WebSocketServer {\n\n    private Session session;\n    private User user;\n    // è®°å½•å…¨å±€çš„è¿æ¥ä¿¡æ¯\n    private static final ConcurrentHashMap<Integer, WebSocketServer> users = new ConcurrentHashMap<>();\n\n    private static final CopyOnWriteArraySet<User> matchpool = new CopyOnWriteArraySet<>();\n\n    private static UserMapper userMapper;\n\n    @Autowired\n    public void setUserMapper(UserMapper userMapper) {\n        WebSocketServer.userMapper = userMapper;\n    }\n\n\n    @OnOpen\n    public void onOpen(Session session, @PathParam(\"token\") String token) throws IOException {\n        // å»ºç«‹è¿æ¥\n        this.session = session;\n        Integer userId = JwtAuthentication.getUserId(token);\n        this.user = userMapper.selectById(userId);\n\n        if (null != this.user) {\n            users.put(userId, this);\n            System.out.println(\"connected!\");\n        } else {\n            this.session.close();\n        }\n\n        System.out.println(users);\n\n    }\n\n    @OnClose\n    public void onClose() {\n        // å…³é—­é“¾æ¥\n        System.out.println(\"disconnected!\");\n        if (null != this.user) {\n            users.remove(this.user.getId());\n            matchpool.remove(this.user);\n        }\n    }\n    \n    private void startMatching() {\n        System.out.println(\"start_matching!\");\n        matchpool.add(this.user);\n        // æš‚æ—¶å®ç°ç®€å•åŒ¹é…é€»è¾‘\n        while (matchpool.size() >= 2) {\n            Iterator<User> it = matchpool.iterator();\n            User a = it.next(), b = it.next();\n            matchpool.remove(a);\n            matchpool.remove(b);\n\n            Game game = new Game(13, 14, 20);\n            game.createMap();\n\n            JSONObject respA = new JSONObject();\n            respA.put(\"event\", \"start-matching\");\n            respA.put(\"opponent_username\", b.getUsername());\n            respA.put(\"opponent_photo\", b.getPhoto());\n            respA.put(\"gameMap\", game.getG());\n            users.get(a.getId()).sendMessage(respA.toJSONString());\n\n            JSONObject respB = new JSONObject();\n            respB.put(\"event\", \"start-matching\");\n            respB.put(\"opponent_username\", a.getUsername());\n            respB.put(\"opponent_photo\", a.getPhoto());\n            respB.put(\"gameMap\", game.getG());\n            users.get(b.getId()).sendMessage(respB.toJSONString());\n        }\n    }\n\n    private void stopMatching() {\n        System.out.println(\"stop_matching!\");\n        matchpool.remove(this.user);\n    }\n\n    @OnMessage\n    public void onMessage(String message, Session session) {\n        // ä» Client æ¥æ”¶æ¶ˆæ¯\n        System.out.println(\"receive message!\");\n        JSONObject data = JSON.parseObject(message);\n        String event = data.getString(\"event\");\n        \n        if (\"start-matching\".equals(event)) {\n            startMatching();\n        } else if (\"stop-matching\".equals(event)) {\n            stopMatching();\n        }\n    }\n\n    public void sendMessage(String message) {\n        // ä» server å‘é€æ¶ˆæ¯\n        synchronized (this.session) {\n            try {\n                this.session.getBasicRemote().sendText(message);\n            } catch (IOException e)  {\n                e.printStackTrace();\n            }\n        }\n    }\n\n    @OnError\n    public void onError(Session session, Throwable error) {\n        error.printStackTrace();\n    }\n}\n\n```\n\n4. ä¿®æ”¹`SecurityConfig`æ”¾è¡Œ`\"/websocket/**\"`è¯·æ±‚ï¼š\n```java\n@Override\npublic void configure(WebSecurity web) throws Exception {\n    web.ignoring().antMatchers(\"/websocket/**\");\n}\n```\n\n5. å°†å‰ç«¯ç”Ÿæˆåœ°å›¾çš„é€»è¾‘æ”¾åˆ°åç«¯ï¼š\n```java\npackage com.kob.backend.comsumer.utils;\n\nimport java.util.Arrays;\nimport java.util.Random;\n\npublic class Game {\n    /**\n     * æ¸¸æˆåœ°å›¾è¡Œæ•°\n     */\n    private final Integer rows;\n    /**\n     * æ¸¸æˆåœ°å›¾åˆ—æ•°\n     */\n    private final Integer cols;\n    /**\n     * åœ°å›¾å†…éƒ¨å¢™ä½“éšœç¢ç‰©æ•°é‡\n     */\n    private final Integer innerWallsCount;\n    /**\n     * æ¸¸æˆåœ°å›¾ï¼ˆ0 è¡¨ç¤ºè‰åœ°ï¼Œ1 è¡¨ç¤ºå¢™ä½“éšœç¢ç‰©ï¼‰\n     */\n    private final int[][] g;\n\n    private final static int[] dx = {-1, 0, 1, 0}, dy = {0, 1, 0, -1};\n\n    public Game(Integer rows, Integer cols, Integer innerWallsCount) {\n        this.rows = rows;\n        this.cols = cols;\n        this.innerWallsCount = innerWallsCount;\n        this.g = new int[rows][cols];\n    }\n\n    public int[][] getG() {\n        return g;\n    }\n\n    // Flood Fill æ ¡éªŒåœ°å›¾è¿é€šæ€§\n    public boolean checkConnectivity(int sx, int sy, int tx, int ty) {\n        if (sx == tx && sy == ty) return true;\n        // è¡¨ç¤ºå·²ç»èµ°è¿‡\n        g[sx][sy] = 1;\n        for (int d = 0; d < 4; d ++) {\n            int a = sx + dx[d], b = sy + dy[d];\n            if (a >= 0 && a < this.rows && b >= 0 && b < this.cols && g[a][b] == 0) {\n                if (checkConnectivity(a, b, tx, ty)) {\n                    // æ¢å¤ç°åœº\n                    g[sx][sy] = 0;\n                    return true;\n                }\n            }\n        }\n        // å³ä½¿æ ¡éªŒå¤±è´¥ä¹Ÿè¦æ¢å¤ç°åœº\n        g[sx][sy] = 0;\n        return false;\n\n    }\n\n    // ç”»åœ°å›¾\n    private boolean draw() {\n        // åˆå§‹åŒ–åœ°å›¾\n        for (int i = 0; i < g.length; i ++) {\n            Arrays.fill(g[i], 0);\n        }\n        // ç”Ÿæˆå››å‘¨å¢™ä½“éšœç¢ç‰©\n        for (int r = 0; r < this.rows; r ++) {\n            g[r][0] = g[r][this.cols - 1] = 1;\n        }\n        for (int c = 0; c < this.cols; c ++) {\n            g[0][c] = g[this.rows - 1][c] = 1;\n        }\n        // ç”Ÿæˆåœ°å›¾å†…éƒ¨éšæœºå¢™ä½“éšœç¢ç‰©\n        Random random = new Random();\n        for (int i = 0; i < this.innerWallsCount >> 1; i ++) {\n            for (int j = 0; j < 1000; j ++) {\n                int r = random.nextInt(this.rows);\n                int c = random.nextInt(this.cols);\n                if (g[r][c] == 1 || g[this.rows - 1 - r][this.cols - 1 - c] == 1) {\n                    continue;\n                }\n                if (r == this.rows - 2 && c == 1 || r == 1 && c == this.cols - 2) {\n                    continue;\n                }\n                g[r][c] = g[this.rows - 1 - r][this.cols - 1 - c] = 1;\n                break;\n            }\n        }\n        // æ ¡éªŒè¿é€šæ€§\n        return checkConnectivity(this.rows - 2, 1, 1, this.cols - 2);\n    }\n\n    public void createMap() {\n        // å¾ªç¯ 1000 æ¬¡ï¼Œç›´åˆ°æˆåŠŸç”Ÿæˆåˆæ³•åœ°å›¾\n        for (int i = 0; i < 1000; i ++) {\n            if (draw()) {\n                break;\n            }\n        }\n    }\n}\n```\n<a name=\"KNr6s\"></a>\n### 6.2 å‰ç«¯å®ç°åŒ¹é…ç•Œé¢\n\n1. å‰ç«¯å®ç°`pk`ç±»ï¼Œåœ¨å…¶ä¸­ç»´æŠ¤å½“å‰ä¸€æ¬¡çš„`pk`éœ€è¦çš„å˜é‡ï¼Œå…¶ä¸­åˆ©ç”¨`status`å˜é‡åŠ¨æ€åˆ‡æ¢åŒ¹é…å’Œæ¸¸æˆç•Œé¢ï¼ˆ`status: \"matching\", // matching è¡¨ç¤ºåŒ¹é…ç•Œé¢ï¼Œplaying è¡¨ç¤ºå¯¹æˆ˜ç•Œé¢`ï¼‰ã€‚\n```javascript\nexport default {\n    state: {\n        status: \"matching\",  // matching è¡¨ç¤ºåŒ¹é…ç•Œé¢ï¼Œplaying è¡¨ç¤ºå¯¹æˆ˜ç•Œé¢\n        socket: null,\n        opponent_username: \"\",\n        opponent_photo: \"\",\n        gameMap: null,\n    },\n    getters: {\n    },\n    mutations: {\n        updateSocket(state, socket) {\n            state.socket = socket;\n        },\n        updateOpponent(state, opponent) {\n            state.opponent_username = opponent.username;\n            state.opponent_photo = opponent.photo;\n        },\n        updateStatus(state, status) {\n            state.status = status;\n        },\n        updateGameMap(state, gameMap) {\n            state.gameMap = gameMap;\n        }\n    },\n    actions: {\n    },\n    modules: {\n    }\n}\n\n```\n\n2. é™¤äº†ä¹‹å‰å®ç°çš„æ¸¸æˆç•Œé¢ï¼Œè¿˜éœ€è¦å®ç°ä¸€ä¸ªåŒ¹é…ç•Œé¢ã€‚åŒ¹é…ç•Œé¢ç›¸å¯¹ç®€å•ï¼Œå’Œæ¸¸æˆåœ°å›¾ç•Œé¢ç±»ä¼¼ï¼Œä¸¤ä¸ªå¤´åƒï¼Œä¸€ä¸ªæŒ‰é’®ã€‚\n\n> ç©å®¶1ï¼š\n\n![image.png](https://cdn.acwing.com/media/article/image/2024/03/03/126318_528bdb66d9-6.2.2ç©å®¶1.png)\n\n> ç©å®¶2ï¼š\n\n![image.png](https://cdn.acwing.com/media/article/image/2024/03/03/126318_57338a40d9-6.2.2ç©å®¶2.png)\n\n> åŒ¹é…æˆåŠŸï¼š\n\n![image.png](https://cdn.acwing.com/media/article/image/2024/03/03/126318_4dac59a0d9-6.2.2åŒ¹é…æˆåŠŸ.png)\n\n3. å®ç°`PkIndexView`é¡µé¢ã€‚ä¹‹å‰è¯¥é¡µé¢åªæœ‰æ¸¸æˆåœ°å›¾ï¼Œç°åœ¨å¼€å§‹æ—¶éœ€è¦å…ˆåŒ¹é…ï¼ŒåŒ¹é…æˆåŠŸåï¼Œéœ€è¦å°†åŒ¹é…ç•Œé¢å…³æ‰ï¼Œåˆ‡æ¢ä¸ºæ¸¸æˆåœ°å›¾é¡µé¢ã€‚\n```vue\n<template>\n  <PlayGround v-if=\"$store.state.pk.status === 'playing'\" />\n  <MatchGround v-if=\"$store.state.pk.status === 'matching'\" />\n</template>\n\n<script>\nimport PlayGround from '../../components/PlayGround.vue'\nimport MatchGround from '../../components/MatchGround.vue'\nimport { onMounted, onUnmounted } from 'vue'\nimport { useStore } from 'vuex'\n\nexport default {\n  components: {\n    PlayGround,\n    MatchGround,\n  },\n  setup() {\n    const store = useStore();\n    const socketUrl = `ws://127.0.0.1:8090/websocket/${store.state.user.token}/`;\n\n    let socket = null;\n    onMounted(() => {\n      store.commit(\"updateOpponent\", {\n        username: \"æˆ‘çš„å¯¹æ‰‹\",\n        photo: \"https://cdn.acwing.com/media/article/image/2022/08/09/1_1db2488f17-anonymous.png\",\n      })\n      socket = new WebSocket(socketUrl);\n\n      socket.onopen = () => {\n        console.log(\"connected!\");\n        store.commit(\"updateSocket\", socket);\n      }\n\n      socket.onmessage = msg => {\n        const data = JSON.parse(msg.data);\n        if (data.event === \"start-matching\") {  // åŒ¹é…æˆåŠŸ\n          store.commit(\"updateOpponent\", {\n            username: data.opponent_username,\n            photo: data.opponent_photo,\n          });\n          setTimeout(() => {\n            store.commit(\"updateStatus\", \"playing\");\n          }, 2000);\n          store.commit(\"updateGameMap\", data.gameMap);\n        }\n      }\n\n      socket.onclose = () => {\n        console.log(\"disconnected!\");\n      }\n    });\n\n    onUnmounted(() => {\n      socket.close();\n      store.commit(\"updateStatus\", \"matching\");\n    })\n  }\n}\n</script>\n\n<style scoped>\n</style>\n```\n> éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸`http`åè®®ç±»ä¼¼ï¼Œ`socketUrl`çš„å†™æ³•å°†`http`æ¢ä¸º`ws`å³å¯ã€‚\n\nåŒ¹é…æˆåŠŸåï¼ŒåŒæ–¹çš„åœ°å›¾å‡æ˜¯ä»åç«¯è·å–ï¼Œå› æ­¤å®ç°äº†ä¸¤åç©å®¶çš„åœ°å›¾ä¸€è‡´æ€§ã€‚<br />![image.png](https://cdn.acwing.com/media/article/image/2024/03/03/126318_5ad67da0d9-6.2.3åŒ¹é…æˆåŠŸå1.png)![image.png](https://cdn.acwing.com/media/article/image/2024/03/03/126318_5d39caf8d9-6.2.3åŒ¹é…æˆåŠŸå2.png)\n<a name=\"m4d1x\"></a>\n### 6.3 å®ç°åŒ¹é…ç³»ç»Ÿçš„å¾®æœåŠ¡ï¼ˆmatchingsystemï¼‰\næ–°å»ºä¸€ä¸ª`backendCloud` `maven`é¡¹ç›®ï¼Œå¼•å…¥`springcloud`ä¾èµ–ï¼Œåœ¨è¯¥é¡¹ç›®ä¸‹é¢æ–°å¢ä¸¤ä¸ªæ¨¡å—ï¼ˆ`backend, matchingsystem`ï¼‰ï¼Œå°†å…ˆå‰çš„`backend`å¤åˆ¶è¿‡æ¥ï¼Œå¼•å…¥å¹¶é…ç½®`restTemplate`ã€‚<br />**åŒ¹é…ç³»ç»Ÿæ€è·¯ï¼š** æ¯æ¬¡æœ‰åŒ¹é…è¯·æ±‚ï¼Œ`backend`å‘é€æ·»åŠ ç”¨æˆ·è¯·æ±‚åˆ°`matchingsystem`ï¼Œ`matchingsystem`å°†è¯¥ç”¨æˆ·æ·»åŠ åˆ°å¾…åŒ¹é…åˆ—è¡¨ä¸­ã€‚`matchingsystem`ä¼šåœ¨é¡¹ç›®å¯åŠ¨æ—¶å¼€å¯`matchingPool`çº¿ç¨‹ï¼Œå¹¶æ¯ç§’å°è¯•è¿›è¡ŒåŒ¹é…åˆ—è¡¨ä¸­çš„ç©å®¶ï¼ŒåŒæ—¶æ¯ç§’ä¼šå¢åŠ ç©å®¶ç­‰å¾…æ—¶é—´ï¼Œæ—¶é—´è¶Šå¤§ï¼Œé‚£ä¹ˆåŒ¹é…è¯¥ç©å®¶æ—¶ï¼Œå¯æ¥å—çš„å¤©æ¢¯åˆ†å·®ä¹Ÿå°†è¶Šå¤§ã€‚\n\n- åœ¨`webSocketServer`ä¸­å®ç°`startMatching`å‡½æ•°è°ƒç”¨åŒ¹é…ç³»ç»Ÿè¿›è¡ŒåŒ¹é…ï¼š\n```java\nprivate void startMatching() {\n    System.out.println(\"start_matching!\");\n    MultiValueMap<String, String> playerData = new LinkedMultiValueMap<>();\n    playerData.add(\"userId\", this.user.getId().toString());\n    playerData.add(\"rating\", this.user.getRating().toString());\n\n    // ADD_PLAYER_URL = \"http://127.0.0.1:8089/player/add/\"\n    restTemplate.postForObject(ADD_PLAYER_URL, playerData, String.class);\n}\n```\n\n- åŒ¹é…ç³»ç»Ÿ`MatchingPool`ç±»æ ¸å¿ƒä»£ç ï¼š\n```java\n@Override\npublic void run() {\n    while (true) {\n        try {\n            Thread.sleep(1000);\n            lock.lock();\n            try {\n                increaseWaitedTime();\n                matchPlayers();\n            } finally {\n                lock.unlock();\n            }\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n    }\n}\n```\n\n- åœ¨`matchingsystem`é¡¹ç›®å¯åŠ¨æ—¶å¼€å¯`MatchingPool`çº¿ç¨‹ï¼š\n```java\n@SpringBootApplication\npublic class MatchingSystemApplication {\n    public static void main(String[] args) {\n        MatchingServiceImpl.matchingPool.start();\n        SpringApplication.run(MatchingSystemApplication.class, args);\n    }\n}\n```\n\n- ä¸€æ—¦åŒ¹é…æˆåŠŸä¸€å¯¹ç©å®¶ï¼Œå°±ä¼šè°ƒç”¨`MatchingPool`çš„`sendResult`æ–¹æ³•é€šçŸ¥`backend`ä»¥åˆ›å»ºå½“å‰æ¸¸æˆï¼š\n```java\n// è¿”å›åŒ¹é…æˆåŠŸç»“æœ\nprivate void sendResult(Player a, Player b) {\n    System.out.println(\"matched: \" + a + \" \" + b);\n    MultiValueMap<String, String> gameData = new LinkedMultiValueMap<>();\n    gameData.add(\"aId\", a.getUserId().toString());\n    gameData.add(\"bId\", b.getUserId().toString());\n    // START_GAME_URL = \"http://127.0.0.1:8090/pk/startGame/\"\n    restTemplate.postForObject(START_GAME_URL, gameData, String.class);\n}\n```\n> `startGame`å‡½æ•°ä¼šåœ¨ä¸‹ä¸€éƒ¨åˆ†ä»‹ç»ã€‚\n\n<a name=\"L5bbR\"></a>\n### 6.4 å®ç°åç«¯æ¸¸æˆé€»è¾‘\nåœ¨`WebSocketServer`ä¸­è°ƒç”¨å®ç°å‡½æ•°`startGame`ä»¥ä¾¿åŒ¹é…ç³»ç»Ÿå®ŒæˆåŒ¹é…æ—¶è¿›è¡Œè°ƒç”¨ä»¥å¼€å§‹æ¸¸æˆï¼š\n```java\npublic static void startGame(Integer aId, Integer bId) {\n    User a = userMapper.selectById(aId);\n    User b = userMapper.selectById(bId);\n\n    Game game = new Game(13, 14, 20, aId, bId);\n    game.createMap();\n    game.start();\n    if (null != users.get(aId)) {\n        users.get(aId).game = game;\n    }\n    if (null != users.get(bId)) {\n        users.get(bId).game = game;\n    }\n\n    JSONObject respGame = new JSONObject();\n    respGame.put(\"a_id\", game.getPlayerA().getId());\n    respGame.put(\"a_sx\", game.getPlayerA().getSx());\n    respGame.put(\"a_sy\", game.getPlayerA().getSy());\n    respGame.put(\"b_id\", game.getPlayerB().getId());\n    respGame.put(\"b_sx\", game.getPlayerB().getSx());\n    respGame.put(\"b_sy\", game.getPlayerB().getSy());\n    respGame.put(\"map\", game.getG());\n\n    JSONObject respA = new JSONObject();\n    respA.put(\"event\", \"start-matching\");\n    respA.put(\"opponent_username\", b.getUsername());\n    respA.put(\"opponent_photo\", b.getPhoto());\n    respA.put(\"game\", respGame);\n    // ç»™ç©å®¶Aå®¢æˆ·ç«¯è¿”å›ç»“æœ\n    if (null != users.get(aId)) {\n        users.get(aId).sendMessage(respA.toJSONString());\n    }\n\n    JSONObject respB = new JSONObject();\n    respB.put(\"event\", \"start-matching\");\n    respB.put(\"opponent_username\", a.getUsername());\n    respB.put(\"opponent_photo\", a.getPhoto());\n    respB.put(\"game\", respGame);\n    // ç»™ç©å®¶Bå®¢æˆ·ç«¯è¿”å›ç»“æœ\n    if (null != users.get(bId)) {\n        users.get(bId).sendMessage(respB.toJSONString());\n    }\n}\n```\nä¸»è¦çš„æ¸¸æˆé€»è¾‘åœ¨`Game`ç±»ä¸­ï¼Œæ¯æ¬¡ç­‰å¾…ç”¨æˆ·è¾“å…¥ï¼Œç„¶åæ ¡éªŒæ“ä½œæ—¶å€™åˆæ³•ï¼Œå¦‚æœåˆæ³•ï¼Œåˆ™å°†ä¸¤åç©å®¶çš„æ“ä½œå¹¿æ’­ç»™åŒæ–¹çš„å®¢æˆ·ç«¯ã€‚å¦‚æœæœ‰ç©å®¶æ“ä½œä¸åˆæ³•æˆ–è€…æœ‰ç©å®¶äº”ç§’å†…æœªè¿›è¡Œè¾“å…¥ï¼Œåˆ™æ¸¸æˆç»“æŸï¼Œå‘ä¸¤åç©å®¶å¹¿æ’­æ¸¸æˆç»“æœã€‚<br />`Game`ä¸­çš„æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š\n```java\n@Override\npublic void run() {\n    for (int i = 0; i < 1000; i ++) {\n        if (nextStep()) {\n            judge();\n            if (\"playing\".equals(status)) {\n                sendMove();\n            } else {\n                sendResult();\n                break;\n            }\n        } else {\n            status = \"finished\";\n            lock.lock();\n            try {\n                if (null == nextStepA && null == nextStepB) {\n                    winner = \"all\";\n                } else if (null == nextStepB) {\n                    winner = \"A\";\n                } else {\n                    winner = \"B\";\n                }\n            } finally {\n                lock.unlock();\n            }\n            sendResult();\n            break;\n        }\n    }\n}\n```\n<a name=\"QHwmW\"></a>\n## 7. å¾®æœåŠ¡ï¼šBotä»£ç çš„æ‰§è¡Œï¼ˆbotrunningsystemï¼‰\n\n- æ·»åŠ ä¾èµ–ï¼š\n```xml\n<dependency>\n    <groupId>org.jooq</groupId>\n    <artifactId>joor-java-8</artifactId>\n    <version>0.9.14</version>\n</dependency>\n```\n\n- é…ç½®`restTemplate`ä¸`security`ï¼š\n```java\n@Configuration\npublic class RestTemplateConfig {\n    @Bean\n    public RestTemplate getRestTemplate() {\n        return new RestTemplate();\n    }\n}\n```\n```java\n@Configuration\n@EnableWebSecurity\npublic class SecurityConfig extends WebSecurityConfigurerAdapter {\n    @Override\n    protected void configure(HttpSecurity http) throws Exception {\n        http.csrf().disable()\n                .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)\n                .and()\n                .authorizeRequests()\n                .antMatchers(\"/bot/add/\").hasIpAddress(\"127.0.0.1\")\n                .antMatchers(HttpMethod.OPTIONS).permitAll()\n                .anyRequest().authenticated();\n    }\n}\n```\næ¯æ¬¡åç«¯ï¼ˆ`backend`ï¼‰ä¼šè°ƒç”¨`bot/add/`æ¥å£å¾€`bots`é˜Ÿåˆ—ä¸­æ·»åŠ `Bot`ï¼š\n```java\npublic void addBot(Integer userId, String botCode, String input) {\n    lock.lock();\n    try {\n        bots.add(new Bot(userId, botCode, input));\n        // å½“ bot æ·»åŠ ç»“æŸï¼Œéœ€è¦å”¤èµ·å…¶ä»–çº¿ç¨‹è¿›è¡Œæ¶ˆè´¹\n        condition.signalAll();\n    } finally {\n        lock.unlock();\n    }\n}\n```\n`botPool`çš„æ ¸å¿ƒä»£ç ï¼ˆè¿™é‡Œç›¸å½“äºæ‰‹åŠ¨å®ç°äº†ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼‰ï¼š\n```java\nprivate void consume(Bot bot) {\n    Consumer consumer = new Consumer();\n    consumer.startTimeout(2000, bot);\n}\n\n@Override\npublic void run() {\n    while (true) {\n        lock.lock();\n        if (bots.isEmpty()) {\n            try {\n                // å½“é˜Ÿåˆ—ä¸­æ²¡æœ‰ç­‰å¾…æ¶ˆè´¹çš„Botæ—¶ï¼Œè®©çº¿ç¨‹ç­‰å¾…ï¼Œå½“æœ‰æ–°æ·»åŠ çš„Botæ—¶ï¼Œä¼šè¢«condition.signalAll();å”¤é†’\n                condition.await();\n            } catch (InterruptedException e) {\n                e.printStackTrace();\n                break;\n            } finally {\n                lock.unlock();\n            }\n        } else {\n            Bot bot = bots.poll();\n            lock.unlock();\n            // consume å¯èƒ½ä¼šæ‰§è¡Œå‡ ç§’é’Ÿï¼Œéœ€è¦å…ˆè§£é”\n            consume(bot);\n        }\n    }\n}\n```\nè€Œåœ¨`Consumer`ä¸­ï¼Œéœ€è¦æ§åˆ¶æ¯ä¸ª`Bot`çš„æ‰§è¡Œæ—¶é—´ï¼š\n```java\npublic void startTimeout(long timeout, Bot bot) {\n    this.bot = bot;\n    this.start();\n    try {\n        this.join(timeout);\n    } catch (InterruptedException e) {\n        e.printStackTrace();\n    } finally {\n        // æœ€å¤šç­‰å¾… timeout ç§’ï¼Œç„¶åä¸­æ–­\n        this.interrupt();\n    }\n}\n```\n`Consumer`ä¸­çš„æ ¸å¿ƒä»£ç ï¼š\n```java\n@Override\npublic void run() {\n    UUID uuid = UUID.randomUUID();\n    String uid = uuid.toString().substring(0, 8);\n    // éœ€è¦ä¿éšœæ¯æ¬¡çš„ç±»åä¸ä¸€æ ·ï¼Œå¦åˆ™åªç¼–è¯‘ä¸€æ¬¡\n    Supplier<Integer> botInterface = Reflect.compile(\n            \"com.kob.botrunningsystem.utils.Bot\" + uid,\n            addUid(bot.getBotCode(), uid)\n    ).create().get();\n    // å°†è¾“å…¥å†™å…¥æ–‡ä»¶ä»¥ä¾¿åç»­æ‰©å±•ï¼ˆåæœŸå¯ä»¥åœ¨dockerä¸­è¿è¡Œï¼Œå°±éœ€è¦ä»æ–‡ä»¶ä¸­è¯»å–è¾“å…¥ï¼‰\n    File file = new File(\"input.txt\");\n    try (PrintWriter fout = new PrintWriter(file)) {\n        fout.println(bot.getInput());\n        fout.flush();\n    } catch (FileNotFoundException e) {\n        throw new RuntimeException(e);\n    }\n    // æ‰§è¡ŒBotä»£ç ï¼Œè·å–ç»“æœ\n    Integer direction = botInterface.get();\n    // å°†Botæ‰§è¡Œç»“æœè¿”å›\n    MultiValueMap<String, String> data = new LinkedMultiValueMap<>();\n    data.add(\"userId\", bot.getUserId().toString());\n    data.add(\"direction\", direction.toString());\n\n    restTemplate.postForObject(RECEIVE_BOT_MOVE_URL, data, String.class);\n}\n```\n<a name=\"CKczF\"></a>\n## 8. åˆ›å»ºå¯¹æˆ˜åˆ—è¡¨ä¸æ’è¡Œæ¦œé¡µé¢\nè¿™ä¸¤éƒ¨åˆ†ä¸»è¦çš„ä»»åŠ¡å°±æ˜¯å†™å¥½åˆ†é¡µæŸ¥è¯¢å’Œåˆ†é¡µå±•ç¤ºã€‚<br />åˆ†é¡µæŸ¥è¯¢ç›´æ¥åˆ©ç”¨`MybatisPlus`è‡ªå¸¦çš„åˆ†é¡µå·¥å…·å³å¯ã€‚<br />åˆ†é¡µé…ç½®ï¼š\n```java\n@Configuration\npublic class MybatisConfig {\n    @Bean\n    public MybatisPlusInterceptor mybatisPlusInterceptor() {\n        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();\n        interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));\n        return interceptor;\n    }\n}\n```\nå…¶ä¸­ï¼Œåœ¨å¯¹æˆ˜åˆ—è¡¨ä¸­çš„`æŸ¥çœ‹å½•åƒ`åŠŸèƒ½ï¼Œå®ç°åŸç†ä¸ºï¼šå°†æ•°æ®åº“ä¸­è®°å½•çš„åœ°å›¾ä¿¡æ¯ã€ç”¨æˆ·åŒæ–¹çš„æ“ä½œä¿¡æ¯å–å‡ºï¼Œåœ¨æ¸¸æˆåœ°å›¾ä¸­é‡æ–°æ¨¡æ‹Ÿä¸€éå³å¯ã€‚<br />**å¯¹å±€åˆ—è¡¨ï¼š**<br />![image.png](https://cdn.acwing.com/media/article/image/2024/03/03/126318_5ef9b2e6d9-8.å¯¹å±€åˆ—è¡¨.png)<br />**æ’è¡Œæ¦œï¼š**<br />![image.png](https://cdn.acwing.com/media/article/image/2024/03/03/126318_61f70baed9-8.æ’è¡Œæ¦œ.png)\n<a name=\"Wj4NC\"></a>\n## 9. å®ç°QQä¸‰æ–¹ç™»å½•\n> **åŸºæœ¬æ€è·¯ï¼š** é€šè¿‡è®¿é—®åç«¯çš„`@GetMapping(\"/applyCode/\")`æ¥å£è·å–`apply_code`ï¼ŒåŒæ—¶åç«¯ç”Ÿæˆäº†`state`å­˜å…¥`redis`ä¸­ã€‚ç„¶åå‰ç«¯å†è°ƒç”¨åç«¯çš„`@GetMapping(\"/receiveCode/\")`æ¥å£ã€‚åœ¨è¯¥æ¥å£ä¸­ï¼Œä¼šæ‹¿ç€`state`ä¸`redis`ä¸­çš„è¿›è¡Œæ ¡éªŒï¼Œç„¶åè·å–`access_token`ï¼Œæ‹¿åˆ°`access_token`ä¹‹åè·å–ç”¨æˆ·çš„`openid`ï¼Œç„¶ååˆ¤æ–­è¯¥`openid`æ˜¯å¦å·²ç»å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ç›´æ¥ç”Ÿæˆ`jwt`å¹¶è¿”å›å‰ç«¯ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡ç”³è¯·`QQ`ç™»å½•ï¼Œéœ€è¦è·å–`user_info`ï¼Œå†å­˜å…¥æ•°æ®åº“å¹¶ç”Ÿæˆ`jwt`è¿”å›ã€‚\n\n**å®˜æ–¹æˆæƒæµç¨‹å›¾ï¼ˆ**[**å®˜æ–¹æ•™ç¨‹**](https://wiki.connect.qq.com/%e4%bd%bf%e7%94%a8authorization_code%e8%8e%b7%e5%8f%96access_token)**ï¼‰ï¼š**<br />![](https://cdn.acwing.com/media/article/image/2024/03/03/126318_6f230017d9-9.å®˜æ–¹æˆæƒæµç¨‹å›¾.png)\n<a name=\"lBIVC\"></a>\n### 9.1 å‰å¾€è…¾è®¯å¼€æ”¾å¹³å°å®Œæˆèµ„æ–™å®¡æ ¸\n\n- å…ˆå‰å¾€è…¾è®¯å¼€æ”¾å¹³å°è¿›è¡Œå¼€å‘è€…äººè„¸è¯†åˆ«æ ¡éªŒï¼ˆ[è…¾è®¯å¼€æ”¾å¹³å°](https://app.open.qq.com/p/developer/team_manage/info)ï¼‰\n> éœ€è¦å…ˆQQç™»å½•ï¼Œç„¶åç‚¹å‡»å³ä¸Šè§’çš„è´¦æˆ·ç®¡ç†ï¼Œæ ¹æ®æç¤ºå¾®ä¿¡æ‰«ç å®Œæˆäººè„¸è¯†åˆ«æ ¡éªŒã€‚\n\n- QQäº’è”è¿›è¡Œå¼€å‘è€…èµ„æ–™å®¡æ ¸ï¼ˆ[å¼€å‘è€…èµ„æ–™å®¡æ ¸](https://connect.qq.com/devuser.html#/create/1/)ï¼‰\n> æ³¨ï¼šæ‰‹æŒç…§ç‰‡å¾—ç”¨åç½®æ‘„åƒå¤´æ‹æ‘„ï¼Œå‰ç½®æ‘„åƒå¤´æœ‰é•œåƒåŠŸèƒ½ï¼Œæ‰‹æŒ‡ä¸èƒ½é®æŒ¡è¯ä»¶ä¿¡æ¯ï¼Œä¸€å®šè¦æ‹æ¸…æ¥šï¼Œå¦åˆ™ ä¼šè¢«é©³å›ï¼\n\n<a name=\"dgV8H\"></a>\n### 9.2 åœ¨è…¾è®¯å¼€æ”¾å¹³å°åˆ›å»ºåº”ç”¨\n\n- åˆ›å»ºåº”ç”¨\n\n![image.png](https://cdn.acwing.com/media/article/image/2024/03/03/126318_65986370d9-9.2åˆ›å»ºåº”ç”¨.png)\n\n- å¡«å†™åº”ç”¨èµ„æ–™\n> ç½‘ç«™å›è°ƒåœ°å€å¡«å†™å‰ç«¯é¡µé¢åœ°å€ï¼Œå†ç”±å‰ç«¯é¡µé¢è¯·æ±‚åç«¯è¿›è¡Œè´¦æˆ·æ³¨å†Œæˆ–`jwt`ç”Ÿæˆã€‚åœ¨è¿™é‡Œéœ€è¦å¤„ç†ä¸€ä¸‹å‰ç«¯é¡µé¢çš„åœ°å€ï¼Œå› ä¸ºè¿™ä¸€æ è…¾è®¯è¦æ±‚ä¸èƒ½ä»¥`'/'`ç»“å°¾ã€‚æ‰€ä»¥å‰ç«¯é¡µé¢ä¹Ÿä¸èƒ½ä»¥`'/'`ç»“å°¾ã€‚\n\n```javascript\n{\n  path: \"/user/account/qq/web/receiveCode\",\n  name: \"user_account_qq_receive_code\",\n  component: ()=>import('@/views/user/account/UserAccountQQReceiveCodeView'),\n  meta:{\n    requestAuth : false\n  }\n},\n```\næ‰€ä»¥æˆ‘çš„åœ°å€ï¼ˆåç«¯çš„`redirect_uri`ä¸æ­¤ä¿æŒä¸€è‡´ï¼‰ï¼š\n```xml\nhttps://smallboat.games/user/account/qq/web/receiveCode\n```\n![image.png](https://cdn.acwing.com/media/article/image/2024/03/03/126318_6a4f7e5bd9-9.2å¡«å†™åº”ç”¨èµ„æ–™.png)\n> - æä¾›æ–¹å’Œç½‘ç«™åœ°å€å¤‡æ¡ˆå·å¯åœ¨ï¼š`[https://icp.chinaz.com/](https://icp.chinaz.com/)`æŸ¥è¯¢ã€‚\n> - æäº¤å®¡æ ¸åä¸€å®šè¦å…ˆå°†`QQ`ç™»å½•æŒ‰é’®éƒ¨ç½²åˆ°æ­£å¼ç¯å¢ƒï¼Œå¦åˆ™ä¼šä»¥`æœªæ‘†æ”¾QQç™»å½•æŒ‰é’®`å®¡æ‰¹ä¸é€šè¿‡ã€‚\n\n- å®¡æ ¸é€šè¿‡\n\n![image.png](https://cdn.acwing.com/media/article/image/2024/03/03/126318_67678959d9-9.2å®¡æ ¸é€šè¿‡.png)\n<a name=\"KFUq7\"></a>\n### 9.3 ä»£ç å®ç°\n<a name=\"FXRnt\"></a>\n#### 9.3.1 å‰ç«¯\n\n- åœ¨ç™»å½•é¡µåˆé€‚ä½ç½®æ·»åŠ `QQ`ç™»å½•æŒ‰é’®ï¼š\n```html\n<div @click=\"qq_login\" style=\"cursor: pointer; text-align: center; margin-top: 10px;\">\n  <img height=\"30\" \n    src=\"https://wiki.connect.qq.com/wp-content/uploads/2013/10/03_qq_symbol-1-250x300.png\"\n    alt=\"QQå®˜æ–¹å›¾æ ‡\"/>\n  <br>\n  <div style=\"color: #09e309\">\n    QQä¸€é”®ç™»å½•\n  </div>\n</div>\n```\n```javascript\nconst qq_login = () => {\n  $.ajax({\n    url: \"https://smallboat.games/api/user/account/qq/web/applyCode/\",\n    type: \"GET\",\n    success: resp => {\n      if (resp.result === \"success\") {\n        window.location.replace(resp.apply_code_url);\n      }\n    }\n  })\n}\n```\n\n- æ·»åŠ è·¯ç”±ï¼ˆ~~å…¶å®ä¸Šé¢å·²ç»å†™è¿‡~~ï¼‰\n```javascript\n{\n  path: \"/user/account/qq/web/receiveCode\",\n  name: \"user_account_qq_receive_code\",\n  component: ()=>import('@/views/user/account/UserAccountQQReceiveCodeView'),\n  meta:{\n    requestAuth : false\n  }\n},\n```\n\n- å¤„ç†`QQ`ç™»å½•çš„é¡µé¢\n```vue\n<template>\n  <div></div>\n</template>\n\n<script>\nimport router from \"@/router/index\";\nimport {useStore} from \"vuex\";\nimport {useRoute} from \"vue-router\";\nimport $ from 'jquery'\nexport default {\n  name: \"UserAccountQQReceiveCodeView\",\n  setup() {\n    const myRoute = useRoute();\n    const store = useStore();\n    $.ajax({\n      url: \"https://smallboat.games/api/user/account/qq/web/receiveCode/\",\n      type: \"GET\",\n      data: {\n        code: myRoute.query.code,\n        state: myRoute.query.state,\n      },\n      success: resp => {\n        if (resp.result === \"success\") {\n          localStorage.setItem(\"jwt\", resp.jwt);\n          store.commit(\"updateToken\", resp.jwt);\n          router.push({name: \"home\"});\n          store.commit(\"updatePullingInfo\", false);\n        } else {\n          router.push({name: \"user_account_login\"});\n        }\n      }\n    })\n  }\n}\n</script>\n\n<style scoped>\n\n</style>\n```\n<a name=\"OxeZj\"></a>\n#### 9.3.2 åç«¯\n**åç«¯ä¸»è¦éœ€è¦å®ç°ä¸¤ä¸ªæ¥å£ï¼š**\n> è®°å¾—åœ¨`SecurityConfig`ä¸­æ”¾è¡Œè¿™ä¸¤ä¸ªæ¥å£ï¼Œå› ä¸ºæ˜¯åœ¨ç”¨æˆ·æœªè·å–`jwt`æ—¶è¿›è¡Œè®¿é—®ã€‚\n\n- `@GetMapping(\"/applyCode/\")`\n```java\n@Override\npublic JSONObject applyCode() {\n    JSONObject resp = new JSONObject();\n    String encodeUrl = \"\";\n    try {\n        encodeUrl = URLEncoder.encode(REDIRECT_URI, \"UTF-8\");\n    } catch (UnsupportedEncodingException e) {\n        e.printStackTrace();\n        resp.put(\"result\", \"failed\");\n        return resp;\n    }\n\n    // éšæœºå­—ç¬¦ä¸²ï¼Œé˜²æ­¢ csrf æ”»å‡»\n    StringBuilder state = new StringBuilder();\n    for (int i = 0; i < 10; i ++) {\n        state.append((char)(random.nextInt(10) + '0'));\n    }\n    // å­˜åˆ°redisé‡Œï¼Œæœ‰æ•ˆæœŸè®¾ç½®ä¸º10åˆ†é’Ÿ\n    resp.put(\"result\", \"success\");\n    redisTemplate.opsForValue().set(state.toString(), \"true\");\n    redisTemplate.expire(state.toString(), Duration.ofMinutes(10));\n\n    String applyCodeUrl = \"https://graph.qq.com/oauth2.0/authorize\"\n            + \"?response_type=\"+\"code\"\n            + \"&client_id=\" + APP_ID\n            + \"&redirect_uri=\" + encodeUrl\n            + \"&state=\" + state;\n    resp.put(\"apply_code_url\", applyCodeUrl);\n\n    return resp;\n}\n```\n\n- `@GetMapping(\"/receiveCode/\")`\n```java\n@Override\npublic JSONObject receiveCode(String code, String state) {\n    JSONObject resp = new JSONObject();\n    resp.put(\"result\", \"failed\");\n    if (null == code || null == state) return resp;\n    if (Boolean.FALSE.equals(redisTemplate.hasKey(state))) return resp;\n    redisTemplate.delete(state);\n    // è·å–access_token\n    List<NameValuePair> nameValuePairs = new LinkedList<>();\n    nameValuePairs.add(new BasicNameValuePair(\"grant_type\", \"authorization_code\"));\n    nameValuePairs.add(new BasicNameValuePair(\"client_id\", APP_ID));\n    nameValuePairs.add(new BasicNameValuePair(\"client_secret\", APP_SECRET));\n    nameValuePairs.add(new BasicNameValuePair(\"code\", code));\n    nameValuePairs.add(new BasicNameValuePair(\"redirect_uri\", REDIRECT_URI));\n    nameValuePairs.add(new BasicNameValuePair(\"fmt\", \"json\"));\n\n    String getString = HttpClientUtil.get(APPLY_ACCESS_TOKEN_URL, nameValuePairs);\n    if (null == getString) return resp;\n    JSONObject getResp = JSONObject.parseObject(getString);\n    String accessToken = getResp.getString(\"access_token\");\n\n    // è·å–openid\n    nameValuePairs = new LinkedList<>();\n    nameValuePairs.add(new BasicNameValuePair(\"access_token\", accessToken));\n    nameValuePairs.add(new BasicNameValuePair(\"fmt\", \"json\"));\n\n    getString = HttpClientUtil.get(APPLY_USER_OPENID_URL, nameValuePairs);\n    if(null == getString) return resp;\n    getResp = JSONObject.parseObject(getString);\n    String openid = getResp.getString(\"openid\");\n\n    if (accessToken == null || openid == null) return resp;\n\n    QueryWrapper<User> queryWrapper = new QueryWrapper<>();\n    queryWrapper.eq(\"openid_qq\", openid);\n    List<User> users = userMapper.selectList(queryWrapper);\n\n    // ç”¨æˆ·å·²ç»æˆæƒï¼Œè‡ªåŠ¨ç™»å½•\n    if (null != users && !users.isEmpty()) {\n        User user = users.get(0);\n        // ç”Ÿæˆjwt\n        String jwt = JwtUtil.createJWT(user.getId().toString());\n\n        resp.put(\"result\", \"success\");\n        resp.put(\"jwt\", jwt);\n        return resp;\n    }\n\n    // æ–°ç”¨æˆ·æˆæƒï¼Œè·å–ç”¨æˆ·ä¿¡æ¯ï¼Œå¹¶åˆ›å»ºæ–°ç”¨æˆ·\n    nameValuePairs = new LinkedList<>();\n    nameValuePairs.add(new BasicNameValuePair(\"access_token\", accessToken));\n    nameValuePairs.add(new BasicNameValuePair(\"openid\", openid));\n    nameValuePairs.add(new BasicNameValuePair(\"oauth_consumer_key\", APP_ID));\n    getString = HttpClientUtil.get(APPLY_USER_INFO_URL, nameValuePairs);\n    if (null == getString) return resp;\n\n    getResp = JSONObject.parseObject(getString);\n    String username = getResp.getString(\"nickname\");\n    // 50*50çš„å¤´åƒ\n    String photo = getResp.getString(\"figureurl_1\");\n\n    if (null == username || null == photo) return resp;\n\n    // æ¯æ¬¡å¾ªç¯ï¼Œç”¨æˆ·åé‡å¤çš„æ¦‚ç‡ä¸ºä¸Šä¸€æ¬¡çš„1/10\n    for (int i = 0; i < 100; i ++) {\n        QueryWrapper<User> usernameQueryWrapper = new QueryWrapper<>();\n        usernameQueryWrapper.eq(\"username\", username);\n        if (userMapper.selectCount(usernameQueryWrapper) == 0) break;\n        username += (char)(random.nextInt(10) + '0');\n        if (i == 99) return resp;\n    }\n    User user = new User(null, username, null, photo, 1500, null, openid, null);\n    userMapper.insert(user);\n    // ç”Ÿæˆ jwt\n    String jwt = JwtUtil.createJWT(user.getId().toString());\n    resp.put(\"result\", \"success\");\n    resp.put(\"jwt\", jwt);\n    return resp;\n}\n```\n<a name=\"jQ4rd\"></a>\n\n## 10. é¡¹ç›®ä¸Šçº¿\nä¸Šçº¿æµç¨‹å‚è€ƒï¼š<br />[é¡¹ç›®ä¸Šçº¿åŸºæœ¬æµç¨‹-CSDNåšå®¢](http://smallboatc.github.io/2024/02/01/%E9%A1%B9%E7%9B%AE%E4%B8%8A%E7%BA%BF%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B/)<br />ä¸Šçº¿æˆæœï¼š<br />[King of Bots](https://smallboat.games/)<br />é¡¹ç›®`github`åœ°å€ï¼š<br />[https://github.com/smallboatc/kob/](https://github.com/smallboatc/kob/)\n","categories":["SpringBoot"]},{"title":"é¡¹ç›®ä¸Šçº¿åŸºæœ¬æµç¨‹","url":"/2024/02/01/é¡¹ç›®ä¸Šçº¿åŸºæœ¬æµç¨‹/","content":"\n<a name=\"Q907D\"></a>\n## 1. ç§ŸECSäº‘æœåŠ¡å™¨\næœåŠ¡å™¨æ¨èé¡ºåºï¼š\n\n- é˜¿é‡Œäº‘\n- è…¾è®¯äº‘\n- åä¸ºäº‘\n\nä¸€èˆ¬é€‰æ‹©`1æ ¸2G`å³å¯ï¼Œé€‰æ‹©æŒ‰ä½¿ç”¨é‡è®¡è´¹ã€‚<br />é€šè¿‡å‘½ä»¤`ssh root@xx.xxx.xxx.xxx #ï¼ˆå…¬ç½‘ipï¼‰`ï¼Œç„¶åè¾“å…¥è´­ä¹°æœåŠ¡å™¨æ—¶è®¾ç½®çš„å¯†ç å³å¯è¿æ¥åˆ°æœåŠ¡å™¨ã€‚ä¹‹å‰å¦‚æœæ²¡ç”Ÿæˆè¿‡å…¬é’¥çš„ï¼Œéœ€è¦å…ˆåœ¨æœ¬åœ°ä½¿ç”¨å‘½ä»¤`ssh-keygen`ä¸€è·¯å›è½¦ç”Ÿæˆå…¬é’¥å†ç™»å½•ã€‚<br />å¦‚æœæ˜¯é‡ç½®è¿‡æœåŠ¡å™¨ï¼Œé‚£ä¹ˆä¹‹å‰å°±ä¼šæœ‰è®°å½•ï¼Œé‡æ–°ç™»å½•æ—¶ä¼šæŠ¥é”™ï¼Œæ­¤æ—¶éœ€è¦åœ¨æ–‡ä»¶ä¸­å°†è¯¥æœåŠ¡å™¨çš„é…ç½®åˆ æ‰å†ç™»å½•ã€‚\n```shell\nvim .ssh/known_hosts # è¿›å…¥ååˆ é™¤è¯¥æœåŠ¡å™¨çš„é…ç½®\n```\n<a name=\"pUBb0\"></a>\n## 2. é…ç½®æœåŠ¡å™¨\n`CentOs`åˆ›å»ºç”¨æˆ·ï¼ˆé»˜è®¤çš„`root`æƒé™è¿‡é«˜ï¼Œéœ€è¦ä½¿ç”¨æ‹¥æœ‰`sudo`æƒé™çš„ç”¨æˆ·è¿›è¡Œæ“ä½œï¼‰\n```shell\nuseradd acs # acs ä¸ºè‡ªå·±æƒ³å–çš„ç”¨æˆ·å\npasswd acs\n# è®¾ç½®å¯†ç \nchmod -v u+w /etc/sudoers # ç»™ sudoers æ–‡ä»¶å¯å†™æƒé™\nvim /etc/sudoers # ä¿®æ”¹è¯¥æ–‡ä»¶ï¼Œç»™ç”¨æˆ· acs æ·»åŠ æƒé™\n# è¿›å…¥åå…ˆè¾“å…¥ /Allow root æ‰¾åˆ° root    ALL=(ALL)    ALL æ‰€åœ¨ä½ç½®\n# i è¿›å…¥ç¼–è¾‘æ¨¡å¼ï¼Œåœ¨ root    ALL=(ALL)    ALL ä¸‹ä¸€è¡Œå†™å…¥ acs    ALL=(ALL)    ALL\n# æŒ‰ESC ç„¶åè¾“å…¥ :wq ä¿å­˜å¹¶é€€å‡º \nchmod -v u-w /etc/sudoers # æ”¶å› sudoers æ–‡ä»¶å¯å†™æƒé™\nsu acs # ä½¿ç”¨æ–°è´¦æˆ·ç™»å½•ç³»ç»Ÿ\n```\n![image.png](https://cdn.acwing.com/media/article/image/2024/03/02/126318_aaaccb4ad8-2.é…ç½®æœåŠ¡å™¨.png)<br />ç„¶å`exit`é€€å‡ºï¼Œåœ¨æœ¬åœ°é…ç½®å…å¯†ç™»å½•ï¼š\n```shell\nvim .ssh/config # æ²¡æœ‰è¯¥æ–‡ä»¶ä¼šè‡ªåŠ¨åˆ›å»º\n```\nåœ¨æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹è¯­å¥\n```shell\nHost springboot_server # åé¢è¿™ä¸ªæ˜¯ç»™æœåŠ¡å™¨å–çš„åå­—\n  \tHostName xx.xxx.xxx.xxx # åé¢è¿™ä¸ªæ˜¯å…¬ç½‘ip\n    User acs # åé¢è¿™ä¸ªæ˜¯åˆšåˆšæ·»åŠ çš„ç”¨æˆ·å\n```\nä¿å­˜å¹¶é€€å‡º<br />åœ¨ç»ˆç«¯ä¸­è¾“å…¥`ssh-copy-id springboot_server`ç„¶åè¾“å…¥å¯†ç å®Œæˆå…å¯†ç™»å½•é…ç½®ï¼Œä¹‹åå°±å¯ä»¥ä½¿ç”¨ä½¿ç”¨`ssh springboot_server`ç›´æ¥ç™»å½•ï¼Œè€Œä¸éœ€è¦è¾“å…¥å¯†ç ã€‚<br />ç„¶åæˆ‘ä»¬å…ˆä¸ç™»å½•ï¼Œå…ˆå°†ä¸€äº›ç¥–ä¼ é…ç½®æ–‡ä»¶ä¼ è¿‡å»ã€‚<br />ä½¿ç”¨`scp xxx springboot_server:`å°†éœ€è¦çš„æ–‡ä»¶ä¼ åˆ°æœåŠ¡å™¨ï¼ˆæ²¡æœ‰å°±ä¸ä¼ ï¼‰ï¼Œæ³¨æ„ä¸€å®šè¦æœ‰å†’å·`:`\n```shell\nscp .bashrc .vimrc .tmux.conf server_name:  # server_nameéœ€è¦æ¢æˆè‡ªå·±é…ç½®çš„åˆ«å\n```\nç„¶åç™»å½•æœåŠ¡å™¨<br />å…ˆè£…ä¸€ä¸ª`tmux`ï¼ˆæ‰€æœ‰å·¥ä½œå°½é‡åœ¨`tmux`ä¸­å®Œæˆï¼Œé¿å…å‘ç”Ÿæ„å¤–ä¸¢å¤±å·¥ä½œè¿›åº¦ï¼‰\n```shell\nsudo yum update # å…ˆæ›´æ–°æ•°æ®æºï¼Œç½‘ç»œä¸å¥½å¯èƒ½ä¼šæŠ¥é”™ï¼Œå°½é‡åœ¨ç½‘ç»œç¯å¢ƒè‰¯å¥½æ—¶æ“ä½œ\nsudo yum install tmux\n```\n<a name=\"jzQu6\"></a>\n## 3. å®‰è£…docker\nç„¶ååœ¨`tmux`ä¸­å®‰è£…`docker`ï¼ˆ[dockerå®‰è£…æ­¥éª¤ï¼ˆå®˜ç½‘ï¼‰](https://docs.docker.com/engine/install/centos/)ï¼‰<br />å®‰è£…å®Œæˆåè¾“å…¥`docker`ä¼šæœ‰ä¸€äº›æç¤ºï¼Œè¯´æ˜å®‰è£…æˆåŠŸï¼<br />ç„¶åå¯åŠ¨`docker`ï¼š`sudo systemctl start docker`<br />å®‰è£…æˆåŠŸä¹‹åï¼Œå°†ç”¨æˆ·åœ¨`docker`ä¸­èµ‹äºˆ`sudo`æƒé™ï¼š`sudo usermod -aG docker $USER`ï¼Œä»¥ä¾¿è¯¥ç”¨æˆ·å¯ä»¥ä½¿ç”¨ `docker` è€Œæ— éœ€ä½¿ç”¨ `sudo`ã€‚ä¹‹åéœ€è¦é€€å‡ºé‡æ–°ç™»å½•æ‰ä¼šç”Ÿæ•ˆï¼Œå¦åˆ™æ‰§è¡Œ`docker`ç›¸å…³å‘½ä»¤ä¼šæç¤ºæ²¡æœ‰æƒé™ã€‚\n\nä¹‹åå°±å¯ä»¥ä½¿ç”¨`scp`å‘½ä»¤æŠŠè‡ªå·±çš„é•œåƒä¼ åˆ°æœåŠ¡å™¨äº†\n\nç„¶åä½¿ç”¨å‘½ä»¤`docker load -i django_lesson_1_0.tar`å°†é•œåƒæ–‡ä»¶è§£å‹åˆ°`docker`ä¸­ã€‚<br />è¿è¡Œé•œåƒï¼š\n```shell\n# ä¸­é—´æ˜¯éœ€è¦ä½¿ç”¨çš„ç«¯å£å·æ˜ å°„é…ç½®ï¼Œä¾‹å¦‚ -p 20000:22 ä¼šå°†åœ¨å¤–ç•Œè®¿é—®æœåŠ¡å™¨20000ç«¯å£æ—¶è‡ªåŠ¨æ˜ å°„åˆ°å®¹å™¨çš„22ç«¯å£\ndocker run -p 20000:22 -p 443:443 -p 80:80 -p 3000:3000 -p 3001:3001 -p 3002:3002 -itd --name kob_server django_lesson:1.0\n```\nç„¶åå°±å¯ä»¥è¿›åˆ°`docker`ä¸­äº†ï¼š`docker attach kob_server`ï¼ˆé•œåƒæ˜¯`ubuntu`ï¼‰\n\nä¹‹åç»™åˆ›å»ºç”¨æˆ·å¹¶èµ‹äºˆ`sudo`æƒé™ï¼Œå†æŒ‰`ctrl + p, strl + q`æŒ‚è½½å®¹å™¨ï¼ˆé€€å‡ºä½†ä¸é”€æ¯ï¼‰ã€‚\n\nä¹‹ååŒæ ·çš„æ“ä½œå°†ç¥–ä¼ çš„é…ç½®æ–‡ä»¶ä¼ åˆ°å®¹å™¨ä¸­\n<a name=\"tAnh0\"></a>\n## 4. å®¹å™¨ä¸­å®‰è£…å„ç§æœåŠ¡\nç„¶ååœ¨å®¹å™¨ä¸­å®‰è£…`mysql`\n```shell\nsudo apt-get install mysql-server\nsudo apt-get update\nsudo apt-get install mysql-server\t\n```\n\nç„¶åå¯åŠ¨`mysql`:`sudo service mysql start`<br />ç„¶åè¿›å…¥`mysql mysql -uroot -pxxxxx`\n\nåœ¨`mysql`ä¸­æ‰§è¡Œ`sql`è¯­å¥ï¼š`ALTER USER 'root'@'localhost' IDENTIFIED WITH caching_sha2_password BY 'yourpasswd';`ä»¥ä¿®æ”¹å¯†ç ã€‚\n\nåˆ›å»ºæ•°æ®åº“å¹¶åˆ›å»ºè¡¨ï¼š\n```sql\ncreate database kob;\nuse kob;\nsource /home/acs/create_table.sql; # æå‰å‡†å¤‡å¥½çš„åˆ›å»ºæ•°æ®åº“è¡¨çš„sqlæ–‡ä»¶\nexit;\n```\nå®‰è£…java\n```shell\nsudo apt-get install openjdk-8-jdk\n```\n<a name=\"UbU8u\"></a>\n## 5. æ‰“åŒ…é¡¹ç›®åˆ°å®¹å™¨ä¸­\nç„¶åå°±æ˜¯å°†é¡¹ç›®æ‰“åŒ…ä¼ åˆ°å®¹å™¨ä¸­è¿è¡Œäº†\n\nåç«¯é¡¹ç›®å…ˆ`clean`å†`package`å³å¯ã€‚<br />å‰ç«¯é¡¹ç›®ä¿®æ”¹è¯·æ±‚åœ°å€è¿è¡Œ`npm run build`\n\nå°†åç«¯é¡¹ç›®çš„jaråŒ…åˆ†åˆ«å‘é€åˆ°å®¹å™¨ä¸­è¿è¡Œ\n```shell\njava -jar xxx.jar # è¿è¡Œ\n```\néœ€è¦åœæ­¢çš„è¯\n```shell\nps -ef | grep xxx.jar # æŸ¥è¯¢ç¨‹åºçš„è¿›ç¨‹å·\nkill -s 9 xxxx # åé¢æ˜¯æŸ¥è¯¢åˆ°çš„è¿›ç¨‹å·\n```\n<a name=\"UwYLg\"></a>\n## 6. é…ç½®è®¸å¯è¯ä»¥åŠnginxç­‰\né…ç½®`key, pem, nginx.conf`<br />åœ¨è¿™ä¹‹å‰å…ˆå°†é…ç½®æ–‡ä»¶å¤åˆ¶åˆ°rootç›®å½•ä¸‹ï¼ˆä¸ºäº†ä½¿é…ç½®nginx.confæ—¶æ–‡ä»¶æ ¼å¼å¥½çœ‹ç‚¹ï¼‰<br />`sudo cp .bashrc .vimrc .tmux.conf /root`<br />å…·ä½“çš„åŸŸåã€è®¸å¯è¯ã€è¯ä¹¦ç”³è¯·åŠ`nginx`é…ç½®å¯å‚è€ƒå…¶ä»–æ–‡ç« ã€‚<br />æœ€åå¯åŠ¨`nginx`\n```shell\nsudo /etc/init.d/nginx start # å¦‚æœè¿è¡Œç»“æœæ˜¯failçš„è¯éœ€è¦æŸ¥çœ‹é”™è¯¯æ—¥å¿—å¯¹åº”ä¿®æ”¹\n```\n\nç»“æŸã€‚<br />**é¢˜å¤–è¯ï¼š** éœ€è¦åœ¨æœ¬åœ°è¿æ¥å®¹å™¨ä¸­çš„æ•°æ®åº“ï¼Œå¯ä»¥å‚è€ƒ[Navicat è¿æ¥è¿œç¨‹æœåŠ¡å™¨é‡Œ docker ä¸­çš„ mysql](http://t.csdnimg.cn/mp9E2)\n\n","categories":["Linux"]},{"title":"ubuntuè§£å†³ç»ˆç«¯ä¸­æ–‡ä¹±ç é—®é¢˜","url":"/2024/01/28/ubuntuè§£å†³ç»ˆç«¯ä¸­æ–‡ä¹±ç é—®é¢˜/","content":"\n1. æŸ¥çœ‹å½“å‰ç³»ç»Ÿè¯­è¨€\n```shell\n$ echo $LANG\n```\n\n2. æŸ¥çœ‹ç³»ç»Ÿå®‰è£…çš„è¯­è¨€åŒ…\n```shell\n$ locale -a \nC\nC.UTF-8\nPOSIX\n\n$ sudo dpkg -l | grep language-pack-zh-hans\n```\n\n3. å¦‚æœæ²¡æœ‰ä¸­æ–‡è¯­è¨€åŒ…ï¼Œéœ€è¦å®‰è£…\n```shell\n$ sudo apt-get install language-pack-zh-hans\n```\n\n4. å®‰è£…æˆåŠŸåï¼Œç¡®è®¤æ˜¯å¦å®‰è£…æˆåŠŸ\n```shell\n$ locale -a \nC\nC.UTF-8\nPOSIX\nzh_CN.utf8\nzh_SG.utf8\n\n$ sudo dpkg -l | grep language-pack-zh-hans\nii  language-pack-zh-hans           1:20.04+20210802                    all          translation updates for language Simplified Chinese\nii  language-pack-zh-hans-base      1:20.04+20210802                    all          translations for language Simplified Chinese\n```\n\n5. è®¾ç½®ç³»ç»Ÿè¯­è¨€ç¯å¢ƒ\n```shell\n# export çš„æ–¹å¼åªå¯¹å½“å‰ç»ˆç«¯ç”Ÿæ•ˆ\n$ export LANG=\"zh_CN.UTF-8\"\n\n#  /etc/profile æ–‡ä»¶ä¸­æ·»åŠ export LANG=\"zh_CN.UTF-8\" å¯¹æ‰€æœ‰ç”¨æˆ·ç”Ÿæ•ˆ\n$ sudo vim /etc/profile\n```\n","categories":["Linux"]},{"title":"åŠ¨æ€è§„åˆ’LISæ¨¡å‹","url":"/2024/01/19/åŠ¨æ€è§„åˆ’LISæ¨¡å‹/","content":"\n<a name=\"UlPOe\"></a>\n## 1. LIS æ¨¡å‹\n> LISé—®é¢˜ï¼šç»™å®šä¸€ä¸ªé•¿åº¦ä¸º`N`çš„æ•°åˆ— `a`ï¼Œæ±‚æ•°å€¼ä¸¥æ ¼å•è°ƒé€’å¢çš„å­åºåˆ—çš„é•¿åº¦æœ€é•¿æ˜¯å¤šå°‘ã€‚\n\n**ç®—æ³•æ€æƒ³ï¼š**\n\n- çŠ¶æ€è¡¨ç¤ºï¼š$f[i]$è¡¨ç¤ºç”±æ•°åˆ—$a$çš„å‰$i$ä¸ªæ•°å­—ç»„æˆï¼ˆä¸ä¸€å®šåŒ…å«æ‰€æœ‰æ•°å­—ï¼‰ä¸”ä»¥$a[i]$ç»“å°¾çš„æœ€é•¿ä¸Šå‡å­åºåˆ—çš„é•¿åº¦ã€‚\n- çŠ¶æ€è®¡ç®—ï¼šéå†å°äº$i$çš„æ¯ä¸€ä¸ª$j$ï¼Œè‹¥æœ‰$a[j] < a[i]$ï¼Œåˆ™$f[i] = max(f[i], f[j] + 1)$ï¼Œå¦åˆ™$f[i] = 1$ã€‚\n\n**ä»£ç å®ç°ï¼š**\n```java\nimport java.util.*;\n\npublic class Main {\n    static final int N = 1010;\n    static int[] a = new int[N], f = new int[N];\n    public static void main(String[] args) {\n        Scanner sc = new Scanner(System.in);\n        int n = sc.nextInt();\n        for (int i = 1; i <= n; i ++) a[i] = sc.nextInt();\n        for (int i = 1; i <= n; i ++) {\n            f[i] = 1;\n            for (int j = 1; j <= n; j ++) {\n                if (a[j] < a[i]) f[i] = Math.max(f[i], f[j] + 1);\n            }\n        }\n        int res = 0;\n        for (int i = 1; i <= n; i ++) res = Math.max(res, f[i]);\n        System.out.println(res);\n    }\n}\n```\n**ä¼˜åŒ–ï¼š**<br />åœ¨çŠ¶æ€è®¡ç®—é‚£ä¸€æ­¥ï¼Œæˆ‘ä»¬æ¯æ¬¡å»éå†æ‰€æœ‰å°äº$i$çš„$j$ï¼Œè¿™æ ·æ˜¾ç„¶æ—¶é—´å¤æ‚åº¦æ˜¯$O(n^2)$ã€‚å¯¹äºæ•°æ®é‡å¤§çš„é¢˜ç›®ï¼Œæ˜¯ä¼š$TLE$çš„ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è´ªå¿ƒçš„æ–¹å¼æ¥ä¼˜åŒ–ï¼Œå…·ä½“å¦‚ä¸‹ï¼š<br />æˆ‘ä»¬ç”¨ä¸€ä¸ªæ•°ç»„$q$æ¥ç»´æŠ¤å½“å‰éå†åˆ°çš„å…ƒç´ ä¹‹å‰çš„åºåˆ—ï¼Œæ¯æ¬¡éå†åˆ°ä¸€ä¸ªå…ƒç´ $a[i]$ï¼Œå°±åœ¨$q$ä¸­å¯»æ‰¾å°äº$a[i]$çš„æœ€å¤§çš„å…ƒç´ $q[r]$ï¼Œå¹¶å°†$q[r+1]$èµ‹å€¼ä¸º$a[i]$ï¼ŒåŒæ—¶æ›´æ–°ä¸€ä¸‹æœ€é•¿ä¸Šå‡å­åºåˆ—çš„é•¿åº¦ã€‚<br />æœ‰ä¸‰ä¸ªæ³¨æ„ç‚¹ï¼š\n\n- å°†$q[r+1]$èµ‹å€¼ä¸º$a[i]$ï¼šæœ‰å¯èƒ½$a[i]$å°±æ˜¯ç»´æŠ¤çš„åºåˆ—ä¸­æœ€å¤§çš„å…ƒç´ ï¼Œå› æ­¤ä¼šæ˜¯æ·»åŠ åˆ°åºåˆ—åé¢ã€‚ä¹Ÿæœ‰å¯èƒ½æ˜¯å°†$q[r+1]$ä¿®æ”¹ä¸º$a[i]$ã€‚\n- å¦‚æœæ˜¯å°†$q[r+1]$ä¿®æ”¹ä¸º$a[i]$ï¼Œè¿™ä¸ªæ“ä½œæ˜¯ä¸å½±å“åé¢çš„éå†çš„ï¼Œå› ä¸ºå¦‚æœåé¢æŸä¸ªå…ƒç´ $a[j]$èƒ½æ”¾åˆ°åŸæ¥çš„$q[r+1]$åé¢ï¼Œä¹Ÿå¿…ç„¶èƒ½æ”¾åˆ°æ–°çš„$q[r+1](a[i])$åé¢ï¼ˆå› ä¸ºå½“å‰çš„$q[r+1]$å¿…ç„¶æ˜¯å¤§äº$a[i]$çš„ï¼‰ã€‚\n- åœ¨è¯¥åºåˆ—ä¸­å¯»æ‰¾å°äº$a[i]$çš„æœ€å¤§çš„å…ƒç´ $q[r]$ï¼šè¿™ä¸ªæ“ä½œæˆ‘ä»¬å¯ä»¥é€šè¿‡äºŒåˆ†æ¥å®ç°ã€‚\n\n**ä¼˜åŒ–ä»£ç å®ç°ï¼š**\n```java\nimport java.io.*;\n\npublic class Main {\n    static final int N = 100010;\n    static int[] a = new int[N], q = new int[N];\n    public static void main(String[] args) throws IOException{\n        BufferedReader br = new BufferedReader(new InputStreamReader(System.in));\n        int n = Integer.parseInt(br.readLine());\n        String[] s = br.readLine().split(\" \");\n        for (int i = 0; i < n; i ++) a[i] = Integer.parseInt(s[i]);\n        \n        int len = 0;\n        q[0] = -(int)2e9;\n        for (int i = 0; i < n; i ++) {\n            int l = 0, r = len;\n            while(l < r) {\n                int mid = l + r + 1 >> 1;\n                if (q[mid] < a[i]) l = mid;\n                else r = mid - 1;\n            }\n            // æ›´æ–°æœ€é•¿ä¸Šå‡å­åºåˆ—é•¿åº¦ï¼ˆä¸ä¸€å®šèƒ½æ›´æ–°ï¼‰\n            len = Math.max(len, r + 1);\n            // å°†æ–°ç‚¹æ’å…¥\n            q[r + 1] = a[i];\n        }\n        System.out.print(len);\n    }\n}\n```\n**LISæ¨¡å‹ç›¸å…³é¢˜ç›®ï¼š**\n\n- [AcWing 1017. æ€ªç›—åŸºå¾·çš„æ»‘ç¿”ç¿¼](https://www.acwing.com/problem/content/1019/)ï¼šé¢˜ç›®éœ€è¦æ±‚ä»ä¸€ä¸ªç‚¹å¼€å§‹ï¼Œæ¯ä¸€æ¬¡çš„ä¸‹ä¸€ä¸ªä½ç½®ä¸è®¸ä¸¥æ ¼ä½äºå‰ä¸€ä¸ªä½ç½®ï¼Œé—®æœ€è¿œèƒ½èµ°å¤šè¿œã€‚é€†å‘æ€ç»´ï¼Œæ±‚ä¸€éLISé—®é¢˜å³å¯ã€‚\n- [AcWing 482. åˆå”±é˜Ÿå½¢](https://www.acwing.com/problem/content/484/)ï¼šé¢˜ç›®è¦æ±‚è‡³å°‘è¦å¤šå°‘ååŒå­¦å‡ºåˆ—æ‰èƒ½å½¢æˆåˆå”±é˜Ÿå½¢ï¼Œæˆ‘ä»¬å¯ä»¥æ±‚åˆå”±é˜Ÿå½¢æœ€é•¿èƒ½å¤šé•¿ï¼ˆå³æ­£ååˆ†åˆ«æ±‚ä¸€æ¬¡LISé—®é¢˜ï¼‰ï¼Œç„¶åç”¨æ€»äººæ•°å‡å»æœ€é•¿åˆå”±é˜Ÿè¡Œäººæ•°ã€‚\n- [AcWing 1016. æœ€å¤§ä¸Šå‡å­åºåˆ—å’Œ](https://www.acwing.com/problem/content/1018/)ï¼šLISé—®é¢˜æ±‚çš„æ˜¯æ•°é‡ï¼Œè€Œè¿™é“é¢˜æ±‚çš„æ˜¯æ¯ä¸ªå…ƒç´ çš„å’Œï¼Œæ‰€ä»¥æ±‚LISé—®é¢˜æ—¶å°†`+1`æ”¹ä¸º`+a[i]`å³å¯ã€‚\n- [AcWing 187. å¯¼å¼¹é˜²å¾¡ç³»ç»Ÿ](https://www.acwing.com/problem/content/189/)ï¼šè¿™é“é¢˜è™½ç„¶ä¹Ÿæ˜¯LISæ¨¡å‹ï¼Œä½†æ˜¯å·²ç»è·ŸDPæ— å…³äº†ï¼Œè§£é¢˜æ–¹æ³•ä¸ºDFS+è´ªå¿ƒç‰ˆLISã€‚\n<a name=\"nYruO\"></a>\n## 2. LCSæ¨¡å‹\n> LCSé—®é¢˜ï¼šç»™å®šä¸¤ä¸ªé•¿åº¦åˆ†åˆ«ä¸ºn å’Œ m çš„å­—ç¬¦ä¸² a å’Œ bï¼Œæ±‚æ—¢æ˜¯ a çš„å­åºåˆ—åˆæ˜¯ b çš„å­åºåˆ—çš„å­—ç¬¦ä¸²é•¿åº¦æœ€é•¿æ˜¯å¤šå°‘ã€‚\n\n**ç®—æ³•æ€æƒ³ï¼š**\n\n- çŠ¶æ€è¡¨ç¤ºï¼š$f[i][j]$è¡¨ç¤ºç”±æ•°åˆ—$a$çš„å‰$i$ä¸ªæ•°å­—ä¸æ•°åˆ—$b$çš„å‰$j$ä¸ªæ•°å­—ç»„æˆçš„å…¬å…±å­åºåˆ—çš„é•¿åº¦æœ€å¤§å€¼ã€‚\n- çŠ¶æ€è®¡ç®—ï¼š\n   - å½“åŒ…å«$a[i]$ä¸”ä¸åŒ…å«$b[j]$æ—¶ï¼Œ$f[i][j] = max(f[i][j], f[i][j - 1])$ï¼›\n   - å½“åŒ…å«$b[j]$ä¸”ä¸åŒ…å«$a[i]$æ—¶ï¼Œ$f[i][j] = max(f[i][j], f[i - 1][j])$ï¼›\n   - å½“æ—¢ä¸åŒ…å«$a[i]$ä¹Ÿä¸åŒ…å«$b[j]$æ—¶ï¼Œ$f[i][j] = max(f[i][j], f[i - 1][j - 1])$ï¼Œä½†æ˜¯è¿™ç§æƒ…å†µå¯ä»¥è¢«ä»¥ä¸Šä»»æ„ä¸€ç§åŒ…å«ï¼›\n   - å½“åŒ…å«$a[i]$ä¸”åŒ…å«$b[j]$æ—¶ï¼ˆè¦æ±‚$a[i] = b[j]$ï¼‰ï¼Œ$f[i][j] = max(f[i][j], f[i - 1][j - 1] + 1)$ã€‚\n\n**ä»£ç å®ç°ï¼š**\n```java\nimport java.util.*;\n\npublic class Main {\n    static final int N = 1010;\n    static int[][] f = new int[N][N];\n    public static void main(String[] args) {\n        Scanner sc = new Scanner(System.in);\n        int n = sc.nextInt(), m = sc.nextInt();\n        char[] a = (\" \" + sc.next()).toCharArray(), b = (\" \" + sc.next()).toCharArray();\n        for (int i = 1; i <= n; i ++)\n            for (int j = 1; j <= m; j ++) {\n                f[i][j] = Math.max(f[i][j - 1], f[i - 1][j]);\n                if (a[i] == b[j]) f[i][j] = Math.max(f[i][j], f[i - 1][j - 1] + 1);\n            }\n        System.out.println(f[n][m]);\n    }\n}\n```\n<a name=\"FNFgY\"></a>\n## 3. LCISæ¨¡å‹\n> LCISé—®é¢˜ï¼šç»™å®šä¸¤ä¸ªé•¿åº¦åˆ†åˆ«ä¸ºn å’Œ m çš„å­—ç¬¦ä¸² a å’Œ bï¼Œæ±‚æ—¢æ˜¯ a çš„å­åºåˆ—åˆæ˜¯ b çš„å­åºåˆ—ä¸”æ•°å€¼ä¸¥æ ¼å•è°ƒé€’å¢çš„å­—ç¬¦ä¸²é•¿åº¦æœ€é•¿æ˜¯å¤šå°‘ã€‚\n\n**ç®—æ³•æ€æƒ³ï¼š**\n\n- çŠ¶æ€è¡¨ç¤ºï¼š$f[i][j]$è¡¨ç¤ºç”±æ•°åˆ—$a$çš„å‰$i$ä¸ªæ•°å­—ä¸æ•°åˆ—$b$çš„å‰$j$ä¸ªæ•°å­—ç»„æˆä¸”ä»¥$b[j]$ç»“å°¾çš„æœ€é•¿ä¸Šå‡å…¬å…±å­åºåˆ—çš„é•¿åº¦çš„æœ€å¤§å€¼ã€‚\n- çŠ¶æ€è®¡ç®—ï¼š\n   - å½“ä¸åŒ…å«$a[i]$æ—¶ï¼Œ$f[i][j] = f[i - 1][j]$ï¼›\n   - å½“åŒ…å«$a[i]$æ—¶ï¼ˆè¦æ±‚$a[i] = b[j]$ï¼‰ï¼Œæ­¤æ—¶$f[i][j]$èµ·ç ä¸º1ï¼Œ$f[i][j] = max(f[i][j], 1)$ï¼Œç„¶åéå†$b[j]$ä¹‹å‰çš„å…ƒç´ ï¼Œè‹¥$b[k]<b[j]$ï¼Œåˆ™$f[i][j] = max(f[i][j], f[i][k] + 1)$ã€‚\n\n**ä»£ç å®ç°ï¼š**\n```java\nimport java.util.*;\n\npublic class Main {\n    static final int N = 3010;\n    static int[] a = new int[N], b = new int[N];\n    static int[][] f = new int[N][N];\n    public static void main(String[] args) {\n        Scanner sc = new Scanner(System.in);\n        int n = sc.nextInt();\n        for (int i = 1; i <= n; i ++) a[i] = sc.nextInt();\n        for (int i = 1; i <= n; i ++) b[i] = sc.nextInt();\n        for (int i = 1; i <= n; i ++) \n            for (int j = 1; j <= n; j ++) {\n                f[i][j] = f[i - 1][j];\n                if (a[i] == b[j]) {\n                    f[i][j] = Math.max(f[i][j], 1);\n                    for (int k = 1; k < j; k ++) \n                        if (b[k] < b[j]) f[i][j] = Math.max(f[i][j], f[i][k] + 1);\n                }\n            }\n        int res = 0;\n        for (int i = 1; i <= n; i ++) res = Math.max(res, f[n][i]);\n        System.out.println(res);\n    }\n}\n```\n**ä¼˜åŒ–ï¼š**<br />ä¸Šè¿°çš„æ–¹æ³•æ—¶é—´å¤æ‚åº¦è¾¾åˆ°äº†$O(n^3)$ï¼Œæ•°æ®é‡ç¨å¤§ä¸€äº›å°±$TLE$ã€‚æˆ‘ä»¬å¯ä»¥å¯¹ä»£ç åšç­‰ä»·å˜å½¢ä¼˜åŒ–æˆ$O(n^2)$ã€‚<br />å¯ä»¥å‘ç°ï¼Œå½“$a[i] = b[j]$æ—¶ï¼Œ`if (b[k] < b[j]) f[i][j] = Math.max(f[i][j], f[i][k] + 1);`è¿™ä¸€å¥ç­‰ä»·äº`if (b[k] < a[i]) f[i][j] = Math.max(f[i][j], f[i][k] + 1);`ï¼Œæˆ‘ä»¬å°±èƒ½å‘ç°ï¼Œè¿™ä¸€éƒ¨åˆ†æ±‚è§£å…¶å®æ˜¯ä¸$b[j]$æ— å…³çš„ã€‚æˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨ä¸€ä¸ªå˜é‡ä»£æ›¿è¿™ä¸€éƒ¨åˆ†ï¼Œæ¯æ¬¡å¾ªç¯$j$æ—¶ç»´æŠ¤èµ·æ¥å³å¯ã€‚<br />**ä¼˜åŒ–ä»£ç å®ç°ï¼š**\n```java\nimport java.util.*;\n\npublic class Main {\n    static final int N = 3010;\n    static int[] a = new int[N], b = new int[N];\n    static int[][] f = new int[N][N];\n    public static void main(String[] args) {\n        Scanner sc = new Scanner(System.in);\n        int n = sc.nextInt();\n        for (int i = 1; i <= n; i ++) a[i] = sc.nextInt();\n        for (int i = 1; i <= n; i ++) b[i] = sc.nextInt();\n        for (int i = 1; i <= n; i ++) {\n            int maxv = 1;\n            for (int j = 1; j <= n; j ++) {\n                f[i][j] = f[i - 1][j];\n                if (a[i] == b[j]) f[i][j] = Math.max(f[i][j], maxv);\n                // è¿™é‡Œçš„b[j]å°±ç­‰ä»·äºä¼˜åŒ–å‰çš„b[k]ï¼Œa[i]å°±ç­‰ä»·äºä¼˜åŒ–å‰çš„b[j]\n                if (a[i] > b[j]) maxv = Math.max(maxv, f[i][j] + 1);\n            }\n        }\n        int res = 0;\n        for (int i = 1; i <= n; i ++) res = Math.max(res, f[n][i]);\n        System.out.println(res);\n    }\n}\n```\n\n","categories":["ç®—æ³•"]},{"title":"äºŒåˆ†ç®—æ³•è¯¦è§£","url":"/2024/01/16/äºŒåˆ†ç®—æ³•è¯¦è§£/","content":"\n<a name=\"qR9aQ\"></a>\n## 1. äºŒåˆ†å®šä¹‰\n**äºŒåˆ†æŸ¥æ‰¾ï¼ˆç™¾åº¦ç™¾ç§‘ï¼‰**ï¼šäºŒåˆ†æŸ¥æ‰¾ä¹Ÿç§°æŠ˜åŠæŸ¥æ‰¾ï¼ˆBinary Searchï¼‰ï¼Œå®ƒæ˜¯ä¸€ç§æ•ˆç‡è¾ƒé«˜çš„æŸ¥æ‰¾æ–¹æ³•ã€‚ä½†æ˜¯ï¼ŒæŠ˜åŠæŸ¥æ‰¾è¦æ±‚[çº¿æ€§è¡¨](https://baike.baidu.com/item/%E7%BA%BF%E6%80%A7%E8%A1%A8/3228081?fromModule=lemma_inlink)å¿…é¡»é‡‡ç”¨[é¡ºåºå­˜å‚¨ç»“æ„](https://baike.baidu.com/item/%E9%A1%BA%E5%BA%8F%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84/1347176?fromModule=lemma_inlink)ï¼Œè€Œä¸”è¡¨ä¸­å…ƒç´ æŒ‰å…³é”®å­—æœ‰åºæ’åˆ—ã€‚<br />ä¸Šè¿°çš„å®šä¹‰åªæ˜¯ç‹­ä¹‰ä¸Šçš„äºŒåˆ†æŸ¥æ‰¾å®šä¹‰ï¼Œåœ¨ä¸Šè¿°å®šä¹‰ä¸­æåˆ°äº†ä¸€ä¸ªæ¦‚å¿µï¼š**æœ‰åº**ï¼Œä½†å®é™…ä¸Šï¼Œæˆ‘ä»¬åªéœ€è¦è®©çº¿æ€§è¡¨æ»¡è¶³**äºŒæ®µæ€§**å³å¯ä½¿ç”¨äºŒåˆ†ã€‚\n<a name=\"cfGPL\"></a>\n## 2. äºŒæ®µæ€§\né‚£ä¹ˆï¼Œä»€ä¹ˆæ˜¯äºŒæ®µæ€§å‘¢ï¼Ÿ<br />æ‰€è°“äºŒæ®µæ€§ï¼Œå°±æ˜¯åœ¨çº¿æ€§è¡¨ä¸­æœ‰ä¸€ä¸ªå…ƒç´ ï¼Œä½¿å¾—è¯¥å…ƒç´ çš„å·¦ä¾§æ»¡è¶³æ€§è´¨1ï¼Œå³ä¾§æ»¡è¶³æ€§è´¨2ã€‚<br />ä¸¾ä¸ªğŸŒ°ï¼Œæœ‰ä¸€ä¸ªæ•°ç»„`nums = [4, 5, 6, 7, 0, 1, 2]`ï¼Œè¯¥æ•°æ•°ç»„åŸæœ¬æ˜¯ä¸¥æ ¼é€’å¢çš„ï¼Œä½†æ˜¯è¢«æŒ‰ç…§æŸä¸ªç‚¹æ—‹è½¬äº†ä¸€æ¬¡ã€‚ç°åœ¨æˆ‘ä»¬éœ€è¦æ‰¾å‡ºè¯¥æ•°ç»„çš„åŸå§‹èµ·ç‚¹ï¼ˆå½“ç„¶ï¼Œç›´æ¥éå†ä¸€éæ˜¯ä¸€ç§æœ‰æ•ˆä½†å¹¶ä¸ä¼˜ç¾çš„åšæ³•ï¼‰ã€‚åœ¨è¿™ä¾‹å­ä¸­ï¼Œèµ·ç‚¹å½“ç„¶æ˜¯`0`äº†ï¼Œå¹¶ä¸”æˆ‘ä»¬é€šè¿‡è§‚å¯Ÿå¯ä»¥å‘ç°ï¼Œ`0`**çš„å·¦ä¾§æ»¡è¶³æ‰€æœ‰çš„å…ƒç´ éƒ½å¤§äºç­‰äº**`nums[0] = 4`ï¼ˆæ€§è´¨1ï¼‰ï¼Œè€Œ`0`**åŠå…¶å³ä¾§å…ƒç´ éƒ½å°äº**`nums[0] = 4`ï¼ˆæ€§è´¨2ï¼‰ã€‚é‚£ä¹ˆæ­¤æ—¶ï¼Œå…ƒç´ `0`å°±æ˜¯è®©è¿™ä¸ªçº¿æ€§è¡¨å…·æœ‰äºŒæ®µæ€§çš„å…ƒç´ **ä¹‹ä¸€**ï¼ˆä¸ºä»€ä¹ˆè¯´ä¹‹ä¸€å‘¢ï¼Œå› ä¸ºä¾‹å¦‚`7`ä¹Ÿèƒ½ä½¿è¯¥çº¿æ€§è¡¨å…·æœ‰äºŒæ®µæ€§ï¼‰ã€‚<br />ä¸ºä»€ä¹ˆå…·æœ‰äºŒæ®µæ€§å°±èƒ½ä½¿ç”¨äºŒåˆ†å‘¢ï¼Ÿ<br />è¿˜æ˜¯æ‹¿ä¸Šè¿°ä¾‹å­è¿›è¡Œè¯´æ˜ï¼Œæˆ‘ä»¬æ—¢ç„¶æ¸…æ¥šäº†æˆ‘ä»¬éœ€è¦æŸ¥æ‰¾çš„å…ƒç´ å…·æœ‰äºŒæ®µæ€§ï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬æ˜¯å¦å¯ä»¥åˆ©ç”¨è¿™ä¸ªæ€§è´¨ç¼©å°æŸ¥è¯¢èŒƒå›´ä»¥ä¸æ–­é€¼è¿‘å¹¶æœ€ç»ˆæŸ¥è¯¢åˆ°è¿™ä¸ªå…ƒç´ å‘¢ï¼Ÿ\n<a name=\"f3r3P\"></a>\n## 3. åˆ©ç”¨äºŒæ®µæ€§å®ç°äºŒåˆ†\nç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚æ¯ä¸€æ¬¡ï¼Œæˆ‘ä»¬å–æ•´ä¸ªçº¿æ€§è¡¨çš„ä¸­é—´å…ƒç´ ï¼ˆä¸‹æ ‡è®°ä¸º`mid`ï¼‰ï¼Œåˆ¤æ–­`nums[mid]`æ»¡è¶³**æ€§è´¨1**è¿˜æ˜¯**æ€§è´¨2**ã€‚\n\n- å¦‚æœæ»¡è¶³æ€§è´¨1ï¼Œåˆ™è¯´æ˜`nums[mid]`åœ¨ç›®æ ‡å…ƒç´ çš„å·¦ä¾§ï¼Œæ­¤æ—¶æˆ‘ä»¬å°†åŒºé—´å·¦ç«¯ç‚¹ï¼ˆ`l`ï¼‰ç§»åŠ¨åˆ°`mid + 1`ï¼ˆå› ä¸ºæ­¤æ—¶æˆ‘ä»¬å¯ä»¥æ˜ç¡®çš„çŸ¥é“`nums[mid]`å¹¶ä¸æ˜¯æˆ‘ä»¬éœ€è¦çš„å…ƒç´ ï¼‰ã€‚\n- å¦‚æœæ»¡è¶³æ€§è´¨2ï¼Œåˆ™è¯´æ˜`nums[mid]`å°±æ˜¯ç›®æ ‡å…ƒç´ æˆ–æ˜¯åœ¨ç›®æ ‡å…ƒç´ å³ä¾§ï¼Œæ­¤æ—¶æˆ‘ä»¬å°†åŒºé—´å³ç«¯ç‚¹ç§»åŠ¨åˆ°`mid`ã€‚\n\näºæ˜¯ï¼ŒäºŒåˆ†æŸ¥æ‰¾çš„ä»£ç å°±æœ‰äº†ï¼š\n```java\nint l = 0, r = n - 1;\nint x = nums[0];\nwhile (l < r) {\n    int mid = l + r >> 1;\n    if (nums[mid] >= x) l = mid + 1;\n    else r = mid;\n}\n```\n> `l + r >> 1`ç­‰ä»·äº`(l + r) / 2`\n\nåˆ°æ­¤å¤„ï¼Œæˆ‘ä»¬å‡ ä¹èƒ½ç”¨ä¸€å¥è¯æ€»ç»“äºŒåˆ†ï¼Œå³**åˆ©ç”¨äºŒæ®µæ€§ä¸æ–­é€¼è¿‘ç›´åˆ°æŸ¥æ‰¾åˆ°ç›®æ ‡å…ƒç´ **ã€‚\n<a name=\"GDwgm\"></a>\n## 4. äºŒåˆ†å¸¸è§æ¨¡æ¿\nè¿™ç±»é¢˜ç›®ä¸€èˆ¬èƒ½å¤Ÿä½¿ç”¨äºŒåˆ†ï¼ˆå› ä¸ºä»–ä»¬é€šå¸¸æƒ…å†µä¸‹å…·æœ‰äºŒæ®µæ€§ï¼‰ï¼š\n\n- æŸ¥æ‰¾æœ€å°çš„æœ€å¤§å€¼\n- æŸ¥æ‰¾æœ€å¤§çš„æœ€å°å€¼\n\n**æ¨¡æ¿1ï¼š**\n```java\nint l = 0, r = n - 1;\nwhile (l < r) {\n    int mid = l + r >> 1;\n    // check() åˆ¤æ–­ mid æ˜¯å¦æ»¡è¶³æ€§è´¨1æˆ–æ€§è´¨2\n    if (check(mid)) r = mid;\n    else l = mid + 1;\n}\n```\n**æ¨¡æ¿2ï¼š**\n```java\nint l = 0, r = n - 1;\nwhile (l < r) {\n    int mid = l + r + 1 >> 1;\n    if (check(mid)) l = mid;\n    else r = mid - 1;\n}\n```\n**ä¸ºä»€ä¹ˆä¼šæœ‰ä¸¤ç§æ¨¡æ¿å‘¢ï¼Ÿ**<br />ä¸»è¦æ˜¯å‡ºäºä¸¤ä¸ªç›®çš„ï¼š\n\n1. æ—¶æ—¶åˆ»åˆ»ä¿è¯ç›®æ ‡å…ƒç´ åœ¨æ‰€ç»´æŠ¤åŒºé—´çš„å†…éƒ¨\n2. å¤„ç†è¾¹ç•Œé—®é¢˜ï¼ˆç›´æ¥èƒŒè¿‡å°±è¡Œï¼Œå½“å‡ºç°`r = mid - 1`æ—¶ï¼Œ`mid`å°±å®šä¹‰ä¸º`int mid = l + r + 1 >> 1;`ï¼Œå‰äººæ€»ç»“å‡ºçš„ç»éªŒï¼‰ã€‚\n\nåœ¨æ¬¡ç»™å‡ºå‡ é“`leetcode`ä¾‹é¢˜ç»ƒç»ƒæ‰‹ï¼ˆé€šè¿‡çœ‹ä¼˜è´¨é¢˜è§£æ˜¯å¾ˆå¥½çš„è¿›æ­¥æ–¹å¼ï¼‰ï¼š\n\n- ä¾‹é¢˜1ï¼š[åœ¨æ’åºæ•°ç»„ä¸­æŸ¥æ‰¾å…ƒç´ çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªä½ç½®](https://leetcode.cn/problems/find-first-and-last-position-of-element-in-sorted-array/description/)\n- ä¾‹é¢˜2ï¼š[æœç´¢æ—‹è½¬æ’åºæ•°ç»„](https://leetcode.cn/problems/search-in-rotated-sorted-array/description/)\n- ä¾‹é¢˜3ï¼š[æœç´¢æ—‹è½¬æ’åºæ•°ç»„ II](https://leetcode.cn/problems/search-in-rotated-sorted-array-ii/description/)\n<a name=\"ThfuS\"></a>\n## 5. æ‰©å±•ï¼šäºŒåˆ†ç­”æ¡ˆ\nå¯¹äºäºŒåˆ†çš„é¢˜ç›®ï¼Œå¾ˆå¤šæ—¶å€™è¿˜ä¼šä»¥**äºŒåˆ†ç­”æ¡ˆ**çš„å½¢å¼å‡ºé¢˜ã€‚<br />ä»€ä¹ˆæ˜¯äºŒåˆ†ç­”æ¡ˆï¼Ÿ<br />**æˆ‘ä»¬ä»¥ä¸€é“ä¾‹é¢˜ä¸ºä¾‹ï¼š**[**è·³çŸ³å¤´**](https://www.luogu.com.cn/problem/P2678)\n<a name=\"TROgb\"></a>\n### 5.1 é¢˜ç›®æè¿°\nä¸€å¹´ä¸€åº¦çš„â€œè·³çŸ³å¤´â€æ¯”èµ›åˆè¦å¼€å§‹äº†ï¼<br />è¿™é¡¹æ¯”èµ›å°†åœ¨ä¸€æ¡ç¬”ç›´çš„æ²³é“ä¸­è¿›è¡Œï¼Œæ²³é“ä¸­åˆ†å¸ƒç€ä¸€äº›å·¨å¤§å²©çŸ³ã€‚ç»„å§”ä¼šå·²ç»é€‰æ‹©å¥½äº†ä¸¤å—å²©çŸ³ä½œä¸ºæ¯”èµ›èµ·ç‚¹å’Œç»ˆç‚¹ã€‚åœ¨èµ·ç‚¹å’Œç»ˆç‚¹ä¹‹é—´ï¼Œæœ‰ $N$ å—å²©çŸ³ï¼ˆä¸å«èµ·ç‚¹å’Œç»ˆç‚¹çš„å²©çŸ³ï¼‰ã€‚åœ¨æ¯”èµ›è¿‡ç¨‹ä¸­ï¼Œé€‰æ‰‹ä»¬å°†ä»èµ·ç‚¹å‡ºå‘ï¼Œæ¯ä¸€æ­¥è·³å‘ç›¸é‚»çš„å²©çŸ³ï¼Œç›´è‡³åˆ°è¾¾ç»ˆç‚¹ã€‚<br />ä¸ºäº†æé«˜æ¯”èµ›éš¾åº¦ï¼Œç»„å§”ä¼šè®¡åˆ’ç§»èµ°ä¸€äº›å²©çŸ³ï¼Œä½¿å¾—é€‰æ‰‹ä»¬åœ¨æ¯”èµ›è¿‡ç¨‹ä¸­çš„æœ€çŸ­è·³è·ƒè·ç¦»å°½å¯èƒ½é•¿ã€‚ç”±äºé¢„ç®—é™åˆ¶ï¼Œç»„å§”ä¼šè‡³å¤šä»èµ·ç‚¹å’Œç»ˆç‚¹ä¹‹é—´ç§»èµ° $M$ å—å²©çŸ³ï¼ˆä¸èƒ½ç§»èµ°èµ·ç‚¹å’Œç»ˆç‚¹çš„å²©çŸ³ï¼‰ã€‚\n<a name=\"vk8Ln\"></a>\n### è¾“å…¥æ ¼å¼\nç¬¬ä¸€è¡ŒåŒ…å«ä¸‰ä¸ªæ•´æ•° $L,N,M$ï¼Œåˆ†åˆ«è¡¨ç¤ºèµ·ç‚¹åˆ°ç»ˆç‚¹çš„è·ç¦»ï¼Œèµ·ç‚¹å’Œç»ˆç‚¹ä¹‹é—´çš„å²©çŸ³æ•°ï¼Œä»¥åŠç»„å§”ä¼šè‡³å¤šç§»èµ°çš„å²©çŸ³æ•°ã€‚ä¿è¯ $L \\geq 1$ ä¸” $N \\geq M \\geq 0$ã€‚<br />æ¥ä¸‹æ¥ $N$ è¡Œï¼Œæ¯è¡Œä¸€ä¸ªæ•´æ•°ï¼Œç¬¬ $i$ è¡Œçš„æ•´æ•° $D_i\\,( 0 < D_i < L)$ï¼Œ è¡¨ç¤ºç¬¬ $i$ å—å²©çŸ³ä¸èµ·ç‚¹çš„è·ç¦»ã€‚è¿™äº›å²©çŸ³æŒ‰ä¸èµ·ç‚¹è·ç¦»ä»å°åˆ°å¤§çš„é¡ºåºç»™å‡ºï¼Œä¸”ä¸ä¼šæœ‰ä¸¤ä¸ªå²©çŸ³å‡ºç°åœ¨åŒä¸€ä¸ªä½ç½®ã€‚\n<a name=\"Fvhnt\"></a>\n### è¾“å‡ºæ ¼å¼\nä¸€ä¸ªæ•´æ•°ï¼Œå³æœ€çŸ­è·³è·ƒè·ç¦»çš„æœ€å¤§å€¼ã€‚\n<a name=\"q3dYD\"></a>\n### æ ·ä¾‹è¾“å…¥ #1\n```\n25 5 2 \n2\n11\n14\n17 \n21\n```\n<a name=\"X2jeI\"></a>\n### æ ·ä¾‹è¾“å‡º #1\n```\n4\n```\n<a name=\"lnEVN\"></a>\n### è¾“å…¥è¾“å‡ºæ ·ä¾‹ 1 è¯´æ˜\nå°†ä¸èµ·ç‚¹è·ç¦»ä¸º $2$ å’Œ $14$ çš„ä¸¤ä¸ªå²©çŸ³ç§»èµ°åï¼Œæœ€çŸ­çš„è·³è·ƒè·ç¦»ä¸º $4$ï¼ˆä»ä¸èµ·ç‚¹è·ç¦» $17$ çš„å²©çŸ³è·³åˆ°è·ç¦» $21$ çš„å²©çŸ³ï¼Œæˆ–è€…ä»è·ç¦» $21$ çš„å²©çŸ³è·³åˆ°ç»ˆç‚¹ï¼‰ã€‚\n<a name=\"dfZxe\"></a>\n### æ•°æ®è§„æ¨¡ä¸çº¦å®š\nå¯¹äº $20\\%$çš„æ•°æ®ï¼Œ$0 \\le M \\le N \\le 10$ã€‚<br />å¯¹äº $50\\%$ çš„æ•°æ®ï¼Œ$0 \\le M \\le N \\le 100$ã€‚<br />å¯¹äº $100\\%$ çš„æ•°æ®ï¼Œ$0 \\le M \\le N \\le 50000,1 \\le L \n \\le 10^9$ã€‚\n<a name=\"OBkEH\"></a>\n### 5.2 é¢˜è§£\næœ¬é¢˜ä¸­ï¼Œæˆ‘ä»¬çš„ç›®çš„æ˜¯è¦å¯»æ‰¾`æœ€çŸ­è·³è·ƒè·ç¦»çš„æœ€å¤§å€¼`ï¼Œè¿™ä¸ªç­”æ¡ˆè‚¯å®šåœ¨$1\\thicksim L$ä¹‹é—´ï¼Œæœ€æš´åŠ›çš„æ–¹æ³•å°±æ˜¯ä»$L$æšä¸¾åˆ°$1$ï¼Œæ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªåˆæ³•ç­”æ¡ˆå°±æ˜¯æœ€ä¼˜è§£ã€‚é‚£ä¹ˆä»€ä¹ˆæ ·çš„ç­”æ¡ˆèƒ½è¢«ç§°ä¸ºåˆæ³•å‘¢ï¼Ÿé¢˜ç›®è¦æ±‚æœ€å¤šåªèƒ½æŒªèµ°$M$å—çŸ³å¤´ï¼Œæ‰€ä»¥å¦‚æœåœ¨æŒªèµ°$M$å—çŸ³å¤´ä¹‹å‰èƒ½å¤Ÿæ»¡è¶³æ¯ä¸¤å—çŸ³å¤´é—´çš„è·ç¦»å¤§äºç­‰äºæˆ‘ä»¬æšä¸¾çš„ç­”æ¡ˆï¼Œé‚£ä¹ˆè¿™ä¸ªç­”æ¡ˆå°±æ˜¯åˆæ³•çš„ã€‚è€ŒæŒªèµ°çŸ³å¤´çš„é¡ºåºå°±æ˜¯è¦å…ˆè§£å†³è·ç¦»æœ€å°çš„çŸ³å¤´ï¼Œå› æ­¤ä»å°åˆ°å¤§å¼€å§‹æŒªçŸ³å¤´å³å¯ï¼Œæ¯æ¬¡æŒªå®ŒçŸ³å¤´è®°å½•æŒªèµ°çš„çŸ³å¤´æ•°é‡ï¼Œç„¶åæ›´æ–°ä¸€ä¸‹ä¸‹ä¸€å—çŸ³å¤´ä¸æŒªèµ°çš„çŸ³å¤´çš„ä¸Šä¸€å—çŸ³å¤´ä¹‹é—´çš„è·ç¦»ã€‚è‹¥æŒªå®ŒçŸ³å¤´å‘ç°æŒªèµ°çŸ³å¤´çš„æ•°é‡å¤§äº$M$ï¼Œé‚£ä¹ˆæˆ‘ä»¬æšä¸¾çš„è¿™ä¸ªç­”æ¡ˆå°±ä¸æ˜¯æ»¡è¶³é¢˜ç›®è¦æ±‚çš„`æœ€çŸ­è·³è·ƒè·ç¦»çš„æœ€å¤§å€¼`ï¼Œå°±ç»§ç»­å¾€å‰æ‰¾ã€‚\n\næˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œåœ¨ä¸Šé¢çš„åˆ†æè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬æ˜¯å…ˆä»ç­”æ¡ˆå…¥æ‰‹ï¼Œå†å»åˆ¤æ–­ç­”æ¡ˆæ˜¯å¦æ»¡è¶³é¢˜ç›®çš„é™åˆ¶æ¡ä»¶ã€‚è€Œè¿™ä¸€æš´åŠ›è¿‡ç¨‹å…¶å®æ˜¯å¯ä»¥ä½¿ç”¨äºŒåˆ†ä¼˜åŒ–çš„ã€‚è¿™ç§ä»ç­”æ¡ˆå‡ºå‘ï¼Œä½¿ç”¨äºŒåˆ†ä¼˜åŒ–çš„æ–¹å¼å°±è¢«ç§°ä¸º**äºŒåˆ†ç­”æ¡ˆ**ã€‚\n\n> é‡ç‚¹åˆ†æ`check`å‡½æ•°ï¼ŒäºŒåˆ†çš„ç²¾é«“ã€‚\n\n\n```java\nimport java.io.*;\nimport java.util.Arrays;\npublic class Main {\n\tstatic final int N = 50010;\n\tstatic int L, n, m;\n    // distè®°å½•å½“å‰ç‚¹ä¸å‰ä¸€ä¸ªç‚¹çš„è·ç¦»\n\tstatic int[] a = new int[N], dist = new int[N];\n\tpublic static boolean check(int mid) {\n\t\tint cnt = 0;\n\t\tint[] backup = Arrays.copyOf(dist, dist.length);\n\t\tfor (int i = 1; i <= n; i ++)\n\t\t\tif (dist[i] < mid) {\n\t\t\t\tcnt ++;\n\t\t\t\tdist[i + 1] += dist[i];\n\t\t\t}\n        // æ¯ä¸€è½®æŒªå®ŒçŸ³å¤´éœ€è¦å°†distæ•°ç»„è¿˜åŸï¼Œå› ä¸ºæ¯è½®æŒªçŸ³å¤´éƒ½æ˜¯ç‹¬ç«‹çš„\n\t\tdist = Arrays.copyOf(backup, backup.length);\n\t\treturn cnt <= m;\n\t}\n\tpublic static void main(String[] args) throws IOException{\n\t\tBufferedReader br = new BufferedReader(new InputStreamReader(System.in));\n\t\tString[] s = br.readLine().split(\" \");\n\t\tL = Integer.parseInt(s[0]);\n\t\tn = Integer.parseInt(s[1]);\n\t\tm = Integer.parseInt(s[2]);\n\t\tfor (int i = 1; i <= n; i ++) {\n\t\t\ta[i] = Integer.parseInt(br.readLine().split(\" \")[0]);\n\t\t\tdist[i] = a[i] - a[i - 1];\n\t\t}\n\t\tdist[n + 1] = L - a[n];\n\t\tn ++;\n\t\tint l = 1, r = L;\n\t\twhile (l < r) {\n\t\t\tint mid = l + r + 1 >> 1;\n\t\t\tif (check(mid)) l = mid;\n\t\t\telse r = mid - 1;\n\t\t}\n\t\tSystem.out.print(l);\n\t}\n}\n```\n","categories":["ç®—æ³•"]},{"title":"ä½¿ç”¨@JsonFormatæ³¨è§£å‰åç«¯æ—¶é—´ç›¸å·®8å°æ—¶çš„é—®é¢˜","url":"/2023/12/17/ä½¿ç”¨@JsonFormatæ³¨è§£å‰åç«¯æ—¶é—´ç›¸å·®8å°æ—¶çš„é—®é¢˜/","content":"\n<a name=\"BW8kv\"></a>\nåœ¨å†™é¡¹ç›®æ—¶å‘ç°åœ¨å®ä½“ç±»ä¸­ä½¿ç”¨äº†`@JsonFormat(pattern = \"yyyy-MM-dd HH:mm:ss\")`æ³¨è§£ï¼Œç„¶åè¯¥æ—¶é—´å­˜å…¥æ•°æ®åº“ä¹Ÿæ­£å¸¸ï¼Œä»æ•°æ®åº“ä¸­å–å‡ºä¹Ÿæ˜¯æ­£å¸¸ï¼Œä½†æ˜¯ä¼ ç»™å‰ç«¯å°±å‡ºç°é—®é¢˜ï¼Œä¸¤è¾¹çš„æ—¶é—´ç›¸å·®äº† `8`å°æ—¶ã€‚\n\n- é…ç½®æ–‡ä»¶ï¼š\n```yaml\nurl: jdbc:mysql://localhost:3306/xxx?serverTimezone=Asia/Shanghai&useUnicode=true&characterEncoding=utf-8\n```\n> æ³¨æ„ï¼š`gmtCreate`åªæ˜¯æ•°æ®åº“ä¸­ä¹ æƒ¯å‘½åï¼Œå¹¶éä½¿ç”¨çš„æ˜¯`GMT`æ—¶é—´ã€‚\n\n<a name=\"lsS8y\"></a>\n## 1. åŸå§‹å†™æ³•\n```java\n@JsonFormat(pattern = \"yyyy-MM-dd HH:mm:ss\")\nprivate Date gmtModified;\n```\n\n- ç¨‹åºè·å–åˆ°çš„æ—¶é—´ï¼š![image.png](https://cdn.acwing.com/media/article/image/2024/03/03/126318_adf2f129d9-1.1.png)\n- æ•°æ®åº“ä¸­å­˜å…¥çš„æ—¶é—´ï¼š![image.png](https://cdn.acwing.com/media/article/image/2024/03/03/126318_afd1785ed9-1.2.png)\n- å‰ç«¯æ¥æ”¶åˆ°çš„æ—¶é—´ï¼š![image.png](https://cdn.acwing.com/media/article/image/2024/03/03/126318_b2bf2366d9-1.3.png)\n\n**é—®é¢˜å‰–æï¼š**\n\n1. **ç¨‹åº-æ•°æ®åº“ï¼š** ç¨‹åºä¸­è·å–çš„æ˜¯å½“å‰çš„ç³»ç»Ÿæ—¶é—´ï¼Œå–å†³äºæœåŠ¡å™¨çš„æ—¶é—´ï¼Œæ‰€ä»¥è·å–çš„æ—¶é—´æ˜¯æ­£ç¡®çš„ï¼Œç„¶åä¼ ç»™æ•°æ®åº“çš„æ—¶å€™ï¼Œç”±äºä¸¤è¾¹çš„æ—¶åŒºæ²¡æœ‰å·®åˆ«ï¼Œæ‰€ä»¥åœ¨åºåˆ—åŒ–çš„æ—¶å€™ï¼Œæ—¶é—´è½¬åŒ–æ˜¯æ²¡æœ‰ä¸€ç‚¹é—®é¢˜çš„ã€‚\n2. **æ•°æ®åº“-ç¨‹åºï¼š** ä»æ•°æ®åº“å–å‡ºæ—¶é—´çš„æ—¶å€™è¿›è¡Œååºåˆ—åŒ–ï¼Œæ­¤æ—¶ä¸¤è¾¹çš„æ—¶åŒºä¸€è‡´ï¼Œæ—¶é—´è½¬æ¢æ²¡æœ‰é—®é¢˜ï¼Œæ‰€ä»¥ç¨‹åºæ‹¿åˆ°çš„æ—¶é—´ä¹Ÿæ˜¯æ­£ç¡®çš„ã€‚\n3. **ç¨‹åº-å‰ç«¯ï¼š** å½“ç¨‹åºéœ€è¦å°†å¯¹è±¡ä¼ è¾“ç»™å‰ç«¯æ—¶ï¼Œå¹¶ä¸æ˜ç¡®å‰ç«¯çš„æ—¶åŒºï¼Œæ‰€ä»¥å°†é»˜è®¤å¯¹æ–¹ä¸º`GMT`æ—¶é—´ï¼Œæ‰€ä»¥åœ¨åºåˆ—åŒ–æ—¶ï¼Œç”±äºæ—¶åŒºçš„å˜åŒ–ï¼Œå¾—åˆ°çš„`Json`å­—ç¬¦ä¸²è‡ªç„¶ä¹Ÿå‘ç”Ÿäº†å˜åŒ–ï¼ˆ`-8`å°æ—¶ï¼‰ã€‚\n<a name=\"VtAtN\"></a>\n## 2. ä¿®æ­£å†™æ³•\n```java\n@JsonFormat(pattern = \"yyyy-MM-dd HH:mm:ss\", timezone = \"GMT+8\")\nprivate Date gmtCreate;\n```\n\n- ç¨‹åºè·å–åˆ°çš„æ—¶é—´ï¼š![image.png](https://cdn.acwing.com/media/article/image/2024/03/03/126318_b3fb63dfd9-2.1.png)\n- æ•°æ®åº“ä¸­å­˜å…¥çš„æ—¶é—´ï¼š![image.png](https://cdn.acwing.com/media/article/image/2024/03/03/126318_b7045e3bd9-2.2.png)\n- å‰ç«¯æ¥æ”¶åˆ°çš„æ—¶é—´ï¼š![image.png](https://cdn.acwing.com/media/article/image/2024/03/03/126318_baa13aecd9-2.3.png)\n\né€šè¿‡åœ¨`@JsonFormat(pattern = \"yyyy-MM-dd HH:mm:ss\")`æ³¨è§£ä¸­åŠ å…¥`timezone = \"GMT+8\"`ï¼Œå°±æ˜ç¡®äº†åœ¨è½¬ä¸º`GMT`æ—¶é—´æ—¶å°†æ—¶é—´`+8`å†åºåˆ—åŒ–ã€‚<br />å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æŒ‡å®šæ—¶åŒºï¼š\n```java\n@JsonFormat(pattern = \"yyyy-MM-dd HH:mm:ss\", timezone = \"Asia/Shanghai\")\nprivate Date gmtCreate;\n```\n","categories":["åç«¯å¼€å‘æ’å‘"]},{"title":"SQLå¼€å‘æ‰‹å†Œï¼ˆè‡ªç”¨ç‰ˆï¼‰","url":"/2023/09/14/SQLå¼€å‘æ‰‹å†Œï¼ˆè‡ªç”¨ç‰ˆï¼‰/","content":"\n<a name=\"kaTKj\"></a>\n# ä¸€ã€SELECTæŸ¥è¯¢æŠ€å·§\n1ã€å¯¹æŸ¥è¯¢è¿›è¡Œä¼˜åŒ–ï¼Œåº”å°½é‡é¿å…å…¨è¡¨æ‰«æ(éå¿…è¦ä¸ä½¿ç”¨`SELECT * FROM table1`)ï¼Œé¦–å…ˆåº”è€ƒè™‘åœ¨ WHERE åŠ ORDER BY æ¶‰åŠçš„åˆ—ä¸Šå»ºç«‹ç´¢å¼•(å»ºç«‹ç´¢å¼•éœ€æ»¡è¶³å»ºç«‹ç´¢å¼•è§„çº¦)ã€‚<br />2ã€åº”å°½é‡é¿å…åœ¨ WHERE å­å¥ä¸­å¯¹å­—æ®µè¿›è¡Œ NULL å€¼åˆ¤æ–­ï¼Œåˆ›å»ºè¡¨æ—¶ NULL æ˜¯é»˜è®¤å€¼ï¼Œä½†å¤§å¤šæ•°æ—¶å€™åº”è¯¥ä½¿ç”¨ NOT NULLï¼Œæˆ–è€…ä½¿ç”¨ä¸€ä¸ªç‰¹æ®Šçš„å€¼ï¼Œå¦‚ 0ï¼Œ-1 ä½œä¸ºé»˜è®¤å€¼ã€‚<br />3ã€åº”å°½é‡é¿å…åœ¨ WHERE å­å¥ä¸­ä½¿ç”¨ != æˆ– <> æ“ä½œç¬¦ã€‚MySQL åªæœ‰å¯¹ä»¥ä¸‹æ“ä½œç¬¦æ‰ä½¿ç”¨ç´¢å¼•ï¼š<ï¼Œ<=ï¼Œ=ï¼Œ>ï¼Œ>=ï¼ŒBETWEENï¼ŒINï¼Œä»¥åŠæŸäº›æ—¶å€™çš„ LIKE(ç´¢å¼•æ–‡ä»¶å…·æœ‰B-Treeçš„æœ€å·¦å‰ç¼€åŒ¹é…ç‰¹æ€§)ã€‚<br />4ã€åº”å°½é‡é¿å…åœ¨ WHERE å­å¥ä¸­ä½¿ç”¨ OR æ¥è¿æ¥æ¡ä»¶ï¼Œå¦åˆ™å°†å¯¼è‡´å¼•æ“æ”¾å¼ƒä½¿ç”¨ç´¢å¼•è€Œè¿›è¡Œå…¨è¡¨æ‰«æï¼Œå¯ä»¥ä½¿ç”¨UNION åˆå¹¶æŸ¥è¯¢ã€‚\n\n- åä¾‹ï¼š\n```sql\nSELECT id FROM t WHERE num = 10 OR num = 20;\n```\n\n- æ­£ä¾‹ï¼š\n```sql\nSELECT id FROM t WHERE num = 10\nUNION ALL\nSELECT id FROM t WHERE num = 20;\n```\n5ã€IN å’Œ NOT IN ä¹Ÿè¦æ…ç”¨ï¼Œå¦åˆ™ä¼šå¯¼è‡´å…¨è¡¨æ‰«æã€‚å¯¹äºè¿ç»­çš„æ•°å€¼ï¼Œèƒ½ç”¨ BETWEEN å°±ä¸è¦ç”¨ INã€‚\n\n- åä¾‹ï¼š\n```sql\nSELECT id FROM t WHERE num IN (1, 2, 3);\n```\n\n- æ­£ä¾‹ï¼š\n```sql\nSELECT id FROM t WHERE num BETWEEN 1 AND 3;\n```\n6ã€å¦‚æœåœ¨ WHERE å­å¥ä¸­ä½¿ç”¨å‚æ•°(æŒ‡æ•°æ®åº“æš‚æ—¶æ— æ³•ç¡®å®šå…¶å€¼çš„å±€éƒ¨å˜é‡ï¼Œå¹¶ä¸æ˜¯mybatisä¸­çš„å‚æ•°)ï¼Œä¹Ÿä¼šå¯¼è‡´å…¨è¡¨æ‰«æè€Œä¸æ˜¯èµ°ç´¢å¼•ã€‚<br />7ã€åº”å°½é‡é¿å…åœ¨ WHERE å­å¥ä¸­å¯¹å­—æ®µè¿›è¡Œè¡¨è¾¾å¼æ“ä½œï¼Œåº”å°½é‡é¿å…åœ¨ WHERE å­å¥ä¸­å¯¹å­—æ®µè¿›è¡Œå‡½æ•°æ“ä½œã€‚\n\n- è¯´æ˜ï¼šWHERE å­å¥ä¸­å¯¹åˆ—çš„ä»»ä½•æ“ä½œç»“æœéƒ½æ˜¯åœ¨ SQL è¿è¡Œæ—¶é€åˆ—è®¡ç®—å¾—åˆ°çš„ï¼Œå› æ­¤å®ƒä¸å¾—ä¸è¿›è¡Œè¡¨æœç´¢ï¼Œè€Œæ²¡æœ‰ä½¿ç”¨è¯¥åˆ—ä¸Šé¢çš„ç´¢å¼•ã€‚å¦‚æœè¿™äº›ç»“æœåœ¨æŸ¥è¯¢ç¼–è¯‘æ—¶å°±èƒ½å¾—åˆ°ï¼Œé‚£ä¹ˆå°±å¯ä»¥è¢« SQL ä¼˜åŒ–å™¨ä¼˜åŒ–ï¼Œä»è€Œå¯èƒ½ä½¿ç”¨ç´¢å¼•ï¼Œè¿›è€Œé¿å…è¡¨æœç´¢ã€‚\n- åä¾‹ï¼š\n```sql\nSELECT * FROM order_master WHERE SUBSTRING(order_master_sn, 1, 4) = '2023';\nSELECT * FROM order_master WHERE payment / 2 < 500;\nSELECT * FROM f_user WHERE CONVERT(CHAR(10), birthday, 112) = '19991217'\n```\n\n- æ­£ä¾‹ï¼š\n```sql\nSELECT * FROM order_master WHERE order_master_sn LIKE '2023%'\nSELECT * FROM order_master WHERE payment < 500 * 2\nSELECT * FROM f_user WHERE birthday = '1999-12-17'\n```\n8ã€å¾ˆå¤šæ—¶å€™ç”¨ EXISTS ä»£æ›¿ IN æ˜¯ä¸€ä¸ªå¥½çš„é€‰æ‹©ï¼š`SELECT num from a WHERE num IN(SELECT num FROM b)`ã€‚ç”¨ä¸‹é¢çš„è¯­å¥æ›¿æ¢ï¼š`SELECT num FROM a WHERE EXISTS(SELECT 1 FROM b WHERE num = a.num)`ã€‚<br />9ã€å½“åœ¨ SQL è¯­å¥ä¸­è¿æ¥å¤šä¸ªè¡¨æ—¶ï¼Œå°½é‡ä¸ºè¡¨èµ·åˆ«åï¼ŒåŒæ—¶æŠŠåˆ«åå‰ç¼€äºæ¯ä¸ª Column ä¸Šï¼ˆå³`order_master.order_master_id`åœ¨å¤šè¡¨æŸ¥è¯¢æ—¶ç»™`order_master`èµ·åˆ«å`om`ï¼Œç„¶åæ›¿æ¢ä¸º`om.order_master_id`ï¼‰ã€‚è¯¥æ“ä½œå¯å‡å°‘è§£æçš„æ—¶é—´å¹¶å‡å°‘é‚£äº›ç”± Column æ­§ä¹‰å¼•èµ·çš„è¯­æ³•é”™è¯¯ã€‚<br />10ã€å°½é‡ä½¿ç”¨ â€œ>=â€ï¼Œä¸è¦ä½¿ç”¨ â€œ>â€ã€‚\n\n- è¯´æ˜ï¼šä½¿ç”¨`>=`é€»è¾‘æ›´åŠ æ¸…æ™°ã€é¿å…é—æ¼æ•°æ®ã€èƒ½å¤Ÿè½»æ¾çš„ä¿®æ”¹è¾¹ç•Œå€¼ã€å¯ä»¥æœ‰æ•ˆé¿å…è¯¯æ“ä½œã€‚\n\n11ã€é€‰æ‹©æœ€æœ‰æ•ˆç‡çš„è¡¨åé¡ºåºï¼ˆåªåœ¨åŸºäºè§„åˆ™çš„ä¼˜åŒ–å™¨ä¸­æœ‰æ•ˆï¼‰ã€‚\n\n- è¯´æ˜ï¼šOracle çš„è§£æå™¨æŒ‰ç…§ä»å³åˆ°å·¦çš„é¡ºåºå¤„ç† FROM å­å¥ä¸­çš„è¡¨åï¼ŒFROM å­å¥ä¸­å†™åœ¨æœ€åçš„è¡¨ï¼ˆåŸºç¡€è¡¨ driving tableï¼‰å°†è¢«æœ€å…ˆå¤„ç†ï¼Œåœ¨ FROM å­å¥ä¸­åŒ…å«å¤šä¸ªè¡¨çš„æƒ…å†µä¸‹ï¼Œå¿…é¡»é€‰æ‹©è®°å½•æ¡æ•°æœ€å°‘çš„è¡¨ä½œä¸ºåŸºç¡€è¡¨ã€‚\n\n12ã€å¯ä»¥é€šè¿‡å°†ä¸éœ€è¦çš„è®°å½•åœ¨ GROUP BY ä¹‹å‰è¿‡æ»¤æ‰æ¥æé«˜ GROUP BY è¯­å¥çš„æ•ˆç‡ã€‚\n\n- åä¾‹ï¼š\n```sql\nSELECT JOB, AVG(SAL) FROM EMP GROUP BY JOB HAVING JOB = 'PRESIDENT' OR JOB = 'MANAGER'\n```\n\n- æ­£ä¾‹ï¼š\n```sql\nSELECT JOB, AVG(SAL) FROM EMPWHERE JOB = 'PRESIDENT' OR JOB = 'MANAGER' GROUP BY JOB\n```\n13ã€SQL è¯­å¥ç”¨å¤§å†™ï¼Œå› ä¸ºè¾ƒå¤šä¸»æµæ•°æ®åº“æ€»æ˜¯å…ˆæŠŠå°å†™çš„å­—æ¯è½¬æ¢æˆå¤§å†™çš„å†æ‰§è¡Œã€‚<br />14ã€ä½¿ç”¨`ISNULL()` æ¥åˆ¤æ–­æ˜¯å¦ä¸ºNULLå€¼ã€‚ \n\n- è¯´æ˜ï¼šNULLä¸ä»»ä½•å€¼çš„ç›´æ¥æ¯”è¾ƒéƒ½ä¸ºNULLã€‚\n   - `NULL <> NULL`çš„è¿”å›ç»“æœæ˜¯NULLï¼Œè€Œä¸æ˜¯falseã€‚\n   - `NULL = NULL`çš„è¿”å›ç»“æœæ˜¯NULLï¼Œè€Œä¸æ˜¯trueã€‚\n   - `NULL <> 1`çš„è¿”å›ç»“æœæ˜¯NULLï¼Œè€Œä¸æ˜¯trueã€‚ \n- åä¾‹ï¼šåœ¨SQLè¯­å¥ä¸­ï¼Œå¦‚æœåœ¨NULLå‰æ¢è¡Œï¼Œå½±å“å¯è¯»æ€§ã€‚ `SELECT * FROM table WHERE column1 IS NULL AND column3 IS NOT NULL;`è€Œ`ISNULL(column)` æ˜¯ä¸€ä¸ªæ•´ä½“ï¼Œç®€æ´æ˜“æ‡‚ã€‚ä»æ€§èƒ½æ•°æ®ä¸Šåˆ†æï¼Œ`ISNULL(column)` æ‰§è¡Œæ•ˆç‡æ›´å¿«ä¸€äº›ã€‚\n\n15ã€ä»£ç ä¸­å†™åˆ†é¡µæŸ¥è¯¢é€»è¾‘æ—¶ï¼Œè‹¥countä¸º0åº”ç›´æ¥è¿”å›ï¼Œé¿å…æ‰§è¡Œåé¢çš„åˆ†é¡µè¯­å¥ã€‚<br />16ã€sql.xmlé…ç½®å‚æ•°ä½¿ç”¨ï¼š`#{}`ï¼Œ`#param#` ï¼Œä¸è¦ä½¿ç”¨ `${}` ï¼ˆæ­¤ç§æ–¹å¼å®¹æ˜“å‡ºç°SQLæ³¨å…¥ï¼‰ã€‚<br />17ã€ä¸å…è®¸ç›´æ¥æ‹¿HashMapä¸Hashtableä½œä¸ºæŸ¥è¯¢ç»“æœé›†çš„è¾“å‡ºã€‚\n\n- åä¾‹ï¼šæŸåŒå­¦ä¸ºé¿å…å†™ä¸€ä¸ª`<resultMap>xxx</resultMap>`ï¼Œç›´æ¥ä½¿ç”¨Hashtableæ¥æ¥æ”¶æ•°æ®åº“è¿”å›ç»“æœï¼Œç»“æœå‡ºç°æ—¥å¸¸æ˜¯æŠŠbigintè½¬æˆLongå€¼ï¼Œè€Œçº¿ä¸Šç”±äºæ•°æ®åº“ç‰ˆæœ¬ä¸ä¸€æ ·ï¼Œè§£ææˆBigIntegerï¼Œå¯¼è‡´çº¿ä¸Šé—®é¢˜ã€‚\n\n18ã€å½“åªè¦ä¸€è¡Œæ•°æ®æ—¶ä½¿ç”¨ LIMIT 1 ã€‚\n\n- è¯´æ˜ï¼šå½“ä½ æŸ¥è¯¢è¡¨çš„æœ‰äº›æ—¶å€™ï¼Œä½ å·²ç»çŸ¥é“ç»“æœåªä¼šæœ‰ä¸€æ¡ç»“æœï¼Œä½†å› ä¸ºä½ å¯èƒ½éœ€è¦å»fetchæ¸¸æ ‡ï¼Œæˆ–æ˜¯ä½ ä¹Ÿè®¸ä¼šå»æ£€æŸ¥è¿”å›çš„è®°å½•æ•°ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒåŠ ä¸Š LIMIT 1 å¯ä»¥å¢åŠ æ€§èƒ½ã€‚è¿™æ ·ä¸€æ¥ï¼ŒMySQL æ•°æ®åº“å¼•æ“ä¼šåœ¨æ‰¾åˆ°ä¸€æ¡æ•°æ®ååœæ­¢æœç´¢ï¼Œè€Œä¸æ˜¯ç»§ç»­å¾€åæŸ¥æ‰¾ä¸‹ä¸€æ¡ç¬¦åˆè®°å½•çš„æ•°æ®ã€‚\n\n19ã€ä½¿ç”¨å­æŸ¥è¯¢ä¼˜åŒ–å¤§åˆ†é¡µæŸ¥è¯¢\n\n- è¯´æ˜ï¼šè¿™ç§ä¼˜åŒ–æ–¹å¼åªä½¿ç”¨ä¸`id`æ˜¯æ­£åºçš„æƒ…å†µã€‚\n- åä¾‹ï¼š\n```sql\nSELECT score, name FROM student ORDER BY score DESC LIMIT 1000000, 10;\n```\n\n- æ­£ä¾‹ï¼š\n```sql\nSELECT score, name FROM student\nWHERE id >= (SELECT id FROM student LIMIT 1000000, 1)\nORDER BY score\nLIMIT 10;\n```\n<a name=\"ax9ds\"></a>\n\n# äºŒã€ç´¢å¼•\n1ã€ä¸šåŠ¡ä¸Šå…·æœ‰å”¯ä¸€ç‰¹æ€§çš„å­—æ®µï¼Œå³ä½¿æ˜¯ç»„åˆå­—æ®µï¼Œä¹Ÿå¿…é¡»å»ºæˆå”¯ä¸€ç´¢å¼•ã€‚\n\n- è¯´æ˜ï¼šä¸è¦ä»¥ä¸ºå”¯ä¸€ç´¢å¼•å½±å“äº†inserté€Ÿåº¦ï¼Œè¿™ä¸ªé€Ÿåº¦æŸè€—å¯ä»¥å¿½ç•¥ï¼Œä½†æé«˜æŸ¥æ‰¾é€Ÿåº¦æ˜¯æ˜æ˜¾çš„ï¼›å¦å¤–ï¼Œå³ä½¿åœ¨åº”ç”¨å±‚åšäº†éå¸¸å®Œå–„çš„æ ¡éªŒæ§åˆ¶ï¼Œåªè¦æ²¡æœ‰å”¯ä¸€ç´¢å¼•ï¼Œæ ¹æ®å¢¨è²å®šå¾‹ï¼Œå¿…ç„¶æœ‰è„æ•°æ®äº§ç”Ÿã€‚\n\n2ã€è¶…è¿‡ä¸‰ä¸ªè¡¨ç¦æ­¢joinã€‚éœ€è¦joinçš„å­—æ®µï¼Œæ•°æ®ç±»å‹ä¿æŒç»å¯¹ä¸€è‡´ï¼›å¤šè¡¨å…³è”æŸ¥è¯¢æ—¶ï¼Œä¿è¯è¢«å…³è”çš„å­—æ®µéœ€è¦æœ‰ç´¢å¼•ã€‚\n\n- è¯´æ˜ï¼šå³ä½¿åŒè¡¨joinä¹Ÿè¦æ³¨æ„è¡¨ç´¢å¼•ã€SQLæ€§èƒ½ã€‚\n\n3ã€ç´¢å¼•çš„ä½¿ç”¨è§„èŒƒï¼š\n\n- ç´¢å¼•çš„åˆ›å»ºè¦ä¸åº”ç”¨ç»“åˆè€ƒè™‘ï¼Œä¸”ä¸€ä¸ªè¡¨å°½é‡ä¸è¦è¶…è¿‡ 6 ä¸ªç´¢å¼•ï¼›\n- å°½å¯èƒ½çš„ä½¿ç”¨ç´¢å¼•å­—æ®µä½œä¸ºæŸ¥è¯¢æ¡ä»¶ï¼Œå°¤å…¶æ˜¯èšç°‡ç´¢å¼•ï¼Œå¿…è¦æ—¶å¯ä»¥é€šè¿‡ index index_name æ¥å¼ºåˆ¶æŒ‡å®šç´¢å¼•ï¼›\n- åœ¨ä½¿ç”¨ç´¢å¼•å­—æ®µä½œä¸ºæ¡ä»¶æ—¶ï¼Œå¦‚æœè¯¥ç´¢å¼•æ˜¯è”åˆç´¢å¼•ï¼Œé‚£ä¹ˆå¿…é¡»ä½¿ç”¨åˆ°è¯¥ç´¢å¼•ä¸­çš„ç¬¬ä¸€ä¸ªå­—æ®µä½œä¸ºæ¡ä»¶æ—¶æ‰èƒ½ä¿è¯ç³»ç»Ÿä½¿ç”¨è¯¥ç´¢å¼•ï¼Œå¦åˆ™è¯¥ç´¢å¼•å°†ä¸ä¼šè¢«ä½¿ç”¨ï¼›\n- è¦æ³¨æ„ç´¢å¼•çš„ç»´æŠ¤ï¼Œå‘¨æœŸæ€§é‡å»ºç´¢å¼•ï¼Œé‡æ–°ç¼–è¯‘å­˜å‚¨è¿‡ç¨‹ï¼›\n- åœ¨varcharå­—æ®µä¸Šå»ºç«‹ç´¢å¼•æ—¶ï¼Œå¿…é¡»æŒ‡å®šç´¢å¼•é•¿åº¦ï¼Œæ²¡å¿…è¦å¯¹å…¨å­—æ®µå»ºç«‹ç´¢å¼•ï¼Œæ ¹æ®å®é™…æ–‡æœ¬åŒºåˆ†åº¦å†³å®šç´¢å¼•é•¿åº¦ã€‚ä¾‹å¦‚å¯¹è¯¥å­—æ®µçš„å‰20ä¸ªå­—ç¬¦å»ºç«‹ç´¢å¼•ï¼ˆ`ALTER table user ADD INDEX idx_desc(desc(20));`ï¼‰ï¼›\n- å¦‚æœéœ€è¦ä½¿ç”¨ç´¢å¼•ï¼Œä¸è¦ä½¿ç”¨uuidä½œä¸ºä¸»é”®ï¼Œä¸èƒ½ä¿è¯å…¶è‡ªå¢æ€§ï¼Œä¼šå¯¼è‡´æ•°æ®åº“å¯¹B+æ ‘çš„æ“ä½œæ›´å¤æ‚ã€‚\n\n4ã€åº”å°½å¯èƒ½çš„é¿å…æ›´æ–° Clustered ç´¢å¼•æ•°æ®åˆ—ï¼Œ å› ä¸º Clustered ç´¢å¼•æ•°æ®åˆ—çš„é¡ºåºå°±æ˜¯è¡¨è®°å½•çš„ç‰©ç†å­˜å‚¨é¡ºåºï¼Œä¸€æ—¦è¯¥åˆ—å€¼æ”¹å˜å°†å¯¼è‡´æ•´ä¸ªè¡¨è®°å½•çš„é¡ºåºçš„è°ƒæ•´ï¼Œä¼šè€—è´¹ç›¸å½“å¤§çš„èµ„æºã€‚è‹¥åº”ç”¨ç³»ç»Ÿéœ€è¦é¢‘ç¹æ›´æ–° Clustered ç´¢å¼•æ•°æ®åˆ—ï¼Œé‚£ä¹ˆéœ€è¦è€ƒè™‘æ˜¯å¦åº”å°†è¯¥ç´¢å¼•å»ºä¸º Clustered ç´¢å¼•ã€‚\n\n- è¯´æ˜ï¼šèšé›†ç´¢å¼•ï¼ˆClustered Indexï¼‰æ˜¯ä¸€ç§SQLæ•°æ®åº“ä¸­çš„ç´¢å¼•ç±»å‹ï¼Œå®ƒå¯¹è¡¨ä¸­çš„æ•°æ®è¡Œè¿›è¡Œç‰©ç†æ’åºã€‚æ¯ä¸ªè¡¨åªèƒ½æœ‰ä¸€ä¸ªèšé›†ç´¢å¼•ï¼Œå› ä¸ºå®ƒå†³å®šäº†æ•°æ®è¡Œåœ¨ç£ç›˜ä¸Šçš„ç‰©ç†å­˜å‚¨é¡ºåºã€‚è¿™ä¹Ÿæ„å‘³ç€è¡¨ä¸­çš„æ•°æ®è¡ŒæŒ‰ç…§èšé›†ç´¢å¼•çš„é”®åˆ—çš„å€¼è¿›è¡Œæ’åºï¼Œå¹¶ä¸”ç‰©ç†å­˜å‚¨ä½ç½®ä¸ç´¢å¼•çš„ç»“æ„ç´§å¯†å…³è”ã€‚\n<a name=\"mlW4c\"></a>\n# ä¸‰ã€æ•°æ®åº“è¡¨çš„è®¾è®¡\n1ã€åªå«æ•°å€¼ä¿¡æ¯çš„å­—æ®µå°½é‡ä¸è¦è®¾è®¡ä¸ºå­—ç¬¦å‹ï¼Œè¿™ä¼šé™ä½æŸ¥è¯¢å’Œè¿æ¥çš„æ€§èƒ½ï¼Œå¹¶ä¼šå¢åŠ å­˜å‚¨å¼€é”€ã€‚<br />2ã€å°½å¯èƒ½çš„ä½¿ç”¨ varchar, nvarchar ä»£æ›¿ char, ncharã€‚\n\n- è¯´æ˜ï¼šé¦–å…ˆï¼Œå˜é•¿å­—æ®µå­˜å‚¨ç©ºé—´å°ï¼Œå¯ä»¥èŠ‚çœå­˜å‚¨ç©ºé—´ï¼›å…¶æ¬¡ï¼Œå¯¹äºæŸ¥è¯¢æ¥è¯´ï¼Œåœ¨ä¸€ä¸ªç›¸å¯¹è¾ƒå°çš„å­—æ®µå†…æœç´¢æ•ˆç‡ä¼šæ›´é«˜ã€‚\n\n3ã€è¡¨è¾¾æ˜¯ä¸å¦æ¦‚å¿µçš„å­—æ®µï¼Œå¿…é¡»ä½¿ç”¨is_xxxçš„æ–¹å¼å‘½åï¼Œæ•°æ®ç±»å‹æ˜¯unsigned tinyintï¼ˆ1è¡¨ç¤ºæ˜¯ï¼Œ0è¡¨ç¤ºå¦ï¼‰ã€‚\n\n- è¯´æ˜ï¼šä»»ä½•å­—æ®µå¦‚æœä¸ºéè´Ÿæ•°ï¼Œå¿…é¡»æ˜¯unsignedã€‚\n- æ­£ä¾‹ï¼šè¡¨è¾¾é€»è¾‘åˆ é™¤çš„å­—æ®µåis_deletedï¼Œ1è¡¨ç¤ºåˆ é™¤ï¼Œ0è¡¨ç¤ºæœªåˆ é™¤ã€‚\n\n4ã€varcharæ˜¯å¯å˜é•¿å­—ç¬¦ä¸²ï¼Œä¸é¢„å…ˆåˆ†é…å­˜å‚¨ç©ºé—´ï¼Œé•¿åº¦ä¸è¦è¶…è¿‡5000ï¼Œå¦‚æœå­˜å‚¨é•¿åº¦å¤§äºæ­¤å€¼ï¼Œå®šä¹‰å­—æ®µç±»å‹ä¸ºtextï¼Œç‹¬ç«‹å‡ºæ¥ä¸€å¼ è¡¨ï¼Œç”¨ä¸»é”®æ¥å¯¹åº”ï¼Œé¿å…å½±å“å…¶å®ƒå­—æ®µç´¢å¼•ç‡ã€‚<br />5ã€åœ¨æ•°æ®åº“ä¸­ä¸èƒ½ä½¿ç”¨ç‰©ç†åˆ é™¤æ“ä½œï¼Œè¦ä½¿ç”¨é€»è¾‘åˆ é™¤ã€‚\n\n- è¯´æ˜ï¼šé€»è¾‘åˆ é™¤åœ¨æ•°æ®åˆ é™¤åå¯ä»¥è¿½æº¯åˆ°è¡Œä¸ºæ“ä½œã€‚ä¸è¿‡ä¼šä½¿å¾—ä¸€äº›æƒ…å†µä¸‹çš„å”¯ä¸€ä¸»é”®å˜å¾—ä¸å”¯ä¸€ï¼Œéœ€è¦æ ¹æ®æƒ…å†µæ¥é…Œæƒ…è§£å†³ã€‚\n<a name=\"w5T7q\"></a>\n","categories":["æ•°æ®åº“"]},{"title":"RabbitMQç¬”è®°","url":"/2023/07/28/RabbitMQç¬”è®°/","content":"\n<a name=\"hIdmQ\"></a>\n\n# åˆè¯†MQ\n\n<a name=\"s1n7e\"></a>\n\n## åŒæ­¥è°ƒç”¨\n\nç›®å‰ï¼Œæˆ‘ä»¬çš„å¤§å¤šæ•°ä¸šåŠ¡æ˜¯åŸºäºOpenFeignè°ƒç”¨ï¼Œå±äºåŒæ­¥è°ƒç”¨ã€‚é€šè¿‡ä¸€ä¸ªä¾‹å­åˆ†æä»€ä¹ˆæ˜¯åŒæ­¥è°ƒç”¨ï¼Œä»¥åŠåŒæ­¥è°ƒç”¨åœ¨è¯¥ç±»åœºæ™¯ä¸‹çš„ç¼ºé™·ã€‚<br />ç°åœ¨å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç”¨æˆ·ä¸‹å•åŠŸèƒ½ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨åŒæ­¥è°ƒç”¨ï¼Œåˆ™ä¸šåŠ¡é€»è¾‘å¤§è‡´å¯åˆ†ä¸ºï¼š\n\n- æ”¯ä»˜æœåŠ¡éœ€è¦å…ˆè°ƒç”¨ç”¨æˆ·æœåŠ¡å®Œæˆä½™é¢æ‰£å‡\n- ç„¶åæ”¯ä»˜æœåŠ¡è‡ªå·±è¦æ›´æ–°æ”¯ä»˜æµæ°´å•çš„çŠ¶æ€\n- ç„¶åæ”¯ä»˜æœåŠ¡è°ƒç”¨äº¤æ˜“æœåŠ¡ï¼Œæ›´æ–°ä¸šåŠ¡è®¢å•çŠ¶æ€ä¸ºå·²æ”¯ä»˜\n\n![1.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_42ef07e728-1.png) <br />**ä»ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œè‡³å°‘å­˜åœ¨3ä¸ªé—®é¢˜ï¼š**<br />**æ‹“å±•æ€§å·®ï¼š**<br />å½“å‰ä¸šåŠ¡é€»è¾‘ç®€å•ï¼Œä½†æ˜¯éšç€ä¸šåŠ¡è§„æ¨¡çš„æ‰©å±•ï¼Œäº§å“çš„åŠŸèƒ½ä¹Ÿéœ€è¦ä¸æ–­æ‰©å±•ï¼Œéšä¹‹è€Œæ¥çš„å°±æ˜¯æ”¯ä»˜ä¸šåŠ¡å˜å¾—ååˆ†è‡ƒè‚¿ã€‚<br />ä¾‹å¦‚åœ¨å½“å‰ä¸šåŠ¡åŸºç¡€ä¸Šå¢åŠ çŸ­ä¿¡é€šçŸ¥åŠŸèƒ½ã€ä¸‹å•å¥–åŠ±ç§¯åˆ†åŠŸèƒ½ç­‰ç­‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„ä¸šåŠ¡å°†ä¼šç¼–ç¨‹è¿™æ ·ï¼š<br />![2.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_466ebbdb28-2.png) <br />æ‰€ä»¥ï¼Œå½“æˆ‘ä»¬ä¸šåŠ¡é€»è¾‘å¯èƒ½ä¼šæœ‰è¾ƒå¤šæ‰©å±•çš„æ—¶å€™ï¼ŒåŒæ­¥è°ƒç”¨ä¼šå¯¼è‡´ä»£ç å¤§é‡é«˜é¢‘æ”¹åŠ¨ï¼Œè¿åäº†å¼€é—­åŸåˆ™ã€‚<br />**æ€§èƒ½é™ä½ï¼š**<br />åŒæ­¥è°ƒç”¨æ˜¯é˜»å¡å¼çš„ï¼Œè°ƒç”¨è€…éœ€è¦ç­‰å¾…å½“å‰è°ƒç”¨æœåŠ¡æ‰§è¡Œå®Œæˆåæ‰ä¼šç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œé‚£ä¹ˆæœ€ç»ˆæ•´ä¸ªä¸šåŠ¡çš„æ—¶é—´å°±æ˜¯è¿™äº›è°ƒç”¨è¿‡ç¨‹ä¹‹å’Œï¼Œä¹Ÿå°±ä¼šç¼–ç¨‹è¿™æ ·ï¼š<br />![3.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_493f9e0528-3.png) <br />æˆ‘ä»¬å‡è®¾æ¯ä¸€ä¸ªå¾®æœåŠ¡çš„è°ƒç”¨æ—¶é—´ä¸º50msï¼Œé‚£ä¹ˆæœ€ç»ˆæ•´ä¸ªä¸šåŠ¡å°†è€—æ—¶300msï¼Œæ€§èƒ½æä½ï¼<br />**çº§è”å¤±è´¥ï¼š**<br />ç”±äºæˆ‘ä»¬çš„æ¯ä¸€æ¬¡è°ƒç”¨éƒ½æ˜¯ä¸²è”çš„ï¼Œè¿™å°±æ„å‘³ç€ä¸€æ—¦æŸä¸€ä¸ªæœåŠ¡å‡ºç°æ•…éšœï¼Œé‚£ä¹ˆæ•´ä¸ªäº‹åŠ¡å°†è¿›è¡Œå›æ»šï¼Œæœ€ç»ˆå¯¼è‡´äº¤æ˜“å¤±è´¥~~ï¼Œè®©å…¬å¸äº§ç”ŸæŸå¤±ï¼Œå¯¼è‡´è¢«å¼€é™¤~~ã€‚<br />ä½†å®é™…ä¸Šåœ¨æˆ‘ä»¬çš„ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬çœŸçš„éœ€è¦è¿™æ ·ä¸²è¡Œçš„æ‰§è¡Œå—ï¼Ÿ<br />æˆ‘ä»¬ä¸€æ—¦æ‰£æ¬¾æˆåŠŸï¼Œåé¢çš„ä¸€ç³»åˆ—äº‹æƒ…å°±å¯ä»¥è‡ªå·±æ…¢æ…¢å»å¤„ç†ã€‚æˆ‘ä»¬åªéœ€è¦ç¡®ä¿æ”¯ä»˜æµæ°´å•æ›´æ–°æˆåŠŸï¼Œç¡®ä¿äº¤æ˜“å®Œæˆ~~ï¼Œé’±éƒ½åˆ°æ‰‹äº†ï¼Œåˆ›å»ºè®¢å•é‚£äº›äº‹æ…¢æ…¢åšå˜›ï¼Œä¿è¯å…¬å¸åˆ©ç›Šè‡³ä¸Šï¼Œå¾—åˆ°é¢†å¯¼é‡ç”¨ï¼Œä¸€è·¯å‡èŒåŠ è–ª~~ã€‚\n\nç”±äºä»¥ä¸Šå‡ ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬çš„è°ƒç”¨å¿…é¡»è°ƒæ•´ï¼Œåˆ©ç”¨**å¼‚æ­¥è°ƒç”¨**æ›¿ä»£**åŒæ­¥è°ƒç”¨**ã€‚\n<a name=\"D1wMU\"></a>\n\n## å¼‚æ­¥è°ƒç”¨\n\næ‰€è°“çš„å¼‚æ­¥è°ƒç”¨æ–¹å¼å…¶å®å°±æ˜¯åŸºäºæ¶ˆæ¯é€šçŸ¥çš„æ–¹å¼ï¼Œä¸€èˆ¬åŒ…å«ä¸‰ä¸ªè§’è‰²ï¼š\n\n- æ¶ˆæ¯å‘é€è€…ï¼šæŠ•é€’æ¶ˆæ¯çš„äººï¼Œå°±æ˜¯åŸæ¥çš„è°ƒç”¨æ–¹\n- æ¶ˆæ¯Brokerï¼šç®¡ç†ã€æš‚å­˜ã€è½¬å‘æ¶ˆæ¯\n- æ¶ˆæ¯æ¥æ”¶è€…ï¼šæ¥æ”¶å’Œå¤„ç†æ¶ˆæ¯çš„äººï¼Œå°±æ˜¯åŸæ¥çš„æœåŠ¡æä¾›æ–¹\n\n![4.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_4b28137f28-4.png) <br />åœ¨å¼‚æ­¥è°ƒç”¨ä¸­ï¼Œå‘é€è€…ä¸å†ç›´æ¥åŒæ­¥è°ƒç”¨æ¥æ”¶è€…çš„ä¸šåŠ¡æ¥å£ï¼Œè€Œæ˜¯å‘é€ä¸€æ¡æ¶ˆæ¯æŠ•é€’ç»™æ¶ˆæ¯Brokerã€‚ç„¶åæ¥æ”¶è€…æ ¹æ®è‡ªå·±çš„éœ€æ±‚ä»æ¶ˆæ¯Brokeré‚£é‡Œè®¢é˜…æ¶ˆæ¯ã€‚æ¯å½“å‘é€æ–¹å‘é€æ¶ˆæ¯åï¼Œæ¥å—è€…éƒ½èƒ½è·å–æ¶ˆæ¯å¹¶å¤„ç†ã€‚<br />è¿™æ ·ï¼Œå‘é€æ¶ˆæ¯çš„äººå’Œæ¥æ”¶æ¶ˆæ¯çš„äººå°±å®Œå…¨**è§£è€¦**äº†ã€‚<br />**æˆ‘ä»¬è¿˜æ˜¯ä»¥ä¸‹å•ä¸šåŠ¡ä¸ºä¾‹è®²è§£å¼‚æ­¥è°ƒç”¨çš„ä¼˜åŠ¿ã€‚**<br />é™¤äº†æ‰£å‡ä½™é¢ã€æ›´æ–°æ”¯ä»˜æµæ°´å•çŠ¶æ€ä»¥å¤–ï¼Œå…¶å®ƒè°ƒç”¨é€»è¾‘å…¨éƒ¨å–æ¶ˆã€‚è€Œæ˜¯æ”¹ä¸ºå‘é€ä¸€æ¡æ¶ˆæ¯åˆ°Brokerã€‚è€Œç›¸å…³çš„å¾®æœåŠ¡éƒ½å¯ä»¥è®¢é˜…æ¶ˆæ¯é€šçŸ¥ï¼Œä¸€æ—¦æ¶ˆæ¯åˆ°è¾¾Brokerï¼Œåˆ™ä¼šåˆ†å‘ç»™æ¯ä¸€ä¸ªè®¢é˜…äº†çš„å¾®æœåŠ¡ï¼Œå¤„ç†å„è‡ªçš„ä¸šåŠ¡ã€‚<br />![5.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_4e2cfc1828-5.png) <br />å†ä»åˆšåˆšçš„ç¤ºä¾‹çœ‹ï¼Œå‡è®¾ç°åœ¨äº§å“ç»ç†å¢åŠ äº†ä¸‹å•é€ç§¯åˆ†çš„åŠŸèƒ½ï¼Œé‚£ä¹ˆæ”¯ä»˜éƒ¨åˆ†çš„ä»£ç å®Œå…¨ä¸éœ€è¦å˜åŠ¨ï¼Œè€Œæ˜¯æ–°å¢ä¸€ä¸ªç§¯åˆ†æœåŠ¡ï¼ŒåŒæ—¶è®©ç§¯åˆ†æœåŠ¡è®¢é˜…æ¶ˆæ¯å³å¯ï¼š<br />![6.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_50b5ce1a28-6.png) <br />ä»è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åˆ†æå‡ºï¼Œä¸ç®¡åæœŸå¢åŠ äº†å¤šå°‘æ¶ˆæ¯è®¢é˜…è€…ï¼Œä½œä¸ºæ”¯ä»˜æœåŠ¡æ¥è®²ï¼Œæ‰§è¡Œé—®æ‰£å‡ä½™é¢ã€æ›´æ–°æ”¯ä»˜æµæ°´çŠ¶æ€åï¼Œå‘é€æ¶ˆæ¯å³å¯ã€‚ä¸šåŠ¡è€—æ—¶ä»…ä»…æ˜¯è¿™ä¸‰éƒ¨åˆ†ä¸šåŠ¡è€—æ—¶ï¼Œä»…ä»…100msï¼Œå¤§å¤§æé«˜äº†ä¸šåŠ¡æ€§èƒ½ã€‚<br />å¹¶ä¸”ï¼Œä¸ç®¡æ˜¯äº¤æ˜“æœåŠ¡ã€é€šçŸ¥æœåŠ¡ï¼Œè¿˜æ˜¯ç§¯åˆ†æœåŠ¡ï¼Œä»–ä»¬çš„ä¸šåŠ¡ä¸æ”¯ä»˜å…³è”åº¦ä½ã€‚ç°åœ¨é‡‡ç”¨äº†å¼‚æ­¥è°ƒç”¨ï¼Œä»–ä»¬å³ä¾¿æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°äº†æ•…éšœï¼Œä¹Ÿä¸ä¼šå½±å“åˆ°æ”¯ä»˜æœåŠ¡ï¼Œå¤§å¤§é™ä½ä¸šåŠ¡é—´çš„è€¦åˆã€‚<br />æ‰€ä»¥ï¼Œå¼‚æ­¥è°ƒç”¨çš„ä¼˜åŠ¿å¯ä»¥æ¦‚æ‹¬ä¸ºï¼š\n\n- åˆåº¦æ›´ä½\n- æ€§èƒ½æ›´å¥½\n- ä¸šåŠ¡æ‹“å±•æ€§å¼º\n- æ•…éšœéš”ç¦»ï¼Œé¿å…çº§è”å¤±è´¥\n\nå½“ç„¶äº†ï¼Œå¼‚æ­¥é€šä¿¡ä¹Ÿå¹¶éå®Œç¾æ— ç¼ºï¼Œä¹Ÿä¼šæœ‰ä¸è¶³ä¹‹å¤„ï¼ˆæ¯•ç«Ÿç¼ºç‚¹ä¹Ÿæ˜¯ä¼˜ç‚¹çš„è¡ç”Ÿç‰©ï¼‰ï¼š\n\n- å®Œå…¨ä¾èµ–äºBrokerçš„å¯é æ€§ã€å®‰å…¨æ€§å’Œæ€§èƒ½\n- æ¶æ„æ›´åŠ å¤æ‚ï¼ŒåæœŸç»´æŠ¤å’Œè°ƒè¯•éº»çƒ¦\n  <a name=\"LVBF1\"></a>\n\n## æŠ€æœ¯é€‰å‹\n\næ‰€è°“æŠ€æœ¯é€‰å‹ï¼Œå…¶å®å°±æ˜¯ç»“åˆå½“å‰ä¸šåŠ¡æ¨ªå‘å¯¹æ¯”å½“å‰ä¸»æµçš„æŠ€æœ¯ï¼Œé€‰æ‹©æœ€ä¸ºåˆé€‚çš„æŠ€æœ¯ã€‚<br />ç›®å‰ä¸»æµçš„MQæœ‰ï¼š\n\n- RabbitMQ\n- ActiveMQ\n- RocketMQ\n- Kafka\n\n![7.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_523cdcbc28-7.png)\n\n- **è¿½æ±‚å¯ç”¨æ€§ï¼š** Kafkaã€ RocketMQ ã€**RabbitMQ**\n- **è¿½æ±‚å¯é æ€§ï¼šRabbitMQ**ã€RocketMQ\n- **è¿½æ±‚ååèƒ½åŠ›ï¼š** RocketMQã€Kafka\n- **è¿½æ±‚æ¶ˆæ¯ä½å»¶è¿Ÿï¼šRabbitMQ**ã€Kafka\n\næ®ç»Ÿè®¡ï¼Œç›®å‰å›½å†…æ¶ˆæ¯é˜Ÿåˆ—ä½¿ç”¨æœ€å¤šçš„è¿˜æ˜¯RabbitMQï¼Œå†åŠ ä¸Šå…¶å„æ–¹é¢éƒ½æ¯”è¾ƒå‡è¡¡ï¼Œç¨³å®šæ€§ä¹Ÿå¥½ï¼Œæ‰€ä»¥åœ¨æ­¤å­¦ä¹ RabbitMQã€‚\n<a name=\"eLkEB\"></a>\n\n# RabbitMQ\n\n**RabbitMQ**æ˜¯å®ç°äº†é«˜çº§[æ¶ˆæ¯é˜Ÿåˆ—](https://baike.baidu.com/item/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/4751675?fromModule=lemma_inlink)åè®®ï¼ˆ[AMQP](https://baike.baidu.com/item/AMQP/8354716?fromModule=lemma_inlink)ï¼‰çš„å¼€æºæ¶ˆæ¯ä»£ç†è½¯ä»¶ï¼ˆäº¦ç§°é¢å‘æ¶ˆæ¯çš„[ä¸­é—´ä»¶](https://baike.baidu.com/item/%E4%B8%AD%E9%97%B4%E4%BB%B6/452240?fromModule=lemma_inlink)ï¼‰ã€‚RabbitMQæœåŠ¡å™¨æ˜¯ç”¨[Erlang](https://baike.baidu.com/item/Erlang/0?fromModule=lemma_inlink)è¯­è¨€ï¼ˆé¢å‘å¹¶å‘çš„è¯­è¨€ï¼‰ç¼–å†™çš„ï¼Œè€Œé›†ç¾¤å’Œ[æ•…éšœè½¬ç§»](https://baike.baidu.com/item/%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB/14768924?fromModule=lemma_inlink)æ˜¯æ„å»ºåœ¨[å¼€æ”¾ç”µä¿¡å¹³å°](https://baike.baidu.com/item/%E5%BC%80%E6%94%BE%E7%94%B5%E4%BF%A1%E5%B9%B3%E5%8F%B0/15696499?fromModule=lemma_inlink)æ¡†æ¶ä¸Šçš„ã€‚<br />RabbitMQå¯¹åº”çš„æ¶æ„å¦‚å›¾æ‰€ç¤ºï¼š<br />![8.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_54b348be28-8.png) <br />å…¶ä¸­åŒ…å«å‡ ä¸ªæ¦‚å¿µï¼š\n\n- **publisher**ï¼šç”Ÿäº§è€…ï¼Œä¹Ÿå°±æ˜¯å‘é€æ¶ˆæ¯çš„ä¸€æ–¹\n- **consumer**ï¼šæ¶ˆè´¹è€…ï¼Œä¹Ÿå°±æ˜¯æ¶ˆè´¹æ¶ˆæ¯çš„ä¸€æ–¹\n- **queue**ï¼šé˜Ÿåˆ—ï¼Œå­˜å‚¨æ¶ˆæ¯ã€‚ç”Ÿäº§è€…æŠ•é€’çš„æ¶ˆæ¯ä¼šæš‚å­˜åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…æ¶ˆè´¹è€…å¤„ç†\n- **exchange**ï¼šäº¤æ¢æœºï¼Œè´Ÿè´£æ¶ˆæ¯è·¯ç”±ã€‚ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ç”±äº¤æ¢æœºå†³å®šæŠ•é€’åˆ°å“ªä¸ªé˜Ÿåˆ—ã€‚\n- **virtual host**ï¼šè™šæ‹Ÿä¸»æœºï¼Œèµ·åˆ°æ•°æ®éš”ç¦»çš„ä½œç”¨ã€‚æ¯ä¸ªè™šæ‹Ÿä¸»æœºç›¸äº’ç‹¬ç«‹ï¼Œæœ‰å„è‡ªçš„exchangeã€queue\n\nä»¥ä¸Šè¿™å‡ ä¸ªéƒ¨åˆ†å‡å¯åœ¨RabbitMQå®˜æ–¹æä¾›çš„æ§åˆ¶å°è¿›è¡Œç®¡ç†ã€‚\n<a name=\"GdDuN\"></a>\n\n## æ”¶å‘æ¶ˆæ¯\n\n<a name=\"R8A9Z\"></a>\n\n### äº¤æ¢æœº\n\næˆ‘ä»¬æ‰“å¼€Exchangesé€‰é¡¹å¡ï¼Œå¯ä»¥çœ‹åˆ°å·²ç»å­˜åœ¨å¾ˆå¤šäº¤æ¢æœºï¼š<br />![9.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_58025bcc28-9.png) <br />æˆ‘ä»¬ç‚¹å‡»ä»»æ„äº¤æ¢æœºï¼Œå³å¯è¿›å…¥äº¤æ¢æœºè¯¦æƒ…é¡µé¢ã€‚ä»ç„¶ä¼šåˆ©ç”¨æ§åˆ¶å°ä¸­çš„publish message å‘é€ä¸€æ¡æ¶ˆæ¯ï¼š<br />![10.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_5a131b4d28-10.png) <br />![11.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_5cb504b128-11.png) <br />è¿™é‡Œæ˜¯ç”±æ§åˆ¶å°æ¨¡æ‹Ÿäº†ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ã€‚ç”±äºæ²¡æœ‰æ¶ˆè´¹è€…å­˜åœ¨ï¼Œæœ€ç»ˆæ¶ˆæ¯ä¸¢å¤±äº†ï¼Œè¿™æ ·è¯´æ˜äº¤æ¢æœºæ²¡æœ‰å­˜å‚¨æ¶ˆæ¯çš„èƒ½åŠ›ã€‚\n<a name=\"LOeg6\"></a>\n\n### é˜Ÿåˆ—\n\næˆ‘ä»¬æ‰“å¼€Queuesé€‰é¡¹å¡ï¼Œæ–°å»ºä¸€ä¸ªé˜Ÿåˆ—ï¼š<br />![12.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_5eb37a6528-12.png) <br />å‘½åä¸º`hello.queue1`ï¼š<br />![13.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_65bbc2ee28-13.png) <br />å†ä»¥ç›¸åŒçš„æ–¹å¼ï¼Œåˆ›å»ºä¸€ä¸ªé˜Ÿåˆ—ï¼Œå‘½åä¸º`hello.queue2`ï¼Œæœ€ç»ˆé˜Ÿåˆ—åˆ—è¡¨å¦‚ä¸‹ï¼š<br />![14.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_6c977b3a28-14.png) <br />æ­¤æ—¶ï¼Œæˆ‘ä»¬å†æ¬¡å‘amq.fanoutäº¤æ¢æœºå‘é€ä¸€æ¡æ¶ˆæ¯ã€‚ä¼šå‘ç°æ¶ˆæ¯ä¾ç„¶æ²¡æœ‰åˆ°è¾¾é˜Ÿåˆ—ã€‚<br />æ€ä¹ˆå›äº‹å‘¢ï¼Ÿ<br />å‘é€åˆ°äº¤æ¢æœºçš„æ¶ˆæ¯ï¼Œåªä¼šè·¯ç”±åˆ°ä¸å…¶ç»‘å®šçš„é˜Ÿåˆ—ï¼Œå› æ­¤ä»…ä»…åˆ›å»ºé˜Ÿåˆ—æ˜¯ä¸å¤Ÿçš„ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å°†å…¶ä¸äº¤æ¢æœºç»‘å®šã€‚\n<a name=\"mAqhz\"></a>\n\n### äº¤æ¢æœº-é˜Ÿåˆ—ï¼ˆç»‘å®šå…³ç³»ï¼‰\n\nç‚¹å‡»`Exchanges`é€‰é¡¹å¡ï¼Œç‚¹å‡»`amq.fanout`äº¤æ¢æœºï¼Œè¿›å…¥äº¤æ¢æœºè¯¦æƒ…é¡µï¼Œç„¶åç‚¹å‡»`Bindings`èœå•ï¼Œåœ¨è¡¨å•ä¸­å¡«å†™è¦ç»‘å®šçš„é˜Ÿåˆ—åç§°ï¼š<br />![15.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_707da2ea28-15.png) <br />ç›¸åŒçš„æ–¹å¼ï¼Œå°†`hello.queue2`ä¹Ÿç»‘å®šåˆ°æ”¹äº¤æ¢æœºã€‚<br />æœ€ç»ˆï¼Œç»‘å®šç»“æœå¦‚ä¸‹ï¼š<br />![16.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_72e831e728-16.png)\n<a name=\"JP8mG\"></a>\n\n### å‘é€æ¶ˆæ¯\n\nå†æ¬¡å›åˆ°`exchange`é¡µé¢ï¼Œæ‰¾åˆ°åˆšåˆšç»‘å®šçš„`amq.fanout`ï¼Œç‚¹å‡»è¿›å…¥è¯¦æƒ…é¡µï¼Œå†æ¬¡å‘é€ä¸€æ¡æ¶ˆæ¯ï¼š<br />![17.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_74f1f6ce28-17.png) <br />å›åˆ°`Queues`é¡µé¢ï¼Œå¯ä»¥å‘ç°`hello.queue`ä¸­å·²ç»æœ‰ä¸€æ¡æ¶ˆæ¯äº†ï¼š<br />![18.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_777a405528-18.png) <br />ç‚¹å‡»é˜Ÿåˆ—åç§°ï¼Œè¿›å…¥è¯¦æƒ…é¡µï¼ŒæŸ¥çœ‹é˜Ÿåˆ—è¯¦æƒ…ï¼Œè¿™æ¬¡æˆ‘ä»¬ç‚¹å‡»`get message`ï¼š<br />![19.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_863e3ecd28-19.png) <br />å¯ä»¥çœ‹åˆ°æ¶ˆæ¯åˆ°è¾¾é˜Ÿåˆ—äº†ï¼š<br />![20.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_88c1b67e28-20.png)<br />è¿™ä¸ªæ—¶å€™å¦‚æœæœ‰æ¶ˆè´¹è€…ç›‘å¬äº†MQçš„`hello.queue1`æˆ–`hello.queue2`é˜Ÿåˆ—ï¼Œå°±èƒ½æ¥æ”¶åˆ°æ¶ˆæ¯äº†ã€‚\n<a name=\"y9i5F\"></a>\n\n## æ•°æ®éš”ç¦»\n\n<a name=\"DKHGX\"></a>\n\n### ç”¨æˆ·ç®¡ç†\n\nç‚¹å‡»`Admin`é€‰é¡¹å¡ï¼Œé¦–å…ˆä¼šçœ‹åˆ°RabbitMQæ§åˆ¶å°çš„ç”¨æˆ·ç®¡ç†ç•Œé¢ï¼š<br />![21.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_8b27592528-21.png) <br />è¿™é‡Œçš„ç”¨æˆ·éƒ½æ˜¯RabbitMQçš„ç®¡ç†æˆ–è¿ç»´äººå‘˜ã€‚ç›®å‰åªæœ‰å®‰è£…RabbitMQæ—¶æ·»åŠ çš„`itheima`è¿™ä¸ªç”¨æˆ·ã€‚ä»”ç»†è§‚å¯Ÿç”¨æˆ·è¡¨æ ¼ä¸­çš„å­—æ®µï¼Œå¦‚ä¸‹ï¼š\n\n- `Name`ï¼š`itheima`ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·å\n- `Tags`ï¼š`administrator`ï¼Œè¯´æ˜`itheima`ç”¨æˆ·æ˜¯è¶…çº§ç®¡ç†å‘˜ï¼Œæ‹¥æœ‰æ‰€æœ‰æƒé™\n- `Can access virtual host`ï¼š `/`ï¼Œå¯ä»¥è®¿é—®çš„`virtual host`ï¼Œè¿™é‡Œçš„`/`æ˜¯é»˜è®¤çš„`virtual host`\n\nå¯¹äºå°å‹ä¼ä¸šè€Œè¨€ï¼Œå‡ºäºæˆæœ¬è€ƒè™‘ï¼Œæˆ‘ä»¬é€šå¸¸åªä¼šæ­å»ºä¸€å¥—MQé›†ç¾¤ï¼Œå…¬å¸å†…çš„å¤šä¸ªä¸åŒé¡¹ç›®åŒæ—¶ä½¿ç”¨ã€‚è¿™ä¸ªæ—¶å€™ä¸ºäº†é¿å…äº’ç›¸å¹²æ‰°ï¼Œ æˆ‘ä»¬ä¼šåˆ©ç”¨`virtual host`çš„éš”ç¦»ç‰¹æ€§ï¼Œå°†ä¸åŒé¡¹ç›®éš”ç¦»ã€‚ä¸€èˆ¬ä¼šåšä¸¤ä»¶äº‹æƒ…ï¼š\n\n- ç»™æ¯ä¸ªé¡¹ç›®åˆ›å»ºç‹¬ç«‹çš„è¿ç»´è´¦å·ï¼Œå°†ç®¡ç†æƒé™åˆ†ç¦»ã€‚\n- ç»™æ¯ä¸ªé¡¹ç›®åˆ›å»ºä¸åŒçš„`virtual host`ï¼Œå°†æ¯ä¸ªé¡¹ç›®çš„æ•°æ®éš”ç¦»ã€‚\n\næ¯”å¦‚ï¼Œæˆ‘ä»¬ç»™é»‘é©¬å•†åŸåˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·ï¼Œå‘½åä¸º`hmall`ï¼š<br />![22.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_8d32179928-22.png) <br />ä½ ä¼šå‘ç°æ­¤æ—¶`hmall`ç”¨æˆ·æ²¡æœ‰ä»»ä½•`virtual host`çš„è®¿é—®æƒé™ï¼š<br />![23.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_9107116a28-23.png) <br />æ¥ä¸‹æ¥æˆ‘ä»¬å°†ç»™`hmall`ç”¨æˆ·åˆ›å»ºè‡ªå·±çš„`virtual host`ã€‚\n<a name=\"cp2L2\"></a>\n\n### virtual host\n\næˆ‘ä»¬å…ˆé€€å‡ºç™»å½•ï¼š<br />![24.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_945ee39028-24.png) <br />åˆ‡æ¢åˆ°åˆšåˆšåˆ›å»ºçš„`hmall`ç”¨æˆ·ç™»å½•ï¼Œç„¶åç‚¹å‡»`Virtual Hosts`èœå•ï¼Œè¿›å…¥`virtual host`ç®¡ç†é¡µï¼š<br />![25.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_96bf98d228-25.png) <br />å¯ä»¥çœ‹åˆ°ç›®å‰åªæœ‰ä¸€ä¸ªé»˜è®¤çš„`virtual host`ï¼Œåå­—ä¸º `/`ã€‚<br />æˆ‘ä»¬å¯ä»¥ç»™é»‘é©¬å•†åŸé¡¹ç›®åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„`virtual host`ï¼Œè€Œä¸æ˜¯ä½¿ç”¨é»˜è®¤çš„`/`ã€‚<br />![26.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_981af35928-26.png) <br />åˆ›å»ºå®Œæˆåå¦‚å›¾ï¼š<br />![27.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_9b2f7a6828-27.png) <br />ç”±äºæˆ‘ä»¬æ˜¯ç™»å½•`hmall`è´¦æˆ·ååˆ›å»ºçš„`virtual host`ï¼Œå› æ­¤å›åˆ°`users`èœå•ï¼Œä½ ä¼šå‘ç°å½“å‰ç”¨æˆ·å·²ç»å…·å¤‡äº†å¯¹`/hmall`è¿™ä¸ª`virtual host`çš„è®¿é—®æƒé™äº†ï¼š![28.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_9e03594228-28.png) <br />æ­¤æ—¶ï¼Œç‚¹å‡»é¡µé¢å³ä¸Šè§’çš„`virtual host`ä¸‹æ‹‰èœå•ï¼Œåˆ‡æ¢`virtual host`ä¸º `/hmall`ï¼š<br />![29.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_a2454c6128-29.png) <br />ç„¶åå†æ¬¡æŸ¥çœ‹`queues`é€‰é¡¹å¡ï¼Œä¼šå‘ç°ä¹‹å‰çš„é˜Ÿåˆ—å·²ç»çœ‹ä¸åˆ°äº†ï¼š<br />![30.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_a6cfc36428-30.png) <br />è¿™å°±æ˜¯åŸºäº`virtual host` çš„éš”ç¦»æ•ˆæœã€‚\n<a name=\"uudna\"></a>\n\n# SpringAMQP\n\nå°†æ¥æˆ‘ä»¬å¼€å‘ä¸šåŠ¡åŠŸèƒ½çš„æ—¶å€™ï¼Œè‚¯å®šä¸ä¼šåœ¨æ§åˆ¶å°æ”¶å‘æ¶ˆæ¯ï¼Œè€Œæ˜¯åº”è¯¥åŸºäºç¼–ç¨‹çš„æ–¹å¼ã€‚ç”±äºRabbitMQé‡‡ç”¨äº†AMQPåè®®ï¼Œå› æ­¤å®ƒå…·å¤‡è·¨è¯­è¨€çš„ç‰¹æ€§ã€‚ä»»ä½•è¯­è¨€åªè¦éµå¾ªAMQPåè®®æ”¶å‘æ¶ˆæ¯ï¼Œéƒ½å¯ä»¥ä¸RabbitMQäº¤äº’ã€‚å¹¶ä¸”RabbitMQå®˜æ–¹ä¹Ÿæä¾›äº†å„ç§ä¸åŒè¯­è¨€çš„å®¢æˆ·ç«¯ã€‚<br />ä½†æ˜¯ï¼ŒRabbitMQå®˜æ–¹æä¾›çš„Javaå®¢æˆ·ç«¯ç¼–ç ç›¸å¯¹å¤æ‚ï¼Œä¸€èˆ¬ç”Ÿäº§ç¯å¢ƒä¸‹æˆ‘ä»¬æ›´å¤šä¼šç»“åˆSpringæ¥ä½¿ç”¨ã€‚è€ŒSpringçš„å®˜æ–¹åˆšå¥½åŸºäºRabbitMQæä¾›äº†è¿™æ ·ä¸€å¥—æ¶ˆæ¯æ”¶å‘çš„æ¨¡æ¿å·¥å…·ï¼šSpringAMQPã€‚å¹¶ä¸”è¿˜åŸºäºSpringBootå¯¹å…¶å®ç°äº†è‡ªåŠ¨è£…é…ï¼Œä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ã€‚<br />SpringAMQPçš„å®˜æ–¹åœ°å€ï¼š<br />[Spring AMQP](https://spring.io/projects/spring-amqp)<br />SpringAMQPæä¾›äº†ä¸‰ä¸ªåŠŸèƒ½ï¼š\n\n- è‡ªåŠ¨å£°æ˜é˜Ÿåˆ—ã€äº¤æ¢æœºåŠå…¶ç»‘å®šå…³ç³»\n- åŸºäºæ³¨è§£çš„ç›‘å¬å™¨æ¨¡å¼ï¼Œå¼‚æ­¥æ¥æ”¶æ¶ˆæ¯\n- å°è£…äº†RabbitTemplateå·¥å…·ï¼Œç”¨äºå‘é€æ¶ˆæ¯\n  <a name=\"cD9zT\"></a>\n\n## åˆ›å»ºDemo\n\nåˆ›å»ºå¾®æœåŠ¡é¡¹ç›®`Demo`ï¼Œé¡¹ç›®ç»“æ„å¦‚å›¾ï¼š<br />![31.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_ab0f3aea28-31.png) <br />åŒ…æ‹¬ä¸‰éƒ¨åˆ†ï¼š\n\n- mq-demoï¼šçˆ¶å·¥ç¨‹ï¼Œç®¡ç†é¡¹ç›®ä¾èµ–\n- publisherï¼šæ¶ˆæ¯çš„å‘é€è€…\n- consumerï¼šæ¶ˆæ¯çš„æ¶ˆè´¹è€…\n\nçˆ¶å·¥ç¨‹çš„`pom`æ–‡ä»¶é…ç½®å¦‚ä¸‹ï¼š\n\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n    <modelVersion>4.0.0</modelVersion>\n\n    <groupId>cn.itcast.demo</groupId>\n    <artifactId>mq-demo</artifactId>\n    <version>1.0-SNAPSHOT</version>\n    <modules>\n        <module>publisher</module>\n        <module>consumer</module>\n    </modules>\n    <packaging>pom</packaging>\n\n    <parent>\n        <groupId>org.springframework.boot</groupId>\n        <artifactId>spring-boot-starter-parent</artifactId>\n        <version>2.7.12</version>\n        <relativePath/>\n    </parent>\n\n    <properties>\n        <maven.compiler.source>8</maven.compiler.source>\n        <maven.compiler.target>8</maven.compiler.target>\n    </properties>\n\n    <dependencies>\n        <dependency>\n            <groupId>org.projectlombok</groupId>\n            <artifactId>lombok</artifactId>\n        </dependency>\n        <!--AMQPä¾èµ–ï¼ŒåŒ…å«RabbitMQ-->\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-amqp</artifactId>\n        </dependency>\n        <!--å•å…ƒæµ‹è¯•-->\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-test</artifactId>\n        </dependency>\n    </dependencies>\n</project>\n```\n\nå½“æˆ‘ä»¬åœ¨çˆ¶å·¥ç¨‹ä¸­å¼•å…¥äº†ç›¸å…³ä¾èµ–åï¼Œå­å·¥ç¨‹å°±èƒ½ç›´æ¥ä½¿ç”¨SpringAMQPäº†ã€‚<br />`publisher`æœåŠ¡çš„`application.yml`æ–‡ä»¶é…ç½®å¦‚ä¸‹ï¼š\n\n```yaml\nspring:\n  rabbitmq:\n    host: 192.168.150.101 # ä½ çš„è™šæ‹ŸæœºIP\n    port: 5672 # ç«¯å£\n    virtual-host: /hmall # è™šæ‹Ÿä¸»æœº\n    username: hmall # ç”¨æˆ·å\n    password: 123 # å¯†ç \n```\n\n`consumer`æœåŠ¡çš„`application.yml`æ–‡ä»¶é…ç½®å¦‚ä¸‹ï¼š\n\n```yaml\nspring:\n  rabbitmq:\n    host: 192.168.150.101 # ä½ çš„è™šæ‹ŸæœºIP\n    port: 5672 # ç«¯å£\n    virtual-host: /hmall # è™šæ‹Ÿä¸»æœº\n    username: hmall # ç”¨æˆ·å\n    password: 123 # å¯†ç \n```\n\n<a name=\"nweVz\"></a>\n\n## å£°æ˜é˜Ÿåˆ—ä¸äº¤æ¢æœº\n\nåœ¨å®é™…å¼€å‘æ—¶ï¼Œé˜Ÿåˆ—å’Œäº¤æ¢æœºæ˜¯ç¨‹åºå‘˜å®šä¹‰çš„ï¼Œå°†æ¥é¡¹ç›®ä¸Šçº¿ï¼Œåˆè¦äº¤ç»™è¿ç»´å»åˆ›å»ºã€‚é‚£ä¹ˆç¨‹åºå‘˜å°±éœ€è¦æŠŠç¨‹åºä¸­è¿è¡Œçš„æ‰€æœ‰é˜Ÿåˆ—å’Œäº¤æ¢æœºéƒ½å†™ä¸‹æ¥ï¼Œäº¤ç»™è¿ç»´ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ˜¯å¾ˆå®¹æ˜“å‡ºç°é”™è¯¯çš„ã€‚<br />å› æ­¤æ¨èçš„åšæ³•æ˜¯ç”±ç¨‹åºå¯åŠ¨æ—¶æ£€æŸ¥é˜Ÿåˆ—å’Œäº¤æ¢æœºæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨è‡ªåŠ¨åˆ›å»ºã€‚\n<a name=\"YN5Xf\"></a>\n\n### å‡ ç§äº¤æ¢æœºç±»å‹\n\n- `FanoutExchange`ï¼šå°†æ¶ˆæ¯åˆ†å‘åˆ°æ‰€æœ‰çš„ç»‘å®šé˜Ÿåˆ—ï¼Œæ— `routingkey`çš„æ¦‚å¿µ\n- `HeadersExchange` ï¼šé€šè¿‡æ·»åŠ å±æ€§`key-value`åŒ¹é…\n- `DirectExchange`ï¼šæŒ‰ç…§`routingkey`åˆ†å‘åˆ°æŒ‡å®šé˜Ÿåˆ—\n- `TopicExchange`ï¼šå¤šå…³é”®å­—åŒ¹é…ï¼Œæ”¯æŒé€šé…ç¬¦\n  <a name=\"qcW7N\"></a>\n\n### åŸºæœ¬API\n\nSpringAMQPæä¾›äº†ä¸€ä¸ªQueueç±»ï¼Œç”¨æ¥åˆ›å»ºé˜Ÿåˆ—ï¼š<br />![32.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_ae2a72d028-32.png) <br />SpringAMQPè¿˜æä¾›äº†ä¸€ä¸ªExchangeæ¥å£ï¼Œæ¥è¡¨ç¤ºæ‰€æœ‰ä¸åŒç±»å‹çš„äº¤æ¢æœºï¼š<br />![33.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_b1a84c5228-33.png) <br />æˆ‘ä»¬å¯ä»¥è‡ªå·±åˆ›å»ºé˜Ÿåˆ—å’Œäº¤æ¢æœºï¼Œä¸è¿‡SpringAMQPè¿˜æä¾›äº†ExchangeBuilderæ¥ç®€åŒ–è¿™ä¸ªè¿‡ç¨‹ï¼š<br />![34.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_b4ed680328-34.png) <br />è€Œåœ¨ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœºæ—¶ï¼Œåˆ™éœ€è¦ä½¿ç”¨BindingBuilderæ¥åˆ›å»ºBindingå¯¹è±¡ï¼š<br />![35.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_b8e5ac1c28-35.png)\n<a name=\"vIEcS\"></a>\n\n### fanoutç¤ºä¾‹\n\nåœ¨consumerä¸­åˆ›å»ºä¸€ä¸ªç±»ï¼Œå£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœºï¼š\n\n```java\npackage com.itheima.consumer.config;\n\nimport org.springframework.amqp.core.Binding;\nimport org.springframework.amqp.core.BindingBuilder;\nimport org.springframework.amqp.core.FanoutExchange;\nimport org.springframework.amqp.core.Queue;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\n\n@Configuration\npublic class FanoutConfig {\n    /**\n     * å£°æ˜äº¤æ¢æœº\n     * @return Fanoutç±»å‹äº¤æ¢æœº\n     */\n    @Bean\n    public FanoutExchange fanoutExchange(){\n        return new FanoutExchange(\"hmall.fanout\");\n    }\n\n    /**\n     * ç¬¬1ä¸ªé˜Ÿåˆ—\n     */\n    @Bean\n    public Queue fanoutQueue1(){\n        return new Queue(\"fanout.queue1\");\n    }\n\n    /**\n     * ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœº\n     */\n    @Bean\n    public Binding bindingQueue1(Queue fanoutQueue1, FanoutExchange fanoutExchange){\n        return BindingBuilder.bind(fanoutQueue1).to(fanoutExchange);\n    }\n\n    /**\n     * ç¬¬2ä¸ªé˜Ÿåˆ—\n     */\n    @Bean\n    public Queue fanoutQueue2(){\n        return new Queue(\"fanout.queue2\");\n    }\n\n    /**\n     * ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœº\n     */\n    @Bean\n    public Binding bindingQueue2(Queue fanoutQueue2, FanoutExchange fanoutExchange){\n        return BindingBuilder.bind(fanoutQueue2).to(fanoutExchange);\n    }\n}\n```\n\n<a name=\"Jmuq0\"></a>\n\n### directç¤ºä¾‹\n\ndirectæ¨¡å¼ç”±äºè¦ç»‘å®šå¤šä¸ªKEYï¼Œä¼šéå¸¸éº»çƒ¦ï¼Œæ¯ä¸€ä¸ªKeyéƒ½è¦ç¼–å†™ä¸€ä¸ªbindingï¼š\n\n```java\npackage com.itheima.consumer.config;\n\nimport org.springframework.amqp.core.*;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\n\n@Configuration\npublic class DirectConfig {\n\n    /**\n     * å£°æ˜äº¤æ¢æœº\n     * @return Directç±»å‹äº¤æ¢æœº\n     */\n    @Bean\n    public DirectExchange directExchange(){\n        return ExchangeBuilder.directExchange(\"hmall.direct\").build();\n    }\n\n    /**\n     * ç¬¬1ä¸ªé˜Ÿåˆ—\n     */\n    @Bean\n    public Queue directQueue1(){\n        return new Queue(\"direct.queue1\");\n    }\n\n    /**\n     * ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœº\n     */\n    @Bean\n    public Binding bindingQueue1WithRed(Queue directQueue1, DirectExchange directExchange){\n        return BindingBuilder.bind(directQueue1).to(directExchange).with(\"red\");\n    }\n    /**\n     * ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœº\n     */\n    @Bean\n    public Binding bindingQueue1WithBlue(Queue directQueue1, DirectExchange directExchange){\n        return BindingBuilder.bind(directQueue1).to(directExchange).with(\"blue\");\n    }\n\n    /**\n     * ç¬¬2ä¸ªé˜Ÿåˆ—\n     */\n    @Bean\n    public Queue directQueue2(){\n        return new Queue(\"direct.queue2\");\n    }\n\n    /**\n     * ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœº\n     */\n    @Bean\n    public Binding bindingQueue2WithRed(Queue directQueue2, DirectExchange directExchange){\n        return BindingBuilder.bind(directQueue2).to(directExchange).with(\"red\");\n    }\n    /**\n     * ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœº\n     */\n    @Bean\n    public Binding bindingQueue2WithYellow(Queue directQueue2, DirectExchange directExchange){\n        return BindingBuilder.bind(directQueue2).to(directExchange).with(\"yellow\");\n    }\n}\n```\n\n<a name=\"KHISC\"></a>\n\n### åŸºäºæ³¨è§£å£°æ˜\n\nåŸºäº@Beançš„æ–¹å¼å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœºæ¯”è¾ƒéº»çƒ¦ï¼ŒSpringè¿˜æä¾›äº†åŸºäºæ³¨è§£æ–¹å¼æ¥å£°æ˜ã€‚<br />ä¾‹å¦‚ï¼Œæˆ‘ä»¬åŒæ ·å£°æ˜Directæ¨¡å¼çš„äº¤æ¢æœºå’Œé˜Ÿåˆ—ï¼š\n\n```java\n@RabbitListener(bindings = @QueueBinding(\n    value = @Queue(name = \"direct.queue1\"),\n    exchange = @Exchange(name = \"hmall.direct\", type = ExchangeTypes.DIRECT),\n    key = {\"red\", \"blue\"}\n))\npublic void listenDirectQueue1(String msg){\n    System.out.println(\"æ¶ˆè´¹è€…1æ¥æ”¶åˆ°direct.queue1çš„æ¶ˆæ¯ï¼šã€\" + msg + \"ã€‘\");\n}\n\n@RabbitListener(bindings = @QueueBinding(\n    value = @Queue(name = \"direct.queue2\"),\n    exchange = @Exchange(name = \"hmall.direct\", type = ExchangeTypes.DIRECT),\n    key = {\"red\", \"yellow\"}\n))\npublic void listenDirectQueue2(String msg){\n    System.out.println(\"æ¶ˆè´¹è€…2æ¥æ”¶åˆ°direct.queue2çš„æ¶ˆæ¯ï¼šã€\" + msg + \"ã€‘\");\n}\n```\n\nä»ä»£ç ä¸Šçœ‹ï¼Œç®€å•äº†éå¸¸å¤šï¼Œå†çœ‹çœ‹`Topic`æ¨¡å¼ï¼š\n\n```java\n@RabbitListener(bindings = @QueueBinding(\n    value = @Queue(name = \"topic.queue1\"),\n    exchange = @Exchange(name = \"hmall.topic\", type = ExchangeTypes.TOPIC),\n    key = \"china.#\"\n))\npublic void listenTopicQueue1(String msg){\n    System.out.println(\"æ¶ˆè´¹è€…1æ¥æ”¶åˆ°topic.queue1çš„æ¶ˆæ¯ï¼šã€\" + msg + \"ã€‘\");\n}\n\n@RabbitListener(bindings = @QueueBinding(\n    value = @Queue(name = \"topic.queue2\"),\n    exchange = @Exchange(name = \"hmall.topic\", type = ExchangeTypes.TOPIC),\n    key = \"#.news\"\n))\npublic void listenTopicQueue2(String msg){\n    System.out.println(\"æ¶ˆè´¹è€…2æ¥æ”¶åˆ°topic.queue2çš„æ¶ˆæ¯ï¼šã€\" + msg + \"ã€‘\");\n}\n```\n\n<a name=\"W685N\"></a>\n\n## æ¶ˆæ¯å‘é€ä¸æ¥æ”¶\n\n<a name=\"V0KRZ\"></a>\n\n### æ¶ˆæ¯å‘é€\n\n```java\npackage com.itheima.publisher.amqp;\n\nimport org.junit.jupiter.api.Test;\nimport org.springframework.amqp.rabbit.core.RabbitTemplate;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.boot.test.context.SpringBootTest;\n\n@SpringBootTest\npublic class SpringAmqpTest {\n\n    @Autowired\n    private RabbitTemplate rabbitTemplate;\n\n    @Test\n    public void testSimpleQueue() {\n        // é˜Ÿåˆ—åç§°\n        String queueName = \"simple.queue\";\n        // æ¶ˆæ¯\n        String message = \"hello, spring amqp!\";\n        // å‘é€æ¶ˆæ¯\n        rabbitTemplate.convertAndSend(queueName, message);\n    }\n}\n```\n\n<a name=\"cdcDu\"></a>\n\n### æ¶ˆæ¯æ¥æ”¶\n\n```java\npackage com.itheima.consumer.listener;\n\nimport org.springframework.amqp.rabbit.annotation.RabbitListener;\nimport org.springframework.stereotype.Component;\n\n@Component\npublic class SpringRabbitListener {\n    // åˆ©ç”¨RabbitListeneræ¥å£°æ˜è¦ç›‘å¬çš„é˜Ÿåˆ—ä¿¡æ¯\n    // å°†æ¥ä¸€æ—¦ç›‘å¬çš„é˜Ÿåˆ—ä¸­æœ‰äº†æ¶ˆæ¯ï¼Œå°±ä¼šæ¨é€ç»™å½“å‰æœåŠ¡ï¼Œè°ƒç”¨å½“å‰æ–¹æ³•ï¼Œå¤„ç†æ¶ˆæ¯ã€‚\n    // å¯ä»¥çœ‹åˆ°æ–¹æ³•ä½“ä¸­æ¥æ”¶çš„å°±æ˜¯æ¶ˆæ¯ä½“çš„å†…å®¹\n    @RabbitListener(queues = \"simple.queue\")\n    public void listenSimpleQueueMessage(String msg) throws InterruptedException {\n        System.out.println(\"spring æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€\" + msg + \"ã€‘\");\n    }\n}\n```\n\n<a name=\"TS7FY\"></a>\n\n## æ¶ˆæ¯è½¬æ¢å™¨\n\n> æ³¨æ„ä¸è¦å°†æ¶ˆæ¯è½¬æ¢å™¨å’Œäº¤æ¢æœºææ··äº†ï¼Œæ¶ˆæ¯è½¬æ¢å™¨æ˜¯ä¸€ä¸ªç”¨äºå°†æ¶ˆæ¯è½¬æ¢ä¸ºç‰¹å®šæ ¼å¼æˆ–ç±»å‹çš„ç»„ä»¶ï¼Œè€Œäº¤æ¢æœºæ˜¯è·¯ç”±æ¶ˆæ¯åˆ°é˜Ÿåˆ—çš„å·¥å…·ã€‚\n\nSpringçš„æ¶ˆæ¯å‘é€ä»£ç æ¥æ”¶çš„æ¶ˆæ¯ä½“æ˜¯ä¸€ä¸ªObjectï¼š<br />![36.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_bda82c1928-36.png) <br />è€Œåœ¨æ•°æ®ä¼ è¾“æ—¶ï¼Œå®ƒä¼šæŠŠä½ å‘é€çš„æ¶ˆæ¯åºåˆ—åŒ–ä¸ºå­—èŠ‚å‘é€ç»™MQï¼Œæ¥æ”¶æ¶ˆæ¯çš„æ—¶å€™ï¼Œè¿˜ä¼šæŠŠå­—èŠ‚ååºåˆ—åŒ–ä¸ºJavaå¯¹è±¡ã€‚\n<a name=\"vSriX\"></a>\n\n### é»˜è®¤è½¬æ¢å™¨\n\nåªä¸è¿‡ï¼Œé»˜è®¤æƒ…å†µä¸‹Springé‡‡ç”¨çš„åºåˆ—åŒ–æ–¹å¼æ˜¯JDKåºåˆ—åŒ–ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼ŒJDKåºåˆ—åŒ–å­˜åœ¨ä¸‹åˆ—é—®é¢˜ï¼š\n\n- æ•°æ®ä½“ç§¯è¿‡å¤§\n- æœ‰å®‰å…¨æ¼æ´ï¼ˆååºåˆ—åŒ–æ—¶å¯èƒ½è¢«ç¯¡æ”¹ï¼‰\n- å¯è¯»æ€§å·®\n\nä»¥ä¸‹æ˜¯ä½¿ç”¨Jdkåºåˆ—åŒ–çš„æ•ˆæœï¼š<br />![37.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_c13b86ce28-37.png)\n<a name=\"HP4qD\"></a>\n\n### é…ç½®JSONè½¬æ¢å™¨\n\næ˜¾ç„¶ï¼ŒJDKåºåˆ—åŒ–æ–¹å¼å¹¶ä¸åˆé€‚ã€‚æˆ‘ä»¬å¸Œæœ›æ¶ˆæ¯ä½“çš„ä½“ç§¯æ›´å°ã€å¯è¯»æ€§æ›´é«˜ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨JSONæ–¹å¼æ¥åšåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚\n\n- å¼•å…¥ä¾èµ–\n\n```xml\n<dependency>\n    <groupId>com.fasterxml.jackson.dataformat</groupId>\n    <artifactId>jackson-dataformat-xml</artifactId>\n    <version>2.9.10</version>\n</dependency>\n```\n\n- åœ¨é…ç½®ç±»ä¸­æ·»åŠ Bean\n\n```java\n@Bean\npublic MessageConverter jsonMessageConverter(ObjectMapper objectMapper) {\n    // 1.å®šä¹‰æ¶ˆæ¯è½¬æ¢å™¨\n    Jackson2JsonMessageConverter jackson2JsonMessageConverter = new Jackson2JsonMessageConverter(objectMapper);\n    // 2.é…ç½®è‡ªåŠ¨åˆ›å»ºæ¶ˆæ¯idï¼Œç”¨äºè¯†åˆ«ä¸åŒæ¶ˆæ¯ï¼Œä¹Ÿå¯ä»¥åœ¨ä¸šåŠ¡ä¸­åŸºäºIDåˆ¤æ–­æ˜¯å¦æ˜¯é‡å¤æ¶ˆæ¯\n    jackson2JsonMessageConverter.setCreateMessageIds(true);\n    return jackson2JsonMessageConverter;\n}\n```\n\n> æ¶ˆæ¯è½¬æ¢å™¨ä¸­æ·»åŠ çš„messageIdå¯ä»¥ä¾¿äºæˆ‘ä»¬å°†æ¥åšå¹‚ç­‰æ€§åˆ¤æ–­ï¼Œä½†æ˜¯è¯¥æ–¹æ¡ˆå¹¶ä¸æ˜¯å¾ˆå¥½ï¼Œå› ä¸ºä¼šå¯¼è‡´ä¸šåŠ¡æ–¹ï¼ˆæ¶ˆè´¹è€…ï¼‰è¢«ä¾µå…¥é¢å¤–çš„é€»è¾‘ï¼ŒåŒæ—¶è¿˜è¦è¯»å†™æ•°æ®åº“æ“ä½œã€‚\n\nä»¥ä¸‹æ˜¯ä½¿ç”¨JSONè½¬æ¢å™¨çš„æ•ˆæœï¼š <br />![38.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_c5b1d30828-38.png)\n<a name=\"iI2mb\"></a>\n\n# ä¸šåŠ¡ä½¿ç”¨RabbitMQ\n\nä¸ç®¡æ˜¯ç”Ÿäº§è€…è¿˜æ˜¯æ¶ˆè´¹è€…ï¼Œéƒ½éœ€è¦é…ç½®MQçš„åŸºæœ¬ä¿¡æ¯ã€‚åˆ†ä¸ºä¸¤æ­¥ï¼š\n\n- æ·»åŠ ä¾èµ–ï¼š\n\n```xml\n<!--æ¶ˆæ¯å‘é€-->\n<dependency>\n  <groupId>org.springframework.boot</groupId>\n  <artifactId>spring-boot-starter-amqp</artifactId>\n</dependency>\n```\n\n- é…ç½®MQåœ°å€ï¼š\n\n```yaml\nspring:\n  rabbitmq:\n    host: 192.168.150.101 # ä½ çš„è™šæ‹ŸæœºIP\n    port: 5672 # ç«¯å£\n    virtual-host: /hmall # è™šæ‹Ÿä¸»æœº\n    username: hmall # ç”¨æˆ·å\n    password: 123 # å¯†ç \n```\n\n<a name=\"tOrbZ\"></a>\n\n## å‘é€æ¶ˆæ¯\n\nä¿®æ”¹`pay-service`æœåŠ¡ä¸‹çš„`com.hmall.pay.service.impl.PayOrderServiceImpl`ç±»ä¸­çš„`tryPayOrderByBalance`æ–¹æ³•ï¼š\n\n```java\nprivate final RabbitTemplate rabbitTemplate;\n\n@Override\n@Transactional\npublic void tryPayOrderByBalance(PayOrderDTO payOrderDTO) {\n    // 1.æŸ¥è¯¢æ”¯ä»˜å•\n    PayOrder po = getById(payOrderDTO.getId());\n    // 2.åˆ¤æ–­çŠ¶æ€\n    if(!PayStatus.WAIT_BUYER_PAY.equalsValue(po.getStatus())){\n        // è®¢å•ä¸æ˜¯æœªæ”¯ä»˜ï¼ŒçŠ¶æ€å¼‚å¸¸\n        throw new BizIllegalException(\"äº¤æ˜“å·²æ”¯ä»˜æˆ–å…³é—­ï¼\");\n    }\n    // 3.å°è¯•æ‰£å‡ä½™é¢\n    userClient.deductMoney(payOrderDTO.getPw(), po.getAmount());\n    // 4.ä¿®æ”¹æ”¯ä»˜å•çŠ¶æ€\n    boolean success = markPayOrderSuccess(payOrderDTO.getId(), LocalDateTime.now());\n    if (!success) {\n        throw new BizIllegalException(\"äº¤æ˜“å·²æ”¯ä»˜æˆ–å…³é—­ï¼\");\n    }\n    // 5.ä¿®æ”¹è®¢å•çŠ¶æ€\n    // tradeClient.markOrderPaySuccess(po.getBizOrderNo());\n    try {\n        rabbitTemplate.convertAndSend(\"pay.direct\", \"pay.success\", po.getBizOrderNo());\n    } catch (Exception e) {\n        log.error(\"æ”¯ä»˜æˆåŠŸçš„æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œæ”¯ä»˜å•idï¼š{}ï¼Œ äº¤æ˜“å•idï¼š{}\", po.getId(), po.getBizOrderNo(), e);\n    }\n}\n```\n\n> é˜²æ­¢å¯¹åŸæœ‰ä¸šåŠ¡æœ‰å½±å“ï¼Œå¯ä»¥åœ¨`catch`ä¸­åŠ å…¥å¤±è´¥åçš„å…œåº•æ–¹æ¡ˆ\n\n<a name=\"fPuSa\"></a>\n\n## æ¥æ”¶æ¶ˆæ¯\n\nåœ¨`trade-service`æœåŠ¡ä¸­å®šä¹‰ä¸€ä¸ªæ¶ˆæ¯ç›‘å¬ç±»ï¼š<br />![39.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_c849cf6d28-39.png) <br />å…¶ä»£ç å¦‚ä¸‹ï¼š\n\n```java\npackage com.hmall.trade.listener;\n\nimport com.hmall.trade.service.IOrderService;\nimport lombok.RequiredArgsConstructor;\nimport org.springframework.amqp.core.ExchangeTypes;\nimport org.springframework.amqp.rabbit.annotation.Exchange;\nimport org.springframework.amqp.rabbit.annotation.Queue;\nimport org.springframework.amqp.rabbit.annotation.QueueBinding;\nimport org.springframework.amqp.rabbit.annotation.RabbitListener;\nimport org.springframework.stereotype.Component;\n\n@Component\n@RequiredArgsConstructor\npublic class PayStatusListener {\n\n    private final IOrderService orderService;\n\n    @RabbitListener(bindings = @QueueBinding(\n        value = @Queue(name = \"trade.pay.success.queue\", durable = \"true\"),\n        exchange = @Exchange(name = \"pay.topic\"),\n        key = \"pay.success\"\n    ))\n    public void listenPaySuccess(Long orderId){\n        orderService.markOrderPaySuccess(orderId);\n    }\n}\n```\n\n<a name=\"qSwKt\"></a>\n\n# ç”Ÿäº§è€…çš„å¯é æ€§\n\n**ä»æœ¬ç« å¼€å§‹çš„ä¸‰ä¸ªç« èŠ‚ï¼Œå°†ä¼šåˆ†ææ¶ˆæ¯ä¼ é€’è¿‡ç¨‹ä¸­æ¶ˆæ¯ä¸¢å¤±çš„ç¯èŠ‚åŠè§£å†³æ–¹å¼ã€‚**<br />æ¶ˆæ¯ä»å‘é€è€…å‘é€æ¶ˆæ¯ï¼Œåˆ°æ¶ˆè´¹è€…å¤„ç†æ¶ˆæ¯ï¼Œéœ€è¦ç»è¿‡çš„æµç¨‹æ˜¯è¿™æ ·çš„ï¼š<br />![40.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_caacf60328-40.png) <br />æ¶ˆæ¯ä»ç”Ÿäº§è€…åˆ°æ¶ˆè´¹è€…çš„æ¯ä¸€æ­¥éƒ½å¯èƒ½å¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼š\n\n- å‘é€æ¶ˆæ¯æ—¶ä¸¢å¤±ï¼š\n    - ç”Ÿäº§è€…å‘é€æ¶ˆæ¯æ—¶è¿æ¥MQå¤±è´¥\n    - ç”Ÿäº§è€…å‘é€æ¶ˆæ¯åˆ°è¾¾MQåæœªæ‰¾åˆ°`Exchange`\n    - ç”Ÿäº§è€…å‘é€æ¶ˆæ¯åˆ°è¾¾MQçš„`Exchange`åï¼Œæœªæ‰¾åˆ°åˆé€‚çš„`Queue`\n    - æ¶ˆæ¯åˆ°è¾¾MQåï¼Œå¤„ç†æ¶ˆæ¯çš„è¿›ç¨‹å‘ç”Ÿå¼‚å¸¸\n- MQå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼š\n    - æ¶ˆæ¯åˆ°è¾¾MQï¼Œä¿å­˜åˆ°é˜Ÿåˆ—åï¼Œå°šæœªæ¶ˆè´¹å°±çªç„¶å®•æœº\n- æ¶ˆè´¹è€…å¤„ç†æ¶ˆæ¯æ—¶ï¼š\n    - æ¶ˆæ¯æ¥æ”¶åå°šæœªå¤„ç†çªç„¶å®•æœº\n    - æ¶ˆæ¯æ¥æ”¶åå¤„ç†è¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸\n\n**ç»¼ä¸Š**ï¼Œæˆ‘ä»¬è¦è§£å†³æ¶ˆæ¯ä¸¢å¤±é—®é¢˜ï¼Œä¿è¯MQçš„å¯é æ€§ï¼Œå°±å¿…é¡»ä»3ä¸ªæ–¹é¢å…¥æ‰‹ï¼š\n\n- ç¡®ä¿ç”Ÿäº§è€…ä¸€å®šæŠŠæ¶ˆæ¯å‘é€åˆ°MQ\n- ç¡®ä¿MQä¸ä¼šå°†æ¶ˆæ¯å¼„ä¸¢\n- ç¡®ä¿æ¶ˆè´¹è€…ä¸€å®šè¦å¤„ç†æ¶ˆæ¯\n\næœ¬ç« å°†åˆ†æå¦‚ä½•ç¡®ä¿ç”Ÿäº§è€…å¯é æ€§ã€‚\n<a name=\"BzbA0\"></a>\n\n## ç”Ÿäº§è€…é‡è¯•æœºåˆ¶\n\né¦–å…ˆç¬¬ä¸€ç§æƒ…å†µï¼Œå°±æ˜¯ç”Ÿäº§è€…å‘é€æ¶ˆæ¯æ—¶ï¼Œå‡ºç°äº†ç½‘ç»œæ•…éšœï¼Œå¯¼è‡´ä¸MQçš„è¿æ¥ä¸­æ–­ã€‚<br />ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒSpringAMQPæä¾›äº†æ¶ˆæ¯å‘é€æ—¶çš„é‡è¯•æœºåˆ¶ã€‚å³ï¼šå½“`RabbitTemplate`ä¸MQè¿æ¥è¶…æ—¶åï¼Œå¤šæ¬¡é‡è¯•ã€‚<br />ä¿®æ”¹`publisher`æ¨¡å—çš„`application.yaml`æ–‡ä»¶ï¼Œæ·»åŠ ä¸‹é¢çš„å†…å®¹ï¼š\n\n```yaml\nspring:\n  rabbitmq:\n    connection-timeout: 1s # è®¾ç½®MQçš„è¿æ¥è¶…æ—¶æ—¶é—´\n    template:\n      retry:\n        enabled: true # å¼€å¯è¶…æ—¶é‡è¯•æœºåˆ¶\n        initial-interval: 1000ms # å¤±è´¥åçš„åˆå§‹ç­‰å¾…æ—¶é—´\n        multiplier: 1 # å¤±è´¥åä¸‹æ¬¡çš„ç­‰å¾…æ—¶é•¿å€æ•°ï¼Œä¸‹æ¬¡ç­‰å¾…æ—¶é•¿ = initial-interval * multiplier\n        max-attempts: 3 # æœ€å¤§é‡è¯•æ¬¡æ•°\n```\n\n**æ³¨æ„**ï¼šå½“ç½‘ç»œä¸ç¨³å®šçš„æ—¶å€™ï¼Œåˆ©ç”¨é‡è¯•æœºåˆ¶å¯ä»¥æœ‰æ•ˆæé«˜æ¶ˆæ¯å‘é€çš„æˆåŠŸç‡ã€‚ä¸è¿‡SpringAMQPæä¾›çš„é‡è¯•æœºåˆ¶æ˜¯**é˜»å¡å¼**çš„é‡è¯•ï¼Œä¹Ÿå°±æ˜¯è¯´å¤šæ¬¡é‡è¯•ç­‰å¾…çš„è¿‡ç¨‹ä¸­ï¼Œå½“å‰çº¿ç¨‹æ˜¯è¢«é˜»å¡çš„ã€‚<br />å¦‚æœå¯¹äºä¸šåŠ¡æ€§èƒ½æœ‰è¦æ±‚ï¼Œå»ºè®®ç¦ç”¨é‡è¯•æœºåˆ¶ã€‚å¦‚æœä¸€å®šè¦ä½¿ç”¨ï¼Œè¯·åˆç†é…ç½®ç­‰å¾…æ—¶é•¿å’Œé‡è¯•æ¬¡æ•°ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è€ƒè™‘ä½¿ç”¨å¼‚æ­¥çº¿ç¨‹æ¥æ‰§è¡Œå‘é€æ¶ˆæ¯çš„ä»£ç ã€‚\n<a name=\"flQ5d\"></a>\n\n## ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶\n\nä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåªè¦ç”Ÿäº§è€…ä¸MQä¹‹é—´çš„ç½‘è·¯è¿æ¥é¡ºç•…ï¼ŒåŸºæœ¬ä¸ä¼šå‡ºç°å‘é€æ¶ˆæ¯ä¸¢å¤±çš„æƒ…å†µï¼Œå› æ­¤å¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬æ— éœ€è€ƒè™‘è¿™ç§é—®é¢˜ã€‚<br />ä¸è¿‡ï¼Œåœ¨å°‘æ•°æƒ…å†µä¸‹ï¼Œä¹Ÿä¼šå‡ºç°æ¶ˆæ¯å‘é€åˆ°MQä¹‹åä¸¢å¤±çš„ç°è±¡ï¼Œæ¯”å¦‚ï¼š\n\n- MQå†…éƒ¨å¤„ç†æ¶ˆæ¯çš„è¿›ç¨‹å‘ç”Ÿäº†å¼‚å¸¸\n- ç”Ÿäº§è€…å‘é€æ¶ˆæ¯åˆ°è¾¾MQåæœªæ‰¾åˆ°`Exchange`\n- ç”Ÿäº§è€…å‘é€æ¶ˆæ¯åˆ°è¾¾MQçš„`Exchange`åï¼Œæœªæ‰¾åˆ°åˆé€‚çš„`Queue`ï¼Œå› æ­¤æ— æ³•è·¯ç”±\n\né’ˆå¯¹ä¸Šè¿°æƒ…å†µï¼ŒRabbitMQæä¾›äº†ç”Ÿäº§è€…æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼ŒåŒ…æ‹¬`Publisher Confirm`å’Œ`Publisher Return`ä¸¤ç§ã€‚åœ¨å¼€å¯ç¡®è®¤æœºåˆ¶çš„æƒ…å†µä¸‹ï¼Œå½“ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ç»™MQåï¼ŒMQä¼šæ ¹æ®æ¶ˆæ¯å¤„ç†çš„æƒ…å†µè¿”å›ä¸åŒçš„**å›æ‰§**ã€‚<br />å…·ä½“å¦‚å›¾æ‰€ç¤ºï¼š<br />![41.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_ccf8e0b528-41.png) <br />å…·ä½“å¦‚ä¸‹ï¼š\n\n- å½“æ¶ˆæ¯æŠ•é€’åˆ°MQï¼Œä½†æ˜¯è·¯ç”±å¤±è´¥æ—¶ï¼Œé€šè¿‡**Publisher Return**è¿”å›å¼‚å¸¸ä¿¡æ¯ï¼ŒåŒæ—¶è¿”å›ackçš„ç¡®è®¤ä¿¡æ¯ï¼Œä»£è¡¨æŠ•é€’æˆåŠŸ\n- ä¸´æ—¶æ¶ˆæ¯æŠ•é€’åˆ°äº†MQï¼Œå¹¶ä¸”å…¥é˜ŸæˆåŠŸï¼Œè¿”å›ACKï¼Œå‘ŠçŸ¥æŠ•é€’æˆåŠŸ\n- æŒä¹…æ¶ˆæ¯æŠ•é€’åˆ°äº†MQï¼Œå¹¶ä¸”å…¥é˜Ÿå®ŒæˆæŒä¹…åŒ–ï¼Œè¿”å›ACK ï¼Œå‘ŠçŸ¥æŠ•é€’æˆåŠŸ\n- å…¶å®ƒæƒ…å†µéƒ½ä¼šè¿”å›NACKï¼Œå‘ŠçŸ¥æŠ•é€’å¤±è´¥\n\nå…¶ä¸­`ack`å’Œ`nack`å±äº**Publisher Confirm**æœºåˆ¶ï¼Œ`ack`æ˜¯æŠ•é€’æˆåŠŸï¼›`nack`æ˜¯æŠ•é€’å¤±è´¥ã€‚è€Œ`return`åˆ™å±äº**Publisher Return**æœºåˆ¶ã€‚<br />é»˜è®¤ä¸¤ç§æœºåˆ¶éƒ½æ˜¯å…³é—­çŠ¶æ€ï¼Œéœ€è¦é€šè¿‡é…ç½®æ–‡ä»¶æ¥å¼€å¯ã€‚\n<a name=\"JOcDt\"></a>\n\n### å®ç°ç”Ÿäº§è€…ç¡®è®¤\n\n- **å¼€å¯ç”Ÿäº§è€…ç¡®è®¤é…ç½®**\n\nåœ¨`publisher`æ¨¡å—çš„`application.yaml`ä¸­æ·»åŠ é…ç½®ï¼š\n\n```yaml\nspring:\n  rabbitmq:\n    publisher-confirm-type: correlated # å¼€å¯publisher confirmæœºåˆ¶ï¼Œå¹¶è®¾ç½®confirmç±»å‹\n    publisher-returns: true # å¼€å¯publisher returnæœºåˆ¶\n```\n\nè¿™é‡Œ`publisher-confirm-type`æœ‰ä¸‰ç§æ¨¡å¼å¯é€‰ï¼š\n\n- `none`ï¼šå…³é—­`confirm`æœºåˆ¶\n- `simple`ï¼šåŒæ­¥é˜»å¡ç­‰å¾…MQçš„å›æ‰§\n- `correlated`ï¼šMQå¼‚æ­¥å›è°ƒè¿”å›å›æ‰§\n\nä¸€èˆ¬æˆ‘ä»¬æ¨èä½¿ç”¨`correlated`ï¼Œå›è°ƒæœºåˆ¶ã€‚\n\n- **å®šä¹‰`ReturnCallback`**\n\næ¯ä¸ª`RabbitTemplate`åªèƒ½é…ç½®ä¸€ä¸ª`ReturnCallback`ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨é…ç½®ç±»ä¸­ç»Ÿä¸€è®¾ç½®ã€‚æˆ‘ä»¬åœ¨`publisher`æ¨¡å—å®šä¹‰ä¸€ä¸ªé…ç½®ç±»ï¼š<br />![42.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_d0ca3a4228-42.png) <br />å†…å®¹å¦‚ä¸‹ï¼š\n\n```java\npackage com.itheima.publisher.config;\n\nimport lombok.AllArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.amqp.core.ReturnedMessage;\nimport org.springframework.amqp.rabbit.core.RabbitTemplate;\nimport org.springframework.context.annotation.Configuration;\n\nimport javax.annotation.PostConstruct;\n\n@Slf4j\n@AllArgsConstructor\n@Configuration\npublic class MqConfig {\n    private final RabbitTemplate rabbitTemplate;\n\n    @PostConstruct\n    public void init(){\n        rabbitTemplate.setReturnsCallback(new RabbitTemplate.ReturnsCallback() {\n            @Override\n            public void returnedMessage(ReturnedMessage returned) {\n                log.error(\"è§¦å‘return callback,\");\n                log.debug(\"exchange: {}\", returned.getExchange());\n                log.debug(\"routingKey: {}\", returned.getRoutingKey());\n                log.debug(\"message: {}\", returned.getMessage());\n                log.debug(\"replyCode: {}\", returned.getReplyCode());\n                log.debug(\"replyText: {}\", returned.getReplyText());\n            }\n        });\n    }\n}\n```\n\n- **å®šä¹‰`ConfirmCallback`**\n\nç”±äºæ¯ä¸ªæ¶ˆæ¯å‘é€æ—¶çš„å¤„ç†é€»è¾‘ä¸ä¸€å®šç›¸åŒï¼Œå› æ­¤`ConfirmCallback`éœ€è¦åœ¨æ¯æ¬¡å‘æ¶ˆæ¯æ—¶å®šä¹‰ã€‚å…·ä½“æ¥è¯´ï¼Œæ˜¯åœ¨è°ƒç”¨`RabbitTemplate`ä¸­çš„`convertAndSend`æ–¹æ³•æ—¶ï¼Œå¤šä¼ é€’ä¸€ä¸ªå‚æ•°ï¼š<br />![43.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_d4bda51b28-43.png) <br />è¿™é‡Œçš„`CorrelationData`ä¸­åŒ…å«ä¸¤ä¸ªæ ¸å¿ƒçš„ä¸œè¥¿ï¼š\n\n- `id`ï¼šæ¶ˆæ¯çš„å”¯ä¸€æ ‡ç¤ºï¼ŒMQå¯¹ä¸åŒçš„æ¶ˆæ¯çš„å›æ‰§ä»¥æ­¤åšåˆ¤æ–­ï¼Œé¿å…æ··æ·†\n- `SettableListenableFuture`ï¼šå›æ‰§ç»“æœçš„`Future`å¯¹è±¡\n\nå°†æ¥MQçš„å›æ‰§å°±ä¼šé€šè¿‡è¿™ä¸ª`Future`æ¥è¿”å›ï¼Œæˆ‘ä»¬å¯ä»¥æå‰ç»™`CorrelationData`ä¸­çš„`Future`æ·»åŠ å›è°ƒå‡½æ•°æ¥å¤„ç†æ¶ˆæ¯å›æ‰§ï¼š<br />![44.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_d889cf3028-44.png) <br />æˆ‘ä»¬æ–°å»ºä¸€ä¸ªæµ‹è¯•ï¼Œå‘ç³»ç»Ÿè‡ªå¸¦çš„äº¤æ¢æœºå‘é€æ¶ˆæ¯ï¼Œå¹¶ä¸”æ·»åŠ `ConfirmCallback`ï¼š\n\n```java\n@Test\nvoid testPublisherConfirm() {\n    // 1.åˆ›å»ºCorrelationData\n    CorrelationData cd = new CorrelationData();\n    // 2.ç»™Futureæ·»åŠ ConfirmCallback\n    cd.getFuture().addCallback(new ListenableFutureCallback<CorrelationData.Confirm>() {\n        @Override\n        public void onFailure(Throwable ex) {\n            // 2.1.Futureå‘ç”Ÿå¼‚å¸¸æ—¶çš„å¤„ç†é€»è¾‘ï¼ŒåŸºæœ¬ä¸ä¼šè§¦å‘\n            log.error(\"send message fail\", ex);\n        }\n        @Override\n        public void onSuccess(CorrelationData.Confirm result) {\n            // 2.2.Futureæ¥æ”¶åˆ°å›æ‰§çš„å¤„ç†é€»è¾‘ï¼Œå‚æ•°ä¸­çš„resultå°±æ˜¯å›æ‰§å†…å®¹\n            if(result.isAck()){ // result.isAck()ï¼Œbooleanç±»å‹ï¼Œtrueä»£è¡¨ackå›æ‰§ï¼Œfalse ä»£è¡¨ nackå›æ‰§\n                log.debug(\"å‘é€æ¶ˆæ¯æˆåŠŸï¼Œæ”¶åˆ° ack!\");\n            }else{ // result.getReason()ï¼ŒStringç±»å‹ï¼Œè¿”å›nackæ—¶çš„å¼‚å¸¸æè¿°\n                log.error(\"å‘é€æ¶ˆæ¯å¤±è´¥ï¼Œæ”¶åˆ° nack, reason : {}\", result.getReason());\n            }\n        }\n    });\n    // 3.å‘é€æ¶ˆæ¯\n    rabbitTemplate.convertAndSend(\"hmall.direct\", \"q\", \"hello\", cd);\n}\n```\n\næ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š<br />![45.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_dabe1d2928-45.png) <br />å¯ä»¥çœ‹åˆ°ï¼Œç”±äºä¼ é€’çš„`RoutingKey`æ˜¯é”™è¯¯çš„ï¼Œè·¯ç”±å¤±è´¥åï¼Œè§¦å‘äº†`return callback`ï¼ŒåŒæ—¶ä¹Ÿæ”¶åˆ°äº†`ack`ã€‚<br />å½“æˆ‘ä»¬ä¿®æ”¹ä¸ºæ­£ç¡®çš„`RoutingKey`ä»¥åï¼Œå°±ä¸ä¼šè§¦å‘`return callback`äº†ï¼Œåªæ”¶åˆ°`ack`ã€‚<br />è€Œå¦‚æœè¿äº¤æ¢æœºéƒ½æ˜¯é”™è¯¯çš„ï¼Œåˆ™åªä¼šæ”¶åˆ°`nack`ã€‚\n\n- **æ³¨æ„**ï¼š\n\n> å¼€å¯ç”Ÿäº§è€…ç¡®è®¤æ¯”è¾ƒæ¶ˆè€—MQæ€§èƒ½ï¼Œä¸€èˆ¬ä¸å»ºè®®å¼€å¯ã€‚è€Œä¸”å¤§å®¶æ€è€ƒä¸€ä¸‹è§¦å‘ç¡®è®¤çš„å‡ ç§æƒ…å†µï¼š\n>\n> - è·¯ç”±å¤±è´¥ï¼šä¸€èˆ¬æ˜¯å› ä¸ºRoutingKeyé”™è¯¯å¯¼è‡´ï¼Œå¾€å¾€æ˜¯ç¼–ç¨‹å¯¼è‡´\n> - äº¤æ¢æœºåç§°é”™è¯¯ï¼šåŒæ ·æ˜¯ç¼–ç¨‹é”™è¯¯å¯¼è‡´\n> - MQå†…éƒ¨æ•…éšœï¼šè¿™ç§éœ€è¦å¤„ç†ï¼Œä½†æ¦‚ç‡å¾€å¾€è¾ƒä½ã€‚å› æ­¤åªæœ‰å¯¹æ¶ˆæ¯å¯é æ€§è¦æ±‚éå¸¸é«˜çš„ä¸šåŠ¡æ‰éœ€è¦å¼€å¯ï¼Œè€Œä¸”ä»…ä»…éœ€è¦å¼€å¯ConfirmCallbackå¤„ç†nackå°±å¯ä»¥äº†ã€‚\n\n<a name=\"QROB7\"></a>\n\n# MQçš„å¯é æ€§\n\næ¶ˆæ¯åˆ°è¾¾MQä»¥åï¼Œå¦‚æœMQä¸èƒ½åŠæ—¶ä¿å­˜ï¼Œä¹Ÿä¼šå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼Œæ‰€ä»¥MQçš„å¯é æ€§ä¹Ÿéå¸¸é‡è¦ã€‚\n<a name=\"qqfiH\"></a>\n\n## æ•°æ®æŒä¹…åŒ–\n\nä¸ºäº†æå‡æ€§èƒ½ï¼Œé»˜è®¤æƒ…å†µä¸‹MQçš„æ•°æ®éƒ½æ˜¯åœ¨å†…å­˜å­˜å‚¨çš„ä¸´æ—¶æ•°æ®ï¼Œé‡å¯åå°±ä¼šæ¶ˆå¤±ã€‚ä¸ºäº†ä¿è¯æ•°æ®çš„å¯é æ€§ï¼Œå¿…é¡»é…ç½®æ•°æ®æŒä¹…åŒ–ï¼ŒåŒ…æ‹¬ï¼š\n\n- äº¤æ¢æœºæŒä¹…åŒ–\n- é˜Ÿåˆ—æŒä¹…åŒ–\n- æ¶ˆæ¯æŒä¹…åŒ–\n  <a name=\"WKQaI\"></a>\n\n### äº¤æ¢æœºæŒä¹…åŒ–\n\nåœ¨æ§åˆ¶å°çš„`Exchanges`é¡µé¢ï¼Œæ·»åŠ äº¤æ¢æœºæ—¶å¯ä»¥é…ç½®äº¤æ¢æœºçš„`Durability`å‚æ•°ï¼š<br />![46.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_de58774228-46.png) <br />è®¾ç½®ä¸º`Durable`å°±æ˜¯æŒä¹…åŒ–æ¨¡å¼ï¼Œ`Transient`å°±æ˜¯ä¸´æ—¶æ¨¡å¼ã€‚\n<a name=\"QbF20\"></a>\n\n### é˜Ÿåˆ—æŒä¹…åŒ–\n\nåœ¨æ§åˆ¶å°çš„Queuesé¡µé¢ï¼Œæ·»åŠ é˜Ÿåˆ—æ—¶ï¼ŒåŒæ ·å¯ä»¥é…ç½®é˜Ÿåˆ—çš„`Durability`å‚æ•°ï¼š<br />![47.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_e1607d8428-47.png)\n<a name=\"ANwL9\"></a>\n\n### æ¶ˆæ¯æŒä¹…åŒ–\n\nåœ¨æ§åˆ¶å°å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œå¯ä»¥æ·»åŠ å¾ˆå¤šå‚æ•°ï¼Œè€Œæ¶ˆæ¯çš„æŒä¹…åŒ–æ˜¯è¦é…ç½®ä¸€ä¸ª`properties`ï¼š<br />![48.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_e3a897c328-48.png) <br />**æ³¨æ„**ï¼šåœ¨å¼€å¯æŒä¹…åŒ–æœºåˆ¶ä»¥åï¼Œå¦‚æœåŒæ—¶è¿˜å¼€å¯äº†ç”Ÿäº§è€…ç¡®è®¤ï¼Œé‚£ä¹ˆMQä¼šåœ¨æ¶ˆæ¯æŒä¹…åŒ–ä»¥åæ‰å‘é€ACKå›æ‰§ï¼Œè¿›ä¸€æ­¥ç¡®ä¿æ¶ˆæ¯çš„å¯é æ€§ã€‚<br />ä¸è¿‡å‡ºäºæ€§èƒ½è€ƒè™‘ï¼Œä¸ºäº†å‡å°‘IOæ¬¡æ•°ï¼Œå‘é€åˆ°MQçš„æ¶ˆæ¯å¹¶ä¸æ˜¯é€æ¡æŒä¹…åŒ–åˆ°æ•°æ®åº“çš„ï¼Œè€Œæ˜¯æ¯éš”ä¸€æ®µæ—¶é—´æ‰¹é‡æŒä¹…åŒ–ã€‚ä¸€èˆ¬é—´éš”åœ¨100æ¯«ç§’å·¦å³ï¼Œè¿™å°±ä¼šå¯¼è‡´ACKæœ‰ä¸€å®šçš„å»¶è¿Ÿï¼Œå› æ­¤å»ºè®®ç”Ÿäº§è€…ç¡®è®¤å…¨éƒ¨é‡‡ç”¨å¼‚æ­¥æ–¹å¼ã€‚\n<a name=\"B0PcB\"></a>\n\n## LazyQueue\n\nåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒRabbitMQä¼šå°†æ¥æ”¶åˆ°çš„ä¿¡æ¯ä¿å­˜åœ¨å†…å­˜ä¸­ä»¥é™ä½æ¶ˆæ¯æ”¶å‘çš„å»¶è¿Ÿã€‚ä½†åœ¨æŸäº›ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œè¿™ä¼šå¯¼è‡´æ¶ˆæ¯ç§¯å‹ï¼Œæ¯”å¦‚ï¼š\n\n- æ¶ˆè´¹è€…å®•æœºæˆ–å‡ºç°ç½‘ç»œæ•…éšœ\n- æ¶ˆæ¯å‘é€é‡æ¿€å¢ï¼Œè¶…è¿‡äº†æ¶ˆè´¹è€…å¤„ç†é€Ÿåº¦\n- æ¶ˆè´¹è€…å¤„ç†ä¸šåŠ¡å‘ç”Ÿé˜»å¡\n\nä¸€æ—¦å‡ºç°æ¶ˆæ¯å †ç§¯é—®é¢˜ï¼ŒRabbitMQçš„å†…å­˜å ç”¨å°±ä¼šè¶Šæ¥è¶Šé«˜ï¼Œç›´åˆ°è§¦å‘å†…å­˜é¢„è­¦ä¸Šé™ã€‚æ­¤æ—¶RabbitMQä¼šå°†å†…å­˜æ¶ˆæ¯åˆ·åˆ°ç£ç›˜ä¸Šï¼Œè¿™ä¸ªè¡Œä¸ºæˆä¸º`PageOut`ã€‚`PageOut`ä¼šè€—è´¹ä¸€æ®µæ—¶é—´ï¼Œå¹¶ä¸”ä¼šé˜»å¡é˜Ÿåˆ—è¿›ç¨‹ã€‚å› æ­¤åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­RabbitMQä¸ä¼šå†å¤„ç†æ–°çš„æ¶ˆæ¯ï¼Œç”Ÿäº§è€…çš„æ‰€æœ‰è¯·æ±‚éƒ½ä¼šè¢«é˜»å¡ã€‚<br />ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä»RabbitMQçš„3.6.0ç‰ˆæœ¬å¼€å§‹ï¼Œå°±å¢åŠ äº†`Lazy Queues`çš„æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯æƒ°æ€§é˜Ÿåˆ—ã€‚æƒ°æ€§é˜Ÿåˆ—çš„ç‰¹å¾å¦‚ä¸‹ï¼š\n\n- æ¥æ”¶åˆ°æ¶ˆæ¯åç›´æ¥å­˜å…¥ç£ç›˜è€Œéå†…å­˜\n- æ¶ˆè´¹è€…è¦æ¶ˆè´¹æ¶ˆæ¯æ—¶æ‰ä¼šä»ç£ç›˜ä¸­è¯»å–å¹¶åŠ è½½åˆ°å†…å­˜ï¼ˆä¹Ÿå°±æ˜¯æ‡’åŠ è½½ï¼‰\n- æ”¯æŒæ•°ç™¾ä¸‡æ¡çš„æ¶ˆæ¯å­˜å‚¨\n\n> ä½¿ç”¨æƒ°æ€§é˜Ÿåˆ—çš„æ€§èƒ½æ›´å¥½çš„åŸå› æ˜¯æ¥æ”¶åˆ°æ¶ˆæ¯ç›´æ¥å­˜å…¥ç£ç›˜ï¼Œé¿å…äº†éæŒä¹…åŒ–çš„æƒ…å†µä¸‹ï¼Œå†…å­˜æ»¡æ—¶éœ€è¦å‘ç£ç›˜ä¸­`Pageout`ï¼Œæ­¤æ—¶mqä¸èƒ½æ¥æ”¶æ¶ˆæ¯ã€‚åŒæ—¶å¯¹ç£ç›˜çš„`io`è¿›è¡Œäº†ä¼˜åŒ–ï¼Œä½¿å…¶æ•ˆç‡æ›´é«˜\n\nè€Œåœ¨3.12ç‰ˆæœ¬ä¹‹åï¼Œ`LazyQueue`å·²ç»æˆä¸ºæ‰€æœ‰é˜Ÿåˆ—çš„é»˜è®¤æ ¼å¼ã€‚å› æ­¤å®˜æ–¹æ¨èå‡çº§MQä¸º3.12ç‰ˆæœ¬æˆ–è€…æ‰€æœ‰é˜Ÿåˆ—éƒ½è®¾ç½®ä¸º`LazyQueue`æ¨¡å¼ã€‚\n<a name=\"pWgjL\"></a>\n\n# æ¶ˆè´¹è€…å¯é æ€§\n\nå½“RabbitMQå‘æ¶ˆè´¹è€…æŠ•é€’æ¶ˆæ¯ä»¥åï¼Œéœ€è¦çŸ¥é“æ¶ˆè´¹è€…çš„å¤„ç†çŠ¶æ€å¦‚ä½•ã€‚å› ä¸ºæ¶ˆæ¯æŠ•é€’ç»™æ¶ˆè´¹è€…å¹¶ä¸ä»£è¡¨å°±ä¸€å®šè¢«æ­£ç¡®æ¶ˆè´¹äº†ï¼Œå¯èƒ½å‡ºç°çš„æ•…éšœæœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ï¼š\n\n- æ¶ˆæ¯æŠ•é€’çš„è¿‡ç¨‹ä¸­å‡ºç°äº†ç½‘ç»œæ•…éšœ\n- æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯åçªç„¶å®•æœº\n- æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œå› å¤„ç†ä¸å½“å¯¼è‡´å¼‚å¸¸\n\nä¸€æ—¦å‘ç”Ÿä¸Šè¿°æƒ…å†µï¼Œæ¶ˆæ¯ä¹Ÿä¼šä¸¢å¤±ã€‚å› æ­¤ï¼ŒRabbitMQå¿…é¡»çŸ¥é“æ¶ˆè´¹è€…çš„å¤„ç†çŠ¶æ€ï¼Œä¸€æ—¦æ¶ˆæ¯å¤„ç†å¤±è´¥æ‰èƒ½é‡æ–°æŠ•é€’æ¶ˆæ¯ã€‚<br />æœ¬ç« å°†ç ”ç©¶æ¶ˆè´¹è€…å¤„ç†æ¶ˆæ¯æ—¶çš„å¯é æ€§è§£å†³æ–¹æ¡ˆã€‚\n<a name=\"k9AlT\"></a>\n\n## æ¶ˆè´¹è€…ç¡®è®¤æœºåˆ¶\n\nä¸ºäº†ç¡®è®¤æ¶ˆè´¹è€…æ˜¯å¦æˆåŠŸå¤„ç†æ¶ˆæ¯ï¼ŒRabbitMQæä¾›äº†æ¶ˆè´¹è€…ç¡®è®¤æœºåˆ¶ï¼ˆ`Consumer Acknowledgement`ï¼‰ã€‚å³ï¼šå½“æ¶ˆè´¹è€…å¤„ç†æ¶ˆæ¯ç»“æŸåï¼Œåº”è¯¥å‘RabbitMQå‘é€ä¸€ä¸ªå›æ‰§ï¼Œå‘ŠçŸ¥RabbitMQè‡ªå·±æ¶ˆæ¯å¤„ç†çŠ¶æ€ã€‚å›æ‰§æœ‰ä¸‰ç§å¯é€‰å€¼ï¼š\n\n- `ack`ï¼šæˆåŠŸå¤„ç†æ¶ˆæ¯ï¼ŒRabbitMQä»é˜Ÿåˆ—ä¸­åˆ é™¤è¯¥æ¶ˆæ¯\n- `nack`ï¼šæ¶ˆæ¯å¤„ç†å¤±è´¥ï¼ŒRabbitMQéœ€è¦å†æ¬¡æŠ•é€’æ¶ˆæ¯\n- `reject`ï¼šæ¶ˆæ¯å¤„ç†å¤±è´¥å¹¶æ‹’ç»è¯¥æ¶ˆæ¯ï¼ŒRabbitMQä»é˜Ÿåˆ—ä¸­åˆ é™¤è¯¥æ¶ˆæ¯\n\nä¸€èˆ¬`reject`æ–¹å¼ç”¨çš„è¾ƒå°‘ï¼Œé™¤éæ˜¯æ¶ˆæ¯æ ¼å¼æœ‰é—®é¢˜ï¼Œé‚£å°±æ˜¯å¼€å‘é—®é¢˜äº†ã€‚å› æ­¤å¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬éœ€è¦å°†æ¶ˆæ¯å¤„ç†çš„ä»£ç é€šè¿‡`try catch`æœºåˆ¶æ•è·ï¼Œæ¶ˆæ¯å¤„ç†æˆåŠŸæ—¶è¿”å›`ack`ï¼Œå¤„ç†å¤±è´¥æ—¶è¿”å›`nack`ã€‚<br />ç”±äºæ¶ˆæ¯å›æ‰§çš„å¤„ç†ä»£ç æ¯”è¾ƒç»Ÿä¸€ï¼Œå› æ­¤`SpringAMQP`å¸®æˆ‘ä»¬å®ç°äº†æ¶ˆæ¯ç¡®è®¤ã€‚å¹¶å…è®¸æˆ‘ä»¬é€šè¿‡é…ç½®æ–‡ä»¶è®¾ç½®`ACK`å¤„ç†æ–¹å¼ï¼Œæœ‰ä¸‰ç§æ¨¡å¼ï¼š\n\n- `none`ï¼šä¸å¤„ç†ã€‚å³æ¶ˆæ¯æŠ•é€’ç»™æ¶ˆè´¹è€…åç«‹åˆ»`ack`ï¼Œæ¶ˆæ¯ä¼šç«‹åˆ»ä»MQåˆ é™¤ã€‚éå¸¸ä¸å®‰å…¨ï¼Œä¸å»ºè®®ä½¿ç”¨\n- `manual`ï¼šæ‰‹åŠ¨æ¨¡å¼ã€‚éœ€è¦è‡ªå·±åœ¨ä¸šåŠ¡ä»£ç ä¸­è°ƒç”¨`api`ï¼Œå‘é€`ack`æˆ–`reject`ï¼Œå­˜åœ¨ä¸šåŠ¡å…¥ä¾µï¼Œä½†æ›´çµæ´»\n- `auto`ï¼šè‡ªåŠ¨æ¨¡å¼ã€‚`SpringAMQP`åˆ©ç”¨`AOP`å¯¹æˆ‘ä»¬çš„æ¶ˆæ¯å¤„ç†é€»è¾‘åšäº†ç¯ç»•å¢å¼ºï¼Œå½“ä¸šåŠ¡æ­£å¸¸æ‰§è¡Œæ—¶åˆ™è‡ªåŠ¨è¿”å›`ack`ã€‚å½“ä¸šåŠ¡å‡ºç°å¼‚å¸¸æ—¶ï¼Œæ ¹æ®å¼‚å¸¸åˆ¤æ–­è¿”å›ä¸åŒç»“æœï¼š\n    - å¦‚æœæ˜¯**ä¸šåŠ¡å¼‚å¸¸**ï¼Œä¼šè‡ªåŠ¨è¿”å›`nack`ï¼›\n    - å¦‚æœæ˜¯**æ¶ˆæ¯å¤„ç†æˆ–æ ¡éªŒå¼‚å¸¸**ï¼Œè‡ªåŠ¨è¿”å›`reject`;\n\n> è¿”å›Rejectçš„å¸¸è§å¼‚å¸¸æœ‰ï¼š\n> Starting with version 1.3.2, the default ErrorHandler is now a ConditionalRejectingErrorHandler that rejects (and does not requeue) messages that fail with an irrecoverable error. Specifically, it rejects messages that fail with the following errors:\n>\n> - o.s.amqpâ€¦MessageConversionException: Can be thrown when converting the incoming message payload using a MessageConverter.\n> - o.s.messagingâ€¦MessageConversionException: Can be thrown by the conversion service if additional conversion is required when mapping to a @RabbitListener method.\n> - o.s.messagingâ€¦MethodArgumentNotValidException: Can be thrown if validation (for example, @Valid) is used in the listener and the validation fails.\n> - o.s.messagingâ€¦MethodArgumentTypeMismatchException: Can be thrown if the inbound message was converted to a type that is not correct for the target method. For example, the parameter is declared as Message<Foo> but Message<Bar> is received.\n> - java.lang.NoSuchMethodException: Added in version 1.6.3.\n> - java.lang.ClassCastException: Added in version 1.6.3.\n\né€šè¿‡ä¸‹é¢çš„é…ç½®å¯ä»¥ä¿®æ”¹`SpringAMQP`çš„`ACK`å¤„ç†æ–¹å¼ï¼š\n\n```yaml\nspring:\n  rabbitmq:\n    listener:\n      simple:\n        acknowledge-mode: none # ä¸åšå¤„ç†\n```\n\nä¿®æ”¹`consumer`æœåŠ¡çš„`SpringRabbitListener`ç±»ä¸­çš„æ–¹æ³•ï¼Œæ¨¡æ‹Ÿä¸€ä¸ªæ¶ˆæ¯å¤„ç†çš„å¼‚å¸¸ï¼š\n\n```java\n@RabbitListener(queues = \"simple.queue\")\npublic void listenSimpleQueueMessage(String msg) throws InterruptedException {\n    log.info(\"spring æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€\" + msg + \"ã€‘\");\n    if (true) {\n        throw new MessageConversionException(\"æ•…æ„çš„\");\n    }\n    log.info(\"æ¶ˆæ¯å¤„ç†å®Œæˆ\");\n}\n```\n\næµ‹è¯•å¯ä»¥å‘ç°ï¼šå½“æ¶ˆæ¯å¤„ç†å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œæ¶ˆæ¯ä¾ç„¶è¢«RabbitMQåˆ é™¤äº†ã€‚<br />æˆ‘ä»¬å†æ¬¡æŠŠç¡®è®¤æœºåˆ¶ä¿®æ”¹ä¸º`auto`ï¼š\n\n```yaml\nspring:\n  rabbitmq:\n    listener:\n      simple:\n        acknowledge-mode: auto # è‡ªåŠ¨ack\n```\n\nåœ¨å¼‚å¸¸ä½ç½®æ‰“æ–­ç‚¹ï¼Œå†æ¬¡å‘é€æ¶ˆæ¯ï¼Œç¨‹åºå¡åœ¨æ–­ç‚¹æ—¶ï¼Œå¯ä»¥å‘ç°æ­¤æ—¶æ¶ˆæ¯çŠ¶æ€ä¸º`unacked`ï¼ˆæœªç¡®å®šçŠ¶æ€ï¼‰ï¼š<br />![49.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_e62519f628-49.png) <br />æ”¾è¡Œä»¥åï¼Œç”±äºæŠ›å‡ºçš„æ˜¯**æ¶ˆæ¯è½¬æ¢å¼‚å¸¸**ï¼Œå› æ­¤`Spring`ä¼šè‡ªåŠ¨è¿”å›`reject`ï¼Œæ‰€ä»¥æ¶ˆæ¯ä¾ç„¶ä¼šè¢«åˆ é™¤ï¼š<br />![50.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_e904ada828-50.png) <br />æˆ‘ä»¬å°†å¼‚å¸¸æ”¹ä¸º`RuntimeException`ç±»å‹ï¼š\n\n```java\n@RabbitListener(queues = \"simple.queue\")\npublic void listenSimpleQueueMessage(String msg) throws InterruptedException {\n    log.info(\"spring æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€\" + msg + \"ã€‘\");\n    if (true) {\n        throw new RuntimeException(\"æ•…æ„çš„\");\n    }\n    log.info(\"æ¶ˆæ¯å¤„ç†å®Œæˆ\");\n}\n```\n\nåœ¨å¼‚å¸¸ä½ç½®æ‰“æ–­ç‚¹ï¼Œç„¶åå†æ¬¡å‘é€æ¶ˆæ¯æµ‹è¯•ï¼Œç¨‹åºå¡åœ¨æ–­ç‚¹æ—¶ï¼Œå¯ä»¥å‘ç°æ­¤æ—¶æ¶ˆæ¯çŠ¶æ€ä¸º`unacked`ï¼ˆæœªç¡®å®šçŠ¶æ€ï¼‰ï¼š<br />![51.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_eb2131ee28-51.png) <br />æ”¾è¡Œä»¥åï¼Œç”±äºæŠ›å‡ºçš„æ˜¯ä¸šåŠ¡å¼‚å¸¸ï¼Œæ‰€ä»¥`Spring`è¿”å›`ack`ï¼Œæœ€ç»ˆæ¶ˆæ¯æ¢å¤è‡³`Ready`çŠ¶æ€ï¼Œå¹¶ä¸”æ²¡æœ‰è¢«RabbitMQåˆ é™¤ï¼š<br />![52.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_ee2bb84428-52.png) <br />å½“æˆ‘ä»¬æŠŠé…ç½®æ”¹ä¸º`auto`æ—¶ï¼Œæ¶ˆæ¯å¤„ç†å¤±è´¥åï¼Œä¼šå›åˆ°RabbitMQï¼Œå¹¶é‡æ–°æŠ•é€’åˆ°æ¶ˆè´¹è€…ã€‚\n<a name=\"Xzeia\"></a>\n\n## å¤±è´¥é‡è¯•æœºåˆ¶\n\nå½“æ¶ˆè´¹è€…å‡ºç°å¼‚å¸¸åï¼Œæ¶ˆæ¯ä¼šä¸æ–­`requeue`ï¼ˆé‡å…¥é˜Ÿï¼‰åˆ°é˜Ÿåˆ—ï¼Œå†é‡æ–°å‘é€ç»™æ¶ˆè´¹è€…ã€‚å¦‚æœæ¶ˆè´¹è€…å†æ¬¡æ‰§è¡Œä¾ç„¶å‡ºé”™ï¼Œæ¶ˆæ¯ä¼šå†æ¬¡`requeue`åˆ°é˜Ÿåˆ—ï¼Œå†æ¬¡æŠ•é€’ï¼Œç›´åˆ°æ¶ˆæ¯å¤„ç†æˆåŠŸä¸ºæ­¢ã€‚<br />æç«¯æƒ…å†µå°±æ˜¯æ¶ˆè´¹è€…ä¸€ç›´æ— æ³•æ‰§è¡ŒæˆåŠŸï¼Œé‚£ä¹ˆæ¶ˆæ¯`requeue`å°±ä¼šæ— é™å¾ªç¯ï¼Œå¯¼è‡´MQçš„æ¶ˆæ¯å¤„ç†é£™å‡ï¼Œå¸¦æ¥ä¸å¿…è¦çš„å‹åŠ›ï¼š<br />![53.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_f02d033d28-53.png) <br />å½“ç„¶ï¼Œä¸Šè¿°æç«¯æƒ…å†µå‘ç”Ÿçš„æ¦‚ç‡è¿˜æ˜¯éå¸¸ä½çš„ï¼Œä¸è¿‡ä¸æ€•ä¸€ä¸‡å°±æ€•ä¸‡ä¸€ã€‚ä¸ºäº†åº”å¯¹ä¸Šè¿°æƒ…å†µ`Spring`åˆæä¾›äº†æ¶ˆè´¹è€…å¤±è´¥é‡è¯•æœºåˆ¶ï¼šåœ¨æ¶ˆè´¹è€…å‡ºç°å¼‚å¸¸æ—¶åˆ©ç”¨æœ¬åœ°é‡è¯•ï¼Œè€Œä¸æ˜¯æ— é™åˆ¶çš„`requeue`åˆ°MQé˜Ÿåˆ—ã€‚<br />ä¿®æ”¹`consumer`æœåŠ¡çš„`application.yml`æ–‡ä»¶ï¼Œæ·»åŠ å†…å®¹ï¼š\n\n```yaml\nspring:\n  rabbitmq:\n    listener:\n      simple:\n        retry:\n          enabled: true # å¼€å¯æ¶ˆè´¹è€…å¤±è´¥é‡è¯•\n          initial-interval: 1000ms # åˆè¯†çš„å¤±è´¥ç­‰å¾…æ—¶é•¿ä¸º1ç§’\n          multiplier: 1 # å¤±è´¥çš„ç­‰å¾…æ—¶é•¿å€æ•°ï¼Œä¸‹æ¬¡ç­‰å¾…æ—¶é•¿ = multiplier * last-interval\n          max-attempts: 3 # æœ€å¤§é‡è¯•æ¬¡æ•°\n          stateless: true # trueæ— çŠ¶æ€ï¼›falseæœ‰çŠ¶æ€ã€‚å¦‚æœä¸šåŠ¡ä¸­åŒ…å«äº‹åŠ¡ï¼Œè¿™é‡Œæ”¹ä¸ºfalse\n```\n\né‡å¯`consumer`æœåŠ¡ï¼Œé‡å¤ä¹‹å‰çš„æµ‹è¯•ã€‚å¯ä»¥å‘ç°ï¼š\n\n- æ¶ˆè´¹è€…åœ¨å¤±è´¥åæ¶ˆæ¯æ²¡æœ‰é‡æ–°å›åˆ°MQæ— é™é‡æ–°æŠ•é€’ï¼Œè€Œæ˜¯åœ¨æœ¬åœ°é‡è¯•äº†`3`æ¬¡\n- æœ¬åœ°é‡è¯•`3`æ¬¡ä»¥åï¼ŒæŠ›å‡ºäº†`AmqpRejectAndDontRequeueException`å¼‚å¸¸ã€‚æŸ¥çœ‹RabbitMQæ§åˆ¶å°ï¼Œå‘ç°æ¶ˆæ¯è¢«åˆ é™¤äº†ï¼Œè¯´æ˜æœ€å`SpringAMQP`è¿”å›çš„æ˜¯`reject`\n\n**ç»“è®ºï¼š**\n\n- å¼€å¯æœ¬åœ°é‡è¯•æ—¶ï¼Œæ¶ˆæ¯å¤„ç†è¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œä¸ä¼š`requeue`åˆ°é˜Ÿåˆ—ï¼Œè€Œæ˜¯åœ¨æ¶ˆè´¹è€…æœ¬åœ°é‡è¯•\n- é‡è¯•è¾¾åˆ°æœ€å¤§æ¬¡æ•°åï¼Œ`Spring`ä¼šè¿”å›`reject`ï¼Œæ¶ˆæ¯ä¼šè¢«ä¸¢å¼ƒ\n  <a name=\"IammB\"></a>\n\n## å¤±è´¥å¤„ç†ç­–ç•¥\n\nåœ¨ä¹‹å‰çš„æµ‹è¯•ä¸­ï¼Œæœ¬åœ°æµ‹è¯•è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°åï¼Œæ¶ˆæ¯ä¼šè¢«ä¸¢å¼ƒã€‚è¿™åœ¨æŸäº›å¯¹äºæ¶ˆæ¯å¯é æ€§è¦æ±‚è¾ƒé«˜çš„ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œæ˜¾ç„¶ä¸å¤ªåˆé€‚äº†ã€‚<br />å› æ­¤`Spring`å…è®¸æˆ‘ä»¬è‡ªå®šä¹‰é‡è¯•æ¬¡æ•°è€—å°½åçš„æ¶ˆæ¯å¤„ç†ç­–ç•¥ï¼Œè¿™ä¸ªç­–ç•¥æ˜¯ç”±`MessageRecovery`æ¥å£æ¥å®šä¹‰çš„ï¼Œå®ƒæœ‰3ä¸ªä¸åŒå®ç°ï¼š\n\n- `RejectAndDontRequeueRecoverer`ï¼šé‡è¯•è€—å°½åï¼Œç›´æ¥`reject`ï¼Œä¸¢å¼ƒæ¶ˆæ¯ã€‚é»˜è®¤å°±æ˜¯è¿™ç§æ–¹å¼\n- `ImmediateRequeueMessageRecoverer`ï¼šé‡è¯•è€—å°½åï¼Œè¿”å›`nack`ï¼Œæ¶ˆæ¯é‡æ–°å…¥é˜Ÿ\n- `RepublishMessageRecoverer`ï¼šé‡è¯•è€—å°½åï¼Œå°†å¤±è´¥æ¶ˆæ¯æŠ•é€’åˆ°æŒ‡å®šçš„äº¤æ¢æœº\n\næ¯”è¾ƒä¼˜é›…çš„ä¸€ç§å¤„ç†æ–¹æ¡ˆæ˜¯`RepublishMessageRecoverer`ï¼Œå¤±è´¥åå°†æ¶ˆæ¯æŠ•é€’åˆ°ä¸€ä¸ªæŒ‡å®šçš„ï¼Œä¸“é—¨å­˜æ”¾å¼‚å¸¸æ¶ˆæ¯çš„é˜Ÿåˆ—ï¼Œåç»­ç”±äººå·¥é›†ä¸­å¤„ç†ã€‚\n\n- åœ¨`consumer`æœåŠ¡ä¸­å®šä¹‰å¤„ç†å¤±è´¥æ¶ˆæ¯çš„äº¤æ¢æœºå’Œé˜Ÿåˆ—\n\n```java\n@Bean\npublic DirectExchange errorMessageExchange(){\n    return new DirectExchange(\"error.direct\");\n}\n@Bean\npublic Queue errorQueue(){\n    return new Queue(\"error.queue\", true);\n}\n@Bean\npublic Binding errorBinding(Queue errorQueue, DirectExchange errorMessageExchange){\n    return BindingBuilder.bind(errorQueue).to(errorMessageExchange).with(\"error\");\n}\n```\n\n- å®šä¹‰ä¸€ä¸ª`RepublishMessageRecoverer`ï¼Œå…³è”é˜Ÿåˆ—å’Œäº¤æ¢æœº\n\n```java\n@Bean\npublic MessageRecoverer republishMessageRecoverer(RabbitTemplate rabbitTemplate){\nreturn new RepublishMessageRecoverer(rabbitTemplate, \"error.direct\", \"error\");\n}\n```\n\nå®Œæ•´ä»£ç å¦‚ä¸‹ï¼š\n\n```java\npackage com.itheima.consumer.config;\n\nimport org.springframework.amqp.core.Binding;\nimport org.springframework.amqp.core.BindingBuilder;\nimport org.springframework.amqp.core.DirectExchange;\nimport org.springframework.amqp.core.Queue;\nimport org.springframework.amqp.rabbit.core.RabbitTemplate;\nimport org.springframework.amqp.rabbit.retry.MessageRecoverer;\nimport org.springframework.amqp.rabbit.retry.RepublishMessageRecoverer;\nimport org.springframework.context.annotation.Bean;\n\n@Configuration\n@ConditionalOnProperty(name = \"spring.rabbitmq.listener.simple.retry.enabled\", havingValue = \"true\")\npublic class ErrorMessageConfig {\n    @Bean\n    public DirectExchange errorMessageExchange(){\n        return new DirectExchange(\"error.direct\");\n    }\n    @Bean\n    public Queue errorQueue(){\n        return new Queue(\"error.queue\", true);\n    }\n    @Bean\n    public Binding errorBinding(Queue errorQueue, DirectExchange errorMessageExchange){\n        return BindingBuilder.bind(errorQueue).to(errorMessageExchange).with(\"error\");\n    }\n\n    @Bean\n    public MessageRecoverer republishMessageRecoverer(RabbitTemplate rabbitTemplate){\n        return new RepublishMessageRecoverer(rabbitTemplate, \"error.direct\", \"error\");\n    }\n}\n```\n\n<a name=\"nEB1y\"></a>\n\n# æ¶ˆæ¯å¯é æ€§å…œåº•æ–¹æ¡ˆ\n\nè™½ç„¶æˆ‘ä»¬åˆ©ç”¨å„ç§æœºåˆ¶å°½å¯èƒ½å¢åŠ äº†æ¶ˆæ¯çš„å¯é æ€§ï¼Œä½†ä¹Ÿä¸å¥½è¯´èƒ½ä¿è¯æ¶ˆæ¯100%çš„å¯é ã€‚ä¸‡ä¸€çœŸçš„MQé€šçŸ¥å¤±è´¥è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ<br />æœ‰æ²¡æœ‰å…¶å®ƒå…œåº•æ–¹æ¡ˆï¼Œèƒ½å¤Ÿç¡®ä¿è®¢å•çš„æ”¯ä»˜çŠ¶æ€ä¸€è‡´å‘¢ï¼Ÿ<br />å…¶å®æ€æƒ³å¾ˆç®€å•ï¼šæ—¢ç„¶MQé€šçŸ¥ä¸ä¸€å®šå‘é€åˆ°äº¤æ˜“æœåŠ¡ï¼Œé‚£ä¹ˆäº¤æ˜“æœåŠ¡å°±å¿…é¡»è‡ªå·±**ä¸»åŠ¨å»æŸ¥è¯¢**æ”¯ä»˜çŠ¶æ€ã€‚è¿™æ ·å³ä¾¿æ”¯ä»˜æœåŠ¡çš„MQé€šçŸ¥å¤±è´¥ï¼Œæˆ‘ä»¬ä¾ç„¶èƒ½é€šè¿‡ä¸»åŠ¨æŸ¥è¯¢æ¥ä¿è¯è®¢å•çŠ¶æ€çš„ä¸€è‡´ã€‚<br />**æµç¨‹å¦‚ä¸‹ï¼š**<br />![54.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_f284f09f28-54.png) <br />å›¾ä¸­é»„è‰²çº¿åœˆèµ·æ¥çš„éƒ¨åˆ†å°±æ˜¯MQé€šçŸ¥å¤±è´¥åçš„å…œåº•å¤„ç†æ–¹æ¡ˆï¼Œç”±äº¤æ˜“æœåŠ¡è‡ªå·±ä¸»åŠ¨å»æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€ã€‚<br />ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œäº¤æ˜“æœåŠ¡å¹¶ä¸çŸ¥é“ç”¨æˆ·ä¼šåœ¨ä»€ä¹ˆæ—¶å€™æ”¯ä»˜ï¼Œå¦‚æœæŸ¥è¯¢çš„æ—¶æœºä¸æ­£ç¡®ï¼ˆæ¯”å¦‚æŸ¥è¯¢çš„æ—¶å€™ç”¨æˆ·æ­£åœ¨æ”¯ä»˜ä¸­ï¼‰ï¼Œå¯èƒ½æŸ¥è¯¢åˆ°çš„æ”¯ä»˜çŠ¶æ€ä¹Ÿä¸æ­£ç¡®ã€‚<br />é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæˆ‘ä»¬åˆ°åº•è¯¥åœ¨ä»€ä¹ˆæ—¶é—´ä¸»åŠ¨æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€å‘¢ï¼Ÿ<br />è¿™ä¸ªæ—¶é—´æ˜¯æ— æ³•ç¡®å®šçš„ï¼Œå› æ­¤ï¼Œé€šå¸¸æˆ‘ä»¬é‡‡å–çš„æªæ–½å°±æ˜¯åˆ©ç”¨**å®šæ—¶ä»»åŠ¡**å®šæœŸæŸ¥è¯¢ï¼Œä¾‹å¦‚æ¯éš”20ç§’å°±æŸ¥è¯¢ä¸€æ¬¡ï¼Œå¹¶åˆ¤æ–­æ”¯ä»˜çŠ¶æ€ã€‚å¦‚æœå‘ç°è®¢å•å·²ç»æ”¯ä»˜ï¼Œåˆ™ç«‹åˆ»æ›´æ–°è®¢å•çŠ¶æ€ä¸ºå·²æ”¯ä»˜å³å¯ã€‚<br />è‡³æ­¤ï¼Œæ¶ˆæ¯å¯é æ€§çš„é—®é¢˜å·²ç»è§£å†³äº†ã€‚<br />**ç»¼ä¸Šï¼Œæ”¯ä»˜æœåŠ¡ä¸äº¤æ˜“æœåŠ¡ä¹‹é—´çš„è®¢å•çŠ¶æ€ä¸€è‡´æ€§æ˜¯å¦‚ä½•ä¿è¯çš„ï¼Ÿ**\n\n- **é¦–å…ˆï¼Œæ”¯ä»˜æœåŠ¡ä¼šæ­£åœ¨ç”¨æˆ·æ”¯ä»˜æˆåŠŸä»¥ååˆ©ç”¨MQæ¶ˆæ¯é€šçŸ¥äº¤æ˜“æœåŠ¡ï¼Œå®Œæˆè®¢å•çŠ¶æ€åŒæ­¥ã€‚**\n- **å…¶æ¬¡ï¼Œä¸ºäº†ä¿è¯MQæ¶ˆæ¯çš„å¯é æ€§ï¼Œæˆ‘ä»¬é‡‡ç”¨äº†ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶ã€æ¶ˆè´¹è€…ç¡®è®¤ã€æ¶ˆè´¹è€…å¤±è´¥é‡è¯•ç­‰ç­–ç•¥ï¼Œç¡®ä¿æ¶ˆæ¯æŠ•é€’çš„å¯é æ€§**\n- **æœ€åï¼Œæˆ‘ä»¬è¿˜åœ¨äº¤æ˜“æœåŠ¡è®¾ç½®äº†å®šæ—¶ä»»åŠ¡ï¼Œå®šæœŸæŸ¥è¯¢è®¢å•æ”¯ä»˜çŠ¶æ€ã€‚è¿™æ ·å³ä¾¿MQé€šçŸ¥å¤±è´¥ï¼Œè¿˜å¯ä»¥åˆ©ç”¨å®šæ—¶ä»»åŠ¡ä½œä¸ºå…œåº•æ–¹æ¡ˆï¼Œç¡®ä¿è®¢å•æ”¯ä»˜çŠ¶æ€çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚**\n  <a name=\"opFBH\"></a>\n\n# ä¸šåŠ¡å¹‚ç­‰æ€§é—®é¢˜\n\n**å¹‚ç­‰**æ˜¯ä¸€ä¸ªæ•°å­¦æ¦‚å¿µï¼Œç”¨å‡½æ•°è¡¨è¾¾å¼æ¥æè¿°æ˜¯è¿™æ ·çš„ï¼š`f(x) = f(f(x))`ï¼Œä¾‹å¦‚æ±‚ç»å¯¹å€¼å‡½æ•°ã€‚<br />åœ¨ç¨‹åºå¼€å‘ä¸­ï¼Œåˆ™æ˜¯æŒ‡åŒä¸€ä¸ªä¸šåŠ¡ï¼Œæ‰§è¡Œä¸€æ¬¡æˆ–å¤šæ¬¡å¯¹ä¸šåŠ¡çŠ¶æ€çš„å½±å“æ˜¯ä¸€è‡´çš„ã€‚ä¾‹å¦‚ï¼š\n\n- æ ¹æ®idåˆ é™¤æ•°æ®\n- æŸ¥è¯¢æ•°æ®\n- æ–°å¢æ•°æ®\n\nä½†æ•°æ®çš„æ›´æ–°å¾€å¾€ä¸æ˜¯å¹‚ç­‰çš„ï¼Œå¦‚æœé‡å¤æ‰§è¡Œå¯èƒ½é€ æˆä¸ä¸€æ ·çš„åæœã€‚æ¯”å¦‚ï¼š\n\n- å–æ¶ˆè®¢å•ï¼Œæ¢å¤åº“å­˜çš„ä¸šåŠ¡ã€‚å¦‚æœå¤šæ¬¡æ¢å¤å°±ä¼šå‡ºç°åº“å­˜é‡å¤å¢åŠ çš„æƒ…å†µ\n- é€€æ¬¾ä¸šåŠ¡ã€‚é‡å¤é€€æ¬¾å¯¹å•†å®¶è€Œè¨€ä¼šæœ‰ç»æµæŸå¤±ã€‚\n\næ‰€ä»¥ï¼Œæˆ‘ä»¬è¦å°½å¯èƒ½é¿å…ä¸šåŠ¡è¢«é‡å¤æ‰§è¡Œã€‚<br />ç„¶è€Œåœ¨å®é™…ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œç”±äºæ„å¤–ç»å¸¸ä¼šå‡ºç°ä¸šåŠ¡è¢«é‡å¤æ‰§è¡Œçš„æƒ…å†µï¼Œä¾‹å¦‚ï¼š\n\n- é¡µé¢å¡é¡¿æ—¶é¢‘ç¹åˆ·æ–°å¯¼è‡´è¡¨å•é‡å¤æäº¤\n- æœåŠ¡é—´è°ƒç”¨çš„é‡è¯•\n- MQæ¶ˆæ¯çš„é‡å¤æŠ•é€’\n\næˆ‘ä»¬åœ¨ç”¨æˆ·æ”¯ä»˜æˆåŠŸåä¼šå‘é€MQæ¶ˆæ¯åˆ°äº¤æ˜“æœåŠ¡ï¼Œä¿®æ”¹è®¢å•çŠ¶æ€ä¸ºå·²æ”¯ä»˜ï¼Œå°±å¯èƒ½å‡ºç°æ¶ˆæ¯é‡å¤æŠ•é€’çš„æƒ…å†µã€‚å¦‚æœæ¶ˆè´¹è€…ä¸åšåˆ¤æ–­ï¼Œå¾ˆæœ‰å¯èƒ½å¯¼è‡´æ¶ˆæ¯è¢«æ¶ˆè´¹å¤šæ¬¡ï¼Œå‡ºç°ä¸šåŠ¡æ•…éšœã€‚<br />ä¸¾ä¾‹ï¼š\n\n1. å‡å¦‚ç”¨æˆ·åˆšåˆšæ”¯ä»˜å®Œæˆï¼Œå¹¶ä¸”æŠ•é€’æ¶ˆæ¯åˆ°äº¤æ˜“æœåŠ¡ï¼Œäº¤æ˜“æœåŠ¡æ›´æ”¹è®¢å•ä¸º**å·²æ”¯ä»˜**çŠ¶æ€ã€‚\n2. ç”±äºæŸç§åŸå› ï¼Œä¾‹å¦‚ç½‘ç»œæ•…éšœå¯¼è‡´ç”Ÿäº§è€…æ²¡æœ‰å¾—åˆ°ç¡®è®¤ï¼Œéš”äº†ä¸€æ®µæ—¶é—´å**é‡æ–°æŠ•é€’**ç»™äº¤æ˜“æœåŠ¡ã€‚\n3. ä½†æ˜¯ï¼Œåœ¨æ–°æŠ•é€’çš„æ¶ˆæ¯è¢«æ¶ˆè´¹ä¹‹å‰ï¼Œç”¨æˆ·é€‰æ‹©äº†é€€æ¬¾ï¼Œå°†è®¢å•çŠ¶æ€æ”¹ä¸ºäº†**å·²é€€æ¬¾**çŠ¶æ€ã€‚\n4. é€€æ¬¾å®Œæˆåï¼Œæ–°æŠ•é€’çš„æ¶ˆæ¯æ‰è¢«æ¶ˆè´¹ï¼Œé‚£ä¹ˆè®¢å•çŠ¶æ€ä¼šè¢«å†æ¬¡æ”¹ä¸º**å·²æ”¯ä»˜**ã€‚ä¸šåŠ¡å¼‚å¸¸ã€‚\n\nå› æ­¤ï¼Œæˆ‘ä»¬å¿…é¡»æƒ³åŠæ³•ä¿è¯æ¶ˆæ¯å¤„ç†çš„å¹‚ç­‰æ€§ã€‚è¿™é‡Œç»™å‡ºä¸¤ç§æ–¹æ¡ˆï¼š\n\n- å”¯ä¸€æ¶ˆæ¯ID\n- ä¸šåŠ¡çŠ¶æ€åˆ¤æ–­\n  <a name=\"j5exQ\"></a>\n\n## å”¯ä¸€æ¶ˆæ¯IDæ–¹å¼\n\nè¿™ä¸ªæ€è·¯éå¸¸ç®€å•ï¼š\n\n1. æ¯ä¸€æ¡æ¶ˆæ¯éƒ½ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„idï¼Œä¸æ¶ˆæ¯ä¸€èµ·æŠ•é€’ç»™æ¶ˆè´¹è€…ã€‚\n2. æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯åå¤„ç†è‡ªå·±çš„ä¸šåŠ¡ï¼Œä¸šåŠ¡å¤„ç†æˆåŠŸåå°†æ¶ˆæ¯IDä¿å­˜åˆ°æ•°æ®åº“\n3. å¦‚æœä¸‹æ¬¡åˆæ”¶åˆ°ç›¸åŒæ¶ˆæ¯ï¼Œå»æ•°æ®åº“æŸ¥è¯¢åˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™ä¸ºé‡å¤æ¶ˆæ¯æ”¾å¼ƒå¤„ç†ã€‚\n\næˆ‘ä»¬è¯¥å¦‚ä½•ç»™æ¶ˆæ¯æ·»åŠ å”¯ä¸€IDå‘¢ï¼Ÿ<br />å…¶å®å¾ˆç®€å•ï¼Œ`SpringAMQP`çš„`MessageConverter`è‡ªå¸¦äº†`MessageID`çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬åªè¦å¼€å¯è¿™ä¸ªåŠŸèƒ½å³å¯ã€‚<br />ä»¥`Jackson`çš„æ¶ˆæ¯è½¬æ¢å™¨ä¸ºä¾‹ï¼š\n\n```java\n@Bean\npublic MessageConverter messageConverter(){\n    // 1.å®šä¹‰æ¶ˆæ¯è½¬æ¢å™¨\n    Jackson2JsonMessageConverter jjmc = new Jackson2JsonMessageConverter();\n    // 2.é…ç½®è‡ªåŠ¨åˆ›å»ºæ¶ˆæ¯idï¼Œç”¨äºè¯†åˆ«ä¸åŒæ¶ˆæ¯ï¼Œä¹Ÿå¯ä»¥åœ¨ä¸šåŠ¡ä¸­åŸºäºIDåˆ¤æ–­æ˜¯å¦æ˜¯é‡å¤æ¶ˆæ¯\n    jjmc.setCreateMessageIds(true);\n    return jjmc;\n}\n```\n\n<a name=\"Llqdt\"></a>\n\n## ä¸šåŠ¡åˆ¤æ–­æ–¹å¼\n\nä¸šåŠ¡åˆ¤æ–­å°±æ˜¯åŸºäºä¸šåŠ¡æœ¬èº«çš„é€»è¾‘æˆ–çŠ¶æ€æ¥åˆ¤æ–­æ˜¯å¦æ˜¯é‡å¤çš„è¯·æ±‚æˆ–æ¶ˆæ¯ï¼Œä¸åŒçš„ä¸šåŠ¡åœºæ™¯åˆ¤æ–­çš„æ€è·¯ä¹Ÿä¸ä¸€æ ·ã€‚<br />ä¾‹å¦‚æˆ‘ä»¬å½“å‰æ¡ˆä¾‹ä¸­ï¼Œå¤„ç†æ¶ˆæ¯çš„ä¸šåŠ¡é€»è¾‘æ˜¯æŠŠè®¢å•çŠ¶æ€ä»æœªæ”¯ä»˜ä¿®æ”¹ä¸ºå·²æ”¯ä»˜ã€‚å› æ­¤æˆ‘ä»¬å°±å¯ä»¥åœ¨æ‰§è¡Œä¸šåŠ¡æ—¶åˆ¤æ–­è®¢å•çŠ¶æ€æ˜¯å¦æ˜¯æœªæ”¯ä»˜ï¼Œå¦‚æœä¸æ˜¯åˆ™è¯æ˜è®¢å•å·²ç»è¢«å¤„ç†è¿‡ï¼Œæ— éœ€é‡å¤å¤„ç†ã€‚<br />ç›¸æ¯”è¾ƒè€Œè¨€ï¼Œæ¶ˆæ¯IDçš„æ–¹æ¡ˆéœ€è¦æ”¹é€ åŸæœ‰çš„æ•°æ®åº“ï¼Œæ‰€ä»¥æˆ‘æ›´æ¨èä½¿ç”¨ä¸šåŠ¡åˆ¤æ–­çš„æ–¹æ¡ˆã€‚<br />ä»¥æ”¯ä»˜ä¿®æ”¹è®¢å•çš„ä¸šåŠ¡ä¸ºä¾‹ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹`OrderServiceImpl`ä¸­çš„`markOrderPaySuccess`æ–¹æ³•ï¼š\n\n```java\n@Override\npublic void markOrderPaySuccess(Long orderId) {\n    // 1.æŸ¥è¯¢è®¢å•\n    Order old = getById(orderId);\n    // 2.åˆ¤æ–­è®¢å•çŠ¶æ€\n    if (old == null || old.getStatus() != 1) {\n        // è®¢å•ä¸å­˜åœ¨æˆ–è€…è®¢å•çŠ¶æ€ä¸æ˜¯1ï¼Œæ”¾å¼ƒå¤„ç†\n        return;\n    }\n    // 3.å°è¯•æ›´æ–°è®¢å•\n    Order order = new Order();\n    order.setId(orderId);\n    order.setStatus(2);\n    order.setPayTime(LocalDateTime.now());\n    updateById(order);\n}\n```\n\nä¸Šè¿°ä»£ç é€»è¾‘ä¸Šç¬¦åˆäº†å¹‚ç­‰åˆ¤æ–­çš„éœ€æ±‚ï¼Œä½†æ˜¯ç”±äºåˆ¤æ–­å’Œæ›´æ–°æ˜¯ä¸¤æ­¥åŠ¨ä½œï¼Œå› æ­¤åœ¨æå°æ¦‚ç‡ä¸‹å¯èƒ½å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚<br />æˆ‘ä»¬å¯ä»¥åˆå¹¶ä¸Šè¿°æ“ä½œä¸ºè¿™æ ·ï¼š\n\n```java\n@Override\npublic void markOrderPaySuccess(Long orderId) {\n    // UPDATE `order` SET status = ? , pay_time = ? WHERE id = ? AND status = 1\n    lambdaUpdate()\n        .set(Order::getStatus, 2)\n        .set(Order::getPayTime, LocalDateTime.now())\n        .eq(Order::getId, orderId)\n        .eq(Order::getStatus, 1)\n        .update();\n}\n```\n\næ³¨æ„çœ‹ï¼Œä¸Šè¿°ä»£ç ç­‰åŒäºè¿™æ ·çš„SQLè¯­å¥ï¼š\n\n```sql\nUPDATE `order` SET status = ? , pay_time = ? WHERE id = ? AND status = 1\n```\n\næˆ‘ä»¬åœ¨`where`æ¡ä»¶ä¸­é™¤äº†åˆ¤æ–­idä»¥å¤–ï¼Œè¿˜åŠ ä¸Šäº†`status`å¿…é¡»ä¸º1çš„æ¡ä»¶ã€‚å¦‚æœæ¡ä»¶ä¸ç¬¦ï¼ˆè¯´æ˜è®¢å•å·²æ”¯ä»˜ï¼‰ï¼Œåˆ™`SQL`åŒ¹é…ä¸åˆ°æ•°æ®ï¼Œæ ¹æœ¬ä¸ä¼šæ‰§è¡Œã€‚\n<a name=\"iGvnN\"></a>\n\n# å»¶è¿Ÿæ¶ˆæ¯\n\nåœ¨ç”µå•†çš„æ”¯ä»˜ä¸šåŠ¡ä¸­ï¼Œå¯¹äºä¸€äº›åº“å­˜æœ‰é™çš„å•†å“ï¼Œä¸ºäº†æ›´å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œé€šå¸¸éƒ½ä¼šåœ¨ç”¨æˆ·ä¸‹å•æ—¶ç«‹åˆ»æ‰£å‡å•†å“åº“å­˜ã€‚ä¾‹å¦‚ç”µå½±é™¢è´­ç¥¨ã€é«˜é“è´­ç¥¨ï¼Œä¸‹å•åå°±ä¼šé”å®šåº§ä½èµ„æºï¼Œå…¶ä»–äººæ— æ³•é‡å¤è´­ä¹°ã€‚<br />ä½†æ˜¯è¿™æ ·å°±å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå‡å¦‚ç”¨æˆ·ä¸‹å•åä¸€ç›´ä¸ä»˜æ¬¾ï¼Œå°±ä¼šä¸€ç›´å æœ‰åº“å­˜èµ„æºï¼Œå¯¼è‡´å…¶ä»–å®¢æˆ·æ— æ³•æ­£å¸¸äº¤æ˜“ï¼Œæœ€ç»ˆå¯¼è‡´å•†æˆ·åˆ©ç›Šå—æŸï¼<br />å› æ­¤ï¼Œç”µå•†ä¸­é€šå¸¸çš„åšæ³•å°±æ˜¯ï¼š**å¯¹äºè¶…è¿‡ä¸€å®šæ—¶é—´æœªæ”¯ä»˜çš„è®¢å•ï¼Œåº”è¯¥ç«‹åˆ»å–æ¶ˆè®¢å•å¹¶é‡Šæ”¾å ç”¨çš„åº“å­˜**ã€‚<br />ä¾‹å¦‚ï¼Œè®¢å•æ”¯ä»˜è¶…æ—¶æ—¶é—´ä¸º30åˆ†é’Ÿï¼Œåˆ™æˆ‘ä»¬åº”è¯¥åœ¨ç”¨æˆ·ä¸‹å•åçš„ç¬¬30åˆ†é’Ÿæ£€æŸ¥è®¢å•æ”¯ä»˜çŠ¶æ€ï¼Œå¦‚æœå‘ç°æœªæ”¯ä»˜ï¼Œåº”è¯¥ç«‹åˆ»å–æ¶ˆè®¢å•ï¼Œé‡Šæ”¾åº“å­˜ã€‚<br />ä½†é—®é¢˜æ¥äº†ï¼šå¦‚ä½•æ‰èƒ½å‡†ç¡®çš„å®ç°åœ¨ä¸‹å•åç¬¬30åˆ†é’Ÿå»æ£€æŸ¥æ”¯ä»˜çŠ¶æ€å‘¢ï¼Ÿ<br />åƒè¿™ç§åœ¨ä¸€æ®µæ—¶é—´ä»¥åæ‰æ‰§è¡Œçš„ä»»åŠ¡ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º**å»¶è¿Ÿä»»åŠ¡**ï¼Œè€Œè¦å®ç°å»¶è¿Ÿä»»åŠ¡ï¼Œæœ€ç®€å•çš„æ–¹æ¡ˆå°±æ˜¯åˆ©ç”¨MQçš„å»¶è¿Ÿæ¶ˆæ¯äº†ã€‚<br />åœ¨RabbitMQä¸­å®ç°å»¶è¿Ÿæ¶ˆæ¯ä¹Ÿæœ‰ä¸¤ç§æ–¹æ¡ˆï¼š\n\n- æ­»ä¿¡äº¤æ¢æœº+TTL\n- å»¶è¿Ÿæ¶ˆæ¯æ’ä»¶\n\nè¿™ä¸€ç« æˆ‘ä»¬å°±ä¸€èµ·ç ”ç©¶ä¸‹è¿™ä¸¤ç§æ–¹æ¡ˆçš„å®ç°æ–¹å¼ï¼Œä»¥åŠä¼˜ç¼ºç‚¹ã€‚\n<a name=\"BMgqJ\"></a>\n\n## æ­»ä¿¡äº¤æ¢æœºå’Œå»¶è¿Ÿæ¶ˆæ¯\n\né¦–å…ˆæˆ‘ä»¬æ¥å­¦ä¹ ä¸€ä¸‹åŸºäºæ­»ä¿¡äº¤æ¢æœºçš„å»¶è¿Ÿæ¶ˆæ¯æ–¹æ¡ˆã€‚\n<a name=\"jNkwv\"></a>\n\n### æ­»ä¿¡äº¤æ¢æœº\n\nä»€ä¹ˆæ˜¯æ­»ä¿¡ï¼Ÿ<br />å½“ä¸€ä¸ªé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯æ»¡è¶³ä¸‹åˆ—æƒ…å†µä¹‹ä¸€æ—¶ï¼Œå¯ä»¥æˆä¸ºæ­»ä¿¡ï¼ˆ`dead letter`ï¼‰ï¼š\n\n- æ¶ˆè´¹è€…ä½¿ç”¨`basic.reject`æˆ– `basic.nack`å£°æ˜æ¶ˆè´¹å¤±è´¥ï¼Œå¹¶ä¸”æ¶ˆæ¯çš„`requeue`å‚æ•°è®¾ç½®ä¸º`false`\n- æ¶ˆæ¯æ˜¯ä¸€ä¸ªè¿‡æœŸæ¶ˆæ¯ï¼Œè¶…æ—¶æ— äººæ¶ˆè´¹\n- è¦æŠ•é€’çš„é˜Ÿåˆ—æ¶ˆæ¯æ»¡äº†ï¼Œæ— æ³•æŠ•é€’\n\nå¦‚æœä¸€ä¸ªé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯å·²ç»æˆä¸ºæ­»ä¿¡ï¼Œå¹¶ä¸”è¿™ä¸ªé˜Ÿåˆ—é€šè¿‡`dead-letter-exchange`å±æ€§æŒ‡å®šäº†ä¸€ä¸ªäº¤æ¢æœºï¼Œé‚£ä¹ˆé˜Ÿåˆ—ä¸­çš„æ­»ä¿¡å°±ä¼šæŠ•é€’åˆ°è¿™ä¸ªäº¤æ¢æœºä¸­ï¼Œè€Œè¿™ä¸ªäº¤æ¢æœºå°±ç§°ä¸º**æ­»ä¿¡äº¤æ¢æœº**ï¼ˆ`Dead Letter Exchange`ï¼‰ã€‚è€Œæ­¤æ—¶åŠ å…¥æœ‰é˜Ÿåˆ—ä¸æ­»ä¿¡äº¤æ¢æœºç»‘å®šï¼Œåˆ™æœ€ç»ˆæ­»ä¿¡å°±ä¼šè¢«æŠ•é€’åˆ°è¿™ä¸ªé˜Ÿåˆ—ä¸­ã€‚<br />æ­»ä¿¡äº¤æ¢æœºæœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿ\n\n1. æ”¶é›†é‚£äº›å› å¤„ç†å¤±è´¥è€Œè¢«æ‹’ç»çš„æ¶ˆæ¯\n2. æ”¶é›†é‚£äº›å› é˜Ÿåˆ—æ»¡äº†è€Œè¢«æ‹’ç»çš„æ¶ˆæ¯\n3. æ”¶é›†å› TTLï¼ˆæœ‰æ•ˆæœŸï¼‰åˆ°æœŸçš„æ¶ˆæ¯\n   <a name=\"Qu7xH\"></a>\n\n### å»¶è¿Ÿæ¶ˆæ¯\n\nå‰é¢ä¸¤ç§ä½œç”¨åœºæ™¯å¯ä»¥çœ‹åšæ˜¯æŠŠæ­»ä¿¡äº¤æ¢æœºå½“åšä¸€ç§æ¶ˆæ¯å¤„ç†çš„æœ€ç»ˆå…œåº•æ–¹æ¡ˆï¼Œä¸æ¶ˆè´¹è€…é‡è¯•æ—¶è®²çš„`RepublishMessageRecoverer`ä½œç”¨ç±»ä¼¼ã€‚<br />è€Œæœ€åä¸€ç§åœºæ™¯ï¼Œå¤§å®¶è®¾æƒ³ä¸€ä¸‹è¿™æ ·çš„åœºæ™¯ï¼š<br />å¦‚å›¾ï¼Œæœ‰ä¸€ç»„ç»‘å®šçš„äº¤æ¢æœºï¼ˆ`ttl.fanout`ï¼‰å’Œé˜Ÿåˆ—ï¼ˆ`ttl.queue`ï¼‰ã€‚ä½†æ˜¯`ttl.queue`æ²¡æœ‰æ¶ˆè´¹è€…ç›‘å¬ï¼Œè€Œæ˜¯è®¾å®šäº†æ­»ä¿¡äº¤æ¢æœº`hmall.direct`ï¼Œè€Œé˜Ÿåˆ—`direct.queue1`åˆ™ä¸æ­»ä¿¡äº¤æ¢æœºç»‘å®šï¼Œ`RoutingKey`æ˜¯`blue`ï¼š<br />![55.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_f463aef928-55.png) <br />å‡å¦‚æˆ‘ä»¬ç°åœ¨å‘é€ä¸€æ¡æ¶ˆæ¯åˆ°`ttl.fanout`ï¼Œ`RoutingKey`ä¸º`blue`ï¼Œå¹¶è®¾ç½®æ¶ˆæ¯çš„**æœ‰æ•ˆæœŸ**ä¸º`5000`æ¯«ç§’ï¼š<br />![56.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_f80da0d428-56.png)\n\n> **æ³¨æ„ï¼šå°½ç®¡è¿™é‡Œçš„**`ttl.fanout`**ä¸éœ€è¦**`RoutingKey`**ï¼Œä½†æ˜¯å½“æ¶ˆæ¯å˜ä¸ºæ­»ä¿¡å¹¶æŠ•é€’åˆ°æ­»ä¿¡äº¤æ¢æœºæ—¶ï¼Œä¼šæ²¿ç”¨ä¹‹å‰çš„**`RoutingKey`**ï¼Œè¿™æ ·**`hmall.direct`**æ‰èƒ½æ­£ç¡®è·¯ç”±æ¶ˆæ¯ã€‚**\n\næ¶ˆæ¯è‚¯å®šä¼šè¢«æŠ•é€’åˆ°`ttl.queue`ä¹‹åï¼Œç”±äºæ²¡æœ‰æ¶ˆè´¹è€…ï¼Œå› æ­¤æ¶ˆæ¯æ— äººæ¶ˆè´¹ã€‚5ç§’ä¹‹åï¼Œæ¶ˆæ¯çš„æœ‰æ•ˆæœŸåˆ°æœŸï¼Œæˆä¸ºæ­»ä¿¡ï¼š<br />![57.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_f913e63428-57.png)<br />æ­»ä¿¡è¢«å†æ¬¡æŠ•é€’åˆ°æ­»ä¿¡äº¤æ¢æœº`hmall.direct`ï¼Œå¹¶æ²¿ç”¨ä¹‹å‰çš„`RoutingKey`ï¼Œä¹Ÿå°±æ˜¯`blue`ï¼š<br />![58.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_fc26646e28-58.png) <br />ç”±äº`direct.queue1`ä¸`hmall.direct`ç»‘å®šçš„`key`æ˜¯`blue`ï¼Œå› æ­¤æœ€ç»ˆæ¶ˆæ¯è¢«æˆåŠŸè·¯ç”±åˆ°`direct.queue1`ï¼Œå¦‚æœæ­¤æ—¶æœ‰æ¶ˆè´¹è€…ä¸`direct.queue1`ç»‘å®šï¼Œ ä¹Ÿå°±èƒ½æˆåŠŸæ¶ˆè´¹æ¶ˆæ¯äº†ã€‚ä½†æ­¤æ—¶å·²ç»æ˜¯5ç§’é’Ÿä»¥åäº†ï¼š<br />![59.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_fead15f128-59.png)<br />ä¹Ÿå°±æ˜¯è¯´ï¼Œ`publisher`å‘é€äº†ä¸€æ¡æ¶ˆæ¯ï¼Œä½†æœ€ç»ˆ`consumer`åœ¨5ç§’åæ‰æ”¶åˆ°æ¶ˆæ¯ã€‚æˆ‘ä»¬æˆåŠŸå®ç°äº†**å»¶è¿Ÿæ¶ˆæ¯**ã€‚\n<a name=\"f9BUM\"></a>\n\n### æ€»ç»“\n\nRabbitMQçš„æ¶ˆæ¯è¿‡æœŸæ˜¯åŸºäºè¿½æº¯æ–¹å¼æ¥å®ç°çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å½“ä¸€ä¸ªæ¶ˆæ¯çš„TTLåˆ°æœŸä»¥åä¸ä¸€å®šä¼šè¢«ç§»é™¤æˆ–æŠ•é€’åˆ°æ­»ä¿¡äº¤æ¢æœºï¼Œè€Œæ˜¯åœ¨æ¶ˆæ¯æ°å¥½å¤„äºé˜Ÿé¦–æ—¶æ‰ä¼šè¢«å¤„ç†ã€‚<br />å½“é˜Ÿåˆ—ä¸­æ¶ˆæ¯å †ç§¯å¾ˆå¤šçš„æ—¶å€™ï¼Œè¿‡æœŸæ¶ˆæ¯å¯èƒ½ä¸ä¼šè¢«æŒ‰æ—¶å¤„ç†ï¼Œå› æ­¤ä½ è®¾ç½®çš„TTLæ—¶é—´ä¸ä¸€å®šå‡†ç¡®ã€‚\n<a name=\"vvt4z\"></a>\n\n## DelayExchangeæ’ä»¶\n\nåŸºäºæ­»ä¿¡é˜Ÿåˆ—è™½ç„¶å¯ä»¥å®ç°å»¶è¿Ÿæ¶ˆæ¯ï¼Œä½†æ˜¯å¤ªéº»çƒ¦äº†ã€‚å› æ­¤RabbitMQç¤¾åŒºæä¾›äº†ä¸€ä¸ªå»¶è¿Ÿæ¶ˆæ¯æ’ä»¶æ¥å®ç°ç›¸åŒçš„æ•ˆæœã€‚\n<a name=\"A03pF\"></a>\n\n### ä¸‹è½½\n\næ’ä»¶ä¸‹è½½åœ°å€ï¼š<br />[GitHub - rabbitmq/rabbitmq-delayed-message-exchange: Delayed Messaging for RabbitMQ](https://github.com/rabbitmq/rabbitmq-delayed-message-exchange)<br />ç”±äºæˆ‘ä»¬å®‰è£…çš„MQæ˜¯3.8ç‰ˆæœ¬ï¼Œå› æ­¤è¿™é‡Œä¸‹è½½3.8.17ç‰ˆæœ¬ï¼š<br />![60.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_00e6d3a928-60.png)\n<a name=\"aQbsE\"></a>\n\n### å®‰è£…\n\nå› ä¸ºæˆ‘ä»¬æ˜¯åŸºäºDockerå®‰è£…ï¼Œæ‰€ä»¥éœ€è¦å…ˆæŸ¥çœ‹RabbitMQçš„æ’ä»¶ç›®å½•å¯¹åº”çš„æ•°æ®å·ã€‚\n\n```bash\ndocker volume inspect mq-plugins\n```\n\nç»“æœå¦‚ä¸‹ï¼š\n\n```json\n[\n  {\n    \"CreatedAt\": \"2024-06-19T09:22:59+08:00\",\n    \"Driver\": \"local\",\n    \"Labels\": null,\n    \"Mountpoint\": \"/var/lib/docker/volumes/mq-plugins/_data\",\n    \"Name\": \"mq-plugins\",\n    \"Options\": null,\n    \"Scope\": \"local\"\n  }\n]\n```\n\næ’ä»¶ç›®å½•è¢«æŒ‚è½½åˆ°äº†`/var/lib/docker/volumes/mq-plugins/_data`è¿™ä¸ªç›®å½•ï¼Œæˆ‘ä»¬ä¸Šä¼ æ’ä»¶åˆ°è¯¥ç›®å½•ä¸‹ã€‚<br />æ¥ä¸‹æ¥æ‰§è¡Œå‘½ä»¤ï¼Œå®‰è£…æ’ä»¶ï¼š\n\n```bash\ndocker exec -it mq rabbitmq-plugins enable rabbitmq_delayed_message_exchange\n```\n\nè¿è¡Œç»“æœå¦‚ä¸‹ï¼š<br />![61.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_034bbc9b28-61.png)\n<a name=\"Y12a5\"></a>\n\n### å£°æ˜å»¶è¿Ÿäº¤æ¢æœº\n\nåŸºäºæ³¨è§£æ–¹å¼ï¼š\n\n```java\n@RabbitListener(bindings = @QueueBinding(\n        value = @Queue(name = \"delay.queue\", durable = \"true\"),\n        exchange = @Exchange(name = \"delay.direct\", delayed = \"true\"),\n        key = \"delay\"\n    ))\n    public void listenDelayMessage(String msg){\n    log.info(\"æ¥æ”¶åˆ°delay.queueçš„å»¶è¿Ÿæ¶ˆæ¯ï¼š{}\", msg);\n}\n```\n\nåŸºäº`@Bean`çš„æ–¹å¼ï¼š\n\n```java\npackage com.itheima.consumer.config;\n\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.amqp.core.*;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\n\n@Slf4j\n@Configuration\npublic class DelayExchangeConfig {\n\n    @Bean\n    public DirectExchange delayExchange(){\n        return ExchangeBuilder\n        .directExchange(\"delay.direct\") // æŒ‡å®šäº¤æ¢æœºç±»å‹å’Œåç§°\n        .delayed() // è®¾ç½®delayçš„å±æ€§ä¸ºtrue\n        .durable(true) // æŒä¹…åŒ–\n        .build();\n    }\n\n    @Bean\n    public Queue delayedQueue(){\n        return new Queue(\"delay.queue\");\n    }\n\n    @Bean\n    public Binding delayQueueBinding(){\n        return BindingBuilder.bind(delayedQueue()).to(delayExchange()).with(\"delay\");\n    }\n}\n```\n\n<a name=\"xObny\"></a>\n\n### å‘é€å»¶è¿Ÿæ¶ˆæ¯\n\nå‘é€æ¶ˆæ¯æ—¶ï¼Œå¿…é¡»é€šè¿‡`x-delay`å±æ€§è®¾å®šå»¶è¿Ÿæ—¶é—´ï¼š\n\n```java\n@Test\nvoid testPublisherDelayMessage() {\n    // 1.åˆ›å»ºæ¶ˆæ¯\n    String message = \"hello, delayed message\";\n    // 2.å‘é€æ¶ˆæ¯ï¼Œåˆ©ç”¨æ¶ˆæ¯åç½®å¤„ç†å™¨æ·»åŠ æ¶ˆæ¯å¤´\n    rabbitTemplate.convertAndSend(\"delay.direct\", \"delay\", message, new MessagePostProcessor() {\n        @Override\n        public Message postProcessMessage(Message message) throws AmqpException {\n            // æ·»åŠ å»¶è¿Ÿæ¶ˆæ¯å±æ€§\n            message.getMessageProperties().setDelay(5000);\n            return message;\n        }\n    });\n}\n```\n\n> **æ³¨æ„ï¼š**\n> **å»¶è¿Ÿæ¶ˆæ¯æ’ä»¶å†…éƒ¨ä¼šç»´æŠ¤ä¸€ä¸ªæœ¬åœ°æ•°æ®åº“è¡¨ï¼ŒåŒæ—¶ä½¿ç”¨**`Elang Timers`**åŠŸèƒ½å®ç°è®¡æ—¶ã€‚å¦‚æœæ¶ˆæ¯çš„å»¶è¿Ÿæ—¶é—´è®¾ç½®è¾ƒé•¿ï¼Œå¯èƒ½ä¼šå¯¼è‡´å †ç§¯çš„å»¶è¿Ÿæ¶ˆæ¯éå¸¸å¤šï¼Œä¼šå¸¦æ¥è¾ƒå¤§çš„**`CPU`**å¼€é”€ï¼ŒåŒæ—¶å»¶è¿Ÿæ¶ˆæ¯çš„æ—¶é—´ä¼šå­˜åœ¨è¯¯å·®ã€‚**\n> **å› æ­¤ï¼Œä¸å»ºè®®è®¾ç½®å»¶è¿Ÿæ—¶é—´è¿‡é•¿çš„å»¶è¿Ÿæ¶ˆæ¯ã€‚**\n\n<a name=\"OaH23\"></a>\n\n## è¶…æ—¶è®¢å•é—®é¢˜\n\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±åœ¨äº¤æ˜“æœåŠ¡ä¸­åˆ©ç”¨å»¶è¿Ÿæ¶ˆæ¯å®ç°è®¢å•è¶…æ—¶å–æ¶ˆåŠŸèƒ½ã€‚å…¶å¤§æ¦‚æ€è·¯å¦‚ä¸‹ï¼š<br />![62.jpeg](https://cdn.acwing.com/media/article/image/2024/06/12/126318_05b473b828-62.jpeg) <br />å‡å¦‚è®¢å•è¶…æ—¶æ”¯ä»˜æ—¶é—´ä¸º30åˆ†é’Ÿï¼Œç†è®ºä¸Šè¯´æˆ‘ä»¬åº”è¯¥åœ¨ä¸‹å•æ—¶å‘é€ä¸€æ¡å»¶è¿Ÿæ¶ˆæ¯ï¼Œå»¶è¿Ÿæ—¶é—´ä¸º30åˆ†é’Ÿã€‚è¿™æ ·å°±å¯ä»¥åœ¨æ¥æ”¶åˆ°æ¶ˆæ¯æ—¶æ£€éªŒè®¢å•æ”¯ä»˜çŠ¶æ€ï¼Œå…³é—­æœªæ”¯ä»˜è®¢å•ã€‚\n<a name=\"J1WMP\"></a>\n\n### å®šä¹‰å¸¸é‡\n\næ— è®ºæ˜¯æ¶ˆæ¯å‘é€è¿˜æ˜¯æ¥æ”¶éƒ½æ˜¯åœ¨äº¤æ˜“æœåŠ¡å®Œæˆï¼Œå› æ­¤æˆ‘ä»¬åœ¨`trade-service`ä¸­å®šä¹‰ä¸€ä¸ªå¸¸é‡ç±»ï¼Œç”¨äºè®°å½•äº¤æ¢æœºã€é˜Ÿåˆ—ã€`RoutingKey`ç­‰å¸¸é‡ï¼š<br />![63.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_08c5bd6c28-63.png) <br />å†…å®¹å¦‚ä¸‹ï¼š\n\n```java\npackage com.hmall.trade.constants;\n\npublic interface MQConstants {\n    String DELAY_EXCHANGE_NAME = \"trade.delay.direct\";\n    String DELAY_ORDER_QUEUE_NAME = \"trade.delay.order.queue\";\n    String DELAY_ORDER_KEY = \"delay.order.query\";\n}\n```\n\n<a name=\"k32De\"></a>\n\n### é…ç½®MQ\n\nåœ¨`trade-service`æ¨¡å—çš„`pom.xml`ä¸­å¼•å…¥`amqp`çš„ä¾èµ–ï¼š\n\n```xml\n<!--amqp-->\n<dependency>\n  <groupId>org.springframework.boot</groupId>\n  <artifactId>spring-boot-starter-amqp</artifactId>\n</dependency>\n```\n\nåœ¨`trade-service`çš„`application.yaml`ä¸­æ·»åŠ MQçš„é…ç½®ï¼š\n\n```yaml\nspring:\n  rabbitmq:\n    host: 192.168.150.101\n    port: 5672\n    virtual-host: /hmall\n    username: hmall\n    password: 123\n```\n\n<a name=\"gSOGn\"></a>\n\n### æ”¹é€ ä¸‹å•ä¸šåŠ¡ï¼Œå‘é€å»¶è¿Ÿæ¶ˆæ¯\n\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ”¹é€ ä¸‹å•ä¸šåŠ¡ï¼Œåœ¨ä¸‹å•å®Œæˆåï¼Œå‘é€å»¶è¿Ÿæ¶ˆæ¯ï¼ŒæŸ¥è¯¢æ”¯ä»˜çŠ¶æ€ã€‚<br />ä¿®æ”¹`trade-service`æ¨¡å—çš„`com.hmall.trade.service.impl.OrderServiceImpl`ç±»çš„`createOrder`æ–¹æ³•ï¼Œæ·»åŠ æ¶ˆæ¯å‘é€çš„ä»£ç ï¼š<br />![64.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_0b0574dc28-64.png) <br />è¿™é‡Œå»¶è¿Ÿæ¶ˆæ¯çš„æ—¶é—´åº”è¯¥æ˜¯15åˆ†é’Ÿï¼Œä¸è¿‡æˆ‘ä»¬ä¸ºäº†æµ‹è¯•æ–¹ä¾¿ï¼Œæ”¹æˆ10ç§’ã€‚\n<a name=\"l5SvN\"></a>\n\n### ç¼–å†™æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€æ¥å£\n\nç”±äºMQæ¶ˆæ¯å¤„ç†æ—¶éœ€è¦æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€ï¼Œå› æ­¤æˆ‘ä»¬è¦åœ¨`pay-service`æ¨¡å—å®šä¹‰ä¸€ä¸ªè¿™æ ·çš„æ¥å£ï¼Œå¹¶æä¾›å¯¹åº”çš„`FeignClient`ã€‚<br />é¦–å…ˆï¼Œåœ¨`hm-api`æ¨¡å—å®šä¹‰ä¸‰ä¸ªç±»ï¼š<br />![65.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_0c50b94928-65.png) <br />è¯´æ˜ï¼š\n\n- `PayOrderDTO`ï¼šæ”¯ä»˜å•çš„æ•°æ®ä¼ è¾“å®ä½“\n- `PayClient`ï¼šæ”¯ä»˜ç³»ç»Ÿçš„`Feign`å®¢æˆ·ç«¯\n- `PayClientFallback`ï¼šæ”¯ä»˜ç³»ç»Ÿçš„`fallback`é€»è¾‘\n\n`PayOrderDTO`ä»£ç å¦‚ä¸‹ï¼š\n\n```java\npackage com.hmall.api.dto;\n\nimport io.swagger.annotations.ApiModel;\nimport io.swagger.annotations.ApiModelProperty;\nimport lombok.Data;\n\nimport java.time.LocalDateTime;\n\n/**\n * <p>\n * æ”¯ä»˜è®¢å•\n * </p>\n */\n@Data\n@ApiModel(description = \"æ”¯ä»˜å•æ•°æ®ä¼ è¾“å®ä½“\")\npublic class PayOrderDTO {\n    @ApiModelProperty(\"id\")\n    private Long id;\n    @ApiModelProperty(\"ä¸šåŠ¡è®¢å•å·\")\n    private Long bizOrderNo;\n    @ApiModelProperty(\"æ”¯ä»˜å•å·\")\n    private Long payOrderNo;\n    @ApiModelProperty(\"æ”¯ä»˜ç”¨æˆ·id\")\n    private Long bizUserId;\n    @ApiModelProperty(\"æ”¯ä»˜æ¸ é“ç¼–ç \")\n    private String payChannelCode;\n    @ApiModelProperty(\"æ”¯ä»˜é‡‘é¢ï¼Œå•ä½åˆ†\")\n    private Integer amount;\n    @ApiModelProperty(\"ä»˜ç±»å‹ï¼Œ1ï¼šh5,2:å°ç¨‹åºï¼Œ3ï¼šå…¬ä¼—å·ï¼Œ4ï¼šæ‰«ç ï¼Œ5ï¼šä½™é¢æ”¯ä»˜\")\n    private Integer payType;\n    @ApiModelProperty(\"ä»˜çŠ¶æ€ï¼Œ0ï¼šå¾…æäº¤ï¼Œ1:å¾…æ”¯ä»˜ï¼Œ2ï¼šæ”¯ä»˜è¶…æ—¶æˆ–å–æ¶ˆï¼Œ3ï¼šæ”¯ä»˜æˆåŠŸ\")\n    private Integer status;\n    @ApiModelProperty(\"æ‹“å±•å­—æ®µï¼Œç”¨äºä¼ é€’ä¸åŒæ¸ é“å•ç‹¬å¤„ç†çš„å­—æ®µ\")\n    private String expandJson;\n    @ApiModelProperty(\"ç¬¬ä¸‰æ–¹è¿”å›ä¸šåŠ¡ç \")\n    private String resultCode;\n    @ApiModelProperty(\"ç¬¬ä¸‰æ–¹è¿”å›æç¤ºä¿¡æ¯\")\n    private String resultMsg;\n    @ApiModelProperty(\"æ”¯ä»˜æˆåŠŸæ—¶é—´\")\n    private LocalDateTime paySuccessTime;\n    @ApiModelProperty(\"æ”¯ä»˜è¶…æ—¶æ—¶é—´\")\n    private LocalDateTime payOverTime;\n    @ApiModelProperty(\"æ”¯ä»˜äºŒç»´ç é“¾æ¥\")\n    private String qrCodeUrl;\n    @ApiModelProperty(\"åˆ›å»ºæ—¶é—´\")\n    private LocalDateTime createTime;\n    @ApiModelProperty(\"æ›´æ–°æ—¶é—´\")\n    private LocalDateTime updateTime;\n}\n```\n\n`PayClient`ä»£ç å¦‚ä¸‹ï¼š\n\n```java\npackage com.hmall.api.client;\n\nimport com.hmall.api.client.fallback.PayClientFallback;\nimport com.hmall.api.dto.PayOrderDTO;\nimport org.springframework.cloud.openfeign.FeignClient;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.PathVariable;\n\n@FeignClient(value = \"pay-service\", fallbackFactory = PayClientFallback.class)\npublic interface PayClient {\n    /**\n     * æ ¹æ®äº¤æ˜“è®¢å•idæŸ¥è¯¢æ”¯ä»˜å•\n     * @param id ä¸šåŠ¡è®¢å•id\n     * @return æ”¯ä»˜å•ä¿¡æ¯\n     */\n    @GetMapping(\"/pay-orders/biz/{id}\")\n    PayOrderDTO queryPayOrderByBizOrderNo(@PathVariable(\"id\") Long id);\n}\n```\n\n`PayClientFallback`ä»£ç å¦‚ä¸‹ï¼š\n\n```java\npackage com.hmall.api.client.fallback;\n\nimport com.hmall.api.client.PayClient;\nimport com.hmall.api.dto.PayOrderDTO;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.cloud.openfeign.FallbackFactory;\n\n@Slf4j\npublic class PayClientFallback implements FallbackFactory<PayClient> {\n    @Override\n    public PayClient create(Throwable cause) {\n        return new PayClient() {\n            @Override\n            public PayOrderDTO queryPayOrderByBizOrderNo(Long id) {\n                return null;\n            }\n        };\n    }\n}\n```\n\næœ€åï¼Œåœ¨`pay-service`æ¨¡å—çš„`PayController`ä¸­å®ç°è¯¥æ¥å£ï¼š\n\n```java\n@ApiOperation(\"æ ¹æ®idæŸ¥è¯¢æ”¯ä»˜å•\")\n@GetMapping(\"/biz/{id}\")\npublic PayOrderDTO queryPayOrderByBizOrderNo(@PathVariable(\"id\") Long id){\n    PayOrder payOrder = payOrderService.lambdaQuery().eq(PayOrder::getBizOrderNo, id).one();\n    return BeanUtils.copyBean(payOrder, PayOrderDTO.class);\n}\n```\n\n<a name=\"de18I\"></a>\n\n### ç›‘å¬æ¶ˆæ¯ï¼ŒæŸ¥è¯¢æ”¯ä»˜çŠ¶æ€\n\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åœ¨`trader-service`ç¼–å†™ä¸€ä¸ªç›‘å¬å™¨ï¼Œç›‘å¬å»¶è¿Ÿæ¶ˆæ¯ï¼ŒæŸ¥è¯¢è®¢å•æ”¯ä»˜çŠ¶æ€ï¼š<br />![66.png](https://cdn.acwing.com/media/article/image/2024/06/12/126318_107d655a28-66.png) <br />ä»£ç å¦‚ä¸‹ï¼š\n\n```java\npackage com.hmall.trade.listener;\n\nimport com.hmall.api.client.PayClient;\nimport com.hmall.api.dto.PayOrderDTO;\nimport com.hmall.trade.constants.MQConstants;\nimport com.hmall.trade.domain.po.Order;\nimport com.hmall.trade.service.IOrderService;\nimport lombok.RequiredArgsConstructor;\nimport org.springframework.amqp.rabbit.annotation.Exchange;\nimport org.springframework.amqp.rabbit.annotation.Queue;\nimport org.springframework.amqp.rabbit.annotation.QueueBinding;\nimport org.springframework.amqp.rabbit.annotation.RabbitListener;\nimport org.springframework.stereotype.Component;\n\n@Component\n@RequiredArgsConstructor\npublic class OrderDelayMessageListener {\n\n    private final IOrderService orderService;\n    private final PayClient payClient;\n\n    @RabbitListener(bindings = @QueueBinding(\n        value = @Queue(name = MQConstants.DELAY_ORDER_QUEUE_NAME),\n        exchange = @Exchange(name = MQConstants.DELAY_EXCHANGE_NAME, delayed = \"true\"),\n        key = MQConstants.DELAY_ORDER_KEY\n    ))\n    public void listenOrderDelayMessage(Long orderId){\n        // 1.æŸ¥è¯¢è®¢å•\n        Order order = orderService.getById(orderId);\n        // 2.æ£€æµ‹è®¢å•çŠ¶æ€ï¼Œåˆ¤æ–­æ˜¯å¦å·²æ”¯ä»˜\n        if(order == null || order.getStatus() != 1){\n            // è®¢å•ä¸å­˜åœ¨æˆ–è€…å·²ç»æ”¯ä»˜\n            return;\n        }\n        // 3.æœªæ”¯ä»˜ï¼Œéœ€è¦æŸ¥è¯¢æ”¯ä»˜æµæ°´çŠ¶æ€\n        PayOrderDTO payOrder = payClient.queryPayOrderByBizOrderNo(orderId);\n        // 4.åˆ¤æ–­æ˜¯å¦æ”¯ä»˜\n        if(payOrder != null && payOrder.getStatus() == 3){\n            // 4.1.å·²æ”¯ä»˜ï¼Œæ ‡è®°è®¢å•çŠ¶æ€ä¸ºå·²æ”¯ä»˜\n            orderService.markOrderPaySuccess(orderId);\n        }else{\n            // TODO 4.2.æœªæ”¯ä»˜ï¼Œå–æ¶ˆè®¢å•ï¼Œå›å¤åº“å­˜\n            orderService.cancelOrder(orderId);\n        }\n    }\n}\n```","categories":["æ¶ˆæ¯é˜Ÿåˆ—MQ"]},{"title":"ç®—æ³•åŸºç¡€ç¬”è®°","url":"/2023/06/15/ç®—æ³•åŸºç¡€ç¬”è®°/","content":"> authorï¼šSmallBoat\n> æ‰€è°“åŸºç¡€ï¼ŒæŒ‡çš„æ˜¯`base`ï¼Œè€Œé`easy`ã€‚â€”â€” yxc\n\n<a name=\"fhScF\"></a>\n\n## ç¬¬ä¸€ç« ï¼šåŸºç¡€ç®—æ³•\n\n<a name=\"KanrX\"></a>\n\n### 1. 1 å¿«é€Ÿæ’åº$\\mathcal{O}(n \\log n)$ï¼š[å¿«é€Ÿæ’åº](https://www.acwing.com/problem/content/787/)\n\n<a name=\"nVSic\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼šåˆ†æ²»\n\n1. ç¡®å®šåˆ†ç•Œç‚¹ `x = q[l + r >> 1]`\n2. è°ƒæ•´åŒºé—´ï¼šè®©ç¬¬ä¸€ä¸ªåŒºé—´é‡Œçš„æ•°å°äºç­‰äº`x`ï¼Œ è®©ç¬¬äºŒä¸ªåŒºé—´çš„æ•°å¤§äºç­‰äº`x`\n3. é€’å½’å¤„ç†å·¦å³ä¸¤è¾¹\n   <a name=\"ZXrlK\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\npublic static void quick_sort(int[] q, int l, int r) {\n    if(l >= r) return; // å¦‚æœå·¦ç«¯ç‚¹å¤§äºç­‰äºå³ç«¯ç‚¹ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œä¹Ÿä¸ºé€’å½’é€€å‡ºæ¡ä»¶\n    int i = l - 1, j = r + 1, x = q[l + r >> 1];\n    while(i < j) {\n        do i ++; while(q[i] < x);\n        do j --; while(q[j] > x);\n        if(i < j) {\n            int tmp = q[i];\n            q[i] = q[j];\n            q[j] = tmp;\n        }\n    }\n    quick_sort(q, l, j);\n    quick_sort(q, j + 1, r);\n}\n```\n\n<a name=\"Z30ax\"></a>\n\n### 1.2 å½’å¹¶æ’åº$\\mathcal{O}(n \\log n)$\n\n<a name=\"PMNCs\"></a>\n\n#### 1.2.1 å½’å¹¶æ’åºï¼š[å½’å¹¶æ’åº](https://www.acwing.com/problem/content/789/)\n\n<a name=\"oXI7a\"></a>\n\n##### ç®—æ³•æ€æƒ³ï¼šåˆ†æ²»\n\n1. ç¡®å®šåˆ†ç•Œç‚¹ `mid = r + l >> 1`\n2. é€’å½’å¤„ç†å·¦å³ä¸¤è¾¹\n3. å½’å¹¶ï¼Œå°†ä¸¤ä¸ªåŒºé—´åˆäºŒä¸ºä¸€ï¼ˆä»é€’å½’åçš„æœ€åº•å±‚å¼€å§‹åˆå¹¶ï¼Œæ¯æ¬¡å›æº¯åè¾¾åˆ°æ’åºçš„æ•ˆæœï¼‰($\\mathcal{O}(n)$)\n   <a name=\"DHETn\"></a>\n\n##### ä»£ç å®ç°ï¼š\n\n```java\npublic static void merge_sort(int[] q, int l, int r) {\n    if (l >= r) return;\n    int mid = l + r >> 1;\n    merge_sort(q, l, mid);\n    merge_sort(q, mid + 1, r); \n\n    int k = 0, i = l, j = mid + 1;\n    while (i <= mid && j <= r)\n        // tmpä¸ºè¾…åŠ©æ•°ç»„ï¼Œç”¨äºä¸´æ—¶å­˜å‚¨å½’å¹¶æ•°æ®ï¼Œä¹Ÿæ˜¯å½’å¹¶æ’åºç©ºé—´å¤æ‚åº¦ä¸»è¦æ¥æº\n        if (q[i] <= q[j]) tmp[k ++] = q[i ++];\n        else tmp[k ++] = q[j ++];\n\n    while (i <= mid) tmp[k ++] = q[i ++];\n    while (j <= r) tmp[k ++] = q[j ++];\n\n    for (i = l, j = 0; i <= r; i ++, j ++) q[i] = tmp[j];\n}\n```\n\n<a name=\"rfvUw\"></a>\n\n#### 1.2.2 å½’å¹¶æ±‚é€†åºå¯¹ï¼š[é€†åºå¯¹çš„æ•°é‡](https://www.acwing.com/activity/content/problem/content/822/)\n\n<a name=\"gu6yy\"></a>\n\n##### ä»£ç å®ç°ï¼š\n\n```java\npublic static long merge_sort(int l, int r) {\n    if(l >= r) return 0;\n    int mid = l + r >> 1;\n    int k = 0, i = l, j = mid + 1;\n    long res = merge_sort(l, mid) + merge_sort(mid + 1, r);\n    while(i <= mid && j <= r) \n        if(q[i] <= q[j]) tmp[k ++] = q[i ++];\n        else {\n            tmp[k ++] = q[j ++];\n            res += mid - i + 1;\n        }\n    while(i <= mid) tmp[k ++] = q[i ++];\n    while(j <= r) tmp[k ++] = q[j ++];\n    for(i = l, j = 0; i <= r; i ++, j ++) q[i] = tmp[j];\n    return res;\n}\n```\n\n<a name=\"LmlLz\"></a>\n\n### 1.3 æ•´æ•°äºŒåˆ†$\\mathcal{O}(\\log n)$ï¼š[æ•°çš„èŒƒå›´](https://www.acwing.com/problem/content/791/)\n\n<a name=\"nDrJV\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\n1. æ—¶æ—¶åˆ»åˆ»ä¿è¯ç­”æ¡ˆåœ¨æ‰€ç»´æŠ¤çš„åŒºé—´å†…éƒ¨ã€‚\n2. `check()`å‡½æ•°ä¸ºæ»¡è¶³æ¡ä»¶éƒ¨åˆ†ï¼Œä¾‹å¦‚ï¼š`1ã€2ã€3ã€3ã€4ã€5`ä¸­ï¼Œæ±‚`3`çš„èµ·å§‹ä½ç½®ï¼Œåˆ™æ‰€æ±‚ä½ç½®åœ¨æ‰€æœ‰`3`èŒƒå›´çš„æœ€å·¦ä¾§ï¼Œäºæ˜¯éœ€è¦ä¿è¯æ¯æ¬¡`mid`éœ€è¦åœ¨æœ€å·¦è¾¹ä¸€ä¸ª`3`æˆ–å…¶å³ä¾§ï¼Œæ•…`check()`å‡½æ•°ä¸º`if (q[mid] >= 3)`ï¼›è‹¥æ±‚`3`çš„æœ€åä½ç½®ï¼ŒåŒç†`check()`å‡½æ•°ä¸º`if (q[mid] <= 3)`ã€‚æ¯æ¬¡åˆ¤æ–­åéœ€è¦è°ƒæ•´åŒºé—´ç«¯ç‚¹ï¼Œä¾‹å¦‚åœ¨æ±‚`3`çš„å·¦ç«¯ç‚¹æ—¶ï¼Œå¦‚æœæ»¡è¶³`q[mid] >= 3`,åˆ™è¯´æ˜æ‰€æ±‚ä½ç½®åœ¨`mid`å·¦ä¾§æˆ–å°±æ˜¯`mid`ï¼Œåˆ™å°†åŒºé—´å³ç«¯ç‚¹æ›´æ–°ä¸º`mid`ï¼Œå³`r = mid`ã€‚\n3. æ¯æ¬¡äºŒåˆ†ä¹‹å‰éœ€å°†`lã€r`åˆå§‹åŒ–ï¼Œ**æ³¨æ„ï¼š** æ›´æ–°æ—¶ï¼Œè‹¥`r`è¢«æ›´æ–°ä¸º`mid - 1`ï¼Œåˆ™`mid`åº”åˆå§‹åŒ–ä¸º`mid = l + r + 1 >> 1`ï¼Œé¿å…æ›´æ–°è¾¹ç•ŒåèŒƒå›´ä¸å˜ï¼Œå‡ºç°æ­»å¾ªç¯ã€‚\n\n- èƒ½ä½¿ç”¨äºŒåˆ†çš„æ¡ä»¶ï¼šå¿…é¡»è¦æœ‰**äºŒæ®µæ€§**ï¼Œå³ä¸€å®šå­˜åœ¨ä¸€ä¸ªåˆ†ç•Œç‚¹ï¼Œä½¿å¾—åˆ†ç•Œç‚¹ä¸€è¾¹(åŒ…æ‹¬åˆ†ç•Œç‚¹)æ»¡è¶³é¢˜ç›®è¦æ±‚ï¼Œå¦ä¸€è¾¹ä¸æ»¡è¶³ã€‚ï¼ˆå‚è€ƒ[äºŒåˆ†ç®—æ³•è¯¦è§£](http://smallboatc.github.io/2024/01/16/%E4%BA%8C%E5%88%86%E7%AE%97%E6%B3%95%E8%AF%A6%E8%A7%A3/)ï¼‰\n- äºŒåˆ†çš„é¢˜ç›®æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯ç›´æ¥è£¸çš„äºŒåˆ†é¢˜ç›®ï¼Œå¦ä¸€ç§åˆ™æ˜¯æšä¸¾å¯èƒ½çš„ç­”æ¡ˆï¼Œç„¶å`check`è¿™ä¸ªç­”æ¡ˆæ˜¯å¦**å¯è¡Œ**ï¼ˆäºŒåˆ†ç­”æ¡ˆï¼‰ã€‚\n  <a name=\"bCFAX\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\n// æ£€æŸ¥xæ˜¯å¦æ»¡è¶³æŸç§æ€§è´¨ï¼Œä¸ä¸€å®šæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¾‹å¦‚ if (a[mid] >= 3) çš„ç®€å•å½¢å¼\npublic static boolean check(int x) {/* ... */} \n\n// åŒºé—´[l, r]è¢«åˆ’åˆ†æˆ[l, mid]å’Œ[mid + 1, r]æ—¶ä½¿ç”¨ï¼š\npublic static int bsearch_1(int l, int r) {\n    while (l < r) {\n        int mid = l + r >> 1;\n        if (check(mid)) r = mid; // check()åˆ¤æ–­midæ˜¯å¦æ»¡è¶³æ€§è´¨\n        else l = mid + 1;\n    }\n    return l;\n}\n\n// åŒºé—´[l, r]è¢«åˆ’åˆ†æˆ[l, mid - 1]å’Œ[mid, r]æ—¶ä½¿ç”¨ï¼š\npublic static int bsearch_2(int l, int r) {\n    while (l < r) {\n        int mid = l + r + 1 >> 1;\n        if (check(mid)) l = mid;\n        else r = mid - 1;\n    }\n    return l;\n}\n```\n\n<a name=\"xwt7l\"></a>\n\n### 1.4 æµ®ç‚¹æ•°äºŒåˆ†$\\mathcal{O}(\\log n)$ï¼š[æ•°çš„ä¸‰æ¬¡æ–¹æ ¹](https://www.acwing.com/problem/content/792/)\n\n<a name=\"QDY11\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\nç®—æ³•åŸç†ä¸æ•´æ•°äºŒåˆ†ç›¸ä¼¼ï¼Œåœ¨åŒºé—´åˆ’åˆ†çš„æ—¶å€™æ²¡æœ‰æ•´æ•°äºŒåˆ†çš„å„ç§è¾¹ç•Œæƒ…å†µï¼Œä¸€èˆ¬ç”¨å·¦å³ç«¯ç‚¹çš„å·®å€¼æ˜¯å¦å°äºæŸä¸ªå€¼$\\epsilon$æ¥åˆ¤å®šæ˜¯å¦éœ€è¦ç»§ç»­å¾ªç¯ã€‚\n<a name=\"b5cNf\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\n// æ£€æŸ¥xæ˜¯å¦æ»¡è¶³æŸç§æ€§è´¨\npublic static boolean check(double x) {/* ... */} \n\npublic static double bsearch_3(double l, double r) {\n    // eps è¡¨ç¤ºç²¾åº¦ epsilonï¼Œå–å†³äºé¢˜ç›®å¯¹ç²¾åº¦çš„è¦æ±‚ï¼Œä¸€èˆ¬æ¯”é¢˜ç›®ä¿ç•™å°æ•°ä½æ•°å¤§2\n    final static double eps = 1e-8;\n    while (r - l > eps) {\n        double mid = (l + r) / 2;\n        if (check(mid)) r = mid;\n        else l = mid;\n    }\n    return l;\n}\n```\n\n<a name=\"ZD5Bq\"></a>\n\n### 1.5 ä¸€ç»´å‰ç¼€å’Œï¼š[å‰ç¼€å’Œ](https://www.acwing.com/problem/content/797/)\n\n<a name=\"aJwbp\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\n- åœ¨è¾“å…¥æ—¶ï¼Œé¡ºä¾¿è®°å½•å‰`i`é¡¹çš„å’Œï¼Œ`i`ä»`1 ~ n`ï¼Œè®°ä¸ºï¼š`s[i]`ï¼Œå½“éœ€è¦æ±‚ç¬¬`i`ä¸ªæ•°åˆ°ç¬¬`j` ä¸ªæ•°çš„å’Œæ—¶ï¼Œç›´æ¥ä½¿ç”¨`s[j] - s[i - 1]`ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º`O(1)`ï¼Œæ¯”é‡æ–°éå†æ›´å¿«ã€‚\n- ä½†æ˜¯ï¼Œå¦‚æœæ•°æ®ä¼šå‘ç”Ÿæ”¹å˜ï¼Œåˆ™å‰ç¼€å’Œæ•°ç»„ä¹Ÿä¼šå‘ç”Ÿæ”¹å˜ï¼Œè€Œè¿™ç§æ–¹å¼æ±‚è§£å‰ç¼€å’Œæ˜¯$\\mathcal{O}(n)$çš„ã€‚åˆ™æ­¤æ—¶éœ€è¦ä½¿ç”¨æ ‘çŠ¶æ•°ç»„æˆ–è€…çº¿æ®µæ ‘è¿›è¡Œæ±‚è§£ï¼ˆè¯¦è§ç¬¬äºŒç« `2.9`ï¼‰ã€‚\n  <a name=\"Sa1Cj\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\ns[i] = a[1] + a[2] + ... a[i]\n\n// è¾“å…¥æ•°ç»„æ—¶é¡ºå¸¦æ±‚å‡ºå‰ç¼€å’Œ\nfor (int i = 1; i <= n; i ++) {\n    a[i] = sc.nextInt();\n    // sum[0] é»˜è®¤ä¸º 0\n    sum[i] = sum[i - 1] + a[i];\n}\n\n// åªéœ€è¦å‰ç¼€å’Œ\nfor (int i = 1; i <= n; i ++) s[i] = s[i - 1] + sc.nextInt();\n\na[l] + ... + a[r] = s[r] - s[l - 1]\n```\n\n<a name=\"w7f5T\"></a>\n\n### 1.6 äºŒç»´å‰ç¼€å’Œï¼š[äºŒç»´å‰ç¼€å’Œ](https://www.acwing.com/problem/content/798/)\n\n<a name=\"ss2Vn\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\näºŒç»´å‰ç¼€å’Œæ€æƒ³ç±»ä¼¼äºä¸€ç»´å‰ç¼€å’Œï¼Œç”¨`s[i][j]`è¡¨ç¤ºä»¥`(i,j)`ä¸ºå³ä¸‹è§’ï¼Œ`(0,0)`ä¸ºå·¦ä¸Šè§’çš„å­çŸ©é˜µä¸­æ‰€æœ‰æ•°ä¹‹å’Œã€‚å¯ç”¨äºæ±‚è§£ä»¥`(x1, y1)`ä¸ºå·¦ä¸Šè§’ï¼Œ`(x2, y2)`ä¸ºå³ä¸‹è§’çš„å­çŸ©é˜µçš„å’Œä¸ºï¼ˆå¯åˆ©ç”¨å®¹æ–¥åŸç†æ¨å¯¼ï¼‰ã€‚\n<a name=\"viQAr\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\nfor (int i = 1; i <= n; i ++)\n    for (int j = 1; j <= m; j ++)\n\t// æ±‚å‰ç¼€å’ŒçŸ©é˜µ\n        s[i][j] = s[i - 1][j] + s[i][j - 1] - s[i - 1][j - 1] + a[i][j];\n// æ±‚è§£ä»¥(x1, y1)ä¸ºå·¦ä¸Šè§’ï¼Œ(x2, y2)ä¸ºå³ä¸‹è§’çš„å­çŸ©é˜µçš„å’Œ\nint res = s[x2][y2] - s[x1 - 1][y2] - s[x2][y1 - 1] + s[x1 - 1][y1 - 1];\n```\n\n<a name=\"ovvCL\"></a>\n\n### 1.7 ä¸€ç»´å·®åˆ†ï¼š[å·®åˆ†](https://www.acwing.com/problem/content/799/)\n\n<a name=\"klHY9\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\n- å®é™…ä¸Šï¼Œå·®åˆ†ä¸å‰ç¼€å’Œäº’ä¸ºé€†è¿ç®—ï¼Œä¾‹å¦‚ï¼Œå¦‚æœæ•°ç»„`s`ä¸ºæ•°ç»„`a`çš„å‰ç¼€å’Œæ•°ç»„ï¼Œé‚£ä¹ˆ`a`åˆ™ç§°ä¸º`s`çš„å·®åˆ†æ•°ç»„ï¼Œå³`a[i] = s[i] - s[i - 1]`ã€‚\n- å·®åˆ†æ•°ç»„çš„ä½œç”¨åœ¨äºï¼Œå¦‚æœéœ€è¦å¯¹ä¸€ä¸ªæ•°ç»„ä¸­çš„`l ~ r`åŒºé—´çš„`k`ä¸ªæ•°å­—å‡åŠ ä¸Š`c`ï¼Œåˆ™æ—¶é—´å¤æ‚åº¦ä¸`k`ç›¸å…³ï¼Œè€Œå¯¹å…¶å·®åˆ†æ•°ç»„è¿›è¡Œæ“ä½œï¼Œåˆ™åªéœ€åœ¨å…¶å·®åˆ†æ•°ç»„çš„ç¬¬`l`é¡¹åŠ `c`ï¼Œå†å¯¹ç¬¬`r + 1`é¡¹å‡å»`c`ï¼Œæ—¶é—´å¤æ‚åº¦é™ä¸º$\\mathcal{O}(1)$ã€‚\n  <a name=\"hSUFq\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\n// æ’å…¥æ“ä½œï¼Œç”¨äºå¯¹å·®åˆ†æ•°ç»„çš„ä¿®æ”¹ï¼Œa æ•°ç»„åˆå§‹åŒ–ä¸º 0\npublic static void insert(int l, int r, int c) {\n    a[l] += c;\n    a[r + 1] -= c;\n}\n\n// è¯»å…¥éœ€è¦æ“ä½œçš„åŸæ•°ç»„\nfor (int i = 1; i <= n; i ++) s[i] = sc.nextInt(); \n\n/*\nåˆ©ç”¨æ’å…¥æ“ä½œï¼Œç›´æ¥æ±‚è§£sæ•°ç»„çš„å·®åˆ†æ•°ç»„aã€‚\nåŸç†æ˜¯åœ¨a[i]ä½ç½®æ’å…¥s[i]åï¼Œa[i + 1]ä¼šå…ˆå‡å»s[i]ï¼Œ\nç­‰åˆ°i = i + 1æ—¶ï¼Œa[i + 1]çš„ä½ç½®ä¼šåŠ ä¸Šs[i + 1]ï¼Œåˆ™æœ€ç»ˆa[i + 1]ä½ç½®ä¸Šçš„æ•°\næ­£å¥½ä¸ºs[i + 1] - s[i]ï¼Œç”±å®šä¹‰å¯çŸ¥ï¼Œaæ­£å¥½æ„æˆsçš„å·®åˆ†æ•°ç»„\n*/\nfor (int i = 1; i <= n; i ++) insert(i, i, s[i]); \n\n// å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æ ¹æ®å®šä¹‰æ±‚å·®åˆ†æ•°ç»„ï¼ša[i] = s[i] - s[i - 1];\n\n// è¯¥æ“ä½œå¯èƒ½ä¼šæœ‰å¾ˆå¤šç»„ï¼Œç›´æ¥å¯¹sæ•°ç»„æ“ä½œæ—¶é—´å¤æ‚åº¦è¾ƒé«˜ï¼Œåˆ™å¯¹å…¶å·®åˆ†æ•°ç»„æ“ä½œï¼Œæœ€åç»Ÿä¸€æ±‚ä¸€æ¬¡å‰ç¼€å’Œå³å¯å¾—åˆ°æ–°çš„sæ•°ç»„\nint l = sc.nextInt(), r = sc.nextInt(), c = sc.nextInt();\ninsert(l, r, c);\n\n// æ±‚ä¸€éå‰ç¼€å’Œ\nfor (int i = i; i <= n; i ++) b[i] += b[i - 1]; \n```\n\n<a name=\"uHO1j\"></a>\n\n### 1.8 äºŒç»´å·®åˆ†ï¼š[å·®åˆ†çŸ©é˜µ](https://www.acwing.com/problem/content/800/)\n\n<a name=\"oOJrb\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\n- ç±»ä¼¼äºä¸€ç»´å·®åˆ†ï¼ŒäºŒç»´å·®åˆ†ä¸äºŒç»´å‰ç¼€å’Œäº’ä¸ºé€†è¿ç®—ï¼Œä¾‹å¦‚ï¼Œæ•°ç»„`s`æ˜¯æ•°ç»„`b`çš„å‰ç¼€å’Œæ•°ç»„ï¼Œé‚£ä¹ˆ`b`å°±ç§°ä¸º`s`å·®åˆ†æ•°ç»„ã€‚\n- äºŒç»´å·®åˆ†æ•°ç»„çš„ä½œç”¨åœ¨äºï¼Œå¦‚æœéœ€è¦å¯¹äºŒç»´çŸ©é˜µä¸­ä»¥`(x1, y1)`ä¸ºå·¦ä¸Šè§’ï¼Œ`(x2, y2)`ä¸ºå³ä¸‹è§’çš„åŒºåŸŸå†…æ¯ä¸ªæ•°åŠ ä¸Š`c`ï¼Œé‚£ä¹ˆå¯ä»¥å¯¹å·®åˆ†çŸ©é˜µä¸­`b[x1][y1]`åŠ ä¸Š`c`ï¼Œå¯¹`b[x2 + 1][y1]`ä¸`b[x1][y2 + 1]`å‡å»`c`ï¼Œå†å¯¹`b[x2 + 1][y2 + 1]`å‡å»`c`ã€‚å› ä¸ºå¯¹`b[x1][y1]`ï¼Œå°†ä¼šå¯¼è‡´æ±‚å‰ç¼€å’Œåï¼Œ`s[x1][y1]`åˆ°å³ä¸‹è§’è¿™éƒ¨åˆ†åŒºåŸŸæ¯ä¸ªæ•°éƒ½åŠ ä¸Š`c`ï¼Œå› æ­¤ï¼Œæ ¹æ®å®¹æ–¥åŸç†ï¼Œéœ€å¯¹å…¶ä»–éƒ¨åˆ†è¿›è¡Œå¦‚ä¸Šå¤„ç†ã€‚\n- åŒæ—¶ï¼Œä¸ä¸€ç»´å·®åˆ†ç±»ä¼¼ï¼ŒäºŒç»´å·®åˆ†ä¹Ÿä¸ç”¨å»æƒ³å¦‚ä½•æ„é€ å·®åˆ†æ•°ç»„ï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨æ’å…¥æ“ä½œå®Œæˆã€‚\n  <a name=\"NmWSH\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\n// æ’å…¥æ“ä½œï¼Œç”¨äºå¯¹å·®åˆ†æ•°ç»„bè¿›è¡Œä¿®æ”¹ï¼ŒåŒæ—¶å¯ä»¥ç”¨æ¥æ„é€ å·®åˆ†æ•°ç»„b\npublic static void insert(int x1, int y1, int x2, int y2, int c) {\n    b[x1][y1] += c; // åŠ cåå³ä¸‹è§’éƒ½å°†+c\n    b[x2 + 1][y1] -= c; // éœ€è¦å¯¹b[x2 + 1][y1]å³ä¸‹è§’å‡å»ä¸€ä¸ªcä½¿å…¶ä¿æŒä¸å˜\n    b[x1][y2 + 1] -= c; // éœ€è¦å¯¹b[x1][y2 + 1]å³ä¸‹è§’å‡å»ä¸€ä¸ªcä½¿å…¶ä¿æŒä¸å˜\n    b[x2 + 1][y2 + 1] += c; // b[x2 + 1][y2 + 1]å³ä¸‹è§’è¢«å‡äº†ä¸¤æ¬¡ï¼Œéœ€è¦åŠ ä¸€æ¬¡è¡¥å›æ¥\n}\n\n// è¯»å…¥éœ€è¦æ“ä½œçš„äºŒç»´æ•°ç»„\nfor (int i = 1; i <= n; i ++)\n    for (int j = 1; j <= m; j ++)\n        s[i][j] = sc.nextInt();\n\n// æ±‚å·®åˆ†æ•°ç»„ b\nfor (int i = 1; i <= n; i ++)\n    for (int j = 1; j <= m; j ++)\n        insert(i, j, i, j, s[i][j]);\n\n// å¯¹åŸæ•°ç»„ O(n) çš„æ“ä½œç­‰ä»·äºå¯¹å·®åˆ†æ•°ç»„ O(1) çš„æ“ä½œ\nint x1 = sc.nextInt(), y1 = sc.nextInt(), x2 = sc.nextInt(), y2 = sc.nextInt(), c = sc.nextInt();\ninsert(x1, y1, x2, y2, c);\n\n// å¯¹ b æ•°ç»„æ±‚ä¸€éå‰ç¼€å’Œ\nfor (int i = 1; i <= n; i ++)\n    for (int j = 1; j <= m; j ++)\n        b[i][j] += b[i][j - 1] + b[i - 1][j] - b[i - 1][j - 1];\n```\n\n<a name=\"d3Hnq\"></a>\n\n### 1.9 åŒæŒ‡é’ˆï¼š [æœ€é•¿è¿ç»­ä¸é‡å¤å­åºåˆ—](https://www.acwing.com/problem/content/801/)\n\n<a name=\"K7CEY\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\n- åŒæŒ‡é’ˆç®—æ³•æ˜¯ä¼˜åŒ–æšä¸¾æœ€å¸¸ç”¨çš„ç®—æ³•ï¼Œå…¶æ ¸å¿ƒæ€æƒ³åœ¨äºé€šè¿‡æ‰¾åˆ°å•è°ƒæ€§ï¼Œå°†$\\mathcal{O}(n^2)$çš„æš´åŠ›æšä¸¾è½¬å˜æˆ$\\mathcal{O}(n)$çš„åŒæŒ‡é’ˆç®—æ³•ã€‚\n- è¯¥ç®—æ³•æœ‰ä¸¤ç±»ï¼Œç¬¬ä¸€ç±»ä¸ºç±»ä¼¼äºå½’å¹¶æ’åºä¸­ï¼Œåœ¨ä¸¤ä¸ªåŒºé—´ä¸Šå½’å¹¶çš„æ“ä½œã€‚ç¬¬äºŒç±»åˆ™åœ¨ä¸€ä¸ªåŒºé—´ä¸ŠåŠ¨æ€ç»´æŠ¤ä¸€ä¸ªå°åŒºé—´ã€‚\n  <a name=\"QzOAd\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\n// ç¬¬ä¸€ç±»åŒå½’å¹¶æ’åºä¸­ä¸¤ä¸ªæŒ‡é’ˆåŒæ—¶æ‰«æä¸¤ä¸ªæ•°ç»„\n\n// ç¬¬äºŒç±»\nfor (int i = 0, j = 0; i < n; i ++) {\n    while (j < i && check(i, j)) j ++; // j < i ä¹Ÿå¯ä»¥æ ¹æ®å…·ä½“é€»è¾‘é€‚å½“è°ƒæ•´ï¼Œcheck()ä¸ºæ£€éªŒæ˜¯å¦æ»¡è¶³æŸä¸€æ€§è´¨\n    // å…·ä½“é—®é¢˜çš„é€»è¾‘\n}\n```\n\n<a name=\"pIInD\"></a>\n\n#### æœ€é•¿è¿ç»­ä¸é‡å¤å­åºåˆ—é¢˜è§£ï¼ˆç¬¬äºŒç±»ï¼‰ï¼š\n\n**é¢˜ç›®æè¿°ï¼š**<br />ç»™å®šä¸€ä¸ªé•¿åº¦ä¸º`n`çš„æ•´æ•°åºåˆ—ï¼Œè¯·æ‰¾å‡ºæœ€é•¿çš„ä¸åŒ…å«é‡å¤çš„æ•°çš„è¿ç»­åŒºé—´ï¼Œè¾“å‡ºå®ƒçš„é•¿åº¦ã€‚<br />**è¾“å…¥æ ¼å¼ï¼š**<br />ç¬¬ä¸€è¡ŒåŒ…å«æ•´æ•°`n`ã€‚<br />ç¬¬äºŒè¡ŒåŒ…å«`n`ä¸ªæ•´æ•°ï¼Œè¡¨ç¤ºæ•´æ•°åºåˆ—ã€‚<br />**è¾“å‡ºæ ¼å¼ï¼š**<br />å…±ä¸€è¡Œï¼ŒåŒ…å«ä¸€ä¸ªæ•´æ•°ï¼Œè¡¨ç¤ºæœ€é•¿çš„ä¸åŒ…å«é‡å¤çš„æ•°çš„è¿ç»­åŒºé—´çš„é•¿åº¦ã€‚<br />**æ•°æ®èŒƒå›´ï¼š**<br />$1 \\leq n\\leq 10^5$<br />**è¾“å…¥æ ·ä¾‹ï¼š**\n\n```\n5\n1 2 2 3 5\n```\n\n**è¾“å‡ºæ ·ä¾‹ï¼š**\n\n```\n3\n```\n\n**åŒæŒ‡é’ˆç®—æ³•**$\\mathcal{O}(n)$**ï¼š**<br />å®šä¹‰ä¸¤ä¸ªæŒ‡é’ˆ`i, j`ï¼Œæ•°ç»„`a`ï¼Œ`i`ä»ç¬¬ä¸€ä¸ªå…ƒç´ å¼€å§‹å¾€åèµ°ï¼Œæ¯ç»è¿‡ä¸€ä¸ªå…ƒç´ ï¼Œç”¨`s`æ•°ç»„è®°å½•å½“å‰æ•°å­—å‡ºç°çš„æ¬¡æ•°ï¼Œå½“èµ°åˆ°æŸä¸ªå…ƒç´ `a[i]`æ—¶ï¼Œè‹¥`s[a[i]] > 1`ï¼Œåˆ™è¯´æ˜è¯¥æ•°å­—å‰é¢å‡ºç°è¿‡ä¸€æ¬¡ï¼Œæ­¤æ—¶è®©`j`æŒ‡é’ˆå‘åèµ°ï¼Œ`j`æŒ‡é’ˆæ¯ç»è¿‡ä¸€ä¸ªå…ƒç´ ï¼Œå°±è®©è¯¥å…ƒç´ å‡ºç°æ¬¡æ•°å°±å‡ä¸€ï¼Œå½“ä¸æ»¡è¶³`s[a[i]] > 1`æ—¶ï¼Œè¯´æ˜`j`åˆšå¥½ç»è¿‡ä¸`a[i]`é‡å¤çš„é‚£ä¸ªæ•°å€¼ï¼Œåˆ™æ­¤æ—¶`j`ä¸å†å‘åèµ°ï¼Œè®°å½•`j ~ i`ä¹‹é—´å…ƒç´ ä¸ªæ•°ï¼Œç„¶å`i`ç»§ç»­å‘åèµ°ï¼Œé‡å¤æ­¤è¿‡ç¨‹ï¼Œç›´åˆ°èµ°å®Œæ•´ä¸ªæ•°ç»„ã€‚\n\n```java\nimport java.util.Scanner;\n\npublic class Main {\n\n    static final int N = 100010;\n\n    public static void main(String[] args) {\n        Scanner sc = new Scanner(System.in);\n        int n = sc.nextInt();\n        int[] a = new int[n];\n        int[] s = new int[N]; // ç”¨äºè®°å½•æ¯ä½æ•°å‡ºç°çš„æ¬¡æ•°\n\n        for (int i = 0; i < n; i ++)\n            a[i] = sc.nextInt();\n\n        int res = 0;\n        for (int i = 0, j = 0; i < n; i ++) {\n            s[a[i]] ++; // æ¯æ¬¡ i å¾€åèµ°ï¼Œç›¸åº”çš„æ•°å­—å‡ºç°çš„æ¬¡æ•°å°±è‡ªå¢\n            while (j < i && s[a[i]] > 1) {\n                s[a[j]] --; // è®© j ç»è¿‡çš„æ•°å­—å‡ºç°çš„æ¬¡æ•°å‡ä¸€\n                j ++; // j å¾€åèµ°\n            }\n            // è¿™ä¸€æ­¥å°±ç®—æ²¡æœ‰é‡åˆ°é‡å¤å…ƒç´ ä¹Ÿä¼šè®¡ç®—æœ€é•¿ä¸è¿ç»­æ•°ç›®\n            res = Math.max(res, i - j + 1); \n        }\n        System.out.println(res);\n    }\n}\n```\n\n> è¿™é“é¢˜è¿˜æœ‰æ»‘åŠ¨çª—å£è§£æ³•ï¼Œæ»‘åŠ¨çª—å£æ›´å¥½ç†è§£ï¼Œè®¸å¤šåŒæŒ‡é’ˆç†è§£èµ·æ¥è¾ƒä¸ºæŠ½è±¡çš„é¢˜ç›®å‡å¯ä½¿ç”¨æ»‘åŠ¨çª—å£è§£å†³ï¼Œè¯¦è§ç¬¬äºŒç« `2.5`æ»‘åŠ¨çª—å£æ¨¡æ¿ã€‚\n\n<a name=\"b3uG4\"></a>\n\n### 1.10 ä½è¿ç®—ï¼š[äºŒè¿›åˆ¶ä¸­1çš„ä¸ªæ•°](https://www.acwing.com/problem/content/803/)\n\n<a name=\"gIDbD\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\nè¯¥éƒ¨åˆ†ä¸å­˜åœ¨ä»€ä¹ˆæ€æƒ³ï¼Œæ›´å¤šçš„æ˜¯è¯­æ³•ï¼Œä¼šç”¨å³å¯ã€‚<br />**ç”¨æ³•ä¸€ï¼š** æ±‚`n`çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸­ç¬¬`k`ä½ï¼ˆä»å³å¾€å·¦çœ‹ï¼Œæœ€å³è¾¹ä¸ºç¬¬`0`ä½ï¼‰æ•°å­—ã€‚**åŸç†ï¼š** n >> k & 1ã€‚<br />**ç”¨æ³•äºŒï¼š**`lowbit`æ“ä½œï¼Œè¿”å›`x`çš„æœ€åä¸€ä½`1`ï¼Œä¾‹å¦‚`x = (1010)â‚‚`ï¼Œåˆ™`lowbit(x) = 10`ï¼›è‹¥`x = (101000)â‚‚`ï¼Œåˆ™`lowbit(x) = 1000`ï¼Œå…·ä½“è§ä»£ç å®ç°ã€‚**åŸç†ï¼š** å› ä¸º`x & -x = x & (~x + 1)`ï¼Œè€Œ`x & (~x + 1)`èƒ½è¿”å›`x`çš„æœ€åä¸€ä½`1`ï¼Œæ‰€ä»¥ä¸€èˆ¬ç”¨`x & -x`æ±‚è§£`x`çš„æœ€åä¸€ä½`1`ã€‚ï¼ˆ`lowbit`æ“ä½œæ˜¯æ ‘çŠ¶æ•°ç»„çš„åŸºç¡€ã€‚ï¼‰\n<a name=\"yGatg\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\n// ç”¨æ³•ä¸€ï¼šæ±‚ n çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸­ç¬¬ k ä½æ•°å­—\nint res = n >> k & 1;\n\n// ç”¨æ³•äºŒï¼šè¿”å› x çš„æœ€åä¸€ä½ 1\npublic static int lowbit(int x) {\n    return x & -x;\n}\n\n// æ±‚è§£ä¸€ä¸ªäºŒè¿›åˆ¶æ•°ä¸­å«æœ‰å¤šå°‘ä¸ª1çš„é—®é¢˜æ—¶ï¼Œå¯ä»¥æ¯æ¬¡å‡å»æœ€åä¸€ä½1ï¼ˆç”¨lowbitå®ç°ï¼‰ï¼Œå‡äº†å¤šå°‘æ¬¡å°±ä»£è¡¨æœ‰å¤šå°‘ä¸ª1ï¼ˆçŠ¶æ€å‹ç¼©å¸¸ç”¨ï¼‰\n// æˆ–è€…ä½¿ç”¨ Integer çš„é™æ€æ–¹æ³• bitCount\nint cnt = Integer.bitCount(x);\n```\n\n<a name=\"e5nZx\"></a>\n\n### 1.11 ç¦»æ•£åŒ–ï¼š[ç¦»æ•£åŒ–](https://www.acwing.com/problem/content/804/)\n\n<a name=\"RuxyK\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\nç¦»æ•£åŒ–çš„æ€æƒ³æ˜¯å°†æ•°å€¼èŒƒå›´å¾ˆå¤§ï¼Œä½†æ˜¯æ•°æ®é‡ä¸å¤§çš„ä¸€ç³»åˆ—æ•°æ˜ å°„åˆ°ä»`0`å¼€å§‹çš„æœ‰åºé€’å¢çš„åŒºé—´ï¼Œä»è€Œé™ä½ç®—æ³•çš„æ—¶é—´å’Œç©ºé—´å¤æ‚åº¦ã€‚ç¦»æ•£åŒ–ä¸æ”¹å˜æ•°æ®é—´çš„ç›¸å¯¹å¤§å°ï¼Œå‹ç¼©æ•°æ®é—´æ— ç”¨çš„è·ç¦»ã€‚ä¾‹å¦‚ï¼Œ`1, 3, 200, 48, 67349, 6546646`è¿™ä¸€ç³»åˆ—æ•°çš„èŒƒå›´ä¸º`1 ~ 6546646`ï¼Œä¸­é—´æœ‰è®¸å¤šæ— ç”¨çš„è·ç¦»ï¼Œæˆ‘ä»¬å°†å…¶å‹ç¼©åˆ°`0 ~ 5`è¿™å‡ ä¸ªä½ç½®ï¼ˆæœ‰æ—¶æ˜ å°„åˆ°ä»`1`å¼€å§‹æ›´åŠ æ–¹ä¾¿ï¼‰ï¼Œæ­¤æ—¶å°±äº§ç”Ÿäº†æ˜ å°„å…³ç³»`0 -> 1, 1 -> 3, 2 -> 48, 3 -> 200, 4 -> 67349, 5 -> 6546646`ã€‚è¿™ä¸ç›´æ¥å¼€ä¸€ä¸ªæ•°ç»„å°†ä»–ä»¬å­˜è¿›å»å†æ’åºæ˜¯æœ‰æœ¬è´¨åŒºåˆ«çš„ï¼Œä¾‹å¦‚æˆ‘ä»¬æƒ³å¯¹`200`è¿™ä¸ªå€¼åŠ ä¸Š`50`ï¼Œå¦‚æœç›´æ¥å¼€æ•°ç»„ï¼Œæƒ³è¦æ‰¾åˆ°`200`è¿™ä¸ªå€¼ï¼Œéœ€è¦éå†ä¸€éï¼Œè€Œå¦‚æœæ˜¯é€šè¿‡ç¦»æ•£åŒ–æ˜ å°„ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åˆ©ç”¨æ˜ å°„å…³ç³»æ‰¾åˆ°åœ¨ä»€ä¹ˆä½ç½®ï¼Œç„¶åç›´æ¥è¿›è¡Œæ“ä½œï¼Œè¯¥æ­¥éª¤æ—¶é—´å¤æ‚åº¦ç›´æ¥é™ä½åˆ°$\\mathcal{O}(1)$ã€‚åœ¨æ˜ å°„ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ•°æ®è¿›è¡Œæ’åºï¼Œä¾¿äºåé¢ç”¨æ•´æ•°äºŒåˆ†æ‰¾åˆ°æ¯ä¸ªæ•°å¯¹åº”çš„æ˜ å°„å€¼ï¼ˆä¸‹æ ‡ï¼‰ã€‚åŒæ—¶éœ€è¦å¯¹æ•°æ®è¿›è¡Œå»é‡ï¼Œå› ä¸ºå³ä½¿æœ‰ä¸¤ä¸ª`200`ï¼Œæˆ‘ä»¬æ¯æ¬¡å¯¹`200`æ“ä½œæ—¶ï¼Œä¹Ÿæ˜¯åœ¨åŒä¸€ä¸ªä½ç½®ä¸Šè¿›è¡Œæ“ä½œçš„ï¼Œå› æ­¤é‡å¤çš„é‚£ä¸ª`200`ä¸ä½†æ²¡æœ‰å­˜åœ¨çš„æ„ä¹‰ï¼Œåè€Œå½±å“åœ¨äºŒåˆ†æ—¶å¯»æ‰¾å…¶æ˜ å°„å€¼ï¼ˆä¸‹æ ‡ï¼‰ã€‚\n<a name=\"UmYOB\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\n// å°†æ‰€æœ‰å€¼æ’åºï¼Œç„¶åå»é‡\nArrays.sort(alls); \n\n// äºŒåˆ†æ‰¾åˆ°æ¯ä¸ªæ•°ç¦»æ•£åŒ–åçš„å€¼ï¼ˆæ ¸å¿ƒï¼‰\npublic static int find(int x) {\n    int l = 0, r = alls.size() - 1;\n    while (l < r) {\n        int mid = l + r >> 1;\n        if (alls[mid] >= x) r = mid;\n        else l = mid + 1;\n    }\n    // å°†ç¦»æ•£åŒ–åçš„å€¼æ˜ å°„åˆ° 1 ~ nï¼Œä¾¿äºå¯èƒ½éœ€è¦æ±‚å‰ç¼€å’Œçš„æƒ…å†µã€‚\n    return r + 1;\n}\n```\n\n<a name=\"XdJSs\"></a>\n\n### 1.12 åŒºé—´åˆå¹¶ï¼š[åŒºé—´åˆå¹¶](https://www.acwing.com/problem/content/805/)\n\n<a name=\"on9RB\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\nåŒºé—´åˆå¹¶æ˜¯å°†æ•°è½´ä¸Šæ‰€æœ‰æœ‰äº¤é›†çš„åŒºé—´è¿›è¡Œåˆå¹¶ï¼Œå¾—åˆ°æ²¡æœ‰äº¤é›†çš„åŒºé—´ã€‚ä¾‹å¦‚å°†åŒºé—´`[0, 2], [3, 7], [4, 5], [7, 10], [13, 15]`åˆå¹¶åçš„åŒºé—´ä¸º`[0, 2], [3, 10], [13, 15]`ã€‚å…¶æ€æƒ³ç±»ä¼¼äºè´ªå¿ƒï¼Œå…ˆå°†æ‰€æœ‰åŒºé—´æŒ‰ç…§å·¦ç«¯ç‚¹è¿›è¡Œæ’åºï¼Œæ¯æ¬¡ç»´æŠ¤ä¸€ä¸ªåŒºé—´ï¼Œ**å¦‚æœ**æšä¸¾çš„åŒºé—´ä¸å½“å‰åŒºé—´æ— äº¤é›†ï¼Œåˆ™å°†ç»´æŠ¤çš„åŒºé—´æ”¾å…¥ç­”æ¡ˆä¸­å»ï¼Œå†å°†ç»´æŠ¤çš„åŒºé—´æ›´æ–°ä¸ºæšä¸¾çš„åŒºé—´ï¼Œ**å¦åˆ™**å°†ç»´æŠ¤çš„åŒºé—´çš„å³ç«¯ç‚¹æ›´æ–°ä¸ºç»´æŠ¤åŒºé—´ä¸æšä¸¾åŒºé—´å³ç«¯ç‚¹çš„æœ€å¤§å€¼ã€‚\n<a name=\"xxgs3\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\nclass PII implements Comparable<PII> {\n    int x, y;\n    public PII(int x, int y) {\n        this.x = x;\n        this.y = y;\n    }\n    public int compareTo(PII p) {\n        return x - p.x;\n    }\n}\n\n// å°†æ‰€æœ‰åŒºé—´åˆå¹¶\npublic static ArrayList<PII> merge(ArrayList<PII> segs) {\n    ArrayList<PII> res = new ArrayList();\n    Collections.sort(segs);\n    int l = -2000000000, r = -2000000000;\n    for (var seg : segs)\n        if (seg.x > r) {\n            if (l != -2000000000)\n                res.add(new PII(l, r));\n            l = seg.x;\n            r = seg.y;\n        }\n        else r = Math.max(r, seg.y);\n\n    if (l != -2000000000) res.add(new PII(l, r));\n    return res;\n}\n```\n\n<a name=\"fJFhl\"></a>\n\n#### æ–°æ€»ç»“çš„æ¨¡æ¿ï¼ˆ2024-03-12ï¼‰ï¼š\n\n```java\n// æ±‚åˆå¹¶åçš„åŒºé—´ä¸ªæ•°\nimport java.util.*;\n\npublic class Main {\n    static class Segement implements Comparable<Segement> {\n        int x, y;\n        public Segement(int x, int y) {\n            this.x = x;\n            this.y = y;\n        }\n        @Override\n        public int compareTo(Segement s) {\n            if (x != s.x) return x - s.x;\n            return s.y - y;\n        }\n    }\n    static final int N = 100010;\n    static Segement[] segments = new Segement[N];\n    public static void main(String[] args) {\n        Scanner sc = new Scanner(System.in);\n        int n = sc.nextInt();\n        for (int i = 0; i < n; i ++) \n            segments[i] = new Segement(sc.nextInt(), sc.nextInt());\n        Arrays.sort(segments, 0, n);\n        int lastEnd = segments[0].y, res = 1;\n        for (int i = 1; i < n; i ++) {\n            int x = segments[i].x, y = segments[i].y;\n            if (y <= lastEnd) continue;\n            if (x > lastEnd) res ++;\n            lastEnd = y;\n        }\n        System.out.println(res);\n    }\n}\n```\n\n<a name=\"r4jwx\"></a>\n\n## ç¬¬äºŒç« ï¼šæ•°æ®ç»“æ„\n\n> `2.1 ~ 2.3èŠ‚`åœ¨ç®—æ³•é¢˜ä¸­ä¸€èˆ¬ä¸ä¼šè¢«ç›´æ¥ç”¨åˆ°ï¼Œä½†æ˜¯å´æ˜¯åé¢çš„é‚»æ¥è¡¨ï¼ˆå›¾è®ºï¼‰å’Œå•è°ƒæ ˆåŠå•è°ƒé˜Ÿåˆ—çš„åŸºç¡€ï¼ˆå½“ç„¶å•¦ï¼Œä¹Ÿå¯ä»¥è¢«Javaçš„é›†åˆä»£æ›¿ ~~ï¼Œæ¯•ç«ŸJavaæ˜¯æœ€å¼ºè¯­è¨€~~ï¼‰ã€‚\n\n<a name=\"hfS0i\"></a>\n\n### 2.1 å•é“¾è¡¨ï¼š[å•é“¾è¡¨](https://www.acwing.com/problem/content/828/)\n\n<a name=\"KWRjs\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\n- è¯¥éƒ¨åˆ†ä¸»è¦é€šè¿‡æ•°ç»„æ¨¡æ‹Ÿå•é“¾è¡¨ï¼Œè¿›è¡Œæ’å…¥ç»“ç‚¹ã€åˆ é™¤ç»“ç‚¹ç­‰æ“ä½œã€‚ä¹‹æ‰€ä»¥éœ€è¦ç”¨æ•°ç»„è¿›è¡Œæ¨¡æ‹Ÿï¼Œæ˜¯å› ä¸ºåœ¨`C ++`æˆ–`java`ä¸­ï¼Œ`new`æ“ä½œæ˜¯éå¸¸æ…¢çš„ï¼Œåœ¨æ•°æ®èŒƒå›´æ¯”è¾ƒå¤§çš„æƒ…å†µå’Œå®¹æ˜“`TLE`ï¼Œå¹¶ä¸”ï¼Œåœ¨å¾ˆå¤šæ—¶å€™ï¼Œå®¹å™¨å¯ä»¥åšçš„æ•°ç»„éƒ½å¯ä»¥åšï¼Œè€Œæ•°ç»„å¯ä»¥åšçš„ï¼Œå®¹å™¨ä¸ä¸€å®šå¯ä»¥åšã€‚é‚£ä¹ˆåˆ©ç”¨æ•°ç»„æ¨¡æ‹Ÿå°±æ˜¾å¾—ååˆ†æœ‰ä¼˜åŠ¿ã€‚é€šè¿‡æ•°ç»„æ¨¡æ‹Ÿå•é“¾è¡¨ï¼Œéœ€è¦å®šä¹‰`head, e[], ne[], idx`ï¼Œå…¶ä¸­`head`è¡¨ç¤ºå¤´ç»“ç‚¹ï¼Œ`e[]`è¡¨ç¤ºæ¯ä¸ªç‚¹çš„å€¼ï¼Œ`ne[]`è¡¨ç¤ºæ¯ä¸ªç‚¹æ‰€æŒ‡å‘çš„ä¸‹ä¸€ä¸ªç‚¹çš„ä¸‹æ ‡ï¼Œ`idx`è¡¨ç¤ºå½“å‰å·²ç»ç”¨åˆ°äº†å“ªä¸ªç‚¹ï¼ˆæ­¤æ—¶`idx`è¿˜æ²¡è¢«ç”¨ï¼‰ã€‚\n- è¯¥éƒ¨åˆ†æ˜¯åé¢é‚»æ¥è¡¨ï¼ˆå›¾è®ºï¼‰éƒ¨åˆ†çš„åŸºç¡€ï¼Œååˆ†é‡è¦ã€‚\n  <a name=\"X5uDH\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\n// headå­˜å‚¨é“¾è¡¨å¤´ï¼Œe[]å­˜å‚¨èŠ‚ç‚¹çš„å€¼ï¼Œne[]å­˜å‚¨èŠ‚ç‚¹çš„nextæŒ‡é’ˆï¼Œidxè¡¨ç¤ºå½“å‰ç”¨åˆ°äº†å“ªä¸ªèŠ‚ç‚¹\nstatic int head;\nstatic int[] e = new int[N];\nstatic int[] ne = new int[N];\nstatic int idx;\n\n// åˆå§‹åŒ–\npublic static void init() {\n    head = -1;\n    idx = 0;\n}\n\n// åœ¨è¡¨å¤´æ’å…¥ä¸€ä¸ªæ•°x\npublic static void addHead(int x) {\n    e[idx] = x;\n    ne[idx] = head;\n    // æ­¤æ—¶ idx æœªè¢«ä½¿ç”¨è¿‡ï¼Œç°åœ¨ä½¿ç”¨ idx\n    head = idx;\n    // idx ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªä½ç½®å¤‡ç”¨\n    idx ++;\n}\n\n// åœ¨ä¸‹æ ‡ä¸ºkçš„ç»“ç‚¹åé¢æ’å…¥ä¸€ä¸ªæ•°x\npublic static void add(int k, int x) {\n    e[idx] = x;\n    ne[idx] = ne[k];\n    ne[k] = idx;\n    idx ++;\n}\n\n// åˆ é™¤ä¸‹æ ‡ä¸ºkçš„ç»“ç‚¹åé¢çš„ä¸€ä¸ªç»“ç‚¹\npublic static void remove(int k) {\n    if (k == 0 && head != -1) head = ne[head]; // ç‰¹åˆ¤æ˜¯å¦ä¸ºå¤´ç»“ç‚¹ï¼Œåˆ é™¤å¤´ç»“ç‚¹æ—¶éœ€è¦åˆ¤æ–­å¤´ç»“ç‚¹æ˜¯å¦å­˜åœ¨\n\telse ne[k] = ne[ne[k]];\n}\n\n// å•é“¾è¡¨çš„éå†\nfor (int i = head; i != -1; i = ne[i]) System.out.printf(\"%d \", e[i]);\n```\n\n<a name=\"LD5fE\"></a>\n\n### 2.2 åŒé“¾è¡¨ï¼š[åŒé“¾è¡¨](https://www.acwing.com/problem/content/829/)\n\n<a name=\"z7DAc\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\nä¸å•é“¾è¡¨ç›¸ä¼¼ï¼Œç”¨æ•°ç»„æ¨¡æ‹ŸåŒé“¾è¡¨ã€‚éœ€å®šä¹‰æ•°ç»„`e, l, r`å’Œå˜é‡`idx`ï¼Œå…¶ä¸­`e`è¡¨ç¤ºæ¯ä¸ªç»“ç‚¹çš„å€¼ï¼Œ`l`è¡¨ç¤ºç»“ç‚¹çš„ä¸Šä¸€ä¸ªç»“ç‚¹ä¸‹æ ‡ï¼Œ`r`è¡¨ç¤ºç»“ç‚¹çš„ä¸‹ä¸€ä¸ªç»“ç‚¹ä¸‹æ ‡ï¼Œ`idx`è¡¨ç¤ºå½“å‰ç”¨åˆ°äº†å“ªä¸ªç‚¹ï¼ˆæ­¤æ—¶`idx`è¿˜æœªè¢«ä½¿ç”¨ï¼‰ã€‚\n<a name=\"YAAEH\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\nint e[N], l[N], r[N], idx;\n\n// åˆå§‹åŒ–é“¾è¡¨\npublic static void init() {\n    // 0æ˜¯å·¦ç«¯ç‚¹ï¼Œ1æ˜¯å³ç«¯ç‚¹\n    r[0] = 1;\n    l[1] = 0;\n    idx = 2;\n}\n\n// åœ¨èŠ‚ç‚¹kçš„å³è¾¹æ’å…¥ä¸€ä¸ªæ•°x\npublic static void insert(int k, int x) {\n    e[idx] = x;\n    l[idx] = k;\n    r[idx] = r[k];\n    l[r[k]] = idx;\n    r[k] = idx ++ ;\n}\n\n// åˆ é™¤èŠ‚ç‚¹k\npublic static void remove(int k) {\n    // å…ˆåé¡ºåºæ— æ‰€è°“\n    l[r[k]] = l[k];\n    r[l[k]] = r[k];\n}\n\n// éå†åŒé“¾è¡¨\nfor (int i = r[0]; i != 1; i = r[i]) System.out.printf(\"%d \", e[i]);\n```\n\n<a name=\"HQyEP\"></a>\n\n### 2.3 æ ˆå’Œé˜Ÿåˆ—ï¼š[æ¨¡æ‹Ÿæ ˆ](https://www.acwing.com/activity/content/problem/content/865/)[æ¨¡æ‹Ÿé˜Ÿåˆ—](https://www.acwing.com/activity/content/problem/content/866/)\n\n<a name=\"tfBfT\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\nç”¨æ•°ç»„æ¨¡æ‹Ÿæ ˆå’Œé˜Ÿåˆ—ï¼Œæ“ä½œç›¸å¯¹ç®€å•ï¼Œå…·ä½“è§ä»£ç å®ç°ã€‚\n<a name=\"ynhRH\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\n// æ•°ç»„æ¨¡æ‹Ÿæ ˆ\nstatic int[] stk = new int[N];\nstatic int tt = 0; // æ ˆé¡¶æŒ‡é’ˆ\nstk[ ++ t] = x; // åœ¨æ ˆé¡¶æ’å…¥x\ntt --; // æ ˆé¡¶å…ƒç´ å‡ºæ ˆ\n\n// æ•°ç»„æ¨¡æ‹Ÿé˜Ÿåˆ—\nstatic int[] queue = new int[N];\nstatic int hh = 0, tt = -1;\nqueue[ ++ tt] = x; // åœ¨é˜Ÿå°¾æ’å…¥å…ƒç´ x\nhh ++; // å¼¹å‡ºé˜Ÿå¤´å…ƒç´ \n```\n\n<a name=\"q0EF5\"></a>\n\n### 2.4 å•è°ƒæ ˆï¼š[å•è°ƒæ ˆ](https://www.acwing.com/activity/content/problem/content/867/)\n\n<a name=\"YPTUg\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\nå•è°ƒæ ˆç”¨äºç»´æŠ¤ä¸€ä¸ªé€’å¢æˆ–é€’å‡çš„åºåˆ—ï¼Œå¯ä»¥å¿«é€Ÿæ±‚å‡ºæ¯ä¸ªæ•°å·¦/å³è¾¹ç¦»å®ƒæœ€è¿‘çš„æ¯”å®ƒ**å¤§/å°**çš„æ•°ã€‚\n<a name=\"dBq3R\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\nstatic final int N = 100010;\nint[] stk = new int[N];\n\nint n = sc.nextInt();\nint tt = 0;\nfor (int i = 0; i < n; i ++) {\n    int x = sc.nextInt();\n    while(tt > 0 && check(stk[tt])) tt --; // checkä¸ºå…·ä½“é¢˜ç›®çš„åˆ¤æ–­\n    if (tt > 0) System.out.printf(\"%d \", stk[tt]);\n    else System.out.printf(\"%d \", -1);\n    stk[++ tt] = x; // æ’å…¥æ–°å…ƒç´ \n}\n```\n\n<a name=\"Zm2Jf\"></a>\n\n### 2.5 å•è°ƒé˜Ÿåˆ—ï¼š[æ»‘åŠ¨çª—å£](https://www.acwing.com/activity/content/problem/content/868/)\n\n<a name=\"alsl0\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\n- å•è°ƒé˜Ÿåˆ—ä¸å•è°ƒæ ˆæ¯”è¾ƒç±»ä¼¼ï¼Œç”¨ä¸€ä¸ªé˜Ÿåˆ—åŠ¨æ€ç»´æŠ¤ä¸€ç»„æœ‰åºåºåˆ—ã€‚æ¯æ¬¡å…ˆåˆ¤æ–­é˜Ÿå¤´æ˜¯å¦éœ€è¦å‡ºæ ˆï¼Œç„¶åä»é˜Ÿå°¾å¼€å§‹å‘å‰æ£€æŸ¥é˜Ÿå°¾å…ƒç´ ä¸å½“å‰æšä¸¾å…ƒç´ çš„å…³ç³»ï¼Œå¦‚æœæ»¡è¶³`check(a[i])`ï¼Œåˆ™è®©é˜Ÿå°¾å…ƒç´ å¼¹å‡ºï¼Œç›´åˆ°é˜Ÿå°¾å…ƒç´ ä¸æ»¡è¶³æ¡ä»¶ã€‚æœ€åå†å°†å½“å‰æšä¸¾å…ƒç´ åŠ å…¥é˜Ÿåˆ—ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œé˜Ÿåˆ—`q[]`å­˜å‚¨çš„æ˜¯æ•°ç»„ä¸­å…ƒç´ çš„ä¸‹æ ‡ã€‚\n- è¯¥ç®—æ³•å¸¸ç”¨çš„åœºæ™¯ä¸ºæ±‚è§£æ»‘åŠ¨çª—å£ä¸­çš„æœ€å¤§å€¼æˆ–æœ€å°å€¼ã€å•è°ƒé˜Ÿåˆ—ä¼˜åŒ– **`dp`**ã€‚\n- [Leetcodeä¸€é¢˜ç§’æ‡‚å•è°ƒé˜Ÿåˆ—ï¼](https://leetcode.cn/problems/shortest-subarray-with-sum-at-least-k/description/)ï¼ˆåˆ©ç”¨Dequeå®ç°å•è°ƒé˜Ÿåˆ—ï¼‰\n  <a name=\"dVo8o\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\nint[] a = new int[N]; // å­˜å‚¨æ‰€æœ‰å…ƒç´ \nint[] q = new int[N]; // ç”¨äºåŠ¨æ€ç»´æŠ¤é˜Ÿåˆ—ï¼Œå­˜å‚¨çš„æ˜¯å…ƒç´ ä¸‹æ ‡\n\n// nè¡¨ç¤ºæ‰€æœ‰å…ƒç´ ä¸ªæ•°ï¼Œ kè¡¨ç¤ºå•è°ƒé˜Ÿåˆ—çš„å¤§å°\nint n = sc.nextInt(), k = sc.nextInt();\n\n// è¿™é‡Œçš„ttåˆå§‹å€¼æ˜¯æœ‰è¯´æ³•çš„ï¼Œå¦‚æœé˜Ÿåˆ—å¼€å§‹æ²¡æœ‰å…ƒç´ ï¼Œåˆ™tt = -1ï¼Œå¦åˆ™tt = 0;\nint hh = 0, tt = -1;\nfor (int i = 0; i < n; i ++) {\n    if (hh <= tt && i - k + 1 > q[hh]) hh ++; // åˆ¤æ–­é˜Ÿå¤´å…ƒç´ æ˜¯å¦éœ€è¦å‡ºé˜Ÿ\n    while (hh <= tt && a[i] <= a[q[tt]]) tt --; // åˆ¤æ–­é˜Ÿå°¾å…ƒç´ æ˜¯å¦éœ€è¦å¼¹å‡ºï¼Œa[i] <= a[q[tt]]å¯æ ¹æ®é¢˜ç›®å…·ä½“æ¡ä»¶æ›´æ¢\n    q[++ tt] = i; // å°†æšä¸¾çš„å…ƒç´ æ’å…¥é˜Ÿå°¾\n}\n```\n\n> `tt = 0` å’Œ `tt = -1`çš„æƒ…å†µå¯å‚è€ƒ[çƒ½ç«ä¼ é€’](https://www.acwing.com/activity/content/problem/content/9808/)ä¸[E. Rudolf and k Bridges](https://www.acwing.com/solution/content/235596/)è¿™ä¸¤é¢˜ã€‚\n\n<a name=\"vMWEj\"></a>\n\n#### å­ä¸²ç±»é—®é¢˜(æ»‘åŠ¨çª—å£ç®—æ³•æ¡†æ¶)ï¼š\n\n> æ³¨æ„ï¼šå•è°ƒé˜Ÿåˆ—å¹¶ä¸ä¸€å®šå¯¹æ‰€æœ‰çš„æ»‘åŠ¨çª—å£é¢˜ç›®å¥½ç”¨ï¼Œåªæ˜¯ä¸Šé¢è¿™é“é¢˜ä½¿ç”¨å•è°ƒé˜Ÿåˆ—èƒ½å®Œç¾è§£å†³ã€‚å½“æ¶‰åŠåˆ°å­—ä¸²ç±»é—®é¢˜æ—¶ï¼Œä¼˜å…ˆé€‰æ‹©æ»‘åŠ¨çª—å£æ¡†æ¶ã€‚\n\n> çœ‹ä¸æ‡‚æ¨¡æ¿å¯ä»¥å…ˆåšåš[Leetcode 438. æ‰¾åˆ°å­—ç¬¦ä¸²ä¸­æ‰€æœ‰å­—æ¯å¼‚ä½è¯](https://leetcode.cn/problems/find-all-anagrams-in-a-string/description/?envType=study-plan-v2&envId=top-100-liked)ï¼Œå†çœ‹è¿™ä¸ªæ¨¡æ¿æ¡†æ¶ã€‚\n\n```java\n/* æ»‘åŠ¨çª—å£ç®—æ³•æ¡†æ¶ */\npublic static void slidingWindow(String s, String p) {\n    char[] cs = s.toCharArray(), cp = p.toCharArray();\n    HashMap<Character, Integer> need = new HashMap<>();\n    HashMap<Character, Integer> window = new HashMap<>();\n    int L = p.length();\n    for (int i = 0; i < L; i ++) {\n        need.put(cp[i], need.getOrDefault(cp[i], 0) + 1);\n    }\n    // æœ‰çš„é¢˜ç›®åªæœ‰ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç”šè‡³éƒ½ä¸éœ€è¦ need å’Œ valid\n    int n = s.length(), m = need.size();\n    int left = 0, right = 0;\n    int valid = 0;\n    while (right < n) {\n        // c æ˜¯å°†ç§»å…¥çª—å£çš„å­—ç¬¦\n        char c = cs[right];\n        // å³æŒ‡é’ˆåç§»\n        right ++;\n        // è¿›è¡Œçª—å£å†…æ•°æ®çš„ä¸€ç³»åˆ—æ›´æ–°ï¼ˆä¸»è¦æ˜¯å°†å…ƒç´ æŠ“è¿›çª—å£ï¼‰\n        ...\n        /**\n        ç¤ºä¾‹ï¼š\n        if (need.containsKey(c)) {\n            window.put(c, window.getOrDefault(c, 0) + 1);\n            if (window.get(c).equals(need.get(c))) {\n                // å¦‚æœçª—å£ä¸­çš„å­—ç¬¦cå·²ç»å¤Ÿäº†ï¼Œåˆ™éœ€æ±‚æ•°é‡çš„å­—æ¯å¤šäº†ä¸€ä¸ª\n                valid ++;\n            }\n        }\n        */\n        \n        // åˆ¤æ–­å·¦ä¾§çª—å£æ˜¯å¦è¦æ”¶ç¼©\n        while (window needs shrink) {\n            // if (right - left == L) res.add(left); æ ¹æ®å…·ä½“é¢˜ç›®ä¿®æ”¹\n            // d æ˜¯å°†ç§»å‡ºçª—å£çš„å­—ç¬¦\n            char d = cs[left];\n            // å·¦æŒ‡é’ˆåç§»\n            left ++;\n            // è¿›è¡Œçª—å£å†…æ•°æ®çš„ä¸€ç³»åˆ—æ›´æ–°ï¼ˆä¸»è¦æ˜¯å°†å…ƒç´ é©±å‡ºçª—å£ï¼‰\n            ...\n            /**\n            ç¤ºä¾‹ï¼š\n            if (need.containsKey(d)) {\n                if (window.get(d).equals(need.get(d))) {\n                    valid --;\n                }\n                window.put(d, window.get(d) - 1);\n            }\n            */\n        }\n    }\n}\n```\n\n<a name=\"J0QJw\"></a>\n\n### 2.6 KMPç®—æ³•ï¼š[KMPå­—ç¬¦ä¸²](https://www.acwing.com/activity/content/problem/content/869/)\n\n<a name=\"OpmSj\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\n`kmp`ç®—æ³•æ˜¯æ¯”è¾ƒç»å…¸çš„å­—ç¬¦ä¸²åŒ¹é…ç®—æ³•ï¼Œ`kmp`æ˜¯å…¶ä¸‰ä¸ªå‘æ˜äººåå­—ç¼©å†™ã€‚`kmp`ç®—æ³•æ˜¯å°†æ¨¡å¼ä¸²`P`ä¸ä¸»ä¸²`S`è¿›è¡ŒåŒ¹é…ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯å°†å·²ç»åŒ¹é…è¿‡çš„å­—ç¬¦åˆ©ç”¨èµ·æ¥ï¼Œä¾‹å¦‚ä¸»ä¸²`S`ä¸º`abaabac`ï¼Œæ¨¡å¼ä¸²`P`ä¸º`abac`ï¼Œå½“åŒ¹é…åˆ°ç¬¬å››ä¸ªå­—ç¬¦å‘ç°ä¸åŒ¹é…æ—¶ï¼Œä¸»ä¸²ä¸­å‰ä¸‰ä¸ªå­—ç¬¦å·²ç»åŒ¹é…æˆåŠŸï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªä¿¡æ¯åˆ©ç”¨èµ·æ¥ï¼Œé‚£ä¹ˆä¸‹æ¬¡åŒ¹é…å¯ä»¥å°†`P`ä¸²çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ç›´æ¥ä¸`S`ä¸²çš„ç¬¬å››ä¸ªå­—ç¬¦å¼€å§‹åŒ¹é…ï¼Œè·³è¿‡äº†ä¸­é—´çš„ä¸€æ®µï¼Œä»è€Œé™ä½ç®—æ³•æ—¶é—´å¤æ‚åº¦ã€‚è€Œ`P`ä¸²æœ€å°‘å¯ä»¥å¾€å‰ç§»åŠ¨å¤šå°‘ä¸”å¯èƒ½åŒ¹é…æˆåŠŸåªå–å†³äº`P`ä¸²æœ¬èº«ä»¥`P[i]`ç»“æŸçš„å­—ä¸²çš„å‰ç¼€å’Œåç¼€ç›¸ç­‰çš„æœ€å¤§å€¼`(next[i])`ï¼Œè¿™ä¾¿æ˜¯`KMP`ç®—æ³•ä¸­æ¯”è¾ƒæŠ½è±¡çš„`next`æ•°ç»„çš„å«ä¹‰ã€‚\n\n> æŒæ¡`kmp`ç®—æ³•çš„åŒæ—¶å»ºè®®æŒæ¡**å­—ç¬¦ä¸²å“ˆå¸Œ**ï¼Œå¾ˆå¤šæŠ½è±¡çš„`kmp`é¢˜ç›®èƒ½å¤Ÿä½¿ç”¨å­—ç¬¦ä¸²å“ˆå¸Œé€šè¿‡ã€‚\n\n<a name=\"XOuo1\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\n// s[]ä¸ºä¸»ä¸²ï¼Œp[]ä¸ºæ¨¡å¼ä¸²ï¼Œnä¸ºæ¨¡å¼ä¸²çš„é•¿åº¦ï¼Œ mä¸ºä¸»ä¸²çš„é•¿åº¦\n// æ±‚nextæ•°ç»„\nfor (int i = 2, j = 0; i <= n; i ++) { // ne[1] = 0\n    // å½“ä¸èƒ½åŒ¹é…æ—¶ï¼Œjè·³è½¬åˆ°ne[j]å¤„\n    while (j != 0 && p[i] != p[j + 1]) j = ne[j]; \n    // è‹¥èƒ½å¤ŸåŒ¹é…ï¼Œåˆ™è®©jå‘åèµ°ä¸€ä½\n    if (p[i] == p[j + 1]) j ++; \n    ne[i] = j;\n}\n\n// åŒ¹é…è¿‡ç¨‹\nfor (int i = 1, j = 0; i <= m; i ++) {\n    while (j != 0 && s[i] != p[j + 1]) j = ne[j];\n    if (s[i] == p[j + 1]) j ++;\n    // å½“jèµ°åˆ°pä¸²æœ«å°¾æ—¶ï¼Œåˆ™è¯´æ˜ä¸€ä¸ªåŒ¹é…å®Œæˆï¼Œå³åœ¨sä¸²ä¸­æ‰¾åˆ°ä¸€ä¸ªå­ä¸²ä¸pä¸²å®Œå…¨ç›¸åŒ\n    if (j == n) { \n        // åŒ¹é…æˆåŠŸã€‚ä¹‹æ‰€ä»¥åŒ¹é…æˆåŠŸè¿˜éœ€è¦ j = ne[j]æ˜¯å› ä¸ºä¸€ä¸ªä¸»ä¸²é‡Œå¯èƒ½åŒ…å«å¤šä¸ªæ¨¡å¼ä¸²(ä¸ºä¸‹ä¸€æ®µåŒ¹é…åšå‡†å¤‡)\n        j = ne[j]; \n        // æ¯é“é¢˜çš„å…·ä½“é€»è¾‘ï¼Œè¿™é‡Œæ˜¯è¾“å‡ºåŒ¹é…æˆåŠŸçš„å¼€å§‹ä¸‹æ ‡\n        bw.write(i - n + \" \"); \n    }\n}\nbw.flush();\n\n// tipï¼šæœ€å°å¾ªç¯èŠ‚é•¿åº¦ï¼ši - ne[i]\n```\n\n<a name=\"hMsgG\"></a>\n\n### 2.7 Trieæ ‘/å­—å…¸æ ‘ï¼š[å­—ç¬¦ä¸²ç»Ÿè®¡](https://www.acwing.com/problem/content/837/)\n\n<a name=\"mIUZw\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\n`Tree`æ ‘æ˜¯ä¸€ç§ç”¨äºå­˜å‚¨å­—ç¬¦ä¸²çš„é«˜æ•ˆçš„æ•°æ®ç»“æ„ï¼Œä»¥ä¸€æ£µæ ‘çš„å½¢å¼å­˜å‚¨å­—ç¬¦ä¸²ä¸­çš„æ¯ä¸ªå­—ç¬¦ï¼Œå¦‚æœè¯¥å­—ç¬¦å·²ç»å­˜åœ¨ï¼Œåˆ™ä¸é‡æ–°åˆ›å»ºï¼Œå¦åˆ™åˆ›å»ºè¯¥å­—ç¬¦ï¼Œå¹¶åœ¨æ ‘ä¸­æ¯ä¸ªå­—ç¬¦ä¸²ç»“å°¾çš„åœ°æ–¹åšæ ‡è®°ï¼Œè¡¨ç¤ºæ ‘ä¸­å«æœ‰ä»¥è¯¥å­—ç¬¦ç»“å°¾çš„å­—ç¬¦ä¸²ã€‚<br />![Trieæ ‘.png](https://cdn.acwing.com/media/article/image/2024/03/02/126318_5949ec9ed8-Trieæ ‘.png)\n<a name=\"v9hti\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\nstatic int[][] son = new int[N][26]; // è¡¨ç¤ºæ¯ä¸ªå­—ç¬¦çš„æ‰€æœ‰å„¿å­ç»“ç‚¹\nstatic int idx; // è¡¨ç¤ºå½“å‰sonä¸­ç”¨åˆ°äº†å“ªä¸ªä¸‹æ ‡\nstatic int[] cnt = new int[N]; // è¡¨ç¤ºä»¥cnt[p]è¿™ä¸ªå­—ç¬¦ç»“å°¾çš„å­—ç¬¦ä¸²ä¸ªæ•°\n\n// æ’å…¥å­—ç¬¦ä¸²åˆ°Trieæ ‘ä¸­\npublic static void insert(char[] str) {\n    // ä»æ ¹èŠ‚ç‚¹å¼€å§‹æ‰¾\n    int p = 0;\n    // éå†è¦æ’å…¥å­—ç¬¦ä¸²çš„æ¯ä¸ªå­—ç¬¦\n    for (int i = 0; i < str.length; i ++) {\n        // å°†è¯¥å­—ç¬¦è½¬æ¢ä¸º0 ~ 25çš„æ•°å­—\n        int u = str[i] - 'a';\n        // å¦‚æœpç»“ç‚¹ä¸å­˜åœ¨uè¿™ä¸ªå„¿å­ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªï¼Œson[p][u] == 0è¡¨ç¤ºæŒ‡å‘ç©ºèŠ‚ç‚¹ï¼Œå¼€å§‹æ—¶ä¹Ÿæ˜¯æ ¹èŠ‚ç‚¹ï¼Œæ²¡æœ‰å­èŠ‚ç‚¹ä¹ŸæŒ‡å‘ç©ºèŠ‚ç‚¹\n        if(son[p][u] == 0) son[p][u] = ++ idx; \n        // ç„¶åæ›´æ–°pçš„ä½ç½®ï¼Œpå¾€åèµ°ä¸€ä¸ªï¼ˆå¯¹äºå­˜åœ¨çš„å¾€åèµ°ä¸€ä¸ªï¼Œå¯¹äºä¸å­˜åœ¨è¿™ä¸ªå­—æ¯çš„ï¼Œä¸Šä¸€æ­¥åˆ›å»ºäº†ï¼Œä¹Ÿå¾€åèµ°ä¸€ä¸ªä½ç½®ï¼‰\n        p = son[p][u];\n    }\n    // æ·»åŠ æˆåŠŸåå°†ä»¥pä½ç½®ç»“å°¾çš„è¿™ä¸ªå­—ç¬¦ä¸²æ•°é‡ +1\n    cnt[p] ++;\n}\n\n// æŸ¥è¯¢å­—ç¬¦ä¸²æ˜¯å¦åœ¨Trieæ ‘ä¸­\npublic static int query(char[] str) {\n    int p = 0;\n    for (int i = 0; i < str.length; i ++) {\n        int u = str[i] - 'a';\n        // å¦‚æœå‘ç°æŸä¸ªå­—ç¬¦åœ¨å½“å‰æŸ¥è¯¢çš„è·¯çº¿ä¸­ä¸å­˜åœ¨ï¼Œåˆ™è¯´æ˜è¯¥å­—ç¬¦ä¸²ä¸åœ¨æ ‘ä¸­ï¼Œç›´æ¥è¿”å›0ä¸ª\n        if (son[p][u] == 0) return 0;\n        // æ›´æ–°pçš„ä½ç½®\n        p = son[p][u];\n    }\n    // è¿”å›ä»¥pä½ç½®å¤„çš„å­—ç¬¦ç»“å°¾çš„å­—ç¬¦ä¸²ä¸ªæ•°\n    return cnt[p];\n}\n```\n\n<a name=\"CChR3\"></a>\n\n### 2.8 å¹¶æŸ¥é›†ï¼š[è¿é€šå—ä¸­ç‚¹çš„æ•°é‡](https://www.acwing.com/problem/content/839/)\n\n<a name=\"yxFnq\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\n- å¹¶æŸ¥é›†çš„ä½œç”¨æ˜¯åœ¨$\\mathcal{O}(1)$çš„æ—¶é—´å†…å°†ä¸¤ä¸ªé›†åˆåˆå¹¶ã€‚å…¶åŸç†ä¸ºï¼šè®©ä¸€ä¸ªé›†åˆçš„æ ¹èŠ‚ç‚¹ç›´æ¥æŒ‡å‘å¦ä¸€ä¸ªé›†åˆçš„æ ¹èŠ‚ç‚¹ï¼Œæˆä¸ºå¦ä¸€ä¸ªé›†åˆçš„ä¸€ä¸ªå­é›†ã€‚å¯ä»¥é€šè¿‡å¯»æ‰¾ä¸€ä¸ªèŠ‚ç‚¹çš„ç¥–å®—èŠ‚ç‚¹åˆ¤æ–­è¯¥å…ƒç´ å±äºå“ªä¸ªé›†åˆï¼Œå…¶æ—¶é—´å¤æ‚åº¦ä¸æ ‘çš„é«˜åº¦ç›¸å…³ï¼Œæ‰€ä»¥ï¼Œéœ€è¦å¯¹å…¶è¿›è¡Œä¼˜åŒ–ã€‚\n- **ä¼˜åŒ–æ€æƒ³** ï¼šå°†æ¯ä¸ªèŠ‚ç‚¹ç›´æ¥æŒ‡å‘å…¶ç¥–å®—èŠ‚ç‚¹ï¼Œè¯¥æ“ä½œæ˜¯åœ¨å¯»æ‰¾ç¥–å®—èŠ‚ç‚¹çš„å›æº¯è¿‡ç¨‹ä¸­å®Œæˆçš„ã€‚\n- æŸ¥æ‰¾ä¸¤ä¸ªç‚¹æ˜¯å¦åœ¨åŒä¸€ä¸ªé›†åˆå½“ä¸­æ—¶ï¼Œå¯ä»¥é€šè¿‡å…¶ç¥–å®—èŠ‚ç‚¹æ˜¯å¦æ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹è¿›è¡Œåˆ¤æ–­ã€‚\n- **è§„å®šï¼š** ç¥–å®—èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ç­‰äºè‡ªå·±ï¼ˆé€’å½’çš„é€€å‡ºæ¡ä»¶ï¼‰\n  <a name=\"ut2oA\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\n// findå‡½æ•°ï¼Œå¹¶æŸ¥é›†çš„æ ¸å¿ƒ\npublic static int find(int x) {\n    if(p[x] != x) p[x] = find(p[x]);\n    return p[x];\n}\n\n// åˆå§‹åŒ–çˆ¶äº²æ•°ç»„ï¼Œå³æ¯ä¸ªèŠ‚ç‚¹å¼€å§‹éƒ½æ˜¯ä¸€ä¸ªé›†åˆ\nfor (int i = 1; i <= n; i ++) p[i] = i; \n\n// å°†a, bä¸¤ä¸ªç‚¹åˆå¹¶è¿›ä¸€ä¸ªé›†åˆï¼Œæ­¤å¤„å¾ˆå®¹æ˜“å‡ºé”™(å°†bçš„ç¥–å®—èŠ‚ç‚¹å˜ä¸ºaçš„ç¥–å®—èŠ‚ç‚¹çš„çˆ¶äº²)\np[find(a)] = find(b); \n\n// åˆ¤æ–­ä¸¤ä¸ªç‚¹æ˜¯å¦åœ¨åŒä¸€ä¸ªé›†åˆ\nif (find(a) == find(b))\n```\n\n<a name=\"uYOuo\"></a>\n\n### 2.9 æ ‘çŠ¶æ•°ç»„ï¼š[åŠ¨æ€æ±‚è¿ç»­åŒºé—´å’Œ](https://www.acwing.com/activity/content/problem/content/1719/)\n\n<a name=\"Hhncl\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\næ ‘çŠ¶æ•°ç»„æ˜¯ä¸€ç§èƒ½åœ¨$\\mathcal{O}(\\log n)$æ—¶é—´å¤æ‚åº¦å†…ä¿®æ”¹æŸä¸ªæ•°ï¼Œå¹¶åŠ¨æ€æ±‚å‡ºå‰ç¼€å’Œçš„æ•°æ®ç»“æ„ã€‚<br />èƒ½å¤Ÿåœ¨$\\mathcal{O}(\\log n)$å†…æ±‚å‡ºå‰ç¼€å’Œçš„åŸå› ï¼šåŠ¨æ€ç»´æŠ¤äº†ä¸€ä¸ªæ•°ç»„ï¼ˆæ ‘çŠ¶æ•°ç»„ï¼‰ã€‚<br />ä¸ºä»€ä¹ˆæ ‘çŠ¶æ•°ç»„ä¿®æ”¹æŸä¸ªæ•°éœ€è¦$\\mathcal{O}(\\log n)$ï¼šæˆ‘ä»¬æ˜¯åœ¨ç»´æŠ¤çš„æ ‘çŠ¶æ•°ç»„ä¸Šè¿›è¡Œä¿®æ”¹çš„ï¼Œå› æ­¤éœ€è¦ä¿®æ”¹è¯¥æ•°å¹¶ç»´æŠ¤è¯¥æ ‘çŠ¶æ•°ç»„ã€‚\n\n> æ³¨æ„ï¼Œæ ‘çŠ¶æ•°ç»„çš„ä¸‹æ ‡å¿…é¡»ä»`1`å¼€å§‹ï¼Œå¦åˆ™ä¼šæ­»å¾ªç¯ï¼Œå› ä¸º$lowbit(0) \\equiv 0$ã€‚\n\n- [Leetcodeä¸€é¢˜ç§’æ‡‚æ ‘çŠ¶æ•°ç»„](https://leetcode.cn/problems/peaks-in-array/description/)\n\n**æ ‘çŠ¶æ•°ç»„çš„ä¸‰ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼š**\n\n- `lowbit`ï¼šç”¨äºå®šä½å…¶å…³è”çš„æ•°ç»„å…ƒç´ ä¸‹æ ‡ï¼›\n- `add`ï¼šå¯¹å…ƒç´ å¢åŠ ä¸€ä¸ªå€¼ï¼ˆä¿®æ”¹æ“ä½œéœ€è¦è½¬ä¸ºå¢åŠ æ“ä½œæ¥å®Œæˆï¼‰ï¼›\n- `query`ï¼šæŸ¥è¯¢ä»¥æŸä¸ªä¸‹æ ‡ç»“å°¾çš„å‰ç¼€å’Œã€‚\n\n![2.9 æ ‘çŠ¶æ•°ç»„.png](https://cdn.acwing.com/media/article/image/2024/03/02/126318_885f94f6d8-2.9-æ ‘çŠ¶æ•°ç»„.png)\n<a name=\"cmLwp\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\nimport java.util.*;\n\npublic class Main {\n    static final int N = 100010;\n    static int[] a = new int[N], tr = new int[N];\n    static int n, m;\n    public static int lowbit(int x) {\n        return x & -x;\n    }\n    public static void add(int x, int v) {\n        for (int i = x; i <= n; i += lowbit(i)) tr[i] += v;\n    }\n    public static int query(int x) {\n        int res = 0;\n        for (int i = x; i > 0; i -= lowbit(i)) res += tr[i];\n        return res;\n    }\n    public static void main(String[] args) {\n        Scanner sc = new Scanner(System.in);\n        n = sc.nextInt();\n        m = sc.nextInt();\n        for (int i = 1; i <= n; i ++) a[i] = sc.nextInt();\n        for (int i = 1; i <= n; i ++) add(i, a[i]);\n        while (m -- > 0) {\n            int k = sc.nextInt(), x = sc.nextInt(), y = sc.nextInt();\n            if (k == 0) System.out.println(query(y) - query(x - 1));\n            else add(x, y);\n        }\n    }\n}\n```\n\n<a name=\"wo62f\"></a>\n\n### 2.10 çº¿æ®µæ ‘ï¼š[æ•°åˆ—åŒºé—´æœ€å¤§å€¼](https://www.acwing.com/problem/content/1272/)ï¼Œ[åŠ¨æ€æ±‚è¿ç»­åŒºé—´å’Œ](https://www.acwing.com/activity/content/problem/content/1719/)\n\n<a name=\"yeT0z\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\nçº¿æ®µæ ‘æ˜¯ä¸€ç§èƒ½åœ¨$\\mathcal{O}(\\log n)$å†…æ±‚å‡ºä¸€æ®µåŒºé—´å†…çš„æŸä¸ªå±æ€§ï¼ˆ`æœ€å¤§å€¼`ã€`æœ€å°å€¼`ã€`sum`ç­‰ï¼‰çš„æ•°æ®ç»“æ„ã€‚\n\n> ä¸€èˆ¬æ¥è¯´ï¼Œæ ‘çŠ¶æ•°ç»„èƒ½å¹²çš„ï¼Œçº¿æ®µæ ‘éƒ½èƒ½å¹²ï¼Œå› ä¸ºçº¿æ®µæ ‘æ›´åŠ çµæ´»ã€‚ä½†æ˜¯ï¼Œç”±äºçº¿æ®µæ ‘çš„å¸¸æ•°å¤ªå¤§ï¼Œæ‰€ä»¥ä¼šæ¯”æ ‘çŠ¶æ•°ç»„æ…¢æ¯”è¾ƒå¤šã€‚\n\n- [Leetcodeä¸€é¢˜ç§’æ‡‚çº¿æ®µæ ‘](https://leetcode.cn/problems/distribute-elements-into-two-arrays-ii/)\n\n**çº¿æ®µæ ‘çš„å››ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼š**\n\n- `pushup`ï¼šç”¨å­èŠ‚ç‚¹çš„ä¿¡æ¯æ›´æ–°å½“å‰èŠ‚ç‚¹ä¿¡æ¯ï¼ˆæœ‰æ—¶ä¸ç”¨æ˜¾å¼åœ°å†™å‡ºï¼‰ï¼›\n- `build`ï¼šåœ¨ä¸€æ®µåŒºé—´ä¸Šåˆå§‹åŒ–çº¿æ®µæ ‘ï¼›\n- `modify`ï¼šä¿®æ”¹æŸä¸ªæ•°çš„å±æ€§ï¼ŒåŒæ—¶ç»´æŠ¤çº¿æ®µæ ‘ï¼›\n- `query`ï¼šæŸ¥è¯¢å±æ€§ã€‚\n\n![2.10çº¿æ®µæ ‘.png](https://cdn.acwing.com/media/article/image/2024/03/02/126318_e60477acd8-2.10çº¿æ®µæ ‘.png)\n<a name=\"TXA2l\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n- [æ•°åˆ—åŒºé—´æœ€å¤§å€¼](https://www.acwing.com/problem/content/1272/)ï¼š\n\n```java\nimport java.io.*;\n\npublic class Main {\n    static class Segment {\n        int l, r, max;\n        public Segment(int l, int r, int max) {\n            this.l = l;\n            this.r = r;\n            this.max = max;\n        }\n    }\n    static final int N = 100010;\n    static int[] w = new int[N];\n    static Segment[] tr = new Segment[4 * N];\n    \n    public static void build(int u, int l, int r) {\n        if (l == r) tr[u] = new Segment(l, r, w[r]);\n        else {\n            tr[u] = new Segment(l, r, 0);\n            int mid = l + r >> 1;\n            build(u << 1, l, mid);\n            build(u << 1 | 1, mid + 1, r);\n            // å…¶å®å°±æ˜¯ pushupï¼Œåªæ˜¯æ²¡æœ‰å•ç‹¬å†™ä¸€ä¸ªpushupå‡½æ•°\n            tr[u].max = Math.max(tr[u << 1].max, tr[u << 1 | 1].max);\n        }\n    }\n    \n    public static int query(int u, int l, int r) {\n        if (tr[u].l >= l && tr[u].r <= r) return tr[u].max;\n        int mid = tr[u].l + tr[u].r >> 1;\n        int max = Integer.MIN_VALUE;\n        if (l <= mid) max = query(u << 1, l, r);\n        if (r > mid) max = Math.max(max, query(u << 1 | 1, l, r));\n        return max;\n    }\n    \n    public static void main (String[] args) throws IOException {\n        BufferedReader br = new BufferedReader(new InputStreamReader(System.in));\n        BufferedWriter bw = new BufferedWriter(new OutputStreamWriter(System.out));\n        String[] s1 = br.readLine().split(\" \");\n        int n = Integer.parseInt(s1[0]), m = Integer.parseInt(s1[1]);\n        String[] s2 = br.readLine().split(\" \");\n        for (int i = 1; i <= n; i ++) w[i] = Integer.parseInt(s2[i - 1]);\n        build(1, 1, n);\n        while (m -- > 0) {\n            String[] s = br.readLine().split(\" \");\n            int x = Integer.parseInt(s[0]), y = Integer.parseInt(s[1]);\n            bw.write(query(1, x, y) + \"\\n\");\n        }\n        bw.flush();\n    }\n}\n```\n\n- [åŠ¨æ€æ±‚è¿ç»­åŒºé—´å’Œ](https://www.acwing.com/activity/content/problem/content/1719/)ï¼š\n\n```java\nimport java.util.*;\n\npublic class Main {\n    static class Segment {\n        int l, r, sum;\n        public Segment(int l, int r, int sum) {\n            this.l = l;\n            this.r = r;\n            this.sum = sum;\n        }\n    }\n    static final int N = 100010;\n    static Segment[] tr = new Segment[4 * N];\n    static int[] w = new int[N];\n\n    // æ˜¾ç¤ºåœ°å°†pushupå†™å‡º\n    public static void pushup(int u) {\n        tr[u].sum = tr[u << 1].sum + tr[u << 1 | 1].sum;\n    }\n    \n    public static void build(int u, int l, int r) {\n        if (l == r) tr[u] = new Segment(l, r, w[r]);\n        else {\n            tr[u] = new Segment(l, r, 0);\n            int mid = l + r >> 1;\n            build(u << 1, l, mid);\n            build(u << 1 | 1, mid + 1, r);\n            pushup(u);\n        }\n    }\n    \n    public static int query(int u, int l, int r) {\n        if (tr[u].l >= l && tr[u].r <= r) return tr[u].sum;\n        int mid = tr[u].l + tr[u].r >> 1;\n        int res = 0;\n        if (l <= mid) res = query(u << 1, l, r);\n        if (r >= mid + 1) res += query(u << 1 | 1, l, r);\n        return res;\n    }\n    \n    public static void modify(int u, int x, int v) {\n        if (tr[u].l == tr[u].r) tr[u].sum += v;\n        else {\n            int mid = tr[u].l + tr[u].r >> 1;\n            if (x <= mid) modify(u << 1, x, v);\n            else modify(u << 1 | 1, x, v);\n            pushup(u);\n        }\n    }\n    \n    public static void main(String[] args) {\n        Scanner sc = new Scanner(System.in);\n        int n = sc.nextInt(), m = sc.nextInt();\n        for (int i = 1; i <= n; i ++) w[i] = sc.nextInt();\n        build(1, 1, n);\n        while (m -- > 0) {\n            int k = sc.nextInt(), x = sc.nextInt(), y = sc.nextInt();\n            if (k == 0) System.out.println(query(1, x, y));\n            else modify(1, x, y);\n        }\n    }\n}\n```\n\n<a name=\"tETKk\"></a>\n\n### 2.11 å­—ç¬¦ä¸²å“ˆå¸Œï¼š[å­—ç¬¦ä¸²å“ˆå¸Œ](https://www.acwing.com/problem/content/843/)\n\n<a name=\"kOQld\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\nè¿™é‡Œçš„å­—ç¬¦ä¸²å“ˆå¸Œæ˜¯ä¸€ç§ç‰¹æ®Šçš„å“ˆå¸Œæ–¹å¼ï¼Œå³å­—ç¬¦ä¸²å‰ç¼€å“ˆå¸Œï¼Œå…¶æ€æƒ³æ˜¯å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºä¸€ä¸ª`P`è¿›åˆ¶çš„æ•°ï¼Œ`P`çš„ç»éªŒå–å€¼ä¸º`131`æˆ–`13331`ã€‚<br />ä¾‹å¦‚ï¼Œå°†`SmallBoat`è½¬æ¢ä¸º`P`è¿›åˆ¶çš„æ•°ï¼ˆè¯¥å­—ç¬¦ä¸²çš„å“ˆå¸Œå€¼ï¼‰ä¸ºï¼š$H[n] = H[9] = H[n - 1] \\times P + str[n] = H[8] \\times P + str[9]$\n\n> è®¡ç®—æ—¶ä¼šè‡ªåŠ¨å°†å­—æ¯è½¬æ¢ä¸ºå¯¹åº”çš„`ASCII`ç¼–ç å€¼\n\né‚£ä¹ˆï¼Œç»™å®šä»»æ„çš„$l, r \\in [0, n - 1]$ï¼Œ$l \\sim r$è¿™æ®µå­—ç¬¦çš„å“ˆå¸Œå€¼ä¸ºï¼š$H[l \\sim r] = H[r] - H[l - 1] \\times P^{r - l + 1}$\n<a name=\"MsqUB\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\nimport java.io.*;\n\npublic class Main {\n    static final int N = 100010, P = 131;\n    static long[] h = new long[N], p = new long[N];\n    static int n, m;\n    public static void main(String[] args) throws IOException {\n        BufferedReader br = new BufferedReader(new InputStreamReader(System.in));\n        BufferedWriter bw = new BufferedWriter(new OutputStreamWriter(System.out));\n        \n        String[] s1 = br.readLine().split(\" \");\n        n = Integer.parseInt(s1[0]); m = Integer.parseInt(s1[1]);\n        char[] str = (\" \" + br.readLine()).toCharArray();\n        \n        p[0] = 1;\n        for (int i = 1; i <= n; i ++) {\n            p[i] = p[i - 1] * P;\n            h[i] = h[i - 1] * P + str[i];\n        }\n        \n        while (m -- > 0) {\n            String[] s2 = br.readLine().split(\" \");\n            int l1 = Integer.parseInt(s2[0]), r1 = Integer.parseInt(s2[1]);\n            int l2 = Integer.parseInt(s2[2]), r2 = Integer.parseInt(s2[3]);\n            if (getHash(l1, r1) == getHash(l2, r2)) bw.write(\"Yes\\n\");\n            else bw.write(\"No\\n\");\n        }\n        bw.flush();\n    }\n    public static long getHash(int l, int r) {\n        // æ³¨æ„å…¬å¼æ­£ç¡®æ€§ï¼Œå¹¶é (h[r] - h[l]) * p[r - l + 1]\n        return h[r] - h[l - 1] * p[r - l + 1];\n    }\n}\n```\n\n<a name=\"eNGWs\"></a>\n\n## ç¬¬ä¸‰ç« ï¼šæœç´¢ä¸å›¾è®º\n\n<a name=\"ZEgA6\"></a>\n\n### 3.1 æ ‘ä¸å›¾çš„å­˜å‚¨ï¼š\n\n- æ ‘æ˜¯ä¸€ç§ç‰¹æ®Šçš„å›¾ï¼Œæ‰€ä»¥åªéœ€è¦ä¼šå›¾çš„å­˜å‚¨æ–¹å¼å³å¯ã€‚åœ¨å›¾ä¸­ï¼Œæ— å‘å›¾åˆæ˜¯ç‰¹æ®Šçš„æœ‰å‘å›¾ï¼Œä¾‹å¦‚ï¼Œå¯¹äºä¸€æ— å‘è¾¹`a -- b`ï¼Œåªéœ€è¦å­˜å‚¨ä¸¤æ¡æœ‰å‘è¾¹å³å¯ï¼Œå³`a -> bã€b -> a`ï¼Œæ•…åªéœ€è¦ä¼šæœ‰å‘å›¾çš„å­˜å‚¨å³å¯ã€‚\n- å›¾çš„å­˜å‚¨å¸¸ç”¨çš„æœ‰ä¸¤ç§ï¼Œåˆ†åˆ«ä¸º**é‚»æ¥çŸ©é˜µ**å’Œ**é‚»æ¥è¡¨**å­˜å‚¨æ³•ã€‚ä¸€èˆ¬ç”¨é‚»æ¥çŸ©é˜µå­˜å‚¨ç¨ å¯†å›¾ï¼Œå³ä½¿ç”¨äºŒç»´æ•°ç»„`g[][]`å­˜å‚¨ï¼Œ`g[a][b]`è¡¨ç¤ºä¸€æ¡ç”±`a`æŒ‡å‘`b`æƒå€¼ä¸º`g[a][b]`çš„è¾¹ã€‚ä½¿ç”¨é‚»æ¥è¡¨å­˜å‚¨ç¨€ç–å›¾ï¼Œ`h[]`å­˜å‚¨æ¯ä¸€æ¡å•é“¾è¡¨çš„å¤´ç»“ç‚¹ï¼Œ`e[]`å­˜å‚¨æ¯ä¸ªé¡¶ç‚¹çš„å€¼ï¼Œ`ne[]`å­˜å‚¨æ¯ä¸ªé¡¶ç‚¹çš„é‚»ç‚¹çš„ä¸‹æ ‡ï¼Œæœ‰æ—¶è¿˜ä¼šç”¨`w[]`å­˜å‚¨è¾¹çš„æƒé‡ã€‚\n  <a name=\"Sdawu\"></a>\n\n### 3.2 æ ‘ä¸å›¾çš„éå†ï¼š\n\n<a name=\"w0r6P\"></a>\n\n#### 3.2.1 DFSï¼š\n\n<a name=\"G5wPU\"></a>\n\n##### æ³¨æ„ï¼š\n\n- åœ¨`dfs`è¿‡ç¨‹ä¸­ï¼Œå¿…è¦æ—¶éœ€è¦**æ¢å¤ç°åœº**ï¼ŒåŒæ—¶å¯¹äºæœ‰çš„é—®é¢˜éœ€è¦è¿›è¡Œ**å‰ªæ**ï¼Œå¦‚`n`çš‡åé—®é¢˜ã€‚\n  <a name=\"bB05L\"></a>\n\n##### ä»£ç å®ç°ï¼š\n\n```java\npublic static void dfs(int u) {\n    if (check()) return; // dfsé€€å‡ºæ¡ä»¶\n\tst[u] = true;\n    for (int i = h[u]; i != -1; i = ne[i]) {\n        int j = e[i];\n        if (!st[j]) dfs(j);\n    }\n}\n```\n\n<a name=\"fXcks\"></a>\n\n##### DFSæŠ€å·§ï¼š\n\n- ä¼˜åŒ–æœç´¢é¡ºåºï¼šåº”å½“ä¼˜å…ˆæœç´¢åˆ†æ”¯è¾ƒå°‘çš„èŠ‚ç‚¹ï¼Œæˆ–è€…ä»¥ä½¿å¾—æ•´ä½“æœç´¢æ¬¡æ•°æ›´å°‘çš„é¡ºåºæœç´¢ï¼›\n- æ’é™¤ç­‰æ•ˆå†—ä½™ï¼šä¾‹å¦‚å…ˆé€‰ä¸€å†é€‰äºŒå’Œå…ˆé€‰äºŒå†é€‰ä¸€æ˜¯åŒä¸€ç§ï¼Œåœ¨æœç´¢çš„æ—¶å€™è¦é¿å…é‡å¤æœç´¢ï¼›\n- å¯è¡Œæ€§å‰ªæï¼šæœç´¢è¿‡ç¨‹ä¸­å‘ç°è¯¥åˆ†æ”¯å†å¾€ä¸‹å·²ç»ä¸æ˜¯æƒ³è¦çš„ç»“æœï¼Œç›´æ¥`return`ï¼›\n- æœ€ä¼˜åŒ–å‰ªæï¼šä¾‹å¦‚æŸ¥æ‰¾æŸæœ€å°å€¼æ—¶ï¼Œå½“å‰åˆ†æ”¯å·²ç»å¤§äºå½“å‰çš„æœ€ä¼˜è§£æ—¶ï¼Œç›´æ¥`return`ï¼›\n- è®°å¿†åŒ–æœç´¢ï¼ˆ`DP`ï¼‰ï¼šåŠ ç¼“å­˜ï¼Œæ¯æ¬¡è¦æœå¯»æŸä¸ªæ–¹æ¡ˆæ—¶ï¼Œå…ˆçœ‹ç¼“å­˜ä¸­æ˜¯å¦å·²å­˜åœ¨ï¼Œå­˜åœ¨ç›´æ¥è¿”å›ï¼Œä¸å­˜åœ¨å†æœç´¢ã€‚\n  <a name=\"sU7te\"></a>\n\n#### 3.2.2 BFSï¼š\n\n<a name=\"iiD9j\"></a>\n\n##### æ³¨æ„ï¼š\n\n- åœ¨`BFS`è¿‡ç¨‹ä¸­æ²¡æœ‰é€’å½’ï¼Œåˆå­¦æ—¶è¦åˆ†æ¸…`BFS`å’Œ`DFS`çš„åŒºåˆ«ï¼Œ`BFS`æ˜¯ç»´æŠ¤ä¸€ä¸ªé˜Ÿåˆ—ã€‚\n  <a name=\"atRG2\"></a>\n\n##### ä»£ç å®ç°ï¼ˆåŸºäºåŒç«¯é˜Ÿåˆ—ï¼‰ï¼š\n\n```java\nstatic int[] dx = {-1, 0, 1, 0}, dy = {0, 1, 0, -1};\npublic static void bfs() {\n    Deque<int[]> q = new ArrayDeque<>();\n    q.addLast(new int[]{0, 0});\n    st[0][0] = true;\n    \n    while (!q.isEmpty()) {\n        int[] t = q.pollFirst();\n        int x = t[0], y = t[1];\n        for (int i = 0; i < 4; i ++) {\n            int a = x + dx[i], b = y + dy[i];\n            if (a < 0 || a >= n || b < 0 || b >= m || st[a][b])\n                continue;\n            // å…·ä½“é¢˜ç›®å¯èƒ½çš„é€»è¾‘\n            ...\n            st[a][b] = true;\n            q.addLast(new int[] {a, b});\n        }\n    }\n}\n```\n\n<a name=\"NGkui\"></a>\n\n### 3.3 æ‹“æ‰‘æ’åºï¼š[æœ‰å‘å›¾çš„æ‹“æ‰‘æ’åº](https://www.acwing.com/problem/content/850/)\n\n<a name=\"wtS5v\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\næ‹“æ‰‘æ’åºï¼ˆ`Topological Sorting`ï¼‰æ˜¯ä¸€ä¸ªæœ‰å‘æ— ç¯å›¾ï¼ˆ`DAG, Directed Acyclic Graph`ï¼‰çš„æ‰€æœ‰é¡¶ç‚¹çš„çº¿æ€§åºåˆ—ã€‚ä¸”è¯¥åºåˆ—å¿…é¡»æ»¡è¶³ä¸‹é¢ä¸¤ä¸ªæ¡ä»¶ï¼š\n\n- æ¯ä¸ªé¡¶ç‚¹å‡ºç°ä¸”åªå‡ºç°ä¸€æ¬¡ï¼›\n- è‹¥å­˜åœ¨ä¸€æ¡ä»é¡¶ç‚¹`A` åˆ°é¡¶ç‚¹ `B` çš„è·¯å¾„ï¼Œé‚£ä¹ˆåœ¨åºåˆ—ä¸­é¡¶ç‚¹`A` å¿…é¡»å‡ºç°åœ¨é¡¶ç‚¹ `B`çš„å‰é¢ã€‚\n\næ‹“æ‰‘æ’åºåˆ©ç”¨é˜Ÿåˆ—ï¼Œå…ˆå°†æ‰€æœ‰å…¥åº¦ä¸º`0`çš„ç‚¹æ”¾è¿›é˜Ÿåˆ—ä¸­ï¼ˆç”¨`d`æ•°ç»„è®°å½•æ¯ä¸ªç‚¹çš„å…¥åº¦ï¼‰ï¼Œç„¶åä»é˜Ÿå¤´å…ƒç´ å¼€å§‹éå†ï¼Œå¹¶è®©é˜Ÿå¤´å…ƒç´ å‡ºé˜Ÿï¼Œå¯¹æ¯ä¸ªç‚¹çš„æ‰€æœ‰é‚»è¾¹éå†ä¸€éï¼Œæ¯æ¬¡éå†è®©å…¶å…¥åº¦å‡ä¸€ï¼Œå½“æŸä¸ªç‚¹å…¥åº¦ä¸º`0`æ—¶ï¼Œå°†å…¶æ”¾è¿›é˜Ÿåˆ—ä¸­ã€‚å½“é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œæ’åºç»“æŸã€‚\n<a name=\"Mo14J\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n> æ•°ç»„æ¨¡æ‹Ÿé˜Ÿåˆ—å¯ä»¥ä¸ç”¨å•ç‹¬å­˜å‚¨ç­”æ¡ˆï¼Œå‡ºé˜Ÿæ“ä½œæ—¶é€»è¾‘å‡ºé˜Ÿï¼Œå› æ­¤å¯ä»¥ç›´æ¥è¾“å‡ºã€‚\n\n```java\npublic static boolean topSort() {\n    int hh = 0, tt = -1; // æ•°ç»„æ¨¡æ‹Ÿé˜Ÿåˆ—\n    for (int i = 1; i <= n; i ++) // å…ˆå°†æ‰€æœ‰å…¥åº¦ä¸º0çš„ç‚¹æ”¾è¿›é˜Ÿåˆ—ä¸­\n        if (d[i] == 0) q[++ tt] = i;\n    // å½“é˜Ÿåˆ—ä¸ç©ºæ—¶ï¼Œéå†é˜Ÿåˆ—ä¸­ç‚¹çš„æ‰€æœ‰é‚»ç‚¹\n    while (hh <= tt) {\n        int t = q[hh ++]; // å–å‡ºé˜Ÿå¤´å…ƒç´ \n        for (int i = h[t]; i != -1; i = ne[i]) { // éå†å…¶æ‰€æœ‰é‚»ç‚¹\n            int j = e[i];\n            d[j] --; // æ¯æ¬¡éå†åå°†å…¶å…¥åº¦å‡ä¸€\n            if (d[j] == 0) q[++ tt] = j; // å½“å…¶å…¥åº¦ä¸ºé›¶æ—¶ï¼Œå°†å…¶æ”¾è¿›é˜Ÿåˆ—\n        }\n    }\n    return tt == n - 1; // è¿”å›æ˜¯å¦æˆåŠŸè¿›è¡Œæ‹“æ‰‘æ’åºï¼Œå½“tt == n - 1æ—¶ï¼Œè¡¨ç¤ºå·²ç»éå†å®Œæ‰€æœ‰ç‚¹\n}\n```\n\n<a name=\"MzTMR\"></a>\n\n#### ä»£ç å®ç°ï¼ˆåŸºäºåŒç«¯é˜Ÿåˆ—ï¼‰ï¼š\n\n> åŸºäºåŒç«¯é˜Ÿåˆ—çš„å®ç°åˆ™éœ€è¦å•ç‹¬å­˜ä¸€ä¸‹åºåˆ—ï¼Œä»¥ä¾¿è¾“å‡ºã€‚ä¸‹é¢ä»£ç ä¸­ä¸ç”¨`st`ä¹Ÿå¯ä»¥ï¼Œå› ä¸º`d[j]`æ¯æ¬¡éƒ½ä¼šè¢« `-1`ï¼Œæ‰€ä»¥ä¸å¯èƒ½æœ‰å…ƒç´ èƒ½é‡å¤å…¥é˜Ÿï¼Œåªæ˜¯ä¹ æƒ¯è¿™æ ·ã€‚\n\n```java\nstatic List<Integer> res = new ArrayList<>();\n// å»ºå›¾çœç•¥\npublic static boolean top_sort() {\n    Deque<Integer> q = new ArrayDeque<>();\n    for (int i = 1; i <= n; i ++) {\n        if (d[i] == 0) {\n            q.addLast(i);\n            st[i] = true;\n        }\n    }\n    while (!q.isEmpty()) {\n        int t = q.pollFirst();\n        res.add(t);\n        for (int i = h[t]; i != -1; i = ne[i]) {\n            int j = e[i];\n            if (st[j]) continue;\n            d[j] --;\n            if (d[j] == 0) {\n                st[j] = true;\n                q.addLast(j);\n            }\n        }\n    }\n    return res.size() == n;\n}\n```\n\n<a name=\"a3j71\"></a>\n\n### 3.4 æœ´ç´ Dijkstraç®—æ³•$\\mathcal{O}(n^2 + m)$ï¼š[Dijkstraæ±‚æœ€çŸ­è·¯â… ](https://www.acwing.com/activity/content/problem/content/918/)\n\n<a name=\"tmQFB\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\n- è¿ªæ°æ–¯ç‰¹æ‹‰ç®—æ³•åªèƒ½ç”¨äºæ±‚è§£**éè´Ÿæƒ**å›¾çš„**å•æºè·¯å¾„é—®é¢˜**ã€‚\n- è¿ªæ°æ–¯ç‰¹æ‹‰ç®—æ³•åŸºäºè´ªå¿ƒï¼Œå°†ç¬¬ä¸€ä¸ªç‚¹åˆ°ç¬¬ä¸€ä¸ªç‚¹çš„è·ç¦»èµ‹å€¼ä¸º`0`ï¼Œå…¶ä»–èµ‹å€¼ä¸ºæ— ç©·å¤§`INF`ï¼Œç„¶åè¿›è¡Œ`n - 1`æ¬¡è¿­ä»£ï¼Œæ¯æ¬¡ä»è¿˜æœªç¡®å®šä¸èµ·ç‚¹æœ€çŸ­è·ç¦»çš„ç‚¹ä¸­é€‰å‡ºä¸èµ·ç‚¹è·ç¦»æœ€å°çš„ç‚¹ï¼Œç„¶åç”¨è¿™ä¸ªç‚¹æ›´æ–°å…¶ä»–ç‚¹åˆ°èµ·ç‚¹çš„è·ç¦»ï¼Œå¹¶å°†è¿™ä¸ªç‚¹çš„çŠ¶æ€æ”¹ä¸ºå·²ç¡®å®šæœ€çŸ­è·ç¦»ï¼ˆå³`st[t] = true`ï¼‰ã€‚\n- ä½¿ç”¨**é‚»æ¥çŸ©é˜µ**å­˜å‚¨ã€‚\n\n> ä¸€èˆ¬éƒ½ä¸ç”¨æœ´ç´ ç‰ˆDijkstraï¼Œ~~æœ‰å †ä¼˜åŒ–ç‰ˆï¼Œè°è¿˜ç”¨æœ´ç´ ç‰ˆå•Š~~~\n\n> æœ‰å…³å›¾è®ºçš„å‡ ä¸ªç®—æ³•å¿…é¡»ç†Ÿè®°æ—¶é—´å¤æ‚åº¦ï¼Œä¾¿äºé€‰æ‹©ã€‚\n\n<a name=\"ci5op\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\npublic static int dijkstra() {\n    // INF = 0x3f3f3f3fè¡¨ç¤ºæ— ç©·å¤§\n    Arrays.fill(dist, INF);\n    // åˆå§‹åŒ–èµ·ç‚¹åˆ°èµ·ç‚¹çš„è·ç¦»ä¸º0\n    dist[1] = 0; \n    // è¿›è¡Œn - 1æ¬¡è¿­ä»£ï¼Œæ¯æ¬¡ç¡®å®šä¸€ä¸ªæœ€å°è·ç¦»ç‚¹\n    for (int i = 0; i < n - 1; i ++) {\n        // tåªä½œä¸ºä¸€ä¸ªä¸´æ—¶å˜é‡ï¼Œç”¨äºç­›é€‰å½“å‰è¿˜æœªç¡®å®šçš„è·ç¦»æœ€å°çš„ç‚¹\n        int t = -1;\n        for (int j = 1; j <= n; j ++) {\n            // å¯»æ‰¾å½“å‰è¿˜æœªç¡®å®šæœ€å°è·ç¦»çš„ç‚¹ä¸­çš„æœ€å°å€¼ï¼ˆt == -1 è¡¨ç¤ºæœ€å¼€å§‹çš„çŠ¶æ€ï¼Œåˆšå¼€å§‹å¾ªç¯ã€‚ï¼‰\n            if (!st[j] && (t == -1 || dist[j] < dist[t]))\n                t = j;\n        }\n        // å¦‚æœå½“å‰ç¡®å®šè¿™ä¸ªç‚¹æ˜¯nå·ç‚¹(æ±‚çš„å°±æ˜¯1~nçš„è·ç¦»)ï¼Œåˆ™ç›´æ¥é€€å‡ºå¾ªç¯ï¼ˆå‰ªæï¼‰\n        if (t == n) break;\n        // å°†tï¼ˆæ­¤æ¬¡ç¡®å®šçš„æœ€å°è·ç¦»ç‚¹ï¼‰æ”¾å…¥é›†åˆä¸­\n        st[t] = true;\n        // ç”¨æ­¤æ¬¡ç¡®å®šçš„æœ€å°è·ç¦»ç‚¹æ›´æ–°å…¶ä»–ç‚¹åˆ°èµ·ç‚¹çš„è·ç¦»\n        for (int j = 1; j <= n; j ++)\n            dist[j] = Math.min(dist[j], dist[t] + g[t][j]);\n    }\n    if (dist[n] == INF) return -1;\n    return dist[n];\n}\n```\n\n<a name=\"rqwwa\"></a>\n\n### 3.5 å †ä¼˜åŒ–ç‰ˆDijkstraç®—æ³•$\\mathcal{O}(m \\log n)$ï¼š[Dijkstraæ±‚æœ€çŸ­è·¯â…¡](https://www.acwing.com/activity/content/problem/content/919/)\n\n<a name=\"j7RsN\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\n- ç®—æ³•æ€æƒ³åŒæœ´ç´ ç‰ˆï¼Œæœ´ç´ ç‰ˆä¸­ï¼Œæ¯æ¬¡å¯»æ‰¾å½“å‰è·ç¦»æœ€å°çš„ç‚¹æ—¶ï¼Œè¯¥æ“ä½œæ˜¯$\\mathcal{O}(n)$çº§åˆ«ï¼Œä½†æ˜¯å¦‚æœç”¨å †è¿›è¡Œç»´æŠ¤ï¼Œåˆ™è¯¥æ­¥éª¤æ—¶é—´å¤æ‚åº¦é™ä½ä¸º$\\mathcal{O}(1)$ï¼Œé™ä½äº†ç“¶é¢ˆå¤„å¤æ‚åº¦ï¼Œä¸è¿‡å½“ç”¨å †ç»´æŠ¤åï¼Œåœ¨åé¢éœ€è¦ç”¨è¯¥ç‚¹æ›´æ–°å…¶ä»–ç‚¹åˆ°èµ·ç‚¹çš„è·ç¦»æ—¶ï¼Œéœ€è¦å¯¹å †è¿›è¡Œæ“ä½œï¼Œæ‰€ä»¥æœ€ç»ˆæ—¶é—´å¤æ‚åº¦ä¸º$\\mathcal{O}(m \\log n)$ã€‚\n- ä½¿ç”¨**é‚»æ¥è¡¨**å­˜å‚¨ã€‚\n  <a name=\"Lwsjq\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\nstatic class PII implements Comparable<PII> {\n    // xè¡¨ç¤ºè¯¥ç‚¹åˆ°èµ·ç‚¹çš„è·ç¦»ï¼Œyè¡¨ç¤ºèŠ‚ç‚¹ç¼–å·\n    int x, y;\n    public int compareTo(PII p) {\n        return this.x - p.x;\n    }\n}\n\nstatic int n, m, idx;\nstatic final int N = 150010;\nstatic final int INF = 0x3f3f3f3f;\nstatic int[] h = new int[N], e = new int[N], ne = new int[N], dist = new int[N], w = new int[N]; // wè¡¨ç¤ºæƒå€¼\nstatic boolean[] st = new boolean[N];\nstatic PriorityQueue<PII> heap = new PriorityQueue<>();\n// æˆ–è€…ä¹Ÿå¯ä»¥ PriorityQueue<int[]> heap = new PriorityQueue<>((o1,o2)->o1[1]-o2[1]); <int[]>è¿™å—æ˜¯ä¸€ä¸ªæ³›å‹çš„å‚æ•°å£°æ˜ï¼Œåœ¨é›†åˆä¸­åªèƒ½å­˜å–æŒ‡å®šç±»å‹çš„å…ƒç´ ï¼Œè¿™é‡Œé™å®šå †ä¸­æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªä¸€ç»´æ•°ç»„ï¼Œåé¢ä¼ å…¥äº†ä¸€ä¸ªé‡å†™compare()æ–¹æ³•çš„Lambdaè¡¨è¾¾å¼ï¼Œè¡¨ç¤ºæ¯ä¸ªæ•°ç»„å…ƒç´ æŒ‰ä¸‹æ ‡ä¸º1å¤„çš„å…ƒç´ distanceè¿›è¡Œå‡åºæ’åºï¼Œå †é¡¶å…ƒç´ å°±æ˜¯è¿˜æœªç¡®å®šæœ€ç»ˆè·ç¦»çš„ç‚¹åˆ°æºç‚¹è·ç¦»æœ€è¿‘çš„ç‚¹ã€‚\n// å¤§æ ¹å †å†™æ³•ï¼šPriorityQueue<Integer> q = new PriorityQueue<>((o1, o2)->o2.compareTo(o1));\n\npublic static void add(int a, int b, int c) {\n    e[idx] = b;\n    w[idx] = c;\n    ne[idx] = h[a];\n    h[a] = idx ++;\n}\n\npublic static int dijkstra() {\n    // åˆå§‹åŒ–è·ç¦»ä¸ºæ— ç©·å¤§\n    Arrays.fill(dist, INF); \n    // å°†èµ·ç‚¹åˆ°èµ·ç‚¹çš„è·ç¦»å®šä¹‰ä¸º0\n    dist[1] = 0; \n    // å°†èµ·ç‚¹æ”¾è¿›å †ä¸­(å°æ ¹å †)\n    heap.add(new PII(0, 1));\n    // st[1] = true; è¿™é‡Œä¸éœ€è¦æå‰å°†1çš„çŠ¶æ€æ”¹ä¸ºç¡®å®šï¼Œå› ä¸ºè¦å…ˆç”¨å…¶æ›´æ–°å…¶ä»–ç‚¹çš„è·ç¦»ä¹‹åå†ç¡®å®š\n    while(!heap.isEmpty()) {\n        // å–å‡ºå †é¡¶å…ƒç´ \n        PII t = heap.remove(); \n        // vertexä¸ºé¡¶ç‚¹ç¼–å·,diatanceä¸ºå½“å‰ç‚¹åˆ°èµ·ç‚¹çš„è·ç¦»\n        int vertex = t.y, distance = t.x; \n        // å¦‚æœå½“å‰ç‚¹å·²ç»ç¡®å®šè¿‡æœ€å°è·ç¦»ï¼Œåˆ™è·³è¿‡è¯¥ç‚¹ï¼ˆå› ä¸ºæœ‰çš„ç‚¹å¯èƒ½ä¸æ­¢è¿›å †ä¸€æ¬¡ï¼‰\n        if (st[vertex]) continue;\n        // å°†è¯¥ç‚¹æ ‡è®°ä¸ºå·²ç»ç¡®å®šæœ€å°è·ç¦»\n        st[vertex] = true;\n        // ç”¨è¯¥ç‚¹æ›´æ–°å…¶ä»–ç‚¹åˆ°èµ·ç‚¹è·ç¦»\n        for (int i = h[vertex]; i != -1; i = ne[i]) {\n            int j = e[i];\n            if (dist[j] > distance + w[i]) {\n                dist[j] = distance + w[i];\n                // æ›´æ–°åå†æ¬¡è¿›å †ï¼ŒåŸæ¥å †ä¸­çš„è¯¥ç‚¹å°†ä¼šåœ¨ if (st[vertex]) continue; è¿™é‡Œè¢«è·³è¿‡\n                heap.add(new PII(dist[j], j));\n            }\n        }\n    }\n    if (dist[n] == INF) return -1; // å¦‚æœnå·ç‚¹åˆ°èµ·ç‚¹çš„è·ç¦»ä¸å­˜åœ¨ï¼Œè¿”å›-1å³å¯ï¼ˆæ³¨æ„ï¼Œdijkstraä¸å­˜åœ¨è´Ÿæƒå€¼ï¼Œæ— éœ€è€ƒè™‘è·ç¦»ä¸º-1çš„æƒ…å†µï¼ŒbellmanFordå’Œspfaéœ€è¦è€ƒè™‘ï¼‰\n    return dist[n];\n}\n```\n\n<a name=\"os1kn\"></a>\n\n### 3.6 Bellman-Fordç®—æ³•$\\mathcal{O}(nm)$ï¼š[æœ‰è¾¹æ•°é™åˆ¶çš„æœ€çŸ­è·¯](https://www.acwing.com/problem/content/855/)\n\n<a name=\"Ei2FI\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\n- `Bellman-Ford`ç®—æ³•ä»¥è¾¹ä¸ºå•ä½ï¼Œè¿›è¡Œ`n`æ¬¡è¿­ä»£ï¼Œæ¯æ¬¡è¿­ä»£æ›´æ–°ä¸€éæ¯ä¸ªç‚¹åˆ°èµ·ç‚¹çš„è·ç¦»ã€‚`Bellman-Ford`ç®—æ³•å¯¹è¾¹çš„å­˜å‚¨æ²¡ä»€ä¹ˆè¦æ±‚ï¼Œç›´æ¥ç”¨ä¸€ä¸ªç±»å­˜å‚¨å³å¯ã€‚\n- å½“é¢˜ç›®è§„å®šæ±‚åªèƒ½ç»è¿‡`k`æ¡è¾¹çš„æœ€çŸ­è·¯å¾„æ—¶ï¼Œåªèƒ½ç”¨`Bellman-Ford`ç®—æ³•ï¼Œæ­¤æ—¶ç®—æ³•å¤æ‚åº¦ä¸º$\\mathcal{O}(mk)$ã€‚\n- å€¼å¾—ä¸€æçš„æ˜¯æ¯æ¬¡æ›´æ–°æ—¶åº”è¯¥ç”¨ä¸Šä¸€æ¬¡è¿­ä»£åçš„`dist`æ•°ç»„è¿›è¡Œæ›´æ–°ã€‚å¦‚æœç”¨å½“å‰çš„`dist`ï¼Œåˆ™åœ¨æ›´æ–°è¿‡å‡ æ¡è¾¹åï¼Œ`dist`æ•°ç»„å·²ç»æ”¹å˜ï¼Œæ­¤æ—¶å†ç”¨å½“å‰çš„`dist`å»æ›´æ–°ä¼šå¯¼è‡´æœ¬æ¥ä¸èƒ½æ›´æ–°çš„ç‚¹ä¹Ÿè¢«æ›´æ–°æ‰äº†ã€‚ä¾‹å¦‚ä¸‹å›¾ä¸­ï¼Œå¦‚æœè¦æ±‚`k = 1`æ—¶ï¼Œç¬¬ä¸€æ¬¡è¿­ä»£ï¼Œä¼šæ‰«é¢ä¸€éæ‰€æœ‰çš„è¾¹ï¼Œå½“æ›´æ–°å®Œç¼–å·ä¸º`2`è¿™ä¸ªç‚¹çš„è·ç¦»åï¼Œ`dist`æ•°ç»„å·²ç»å‘ç”Ÿå˜åŒ–ï¼Œå½“æ‰«æåˆ°`2->3`è¿™æ¡è¾¹æ—¶ï¼Œ`dist[3]`å°±ä¼šè¢«æ›´æ–°ä¸º`2`ï¼Œè€Œé¢˜ç›®è¦æ±‚åªç»è¿‡`1`æ¡è¾¹ï¼Œå› æ­¤ç­”æ¡ˆåº”è¯¥ä¸º`3`ï¼Œæ˜¾ç„¶ä¸å¯¹ã€‚è€Œæˆ‘ä»¬æ¯æ‰«æä¸€æ¡è¾¹ï¼Œåˆ©ç”¨ä¸Šä¸€æ¬¡è¿­ä»£çš„ç»“æœï¼Œå°±ä¸ä¼šå› ä¸ºå½“å‰ä¸€æ¬¡è¿­ä»£è¿‡ç¨‹ä¸­`dist`æ•°ç»„çš„æ”¹å˜è€Œå‡ºç°é”™è¯¯ï¼Œè¿™å°±æ˜¯ä»£ç å®ç°ä¸­`backup`æ•°ç»„çš„ä½œç”¨ã€‚\n\n![backupæ•°ç»„çš„æ„ä¹‰.PNG](https://cdn.acwing.com/media/article/image/2024/03/02/126318_0e7bae3dd8-backupæ•°ç»„çš„æ„ä¹‰.PNG)\n<a name=\"XcUeL\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\n// å®šä¹‰è¾¹ç±»ï¼Œaè¡¨ç¤ºèµ·ç‚¹ï¼Œbè¡¨ç¤ºç»ˆç‚¹ï¼Œwè¡¨ç¤ºæƒå€¼\nstatic class Edge {\n    public int a, b, w;\n    public Edge(int a, int b, int w) {\n        this.a = a;\n        this.b = b;\n        this.w = w;\n    }\n}\n\npublic static int bellmanFord() {\n    // åˆå§‹åŒ–è·ç¦»ä¸ºæ— ç©·å¤§\n    Arrays.fill(dist, INF); \n    // èµ·ç‚¹è·ç¦»ä¸º 0\n    dist[1] = 0;\n    // è¿›è¡Œkæ¬¡è¿­ä»£ï¼ˆkä¸ºé¢˜ç›®è¦æ±‚çš„åªèƒ½ç»è¿‡kæ¡è¾¹ï¼‰\n    for (int i = 0; i < k; i ++) { \n        // æ‹·è´ä¸Šä¸€æ¬¡è¿­ä»£åçš„distæ•°ç»„\n        int[] backup = Arrays.copyOf(dist, dist.length); \n        // æ‰«ææ¯ä¸€æ¡è¾¹\n        for (int j = 0; j < m; j ++) { \n            int a = edges[j].a, b = edges[j].b, w = edges[j].w;\n            dist[b] = Math.min(dist[b], backup[a] + w); // æ›´æ–°è·ç¦»\n        }\n    }\n    if (dist[n] > INF / 2) flag = true; // è¿™ç§å†™æ³•æ˜¯ä¸ºäº†é¿å…ä¸‹å›¾ä¸­èµ·ç‚¹æ ¹æœ¬åˆ°è¾¾ä¸äº†nè¿™ä¸ªç‚¹ï¼Œè€Œn-1è¿™ä¸ªç‚¹å°†dist[n]çš„æ— ç©·å¤§æ›´æ–°ä¸ºINF - 1ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º\n    return dist[n];\n}\n```\n\n![æ— ç©·å¤§è¢«æ›´æ–°.PNG](https://cdn.acwing.com/media/article/image/2024/03/02/126318_1c31d19ad8-æ— ç©·å¤§è¢«æ›´æ–°.PNG)\n<a name=\"aMltP\"></a>\n\n### 3.7 SPFAç®—æ³•$\\mathcal{O}(m) \\sim \\mathcal{O}(nm)$ï¼š[SPFAæ±‚æœ€çŸ­è·¯](https://www.acwing.com/problem/content/853/)\n\n<a name=\"UZGr2\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\n- `SPFA`ç®—æ³•æ˜¯å¯¹`Bellman-Ford`ç®—æ³•çš„**å®½æœä¼˜åŒ–**ï¼Œä½†æ˜¯å¤±å»äº†`k`çš„é™åˆ¶ï¼ˆæœ‰äº›é¢˜ç›®å°±æ˜¯è¦åœ¨`k`æ¬¡å†…ï¼‰ï¼Œ`Bellman-Ford`æ¯æ¬¡éƒ½ç”¨å½“å‰ç‚¹å»æ›´æ–°å…¶ä»–ç‚¹åˆ°èµ·ç‚¹çš„è·ç¦»ï¼Œå¦‚æœå½“å‰ç‚¹çš„è·ç¦»æ²¡æœ‰å˜å°çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªæ“ä½œå°±æ˜¯åœ¨æµªè´¹æ—¶é—´ï¼Œæ‰€ä»¥`SPFA`ç®—æ³•åœ¨æ­¤å¤„è¿›è¡Œäº†ä¼˜åŒ–ï¼Œåˆ©ç”¨ä¸€ä¸ªé˜Ÿåˆ—ï¼Œæ¯å½“éå†åˆ°çš„ç‚¹è·ç¦»å˜å°æ—¶ï¼Œå°†å…¶æ”¾å…¥é˜Ÿåˆ—ä¸­ï¼Œä¹‹åä¼šç”¨å®ƒå»æ›´æ–°å…¶ä»–ç‚¹çš„è·ç¦»ã€‚\n- å¹¶ä¸”ï¼Œ`SPFA`ç®—æ³•ä¸€èˆ¬æƒ…å†µä¸‹å¾ˆå¿«ï¼Œå¾ˆå¤š`Dijkstra`çš„é¢˜éƒ½å¯ä»¥ç”¨`SPFA`è¿‡æ‰ï¼Œé™¤éå‡ºé¢˜äººæ•…æ„ç¼–é€ æ•°æ®ï¼Œå°†`SPFA`ç®—æ³•æ—¶é—´å¤æ‚åº¦å¡æˆ$\\mathcal{O}(nm)$ã€‚`SPFA`ç®—æ³•æ—¶é—´å¤æ‚åº¦ä¸€èˆ¬ä¸º$\\mathcal{O}(m)$ï¼Œæœ€å$\\mathcal{O}(nm)$ã€‚\n- `Bellman-Ford`ä½¿ç”¨**ç±»**å­˜å‚¨æ¯æ¡è¾¹ï¼Œ`SPFA`ä½¿ç”¨**é‚»æ¥è¡¨**å­˜å‚¨å›¾ã€‚\n- ä¸€å¥è¯æ€»ç»“`SPFA`ï¼Œç”¨æ›´æ–°è¿‡è·ç¦»çš„ç‚¹å†å»æ›´æ–°å…¶ä»–ç‚¹çš„è·ç¦»ã€‚\n  <a name=\"P57kl\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\npublic static boolean spfa() {\n    Arrays.fill(dist, INF);\n    Deque<Integer> q = new ArrayDeque<>();\n    // stæ•°ç»„è¡¨ç¤ºå½“å‰çš„ç‚¹æ˜¯å¦åœ¨é˜Ÿåˆ—å½“ä¸­ï¼Œé˜²æ­¢å­˜å‚¨é‡å¤çš„ç‚¹(ä¸æ ¡éªŒåŸºæœ¬éƒ½ä¼šTLEï¼Œå› ä¸ºspfaä¸­æœ‰çš„ç‚¹å¯èƒ½ä¼šé‡è¯»å…¥é˜Ÿ)\n    q.addLast(1); dist[1] = 0; st[1] = true;\n    \n    while (!q.isEmpty()) {\n        int t = q.pollFirst();\n        // ç»´æŠ¤st\n        st[t] = false;\n        for (int i = h[t]; i != -1; i = ne[i]) {\n            int j = e[i];\n            // d = dist[t] + dist{t -> j}\n            int d = dist[t] + w[i];\n            // èƒ½è¢«æ›´æ–°æ‰æ›´æ–°\n            if (dist[j] > d) {\n                dist[j] = d;\n                // æœªåœ¨é˜Ÿåˆ—ä¸­æ‰å…¥é˜Ÿ\n                if (!st[j]) {\n                    q.addLast(j);\n                    st[j] = true;\n                }\n            }\n        }\n    }\n    return dist[n] != INF;\n}\n```\n\n<a name=\"ZfGqz\"></a>\n\n### 3.8 SPFAåˆ¤è´Ÿç¯ï¼š[SPFAåˆ¤è´Ÿç¯](https://www.acwing.com/activity/content/problem/content/921/)\n\n<a name=\"ozEcG\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\nè¯¥ç®—æ³•åŸºäº`SPFA`ç®—æ³•ï¼Œåœ¨è¯¥è¿‡ç¨‹ä¸­å¢åŠ ä¸€ä¸ª`cnt`æ•°ç»„ï¼Œè¡¨ç¤ºä»èµ·ç‚¹åˆ°è¯¥ç‚¹ç»è¿‡äº†å¤šå°‘ä¸ªç‚¹ï¼Œå¦‚æœæŸæ¡æœ€çŸ­è·¯å¾„ä¸Šé™¤äº†è‡ªå·±æœ‰`n`ä¸ªç‚¹ï¼ˆå‡è®¾æ€»å…±æœ‰`n`ä¸ªç‚¹ï¼‰ï¼Œé‚£ä¹ˆåŠ ä¸Šè‡ªå·±ä¹‹åä¸€å…±æœ‰`n + 1`ä¸ªç‚¹ï¼Œç”±[æŠ½å±‰åŸç†](https://baike.baidu.com/item/%E6%8A%BD%E5%B1%89%E5%8E%9F%E7%90%86/233776)ä¸€å®šæœ‰ä¸¤ä¸ªç‚¹ç›¸åŒï¼Œæ‰€ä»¥å­˜åœ¨ç¯ã€‚å¹¶ä¸”åœ¨è¯¥èƒŒæ™¯ä¸‹ï¼Œè¿™ä¸ªç¯ä¸€å®šæ˜¯è´Ÿç¯ï¼Œå¦åˆ™ä¸ä¼šä¸€ç›´æ›´æ–°è·ç¦»ä»è€Œå¯¼è‡´æ­»å¾ªç¯ã€‚ï¼ˆå½“ç„¶ï¼Œå› ä¸ºæœ‰`cnt`é™åˆ¶ï¼Œä¸€æ—¦`cnt[j] >= n`ï¼Œåˆ™ç›´æ¥`return ture`ï¼Œæ‰€ä»¥ä»£ç ä¸­ä¸ä¼šå­˜åœ¨æ­»å¾ªç¯ï¼‰ã€‚\n<a name=\"pnlzU\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\n// é˜Ÿåˆ—é‡Œå­˜å‚¨èŠ‚ç‚¹ç¼–å·ï¼ˆæ—©æœŸä»£ç ï¼Œç”¨LinkedListå†™çš„ï¼Œå®é™…å¹¶éé˜Ÿåˆ—ï¼Œé›†åˆè€Œå·²ï¼‰\nstatic List<Integer> q = new LinkedList();\npublic static boolean spfa() {\n    // ä¹‹æ‰€ä»¥å°†æ‰€æœ‰ç‚¹æ”¾è¿›é˜Ÿåˆ—ï¼Œæ˜¯å› ä¸ºå¯èƒ½1å·ç‚¹æ ¹æœ¬åˆ°ä¸äº†è´Ÿç¯\n    for (int i = 1; i <= n; i ++) {\n        q.add(i);\n        st[i] = true;\n    }\n    while (!q.isEmpty()) {\n        int t = q.remove();\n        st[t] = false;\n        for (int i = h[t]; i != -1; i = ne[i]) {\n            int j = e[i];\n            // ä¸€å¼€å§‹æ‰€æœ‰distéƒ½ç­‰äº0ï¼ˆä¸ç”¨åˆå§‹åŒ–ä¸ºINFï¼‰ï¼Œå¦‚æœæ»¡è¶³dist[j] > dist[t] + w[i]è¯´æ˜æœ‰è´Ÿæƒå€¼\n            if (dist[j] > dist[t] + w[i]) {\n                dist[j] = dist[t] + w[i];\n                // æ¯æ›´æ–°ä¸€æ¬¡ï¼Œå°†cnt[j]ä¹Ÿæ›´æ–°\n                cnt[j] = cnt[t] + 1;\n                if (!st[j]) {\n                    // å¦‚æœå½“å‰ç‚¹ä¸åœ¨é˜Ÿåˆ—ä¸­ï¼Œå°±å°†å…¶æ”¾è¿›é˜Ÿåˆ—\n                    q.add(j);\n                    st[j] = true;\n                }\n                // å¦‚æœå‘ç°æŸä¸ªç‚¹çš„cntå¤§äºç­‰äºnï¼Œè¯´æ˜å·²ç»åœ¨é‡Œé¢è½¬äº†næ¬¡äº†ï¼Œå› ä¸ºå¦‚æœè¿™ä¸ªç¯çš„æƒå€¼ä¹‹å’Œå¤§äºç­‰äº0çš„è¯ï¼Œæ˜¯ä¸ä¼šåœ¨é‡Œé¢ä¸€ç›´è½¬çš„ï¼Œæ‰€ä»¥ç›´æ¥returnï¼Œé¿å…æ­»å¾ªç¯\n                if(cnt[j] >= n) return true;\n            }\n        }\n    }\n    return false; // å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œåˆ™è¯´æ˜æ²¡æœ‰è´Ÿç¯\n}\n```\n\n<a name=\"uZxnG\"></a>\n\n### 3.9 Floydç®—æ³•ï¼š[Floydæ±‚æœ€çŸ­è·¯](https://www.acwing.com/problem/content/856/)\n\n<a name=\"TleJN\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\n`Floyd`ç®—æ³•åŸºäºåŠ¨æ€è§„åˆ’ï¼Œä½¿ç”¨ä¸‰é‡å¾ªç¯ï¼Œå¯ä»¥æ±‚è§£**å¤šæºæ±‡é—®é¢˜**ã€‚<br />ç”±äº`Floyd`ç®—æ³•æ˜¯æœ€çŸ­è·¯ç®—æ³•çš„æœ€åä¸€ä¸ªç®—æ³•ï¼Œæ‰€ä»¥åœ¨æ­¤è¿›è¡Œæ€»ç»“ï¼š\n\n- æœ´ç´ `Dijkstra`ï¼ˆå•å…ƒæœ€çŸ­è·¯ï¼‰å¸¸ç”¨äºæ±‚è§£éè´Ÿæƒå›¾ä¸­çš„**ç¨ å¯†å›¾**ï¼Œæ—¶é—´å¤æ‚åº¦$\\mathcal{O}(n^2 + m)$ï¼›\n- å †ä¼˜åŒ–ç‰ˆ`Dijkstra`ï¼ˆå•å…ƒæœ€çŸ­è·¯ï¼‰å¸¸ç”¨äºæ±‚è§£éè´Ÿæƒå›¾ä¸­çš„**ç¨€ç–å›¾**ï¼Œæ—¶é—´å¤æ‚åº¦$\\mathcal{O}(m \\log n)$ï¼›\n- `Bellman-Ford`ç®—æ³•å¸¸ç”¨äºæ±‚è§£**æœ‰è¾¹æ•°é™åˆ¶çš„æœ€çŸ­è·¯é—®é¢˜**ï¼Œæ—¶é—´å¤æ‚åº¦$\\mathcal{O}(nm)$ï¼›\n- `spfa`ç®—æ³•å¸¸ç”¨äºæ±‚è§£**å­˜åœ¨è´Ÿæƒè¾¹**çš„æœ€çŸ­è·¯é—®é¢˜ï¼ˆä¹Ÿå¯ä»¥æ±‚æ­£æƒè¾¹æœ€çŸ­è·¯ï¼Œæœ‰è¢«å¡é£é™©ï¼‰ï¼Œæ—¶é—´å¤æ‚åº¦$\\mathcal{O}(m)$ï¼›\n- `Floyd`ç®—æ³•å¸¸ç”¨äºæ±‚è§£**å¤šæºæ±‡æœ€çŸ­è·¯**é—®é¢˜ï¼Œæ—¶é—´å¤æ‚åº¦$\\mathcal{O}(n^3)$ï¼Œ`Floyd`ç®—æ³•çš„ä»£ç å®ç°è¾ƒç®€å•ï¼Œç†è§£ä¸äº†å…ˆç›´æ¥èƒŒè¿‡å³å¯ï¼Œåé¢å­¦äº†`dp`åå°±å¥½ç†è§£äº†ã€‚\n  <a name=\"ToS1U\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\npublic static void floyd() {\n    for (int k = 1; k <= n; k ++)\n        for (int i = 1; i <= n; i ++)\n            for (int j = 1; j <= n; j ++)\n                // dä¸ºå›¾çš„é‚»æ¥çŸ©é˜µï¼ŒFloydç®—æ³•å®Œæˆådå˜æˆæ¯ä¸ªç‚¹åˆ°å…¶ä»–ç‚¹çš„æœ€çŸ­è·ç¦»çŸ©é˜µ\n                d[i][j] = Math.min(d[i][j], d[i][k] + d[k][j]);\n}\n```\n\n<a name=\"G0Mdp\"></a>\n\n### 3.10 æœ´ç´ Primç®—æ³•ï¼š[primç®—æ³•æ±‚æœ€å°ç”Ÿæˆæ ‘](https://www.acwing.com/problem/content/860/)\n\n<a name=\"MlZpa\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\n- `Prim`ç®—æ³•æ˜¯æ±‚æœ€å°ç”Ÿæˆæ ‘çš„ä¸€ç§ç®—æ³•ï¼ŒåŸç†æ˜¯ä»ä¸€ä¸ªç‚¹å‡ºå‘ï¼Œæ¯æ¬¡æ‰¾åˆ°ç¦»é›†åˆæœ€è¿‘çš„ç‚¹ï¼Œå¹¶å°†å…¶åŠ å…¥åˆ°é›†åˆä¸­ï¼Œç„¶åç”¨è¿™ä¸ªç‚¹æ¥æ›´æ–°å‰©ä¸‹çš„ç‚¹åˆ°é›†åˆçš„è·ç¦»ã€‚å¸¸å¸¸ç”¨äºæ±‚è§£**ç¨ å¯†å›¾**çš„æœ€å°ç”Ÿæˆæ ‘é—®é¢˜ã€‚\n- é›†åˆä¸­ç»´æŠ¤çš„å…ƒç´ å°±æ˜¯ç”Ÿæˆæ ‘ä¸­çš„èŠ‚ç‚¹ï¼Œæ¯ä¸ªç‚¹åˆ°é›†åˆçš„è·ç¦»å®šä¹‰ä¸ºè¯¥ç‚¹åˆ°é›†åˆä¸­ä»»æ„ä¸€ç‚¹è·ç¦»çš„æœ€å°å€¼ã€‚\n- ç”¨é‚»æ¥çŸ©é˜µå­˜å‚¨å›¾ã€‚\n  <a name=\"tWnNl\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\npublic static int prim() {\n    Arrays.fill(dist, INF);\n    // resè¡¨ç¤ºç”Ÿæˆæ ‘ä¸­æ¯æ¡è¾¹çš„æƒå€¼ä¹‹å’Œ\n    int res = 0;\n    // è¿­ä»£næ¬¡ï¼Œæ¯æ¬¡ç¡®å®šä¸€ä¸ªèŠ‚ç‚¹\n    for (int i = 0; i < n; i ++) {\n        // tä¸ºä¸´æ—¶å˜é‡ï¼Œç”¨äºå¯»æ‰¾åˆ°é›†åˆçš„æœ€çŸ­èŠ‚ç‚¹\n        int t = -1;\n        // å¯»æ‰¾åˆ°é›†åˆè·ç¦»æœ€çŸ­çš„èŠ‚ç‚¹\n        for (int j = 1; j <= n; j ++)\n            if (!st[j] && (t == -1 || dist[j] < dist[t]))\n                t = j;\n        // å¦‚æœä¸æ˜¯ç¬¬ä¸€ä¸ªç‚¹ï¼Œå¹¶ä¸”åˆ°é›†åˆè·ç¦»æœ€çŸ­çš„ç‚¹çš„è·ç¦»ä¸ºæ— ç©·å¤§ï¼Œåˆ™è¯´æ˜æœ€å°ç”Ÿæˆæ ‘ä¸å­˜åœ¨\n        if (i != 0 && dist[t] == INF) return INF;\n        // å°†è¯¥æ¡è¾¹çš„æƒå€¼åŠ åˆ°resä¸­\n        if (i != 0) res += dist[t];\n        // stè¡¨ç¤ºæ˜¯å¦åŠ å…¥åˆ°é›†åˆä¸­\n        st[t] = true;\n        // ç”¨è¯¥ç‚¹æ›´æ–°å…¶ä»–ç‚¹åˆ°é›†åˆçš„è·ç¦»ï¼Œæ³¨æ„ä¸æ˜¯ dist[t] + g[t][j]\n        for (int j = 1; j <= n; j ++) dist[j] = Math.min(dist[j], g[t][j]);\n    }\n    return res;\n}\n```\n\n<a name=\"qxFoi\"></a>\n\n### 3.11 Kruskalç®—æ³•ï¼š[Kruskalç®—æ³•æ±‚æœ€å°ç”Ÿæˆæ ‘](https://www.acwing.com/activity/content/problem/content/925/)\n\n<a name=\"ydNLU\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\n- `Kruskal`æ˜¯ä»¥è¾¹ä¸ºå¯¹è±¡ï¼Œé¦–å…ˆå°†æ‰€æœ‰è¾¹æŒ‰ç…§æƒå€¼è¿›è¡Œæ’åºï¼Œç„¶åæšä¸¾æ¯ä¸€æ¡è¾¹ï¼Œå¦‚æœä¸€æ¡è¾¹å¯¹åº”çš„ä¸¤ä¸ªé¡¶ç‚¹ä¸åœ¨åŒä¸€ä¸ªé›†åˆä¸­ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å°†å…¶åŠ å…¥åˆ°ä¸€ä¸ªé›†åˆä¸­ï¼Œåœ¨æšä¸¾è¿‡ç¨‹ä¸­è®°å½•ä¸€ä¸ª`cnt`å˜é‡ï¼Œæ¯æ¬¡æœ‰ç‚¹åŠ å…¥é›†åˆä¸­ï¼Œåˆ™`cnt ++`ï¼Œå¦‚æœæšä¸¾å®Œæˆä¹‹åï¼Œ`cnt < n - 1`ï¼Œåˆ™è¯´æ˜å¹¶ä¸æ˜¯æ‰€æœ‰ç‚¹éƒ½åŠ å…¥é›†åˆäº†ï¼Œæ•…æœ€å°ç”Ÿæˆæ ‘ä¸å­˜åœ¨ã€‚\n- åœ¨ä»¥ä¸Šè¿‡ç¨‹ä¸­ï¼Œåˆ¤æ–­ä¸¤ä¸ªç‚¹æ˜¯å¦åœ¨é›†åˆä¸­ï¼Œå¯ä»¥é€šè¿‡å¹¶æŸ¥é›†è¿›è¡ŒæŸ¥è¯¢å¹¶ç»´æŠ¤ã€‚\n  <a name=\"sx7IW\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\nimport java.util.*;\n\npublic class Main {\n    static class Edge {\n        int a, b, w;\n        public Edge(int a, int b, int w) {\n            this.a = a;\n            this.b = b;\n            this.w = w;\n        }\n    }\n    static final int N = 100010, INF = 0x3f3f3f3f;\n    static Edge[] edges = new Edge[2 * N];\n    static int[] p = new int[N];\n    static int n, m;\n    public static void main(String[] args) {\n        Scanner sc = new Scanner(System.in);\n        n = sc.nextInt(); m = sc.nextInt();\n        for (int i = 0; i < m; i ++) {\n            int a = sc.nextInt(), b = sc.nextInt(), w = sc.nextInt();\n            edges[i] = new Edge(a, b, w);\n        }\n        Arrays.sort(edges, 0, m, (o1, o2) -> o1.w - o2.w);\n        int res = kruskal();\n        System.out.println(res == INF ? \"impossible\" : res);\n    }\n    public static int kruskal() {\n        int res = 0, cnt = 0;\n        for (int i = 0; i <= n; i ++) p[i] = i;\n        for (int i = 0; i < m; i ++) {\n            int a = edges[i].a, b = edges[i].b, w = edges[i].w;\n            a = find(a); b = find(b);\n            if (a != b) {\n                p[a] = b;\n                cnt ++;\n                res += w;\n            }\n            if (cnt == n - 1) return res;\n        }\n        return INF;\n    }\n    public static int find(int x) {\n        if (p[x] != x) p[x] = find(p[x]);\n        return p[x];\n    }\n}\n```\n\n<a name=\"qNQGg\"></a>\n\n### 3.12 æŸ“è‰²æ³•åˆ¤åˆ«äºŒåˆ†å›¾ï¼š[æŸ“è‰²æ³•åˆ¤åˆ«äºŒåˆ†å›¾](https://www.acwing.com/problem/content/862/)\n\n<a name=\"U9xRN\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\n- **äºŒåˆ†å›¾ï¼š** å½“ä¸”ä»…å½“å›¾ä¸­ä¸å­˜åœ¨å¥‡æ•°ç¯ï¼Œå¯ä»¥åˆ©ç”¨æŠ½å±‰åŸç†è¿›è¡Œè¯æ˜ï¼›\n- **æŸ“è‰²æ³•**é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å°†æ¯ä¸ªç‚¹æŸ“è‰²ï¼ŒæŸ“è‰²è¿‡ç¨‹ä¸­éœ€è¦ä¿è¯æ¯ä¸ªç‚¹ä¸å®ƒç›¸é‚»çš„ç‚¹çš„é¢œè‰²ä¸åŒï¼Œä¸€å…±ä¸¤ç§é¢œè‰²ã€‚å¦‚æœåœ¨æŸ“è‰²è¿‡ç¨‹ä¸­å‡ºç°çŸ›ç›¾ï¼Œé‚£ä¹ˆè¯¥å›¾å°±ä¸€å®šä¸æ˜¯äºŒåˆ†å›¾ã€‚\n  <a name=\"xnuYL\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\n// uè¡¨ç¤ºå½“å‰èŠ‚ç‚¹ç¼–å·ï¼Œcè¡¨ç¤ºå½“å‰é¢œè‰²\npublic static boolean dfs(int u, int c) { \n    // colorè¡¨ç¤ºé¢œè‰²ï¼Œ0è¡¨ç¤ºæœªæŸ“è‰²ï¼Œ1å’Œ2è¡¨ç¤ºä¸¤ç§ä¸åŒé¢œè‰²\n    color[u] = c; \n    for (int i = h[u]; i != -1; i = ne[i]) { \n        int j = e[i];\n        // å¦‚æœè¿™ä¸ªé‚»ç‚¹æœªè¢«æŸ“è‰²ï¼Œåˆ™å°†å…¶æŸ“ä¸ºä¸uä¸åŒçš„å¦ä¸€ç§é¢œè‰²ï¼Œå¦‚æœæŸ“è‰²ä¸æˆåŠŸï¼Œåˆ™è¯´æ˜å‘ç”ŸçŸ›ç›¾ï¼Œç›´æ¥é€€å‡º\n        if (color[j] == 0 && !dfs(j, 3 - c)) return false;\n        // å¦‚æœå½“å‰èŠ‚ç‚¹çš„ä¸€ä¸ªé‚»ç‚¹ä¸å½“å‰èŠ‚ç‚¹é¢œè‰²ç›¸åŒï¼Œåˆ™å‘ç”ŸçŸ›ç›¾ï¼Œç›´æ¥é€€å‡º\n        else if (color[j] == c) return false; \n    }\n    return true;\n}\n\n// å¼€å§‹æ—¶ flag ä¸º trueï¼Œè¡¨ç¤ºä¸å­˜åœ¨æŸ“è‰²å¤±è´¥çš„æƒ…å†µ\nboolean flag = true; \n// æšä¸¾æ¯ä¸€ä¸ªç‚¹\nfor (int i = 1; i <= n; i ++) \n    // å¯¹è¿˜æ²¡æœ‰æŸ“è‰²çš„èŠ‚ç‚¹æŸ“è‰²\n    if (color[i] == 0 && !dfs(i, 1)) {\n        // æŸ“è‰²å¤±è´¥ï¼Œåˆ™è¯´æ˜ä¸æ˜¯äºŒåˆ†å›¾\n        flag = false; \n        break;\n    }\n// å¾ªç¯ç»“æŸä¹‹å flag è¿˜æ˜¯ true åˆ™è¯´æ˜æŸ“è‰²æˆåŠŸï¼Œä¸ºäºŒåˆ†å›¾\n```\n\n<a name=\"lwi86\"></a>\n\n### 3.13 åŒˆç‰™åˆ©ç®—æ³•ï¼š[äºŒåˆ†å›¾çš„æœ€å¤§åŒ¹é…](https://www.acwing.com/activity/content/problem/content/927/)\n\n<a name=\"zfSqL\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\n- åŒˆç‰™åˆ©ç®—æ³•ç”±ä¸¤ä½åŒˆç‰™åˆ©çš„æ•°å­¦å®¶æå‡ºï¼Œå› æ­¤å¾—åã€‚ç”¨ä¸€ä¸ªå½¢è±¡çš„ä¾‹å­è§£é‡Šï¼Œä¸€ä¸ªäºŒåˆ†å›¾ä¸­ï¼Œæ‰€æœ‰é¡¶ç‚¹åˆ†ä¸ºå·¦å³ä¸¤ä¸ªéƒ¨åˆ†ï¼Œå·¦åŠéƒ¨åˆ†çš„ç‚¹ä¸å³åŠéƒ¨åˆ†çš„ç‚¹ä¹‹é—´å­˜åœ¨è®¸å¤šè¾¹ï¼Œå¦‚æœå…¶ä¸­ä¸€æ¡è¾¹ä¸å…¶ä»–ä»»æ„çš„è¾¹éƒ½ä¸ä¾é™„äºåŒä¸€ä¸ªé¡¶ç‚¹ï¼Œåˆ™ç§°è¿™æ¡è¾¹ä¸ºä¸€ä¸ªåŒ¹é…ã€‚ä¾‹å¦‚å›¾`1`çš„äºŒåˆ†å›¾ä¸­ï¼Œå›¾`4`å°±æ˜¯è¯¥äºŒåˆ†å›¾çš„æœ€å¤§åŒ¹é…ï¼Œæœ€å¤§åŒ¹é…æ•°ä¸º`4`ã€‚\n- åœ¨æ•´ä¸ªåŒ¹é…è¿‡ç¨‹ä¸­ï¼Œæœ€å¼€å§‹`1`å·ä¸`5`å·åŒ¹é…ï¼Œ`2`å·å’Œ`7`å·åŒ¹é…ï¼Œæ­¤æ—¶æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œå½“`3`å·ç‚¹åŒ¹é…æ—¶ï¼Œå‘ç°`7`å·ç‚¹å·²ç»è¢«åŒ¹é…è¿‡äº†ï¼Œæ­¤æ—¶ï¼Œæˆ‘ä»¬çœ‹çœ‹ä¸`7`å·åŒ¹é…çš„`2`å·ç‚¹èƒ½å¦æ¢ä¸ªç‚¹åŒ¹é…ï¼Œè€Œ`2`å·ç‚¹çš„å¦ä¸€ä¸ªå¯åŒ¹é…ç‚¹`5`å·ç‚¹è¢«`1`å·ç‚¹åŒ¹é…ï¼Œæˆ‘ä»¬å†çœ‹`1`å·ç‚¹èƒ½ä¸èƒ½æ¢ä¸ªç‚¹åŒ¹é…ï¼Œæ­¤æ—¶å‘ç°`1`å·ç‚¹è¿˜å¯ä»¥å’Œ`6`å·ç‚¹åŒ¹é…ï¼Œäºæ˜¯ï¼Œ`1ã€2ã€3`å·ç‚¹éƒ½å¯ä»¥åŒ¹é…ï¼Œå¦‚å›¾`3`æ‰€ç¤ºã€‚\n\n![äºŒåˆ†å›¾çš„æœ€å¤§åŒ¹é….PNG](https://cdn.acwing.com/media/article/image/2024/03/02/126318_370a50f7d8-äºŒåˆ†å›¾çš„æœ€å¤§åŒ¹é….PNG)\n<a name=\"EeLdc\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\npublic static boolean find(int x) {\n    for (int i = h[x]; i != -1; i = ne[i]) {\n        int j = e[i];\n        // å¦‚æœjè¿˜æ²¡è¢«è€ƒè™‘è¿‡\n        if (!st[j]) {\n            // å°†jçš„çŠ¶æ€è®¾ç½®ä¸ºå·²è€ƒè™‘è¿‡\n            st[j] = true;\n            // å¦‚æœjè¿˜æ²¡æœ‰ä¸å…¶ä»–ç‚¹åŒ¹é…ï¼Œæˆ–è€…å¯ä»¥ä¸ºä¸jåŒ¹é…çš„ç‚¹æ‰¾åˆ°å…¶ä»–ç‚¹è¿›è¡ŒåŒ¹é…\n            if (match[j] == 0 || find(match[j])) {\n                // é‚£ä¹ˆå°±å°†j è¿™ä¸ªç‚¹ä¸xè¿›è¡ŒåŒ¹é…(match[j]è¡¨ç¤ºä¸jè¿™ä¸ªç‚¹åŒ¹é…çš„ç‚¹çš„èŠ‚ç‚¹ç¼–å·)\n                match[j] = x;\n                // åŒ¹é…æˆåŠŸè¿”å›true\n                return true;\n            }\n        }\n    }\n    // å¦‚æœå®åœ¨åŒ¹é…ä¸äº†ï¼Œå°±è¿”å›false\n    return false;\n}\n\nint res = 0;\n// å·¦åŠéƒ¨åˆ†ç‚¹çš„ç¼–å·ä¸º1~n1ï¼Œä¾æ¬¡æšä¸¾æ¯ä¸ªç‚¹ï¼Œçœ‹èƒ½å¦æ‰¾åˆ°åŒ¹é…\nfor (int i = 1; i <= n1; i ++) {\n    // stè¡¨ç¤ºå½“å‰ç‚¹æ˜¯å¦è¢«è€ƒè™‘è¿‡ï¼Œå¹¶éåŒ¹é…æˆåŠŸä¸å¦\n    Arrays.fill(st, false);\n    // å¦‚æœæ‰¾åˆ°åŒ¹é…ï¼Œæœ€å¤§åŒ¹é…æ•°åŠ ä¸€\n    if (find(i)) res ++;\n}\n```\n\n<a name=\"my7pd\"></a>\n\n## ç¬¬å››ç« ï¼šæ•°å­¦çŸ¥è¯†\n\n<a name=\"XmRxl\"></a>\n\n### 4.1 è¯•é™¤æ³•åˆ¤å®šè´¨æ•°ï¼š[è¯•é™¤æ³•åˆ¤å®šè´¨æ•°](https://www.acwing.com/problem/content/868/)\n\n<a name=\"urRDE\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\nåˆ¤å®šä¸€ä¸ªæ•°`n`æ˜¯å¦æ˜¯è´¨æ•°ï¼Œä¸»è¦åˆ¤å®š$2 \\sim \\sqrt{n}$ä¹‹é—´æ˜¯å¦æœ‰å…¶çº¦æ•°ã€‚ï¼ˆæ‰€æœ‰å°äº`2`çš„æ•°ä¸æ˜¯è´¨æ•°ï¼‰\n<a name=\"UNmRa\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\npublic static boolean isPrime(int x) {\n    if (x < 2) return false;\n    // ç”±äºsqrt()æ¯”è¾ƒæ…¢ï¼Œä¸”i * i å¯èƒ½çˆ†intï¼Œæ‰€ä»¥é‡‡ç”¨æ­¤ç§å†™æ³•\n    for (int i = 2; i <= x / i; i ++)\n        if (x % i == 0) return false;\n\treturn true;\n}\n```\n\n<a name=\"HaCNB\"></a>\n\n### 4.2 è¯•é™¤æ³•åˆ†è§£è´¨å› æ•°ï¼š[è¯•é™¤æ³•åˆ†è§£è´¨å› æ•°](https://www.acwing.com/problem/content/869/)\n\n<a name=\"Mne7Y\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\n- æƒ³è¦å¯¹ä¸€ä¸ªæ•°`x`åˆ†è§£è´¨å› æ•°ï¼Œä¸»è¦æ˜¯é€šè¿‡ä»å°åˆ°å¤§æšä¸¾å…¶çº¦æ•°ï¼Œå½“æšä¸¾åˆ°ä¸€ä¸ªçº¦æ•°`i`æ—¶ï¼Œé€šè¿‡ä¸€ä¸ªå¾ªç¯ï¼Œå°†`x`åå¤æ›´æ–°ä¸º`x = x / i`ï¼Œå¹¶è®°å½•æ›´æ–°äº†å¤šå°‘æ¬¡ï¼Œè¿™ä¸ªæ¬¡æ•°å°±æ˜¯`i`è¿™ä¸ªè´¨å› å­çš„æŒ‡æ•°ã€‚\n- å½“ä¸Šè¿°è¿‡ç¨‹ç»“æŸåï¼Œéœ€è¦åˆ¤å®šä¸€ä¸‹æœ€åçš„`x`æ˜¯å¦è¢«é™¤æˆäº†`1`ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™è¯´æ˜è¢«é™¤å‰©ä¸‹çš„è¿™ä¸ª`x`ä¹Ÿæ˜¯æœ€å¼€å§‹çš„`x`çš„ä¸€ä¸ªè´¨å› å­ï¼Œä¸”è¯¥è´¨å› å­ä¸èƒ½å†è¢«åˆ†è§£ã€‚\n  <a name=\"aAKGd\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\npublic static void devide(int x) {\n    for (int i = 2; i <= x / i; i ++) {\n        // å¦‚æœiæ˜¯xçš„çº¦æ•°\n        if (x % i == 0) {\n            int cnt = 0;\n            // æ±‚å‡ºiçš„æŒ‡æ•°cntï¼Œå¹¶ä¸”æ›´æ–°xï¼ˆå°†è¿™ä¸ªè´¨å› å­é™¤å¹²å‡€ï¼‰\n            while (x % i == 0) {\n                x /= i;\n                cnt ++;\n            }\n            // è¾“å‡ºè¿™ä¸ªè´¨å› å­å’Œå®ƒçš„æŒ‡æ•°\n            System.out.println(i + \" \" + cnt);\n        }\n    }\n    if (x > 1) System.out.println(x + \" \" + 1);\n}\n```\n\n<a name=\"sAAyB\"></a>\n\n### 4.3 ç­›è´¨æ•°ï¼š[ç­›è´¨æ•°](https://www.acwing.com/problem/content/870/)\n\n<a name=\"MgFAi\"></a>\n\n#### 4.3.1 æœ´ç´ ç­›æ³•ï¼š\n\n<a name=\"AeFfu\"></a>\n\n##### ç®—æ³•æ€æƒ³ï¼š\n\n- ç­›è´¨æ•°çš„ç›®çš„åœ¨äºæ±‚å‡º`1 ~ n`ä¹‹é—´çš„è´¨æ•°ã€‚é‚£ä¹ˆæ¯”è¾ƒå¿«é€Ÿçš„åŠæ³•å°±æ˜¯å°†`1 ~ n`å½“ä¸­ä¸æ˜¯è´¨æ•°çš„æ•°ç»™ç­›å‡ºå»\n- æœ´ç´ ç­›æ³•æ˜¯åˆ©ç”¨å·²ç»ç¡®å®šäº†çš„è´¨æ•°è¿›è¡Œç­›é™¤ï¼Œå…¶åŸç†æ˜¯å°†ä¸€ä¸ªè´¨æ•°çš„æ‰€æœ‰å°äºç­‰äº`n`çš„å€æ•°å…¨éƒ¨ç­›é™¤\n\n> ä¸€èˆ¬éƒ½ä¸ç”¨æœ´ç´ ç­›æ³•ï¼Œ~~éƒ½æœ‰çº¿æ€§ç­›äº†ï¼Œè°è¿˜ç”¨æœ´ç´ ç­›æ³•å‘€~~~\n\n<a name=\"Luzjo\"></a>\n\n##### ä»£ç å®ç°ï¼š\n\n```java\n// è®°å½•è´¨æ•°çš„ä¸ªæ•°\nint cnt = 0;\n// å­˜å‚¨æ‰€æœ‰çš„è´¨æ•°\nint[] primes = new int[n];\n// st è¡¨ç¤ºå½“å‰æ•°æ˜¯å¦è¢«ç­›æ‰\nboolean[] st = new boolean[n + 10];\n// ä» 2 å¼€å§‹æšä¸¾æ¯ä¸ªæ•°\nfor (int i = 2; i <= n; i ++) {\n    // å¦‚æœå½“å‰çš„æ•°å·²ç»è¢«ç­›æ‰ï¼Œåˆ™è·³è¿‡è¯¥æ¬¡å¾ªç¯\n    if (st[i]) continue;\n    // å¦åˆ™å°†å…¶åŠ åˆ°è´¨æ•°æ•°ç»„ä¸­ï¼ŒåŒæ—¶cnt ++\n    primes[cnt ++] = i;\n    // ç”¨å½“å‰è´¨æ•°ç­›æ‰å…¶æ‰€æœ‰çš„å€æ•°ï¼ˆå¦‚2iï¼Œ3iéƒ½è¢«ç­›æ‰ï¼‰\n    for (int j = i + i; j <= n; j += i) st[j] = true;\n}\n```\n\n<a name=\"yJZtE\"></a>\n\n#### 4.3.2 çº¿æ€§ç­›æ³•ï¼š\n\n<a name=\"FdYH1\"></a>\n\n##### ç®—æ³•æ€æƒ³ï¼š\n\n- çº¿æ€§ç­›æ³•å¯ä»¥ç†è§£ä¸ºæ˜¯å¯¹æœ´ç´ ç­›æ³•çš„ä¼˜åŒ–ï¼Œå› ä¸ºæœ´ç´ ç­›æ³•é‡Œä¼šå¤šæ¬¡ç­›é™¤åŒä¸€ä¸ªæ•°ï¼Œè€Œçº¿æ€§ç­›æ³•ä¸­ï¼Œæ¯ä¸ªåˆæ•°åªä¼šè¢«ç­›æ‰ä¸€æ¬¡ã€‚\n- å…¶ä¸»è¦æ€æƒ³æ˜¯é€šè¿‡æ¯ä¸ªåˆæ•°çš„æœ€å°è´¨å› å­å°†å…¶ç­›æ‰ã€‚\n  <a name=\"QhNqL\"></a>\n\n##### ä»£ç å®ç°ï¼š\n\n```java\nint cnt = 0;\nint[] primes = new int[n];\nboolean[] st = new boolean[n + 10];\nfor (int i = 2; i <= n; i ++) {\n    // if (st[i]) continue; æ­¤å¤„ä¸èƒ½continueï¼Œå› ä¸ºè¿˜éœ€è¦ç”¨iæ¥ç­›æ‰åé¢çš„åˆæ•°\n    if (!st[i]) primes[cnt ++] = i;\n    // æ¯æ¬¡ç­›æ‰çš„æ•°ä¸ºprimes[j] * iï¼Œæ‰€ä»¥éœ€è¦primes[j] * i <= n\n    for (int j = 0; primes[j] <= n / i; j ++) { \n        st[primes[j] * i] = true;\n        // ä¿è¯primes[j]ä¸ºprimes[j] * içš„æœ€å°è´¨å› å­ï¼Œå½“è¿™ä¸ªæ¡ä»¶å‘ç”Ÿåï¼Œä¸‹ä¸€ä¸ªæšä¸¾çš„å…ƒç´ ä¸€å®šå¤§äºprimes[j] * içš„æœ€å°è´¨å› å­ï¼Œæ‰€ä»¥éœ€è¦break\n        if (i % primes[j] == 0) break;\n    }\n}\n```\n\n<a name=\"IU3UX\"></a>\n\n### 4.4 è¯•é™¤æ³•æ±‚çº¦æ•°ï¼š[è¯•é™¤æ³•æ±‚çº¦æ•°](https://www.acwing.com/activity/content/problem/content/938/)\n\n<a name=\"ffFpl\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\nä¸æ±‚è´¨æ•°å·®ä¸å¤šï¼Œä»`0`å¼€å§‹æšä¸¾åˆ°$\\sqrt{n}$ï¼Œå¯¹æ¯ä¸ªæ•°`i`è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæ˜¯`x`çš„çº¦æ•°ï¼Œä¸”`i != x / i`ï¼Œåˆ™å°†`i`ä¸`x / i`æ”¾è¿›ç­”æ¡ˆä¸­ï¼Œæœ€åæ’åºè¾“å‡ºå³å¯ã€‚\n<a name=\"bcF27\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\nimport java.util.*;\nimport java.io.*;\n\npublic class Main {\n    public static void main(String[] args) throws IOException {\n        Scanner sc = new Scanner(System.in);\n        BufferedWriter bw = new BufferedWriter(new OutputStreamWriter(System.out));\n        int T = sc.nextInt(); \n        while (T -- > 0) {\n            List<Integer> devisors = new ArrayList();\n            int x = sc.nextInt();\n            for (int i = 1; i <= x / i; i ++) {\n                if (x % i == 0) {\n                    devisors.add(i);\n                    if (x / i != i) devisors.add(x / i);\n                }\n            }\n            Collections.sort(devisors);\n            for (int a : devisors) bw.write(a + \" \");\n            bw.write(\"\\n\");\n        }\n        bw.flush();\n    }\n}\n```\n\n<a name=\"FGRaw\"></a>\n\n### 4.5 çº¦æ•°ä¸ªæ•°ï¼š[çº¦æ•°ä¸ªæ•°](https://www.acwing.com/activity/content/problem/content/939/)\n\n<a name=\"cQEAe\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\n- è¯¥ç®—æ³•æ±‚è§£çš„æ˜¯ä¸€ä¸ªæ•°`x`çš„æ‰€æœ‰`2 ~ x - 1`ä¸­çš„çº¦æ•°ä¸ªæ•°\n- è¯¥ç®—æ³•åŸºäºçº¦æ•°ä¸ªæ•°å…¬å¼ï¼š$(\\alpha_1 + 1) \\times (\\alpha_2 + 1) \\times ... \\times (\\alpha_k + 1)$ï¼Œå…¶ä¸­$\\alpha_1$ä¸º`x`çš„ç¬¬ä¸€ä¸ªè´¨å› å­çš„æŒ‡æ•°ï¼Œ$\\alpha_2$ä¸º`x`çš„ç¬¬äºŒä¸ªè´¨å› å­çš„æŒ‡æ•°ï¼Œä¾æ¬¡ç±»æ¨ã€‚\n  <a name=\"iD8yv\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\nimport java.util.*;\n\npublic class Main {\n    static final int mod = (int)1e9 + 7;\n    public static void main(String[] args) {\n        Scanner sc = new Scanner(System.in);\n        int n = sc.nextInt();\n        HashMap<Integer, Integer> primes = new HashMap<>();\n        while (n -- > 0) {\n            int x = sc.nextInt();\n            for (int i = 2; i <= x / i; i ++) {\n                int s = 0;\n                while (x % i == 0) {\n                    x /= i;\n                    s ++;\n                }\n                primes.put(i, primes.getOrDefault(i, 0) + s);\n            }\n            if (x > 1) {\n                primes.put(x, primes.getOrDefault(x, 0) + 1);\n            }\n        }\n        long res = 1;\n        for (int value : primes.values()) \n            res = res * (value + 1) % mod;\n        \n        System.out.println(res);\n    }\n}\n```\n\n<a name=\"wUi0e\"></a>\n\n### 4.6 çº¦æ•°ä¹‹å’Œï¼š[çº¦æ•°ä¹‹å’Œ](https://www.acwing.com/activity/content/problem/content/940/)\n\n<a name=\"C9FxK\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\n- `4.5`èŠ‚æ˜¯æ±‚ä¸€ä¸ªæ•°çš„çº¦æ•°ä¸ªæ•°ï¼Œè€Œ`4.6`åˆ™æ˜¯æ±‚è¿™äº›çº¦æ•°çš„å’Œã€‚\n- è¯¥ç®—æ³•åŒæ ·åŸºäºå…¬å¼ï¼š$(p_1^0 + p_1^1 + ... + p_1^{\\alpha_1}) \\times ... \\times (p_k^0 + p_k^1 + ... + p_k^{\\alpha_k})$ã€‚å…¶ä¸­ï¼Œ$p_1$æ˜¯ç¬¬ä¸€ä¸ªè´¨å› å­ï¼Œ$\\alpha_1$æ˜¯ç¬¬ä¸€ä¸ªè´¨å› å­çš„æŒ‡æ•°ã€‚\n- ä¸Šå¼ä¸­ï¼Œå¯ä»¥åˆ©ç”¨$t = t \\times p + 1$æ±‚è§£æ¯ä¸€é¡¹ï¼Œä¾‹å¦‚ç¬¬ä¸€é¡¹$t_{\\alpha_1}$ï¼š$t_0 = 1, t_1 = p + 1, t_2 = p^2 + p + 1, ..., t_{\\alpha_1} = p^{\\alpha_1} + ... + 1$ã€‚\n  <a name=\"ROvDE\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\nimport java.util.*;\n\n// æ±‚nä¸ªæ•°çš„ä¹˜ç§¯ï¼Œå†æ±‚è¿™ä¸ªæ•°çš„æ‰€æœ‰çº¦æ•°ä¹‹å’Œ\npublic class Main {\n    static final int mod = (int)1e9 + 7;\n    public static void main(String[] args) {\n        Scanner sc = new Scanner(System.in);\n        int n = sc.nextInt();\n        HashMap<Integer, Integer> primes = new HashMap<>();\n        while (n -- > 0) {\n            int x = sc.nextInt();\n            for (int i = 2; i <= x / i; i ++) {\n                int s = 0;\n                while (x % i == 0) {\n                    x /= i; // åŒ4.5èŠ‚\n                    s ++;\n                }\n                primes.put(i, primes.getOrDefault(i, 0) + s);\n            }\n            if (x > 1) primes.put(x, primes.getOrDefault(x, 0) + 1);\n        }\n        long res = 1;\n        for (Map.Entry prime : primes.entrySet()) { // éå†å®¹å™¨ä¸­çš„æ¯ä¸€é¡¹\n            long t = 1;\n            int key = (int)prime.getKey(), value = (int)prime.getValue();\n            while (value -- > 0) t = (t * key + 1) % mod; // æ±‚è§£å…¬å¼çš„æ¯ä¸€é¡¹\n            res = res * t % mod; // å°†å…¬å¼çš„æ¯ä¸€é¡¹ç›¸ä¹˜\n        }\n        System.out.println(res);\n    }\n}\n```\n\n<a name=\"Yh4jS\"></a>\n\n#### è¡¥å……`map`éå†æ–¹å¼ï¼š\n\n```java\nfor (int key : map.keySet()) {} // éå†æ¯é¡¹key\nfor (int value : map.values()) {} // éå†æ¯é¡¹value\nfor (Map.Entry<Integer, Integer> p : entrySet()) {} // éå†mapçš„æ¯ä¸ªå¯¹è±¡\n```\n\n<a name=\"wBmtv\"></a>\n\n### 4.7 æœ€å¤§å…¬çº¦æ•°ï¼š[æœ€å¤§å…¬çº¦æ•°](https://www.acwing.com/activity/content/problem/content/941/)\n\n<a name=\"MdBOV\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\nå¦‚æœä¸€ä¸ªæ•°`d`èƒ½æ•´é™¤`a`ï¼Œä¸”èƒ½æ•´é™¤`b`ï¼Œé‚£ä¹ˆ`d`ä¸€å®šèƒ½æ•´é™¤`câ‚ * a + câ‚‚ * b`ã€‚æ‰€ä»¥`d`ä¹Ÿèƒ½å¤Ÿæ•´é™¤`a - c * b`ï¼Œä»¤`c = (a / b)`å‘ä¸‹å–æ•´ï¼Œåˆ™`a - c * b = a mod b`ï¼Œæ‰€ä»¥`d`ä¹Ÿèƒ½æ•´é™¤`a mod b`ï¼Œæ•…`aã€ b`ä¸¤ä¸ªæ•°çš„æœ€å¤§å…¬çº¦æ•°ç­‰äº`bã€ a mod b`è¿™ä¸¤ä¸ªæ•°çš„æœ€å¤§å…¬çº¦æ•°ã€‚è¿™å°±æ˜¯æ¬§å‡ é‡Œå¾—ç®—æ³•çš„æ ¸å¿ƒä¹‹å¤„ã€‚\n<a name=\"fZu8N\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\npublic static int gcd(int a, int b) {\n    // å¦‚æœbç­‰äº0ï¼Œé‚£ä¹ˆæœ€å¤§å…¬çº¦æ•°å°±æ˜¯aï¼Œå¦åˆ™å°±æ˜¯gcd(b, a % b)\n    return b > 0 ? gcd(b, a % b) : a;\n}\n```\n\n<a name=\"HpVrm\"></a>\n\n### 4.8 æ¬§æ‹‰å‡½æ•°ï¼š[æ¬§æ‹‰å‡½æ•°](https://www.acwing.com/activity/content/problem/content/943/)\n\n<a name=\"Qe8xq\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\n- æ¬§æ‹‰å‡½æ•°æ˜¯æŒ‡ï¼šå¯¹äºä¸€ä¸ªæ­£æ•´æ•°`x`ï¼Œå°äºæˆ–ç­‰äº`x`çš„æ­£æ•´æ•°ä¸­ä¸`x`äº’è´¨çš„æ­£æ•´æ•°ä¸ªæ•°ï¼ˆåŒ…æ‹¬`1`ï¼‰çš„ä¸ªæ•°ï¼Œè®°ä½œ$\\varphi(n)$ã€‚\n- æ¬§æ‹‰å‡½æ•°çš„å…¬å¼æ¨å¯¼å¤§è‡´ä¸ºï¼š\n\n![æ¬§æ‹‰å…¬å¼.png](https://cdn.acwing.com/media/article/image/2024/03/02/126318_86291071d8-æ¬§æ‹‰å…¬å¼.png) <br />å…¶ä¸­$p_i$ä¸º`x`çš„æ¯ä¸€ä¸ªè´¨å› å­ã€‚ä¸Šè¿°å…¬å¼çš„é™¤æ³•å‡ä¸ºæ•´é™¤ï¼ˆå³ä¸‹å–æ•´ï¼‰ï¼Œä¸Šè¿°å…¬å¼çš„æ€æƒ³ä¸ºï¼š`1 ~ x`ä¸­æ€»å…±æœ‰`x`ä¸ªæ•°ï¼Œå‡å»ä¸`x`æœ‰ç›¸åŒè´¨å› å­çš„æ•°åï¼Œå‰©ä¸‹çš„æ•°å‡ä¸`x`äº’è´¨ï¼Œè€Œæ¯æ¬¡ä¼šé‡å¤å‡å»ç›¸åŒçš„æ•°ï¼Œæ‰€ä»¥å†åŠ å›æ¥ï¼ˆå®¹æ–¥åŸç†ï¼‰ã€‚\n<a name=\"BMqZD\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\npublic static int getEuler(int x) {\n    int res = x;\n    for (int i = 2; i <= x / i; i ++) {\n        if (x % i == 0) {\n            // å…¬å¼ï¼Œè¿™ç§å†™æ³•æ˜¯é¿å…å‡ºç°å°æ•°ï¼Œç­‰ä»·äºres = res *(1 - 1 / i);\n            res = res - res / i; \n            // æŠŠ i é™¤å¹²å‡€\n            while (x % i == 0) x /= i;\n        }\n    }\n    if (x > 1) res = res - res / x;\n    return res;\n}\n```\n\n<a name=\"rfpgz\"></a>\n\n### 4.9 ç­›æ³•æ±‚æ¬§æ‹‰å‡½æ•°ï¼š[ç­›æ³•æ±‚æ¬§æ‹‰å‡½æ•°](https://www.acwing.com/activity/content/problem/content/943/)\n\n<a name=\"GSbdg\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\nä¸»è¦æ€æƒ³è¿˜æ˜¯åŸºäº`4.8`ä¸­çš„å…¬å¼ï¼Œæ­¤ç®—æ³•é€‚ç”¨äºé¢˜ç›®è¦æ±‚æ±‚è§£`1 ~ x`ä¸­çš„æ¯ä¸€ä¸ªæ•°çš„æ¬§æ‹‰å‡½æ•°å€¼ã€‚\n<a name=\"Y9Vxz\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\nstatic final int N = 1000010;\nstatic int[] primes = new int[N];\nstatic boolean[] st = new boolean[N];\nstatic int[] phi = new int[N]; // ç”¨äºå­˜æ”¾æ¯ä¸ªæ•°çš„æ¬§æ‹‰å‡½æ•°å€¼\npublic static void getEuler(int x) {\n    int cnt = 0;\n    phi[1] = 1; // å¯¹äºphi[]ï¼Œç”±äºå…¶å®é™…æ„ä¹‰ï¼Œiä»1å¼€å§‹\n    for (int i = 2; i <= x; i ++) {\n        if (!st[i]) {\n            primes[cnt ++] = i;\n            phi[i] = i - 1;\n        }\n        for (int j = 0; primes[j] <= x / i; j ++) {\n            st[primes[j] * i] = true;\n            if (i % primes[j] == 0) {\n                phi[i * primes[j]] = primes[j] * phi[i]; // å…¬å¼1\n                break;\n            }\n            // ä¸éœ€è¦elseï¼Œå› ä¸ºå¦‚æœæ‰§è¡Œäº†if,å°±ä¼šbreak\n            phi[i * primes[j]] = (primes[j] - 1) * phi[i]; // å…¬å¼2\n        }\n    }\n}\n```\n\n<a name=\"mrIbq\"></a>\n\n#### å…¬å¼æ¨å¯¼ï¼š\n\n- **å…¬å¼1ï¼š** ç”±äºæ­¤æ—¶`i % primes[j] == 0`ï¼Œè¯´æ˜`primes[j]`æ˜¯`i`çš„æœ€å°è´¨å› å­ï¼Œåˆ™åœ¨è®¡ç®—`phi[i * primes[j]]`æ—¶ï¼Œ`(1 - 1 / primes[j])`å·²ç»åœ¨æ±‚è§£`phi[i]`æ—¶è¢«ä¹˜è¿‡ä¸€æ¬¡ï¼Œæ‰€ä»¥æ­¤æ—¶ä¸éœ€è¦ä¹˜è¿™ä¸€é¡¹ã€‚\n\n$\\varphi(i \\times\\: \\text{primes}[j]) = i \\times\\: \\text{primes}[j] \\times \\left(1 - \\frac{1}{p_1}\\right) \\times \\left(1 - \\frac{1}{p_2}\\right) \\times \\cdots \\times \\left(1 - \\frac{1}{p_k}\\right) =  \\text{primes}[j]  \\times \t\\varphi(i)$\n\n- **å…¬å¼2ï¼š** ç”±äºæ­¤æ—¶`i % primes[j] != 0`ï¼Œè¯´æ˜`primes[j]`ä¸æ˜¯`i`çš„è´¨å› å­ï¼Œåˆ™åœ¨è®¡ç®—`phi[i * primes[j]]`æ—¶ï¼Œéœ€è¦ä¹˜`(1 - 1 / primes[j])`è¿™ä¸€é¡¹ï¼ŒåŒ–ç®€å³å¯ã€‚\n\n$\\varphi(i \\times\\: \\text{primes}[j]) = i \\times\\: \\text{primes}[j] \\times \\left(1 - \\frac{1}{p_1}\\right) \\times \\left(1 - \\frac{1}{p_2}\\right) \\times \\cdots \\times \\left(1 - \\frac{1}{p_k}\\right) \\times (1 - \\frac{1}{\\text{primes}[j]}) \\\\ = \\text{primes}[j] \\times (1 -\\frac{1}{\\text{primes}[j]}) \\times \\varphi(i) \\\\ = (\\text{primes}[j] - 1) \\times \\varphi(i)$\n\n<a name=\"BEGYT\"></a>\n\n### 4.10 å¿«é€Ÿå¹‚ï¼š[å¿«é€Ÿå¹‚](https://www.acwing.com/problem/content/877/)\n\n<a name=\"XDMyV\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\n- å¿«é€Ÿå¹‚å¯ä»¥å¿«é€Ÿæ±‚è§£$a^b \\% p$çš„ç»“æœã€‚$a^b$åœ¨`java`ä¸­è™½ç„¶æœ‰æ–¹æ³•`pow`å¯ä»¥ä½¿ç”¨ï¼Œä½†æ˜¯åœ¨è®¡ç®—è¿‡ç¨‹ä¸­å¾ˆå®¹æ˜“å°±çˆ†`long`ï¼Œè€Œå¿«é€Ÿå¹‚è®¡ç®—çš„æ¯ä¸€æ­¥éƒ½ä¼š$\\% p$ï¼Œä¸€èˆ¬ä¸ä¼šçˆ†`long`ã€‚\n- å…¶æ€æƒ³ä¸ºå…ˆé¢„å¤„ç†å‡º$a^{2^0}, a^{2^1}, ..., a^{2^{\\log b}}$çš„ç»“æœï¼Œè¿™äº›æ•°æ¯ä¸€ä¸ªéƒ½æ˜¯å‰ä¸€ä¸ªçš„å¹³æ–¹ã€‚è¿™ä¸€æ­¥æ˜¾ç„¶æ˜¯$\\mathcal{O}(\\log b)$å¤æ‚åº¦çš„ã€‚\n- å†å°†$a^b$åˆ†è§£ä¸ºè‹¥å¹²ä¸ªå‰é¢é¢„å¤„ç†å‡ºæ¥çš„å€¼ç›¸ä¹˜ï¼Œå³å°†`b`åˆ†è§£ä¸ºå‰é¢é¢„å¤„ç†å‡ºæ¥çš„å€¼çš„æŒ‡æ•°ç›¸åŠ ï¼Œè¿™ä¸€æ­¥å¯ä»¥ä½¿ç”¨äºŒè¿›åˆ¶è¿›è¡Œè®¡ç®—ï¼Œä¾‹å¦‚ï¼šåè¿›åˆ¶ä¸­çš„$a^5$ï¼Œ`5`çš„äºŒè¿›åˆ¶çš„`101`ï¼Œåˆ™`5`å¯ä»¥å†™ä¸º$2^0 + 2^2$ï¼Œé‚£ä¹ˆ$a^5$å°±è¢«åˆ†è§£ä¸º$a^{2^0} \\times a^{2^2}$ï¼Œæ­¤æ—¶å°±å¯ä»¥ç”¨é¢„å¤„ç†å‡ºæ¥çš„å€¼ç›¸ä¹˜å¾—åˆ°ã€‚è€Œè¿™ä¸€æ­¥ä¹Ÿæ˜¯$\\mathcal{O}(\\log b)$çš„ï¼Œå› æ­¤æ—¶é—´å¤æ‚åº¦ä¸º$\\mathcal{O}(\\log b)$ã€‚\n  <a name=\"XiN7v\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n> è¯¥æ¨¡æ¿ç›¸å½“ç²¾å¦™ï¼Œåœ¨æ¯æ¬¡`while`å¾ªç¯æ—¶ï¼Œç®—å‡º$a^{2^i}$ï¼ŒåŒæ—¶åˆ¤æ–­è¿™ä¸€ä¸ªé¢„å¤„ç†å‡ºæ¥çš„å€¼éœ€ä¸éœ€è¦ä¹˜è¿›å»ï¼Œå¹¶è¾¾åˆ°äº†æ›´æ–°`a`å’Œ`b`çš„æ•ˆæœ\n\n```java\npublic static int qmi(int a, int b, int p) {\n    // é˜²æ­¢p=1ï¼Œå½“p=1æ—¶ï¼Œç­”æ¡ˆä¸º0\n    int res = 1 % p;\n    while(b > 0) {\n        // (b & 1)è¦åŠ æ‹¬å·ï¼Œå¦åˆ™&ä¼šè¢«å½“ä½œé€»è¾‘è¿ç®—ç¬¦ï¼Œ(b & 1) == 1 è¡¨ç¤ºbçš„äºŒè¿›åˆ¶ä¸­æœ€åä¸€ä½æ˜¯å¦æ˜¯1ï¼Œ& è¿ç®—ç¬¦è¡¨ç¤ºå‚ä¸è®¡ç®—çš„ä¸¤ä¸ªæ•°äºŒè¿›åˆ¶ä¸­å¯¹åº”ä½ç½®çš„æ•°éƒ½æ˜¯1æ‰æ˜¯1ï¼Œå¦åˆ™ä¸º0\n        if ((b & 1) == 1) res = (int)((long)res * a % p);\n        // å°†aæ›´æ–°ä¸ºa^2(javaä¸ºå¼ºç±»å‹è¯­è¨€ï¼Œæ¯”c++ä¸¥æ ¼ï¼Œå¿…é¡»æœ€åæ‰‹åŠ¨å¼ºè½¬ä¸ºintå†å¤åˆ¶ç»™a)\n        a = (int)((long)a * a % p);\n        // åˆ é™¤bçš„äºŒè¿›åˆ¶ä¸­æœ€åä¸€ä½æ•°\n        b >>= 1;\n    }\n    return res;\n}\n```\n\n<a name=\"Xkti4\"></a>\n\n### 4.11 å¿«é€Ÿå¹‚æ±‚é€†å…ƒï¼š[å¿«é€Ÿå¹‚æ±‚é€†å…ƒ](https://www.acwing.com/activity/content/problem/content/945/)\n\n<a name=\"mUBgJ\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\n- **ä¹˜æ³•é€†å…ƒå®šä¹‰**ï¼šè‹¥æ•´æ•°`b, m`äº’è´¨ï¼Œå¹¶ä¸”å¯¹äºä»»æ„çš„æ•´æ•°`a`ï¼Œå¦‚æœæ»¡è¶³`b|a`ï¼Œåˆ™å­˜åœ¨ä¸€ä¸ªæ•´æ•°`x`ï¼Œä½¿å¾—`a/b â‰¡ a * x (mod m)`ï¼Œåˆ™ç§°`x`ä¸º`b`çš„æ¨¡`m`ä¹˜æ³•é€†å…ƒï¼Œè®°ä½œ`bâ»Â¹ (mod m)`ã€‚`b`å­˜åœ¨ä¹˜æ³•é€†å…ƒçš„å……åˆ†å¿…è¦æ¡ä»¶æ˜¯`b`ä¸æ¨¡æ•°`m`äº’è´¨ã€‚\n\n$\\frac{a}{b} = a \\cdot x \\pmod{m} \\\\ b \\cdot x \\equiv 1 \\pmod{m} \\\\ \\because m\\text{ä¸ºè´¨æ•°ï¼Œç”±è´¹é©¬å°å®šç†çŸ¥,} \\\\ b^{m-1} \\equiv 1 \\pmod{m} \\\\ \\text{åˆ} \\because b^{m-1} = b \\cdot b^{m-2}\\quad (m \\geq 2) \\\\  \\therefore x \\equiv b^{m-2}\\quad (\\text{mod } m)$\n\n- å½“`b`ä¸º`m`çš„å€æ•°æ—¶ï¼Œæ˜¾ç„¶ï¼Œ`b % m = 0`ï¼Œä¸å­˜åœ¨é€†å…ƒï¼›\n- å½“`b`ä¸æ˜¯`m`çš„å€æ•°æ—¶ï¼Œ`b`çš„é€†å…ƒä¸º$b^{m - 2} \\% m$ã€‚\n  <a name=\"j3cuP\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\npublic static int qmi(int a, int b, int p) {\n    int res = 1 % p;\n    while (b != 0) {\n        if ((b & 1) == 1) res = (int)((long)res * a % p);\n        a = (int)((long)a * a % p);\n        b >>= 1;\n    }\n    return res;\n}\n\nint a = sc.nextInt(), p = sc.nextInt();\nint res = qmi(a, p - 2, p);\nif (b % m != 0) System.out.println(res);\nelse System.out.println(\"impossible\");\n```\n\n<a name=\"k1url\"></a>\n\n### 4.12 æ‰©å±•æ¬§å‡ é‡Œå¾—ç®—æ³•ï¼š[æ‰©å±•æ¬§å‡ é‡Œå¾—ç®—æ³•](https://www.acwing.com/activity/content/problem/content/946/)\n\n<a name=\"DPzHN\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\n- æƒ³äº†è§£æ‰©å±•æ¬§å‡ é‡Œå¾—ç®—æ³•ï¼Œå…ˆå¼•å…¥**è£´å±å®šç†ï¼š** è‹¥`a, b` æ˜¯æ•´æ•°,ä¸” `gcd(a , b) = d` ï¼Œé‚£ä¹ˆå¯¹äºä»»æ„çš„æ•´æ•°`x, y`, `ax + by`éƒ½ä¸€å®šæ˜¯`d`çš„å€æ•°ï¼Œç‰¹åˆ«åœ°ï¼Œä¸€å®šå­˜åœ¨æ•´æ•°`x, y`ï¼Œä½¿`ax + by = d`æˆç«‹ã€‚è€Œæ‰©å±•æ¬§å‡ é‡Œå¾—ç®—æ³•åˆ™å¯ä»¥å¾ˆæ–¹ä¾¿çš„æ±‚è§£ä»»æ„æ­£æ•´æ•°`a, b`çš„`x, y`è¿™ä¸¤ä¸ªç³»æ•°ã€‚å³é€šè¿‡å‡½æ•°`exgcd(a, b, x, y)`æ±‚å¾—ç³»æ•°`x, y`ã€‚æ³¨æ„ï¼š`x, y`å¹¶ä¸å”¯ä¸€ã€‚\n- ç”±æ¬§å‡ é‡Œå¾—ç®—æ³•çŸ¥ï¼Œ`gcd(a, b) = gcd(b, a % b)`ï¼Œè€Œ`a % b = a - a / b * b` ï¼Œé‚£ä¹ˆåœ¨é€’å½’æ±‚`exgcd(b, a % b, y, x)`æ—¶æœ‰`by + (a % b)x = d`ï¼ŒåŒ–ç®€å¾—`ax + (y - a / b * x)b = d`ï¼Œè¯´æ˜åœ¨é€’å½’æ—¶ç³»æ•°`x`ä¸ç”¨æ›´æ–°ï¼ˆè¿™é‡Œçš„`x`æ˜¯æŒ‡`exgcd`å‡½æ•°é‡Œçš„`x`ï¼Œå› ä¸ºåœ¨æ¯æ¬¡è¿›è¡Œé€’å½’æ—¶ï¼Œä¼šå°†å®å‚äº¤æ¢åå†å¤åˆ¶ç»™å½¢å‚ï¼‰ï¼Œåªéœ€è¦æ›´æ–°`y`ã€‚\n- åœ¨`java`ä¸­æ²¡æœ‰ç±»ä¼¼`C ++`çš„å¼•ç”¨ç±»å‹ï¼Œå¯ä»¥ç”¨æ•°ç»„è¿›è¡Œä»£æ›¿ã€‚\n  <a name=\"a6D15\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\nstatic int[] x = new int[1];\nstatic int[] y = new int[1];\n// å½¢å¼ä¸Šæ˜¯æŠŠgcdæ‹†å¼€å†™\npublic static int exgcd(int a, int b, int[] x, int[] y) {\n    if (b == 0) {\n        x[0] = 1;\n        y[0] = 0;\n        return a;\n    }\n    int d = exgcd(b, a % b, y, x);\n    // æ ¸å¿ƒï¼Œæ›´æ–°ç³»æ•°ï¼Œè¿™é‡Œå®é™…ä¸Šä¸åªæ˜¯æ›´æ–°yï¼Œåªæ˜¯å˜é‡åç»Ÿä¸€ä¸ºyäº†ï¼Œå®é™…ä¸Šæ˜¯äº¤æ›¿æ›´æ–°x, y\n    y[0] -= a / b * x[0];\n    return d;\n}\n```\n\n<a name=\"kX05h\"></a>\n\n### 4.13 çº¿æ€§åŒä½™æ–¹ç¨‹ï¼š[çº¿æ€§åŒä½™æ–¹ç¨‹](https://www.acwing.com/activity/content/problem/content/947/)\n\n<a name=\"IPFL1\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\n- å¯ä»¥é€šè¿‡æ‰©å±•æ¬§å‡ é‡Œå¾—ç®—æ³•æ±‚è§£çº¿æ€§åŒä½™æ–¹ç¨‹`ax â‰¡ b (mod m)`ã€‚ä»å–æ¨¡çš„å®šä¹‰å‡ºå‘ï¼Œå¯ä»¥æ ¹æ®`ax â‰¡ b (mod m)`æ„é€ å‡º`ax = my' + b`ï¼Œä»¤`y = -y'`ï¼Œæ•´ç†å¾—`ax + my = b`ï¼Œå½“`b`ä¸º`a, m`çš„æœ€å°å…¬å€æ•°çš„å€æ•°æ—¶ï¼Œå¯ä»¥åˆ©ç”¨æ‰©å±•æ¬§å‡ é‡Œå¾—ç®—æ³•è¿›è¡Œæ±‚è§£ï¼Œè€Œå½“`b`ä¸æ˜¯å…¶å€æ•°æ—¶ï¼Œåˆ™æ— è§£ã€‚\n- å½“ç”¨æ‰©å±•æ¬§å‡ é‡Œå¾—æ±‚å‡ºä¸€ç»„$x_0, y_0$åï¼Œæ­¤æ—¶çš„$x_0, y_0$æ»¡è¶³çš„æ˜¯$ax_0 + my_0 = gcd(a, m)$ï¼Œæ­¤æ—¶ï¼Œæˆ‘ä»¬å°†ç­‰å¼ä¸¤è¾¹åŒæ—¶ä¹˜ä»¥$\\frac {b}{gcd(a, m)}$ï¼Œå¾—åˆ°$ax_0(\\frac {b}{gcd(a, m)}) + my_0(\\frac {b}{gcd(a, m)}) = b$ï¼Œä»¤$x = x_0(\\frac{b}{gcd(a, m)})$ï¼Œ$y= y_0(\\frac{b}{gcd(a, m)})$ï¼Œåˆ™æ­¤æ—¶çš„`x, y`å³ä¸ºåŸçº¿æ€§åŒä½™æ–¹ç¨‹çš„ä¸€ç»„è§£ã€‚\n  <a name=\"C7GMd\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\nstatic int[] x = new int[1];\nstatic int[] y = new int[1];\npublic static int exgcd(int a, int b, int[] x, int[] y) {\n    if (b == 0) {\n        x[0] = 1;\n        y[0] = 0;\n        return a;\n    }\n    int d = exgcd(b, a % b, y, x);\n    y[0] -= a / b * x[0];\n    return d;\n}\n\nint d = exgcd(a, m, x, y);\n// è‹¥bä¸ä¸ºdçš„å€æ•°ï¼Œåˆ™åŸçº¿æ€§åŒä½™æ–¹ç¨‹æ— è§£\nif (b % d != 0) bw.write(\"impossible\\n\"); \n// mod mæ˜¯ä¸ºäº†å°†å…¶è½¬æ¢ä¸ºintèŒƒå›´å†…çš„è§£\nelse bw.write((long)x[0] * (b / d) % m + \"\\n\"); \nbw.flush();\n```\n\n<a name=\"bh32e\"></a>\n\n### 4.14 é«˜æ–¯æ¶ˆå…ƒ$\\mathcal{O}(n^3)$ï¼š[é«˜æ–¯æ¶ˆå…ƒè§£çº¿æ€§æ–¹ç¨‹ç»„](https://www.acwing.com/problem/content/885/)\n\n<a name=\"EYJpX\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\né«˜æ–¯æ¶ˆå…ƒçš„åŸç†æ˜¯å°†çº¿æ€§æ–¹ç¨‹ç»„çš„å¢å¹¿çŸ©é˜µè¿›è¡Œåˆç­‰è¡Œå˜æ¢ï¼Œä½¿ä¹‹æˆä¸ºä¸Šä¸‰è§’çŸ©é˜µï¼Œå†é€šè¿‡ä¸Šä¸‰è§’çŸ©é˜µå€’ç€è§£å‡ºæœªçŸ¥æ•°ã€‚<br />**æ­¥éª¤å¦‚ä¸‹ï¼š**\n\n- ä¾æ¬¡éå†æ¯ä¸€åˆ—`c`;\n- æ‰¾åˆ°è¿™ä¸€åˆ—ä¸­ç»å¯¹å€¼æœ€å¤§çš„å…ƒç´ è¡Œå·ï¼Œè‹¥æœ€å¤§å…ƒç´ ä¸º`0`ï¼Œåˆ™ä¸éœ€è¦å¤„ç†æ­¤åˆ—ï¼›\n- å°†å…¶äº¤æ¢åˆ°ç¬¬`r`è¡Œï¼ˆ`r`ä»`0`å¼€å§‹ï¼‰;\n- å°†ç¬¬`r`è¡Œç¬¬`c`åˆ—å…ƒç´ åŒ–ä¸º`1`ï¼ˆåˆç­‰è¡Œå˜æ¢ï¼‰ï¼›\n- æœ€åé€šè¿‡ä¸Šä¸‰è§’çŸ©é˜µåˆ¤æ–­è§£çš„æƒ…å†µã€‚\n  <a name=\"rQdqY\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\nimport java.util.*;\nimport java.io.*;\n\npublic class Main {\n    static final int N = 110;\n    static int n;\n    static double[][] a = new double[N][N];\n    static final double eps = 1e-6;\n    // ä¾¿äºäº¤æ¢æ•°ç»„ä¸­çš„å…ƒç´ \n    public static void swap(int x1, int y1, int x2, int y2) { \n        double t = a[x1][y1];\n        a[x1][y1] = a[x2][y2];\n        a[x2][y2] = t;\n    }\n    public static int gauss() {\n        int c, r; // col row\n        for (c = 0, r = 0; c < n; c ++) {\n            // æ ‡è®°å½“å‰åˆ—ä¸­æœ€å¤§å…ƒç´ è¡Œå·\n            int t = r; \n            // æ‰¾åˆ°æœ€å¤§å…ƒç´ è¡Œå·\n            for (int i = r; i < n; i ++) \n                if (Math.abs(a[i][c]) > Math.abs(a[t][c])) \n                    t = i;\n\n            // è‹¥æœ€å¤§çš„ä¸€ä¸ªå…ƒç´ ä¸º0ï¼Œåˆ™è¯¥åˆ—ä¸éœ€è¦å†è¿›è¡Œå¤„ç†\n            if(Math.abs(a[t][c]) < eps) continue; \n\n            // å°†æ‰¾åˆ°çš„è¿™è¡Œæ¢åˆ°ç¬¬rè¡Œ,ä»ç¬¬cåˆ—å¼€å§‹ï¼ˆcåˆ—ä¹‹å‰çš„å…¨ä¸ºé›¶ä¸”èƒ½ä¸ä¹‹äº¤æ¢çš„ä¹Ÿæ˜¯0ï¼‰\n            for (int i = c; i <= n; i ++)  swap(t, i, r, i); \n\n            // å°†è¿™ä¸€è¡Œæ‰€æœ‰çš„æ•°é™¤ä»¥è¿™ä¸€è¡Œçš„ç¬¬cä¸ªæ•°ï¼ˆå°†ç¬¬cä¸ªæ•°åŒ–ä¸º1ï¼‰\n            for (int i = n; i >= c; i --) a[r][i] /= a[r][c]; \n\n            // å°†è¯¥åˆ—åœ¨è¯¥è¡Œä¸€ä¸‹çš„å…ƒç´ åŒ–ä¸º0ï¼Œåˆç­‰è¡Œå˜æ¢ï¼ˆæŸä¸€è¡Œå‡å»æŸä¸€è¡Œçš„è‹¥å¹²å€ï¼‰\n            for (int i = r + 1; i < n; i ++) { \n                // è‹¥è¯¥åˆ—rè¡Œä¸€ä¸‹æœ‰å…ƒç´ æœ¬èº«æ˜¯0ï¼Œåˆ™å…ƒç´ æ‰€åœ¨è¡Œä¸éœ€è¦è¿›è¡Œå¤„ç†\n                if (Math.abs(a[i][c]) > eps) \n                    for (int j  = n; j >= c; j --)  \n                        a[i][j] -= a[r][j] * a[i][c]; // åˆç­‰è¡Œå˜æ¢\n            }\n            // æ­¤å¤„rä¹Ÿå¯ä»¥ç†è§£ä¸ºå¢å¹¿çŸ©é˜µçš„ç§©ï¼Œå¯ä»¥é€šè¿‡ç§©åˆ¤å®šå”¯ä¸€è§£/æ— ç©·å¤šè§£/æ— è§£\n            r ++; \n        }\n\n        if (r < n) {\n            for (int i = r; i < n; i ++) {\n                // å¦‚æœç³»æ•°ä¸º0ï¼Œä½†å¤šé¡¹å¼å’Œä¸ä¸º0ï¼Œåˆ™è¯´æ˜æ— è§£\n                if (Math.abs(a[i][n]) > eps) return 2; \n            }\n            // å¦åˆ™ä¸ºæ— ç©·å¤šè§£\n            return 1; \n        }\n        // å”¯ä¸€è§£çš„æƒ…å†µ\n        else {\n            // ä»å€’æ•°ç¬¬äºŒè¡Œå¾€ä¸Šè§£æ–¹ç¨‹\n            for (int i = n - 2; i >= 0; i --) { \n                for (int j = i + 1; j < n; j ++) // iä¸ºè¡Œæ•°ï¼Œjä¸ºåˆ—æ•°\n                    // ç³»æ•°ä¹˜ä»¥æœªçŸ¥æ•°çš„å€¼(å€¼åœ¨è¯¥è¡Œçš„ä¸‹ä¸€è¡Œ(ç¬¬jè¡Œ)å·²ç»è§£å‡ºï¼Œå¹¶å­˜æ”¾åœ¨a[][n])\n                    a[i][n] -= a[i][j] * a[j][n]; \n            }\n            return 0;\n        }\n    }\n\n    public static void main(String[] args) throws IOException {\n        BufferedReader br = new BufferedReader(new InputStreamReader(System.in));\n        n = Integer.parseInt(br.readLine());\n\n        // è¯»å…¥å¢å¹¿çŸ©é˜µ\n        for (int i = 0; i < n; i ++) { \n            String[] s = br.readLine().split(\" \");\n            // æ¯è¡Œä¼šå¤šä¸€ä¸ªå¤šé¡¹å¼çš„å’Œ\n            for (int j = 0; j <= n; j ++) { \n                a[i][j] = Double.parseDouble(s[j]);\n            }\n        }\n\n        int ans = gauss();\n        // å”¯ä¸€è§£\n        if (ans == 0)  \n            for (int i = 0; i < n; i ++)\n                if(Math.abs(a[i][n]) < eps)\n                    // é¿å…æ•°æ®å­˜å‚¨æ—¶ç²¾åº¦è¯¯å·®ï¼ˆä¾‹å¦‚å­˜çš„ç­”æ¡ˆä¸º-0.00000000000001ï¼Œå¦‚æœä¿ç•™ä¸¤ä½å°æ•°ä¼šè¾“å‡º-0.00ï¼Œç­”æ¡ˆåº”ä¸º0.00ï¼‰\n                    System.out.printf(\"0.00\\n\"); \n                else\n                    System.out.printf(\"%.2f\\n\", a[i][n]);\n        else if (ans == 1) System.out.println(\"Infinite group solutions\"); // æ— ç©·å¤šè§£\n        else System.out.println(\"No solution\"); // æ— è§£\n    }\n}\n```\n\n<a name=\"AdqL6\"></a>\n\n### 4.15 ç®€å•åšå¼ˆè®ºï¼š[Nimæ¸¸æˆ](https://www.acwing.com/activity/content/problem/content/961/)\n\n<a name=\"LQfgi\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\nåšå¼ˆè®ºåˆè¢«ç§°ä¸ºå¯¹ç­–è®º(Game Theory)ï¼Œæ—¢æ˜¯ç°ä»£æ•°å­¦çš„ä¸€ä¸ªæ–°åˆ†æ”¯ï¼Œä¹Ÿæ˜¯è¿ç­¹å­¦çš„ä¸€ä¸ªé‡è¦å­¦ç§‘ã€‚åšå¼ˆè®ºä¸»è¦ç ”ç©¶å·²å…¬å¼åŒ–çš„æ¿€åŠ±ç»“æ„é—´çš„ç›¸äº’ä½œç”¨ï¼Œæ˜¯ç ”ç©¶å…·æœ‰æ–—äº‰æˆ–ç«äº‰æ€§è´¨ç°è±¡çš„æ•°å­¦ç†è®ºå’Œæ–¹æ³•ã€‚åšå¼ˆè®ºè€ƒè™‘æ¸¸æˆä¸­çš„ä¸ªä½“çš„é¢„æµ‹è¡Œä¸ºå’Œå®é™…è¡Œä¸ºï¼Œå¹¶ç ”ç©¶å®ƒä»¬çš„ä¼˜åŒ–ç­–ç•¥ã€‚<br />ä»¥`Nim`æ¸¸æˆä¸ºä¾‹ï¼šç»™å®š`n`å †çŸ³å­ï¼Œä¸¤ä½ç©å®¶è½®æµæ“ä½œï¼Œæ¯æ¬¡æ“ä½œå¯ä»¥ä»ä»»æ„ä¸€å †çŸ³å­ä¸­æ‹¿èµ°ä»»æ„æ•°é‡çš„çŸ³å­ï¼ˆå¯ä»¥æ‹¿å®Œï¼Œä½†ä¸èƒ½ä¸æ‹¿ï¼‰ï¼Œæœ€åæ— æ³•è¿›è¡Œæ“ä½œï¼ˆå³æ²¡æœ‰çŸ³å­å¯æ‹¿ï¼‰çš„äººè§†ä¸ºå¤±è´¥ã€‚<br />é—®å¦‚æœä¸¤äººéƒ½é‡‡ç”¨æœ€ä¼˜ç­–ç•¥ï¼Œå…ˆæ‰‹æ˜¯å¦å¿…èƒœï¼Ÿ<br />**ç»“è®ºï¼š**\n\n- æ¯å †çŸ³å­çš„å¼‚æˆ–ä¸º`0`ï¼Œåˆ™å…ˆæ‰‹å¿…è´¥\n- æ¯å †çŸ³å­çš„å¼‚æˆ–ä¸º`1`ï¼Œåˆ™å…ˆæ‰‹å¿…èƒœ\n  <a name=\"ksM19\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\nimport java.util.*;\nimport java.io.*;\n\npublic class Main {\n    public static void main(String[] args) throws IOException {\n        BufferedReader br = new BufferedReader(new InputStreamReader(System.in));\n        int n = Integer.parseInt(br.readLine());\n        String[] s = br.readLine().split(\" \");\n        int[] a = new int[100010];\n        int res = 0; \n        for (int i = 0; i < n; i ++) {\n            a[i] = Integer.parseInt(s[i]);\n            res ^= a[i];\n        }\n        if (res == 0) System.out.print(\"No\"); \n        else System.out.print(\"Yes\");\n    }\n}\n```\n\n<a name=\"NcXWE\"></a>\n\n## ç¬¬äº”ç« ï¼šåŠ¨æ€è§„åˆ’\n\n<a name=\"C82gy\"></a>\n\n### 5.1èƒŒåŒ…é—®é¢˜\n\n> è€ƒè™‘èƒŒåŒ…é—®é¢˜çš„æ—¶å€™ï¼ŒçŠ¶æ€è¡¨ç¤ºä¸ºï¼šå‰`i`ä¸ªç‰©å“ï¼ˆç¬¬ä¸€ç»´ï¼‰ï¼Œæ¯å¢åŠ ä¸€ä¸ªé™åˆ¶ï¼Œå¢åŠ ä¸€ç»´ï¼Œç„¶åå†è€ƒè™‘å¯¹ä»£ç åšç­‰ä»·å˜å½¢ä¼˜åŒ–ç©ºé—´ã€‚\n\n<a name=\"JIgg3\"></a>\n\n#### 5.1.1 01èƒŒåŒ…é—®é¢˜\n\n<a name=\"P5n2l\"></a>\n\n##### é—®é¢˜æè¿°ï¼š\n\n`01`èƒŒåŒ…é—®é¢˜æè¿°çš„æ˜¯ï¼šæœ‰`N`ä»¶ç‰©å“å’Œä¸€ä¸ªå®¹é‡ä¸º`V`çš„èƒŒåŒ…ã€‚æ¯ä»¶ç‰©å“**åªèƒ½ä½¿ç”¨ä¸€æ¬¡**ã€‚å…¶ä¸­ï¼Œç¬¬`i`ä»¶ç‰©å“çš„ä½“ç§¯æ˜¯`vi`ï¼Œä»·å€¼æ˜¯`wi`ï¼Œé—®ï¼šå°†å“ªäº›ç‰©å“è£…è¿›èƒŒåŒ…ï¼Œå¯ä½¿è¿™äº›ç‰©å“çš„ä½“ç§¯ä¸è¶…è¿‡èƒŒåŒ…å®¹é‡ï¼Œä¸”æ€»ä»·å€¼æœ€å¤§ã€‚\n<a name=\"WvGy2\"></a>\n\n##### é—®é¢˜åˆ†æï¼š\n\n![01èƒŒåŒ….png](https://cdn.acwing.com/media/article/image/2024/03/02/126318_b1d88ac9d8-01èƒŒåŒ….png)\n<a name=\"X3V7p\"></a>\n\n##### ä»£ç å®ç°ï¼š\n\n- æœ´ç´ ç‰ˆ\n\n```java\nimport java.io.*;\n\npublic class Main {\n    static final int N = 1010;\n    static int[] v = new int[N], w = new int[N];\n    static int[][] f = new int[N][N];\n    public static void main(String[] args) throws IOException {\n        BufferedReader br = new BufferedReader(new InputStreamReader(System.in));\n        String[] s = br.readLine().split(\" \");\n        int n = Integer.parseInt(s[0]);\n        int m = Integer.parseInt(s[1]);\n        for (int i = 1; i <= n; i ++) {\n            String[] s1 = br.readLine().split(\" \");\n            v[i] = Integer.parseInt(s1[0]);\n            w[i] = Integer.parseInt(s1[1]);\n        }\n        for (int i = 1; i <= n; i ++)\n            for (int j = 0; j <= m; j ++) {\n                f[i][j] = f[i - 1][j];\n                if (j >= v[i]) f[i][j] = Math.max(f[i][j], f[i - 1][j - v[i]] + w[i]);\n            }\n        System.out.println(f[n][m]);\n    }\n}\n```\n\n- ç©ºé—´ä¼˜åŒ–\n\n```java\nimport java.io.*;\n\npublic class Main {\n    static final int N = 1010;\n    static int[] v = new int[N], w = new int[N];\n    static int[] f = new int[N];\n    public static void main(String[] args) throws IOException {\n        BufferedReader br = new BufferedReader(new InputStreamReader(System.in));\n        String[] s = br.readLine().split(\" \");\n        int n = Integer.parseInt(s[0]);\n        int m = Integer.parseInt(s[1]);\n        for (int i = 1; i <= n; i ++) {\n            String[] s1 = br.readLine().split(\" \");\n            v[i] = Integer.parseInt(s1[0]);\n            w[i] = Integer.parseInt(s1[1]);\n        }\n        for (int i = 1; i <= n; i ++) {\n            for (int j = m; j >= v[i]; j --) {\n                f[j] = Math.max(f[j], f[j - v[i]] + w[i]);\n            }\n        }\n        System.out.println(f[m]);\n    }\n}\n```\n\nä¼˜åŒ–æˆä¸€ç»´çš„è¯´æ˜ï¼š[å¯¹äº01èƒŒåŒ…ä¸€ç»´ä¼˜åŒ–çš„ç†è§£](https://www.acwing.com/file_system/file/content/whole/index/content/4813/)\n<a name=\"nVgj8\"></a>\n\n#### 5.1.2 å®Œå…¨èƒŒåŒ…é—®é¢˜\n\n<a name=\"IayfS\"></a>\n\n##### é—®é¢˜æè¿°ï¼š\n\næœ‰`N`ç§ç‰©å“å’Œä¸€ä¸ªå®¹é‡ä¸º`V`çš„èƒŒåŒ…ï¼Œæ¯ç§ç‰©å“éƒ½æœ‰**æ— é™**ä»¶å¯ä»¥ä½¿ç”¨ã€‚å…¶ä¸­ï¼Œç¬¬`i`ä»¶ç‰©å“çš„ä½“ç§¯æ˜¯`vi`ï¼Œä»·å€¼æ˜¯`wi`ã€‚é—®ï¼šå°†å“ªäº›ç‰©å“è£…è¿›èƒŒåŒ…ï¼Œå¯ä½¿è¿™äº›ç‰©å“çš„ä½“ç§¯ä¸è¶…è¿‡èƒŒåŒ…å®¹é‡ï¼Œä¸”æ€»ä»·å€¼æœ€å¤§ã€‚\n<a name=\"jk44j\"></a>\n\n##### é—®é¢˜åˆ†æï¼š\n\n![å®Œå…¨èƒŒåŒ….png](https://cdn.acwing.com/media/article/image/2024/03/02/126318_c1528506d8-å®Œå…¨èƒŒåŒ….png) <br />**æ³¨ï¼š** ä¸Šå›¾ä¸­çš„`k`ä»`1`å¼€å§‹æšä¸¾ã€‚ä¹Ÿå¯ä»¥ä»`0`å¼€å§‹æšä¸¾ï¼Œåˆ™`f[i][j] = max(f[i][j], f[i - 1][j - k * v[i]] + k * w[i])`\n<a name=\"aI24l\"></a>\n\n##### ä»£ç å®ç°ï¼š\n\n- æœ´ç´ ç‰ˆ\n\n```java\nimport java.io.*;\n\npublic class Main {\n    public static final int N = 1010;\n    public static int[][] f = new int[N][N];\n    public static void main(String[] args) throws IOException {\n        BufferedReader br = new BufferedReader(new InputStreamReader(System.in));\n        String[] s1 = br.readLine().split(\" \");\n        int n = Integer.parseInt(s1[0]);\n        int m = Integer.parseInt(s1[1]);\n        int[] v = new int[N];\n        int[] w = new int[N];\n\n        for (int i = 1; i <= n; i ++) {\n            String[] s2 = br.readLine().split(\" \");\n            v[i] = Integer.parseInt(s2[0]);\n            w[i] = Integer.parseInt(s2[1]);\n        }\n\n        for (int i = 1; i <= n; i ++)\n            for (int j = 0; j <= m; j ++)\n                for (int k = 0; k * v[i] <= j; k ++)\n                    // ä¹‹æ‰€ä»¥æ²¡æœ‰å†™f[i][j] = f[i - 1][j]æ˜¯å› ä¸ºå®Œå…¨èƒŒåŒ…åœ¨äºç¬¬iä¸ªç‰©å“çš„ä¸ªæ•°ï¼Œkå±‚çš„f[i][j]å®é™…ä¸Šæ˜¯k-1å±‚ç®—å‡ºæ¥çš„f[i][j]ã€‚\n                    f[i][j] = Math.max(f[i][j], f[i - 1][j - k * v[i]] + k * w[i]);\n        System.out.println(f[n][m]);\n    }\n}\n```\n\n- ä¼˜åŒ–æ—¶é—´\n\n```java\nimport java.io.*;\n\npublic class Main {\n    static final int N = 1010;\n    static int[] v = new int[N], w = new int[N];\n    static int[][] f = new int[N][N];\n    public static void main(String[] args) throws IOException {\n        BufferedReader br = new BufferedReader(new InputStreamReader(System.in));\n        String[] s = br.readLine().split(\" \");\n        int n = Integer.parseInt(s[0]);\n        int m = Integer.parseInt(s[1]);\n        for (int i = 1; i <= n; i ++) {\n            String[] s1 = br.readLine().split(\" \");\n            v[i] = Integer.parseInt(s1[0]);\n            w[i] = Integer.parseInt(s1[1]);\n        }\n        for (int i = 1; i <= n; i ++)\n            for (int j = 0; j <= m; j ++) {\n                f[i][j] = f[i - 1][j];\n                // æ ¹æ®f[i][j]ä¸f[i][j - v[i]]çš„å…³ç³»æ¨å‡º\n                if (j >= v[i]) f[i][j] = Math.max(f[i][j], f[i][j - v[i]] + w[i]); \n            }\n        System.out.println(f[n][m]);\n    }\n}\n```\n\n- ä¼˜åŒ–æ—¶é—´+ç©ºé—´\n\n```java\nimport java.io.*;\n\npublic class Main {\n    static final int N = 1010;\n    static int[] v = new int[N], w = new int[N];\n    static int[] f = new int[N];\n    public static void main(String[] args) throws IOException {\n        BufferedReader br = new BufferedReader(new InputStreamReader(System.in));\n        String[] s = br.readLine().split(\" \");\n        int n = Integer.parseInt(s[0]);\n        int m = Integer.parseInt(s[1]);\n        for (int i = 1; i <= n; i ++) {\n            String[] s1 = br.readLine().split(\" \");\n            v[i] = Integer.parseInt(s1[0]);\n            w[i] = Integer.parseInt(s1[1]);\n        }\n        for (int i = 1; i <= n; i ++) \n            for (int j = v[i]; j <= m; j ++) \n                // å®Œå…¨èƒŒåŒ…ç»ˆæå†™æ³•ä¸01èƒŒåŒ…å¾ˆåƒï¼Œæ­¤å¤„æ˜¯ä»å°åˆ°å¤§éå†ä½“ç§¯\n                f[j] = Math.max(f[j], f[j - v[i]] + w[i]); \n        System.out.println(f[m]);\n    }\n}\n```\n\n<a name=\"ipHIk\"></a>\n\n#### 5.1.3 å¤šé‡èƒŒåŒ…é—®é¢˜\n\n<a name=\"eDfs7\"></a>\n\n##### é—®é¢˜æè¿°ï¼š\n\næœ‰`N`ç§ç‰©å“å’Œä¸€ä¸ªå®¹é‡ä¸º`V`çš„èƒŒåŒ…ã€‚ç¬¬`i`ä»¶ç‰©å“æœ€å¤šæœ‰`si`ä»¶ï¼Œæ¯ä»¶çš„ä½“ç§¯ä¸º`vi`ï¼Œä»·å€¼ä¸º`wi`ã€‚é—®ï¼šå°†å“ªäº›ç‰©å“è£…è¿›èƒŒåŒ…ï¼Œå¯ä½¿è¿™äº›ç‰©å“çš„ä½“ç§¯ä¸è¶…è¿‡èƒŒåŒ…å®¹é‡ï¼Œä¸”æ€»ä»·å€¼æœ€å¤§ã€‚\n<a name=\"Gc4DY\"></a>\n\n##### é—®é¢˜åˆ†æï¼š\n\nå¤šé‡èƒŒåŒ…é—®é¢˜çš„åˆ†æä¸å®Œå…¨èƒŒåŒ…é—®é¢˜å‡ ä¹ä¸€æ ·ï¼Œåªæ˜¯å¯¹`k`å¤šäº†ä¸€ä¸ªé™åˆ¶ï¼ˆ`k <= s[i]`ï¼‰ã€‚\n<a name=\"Cp7OI\"></a>\n\n##### ä»£ç å®ç°ï¼š\n\n- æœ´ç´ ç‰ˆ\n\n```java\nimport java.io.*;\n\npublic class Main {\n    static final int N = 110;\n    static int[] v = new int[N], w = new int[N], s = new int[N];\n    static int[][] f = new int[N][N];\n    public static void main(String[] args) throws IOException {\n        BufferedReader br = new BufferedReader(new InputStreamReader(System.in));\n        String[] s1 = br.readLine().split(\" \");\n        int n = Integer.parseInt(s1[0]);\n        int m = Integer.parseInt(s1[1]);\n        for (int i = 1; i <= n; i ++) {\n            String[] s2 = br.readLine().split(\" \");\n            v[i] = Integer.parseInt(s2[0]);\n            w[i] = Integer.parseInt(s2[1]);\n            s[i] = Integer.parseInt(s2[2]);\n        }\n        for (int i = 1; i <= n; i ++) \n            for (int j = 1; j <= m; j ++) \n                for (int k = 0; k <= s[i] && k * v[i] <= j; k ++) \n                    f[i][j] = Math.max(f[i][j], f[i - 1][j - k * v[i]] + k * w[i]); // ä»£ç å‡ ä¹ä¸å®Œå…¨èƒŒåŒ…å·®ä¸å¤š\n        System.out.println(f[n][m]);\n    }\n}\n```\n\n- äºŒè¿›åˆ¶ä¼˜åŒ–ç‰ˆ\n\n> å¤šé‡èƒŒåŒ…äºŒè¿›åˆ¶ä¼˜åŒ–ä¸»è¦æ˜¯å°†å¤šé‡èƒŒåŒ…é—®é¢˜è½¬æ¢ä¸º01èƒŒåŒ…é—®é¢˜ï¼šå°†æ¯ç§ç‰©å“åˆ†è§£ä¸ºè‹¥å¹²å †ï¼Œè¿™äº›å †çš„æ•°é‡æ€»æ˜¯èƒ½å¤Ÿå‡‘å‡ºè¿™ç§ç‰©å“åŸæ¥æ•°é‡çš„ä»»æ„ä¸€ç§å–æ³•ï¼ˆä¾‹å¦‚ä¸€ç§ç‰©å“æ€»å…±æœ‰8ä¸ªï¼Œåˆ™å°†å…¶åˆ†ä¸º1ã€2ã€4ã€1è¿™å‡ å †ï¼‰ï¼Œç„¶åå°†åˆ†å †åçš„æ¯ä¸€å †ç‰©å“éƒ½çœ‹ä½œæ˜¯ä¸€ä»¶æ–°ç‰©å“ï¼Œå†å¯¹è¿™ä¸ªäº›ç‰©å“åšä¸€é01èƒŒåŒ…å°±èƒ½æ±‚å‡ºæœ€ç»ˆçš„è§£ã€‚\n\n```java\nimport java.io.*;\n\npublic class Main {\n    static final int N = 25000;\n    static int[] v = new int[N], w = new int[N];\n    static int[] f = new int[N];\n    public static void main(String[] args) throws IOException {\n        BufferedReader br = new BufferedReader(new InputStreamReader(System.in));\n        String[] s1 = br.readLine().split(\" \");\n        int n = Integer.parseInt(s1[0]), m = Integer.parseInt(s1[1]);\n        int cnt = 0; // è¡¨ç¤ºæœ€ç»ˆç‰©å“çš„å †æ•°ï¼Œæ¯ä¸€å¯¹ç‰©å“åªæœ‰æ‹¿å’Œä¸æ‹¿ä¸¤ç§çŠ¶æ€\n        for (int i = 1; i <= n; i ++) {\n            String[] s2 = br.readLine().split(\" \");\n            int a = Integer.parseInt(s2[0]); // å½“å‰ç‰©å“çš„å•ä¸ªä½“ç§¯\n            int b = Integer.parseInt(s2[1]); // å½“å‰ç‰©å“çš„å•ä¸ªä»·å€¼\n            int s = Integer.parseInt(s2[2]); // å½“å‰ç‰©å“çš„æ€»æ•°é‡\n            int k = 1; // å°†å½“å‰ç‰©å“åˆ’åˆ†ä¸ºå¾ˆå¤šå †ï¼Œkè¡¨ç¤ºæ¯ä¸€å †çš„æ•°é‡\n            while (k <= s) { // äºŒè¿›åˆ¶ä¼˜åŒ–ï¼Œå°†å…¶è½¬ä¸º01èƒŒåŒ…é—®é¢˜\n                cnt ++; // æ¯åˆ’åˆ†å‡ºä¸€å †ï¼Œæ€»å †æ•°åŠ ä¸€\n                v[cnt] = k * a; // è®¡ç®—å‡ºè¿™ä¸€å †çš„æ€»ä½“ç§¯\n                w[cnt] = k * b; // è®¡ç®—å‡ºè¿™ä¸€å¯¹çš„æ€»ä»·å€¼\n                s -= k; // æ›´æ–°è¿™ç§ç‰©å“è¿˜å‰©çš„æ•°é‡\n                k *= 2; // æ›´æ–°k\n            }\n            if (s > 0) { // è‹¥ç‰©å“è¿˜æœ‰å‰©çš„ï¼Œä½†æ˜¯å·²ç»ä¸è¶³2^(k + 1)ä¸ªï¼Œå°±ç›´æ¥å°†å…¶çœ‹ä½œæ–°çš„ä¸€å †\n                cnt ++;\n                v[cnt] = a * s;\n                w[cnt] = b * s;\n            }\n        }\n        n = cnt; // æ›´æ–°æ€»ç‰©å“å †æ•°\n        // åšä¸€é 01 èƒŒåŒ…\n        for (int i = 1; i <= n; i ++)\n            for (int j = m; j >= v[i]; j --)\n                f[j] = Math.max(f[j], f[j - v[i]] + w[i]);\n        System.out.println(f[m]);\n    }\n}\n```\n\n<a name=\"pNrJk\"></a>\n\n#### 5.1.4 åˆ†ç»„èƒŒåŒ…é—®é¢˜ï¼š\n\n<a name=\"zTFFv\"></a>\n\n##### é—®é¢˜æè¿°ï¼š\n\næœ‰`N`ç»„ç‰©å“å’Œä¸€ä¸ªå®¹é‡æ˜¯`V`çš„èƒŒåŒ…ã€‚æ¯ç»„ç‰©å“æœ‰è‹¥å¹²ä¸ªï¼ŒåŒä¸€ç»„å†…çš„ç‰©å“**æœ€å¤šåªèƒ½é€‰ä¸€ä¸ª**ã€‚ä¸”æ¯ä»¶ç‰©å“çš„ä½“ç§¯æ˜¯ `v[i][j]`ï¼Œä»·å€¼æ˜¯ `w[i][j]`ï¼Œå…¶ä¸­`i`æ˜¯ç»„å·ï¼Œ`j`æ˜¯ç»„å†…ç¼–å·ã€‚é—®ï¼šå°†å“ªäº›ç‰©å“è£…å…¥èƒŒåŒ…ï¼Œå¯ä½¿ç‰©å“æ€»ä½“ç§¯ä¸è¶…è¿‡èƒŒåŒ…å®¹é‡ï¼Œä¸”æ€»ä»·å€¼æœ€å¤§ã€‚\n<a name=\"guQiS\"></a>\n\n##### é—®é¢˜åˆ†æï¼š\n\n![åˆ†ç»„èƒŒåŒ….png](https://cdn.acwing.com/media/article/image/2024/03/02/126318_df2a2e04d8-åˆ†ç»„èƒŒåŒ….png)\n<a name=\"jwkdC\"></a>\n\n##### ä»£ç å®ç°ï¼š\n\n- **æœ´ç´ ç‰ˆï¼š**\n\n```java\nimport java.util.*;\n\npublic class Main {\n    static final int N = 110;\n    static int[][] v = new int[N][N], w = new int[N][N];\n    static int[] s = new int[N];\n    static int[][] f = new int[N][N];\n    public static void main(String[] args) {\n        Scanner sc = new Scanner(System.in);\n        int n = sc.nextInt(), m = sc.nextInt();\n        for (int i = 1; i <= n; i ++) {\n            s[i] = sc.nextInt();\n            for (int j = 1; j <= s[i]; j ++) {\n                v[i][j] = sc.nextInt();\n                w[i][j] = sc.nextInt();\n            }\n        }\n        for (int i = 1; i <= n; i ++) \n            for (int j = 1; j <= m; j ++) \n                for (int k = 1; k <= s[i]; k ++) \n                    if(v[i][k] <= j)\n                        f[i][j] = Math.max(f[i][j], f[i - 1][j - v[i][k]] + w[i][k]);\n        System.out.print(f[n][m]);\n    }\n}\n```\n\n- **ä¸€ç»´ç‰ˆæœ¬ï¼š**\n\n```java\nimport java.io.*;\n\npublic class Main {\n    static final int N = 110;\n    static int[][] v = new int[N][N], w = new int[N][N];\n    static int[] s = new int[N], f = new int[N];\n    public static void main(String[] args) throws IOException {\n        BufferedReader br = new BufferedReader(new InputStreamReader(System.in));\n        String[] s1 = br.readLine().split(\" \");\n        int n = Integer.parseInt(s1[0]);\n        int m = Integer.parseInt(s1[1]);\n        // è¯»å…¥æ•°æ®\n        for (int i = 1; i <= n; i ++) {\n            s[i] = Integer.parseInt(br.readLine());\n            for (int j = 1; j <= s[i]; j ++) {\n                String[] s2 = br.readLine().split(\" \");\n                v[i][j] = Integer.parseInt(s2[0]);\n                w[i][j] = Integer.parseInt(s2[1]);\n            }\n        }\n        // æœ‰äº›è®¸ç±»ä¼¼äº01èƒŒåŒ…å¯¹äºæ¯ä¸ªç‰©å“é€‰æˆ–ä¸é€‰ï¼Œå€’ç€æšä¸¾j\n        for (int i = 1; i <= n; i ++)\n            for (int j = m; j >= 0; j --)\n                for (int k = 1; k <= s[i]; k ++)\n                    if (v[i][k] <= j)\n                        f[j] = Math.max(f[j], f[j - v[i][k]] + w[i][k]);\n        System.out.println(f[m]);\n    }\n}\n```\n\n<a name=\"q8rfI\"></a>\n\n### 5.2 çº¿æ€§dp\n\n<a name=\"U57un\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\nè¿™ä¸€ç±»`Dp`å…ˆæ€è€ƒéœ€è¦ç”¨å‡ ç»´æ¥è¡¨ç¤ºé›†åˆã€æ¯ä¸ªé›†åˆè¡¨ç¤ºçš„æ˜¯ä»€ä¹ˆã€ç„¶åå†æ€è€ƒéœ€è¦å°†æ¯ä¸ªé›†åˆåˆ†æˆå“ªå‡ ä¸ªéƒ¨åˆ†ï¼Œä¸”è¿™å‡ ä¸ªéƒ¨åˆ†å‡èƒ½å¤Ÿç”¨å·²çŸ¥é›†åˆæ¨å¯¼å‡ºæ¥ã€‚<br />çº¿æ€§`Dp`ä»¥**æœ€é•¿å…¬å…±å­åºåˆ—**è¿™é“é¢˜ä¸ºä¾‹ï¼Œè¿›è¡Œåˆ†æã€‚\n\n- **é—®é¢˜æè¿°ï¼š** ç»™å®šä¸¤ä¸ªé•¿åº¦åˆ†åˆ«ä¸º N å’Œ M çš„å­—ç¬¦ä¸² A å’Œ Bï¼Œæ±‚æ—¢æ˜¯ A çš„å­åºåˆ—åˆæ˜¯ B çš„å­åºåˆ—çš„å­—ç¬¦ä¸²é•¿åº¦æœ€é•¿æ˜¯å¤šå°‘ã€‚\n- **é—®é¢˜åˆ†æï¼š**\n    - é¦–å…ˆæ€è€ƒéœ€è¦ç”¨å‡ ç»´æ¥è¡¨ç¤ºé›†åˆï¼šæœ¬é¢˜æ˜¯ä¸¤ä¸ªå­—ç¬¦ä¸²ï¼Œä¸”é—®çš„æ˜¯è¿™ä¸¤ä¸ªå­—ç¬¦ä¸²ä¹‹é—´çš„å…³ç³»ï¼Œé‚£ä¹ˆæ ¹æ®ç»éªŒï¼Œå¯ä»¥ä½¿ç”¨äºŒç»´æ•°ç»„è¡¨ç¤ºé›†åˆï¼›\n    - æ¯ä¸ªé›†åˆåˆ†åˆ«è¡¨ç¤ºä»€ä¹ˆï¼š`f[i][j]`è¡¨ç¤ºæ‰€æœ‰åœ¨ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²çš„å‰`i`ä¸ªå­—æ¯ä¸­å‡ºç°ï¼Œä¸”åœ¨ç¬¬äºŒä¸ªå­—ç¬¦ä¸²çš„å‰`j`ä¸ªå­—æ¯ä¸­å‡ºç°çš„å­åºåˆ—ï¼›\n    - æ¯ä¸ªé›†åˆéœ€è¦åˆ†ä¸ºå“ªå‡ ä¸ªéƒ¨åˆ†ï¼šå¯ä»¥æŒ‰ç…§æ˜¯å¦åŒ…å«ç¬¬`i`ä¸ªå­—æ¯æˆ–æ˜¯å¦åŒ…å«ç¬¬`j`ä¸ªå­—æ¯åˆ†ä¸º`4`éƒ¨åˆ†ã€‚\n\n![æœ€é•¿å…¬å…±å­åºåˆ—.png](https://cdn.acwing.com/media/article/image/2024/03/02/126318_59623a75d8-æœ€é•¿å…¬å…±å­åºåˆ—.png)\n<a name=\"qVhdh\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\nimport java.util.*;\npublic class Main {\n    static final int N = 1010;\n    static int[][] f = new int[N][N];\n    public static void main(String[] args) {\n        Scanner sc = new Scanner(System.in);\n        int n = sc.nextInt(), m = sc.nextInt();\n        char[] a = (\" \" + sc.next()).toCharArray();\n        char[] b = (\" \" + sc.next()).toCharArray();\n        for (int i = 1; i <= n; i ++) \n            for (int j = 1; j <= m; j ++) {\n                f[i][j] = Math.max(f[i - 1][j], f[i][j - 1]);\n                if (a[i] == b[j]) \n                    f[i][j] = Math.max(f[i][j], f[i - 1][j - 1] + 1);\n            }\n        System.out.println(f[n][m]);\n    }\n}\n```\n\n<a name=\"P7uPa\"></a>\n\n### 5.3 åŒºé—´dp\n\n<a name=\"BIPvq\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\nåŒºé—´`Dp`çš„é¢˜ç›®é€šå¸¸çš„æšä¸¾é¡ºåºæ˜¯ï¼šå…ˆæšä¸¾åŒºé—´é•¿åº¦ï¼Œå†æšä¸¾å·¦ç«¯ç‚¹ã€å†æšä¸¾å†³ç­–ã€‚<br />ä¸‹é¢å°†ä»¥[çŸ³å­åˆå¹¶](https://www.acwing.com/problem/content/284/)è¿™é“é¢˜ä¸ºä¾‹è¿›è¡Œåˆ†æï¼š<br />\n#### é¢˜ç›®æè¿°ï¼š\n\nè®¾æœ‰ $N$ å †çŸ³å­æ’æˆä¸€æ’ï¼Œå…¶ç¼–å·ä¸º $1,2,3,â€¦,N$ã€‚<br />æ¯å †çŸ³å­æœ‰ä¸€å®šçš„è´¨é‡ï¼Œå¯ä»¥ç”¨ä¸€ä¸ªæ•´æ•°æ¥æè¿°ï¼Œç°åœ¨è¦å°†è¿™ $N$ å †çŸ³å­åˆå¹¶æˆä¸ºä¸€å †ã€‚<br />æ¯æ¬¡åªèƒ½åˆå¹¶ç›¸é‚»çš„ä¸¤å †ï¼Œåˆå¹¶çš„ä»£ä»·ä¸ºè¿™ä¸¤å †çŸ³å­çš„è´¨é‡ä¹‹å’Œï¼Œåˆå¹¶åä¸è¿™ä¸¤å †çŸ³å­ç›¸é‚»çš„çŸ³å­å°†å’Œæ–°å †ç›¸é‚»ï¼Œåˆå¹¶æ—¶ç”±äºé€‰æ‹©çš„é¡ºåºä¸åŒï¼Œåˆå¹¶çš„æ€»ä»£ä»·ä¹Ÿä¸ç›¸åŒã€‚<br />ä¾‹å¦‚æœ‰ $4$ å †çŸ³å­åˆ†åˆ«ä¸º `1 3 5 2`ï¼Œ æˆ‘ä»¬å¯ä»¥å…ˆåˆå¹¶ $1ã€2$ å †ï¼Œä»£ä»·ä¸º $4$ï¼Œå¾—åˆ° `4 5 2`ï¼Œ åˆåˆå¹¶ $1ã€2$ å †ï¼Œä»£ä»·ä¸º $9$ï¼Œå¾—åˆ° `9 2` ï¼Œå†åˆå¹¶å¾—åˆ° $11$ï¼Œæ€»ä»£ä»·ä¸º $4+9+11=24$ï¼›<br />å¦‚æœç¬¬äºŒæ­¥æ˜¯å…ˆåˆå¹¶ $2ã€3$ å †ï¼Œåˆ™ä»£ä»·ä¸º $7$ï¼Œå¾—åˆ° `4 7`ï¼Œæœ€åä¸€æ¬¡åˆå¹¶ä»£ä»·ä¸º $11$ï¼Œæ€»ä»£ä»·ä¸º $4+7+11=22$ã€‚<br />é—®é¢˜æ˜¯ï¼šæ‰¾å‡ºä¸€ç§åˆç†çš„æ–¹æ³•ï¼Œä½¿æ€»çš„ä»£ä»·æœ€å°ï¼Œè¾“å‡ºæœ€å°ä»£ä»·ã€‚\n\n#### é—®é¢˜åˆ†æï¼š\n\n![åˆå¹¶çŸ³å­åˆ†æ.png](https://cdn.acwing.com/media/article/image/2024/03/02/126318_76a65135d8-åˆå¹¶çŸ³å­åˆ†æ.png)\n<a name=\"LMDk7\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\nimport java.io.*;\n\npublic class Main {\n    static final int N = 310, INF = 0x3f3f3f3f;\n    static int[] s = new int[N];\n    static int[][] f = new int[N][N];\n    public static void main(String[] args) throws IOException {\n        BufferedReader br = new BufferedReader(new InputStreamReader(System.in));\n        int n = Integer.parseInt(br.readLine());\n        String[] s1 = br.readLine().split(\" \");\n        for (int i = 1; i <= n; i ++) s[i] = Integer.parseInt(s1[i - 1]);\n        for (int i = 1; i <= n; i ++) s[i] += s[i - 1]; // é¢„å¤„ç†å‰ç¼€å’Œ\n\n        for (int len = 2; len <= n; len ++) { // æŒ‰ç…§åŒºé—´é•¿åº¦ä»å°åˆ°å¤§æšä¸¾\n            for (int i = 1; i + len - 1 <= n; i ++) { // iå®é™…ä¸Šå°±æ˜¯å·¦ç«¯ç‚¹\n                int l = i, r = i + len - 1; // å®šä¹‰å·¦å³ç«¯ç‚¹\n                f[l][r] = INF; // åˆå§‹åŒ–f[l][r]ï¼Œå¦åˆ™å…¨æ˜¯0ï¼Œæœ€å°ä»£ä»·ä¼šè¢«é”™è¯¯åœ°æ›´æ–°\n                for (int k = l; k < r; k ++) { // ä»å·¦ç«¯ç‚¹å¼€å§‹ï¼Œéå†æ¯ä¸ªåˆ†ç•Œç‚¹\n                    // f[l][r]æœ€ç»ˆæ˜¯ç”±ä¸¤ä¸ªå¤§åŒºé—´åˆå¹¶ï¼Œf[l][r]ç­‰äºè¿™ä¸¤ä¸ªå¤§åŒºé—´è‡ªèº«åˆå¹¶æ‰€éœ€ä»£ä»·åŠ åˆå¹¶è¿™ä¸¤ä¸ªåŒºé—´çš„ä»£ä»·\n                    f[l][r] = Math.min(f[l][r], f[l][k] + f[k + 1][r] + s[r] - s[l - 1]);\n                }\n            }\n        }\n        System.out.print(f[1][n]); // è¾“å‡ºåˆå¹¶1~nè¿™ä¸ªåŒºé—´çš„æœ€å°ä»£ä»·\n    }\n}\n```\n\n**åŒºé—´`dp`æ€»ç»“ï¼š**\n\n1. æšä¸¾åŒºé—´é•¿åº¦`len`ï¼Œ`len`é€šå¸¸ä¸º`2 ~ n`;\n2. æšä¸¾åŒºé—´å·¦ç«¯ç‚¹ï¼ˆä¸€èˆ¬`i` ä»ç¬¬ä¸€ä¸ªå…ƒç´ å¼€å§‹ï¼Œå³ç«¯ç‚¹`i + len - 1`ä¸èƒ½è¶Šç•Œï¼‰ï¼›\n3. è¿›è¡Œå†³ç­–ï¼š\n\n- è‹¥æœ‰åŒºé—´åˆ†ç•Œç‚¹ï¼Œåˆ™æšä¸¾åˆ†ç•Œç‚¹ï¼ˆä¸€èˆ¬å·¦ç«¯ç‚¹ä½ç½®ä¸ºç¬¬ä¸€ä¸ªåˆ†ç•Œç‚¹ï¼Œå³ç«¯ç‚¹ä¸Šä¸€ä¸ªä½ç½®ä¸ºæœ€åä¸€ä¸ªåˆ†ç•Œç‚¹ï¼‰\n- è‹¥ä¸éœ€è¦åˆ†ç•Œç‚¹ï¼Œåˆ™ç›´æ¥è¿›è¡Œå†³ç­–\n  <a name=\"iKwRF\"></a>\n\n### 5.4 è®¡æ•°ç±»dp\n\n<a name=\"qpN02\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\nè®¡æ•°ç±»`Dp`å®é™…ä¸Šå°±æ˜¯è®¡æ•°ç±»å®Œå…¨èƒŒåŒ…é—®é¢˜ï¼Œåªæ˜¯åœ¨é›†åˆè¡¨ç¤ºå’Œé›†åˆå±æ€§ä¸Šç•¥æœ‰ä¸åŒã€‚è®¡æ•°ç±»`Dp`ä¸­ï¼Œ`f[i][j]`çš„æ¯ä¸€éƒ¨åˆ†ä»£è¡¨çš„å°±æ˜¯è¯¥éƒ¨åˆ†çš„æ•°é‡ï¼Œä¸éœ€è¦åŠ ä¸Šä»·å€¼ï¼Œè€Œå®Œå…¨èƒŒåŒ…åˆ™éœ€è¦åŠ ä¸Šå…¶ä»·å€¼ã€‚\n<a name=\"f4FaA\"></a>\n\n#### é—®é¢˜åˆ†æï¼š\n\n> ç¬”è¯¯ï¼šé›†åˆè¡¨ç¤ºåªä»å‰`i`ä¸ªæ•°ä¸­é€‰ï¼Œä¸”æ€»ä½“ç§¯æ°å¥½æ˜¯`j`çš„é€‰æ³•<br />\n\n![è®¡æ•°ç±»Dp.png](https://cdn.acwing.com/media/article/image/2024/03/02/126318_858eefcdd8-è®¡æ•°ç±»Dp.png)\n<a name=\"t8sQG\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n- ä¼˜åŒ–æ—¶é—´\n\n```java\nimport java.util.Scanner;\n\npublic class Main {\n    static final int N = 1010, MOD = (int)(1e9 + 7);\n    static int[][] f = new int[N][N];\n    public static void main(String[] args) {\n        Scanner sc = new Scanner(System.in);\n        int n = sc.nextInt();\n        f[0][0] = 1;\n        for (int i = 1; i <= n; i ++) {\n            for (int j = 0; j <= n; j ++) {\n                // jéœ€è¦ä»0å¼€å§‹éå†ï¼Œå½“ j >= i æ—¶ï¼Œæ‰æœ‰f[i] [j] = (f[i - 1] [j] + f[i] [j - i])è¿™ä¸€æ­¥çš„è½¬ç§»ï¼ŒåŒå®Œå…¨èƒŒåŒ…æœ´ç´ ç‰ˆã€‚å¦‚æœä¸Šé¢åˆå§‹åŒ–æ—¶ï¼Œå°†f[1~n][0]éƒ½åˆå§‹åŒ–æˆ1ï¼Œé‚£ä¹ˆè¿™é‡Œçš„jå¯ä»¥ä»1å¼€å§‹\n                f[i][j] = f[i - 1][j] % MOD;\n                if (j >= i) f[i][j] = (f[i - 1][j] + f[i][j - i]) % MOD;\n            }\n        }\n        System.out.print(f[n][n]);\n    }\n}\n```\n\n- ä¼˜åŒ–æ—¶é—´+ç©ºé—´\n\n```java\nimport java.util.Scanner;\n\npublic class Main {\n    static final int N = 1010, MOD = (int)(1e9 + 7);\n    static int[] f = new int[N];\n    public static void main(String[] args) {\n        Scanner sc = new Scanner(System.in);\n        int n = sc.nextInt();\n        f[0] = 1;\n        for (int i = 1; i <= n; i ++) \n            for (int j = i; j <= n; j ++) \n                f[j] = (f[j] + f[j - i]) % MOD;\n        System.out.print(f[n]);\n    } \n}\n```\n\n<a name=\"UdzpI\"></a>\n\n### 5.5 çŠ¶æ€å‹ç¼©dp\n\n<a name=\"hY4p6\"></a>\n\n#### ç®—æ³•æ€æƒ³ï¼š\n\nçŠ¶æ€å‹ç¼©dpçš„æ€æƒ³å°±æ˜¯ç”¨ä¸€ä¸ªæ•°çš„äºŒè¿›åˆ¶è¡¨ç°å½¢å¼è¡¨ç¤ºäºŒç»´çŠ¶æ€ä¸­æŸä¸€ç»´çš„çŠ¶æ€ã€‚<br />**ä»¥è’™å¾·é‡Œå®‰çš„æ¢¦æƒ³è¿™é“é¢˜ä¸ºä¾‹ï¼š**\n\n> [è’™å¾·é‡Œå®‰çš„æ¢¦æƒ³](https://www.acwing.com/problem/content/description/293/)ï¼šæ±‚æŠŠ$N \\times M$çš„æ£‹ç›˜åˆ†å‰²æˆè‹¥å¹²ä¸ª$1 \\times 2$çš„é•¿æ–¹å½¢ï¼Œæœ‰å¤šå°‘ç§æ–¹æ¡ˆã€‚\n> ä¾‹å¦‚$2 \\times 4$çš„æ£‹ç›˜çš„æ–¹æ¡ˆæœ‰ï¼š![5.5çŠ¶æ€å‹ç¼©dp.png](https://cdn.acwing.com/media/article/image/2024/03/02/126318_d419c420d8-5.5çŠ¶æ€å‹ç¼©dp.png)\n\né¢˜ç›®ä¸­è¦æ±‚ä½¿ç”¨`1 Ã— 2`çš„å°æ–¹æ ¼æŠŠæ£‹ç›˜å¡«æ»¡ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ¨ªç€å¡«ï¼Œä¹Ÿå¯ä»¥ç«–ç€å¡«ã€‚å½“æˆ‘ä»¬æŠŠæ¨ªç€å¡«çš„é•¿æ–¹å½¢å¡«å®Œï¼Œé‚£ä¹ˆç«–ç€å¡«çš„å°æ–¹æ ¼çš„æ–¹æ¡ˆå°±æ˜¯å”¯ä¸€çš„ã€‚å› æ­¤æˆ‘ä»¬åªéœ€è¦è€ƒè™‘æ¨ªç€å¡«çš„é•¿æ–¹å½¢æœ‰å¤šå°‘ç§å¡«æ³•ã€‚<br />æˆ‘ä»¬åˆ†ææ¯ä¸€åˆ—ï¼Œç”¨ä¸€ä¸ªäºŒè¿›åˆ¶æ•°è¡¨ç¤ºè¯¥åˆ—é•¿æ–¹å½¢çš„æ‘†æ”¾çŠ¶æ€ã€‚å¦‚æœè¯¥åˆ—çš„æŸä¸€è¡Œæ˜¯`0`ï¼Œåˆ™è¡¨ç¤ºè¯¥åˆ—çš„è¿™è¡Œæ²¡æœ‰æ‘†æ”¾é•¿æ–¹å½¢ï¼Œ`1`åˆ™æ˜¯æ‘†æ”¾äº†é•¿æ–¹å½¢ã€‚ä¾‹å¦‚ä¸Šé¢ä¾‹å›¾ä¸­çš„`2 Ã— 4`æ£‹ç›˜ï¼Œç¬¬äºŒä¸ªæ‘†æ”¾æ–¹æ¡ˆå¯¹åº”çš„çŠ¶æ€è¡¨ç¤ºä¸º$\\begin{bmatrix}\n1 & 1 & 0 & 0 \\\\\n1 & 1 & 0 & 0\n\\end{bmatrix}$ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç”¨`3`è¡¨ç¤ºç¬¬ä¸€åˆ—å’Œç¬¬äºŒåˆ—çš„çŠ¶æ€ï¼Œç”¨`0`è¡¨ç¤ºç¬¬ä¸‰åˆ—å’Œç¬¬å››åˆ—çš„çŠ¶æ€ã€‚<br />**å¦‚ä½•åˆ¤æ–­æ¯ä¸€åˆ—çš„çŠ¶æ€æ˜¯ä¸æ˜¯ä¸€ä¸ªåˆæ³•çš„çŠ¶æ€ï¼Ÿ**<br />æˆ‘ä»¬è¦çŸ¥é“ï¼Œä¸æ˜¯æ¯ä¸€ä¸ªæ•°éƒ½èƒ½è¡¨ç¤ºä¸€ä¸ªåˆ—çš„çŠ¶æ€çš„ï¼Œå› ä¸ºè¿™æ˜¯å®é™…é—®é¢˜ã€‚ä¾‹å¦‚ï¼Œ`11`çš„äºŒè¿›åˆ¶è¡¨ç¤º`1011`å°±ä¸æ˜¯ä¸€ä¸ªåˆæ³•çš„çŠ¶æ€ï¼Œå› ä¸ºå¦‚æœå½“å‰åˆ—è¿™æ ·æ‘†æ”¾ï¼Œé‚£ä¹ˆç«–ç€çš„é•¿æ–¹å½¢å°±æ— æ³•æ‘†æ”¾ã€‚<br />å› æ­¤ï¼Œåªè¦ä¸€ä¸ªæ•°çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸­å‡ºç°äº†è¿ç»­çš„å¥‡æ•°ä¸ª`0`æ—¶ï¼Œåˆ™è¯¥æ•°å°±ä¸æ˜¯ä¸€ä¸ªåˆæ³•çš„çŠ¶æ€ã€‚<br />**å¦‚ä½•è¿›è¡ŒçŠ¶æ€è½¬ç§»ï¼Ÿ**<br />é¦–å…ˆæˆ‘ä»¬å®šä¹‰çŠ¶æ€æ•°ç»„$f[i][j]$è¡¨ç¤ºå‰$i$åˆ—æ‘†æ”¾å®Œæˆçš„æ‰€æœ‰æ–¹æ¡ˆæ•°ã€‚<br />$f[i][j]$è¡¨ç¤ºæ‰€æœ‰èƒ½ä»ä¸Šä¸€ä¸ªåˆ—çš„çŠ¶æ€è½¬ç§»è¿‡æ¥çš„æ–¹æ¡ˆæ•°ä¹‹å’Œã€‚\n\n> å‡è®¾ç¬¬$i - 1$åˆ—è¢«æˆ³çš„çŠ¶æ€ä¸º$k$ï¼Œç¬¬$i$åˆ—è¢«æˆ³çŠ¶æ€ä¸º$j$ã€‚ï¼ˆåªè€ƒè™‘äºŒè¿›åˆ¶è¡¨ç¤ºä¸­çš„$1$å…¨éƒ¨ç”±ä¸Šä¸€åˆ—æˆ³å‡ºçš„æƒ…å†µï¼‰ï¼Œ**é‚£ä¹ˆè¿™æ ·ç¬¬**$i - 1$**åˆ—è¢«æˆ³å’Œæˆ³å‡ºçš„æƒ…å†µçš„è€ƒè™‘å®Œäº†ï¼ˆå³ç¬¬**$i - 1$**åˆ—çš„çŠ¶æ€ä¸º**$j \\mid k$**ï¼‰**ã€‚\n\n**èƒ½å¤Ÿä»ç¬¬**$i - 1$**åˆ—æˆ³åˆ°ç¬¬**$i$**åˆ—çš„æ¡ä»¶ï¼ˆèƒ½è½¬ç§»çš„æ¡ä»¶ï¼Œå®é™…å°±æ˜¯åœ¨åˆ¤æ–­ç¬¬**$i- 1$**åˆ—çš„çŠ¶æ€å’Œè½¬ç§»æ–¹å¼æ˜¯å¦åˆæ³•ï¼‰ï¼š**\n\n- ç¬¬$i - 1$ä¸ç¬¬$i$åˆ—ä¸èƒ½åŒæ—¶è¢«æˆ³ï¼ˆ`j & k = 0`ï¼‰\n- åœ¨ç¡®å®šç¬¬$i- 1$åˆ—è¢«æˆ³æˆ–å‘åæˆ³å‡ºåæ‰€å‰©ä¸‹çš„ä½ç½®è¦èƒ½å¤Ÿæ‘†æ”¾ç«–ç€çš„é•¿æ–¹å½¢ï¼ˆçŠ¶æ€çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸èƒ½æœ‰è¿ç»­å¥‡æ•°ä¸ª`0`ï¼šå³`j | k`çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸èƒ½æœ‰è¿ç»­å¥‡æ•°ä¸ª`0`ï¼‰\n\n**çŠ¶æ€è½¬ç§»æ–¹ç¨‹ï¼š**\n\n```java\nif (æ»¡è¶³èƒ½å¤Ÿä»ç¬¬i - 1åˆ—æˆ³åˆ°ç¬¬iåˆ—çš„æ¡ä»¶)\n    f[i][j] += f[i - 1][k];\n```\n\n**åˆå§‹åŒ–ä¸ç­”æ¡ˆï¼š**<br />æ ¹æ®$f[i][j]$çš„å«ä¹‰ï¼Œç¬¬$0$åˆ—æ˜¯ä¸ä¼šè¢«æˆ³çš„ï¼Œå› æ­¤å…¶ä¸Šä¸€åˆ—ï¼ˆè™šæ‹Ÿï¼‰å…¨æ˜¯ç«–ç€æ‘†æ”¾æ–¹å—çš„ï¼ˆåªæœ‰è¿™ä¸€ç§æ–¹æ¡ˆï¼‰ï¼Œæ‰€ä»¥$f[0][0] = 1$ã€‚<br />å½“æˆ‘ä»¬å°†å…¨éƒ¨çš„$m$åˆ—ï¼ˆ$0 \\sim m - 1$ï¼‰æ‘†å¥½æ—¶ï¼Œç¬¬$m$åˆ—ï¼ˆä¸éœ€è¦æ‘†æ”¾æ–¹å—çš„åˆ—ï¼‰æ²¡æœ‰è¢«æˆ³çš„æ‰€æœ‰æ–¹æ¡ˆæ•°ä¹‹å’Œå³ä¸ºç­”æ¡ˆï¼Œå³$f[m][0]$ã€‚\n<a name=\"c9j85\"></a>\n\n#### ä»£ç å®ç°ï¼š\n\n```java\nimport java.util.*;\n\npublic class Main {\n    static final int N = 12, M = 1 << 12;\n    static long[][] f = new long[N][M];\n    static boolean[] st = new boolean[M];\n    public static void main(String[] args) {\n        Scanner sc = new Scanner(System.in);\n        while (true) {\n            int n = sc.nextInt(), m = sc.nextInt();\n            if (n == 0 && m == 0) break;\n            // é¢„å¤„ç†æ¯ä¸ªçŠ¶æ€çš„åˆæ³•æ€§\n            Arrays.fill(st, true);\n            for (int i = 0; i < 1 << n; i ++) {\n                int cnt = 0;\n                for (int j = 0; j < n; j ++)\n                    if (((i >> j) & 1) == 1) {\n                        if ((cnt & 1) > 0) {\n                            st[i] = false;\n                            break;\n                        }\n                    }\n                    else cnt ++;\n                if ((cnt & 1) > 0) st[i] = false;\n            }\n            for (int i = 0; i < N; i ++) Arrays.fill(f[i], 0);\n            f[0][0] = 1;\n            // çŠ¶æ€è½¬ç§»\n            for (int i = 1; i <= m; i ++)\n                for (int j = 0; j < 1 << n; j ++)\n                    for (int k = 0; k < 1 << n; k ++)\n                        if ((j & k) == 0 && st[j | k])\n                            f[i][j] += f[i - 1][k];\n            System.out.println(f[m][0]);\n        }\n    }\n}\n```\n\n<a name=\"DZPyh\"></a>\n\n## ç¬¬å…­ç« ï¼šç”±ä¸åŒæ•°æ®èŒƒå›´åæ¨æ—¶é—´å¤æ‚åº¦å’Œç®—æ³•å†…å®¹\n\n1. $n \\leq 30 \\Rightarrow$æŒ‡æ•°çº§åˆ«ï¼š`dfs + å‰ªæ`ã€`çŠ¶æ€å‹ç¼©dp`\n2. $n \\leq 100 \\Rightarrow \\mathcal{O}(n^3)$ï¼š`floyd`ã€`dp`ã€`é«˜æ–¯æ¶ˆå…ƒ`\n3. $n \\leq 1000 \\Rightarrow \\mathcal{O}(n^2) æˆ– \\mathcal{O}(n^2 \\log n)$ï¼š`dp`ã€`äºŒåˆ†`ã€`æœ´ç´ Dijkstra`ã€`æœ´ç´ ç‰ˆPrim`ã€`Bellman-Ford`\n4. $n \\leq 10000 \\Rightarrow \\mathcal{O}(n \\times \\sqrt{n})$ï¼š`å—çŠ¶é“¾è¡¨`ã€`åˆ†å—`ã€`è«é˜Ÿ`\n5. $n \\leq 10^5 \\Rightarrow \\mathcal{O}(n \\log n)$ï¼š`å„ç§sort`ã€`çº¿æ®µæ ‘`ã€`æ ‘çŠ¶æ•°ç»„`ã€`set/map`ã€`heap`ã€`æ‹“æ‰‘æ’åº`ã€`dijkstra + heap`ã€`prim + heap`ã€`Kruskal`ã€`spfa`ã€`æ±‚å‡¸åŒ…`ã€`æ±‚åŠå¹³é¢äº¤`ã€`äºŒåˆ†`ã€`CDQåˆ†æ²»`ã€`æ•´ä½“äºŒåˆ†`ã€`åç¼€æ•°ç»„`ã€`æ ‘é“¾å‰–åˆ†`ã€`åŠ¨æ€æ ‘`\n6. $n \\leq 10^6 \\Rightarrow \\mathcal{O}(n)æˆ–å¸¸æ•°è¾ƒå°çš„\\mathcal{O}(n \\log n)$ï¼š`å•è°ƒé˜Ÿåˆ—`ã€`hash`ã€`åŒæŒ‡é’ˆ`ã€`å¹¶æŸ¥é›†`ï¼Œ`kmp`ã€`ACè‡ªåŠ¨æœº`ã€`sort`ã€`æ ‘çŠ¶æ•°ç»„`ã€`heap`ã€`dijkstra`ã€`spfa`\n7. $n \\leq 10^7 \\Rightarrow \\mathcal{O}(n)$ï¼š`åŒæŒ‡é’ˆ`ã€`kmp`ã€`ACè‡ªåŠ¨æœº`ã€`çº¿æ€§ç­›è´¨æ•°`\n8. $n \\leq 10^9 \\Rightarrow \\mathcal{O}(\\sqrt{n})$ï¼š`è¯•é™¤æ³•åˆ¤æ–­è´¨æ•°`\n9. $n \\leq 10^{18} \\Rightarrow \\mathcal{O}(\\log n)$ï¼š`æœ€å¤§å…¬çº¦æ•°`ï¼Œ`å¿«é€Ÿå¹‚`ï¼Œ`æ•°ä½dp`\n10. $n \\leq 10^{1000} \\Rightarrow \\mathcal{O}((\\log n)^2)(\\log n è¡¨ç¤ºä½æ•°)$ï¼š`é«˜ç²¾åº¦åŠ å‡ä¹˜é™¤`\n11. $n \\leq 10^{100000} \\Rightarrow \\mathcal{O}(\\log k \\times \\log\\log k)(kè¡¨ç¤ºä½æ•°)$ï¼š`é«˜ç²¾åº¦åŠ å‡`ã€`FFT/NTT`","categories":["ç®—æ³•"]}]