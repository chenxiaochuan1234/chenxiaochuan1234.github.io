<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/favicon-16x16.png?v=2.8.0" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon-32x32.png?v=2.8.0" type="image/png" sizes="32x32"><meta name="description" content="King of Bots是一款AI蛇蛇对战游戏平台，与传统单人贪吃蛇不同的是，本贪吃蛇为双人对战，每回合玩家同时做出决策（人工或者Bot）控制自己的蛇，先撞到障碍物或者对方蛇的身体者输。游戏网址：https:&#x2F;&#x2F;app5163.acapp.acwing.com.cn&#x2F;">
<meta property="og:type" content="article">
<meta property="og:title" content="King of Bots项目总结">
<meta property="og:url" content="http://smallboatc.github.io/2024/02/27/King%20of%20Bots%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93/index.html">
<meta property="og:site_name" content="SmallBoat&#39; Blog">
<meta property="og:description" content="King of Bots是一款AI蛇蛇对战游戏平台，与传统单人贪吃蛇不同的是，本贪吃蛇为双人对战，每回合玩家同时做出决策（人工或者Bot）控制自己的蛇，先撞到障碍物或者对方蛇的身体者输。游戏网址：https:&#x2F;&#x2F;app5163.acapp.acwing.com.cn&#x2F;">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.acwing.com/media/article/image/2024/03/03/126318_235f9eadd9-1.%E9%A1%B9%E7%9B%AE%E8%A7%84%E5%88%92.png">
<meta property="og:image" content="https://cdn.acwing.com/media/article/image/2024/03/03/126318_1d7f8b70d9-1.2.%E9%A1%B9%E7%9B%AE%E9%80%BB%E8%BE%91%E8%AE%BE%E8%AE%A1.png">
<meta property="og:image" content="https://cdn.acwing.com/media/article/image/2024/03/03/126318_2aa880d4d9-3.1%E5%88%9B%E5%BB%BA%E5%AF%BC%E8%88%AA%E6%A0%8F.png">
<meta property="og:image" content="https://cdn.acwing.com/media/article/image/2024/03/03/126318_301badf5d9-3.2%E5%88%9B%E5%BB%BA%E6%B8%B8%E6%88%8F%E5%9C%B0%E5%9B%BE.png">
<meta property="og:image" content="https://cdn.acwing.com/media/article/image/2024/03/03/126318_35da8150d9-3.3%E5%88%9B%E5%BB%BA%E8%9B%87%E7%B1%BB.png">
<meta property="og:image" content="https://cdn.acwing.com/media/article/image/2024/03/03/126318_3991b228d9-4.3%E5%89%8D%E7%AB%AF%E6%B3%A8%E5%86%8C%E9%A1%B5%E9%9D%A2%E5%AE%9E%E7%8E%B0.png">
<meta property="og:image" content="https://cdn.acwing.com/media/article/image/2024/03/03/126318_3e2a0c6bd9-5.2.1%E6%88%91%E7%9A%84bot%E9%A1%B5%E9%9D%A2.png">
<meta property="og:image" content="https://cdn.acwing.com/media/article/image/2024/03/03/126318_43f08b5cd9-5.2.2%E5%88%9B%E5%BB%BAbot%E7%9A%84modal%E6%A1%86.png">
<meta property="og:image" content="https://cdn.acwing.com/media/article/image/2024/03/03/126318_4684fd31d9-5.2.3%E4%BF%AE%E6%94%B9bot%E7%9A%84modal%E6%A1%86.png">
<meta property="og:image" content="https://cdn.acwing.com/media/article/image/2024/03/03/126318_528bdb66d9-6.2.2%E7%8E%A9%E5%AE%B61.png">
<meta property="og:image" content="https://cdn.acwing.com/media/article/image/2024/03/03/126318_57338a40d9-6.2.2%E7%8E%A9%E5%AE%B62.png">
<meta property="og:image" content="https://cdn.acwing.com/media/article/image/2024/03/03/126318_4dac59a0d9-6.2.2%E5%8C%B9%E9%85%8D%E6%88%90%E5%8A%9F.png">
<meta property="og:image" content="https://cdn.acwing.com/media/article/image/2024/03/03/126318_5ad67da0d9-6.2.3%E5%8C%B9%E9%85%8D%E6%88%90%E5%8A%9F%E5%90%8E1.png">
<meta property="og:image" content="https://cdn.acwing.com/media/article/image/2024/03/03/126318_5d39caf8d9-6.2.3%E5%8C%B9%E9%85%8D%E6%88%90%E5%8A%9F%E5%90%8E2.png">
<meta property="og:image" content="https://cdn.acwing.com/media/article/image/2024/03/03/126318_5ef9b2e6d9-8.%E5%AF%B9%E5%B1%80%E5%88%97%E8%A1%A8.png">
<meta property="og:image" content="https://cdn.acwing.com/media/article/image/2024/03/03/126318_61f70baed9-8.%E6%8E%92%E8%A1%8C%E6%A6%9C.png">
<meta property="og:image" content="https://cdn.acwing.com/media/article/image/2024/03/03/126318_6f230017d9-9.%E5%AE%98%E6%96%B9%E6%8E%88%E6%9D%83%E6%B5%81%E7%A8%8B%E5%9B%BE.png">
<meta property="og:image" content="https://cdn.acwing.com/media/article/image/2024/03/03/126318_65986370d9-9.2%E5%88%9B%E5%BB%BA%E5%BA%94%E7%94%A8.png">
<meta property="og:image" content="https://cdn.acwing.com/media/article/image/2024/03/03/126318_6a4f7e5bd9-9.2%E5%A1%AB%E5%86%99%E5%BA%94%E7%94%A8%E8%B5%84%E6%96%99.png">
<meta property="og:image" content="https://cdn.acwing.com/media/article/image/2024/03/03/126318_67678959d9-9.2%E5%AE%A1%E6%A0%B8%E9%80%9A%E8%BF%87.png">
<meta property="article:published_time" content="2024-02-26T16:46:00.000Z">
<meta property="article:modified_time" content="2024-03-03T10:50:37.239Z">
<meta property="article:author" content="SmallBoat">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.acwing.com/media/article/image/2024/03/03/126318_235f9eadd9-1.%E9%A1%B9%E7%9B%AE%E8%A7%84%E5%88%92.png"><title>King of Bots项目总结 | SmallBoat' Blog</title><link ref="canonical" href="http://smallboatc.github.io/2024/02/27/King%20of%20Bots%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.8.0"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"carbon","highlight":"light","wordWrap":true},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: true,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: {"switchPost":true},
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 7.1.1"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">搜索</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">SmallBoat's Blog</div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">King of Bots项目总结</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2024-02-27</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2024-03-03</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">7.8k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">69分</span></span><span class="post-meta-item post-meta-item--visitors"><span class="post-meta-item__icon"><i class="fas fa-eye"></i></span><span class="post-meta-item__info">阅读次数</span><span class="post-meta-item__value" id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body"><p><a name="xvTck"></a></p>

        <h2 id="1-项目规划"   >
          <a href="#1-项目规划" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#1-项目规划"></a> 1. 项目规划</h2>
      
<ul>
<li>使用其后端分离方式完成本项目。其中，前端使用<code>Vue3</code>完成，后端使用<code>SpringBoot2</code>完成。</li>
</ul>
<p>
        <img   class="lazyload lazyload-block"
          src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://cdn.acwing.com/media/article/image/2024/03/03/126318_235f9eadd9-1.%E9%A1%B9%E7%9B%AE%E8%A7%84%E5%88%92.png"  alt="" />
      </p>
<ul>
<li>
<p>技术栈：<br />
| <strong>技术</strong> | <strong>说明</strong> |<br />
| — | — |<br />
| SpringBoot | 容器+MVC框架 |<br />
| mysql | 关系型数据库 |<br />
| JWT | 登录支持 |<br />
| SpringSecurity | 验证和授权框架 |<br />
| Redis | 缓存数据库 |<br />
| Lombok | 简化对象封装工具 |<br />
| MyBatisPlus | ORM框架 |<br />
| MicroService（SpringCloud） | 微服务 |</p>
</li>
<li>
<p>项目（游戏）设计逻辑：</p>
</li>
</ul>
<p>
        <img   class="lazyload lazyload-block"
          src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://cdn.acwing.com/media/article/image/2024/03/03/126318_1d7f8b70d9-1.2.%E9%A1%B9%E7%9B%AE%E9%80%BB%E8%BE%91%E8%AE%BE%E8%AE%A1.png"  alt="" />
      <br />
<a name="P2aiK"></a></p>

        <h2 id="2-环境配置与项目创建"   >
          <a href="#2-环境配置与项目创建" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#2-环境配置与项目创建"></a> 2. 环境配置与项目创建</h2>
      
<p><a name="ue2bM"></a></p>

        <h3 id="21-项目设计"   >
          <a href="#21-项目设计" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#21-项目设计"></a> 2.1 项目设计</h3>
      
<ul>
<li>名称：<code>King Of Bots</code></li>
<li>项目包含的模块</li>
<li>PK模块：匹配界面（微服务）、实况直播界面（<code>WebSocket</code>协议）
<ul>
<li>对局列表模块：对局列表界面、对局录像界面</li>
<li>排行榜模块：<code>Bot</code>排行榜界面</li>
<li>用户中心模块：注册界面、登录界面、我的<code>Bot</code>界面、每个<code>Bot</code>的详情界面</li>
</ul>
</li>
<li>前后端分离模式
<ul>
<li><code>SpringBoot</code>实现后端</li>
<li><code>Vue3</code>实现<code>Web</code>端和<code>AcApp</code>端<br />
<a name="VPYFM"></a></li>
</ul>
</li>
</ul>

        <h3 id="22-配置git环境"   >
          <a href="#22-配置git环境" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#22-配置git环境"></a> 2.2 配置git环境</h3>
      
<ol>
<li>安装<code>Git Bash</code>：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://gitforwindows.org/" >https://gitforwindows.org/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li>进入家目录生成秘钥：执行命令<code>ssh-keygen</code></li>
<li>将<code>id_rsa.pub</code>的内容复制到<code>github</code>上<br />
<a name="UX9s1"></a></li>
</ol>

        <h3 id="23-创建项目前后端"   >
          <a href="#23-创建项目前后端" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#23-创建项目前后端"></a> 2.3 创建项目前后端</h3>
      
<ul>
<li>后端：使用<code>Spring Initilizr</code>创建后端，使用<code>2.3.7REALESE</code>版本，添加<code>SpringBoot Web Starter</code>插件。</li>
<li>前端：使用<code>Vue cli</code>脚手架创建项目，添加<code>Vue Router</code>和<code>VueX</code>插件，添加<code>BootStrap</code>与<code>jquery</code>依赖。（<code>Vue ui</code>创建前端有点奇怪的<code>bug</code>，选择位置时不选择默认盘符下的位置就报错，先在该盘符创建再移动到目标盘符去）<br />
<a name="VBmjE"></a></li>
</ul>

        <h2 id="3-创建前端基础页面"   >
          <a href="#3-创建前端基础页面" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#3-创建前端基础页面"></a> 3. 创建前端基础页面</h2>
      
<p><a name="chK2N"></a></p>

        <h3 id="31-创建导航栏及页面"   >
          <a href="#31-创建导航栏及页面" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#31-创建导航栏及页面"></a> 3.1 创建导航栏及页面</h3>
      
<p>
        <img   class="lazyload lazyload-block"
          src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://cdn.acwing.com/media/article/image/2024/03/03/126318_2aa880d4d9-3.1%E5%88%9B%E5%BB%BA%E5%AF%BC%E8%88%AA%E6%A0%8F.png"  alt="image.png" />
      <br />通过创建各个页面的<code>view</code>，主要包括<code>error, pk, ranklist, record, user-bot</code>页面。然后在导航栏中通过<code>router</code>进行跳转。<br />通过如下方式实时计算当前页面位于哪个部分，以便于高亮导航栏中的对应部分：</p>
<figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> route = <span class="title function_">useRoute</span>();</span><br><span class="line"><span class="keyword">let</span> route_name = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> route.<span class="property">name</span>)</span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  route_name</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p><a name="cfwHz"></a></p>

        <h3 id="32-创建游戏地图"   >
          <a href="#32-创建游戏地图" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#32-创建游戏地图"></a> 3.2 创建游戏地图</h3>
      
<p>
        <img   class="lazyload lazyload-block"
          src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://cdn.acwing.com/media/article/image/2024/03/03/126318_301badf5d9-3.2%E5%88%9B%E5%BB%BA%E6%B8%B8%E6%88%8F%E5%9C%B0%E5%9B%BE.png"  alt="image.png" />
      <br />首先创建游戏地图基类<code>AcGameObject</code>，然后通过继承该类实现<code>GameMap</code>游戏地图渲染类。</p>
<ul>
<li>在<code>AcGameObject</code>中，通过<code>requestAnimationFrame(step)</code>递归实现每<code>60</code>帧（因显示器而异）的实时渲染游戏画面。</li>
<li>在<code>GameMap</code>中，先将游戏背景（绿布）渲染出来，然后创建四周墙壁，再随机生成内部墙体障碍物，每生成一种方案，通过<code>Flood Fill</code>算法检验左下角与右上角的连通性，如果不连通则重新生成。</li>
</ul>
<p><strong>注意：</strong> 在后期会将生成地图的逻辑放到后端（前端只负责渲染，暂时放在前端便于当前调试），避免两名用户中有人修改前端代码造成不公平的情况。与此同时，生成的地图为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>13</mn><mo>×</mo><mn>14</mn></mrow><annotation encoding="application/x-tex">13 \times 14</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">4</span></span></span></span>的布局，并确保其是中心对称的。</p>
<blockquote>
<p>设计成<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>13</mn><mo>×</mo><mn>14</mn></mrow><annotation encoding="application/x-tex">13 \times 14</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">4</span></span></span></span>主要是为了避免两条蛇头能同时到达一个点的情况（平局），避免造成对优势方不利的情况。<br />
解释：若设计为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>13</mn><mo>×</mo><mn>13</mn></mrow><annotation encoding="application/x-tex">13 \times 13</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">3</span></span></span></span>，则刚开始两条蛇的蛇头坐标为<code>(1, 13), (13, 1)</code>，双方每走一步，横纵坐标之和的变化都是相同的（偶、奇、偶、奇……），设计成<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>13</mn><mo>×</mo><mn>14</mn></mrow><annotation encoding="application/x-tex">13 \times 14</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">4</span></span></span></span>则刚开始两蛇头的坐标为<code>(1, 14), (13, 1)</code>，则双方每走一步横纵坐标之和不可能相等，意味着双方的蛇头不可能在同一时间进入同一个格子。</p>
</blockquote>
<p><a name="BUfE6"></a></p>

        <h3 id="33-创建蛇类"   >
          <a href="#33-创建蛇类" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#33-创建蛇类"></a> 3.3 创建蛇类</h3>
      
<p>
        <img   class="lazyload lazyload-block"
          src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://cdn.acwing.com/media/article/image/2024/03/03/126318_35da8150d9-3.3%E5%88%9B%E5%BB%BA%E8%9B%87%E7%B1%BB.png"  alt="image.png" />
      在创建蛇类前，先要创建蛇的身体类（即<code>Cell</code>类）：</p>
<figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Cell</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">r, c</span>) &#123;</span><br><span class="line">    <span class="comment">// 格子坐标</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">r</span> = r; </span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">c</span> = c;</span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">x</span> = c + <span class="number">0.5</span>; <span class="comment">// 圆心横坐标</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">y</span> = r + <span class="number">0.5</span>; <span class="comment">// 圆心纵坐标</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>在定义蛇类时，需要定义其状态、当前移动方向、眼睛的偏移方向。蛇的移动方式为每移动一步，蛇头向前一步，蛇尾砍掉，身体保持不同（前10步，蛇尾不用移动，每次移动只蛇头向前移动即可，长度加1，之后每3步增长一格）。</p>
<blockquote>
<p>蛇的身体为一个个圆形<code>Cell</code>组成，因此，每两个<code>Cell</code>间用长方形进行填充，这样就只有头和尾的<code>Cell</code>有圆弧，看起来会比较正常。</p>
</blockquote>
<p>在移动时，通过蛇类中的函数设置当前步的前进方向，然后在地图类中进行监听用户操作（后续接入代码操作后，也将调用此函数设置蛇蛇的移动方向）：</p>
<figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">set_direction</span>(<span class="params">d</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">direction</span> = d;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>然后判断蛇的存活状态（在地图类中进行判断，而不是在蛇类中判断）：</p>
<figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">check_valid</span>(<span class="params">cell</span>) &#123;  <span class="comment">// 检测目标位置是否合法：没有撞到两条蛇的身体和障碍物</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> wall <span class="keyword">of</span> <span class="variable language_">this</span>.<span class="property">walls</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (wall.<span class="property">r</span> === cell.<span class="property">r</span> &amp;&amp; wall.<span class="property">c</span> === cell.<span class="property">c</span>)</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> snake <span class="keyword">of</span> <span class="variable language_">this</span>.<span class="property">snakes</span>) &#123;</span><br><span class="line">      <span class="keyword">let</span> k = snake.<span class="property">cells</span>.<span class="property">length</span>;</span><br><span class="line">      <span class="keyword">if</span> (!snake.<span class="title function_">check_tail_increasing</span>()) &#123;  <span class="comment">// 当蛇尾会前进的时候，蛇尾不用判断</span></span><br><span class="line">          k -- ;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; k; i ++ ) &#123;</span><br><span class="line">          <span class="keyword">if</span> (snake.<span class="property">cells</span>[i].<span class="property">r</span> === cell.<span class="property">r</span> &amp;&amp; snake.<span class="property">cells</span>[i].<span class="property">c</span> === cell.<span class="property">c</span>)</span><br><span class="line">              <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p><a name="KM6d4"></a></p>

        <h2 id="4-配置mysql与实现注册登录模块"   >
          <a href="#4-配置mysql与实现注册登录模块" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#4-配置mysql与实现注册登录模块"></a> 4. 配置MySql与实现注册登录模块</h2>
      
<p>在<code>pom.xml</code>文件中添加如下依赖：</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.24<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.33<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-generator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></div></figure>
<p><a name="IdcIv"></a></p>

        <h3 id="41-数据库配置"   >
          <a href="#41-数据库配置" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#41-数据库配置"></a> 4.1 数据库配置</h3>
      
<p>数据库使用<code>MySql8.0</code>版本，并创建<code>user</code>表。<code>YAML</code>相关配置如下：</p>
<figure class="highlight yaml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置数据库连接</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">xxxxxxx</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/kob?serverTimezone=Asia/Shanghai&amp;useUnicode=true&amp;characterEncoding=utf-8</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br></pre></td></tr></table></div></figure>
<p><a name="qaDya"></a></p>

        <h3 id="42-登录校验模块"   >
          <a href="#42-登录校验模块" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#42-登录校验模块"></a> 4.2 登录校验模块</h3>
      
<p><a name="KX9uz"></a></p>

        <h4 id="421-基本登录功能"   >
          <a href="#421-基本登录功能" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#421-基本登录功能"></a> 4.2.1 基本登录功能</h4>
      
<p>登录模块利用<code>SpringSecurity</code>自带的功能即可完成。通过配置<code>SecurityConfig</code>配置类、再实现<code>UserDetailsService, UserDetails</code>两个接口即可。在<code>UserDetailsServiceImpl</code>中先校验用户是否存在，再返回一个<strong>包含用户信息</strong>的<code>UserDetailsImpl</code>对象用于校验用户合法性（包括密码校验、用户是否失效、用户是否被锁等等）。<br />
<a name="StVor"></a></p>

        <h4 id="422-引入jwt认证"   >
          <a href="#422-引入jwt认证" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#422-引入jwt认证"></a> 4.2.2 引入<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.yuque.com/cxc_lhl/iupfzc/krkag1qcw9gl91u4#xFIlJ" >JWT</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>认证</h4>
      
<p>为了使用<code>jwt</code>认证，先在<code>pom.xml</code>文件中引入一下依赖：</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.11.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt-impl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.11.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt-jackson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.11.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></div></figure>
<ol>
<li>实现<code>JwtUtil</code>类，用于生成和解析<code>jwt</code>。</li>
<li>实现<code>JwtAuthenticationTokenFilter</code>类，用于验证用户传递过来的<code>jwt</code>，验证成功后，当前用户的信息将会被注入上下文中。</li>
<li>修改<code>SecurityConfig</code>放行<code>token</code>及<code>register</code>请求。</li>
</ol>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    http.csrf()</span><br><span class="line">        .disable()</span><br><span class="line">        .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)</span><br><span class="line">        .and()</span><br><span class="line">        .authorizeRequests()</span><br><span class="line">        .antMatchers(<span class="string">&quot;/user/account/token/&quot;</span>, <span class="string">&quot;/user/account/register/&quot;</span>).permitAll()</span><br><span class="line">        .antMatchers(HttpMethod.OPTIONS).permitAll()</span><br><span class="line">        .anyRequest().authenticated();</span><br><span class="line">    http.addFilterBefore(jwtAuthenticationTokenFilter, UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<ul>
<li>再分别创建三个接口<code>/user/account/token/, /user/account/info/, /user/account/register/</code>用于获取<code>token</code>、获取用户信息、用户注册。</li>
</ul>
<blockquote>
<p>在调试过程中，发现一个需要注意的细节，在浏览器中复制生成的<code>token</code>时，需要将其点开再复制，因为当位置不够时，中间很长一部分会议省略号形式展示，复制后根本无法发出请求。</p>
</blockquote>
<p><a name="JrIwT"></a></p>

        <h3 id="43-前端注册页面实现"   >
          <a href="#43-前端注册页面实现" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#43-前端注册页面实现"></a> 4.3 前端注册页面实现</h3>
      
<p>注册页面与登录页面极其类似，直接复制过来修改一下即可。<br />
        <img   class="lazyload lazyload-block"
          src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://cdn.acwing.com/media/article/image/2024/03/03/126318_3991b228d9-4.3%E5%89%8D%E7%AB%AF%E6%B3%A8%E5%86%8C%E9%A1%B5%E9%9D%A2%E5%AE%9E%E7%8E%B0.png"  alt="image.png" />
      <br />
<a name="DuFMp"></a></p>

        <h3 id="44-将jwt信息存进localstorage"   >
          <a href="#44-将jwt信息存进localstorage" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#44-将jwt信息存进localstorage"></a> 4.4 将jwt信息存进localStorage</h3>
      
<p>每当用户登录成功时，我们就将其获取到的<code>jwt</code>存进<code>localStorage</code>中。</p>
<figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&quot;jwt&quot;</span>, resp.<span class="property">token</span>)</span><br></pre></td></tr></table></div></figure>
<p>然后在每次路由跳转到登录页时，闲取出<code>localStorage</code>中的<code>jwt</code>信息，然后发送获取用户信息的请求以校验当前的<code>jwt</code>是否过期。</p>
<figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jwt = <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&quot;jwt&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> (jwt) &#123;</span><br><span class="line">  store.<span class="title function_">commit</span>(<span class="string">&quot;updateToken&quot;</span>, jwt)</span><br><span class="line">  store.<span class="title function_">dispatch</span>(<span class="string">&quot;getInfo&quot;</span>, &#123;</span><br><span class="line">    <span class="title function_">success</span>(<span class="params"></span>) &#123;</span><br><span class="line">      router.<span class="title function_">push</span>(&#123;<span class="attr">name</span>: <span class="string">&quot;home&quot;</span>&#125;)</span><br><span class="line">      store.<span class="title function_">commit</span>(<span class="string">&quot;updatePullingInfo&quot;</span>, <span class="literal">false</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">error</span>(<span class="params"></span>) &#123;</span><br><span class="line">      store.<span class="title function_">commit</span>(<span class="string">&quot;updatePullingInfo&quot;</span>, <span class="literal">false</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  store.<span class="title function_">commit</span>(<span class="string">&quot;updatePullingInfo&quot;</span>, <span class="literal">false</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>如果成功，则路由直接跳转到首页，否则显示登录页让用户重新登录。</p>
<blockquote>
<p>其中，<code>updatePullingInfo</code>是<code>user.js</code>中的用于修改全局变量<code>pulling_info</code>的函数，<code>pulling_info</code>用于控制当前是否处于获取用户信息状态（避免此时登录页会闪一下的问题），当用户信息拉取完毕时，成功就跳转首页，失败就正常显示登录页。</p>
</blockquote>
<figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">updatePullingInfo</span>(<span class="params">state, pulling_info</span>) &#123;</span><br><span class="line">    state.<span class="property">pulling_info</span> = pulling_info</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p><a name="lVLd6"></a></p>

        <h2 id="5-个人中心我的bot"   >
          <a href="#5-个人中心我的bot" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#5-个人中心我的bot"></a> 5. 个人中心（我的Bot）</h2>
      
<p><a name="p2qBF"></a></p>

        <h3 id="51-bot的crud后端"   >
          <a href="#51-bot的crud后端" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#51-bot的crud后端"></a> 5.1 Bot的CRUD（后端）</h3>
      
<p><code>Bot</code>的<code>CRUD</code>是一些比较重复性的工作，此处以<code>add</code>举例。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">add</span><span class="params">(Map&lt;String, String&gt; botData)</span> &#123;</span><br><span class="line">    <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authenticationToken</span> <span class="operator">=</span></span><br><span class="line">            (UsernamePasswordAuthenticationToken) SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">    <span class="type">UserDetailsImpl</span> <span class="variable">loginUser</span> <span class="operator">=</span> (UserDetailsImpl) authenticationToken.getPrincipal();</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> loginUser.getUser();</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">title</span> <span class="operator">=</span> botData.get(<span class="string">&quot;title&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">description</span> <span class="operator">=</span> botData.get(<span class="string">&quot;description&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> botData.get(<span class="string">&quot;content&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == title || title.length() == <span class="number">0</span>) &#123;</span><br><span class="line">        map.put(<span class="string">&quot;error_massage&quot;</span>, <span class="string">&quot;Bot标题不能为空！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (title.length() &gt; <span class="number">50</span>) &#123;</span><br><span class="line">        map.put(<span class="string">&quot;error_message&quot;</span>, <span class="string">&quot;Bot标题长度不能超过50！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 描述可以为空</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == description || description.length() == <span class="number">0</span>) &#123;</span><br><span class="line">        description = <span class="string">&quot;这个用户很懒，什么也没写~&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (description.length() &gt; <span class="number">200</span>) &#123;</span><br><span class="line">        map.put(<span class="string">&quot;error_message&quot;</span>, <span class="string">&quot;Bot描述长度不能超过200！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == content || content.length() == <span class="number">0</span>) &#123;</span><br><span class="line">        map.put(<span class="string">&quot;error_message&quot;</span>, <span class="string">&quot;Bot代码不能为空！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (content.length() &gt; <span class="number">10000</span>) &#123;</span><br><span class="line">        map.put(<span class="string">&quot;error_message&quot;</span>, <span class="string">&quot;Bot代码长度不能超过10000！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 校验一下该 bot的标题和代码，是否已创建过</span></span><br><span class="line">    QueryWrapper&lt;Bot&gt; botQueryWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    botQueryWrapper.eq(<span class="string">&quot;user_id&quot;</span>, user.getId());</span><br><span class="line">    botQueryWrapper.and(wrapper -&gt; wrapper.eq(<span class="string">&quot;content&quot;</span>, content).or().eq(<span class="string">&quot;title&quot;</span>, title));</span><br><span class="line">    <span class="type">Long</span> <span class="variable">count</span> <span class="operator">=</span> botMapper.selectCount(botQueryWrapper);</span><br><span class="line">    <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        map.put(<span class="string">&quot;error_message&quot;</span>, <span class="string">&quot;该Bot已经被你创建过啦，创建一个新的吧！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Date</span> <span class="variable">now</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">    System.out.println(now);</span><br><span class="line">    <span class="type">Bot</span> <span class="variable">bot</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bot</span>(<span class="literal">null</span>, user.getId(), title, description, content, DEFAULT_RATING, now, now, <span class="literal">null</span>);</span><br><span class="line">    System.out.println(bot);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">state</span> <span class="operator">=</span> botMapper.insert(bot);</span><br><span class="line">    <span class="keyword">if</span> (state &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        map.put(<span class="string">&quot;error_message&quot;</span>, <span class="string">&quot;success&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    map.put(<span class="string">&quot;error_message&quot;</span>, <span class="string">&quot;创建失败！&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p><code>CRUD</code>部分基本都类似，主要是一些限制条件要限制好，不然前端代码如果被修改，数据安全性得不到保证。</p>
<blockquote>
<p>正如 yxc 所说，前端防君子，后端防小人！<br />
这里创建Bot类时有个需要注意的地方，时区一定要通过<code>@JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;, timezone = &quot;Asia/Shanghai&quot;)</code>规定好，不然会出现前后端时间相差8小时的情况（具体可参考<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/m0_65894434/article/details/134997740" >使用@JsonFormat注解前后端时间相差8小时</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>）。</p>
</blockquote>
<p><a name="bpIYU"></a></p>

        <h3 id="52-bot的crud前端"   >
          <a href="#52-bot的crud前端" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#52-bot的crud前端"></a> 5.2 Bot的CRUD（前端）</h3>
      
<p>前端实现<code>CRUD</code>比较容易，使用<code>BootStrap</code>中的样式即可。唯一麻烦点的是引入<code>ace</code>代码编辑器。</p>
<ul>
<li><strong>我的Bot页面：</strong></li>
</ul>
<p>
        <img   class="lazyload lazyload-block"
          src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://cdn.acwing.com/media/article/image/2024/03/03/126318_3e2a0c6bd9-5.2.1%E6%88%91%E7%9A%84bot%E9%A1%B5%E9%9D%A2.png"  alt="image.png" />
      </p>
<ul>
<li><strong>创建Bot的</strong><code>Modal</code><strong>框：</strong></li>
</ul>
<p>
        <img   class="lazyload lazyload-block"
          src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://cdn.acwing.com/media/article/image/2024/03/03/126318_43f08b5cd9-5.2.2%E5%88%9B%E5%BB%BAbot%E7%9A%84modal%E6%A1%86.png"  alt="image.png" />
      </p>
<ul>
<li><strong>修改Bot的</strong><code>Modal</code><strong>框：</strong></li>
</ul>
<p>
        <img   class="lazyload lazyload-block"
          src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://cdn.acwing.com/media/article/image/2024/03/03/126318_4684fd31d9-5.2.3%E4%BF%AE%E6%94%B9bot%E7%9A%84modal%E6%A1%86.png"  alt="image.png" />
      </p>
<blockquote>
<p>注意：在引入<code>ace</code>代码编辑器时，在调试时可能会因为浏览器的问题而导致代码高亮、自动提示等出现不符合预期的问题，切换浏览器尝试一下。</p>
</blockquote>
<p><a name="D2Q1e"></a></p>

        <h2 id="6-微服务实现匹配系统"   >
          <a href="#6-微服务实现匹配系统" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#6-微服务实现匹配系统"></a> 6. 微服务：实现匹配系统</h2>
      
<p><a name="p1O0M"></a></p>

        <h3 id="61-后端backend集成websocket"   >
          <a href="#61-后端backend集成websocket" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#61-后端backend集成websocket"></a> 6.1 后端（backend）集成WebSocket</h3>
      
<ol>
<li>在<code>pom.xml</code>文件中添加依赖：</li>
</ol>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-websocket<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></div></figure>
<ol start="2">
<li>添加<code>WebSocketConfig</code>配置类：</li>
</ol>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.server.standard.ServerEndpointExporter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ServerEndpointExporter <span class="title function_">serverEndpointExporter</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServerEndpointExporter</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<ol start="3">
<li>添加<code>WebSocketServer</code>类（核心功能）：</li>
</ol>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kob.backend.comsumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.kob.backend.comsumer.utils.Game;</span><br><span class="line"><span class="keyword">import</span> com.kob.backend.comsumer.utils.JwtAuthentication;</span><br><span class="line"><span class="keyword">import</span> com.kob.backend.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> com.kob.backend.pojo.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.websocket.*;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.PathParam;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.ServerEndpoint;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CopyOnWriteArraySet;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ServerEndpoint(&quot;/websocket/&#123;token&#125;&quot;)</span>  <span class="comment">// 不要以&#x27;/&#x27;结尾</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Session session;</span><br><span class="line">    <span class="keyword">private</span> User user;</span><br><span class="line">    <span class="comment">// 记录全局的连接信息</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentHashMap&lt;Integer, WebSocketServer&gt; users = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> CopyOnWriteArraySet&lt;User&gt; matchpool = <span class="keyword">new</span> <span class="title class_">CopyOnWriteArraySet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserMapper</span><span class="params">(UserMapper userMapper)</span> &#123;</span><br><span class="line">        WebSocketServer.userMapper = userMapper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnOpen</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(Session session, <span class="meta">@PathParam(&quot;token&quot;)</span> String token)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 建立连接</span></span><br><span class="line">        <span class="built_in">this</span>.session = session;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">userId</span> <span class="operator">=</span> JwtAuthentication.getUserId(token);</span><br><span class="line">        <span class="built_in">this</span>.user = userMapper.selectById(userId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != <span class="built_in">this</span>.user) &#123;</span><br><span class="line">            users.put(userId, <span class="built_in">this</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;connected!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.session.close();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(users);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnClose</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 关闭链接</span></span><br><span class="line">        System.out.println(<span class="string">&quot;disconnected!&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != <span class="built_in">this</span>.user) &#123;</span><br><span class="line">            users.remove(<span class="built_in">this</span>.user.getId());</span><br><span class="line">            matchpool.remove(<span class="built_in">this</span>.user);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startMatching</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;start_matching!&quot;</span>);</span><br><span class="line">        matchpool.add(<span class="built_in">this</span>.user);</span><br><span class="line">        <span class="comment">// 暂时实现简单匹配逻辑</span></span><br><span class="line">        <span class="keyword">while</span> (matchpool.size() &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">            Iterator&lt;User&gt; it = matchpool.iterator();</span><br><span class="line">            <span class="type">User</span> <span class="variable">a</span> <span class="operator">=</span> it.next(), b = it.next();</span><br><span class="line">            matchpool.remove(a);</span><br><span class="line">            matchpool.remove(b);</span><br><span class="line"></span><br><span class="line">            <span class="type">Game</span> <span class="variable">game</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Game</span>(<span class="number">13</span>, <span class="number">14</span>, <span class="number">20</span>);</span><br><span class="line">            game.createMap();</span><br><span class="line"></span><br><span class="line">            <span class="type">JSONObject</span> <span class="variable">respA</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">            respA.put(<span class="string">&quot;event&quot;</span>, <span class="string">&quot;start-matching&quot;</span>);</span><br><span class="line">            respA.put(<span class="string">&quot;opponent_username&quot;</span>, b.getUsername());</span><br><span class="line">            respA.put(<span class="string">&quot;opponent_photo&quot;</span>, b.getPhoto());</span><br><span class="line">            respA.put(<span class="string">&quot;gameMap&quot;</span>, game.getG());</span><br><span class="line">            users.get(a.getId()).sendMessage(respA.toJSONString());</span><br><span class="line"></span><br><span class="line">            <span class="type">JSONObject</span> <span class="variable">respB</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">            respB.put(<span class="string">&quot;event&quot;</span>, <span class="string">&quot;start-matching&quot;</span>);</span><br><span class="line">            respB.put(<span class="string">&quot;opponent_username&quot;</span>, a.getUsername());</span><br><span class="line">            respB.put(<span class="string">&quot;opponent_photo&quot;</span>, a.getPhoto());</span><br><span class="line">            respB.put(<span class="string">&quot;gameMap&quot;</span>, game.getG());</span><br><span class="line">            users.get(b.getId()).sendMessage(respB.toJSONString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">stopMatching</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;stop_matching!&quot;</span>);</span><br><span class="line">        matchpool.remove(<span class="built_in">this</span>.user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnMessage</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message, Session session)</span> &#123;</span><br><span class="line">        <span class="comment">// 从 Client 接收消息</span></span><br><span class="line">        System.out.println(<span class="string">&quot;receive message!&quot;</span>);</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">data</span> <span class="operator">=</span> JSON.parseObject(message);</span><br><span class="line">        <span class="type">String</span> <span class="variable">event</span> <span class="operator">=</span> data.getString(<span class="string">&quot;event&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;start-matching&quot;</span>.equals(event)) &#123;</span><br><span class="line">            startMatching();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;stop-matching&quot;</span>.equals(event)) &#123;</span><br><span class="line">            stopMatching();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        <span class="comment">// 从 server 发送消息</span></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>.session) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.session.getBasicRemote().sendText(message);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e)  &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnError</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Session session, Throwable error)</span> &#123;</span><br><span class="line">        error.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>
<ol start="4">
<li>修改<code>SecurityConfig</code>放行<code>&quot;/websocket/**&quot;</code>请求：</li>
</ol>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    web.ignoring().antMatchers(<span class="string">&quot;/websocket/**&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<ol start="5">
<li>将前端生成地图的逻辑放到后端：</li>
</ol>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kob.backend.comsumer.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Game</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 游戏地图行数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Integer rows;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 游戏地图列数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Integer cols;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 地图内部墙体障碍物数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Integer innerWallsCount;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 游戏地图（0 表示草地，1 表示墙体障碍物）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span>[][] g;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span>[] dx = &#123;-<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>&#125;, dy = &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Game</span><span class="params">(Integer rows, Integer cols, Integer innerWallsCount)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.rows = rows;</span><br><span class="line">        <span class="built_in">this</span>.cols = cols;</span><br><span class="line">        <span class="built_in">this</span>.innerWallsCount = innerWallsCount;</span><br><span class="line">        <span class="built_in">this</span>.g = <span class="keyword">new</span> <span class="title class_">int</span>[rows][cols];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span>[][] getG() &#123;</span><br><span class="line">        <span class="keyword">return</span> g;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Flood Fill 校验地图连通性</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">checkConnectivity</span><span class="params">(<span class="type">int</span> sx, <span class="type">int</span> sy, <span class="type">int</span> tx, <span class="type">int</span> ty)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (sx == tx &amp;&amp; sy == ty) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// 表示已经走过</span></span><br><span class="line">        g[sx][sy] = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">d</span> <span class="operator">=</span> <span class="number">0</span>; d &lt; <span class="number">4</span>; d ++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> sx + dx[d], b = sy + dy[d];</span><br><span class="line">            <span class="keyword">if</span> (a &gt;= <span class="number">0</span> &amp;&amp; a &lt; <span class="built_in">this</span>.rows &amp;&amp; b &gt;= <span class="number">0</span> &amp;&amp; b &lt; <span class="built_in">this</span>.cols &amp;&amp; g[a][b] == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (checkConnectivity(a, b, tx, ty)) &#123;</span><br><span class="line">                    <span class="comment">// 恢复现场</span></span><br><span class="line">                    g[sx][sy] = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 即使校验失败也要恢复现场</span></span><br><span class="line">        g[sx][sy] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 画地图</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">draw</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 初始化地图</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; g.length; i ++) &#123;</span><br><span class="line">            Arrays.fill(g[i], <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 生成四周墙体障碍物</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> <span class="number">0</span>; r &lt; <span class="built_in">this</span>.rows; r ++) &#123;</span><br><span class="line">            g[r][<span class="number">0</span>] = g[r][<span class="built_in">this</span>.cols - <span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> <span class="number">0</span>; c &lt; <span class="built_in">this</span>.cols; c ++) &#123;</span><br><span class="line">            g[<span class="number">0</span>][c] = g[<span class="built_in">this</span>.rows - <span class="number">1</span>][c] = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 生成地图内部随机墙体障碍物</span></span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.innerWallsCount &gt;&gt; <span class="number">1</span>; i ++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">1000</span>; j ++) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> random.nextInt(<span class="built_in">this</span>.rows);</span><br><span class="line">                <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> random.nextInt(<span class="built_in">this</span>.cols);</span><br><span class="line">                <span class="keyword">if</span> (g[r][c] == <span class="number">1</span> || g[<span class="built_in">this</span>.rows - <span class="number">1</span> - r][<span class="built_in">this</span>.cols - <span class="number">1</span> - c] == <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (r == <span class="built_in">this</span>.rows - <span class="number">2</span> &amp;&amp; c == <span class="number">1</span> || r == <span class="number">1</span> &amp;&amp; c == <span class="built_in">this</span>.cols - <span class="number">2</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                g[r][c] = g[<span class="built_in">this</span>.rows - <span class="number">1</span> - r][<span class="built_in">this</span>.cols - <span class="number">1</span> - c] = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 校验连通性</span></span><br><span class="line">        <span class="keyword">return</span> checkConnectivity(<span class="built_in">this</span>.rows - <span class="number">2</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="built_in">this</span>.cols - <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createMap</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 循环 1000 次，直到成功生成合法地图</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i ++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (draw()) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p><a name="KNr6s"></a></p>

        <h3 id="62-前端实现匹配界面"   >
          <a href="#62-前端实现匹配界面" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#62-前端实现匹配界面"></a> 6.2 前端实现匹配界面</h3>
      
<ol>
<li>前端实现<code>pk</code>类，在其中维护当前一次的<code>pk</code>需要的变量，其中利用<code>status</code>变量动态切换匹配和游戏界面（<code>status: &quot;matching&quot;, // matching 表示匹配界面，playing 表示对战界面</code>）。</li>
</ol>
<figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="attr">state</span>: &#123;</span><br><span class="line">        <span class="attr">status</span>: <span class="string">&quot;matching&quot;</span>,  <span class="comment">// matching 表示匹配界面，playing 表示对战界面</span></span><br><span class="line">        <span class="attr">socket</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">opponent_username</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">opponent_photo</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">gameMap</span>: <span class="literal">null</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">getters</span>: &#123;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">mutations</span>: &#123;</span><br><span class="line">        <span class="title function_">updateSocket</span>(<span class="params">state, socket</span>) &#123;</span><br><span class="line">            state.<span class="property">socket</span> = socket;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">updateOpponent</span>(<span class="params">state, opponent</span>) &#123;</span><br><span class="line">            state.<span class="property">opponent_username</span> = opponent.<span class="property">username</span>;</span><br><span class="line">            state.<span class="property">opponent_photo</span> = opponent.<span class="property">photo</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">updateStatus</span>(<span class="params">state, status</span>) &#123;</span><br><span class="line">            state.<span class="property">status</span> = status;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">updateGameMap</span>(<span class="params">state, gameMap</span>) &#123;</span><br><span class="line">            state.<span class="property">gameMap</span> = gameMap;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">actions</span>: &#123;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">modules</span>: &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>
<ol start="2">
<li>除了之前实现的游戏界面，还需要实现一个匹配界面。匹配界面相对简单，和游戏地图界面类似，两个头像，一个按钮。</li>
</ol>
<blockquote>
<p>玩家1：</p>
</blockquote>
<p>
        <img   class="lazyload lazyload-block"
          src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://cdn.acwing.com/media/article/image/2024/03/03/126318_528bdb66d9-6.2.2%E7%8E%A9%E5%AE%B61.png"  alt="image.png" />
      </p>
<blockquote>
<p>玩家2：</p>
</blockquote>
<p>
        <img   class="lazyload lazyload-block"
          src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://cdn.acwing.com/media/article/image/2024/03/03/126318_57338a40d9-6.2.2%E7%8E%A9%E5%AE%B62.png"  alt="image.png" />
      </p>
<blockquote>
<p>匹配成功：</p>
</blockquote>
<p>
        <img   class="lazyload lazyload-block"
          src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://cdn.acwing.com/media/article/image/2024/03/03/126318_4dac59a0d9-6.2.2%E5%8C%B9%E9%85%8D%E6%88%90%E5%8A%9F.png"  alt="image.png" />
      </p>
<ol start="3">
<li>实现<code>PkIndexView</code>页面。之前该页面只有游戏地图，现在开始时需要先匹配，匹配成功后，需要将匹配界面关掉，切换为游戏地图页面。</li>
</ol>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;PlayGround v-if=&quot;$store.state.pk.status === &#x27;playing&#x27;&quot; /&gt;</span><br><span class="line">  &lt;MatchGround v-if=&quot;$store.state.pk.status === &#x27;matching&#x27;&quot; /&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import PlayGround from &#x27;../../components/PlayGround.vue&#x27;</span><br><span class="line">import MatchGround from &#x27;../../components/MatchGround.vue&#x27;</span><br><span class="line">import &#123; onMounted, onUnmounted &#125; from &#x27;vue&#x27;</span><br><span class="line">import &#123; useStore &#125; from &#x27;vuex&#x27;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  components: &#123;</span><br><span class="line">    PlayGround,</span><br><span class="line">    MatchGround,</span><br><span class="line">  &#125;,</span><br><span class="line">  setup() &#123;</span><br><span class="line">    const store = useStore();</span><br><span class="line">    const socketUrl = `ws://127.0.0.1:8090/websocket/$&#123;store.state.user.token&#125;/`;</span><br><span class="line"></span><br><span class="line">    let socket = null;</span><br><span class="line">    onMounted(() =&gt; &#123;</span><br><span class="line">      store.commit(&quot;updateOpponent&quot;, &#123;</span><br><span class="line">        username: &quot;我的对手&quot;,</span><br><span class="line">        photo: &quot;https://cdn.acwing.com/media/article/image/2022/08/09/1_1db2488f17-anonymous.png&quot;,</span><br><span class="line">      &#125;)</span><br><span class="line">      socket = new WebSocket(socketUrl);</span><br><span class="line"></span><br><span class="line">      socket.onopen = () =&gt; &#123;</span><br><span class="line">        console.log(&quot;connected!&quot;);</span><br><span class="line">        store.commit(&quot;updateSocket&quot;, socket);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      socket.onmessage = msg =&gt; &#123;</span><br><span class="line">        const data = JSON.parse(msg.data);</span><br><span class="line">        if (data.event === &quot;start-matching&quot;) &#123;  // 匹配成功</span><br><span class="line">          store.commit(&quot;updateOpponent&quot;, &#123;</span><br><span class="line">            username: data.opponent_username,</span><br><span class="line">            photo: data.opponent_photo,</span><br><span class="line">          &#125;);</span><br><span class="line">          setTimeout(() =&gt; &#123;</span><br><span class="line">            store.commit(&quot;updateStatus&quot;, &quot;playing&quot;);</span><br><span class="line">          &#125;, 2000);</span><br><span class="line">          store.commit(&quot;updateGameMap&quot;, data.gameMap);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      socket.onclose = () =&gt; &#123;</span><br><span class="line">        console.log(&quot;disconnected!&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    onUnmounted(() =&gt; &#123;</span><br><span class="line">      socket.close();</span><br><span class="line">      store.commit(&quot;updateStatus&quot;, &quot;matching&quot;);</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></div></figure>
<blockquote>
<p>需要注意的是，与<code>http</code>协议类似，<code>socketUrl</code>的写法将<code>http</code>换为<code>ws</code>即可。</p>
</blockquote>
<p>匹配成功后，双方的地图均是从后端获取，因此实现了两名玩家的地图一致性。<br />
        <img   class="lazyload lazyload-block"
          src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://cdn.acwing.com/media/article/image/2024/03/03/126318_5ad67da0d9-6.2.3%E5%8C%B9%E9%85%8D%E6%88%90%E5%8A%9F%E5%90%8E1.png"  alt="image.png" />
      
        <img   class="lazyload lazyload-block"
          src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://cdn.acwing.com/media/article/image/2024/03/03/126318_5d39caf8d9-6.2.3%E5%8C%B9%E9%85%8D%E6%88%90%E5%8A%9F%E5%90%8E2.png"  alt="image.png" />
      <br />
<a name="m4d1x"></a></p>

        <h3 id="63-实现匹配系统的微服务matchingsystem"   >
          <a href="#63-实现匹配系统的微服务matchingsystem" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#63-实现匹配系统的微服务matchingsystem"></a> 6.3 实现匹配系统的微服务（matchingsystem）</h3>
      
<p>新建一个<code>backendCloud</code> <code>maven</code>项目，引入<code>springcloud</code>依赖，在该项目下面新增两个模块（<code>backend, matchingsystem</code>），将先前的<code>backend</code>复制过来，引入并配置<code>restTemplate</code>。<br /><strong>匹配系统思路：</strong> 每次有匹配请求，<code>backend</code>发送添加用户请求到<code>matchingsystem</code>，<code>matchingsystem</code>将该用户添加到待匹配列表中。<code>matchingsystem</code>会在项目启动时开启<code>matchingPool</code>线程，并每秒尝试进行匹配列表中的玩家，同时每秒会增加玩家等待时间，时间越大，那么匹配该玩家时，可接受的天梯分差也将越大。</p>
<ul>
<li>在<code>webSocketServer</code>中实现<code>startMatching</code>函数调用匹配系统进行匹配：</li>
</ul>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startMatching</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;start_matching!&quot;</span>);</span><br><span class="line">    MultiValueMap&lt;String, String&gt; playerData = <span class="keyword">new</span> <span class="title class_">LinkedMultiValueMap</span>&lt;&gt;();</span><br><span class="line">    playerData.add(<span class="string">&quot;userId&quot;</span>, <span class="built_in">this</span>.user.getId().toString());</span><br><span class="line">    playerData.add(<span class="string">&quot;rating&quot;</span>, <span class="built_in">this</span>.user.getRating().toString());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ADD_PLAYER_URL = &quot;http://127.0.0.1:8089/player/add/&quot;</span></span><br><span class="line">    restTemplate.postForObject(ADD_PLAYER_URL, playerData, String.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<ul>
<li>匹配系统<code>MatchingPool</code>类核心代码：</li>
</ul>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                increaseWaitedTime();</span><br><span class="line">                matchPlayers();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<ul>
<li>在<code>matchingsystem</code>项目启动时开启<code>MatchingPool</code>线程：</li>
</ul>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MatchingSystemApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        MatchingServiceImpl.matchingPool.start();</span><br><span class="line">        SpringApplication.run(MatchingSystemApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<ul>
<li>一旦匹配成功一对玩家，就会调用<code>MatchingPool</code>的<code>sendResult</code>方法通知<code>backend</code>以创建当前游戏：</li>
</ul>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回匹配成功结果</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendResult</span><span class="params">(Player a, Player b)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;matched: &quot;</span> + a + <span class="string">&quot; &quot;</span> + b);</span><br><span class="line">    MultiValueMap&lt;String, String&gt; gameData = <span class="keyword">new</span> <span class="title class_">LinkedMultiValueMap</span>&lt;&gt;();</span><br><span class="line">    gameData.add(<span class="string">&quot;aId&quot;</span>, a.getUserId().toString());</span><br><span class="line">    gameData.add(<span class="string">&quot;bId&quot;</span>, b.getUserId().toString());</span><br><span class="line">    <span class="comment">// START_GAME_URL = &quot;http://127.0.0.1:8090/pk/startGame/&quot;</span></span><br><span class="line">    restTemplate.postForObject(START_GAME_URL, gameData, String.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<blockquote>
<p><code>startGame</code>函数会在下一部分介绍。</p>
</blockquote>
<p><a name="L5bbR"></a></p>

        <h3 id="64-实现后端游戏逻辑"   >
          <a href="#64-实现后端游戏逻辑" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#64-实现后端游戏逻辑"></a> 6.4 实现后端游戏逻辑</h3>
      
<p>在<code>WebSocketServer</code>中调用实现函数<code>startGame</code>以便匹配系统完成匹配时进行调用以开始游戏：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">startGame</span><span class="params">(Integer aId, Integer bId)</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">a</span> <span class="operator">=</span> userMapper.selectById(aId);</span><br><span class="line">    <span class="type">User</span> <span class="variable">b</span> <span class="operator">=</span> userMapper.selectById(bId);</span><br><span class="line"></span><br><span class="line">    <span class="type">Game</span> <span class="variable">game</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Game</span>(<span class="number">13</span>, <span class="number">14</span>, <span class="number">20</span>, aId, bId);</span><br><span class="line">    game.createMap();</span><br><span class="line">    game.start();</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != users.get(aId)) &#123;</span><br><span class="line">        users.get(aId).game = game;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != users.get(bId)) &#123;</span><br><span class="line">        users.get(bId).game = game;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">respGame</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    respGame.put(<span class="string">&quot;a_id&quot;</span>, game.getPlayerA().getId());</span><br><span class="line">    respGame.put(<span class="string">&quot;a_sx&quot;</span>, game.getPlayerA().getSx());</span><br><span class="line">    respGame.put(<span class="string">&quot;a_sy&quot;</span>, game.getPlayerA().getSy());</span><br><span class="line">    respGame.put(<span class="string">&quot;b_id&quot;</span>, game.getPlayerB().getId());</span><br><span class="line">    respGame.put(<span class="string">&quot;b_sx&quot;</span>, game.getPlayerB().getSx());</span><br><span class="line">    respGame.put(<span class="string">&quot;b_sy&quot;</span>, game.getPlayerB().getSy());</span><br><span class="line">    respGame.put(<span class="string">&quot;map&quot;</span>, game.getG());</span><br><span class="line"></span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">respA</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    respA.put(<span class="string">&quot;event&quot;</span>, <span class="string">&quot;start-matching&quot;</span>);</span><br><span class="line">    respA.put(<span class="string">&quot;opponent_username&quot;</span>, b.getUsername());</span><br><span class="line">    respA.put(<span class="string">&quot;opponent_photo&quot;</span>, b.getPhoto());</span><br><span class="line">    respA.put(<span class="string">&quot;game&quot;</span>, respGame);</span><br><span class="line">    <span class="comment">// 给玩家A客户端返回结果</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != users.get(aId)) &#123;</span><br><span class="line">        users.get(aId).sendMessage(respA.toJSONString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">respB</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    respB.put(<span class="string">&quot;event&quot;</span>, <span class="string">&quot;start-matching&quot;</span>);</span><br><span class="line">    respB.put(<span class="string">&quot;opponent_username&quot;</span>, a.getUsername());</span><br><span class="line">    respB.put(<span class="string">&quot;opponent_photo&quot;</span>, a.getPhoto());</span><br><span class="line">    respB.put(<span class="string">&quot;game&quot;</span>, respGame);</span><br><span class="line">    <span class="comment">// 给玩家B客户端返回结果</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != users.get(bId)) &#123;</span><br><span class="line">        users.get(bId).sendMessage(respB.toJSONString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>主要的游戏逻辑在<code>Game</code>类中，每次等待用户输入，然后校验操作时候合法，如果合法，则将两名玩家的操作广播给双方的客户端。如果有玩家操作不合法或者有玩家五秒内未进行输入，则游戏结束，向两名玩家广播游戏结果。<br /><code>Game</code>中的核心代码如下：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i ++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nextStep()) &#123;</span><br><span class="line">            judge();</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;playing&quot;</span>.equals(status)) &#123;</span><br><span class="line">                sendMove();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                sendResult();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            status = <span class="string">&quot;finished&quot;</span>;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> == nextStepA &amp;&amp; <span class="literal">null</span> == nextStepB) &#123;</span><br><span class="line">                    winner = <span class="string">&quot;all&quot;</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="literal">null</span> == nextStepB) &#123;</span><br><span class="line">                    winner = <span class="string">&quot;A&quot;</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    winner = <span class="string">&quot;B&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">            sendResult();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p><a name="QHwmW"></a></p>

        <h2 id="7-微服务bot代码的执行botrunningsystem"   >
          <a href="#7-微服务bot代码的执行botrunningsystem" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#7-微服务bot代码的执行botrunningsystem"></a> 7. 微服务：Bot代码的执行（botrunningsystem）</h2>
      
<ul>
<li>添加依赖：</li>
</ul>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jooq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>joor-java-8<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.14<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></div></figure>
<ul>
<li>配置<code>restTemplate</code>与<code>security</code>：</li>
</ul>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RestTemplateConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">getRestTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.csrf().disable()</span><br><span class="line">                .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)</span><br><span class="line">                .and()</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/bot/add/&quot;</span>).hasIpAddress(<span class="string">&quot;127.0.0.1&quot;</span>)</span><br><span class="line">                .antMatchers(HttpMethod.OPTIONS).permitAll()</span><br><span class="line">                .anyRequest().authenticated();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>每次后端（<code>backend</code>）会调用<code>bot/add/</code>接口往<code>bots</code>队列中添加<code>Bot</code>：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addBot</span><span class="params">(Integer userId, String botCode, String input)</span> &#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        bots.add(<span class="keyword">new</span> <span class="title class_">Bot</span>(userId, botCode, input));</span><br><span class="line">        <span class="comment">// 当 bot 添加结束，需要唤起其他线程进行消费</span></span><br><span class="line">        condition.signalAll();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p><code>botPool</code>的核心代码（这里相当于手动实现了一个消息队列）：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">consume</span><span class="params">(Bot bot)</span> &#123;</span><br><span class="line">    <span class="type">Consumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Consumer</span>();</span><br><span class="line">    consumer.startTimeout(<span class="number">2000</span>, bot);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">if</span> (bots.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 当队列中没有等待消费的Bot时，让线程等待，当有新添加的Bot时，会被condition.signalAll();唤醒</span></span><br><span class="line">                condition.await();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">Bot</span> <span class="variable">bot</span> <span class="operator">=</span> bots.poll();</span><br><span class="line">            lock.unlock();</span><br><span class="line">            <span class="comment">// consume 可能会执行几秒钟，需要先解锁</span></span><br><span class="line">            consume(bot);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>而在<code>Consumer</code>中，需要控制每个<code>Bot</code>的执行时间：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startTimeout</span><span class="params">(<span class="type">long</span> timeout, Bot bot)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.bot = bot;</span><br><span class="line">    <span class="built_in">this</span>.start();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.join(timeout);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// 最多等待 timeout 秒，然后中断</span></span><br><span class="line">        <span class="built_in">this</span>.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p><code>Consumer</code>中的核心代码：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">UUID</span> <span class="variable">uuid</span> <span class="operator">=</span> UUID.randomUUID();</span><br><span class="line">    <span class="type">String</span> <span class="variable">uid</span> <span class="operator">=</span> uuid.toString().substring(<span class="number">0</span>, <span class="number">8</span>);</span><br><span class="line">    <span class="comment">// 需要保障每次的类名不一样，否则只编译一次</span></span><br><span class="line">    Supplier&lt;Integer&gt; botInterface = Reflect.compile(</span><br><span class="line">            <span class="string">&quot;com.kob.botrunningsystem.utils.Bot&quot;</span> + uid,</span><br><span class="line">            addUid(bot.getBotCode(), uid)</span><br><span class="line">    ).create().get();</span><br><span class="line">    <span class="comment">// 将输入写入文件以便后续扩展（后期可以在docker中运行，就需要从文件中读取输入）</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;input.txt&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> (<span class="type">PrintWriter</span> <span class="variable">fout</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintWriter</span>(file)) &#123;</span><br><span class="line">        fout.println(bot.getInput());</span><br><span class="line">        fout.flush();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 执行Bot代码，获取结果</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">direction</span> <span class="operator">=</span> botInterface.get();</span><br><span class="line">    <span class="comment">// 将Bot执行结果返回</span></span><br><span class="line">    MultiValueMap&lt;String, String&gt; data = <span class="keyword">new</span> <span class="title class_">LinkedMultiValueMap</span>&lt;&gt;();</span><br><span class="line">    data.add(<span class="string">&quot;userId&quot;</span>, bot.getUserId().toString());</span><br><span class="line">    data.add(<span class="string">&quot;direction&quot;</span>, direction.toString());</span><br><span class="line"></span><br><span class="line">    restTemplate.postForObject(RECEIVE_BOT_MOVE_URL, data, String.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p><a name="CKczF"></a></p>

        <h2 id="8-创建对战列表与排行榜页面"   >
          <a href="#8-创建对战列表与排行榜页面" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#8-创建对战列表与排行榜页面"></a> 8. 创建对战列表与排行榜页面</h2>
      
<p>这两部分主要的任务就是写好分页查询和分页展示。<br />分页查询直接利用<code>MybatisPlus</code>自带的分页工具即可。<br />分页配置：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MybatisPlusInterceptor <span class="title function_">mybatisPlusInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MybatisPlusInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisPlusInterceptor</span>();</span><br><span class="line">        interceptor.addInnerInterceptor(<span class="keyword">new</span> <span class="title class_">PaginationInnerInterceptor</span>(DbType.MYSQL));</span><br><span class="line">        <span class="keyword">return</span> interceptor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>其中，在对战列表中的<code>查看录像</code>功能，实现原理为：将数据库中记录的地图信息、用户双方的操作信息取出，在游戏地图中重新模拟一遍即可。<br /><strong>对局列表：</strong><br />
        <img   class="lazyload lazyload-block"
          src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://cdn.acwing.com/media/article/image/2024/03/03/126318_5ef9b2e6d9-8.%E5%AF%B9%E5%B1%80%E5%88%97%E8%A1%A8.png"  alt="image.png" />
      <br /><strong>排行榜：</strong><br />
        <img   class="lazyload lazyload-block"
          src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://cdn.acwing.com/media/article/image/2024/03/03/126318_61f70baed9-8.%E6%8E%92%E8%A1%8C%E6%A6%9C.png"  alt="image.png" />
      <br />
<a name="Wj4NC"></a></p>

        <h2 id="9-实现qq三方登录"   >
          <a href="#9-实现qq三方登录" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#9-实现qq三方登录"></a> 9. 实现QQ三方登录</h2>
      
<blockquote>
<p><strong>基本思路：</strong> 通过访问后端的<code>@GetMapping(&quot;/applyCode/&quot;)</code>接口获取<code>apply_code</code>，同时后端生成了<code>state</code>存入<code>redis</code>中。然后前端再调用后端的<code>@GetMapping(&quot;/receiveCode/&quot;)</code>接口。在该接口中，会拿着<code>state</code>与<code>redis</code>中的进行校验，然后获取<code>access_token</code>，拿到<code>access_token</code>之后获取用户的<code>openid</code>，然后判断该<code>openid</code>是否已经存在，如果存在直接生成<code>jwt</code>并返回前端，如果不存在，则说明是第一次申请<code>QQ</code>登录，需要获取<code>user_info</code>，再存入数据库并生成<code>jwt</code>返回。</p>
</blockquote>
<p><strong>官方授权流程图（</strong><a target="_blank" rel="noopener" href="https://wiki.connect.qq.com/%e4%bd%bf%e7%94%a8authorization_code%e8%8e%b7%e5%8f%96access_token"><strong>官方教程</strong></a><strong>）：</strong><br />
        <img   class="lazyload lazyload-block"
          src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://cdn.acwing.com/media/article/image/2024/03/03/126318_6f230017d9-9.%E5%AE%98%E6%96%B9%E6%8E%88%E6%9D%83%E6%B5%81%E7%A8%8B%E5%9B%BE.png"  alt="" />
      <br />
<a name="lBIVC"></a></p>

        <h3 id="91-前往腾讯开放平台完成资料审核"   >
          <a href="#91-前往腾讯开放平台完成资料审核" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#91-前往腾讯开放平台完成资料审核"></a> 9.1 前往腾讯开放平台完成资料审核</h3>
      
<ul>
<li>先前往腾讯开放平台进行开发者人脸识别校验（<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://app.open.qq.com/p/developer/team_manage/info" >腾讯开放平台</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>）</li>
</ul>
<blockquote>
<p>需要先QQ登录，然后点击右上角的账户管理，根据提示微信扫码完成人脸识别校验。</p>
</blockquote>
<ul>
<li>QQ互联进行开发者资料审核（<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://connect.qq.com/devuser.html#/create/1/" >开发者资料审核</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>）</li>
</ul>
<blockquote>
<p>注：手持照片得用后置摄像头拍摄，前置摄像头有镜像功能，手指不能遮挡证件信息，一定要拍清楚，否则 会被驳回！</p>
</blockquote>
<p><a name="dgV8H"></a></p>

        <h3 id="92-在腾讯开放平台创建应用"   >
          <a href="#92-在腾讯开放平台创建应用" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#92-在腾讯开放平台创建应用"></a> 9.2 在腾讯开放平台创建应用</h3>
      
<ul>
<li>创建应用</li>
</ul>
<p>
        <img   class="lazyload lazyload-block"
          src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://cdn.acwing.com/media/article/image/2024/03/03/126318_65986370d9-9.2%E5%88%9B%E5%BB%BA%E5%BA%94%E7%94%A8.png"  alt="image.png" />
      </p>
<ul>
<li>填写应用资料</li>
</ul>
<blockquote>
<p>网站回调地址填写前端页面地址，再由前端页面请求后端进行账户注册或<code>jwt</code>生成。在这里需要处理一下前端页面的地址，因为这一栏腾讯要求不能以<code>'/'</code>结尾。所以前端页面也不能以<code>'/'</code>结尾。</p>
</blockquote>
<figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">path</span>: <span class="string">&quot;/user/account/qq/web/receiveCode&quot;</span>,</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;user_account_qq_receive_code&quot;</span>,</span><br><span class="line">  <span class="attr">component</span>: <span class="function">()=&gt;</span><span class="keyword">import</span>(<span class="string">&#x27;@/views/user/account/UserAccountQQReceiveCodeView&#x27;</span>),</span><br><span class="line">  <span class="attr">meta</span>:&#123;</span><br><span class="line">    requestAuth : <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></div></figure>
<p>所以我的地址（后端的<code>redirect_uri</code>与此保持一致）：</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://app5163.acapp.acwing.com.cn/user/account/qq/web/receiveCode</span><br></pre></td></tr></table></div></figure>
<p>
        <img   class="lazyload lazyload-block"
          src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://cdn.acwing.com/media/article/image/2024/03/03/126318_6a4f7e5bd9-9.2%E5%A1%AB%E5%86%99%E5%BA%94%E7%94%A8%E8%B5%84%E6%96%99.png"  alt="image.png" />
      </p>
<blockquote>
<ul>
<li>提供方和网站地址备案号可在：<code>[https://icp.chinaz.com/](https://icp.chinaz.com/)</code>查询。</li>
<li>提交审核后一定要先将<code>QQ</code>登录按钮部署到正式环境，否则会以<code>未摆放QQ登录按钮</code>审批不通过。</li>
</ul>
</blockquote>
<ul>
<li>审核通过</li>
</ul>
<p>
        <img   class="lazyload lazyload-block"
          src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="https://cdn.acwing.com/media/article/image/2024/03/03/126318_67678959d9-9.2%E5%AE%A1%E6%A0%B8%E9%80%9A%E8%BF%87.png"  alt="image.png" />
      <br />
<a name="KFUq7"></a></p>

        <h3 id="93-代码实现"   >
          <a href="#93-代码实现" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#93-代码实现"></a> 9.3 代码实现</h3>
      
<p><a name="FXRnt"></a></p>

        <h4 id="931-前端"   >
          <a href="#931-前端" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#931-前端"></a> 9.3.1 前端</h4>
      
<ul>
<li>在登录页合适位置添加<code>QQ</code>登录按钮：</li>
</ul>
<figure class="highlight html"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> @<span class="attr">click</span>=<span class="string">&quot;qq_login&quot;</span> <span class="attr">style</span>=<span class="string">&quot;cursor: pointer; text-align: center; margin-top: 10px;&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">height</span>=<span class="string">&quot;30&quot;</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">src</span>=<span class="string">&quot;https://wiki.connect.qq.com/wp-content/uploads/2013/10/03_qq_symbol-1-250x300.png&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">alt</span>=<span class="string">&quot;QQ官方图标&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;color: #09e309&quot;</span>&gt;</span></span><br><span class="line">    QQ一键登录</span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></div></figure>
<figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">qq_login</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&quot;https://app5163.acapp.acwing.com.cn/api/user/account/qq/web/applyCode/&quot;</span>,</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">    <span class="attr">success</span>: <span class="function"><span class="params">resp</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (resp.<span class="property">result</span> === <span class="string">&quot;success&quot;</span>) &#123;</span><br><span class="line">        <span class="variable language_">window</span>.<span class="property">location</span>.<span class="title function_">replace</span>(resp.<span class="property">apply_code_url</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<ul>
<li>添加路由（<s>其实上面已经写过</s>）</li>
</ul>
<figure class="highlight javascript"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">path</span>: <span class="string">&quot;/user/account/qq/web/receiveCode&quot;</span>,</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;user_account_qq_receive_code&quot;</span>,</span><br><span class="line">  <span class="attr">component</span>: <span class="function">()=&gt;</span><span class="keyword">import</span>(<span class="string">&#x27;@/views/user/account/UserAccountQQReceiveCodeView&#x27;</span>),</span><br><span class="line">  <span class="attr">meta</span>:&#123;</span><br><span class="line">    requestAuth : <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></div></figure>
<ul>
<li>处理<code>QQ</code>登录的页面</li>
</ul>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;&lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import router from &quot;@/router/index&quot;;</span><br><span class="line">import &#123;useStore&#125; from &quot;vuex&quot;;</span><br><span class="line">import &#123;useRoute&#125; from &quot;vue-router&quot;;</span><br><span class="line">import $ from &#x27;jquery&#x27;</span><br><span class="line">export default &#123;</span><br><span class="line">  name: &quot;UserAccountQQReceiveCodeView&quot;,</span><br><span class="line">  setup() &#123;</span><br><span class="line">    const myRoute = useRoute();</span><br><span class="line">    const store = useStore();</span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">      url: &quot;https://app5163.acapp.acwing.com.cn/api/user/account/qq/web/receiveCode/&quot;,</span><br><span class="line">      type: &quot;GET&quot;,</span><br><span class="line">      data: &#123;</span><br><span class="line">        code: myRoute.query.code,</span><br><span class="line">        state: myRoute.query.state,</span><br><span class="line">      &#125;,</span><br><span class="line">      success: resp =&gt; &#123;</span><br><span class="line">        if (resp.result === &quot;success&quot;) &#123;</span><br><span class="line">          localStorage.setItem(&quot;jwt&quot;, resp.jwt);</span><br><span class="line">          store.commit(&quot;updateToken&quot;, resp.jwt);</span><br><span class="line">          router.push(&#123;name: &quot;home&quot;&#125;);</span><br><span class="line">          store.commit(&quot;updatePullingInfo&quot;, false);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          router.push(&#123;name: &quot;user_account_login&quot;&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></div></figure>
<p><a name="OxeZj"></a></p>

        <h4 id="932-后端"   >
          <a href="#932-后端" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#932-后端"></a> 9.3.2 后端</h4>
      
<p><strong>后端主要需要实现两个接口：</strong></p>
<blockquote>
<p>记得在<code>SecurityConfig</code>中放行这两个接口，因为是在用户未获取<code>jwt</code>时进行访问。</p>
</blockquote>
<ul>
<li><code>@GetMapping(&quot;/applyCode/&quot;)</code></li>
</ul>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> JSONObject <span class="title function_">applyCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">resp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    <span class="type">String</span> <span class="variable">encodeUrl</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        encodeUrl = URLEncoder.encode(REDIRECT_URI, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        resp.put(<span class="string">&quot;result&quot;</span>, <span class="string">&quot;failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> resp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 随机字符串，防止 csrf 攻击</span></span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">state</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i ++) &#123;</span><br><span class="line">        state.append((<span class="type">char</span>)(random.nextInt(<span class="number">10</span>) + <span class="string">&#x27;0&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 存到redis里，有效期设置为10分钟</span></span><br><span class="line">    resp.put(<span class="string">&quot;result&quot;</span>, <span class="string">&quot;success&quot;</span>);</span><br><span class="line">    redisTemplate.opsForValue().set(state.toString(), <span class="string">&quot;true&quot;</span>);</span><br><span class="line">    redisTemplate.expire(state.toString(), Duration.ofMinutes(<span class="number">10</span>));</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">applyCodeUrl</span> <span class="operator">=</span> <span class="string">&quot;https://graph.qq.com/oauth2.0/authorize&quot;</span></span><br><span class="line">            + <span class="string">&quot;?response_type=&quot;</span>+<span class="string">&quot;code&quot;</span></span><br><span class="line">            + <span class="string">&quot;&amp;client_id=&quot;</span> + APP_ID</span><br><span class="line">            + <span class="string">&quot;&amp;redirect_uri=&quot;</span> + encodeUrl</span><br><span class="line">            + <span class="string">&quot;&amp;state=&quot;</span> + state;</span><br><span class="line">    resp.put(<span class="string">&quot;apply_code_url&quot;</span>, applyCodeUrl);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> resp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<ul>
<li><code>@GetMapping(&quot;/receiveCode/&quot;)</code></li>
</ul>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> JSONObject <span class="title function_">receiveCode</span><span class="params">(String code, String state)</span> &#123;</span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">resp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    resp.put(<span class="string">&quot;result&quot;</span>, <span class="string">&quot;failed&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == code || <span class="literal">null</span> == state) <span class="keyword">return</span> resp;</span><br><span class="line">    <span class="keyword">if</span> (Boolean.FALSE.equals(redisTemplate.hasKey(state))) <span class="keyword">return</span> resp;</span><br><span class="line">    redisTemplate.delete(state);</span><br><span class="line">    <span class="comment">// 获取access_token</span></span><br><span class="line">    List&lt;NameValuePair&gt; nameValuePairs = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">    nameValuePairs.add(<span class="keyword">new</span> <span class="title class_">BasicNameValuePair</span>(<span class="string">&quot;grant_type&quot;</span>, <span class="string">&quot;authorization_code&quot;</span>));</span><br><span class="line">    nameValuePairs.add(<span class="keyword">new</span> <span class="title class_">BasicNameValuePair</span>(<span class="string">&quot;client_id&quot;</span>, APP_ID));</span><br><span class="line">    nameValuePairs.add(<span class="keyword">new</span> <span class="title class_">BasicNameValuePair</span>(<span class="string">&quot;client_secret&quot;</span>, APP_SECRET));</span><br><span class="line">    nameValuePairs.add(<span class="keyword">new</span> <span class="title class_">BasicNameValuePair</span>(<span class="string">&quot;code&quot;</span>, code));</span><br><span class="line">    nameValuePairs.add(<span class="keyword">new</span> <span class="title class_">BasicNameValuePair</span>(<span class="string">&quot;redirect_uri&quot;</span>, REDIRECT_URI));</span><br><span class="line">    nameValuePairs.add(<span class="keyword">new</span> <span class="title class_">BasicNameValuePair</span>(<span class="string">&quot;fmt&quot;</span>, <span class="string">&quot;json&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">getString</span> <span class="operator">=</span> HttpClientUtil.get(APPLY_ACCESS_TOKEN_URL, nameValuePairs);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == getString) <span class="keyword">return</span> resp;</span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">getResp</span> <span class="operator">=</span> JSONObject.parseObject(getString);</span><br><span class="line">    <span class="type">String</span> <span class="variable">accessToken</span> <span class="operator">=</span> getResp.getString(<span class="string">&quot;access_token&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取openid</span></span><br><span class="line">    nameValuePairs = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">    nameValuePairs.add(<span class="keyword">new</span> <span class="title class_">BasicNameValuePair</span>(<span class="string">&quot;access_token&quot;</span>, accessToken));</span><br><span class="line">    nameValuePairs.add(<span class="keyword">new</span> <span class="title class_">BasicNameValuePair</span>(<span class="string">&quot;fmt&quot;</span>, <span class="string">&quot;json&quot;</span>));</span><br><span class="line"></span><br><span class="line">    getString = HttpClientUtil.get(APPLY_USER_OPENID_URL, nameValuePairs);</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">null</span> == getString) <span class="keyword">return</span> resp;</span><br><span class="line">    getResp = JSONObject.parseObject(getString);</span><br><span class="line">    <span class="type">String</span> <span class="variable">openid</span> <span class="operator">=</span> getResp.getString(<span class="string">&quot;openid&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (accessToken == <span class="literal">null</span> || openid == <span class="literal">null</span>) <span class="keyword">return</span> resp;</span><br><span class="line"></span><br><span class="line">    QueryWrapper&lt;User&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    queryWrapper.eq(<span class="string">&quot;openid_qq&quot;</span>, openid);</span><br><span class="line">    List&lt;User&gt; users = userMapper.selectList(queryWrapper);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用户已经授权，自动登录</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != users &amp;&amp; !users.isEmpty()) &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> users.get(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 生成jwt</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">jwt</span> <span class="operator">=</span> JwtUtil.createJWT(user.getId().toString());</span><br><span class="line"></span><br><span class="line">        resp.put(<span class="string">&quot;result&quot;</span>, <span class="string">&quot;success&quot;</span>);</span><br><span class="line">        resp.put(<span class="string">&quot;jwt&quot;</span>, jwt);</span><br><span class="line">        <span class="keyword">return</span> resp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 新用户授权，获取用户信息，并创建新用户</span></span><br><span class="line">    nameValuePairs = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">    nameValuePairs.add(<span class="keyword">new</span> <span class="title class_">BasicNameValuePair</span>(<span class="string">&quot;access_token&quot;</span>, accessToken));</span><br><span class="line">    nameValuePairs.add(<span class="keyword">new</span> <span class="title class_">BasicNameValuePair</span>(<span class="string">&quot;openid&quot;</span>, openid));</span><br><span class="line">    nameValuePairs.add(<span class="keyword">new</span> <span class="title class_">BasicNameValuePair</span>(<span class="string">&quot;oauth_consumer_key&quot;</span>, APP_ID));</span><br><span class="line">    getString = HttpClientUtil.get(APPLY_USER_INFO_URL, nameValuePairs);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == getString) <span class="keyword">return</span> resp;</span><br><span class="line"></span><br><span class="line">    getResp = JSONObject.parseObject(getString);</span><br><span class="line">    <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> getResp.getString(<span class="string">&quot;nickname&quot;</span>);</span><br><span class="line">    <span class="comment">// 50*50的头像</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">photo</span> <span class="operator">=</span> getResp.getString(<span class="string">&quot;figureurl_1&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == username || <span class="literal">null</span> == photo) <span class="keyword">return</span> resp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 每次循环，用户名重复的概率为上一次的1/10</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i ++) &#123;</span><br><span class="line">        QueryWrapper&lt;User&gt; usernameQueryWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">        usernameQueryWrapper.eq(<span class="string">&quot;username&quot;</span>, username);</span><br><span class="line">        <span class="keyword">if</span> (userMapper.selectCount(usernameQueryWrapper) == <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line">        username += (<span class="type">char</span>)(random.nextInt(<span class="number">10</span>) + <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">99</span>) <span class="keyword">return</span> resp;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="literal">null</span>, username, <span class="literal">null</span>, photo, <span class="number">1500</span>, <span class="literal">null</span>, openid, <span class="literal">null</span>);</span><br><span class="line">    userMapper.insert(user);</span><br><span class="line">    <span class="comment">// 生成 jwt</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">jwt</span> <span class="operator">=</span> JwtUtil.createJWT(user.getId().toString());</span><br><span class="line">    resp.put(<span class="string">&quot;result&quot;</span>, <span class="string">&quot;success&quot;</span>);</span><br><span class="line">    resp.put(<span class="string">&quot;jwt&quot;</span>, jwt);</span><br><span class="line">    <span class="keyword">return</span> resp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p><a name="jQ4rd"></a></p>

        <h2 id="10-项目上线"   >
          <a href="#10-项目上线" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#10-项目上线"></a> 10. 项目上线</h2>
      
<p>上线流程参考：<br /><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/m0_65894434/article/details/135360932" >项目上线基本流程-CSDN博客</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br />上线成果：<br /><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://app5163.acapp.acwing.com.cn/" >King of Bots</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br />项目<code>github</code>地址：<br /><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/smallboatc/kob/" >https://github.com/smallboatc/kob/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ 本文结束，感谢您的阅读 ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">本文作者: </span><span class="copyright-author__value"><a href="http://smallboatc.github.io">SmallBoat</a></span></div><div class="copyright-link"><span class="copyright-link__name">本文链接: </span><span class="copyright-link__value"><a href="http://smallboatc.github.io/2024/02/27/King%20of%20Bots%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93/">http://smallboatc.github.io/2024/02/27/King%20of%20Bots%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">版权声明: </span><span class="copyright-notice__value">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> 许可协议。转载请注明出处！</span></div></div><nav class="post-paginator paginator"><div class="paginator-next"><a class="paginator-next__link" href="/2024/02/01/%E9%A1%B9%E7%9B%AE%E4%B8%8A%E7%BA%BF%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B/"><span class="paginator-prev__text">项目上线基本流程</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div><div class="comments" id="comments"><div id="gitalk-container"></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">文章目录</span><span class="sidebar-nav-ov">站点概览</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E9%A1%B9%E7%9B%AE%E8%A7%84%E5%88%92"><span class="toc-text">
           1. 项目规划</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E4%B8%8E%E9%A1%B9%E7%9B%AE%E5%88%9B%E5%BB%BA"><span class="toc-text">
           2. 环境配置与项目创建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#21-%E9%A1%B9%E7%9B%AE%E8%AE%BE%E8%AE%A1"><span class="toc-text">
           2.1 项目设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#22-%E9%85%8D%E7%BD%AEgit%E7%8E%AF%E5%A2%83"><span class="toc-text">
           2.2 配置git环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#23-%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE%E5%89%8D%E5%90%8E%E7%AB%AF"><span class="toc-text">
           2.3 创建项目前后端</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%88%9B%E5%BB%BA%E5%89%8D%E7%AB%AF%E5%9F%BA%E7%A1%80%E9%A1%B5%E9%9D%A2"><span class="toc-text">
           3. 创建前端基础页面</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#31-%E5%88%9B%E5%BB%BA%E5%AF%BC%E8%88%AA%E6%A0%8F%E5%8F%8A%E9%A1%B5%E9%9D%A2"><span class="toc-text">
           3.1 创建导航栏及页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#32-%E5%88%9B%E5%BB%BA%E6%B8%B8%E6%88%8F%E5%9C%B0%E5%9B%BE"><span class="toc-text">
           3.2 创建游戏地图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#33-%E5%88%9B%E5%BB%BA%E8%9B%87%E7%B1%BB"><span class="toc-text">
           3.3 创建蛇类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E9%85%8D%E7%BD%AEmysql%E4%B8%8E%E5%AE%9E%E7%8E%B0%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97"><span class="toc-text">
           4. 配置MySql与实现注册登录模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#41-%E6%95%B0%E6%8D%AE%E5%BA%93%E9%85%8D%E7%BD%AE"><span class="toc-text">
           4.1 数据库配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#42-%E7%99%BB%E5%BD%95%E6%A0%A1%E9%AA%8C%E6%A8%A1%E5%9D%97"><span class="toc-text">
           4.2 登录校验模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#421-%E5%9F%BA%E6%9C%AC%E7%99%BB%E5%BD%95%E5%8A%9F%E8%83%BD"><span class="toc-text">
           4.2.1 基本登录功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#422-%E5%BC%95%E5%85%A5jwt%E8%AE%A4%E8%AF%81"><span class="toc-text">
           4.2.2 引入JWT认证</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#43-%E5%89%8D%E7%AB%AF%E6%B3%A8%E5%86%8C%E9%A1%B5%E9%9D%A2%E5%AE%9E%E7%8E%B0"><span class="toc-text">
           4.3 前端注册页面实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#44-%E5%B0%86jwt%E4%BF%A1%E6%81%AF%E5%AD%98%E8%BF%9Blocalstorage"><span class="toc-text">
           4.4 将jwt信息存进localStorage</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E6%88%91%E7%9A%84bot"><span class="toc-text">
           5. 个人中心（我的Bot）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#51-bot%E7%9A%84crud%E5%90%8E%E7%AB%AF"><span class="toc-text">
           5.1 Bot的CRUD（后端）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#52-bot%E7%9A%84crud%E5%89%8D%E7%AB%AF"><span class="toc-text">
           5.2 Bot的CRUD（前端）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F"><span class="toc-text">
           6. 微服务：实现匹配系统</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#61-%E5%90%8E%E7%AB%AFbackend%E9%9B%86%E6%88%90websocket"><span class="toc-text">
           6.1 后端（backend）集成WebSocket</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#62-%E5%89%8D%E7%AB%AF%E5%AE%9E%E7%8E%B0%E5%8C%B9%E9%85%8D%E7%95%8C%E9%9D%A2"><span class="toc-text">
           6.2 前端实现匹配界面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#63-%E5%AE%9E%E7%8E%B0%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1matchingsystem"><span class="toc-text">
           6.3 实现匹配系统的微服务（matchingsystem）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#64-%E5%AE%9E%E7%8E%B0%E5%90%8E%E7%AB%AF%E6%B8%B8%E6%88%8F%E9%80%BB%E8%BE%91"><span class="toc-text">
           6.4 实现后端游戏逻辑</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E5%BE%AE%E6%9C%8D%E5%8A%A1bot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8Cbotrunningsystem"><span class="toc-text">
           7. 微服务：Bot代码的执行（botrunningsystem）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E5%88%9B%E5%BB%BA%E5%AF%B9%E6%88%98%E5%88%97%E8%A1%A8%E4%B8%8E%E6%8E%92%E8%A1%8C%E6%A6%9C%E9%A1%B5%E9%9D%A2"><span class="toc-text">
           8. 创建对战列表与排行榜页面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E5%AE%9E%E7%8E%B0qq%E4%B8%89%E6%96%B9%E7%99%BB%E5%BD%95"><span class="toc-text">
           9. 实现QQ三方登录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#91-%E5%89%8D%E5%BE%80%E8%85%BE%E8%AE%AF%E5%BC%80%E6%94%BE%E5%B9%B3%E5%8F%B0%E5%AE%8C%E6%88%90%E8%B5%84%E6%96%99%E5%AE%A1%E6%A0%B8"><span class="toc-text">
           9.1 前往腾讯开放平台完成资料审核</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#92-%E5%9C%A8%E8%85%BE%E8%AE%AF%E5%BC%80%E6%94%BE%E5%B9%B3%E5%8F%B0%E5%88%9B%E5%BB%BA%E5%BA%94%E7%94%A8"><span class="toc-text">
           9.2 在腾讯开放平台创建应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#93-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">
           9.3 代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#931-%E5%89%8D%E7%AB%AF"><span class="toc-text">
           9.3.1 前端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#932-%E5%90%8E%E7%AB%AF"><span class="toc-text">
           9.3.2 后端</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-%E9%A1%B9%E7%9B%AE%E4%B8%8A%E7%BA%BF"><span class="toc-text">
           10. 项目上线</span></a></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/img/avatar.jpg" alt="avatar"></div><p class="sidebar-ov-author__text">该庆幸的是年岁还轻，时光未老。怕只怕杜鹃过早鸣叫，使百花应声而凋，使荃蕙化而为芽。  ——余秋雨</p></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/smallboatc" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a><a class="sidebar-ov-social-item" href="tencent://message?uin=2226052035" target="_blank" rel="noopener" data-popover="QQ" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-qq"></i></span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">8</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">5</div><div class="sidebar-ov-state-item__name">分类</div></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">你已阅读了 </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2024</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>SmallBoat</span></div><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span class="footer__devider">|</span><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span></div><div class="busuanzi"><span class="busuanzi-siteuv"><span class="busuanzi-siteuv__icon"><i class="fas fa-user"></i></span><span class="busuanzi-siteuv__info">访问人数</span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_uv"></span></span><span class="busuanzi-sitepv"><span class="busuanzi-siteuv__icon"><i class="fas fa-eye"></i></span><span class="busuanzi-siteuv__info">浏览总量</span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_pv"></span></span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="搜索文章（支持多关键词，请用空格分隔）"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/ribbon.js@latest/dist/ribbon.min.js" size="120" alpha="0.6" zIndex="-1"></script><script src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1.0.1/dist/canvas-nest.min.js" color="0,0,0" opacity="0.6" count="99" zIndex="-1"></script><script src="https://cdn.jsdelivr.net/npm/lazyload@2.0.0-rc.2/lazyload.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ 文章无标题 ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', '请输入字符');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><link href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css" rel="stylesheet" type="text/css"><link href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/contrib/copy-tex.css" rel="stylesheet" type="text/css"><script src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/contrib/copy-tex.min.js"></script><script src="//cdn.jsdelivr.net/gh/sukkaw/busuanzi@latest/bsz.pure.mini.js" async></script><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-md5@latest/src/md5.min.js"></script><script>function loadGitalk () {
  if (!document.getElementById('gitalk-container')) {
    return;
  }

  var gitalk = new Gitalk({
    id: md5(window.location.pathname.slice(1)),
    clientID: 'faff2362c8ef02f91ba7',
    clientSecret: '2f3704f59b5815f7f1b08ff03cd60f1463f2ec25',
    repo: 'blog_comments',
    owner: 'smallboatc',
    admin: ['smallboatc'],
    distractionFreeMode: 'true',
    language: 'zh-CN'
  });
  gitalk.render('gitalk-container');
}

if (false) {
  loadGitalk();
} else {
  window.addEventListener('DOMContentLoaded', loadGitalk, false);
}</script><script src="/js/utils.js?v=2.8.0"></script><script src="/js/stun-boot.js?v=2.8.0"></script><script src="/js/scroll.js?v=2.8.0"></script><script src="/js/header.js?v=2.8.0"></script><script src="/js/sidebar.js?v=2.8.0"></script><script type="application/json" src="/search.json"></script></body></html>